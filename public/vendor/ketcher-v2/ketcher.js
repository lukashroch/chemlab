!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,b.ketcher=a()}}(function(){var a;return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(b,c,d){var e=e||function(a){"use strict";if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var b=a.document,c=function(){return a.URL||a.webkitURL||a},d=b.createElementNS("http://www.w3.org/1999/xhtml","a"),e="download"in d,f=function(a){var b=new MouseEvent("click");a.dispatchEvent(b)},g=a.webkitRequestFileSystem,h=a.requestFileSystem||g||a.mozRequestFileSystem,i=function(b){(a.setImmediate||a.setTimeout)(function(){throw b},0)},j="application/octet-stream",k=0,l=500,m=function(b){var d=function(){"string"==typeof b?c().revokeObjectURL(b):b.remove()};a.chrome?d():setTimeout(d,l)},n=function(a,b,c){b=[].concat(b);for(var d=b.length;d--;){var e=a["on"+b[d]];if("function"==typeof e)try{e.call(a,c||a)}catch(a){i(a)}}},o=function(a){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(a.type)?new Blob(["\ufeff",a],{type:a.type}):a},p=function(b,i,l){l||(b=o(b));var s,t,y,p=this,q=b.type,r=!1,u=function(){n(p,"writestart progress write writeend".split(" "))},v=function(){if(!r&&s||(s=c().createObjectURL(b)),t)t.location.href=s;else{var d=a.open(s,"_blank");void 0==d&&"undefined"!=typeof safari&&(a.location.href=s)}p.readyState=p.DONE,u(),m(s)},w=function(a){return function(){if(p.readyState!==p.DONE)return a.apply(this,arguments)}},x={create:!0,exclusive:!1};return p.readyState=p.INIT,i||(i="download"),e?(s=c().createObjectURL(b),d.href=s,d.download=i,void setTimeout(function(){f(d),u(),m(s),p.readyState=p.DONE})):(a.chrome&&q&&q!==j&&(y=b.slice||b.webkitSlice,b=y.call(b,0,b.size,j),r=!0),g&&"download"!==i&&(i+=".download"),(q===j||g)&&(t=a),h?(k+=b.size,void h(a.TEMPORARY,k,w(function(a){a.root.getDirectory("saved",x,w(function(a){var c=function(){a.getFile(i,x,w(function(a){a.createWriter(w(function(c){c.onwriteend=function(b){t.location.href=a.toURL(),p.readyState=p.DONE,n(p,"writeend",b),m(a)},c.onerror=function(){var a=c.error;a.code!==a.ABORT_ERR&&v()},"writestart progress write abort".split(" ").forEach(function(a){c["on"+a]=p["on"+a]}),c.write(b),p.abort=function(){c.abort(),p.readyState=p.DONE},p.readyState=p.WRITING}),v)}),v)};a.getFile(i,{create:!1},w(function(a){a.remove(),c()}),w(function(a){a.code===a.NOT_FOUND_ERR?c():v()}))}),v)}),v)):void v())},q=p.prototype,r=function(a,b,c){return new p(a,b,c)};return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(a,b,c){return c||(a=o(a)),navigator.msSaveOrOpenBlob(a,b||"download")}:(q.abort=function(){var a=this;a.readyState=a.DONE,n(a,"abort")},q.readyState=q.INIT=0,q.WRITING=1,q.DONE=2,q.error=q.onwritestart=q.onprogress=q.onwrite=q.onabort=q.onerror=q.onwriteend=null,r)}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof c&&c.exports?c.exports.saveAs=e:"undefined"!=typeof a&&null!==a&&null!=a.amd&&a([],function(){return e})},{}],2:[function(b,c,d){!function(a,b){a(function(){function o(a){var b=a.split(/-(?!$)/),c=b[b.length-1],d={code:h[c]};if(!d.code)throw'Unknown key "'+c+'" in keystring "'+a+'"';for(var f,g=0;g<b.length-1;g++){if(c=b[g],f=e[c],!f)throw'Unknown modifier "'+c+'" in keystring "'+a+'"';d[f]=!0}return d}function p(a){for(var b="",c=0;c<f.length;c++)a[f[c]]&&(b+=f[c]+"-");return b+=j[a.code]}function q(a){for(var b=[],c=a.split(" "),d=0;d<c.length;d++){var e=o(c[d]);e=p(e),b.push(e)}return b.original=a,b}function r(a){for(var b={code:a.keyCode},c=0;c<d.length;c++){var e=d[c];a[e]&&(b[e.slice(0,e.length-3)]=!0)}return p(b)}function s(a,b){for(var c=0;c<b.length;c++){var d=b[c];if(d&&(a=a[d]),!a)break}return a}function u(a){if(!~g.indexOf(a.keyCode)){var b=t.slice();b.push(r(a));for(var d,e,f,c=m.split("."),h=c.length;h>=0;h--)if(e=s(n,c.slice(0,h))){d=!0;for(var i=0;i<b.length;i++){if(f=b[i],!e[f]){d=!1;break}e=e[f]}if(d)break}var j=c.slice(0,h).join("."),k=e.preventDefault;if(d&&!e.handlers)return t=b,void(k&&a.preventDefault());if(d)for(h=0;h<e.handlers.length;h++){var l=e.handlers[h],o=l._keymage,p=l.call(o.context,a,{shortcut:o.original,scope:m,definitionScope:j});(p===!1||k)&&a.preventDefault()}t=[]}}function v(a,b,c){var d=a.split("."),e=n;d=d.concat(b);for(var f=0,g=d.length;f<g;f++){var h=d[f];if(h&&(e=e[h]||(e[h]={}),c&&c._keymage.preventDefault&&(e.preventDefault=!0),f===g-1)){var i=e.handlers||(e.handlers=[]);return i}}}function w(a,b,c){var d=v(a,b,c);d.push(c)}function x(a,b,c){var d=v(a,b),e=d.indexOf(c);~e&&d.splice(e,1)}function y(a,c,d,e){if(c===b&&d===b)return function(b,c){return z(a,b,c)};"function"==typeof c&&(e=d,d=c,c=a,a="");var f=q(c);return[a,f,d,e]}function z(a,b,c,d){var e=y(a,b,c,d);return c=e[2],d=e[3],c._keymage=d||{},c._keymage.original=b,w.apply(null,e),function(){x.apply(null,e)}}var i,a="1.1.3",c="undefined"!=typeof navigator&&~navigator.userAgent.indexOf("Mac OS X"),d=["shiftKey","ctrlKey","altKey","metaKey"],e={shift:"shift",ctrl:"ctrl",control:"ctrl",alt:"alt",option:"alt",win:"meta",cmd:"meta",super:"meta",meta:"meta",defmod:c?"meta":"ctrl"},f=["shift","ctrl","alt","meta"],g=[16,17,18,91],h={backspace:8,tab:9,enter:13,return:13,pause:19,caps:20,capslock:20,escape:27,esc:27,space:32,pgup:33,pageup:33,pgdown:34,pagedown:34,end:35,home:36,ins:45,insert:45,del:46,delete:46,left:37,up:38,right:39,down:40,"*":106,"+":107,plus:107,minus:109,";":186,"=":187,",":188,"-":189,".":190,"/":191,"`":192,"[":219,"\\":220,"]":221,"'":222};for(i=0;i<10;i++)h["num-"+i]=i+95;for(i=0;i<10;i++)h[i.toString()]=i+48;for(i=1;i<25;i++)h["f"+i]=i+111;for(i=65;i<91;i++)h[String.fromCharCode(i).toLowerCase()]=i;var j={};for(var k in h){var l=h[k];(!j[l]||j[l].length<k.length)&&(j[l]=k)}var m="",n={},t=[];return z.unbind=function(a,b,c){var d=y(a,b,c);x.apply(null,d)},z.parse=o,z.stringify=p,z.bindings=n,z.setScope=function(a){m=a?a:""},z.getScope=function(){return m},z.pushScope=function(a){return m=(m?m+".":"")+a},z.popScope=function(a){var b;return a?(m=m.replace(new RegExp("(^|\\.)"+a+"(\\.|$).*"),""),a):(b=m.lastIndexOf("."),a=m.slice(b+1),m=b==-1?"":m.slice(0,b),a)},z.version=a,window.addEventListener("keydown",u,!1),z})}("undefined"!=typeof a?a:function(a){"undefined"!=typeof c?c.exports=a():window.keymage=a()})},{}],3:[function(a,b,c){!function(a){function d(a,b){return function(){a.apply(b,arguments)}}function f(a){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof a)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],l(a,d(h,this),d(i,this))}function g(a){var b=this;return null===this._state?void this._deferreds.push(a):void c(function(){var c=b._state?a.onFulfilled:a.onRejected;if(null===c)return void(b._state?a.resolve:a.reject)(b._value);var d;try{d=c(b._value)}catch(b){return void a.reject(b)}a.resolve(d)})}function h(a){try{if(a===this)throw new TypeError("A promise cannot be resolved with itself.");if(a&&("object"==typeof a||"function"==typeof a)){var b=a.then;if("function"==typeof b)return void l(d(b,a),d(h,this),d(i,this))}this._state=!0,this._value=a,j.call(this)}catch(a){i.call(this,a)}}function i(a){this._state=!1,this._value=a,j.call(this)}function j(){for(var a=0,b=this._deferreds.length;a<b;a++)g.call(this,this._deferreds[a]);this._deferreds=null}function k(a,b,c,d){this.onFulfilled="function"==typeof a?a:null,this.onRejected="function"==typeof b?b:null,this.resolve=c,this.reject=d}function l(a,b,c){var d=!1;try{a(function(a){d||(d=!0,b(a))},function(a){d||(d=!0,c(a))})}catch(a){if(d)return;d=!0,c(a)}}var c="function"==typeof setImmediate&&setImmediate||function(a){setTimeout(a,1)},e=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)};f.prototype.catch=function(a){return this.then(null,a)},f.prototype.then=function(a,b){var c=this;return new f(function(d,e){g.call(c,new k(a,b,d,e))})},f.all=function(){var a=Array.prototype.slice.call(1===arguments.length&&e(arguments[0])?arguments[0]:arguments);return new f(function(b,c){function e(f,g){try{if(g&&("object"==typeof g||"function"==typeof g)){var h=g.then;if("function"==typeof h)return void h.call(g,function(a){e(f,a)},c)}a[f]=g,0===--d&&b(a)}catch(a){c(a)}}if(0===a.length)return b([]);for(var d=a.length,f=0;f<a.length;f++)e(f,a[f])})},f.resolve=function(a){return a&&"object"==typeof a&&a.constructor===f?a:new f(function(b){b(a)})},f.reject=function(a){return new f(function(b,c){c(a)})},f.race=function(a){return new f(function(b,c){for(var d=0,e=a.length;d<e;d++)a[d].then(b,c)})},f._setImmediateFn=function(b){c=b},"undefined"!=typeof b&&b.exports?b.exports=f:a.Promise||(a.Promise=f)}(this)},{}],4:[function(a,b,c){"use strict";var d=a("strict-uri-encode");c.extract=function(a){return a.split("?")[1]||""},c.parse=function(a){return"string"!=typeof a?{}:(a=a.trim().replace(/^(\?|#|&)/,""),a?a.split("&").reduce(function(a,b){var c=b.replace(/\+/g," ").split("="),d=c.shift(),e=c.length>0?c.join("="):void 0;return d=decodeURIComponent(d),e=void 0===e?null:decodeURIComponent(e),a.hasOwnProperty(d)?Array.isArray(a[d])?a[d].push(e):a[d]=[a[d],e]:a[d]=e,a},{}):{})},c.stringify=function(a){return a?Object.keys(a).sort().map(function(b){var c=a[b];return Array.isArray(c)?c.sort().map(function(a){return d(b)+"="+d(a)}).join("&"):d(b)+"="+d(c)}).filter(function(a){return a.length>0}).join("&"):""}},{"strict-uri-encode":5}],5:[function(a,b,c){"use strict";b.exports=function(a){return encodeURIComponent(a).replace(/[!'()*]/g,function(a){return"%"+a.charCodeAt(0).toString(16).toUpperCase()})}},{}],6:[function(a,b,c){var d=function(b){for(var d,e,c=0,f=b.length;c<f;c++)try{return e=b[c],d=e(),window.XMLHttpRequest?e:window.XMLHttpRequest=e}catch(a){continue}}([function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml3.")},function(){return new ActiveXObject("Msxml2.XMLHTTP.6.0")},function(){return new ActiveXObject("Msxml2.XMLHTTP.3.0")},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")},function(){return null}]);b.exports=function(){return d()}},{}],7:[function(a,b,c){function d(a){return a.replace(/[^ !'()~\*]*/g,encodeURIComponent).replace(/ /g,"+").replace(/[!'()~\*]/g,function(a){return"%"+("0"+a.charCodeAt(0).toString(16)).slice(-2).toUpperCase()})}function e(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(encodeURIComponent(c)+"="+d(a[c]));return b.join("&")}function f(a){var b=a.responseText,c=b.substring(b.indexOf("\n")+1);if(b.startsWith("Ok."))return c;throw Error("Unknown server error: "+b)}function g(a){function b(b,c){function d(a,c,d){return{method:b,url:g.url,sync:d,params:c,data:a&&e(a),headers:a&&{"Content-Type":"application/x-www-form-urlencoded"}}}var g=function(a,b){return h(d(a,b)).then(f)};return g.sync=function(a,b){return f(h(d(a,b,!0)))},g.url=a+c,g}return{inchi:b("POST","getinchi"),molfile:b("POST","getmolfile"),aromatize:b("POST","aromatize"),dearomatize:b("POST","dearomatize"),calculateCip:b("POST","calculate_cip"),automap:b("POST","automap"),layout_smiles:b("GET","layout"),layout:b("POST","layout"),smiles:b("POST","smiles"),save:b("POST","save"),knocknock:function(){return h(a+"knocknock").then(function(a){if("You are welcome!"!==a.responseText)throw Error("Server is not compatible")})}}}var h=a("./util/ajax.js");b.exports=g},{"./util/ajax.js":37}],8:[function(a,b,c){(function(b){var c=a("../util/map"),d=a("../util/vec2");a("./element"),a("./struct");var e=b.chem=b.chem||{};e.CisTrans=function(a,b,d){this.molecule=a,this.bonds=new c,this.getNeighbors=b,this.context=d},e.CisTrans.PARITY={NONE:0,CIS:1,TRANS:2},e.CisTrans.prototype.each=function(a,b){this.bonds.each(a,b)},e.CisTrans.prototype.getParity=function(a){return this.bonds.get(a).parity},e.CisTrans.prototype.getSubstituents=function(a){return this.bonds.get(a).substituents},e.CisTrans.prototype.sameside=function(a,b,c,e){var f=d.diff(a,b),g=new d(-f.y,f.x);if(!g.normalize())return 0;var h=d.diff(c,a),i=d.diff(e,b);if(!h.normalize())return 0;if(!i.normalize())return 0;var j=d.dot(h,g),k=d.dot(i,g);return Math.abs(j)<.001||Math.abs(k)<.001?0:j*k>0?1:-1},e.CisTrans.prototype._sameside=function(a,b,c,d){return this.sameside(this.molecule.atoms.get(a).pp,this.molecule.atoms.get(b).pp,this.molecule.atoms.get(c).pp,this.molecule.atoms.get(d).pp)},e.CisTrans.prototype._sortSubstituents=function(a){var b=this.molecule.atoms.get(a[0]).pureHydrogen(),c=a[1]<0||this.molecule.atoms.get(a[1]).pureHydrogen(),d=this.molecule.atoms.get(a[2]).pureHydrogen(),e=a[3]<0||this.molecule.atoms.get(a[3]).pureHydrogen();return(!b||!c)&&((!d||!e)&&(c?a[1]=-1:b?(a[0]=a[1],a[1]=-1):a[0]>a[1]&&a.swap(0,1),e?a[3]=-1:d?(a[2]=a[3],a[3]=-1):a[2]>a[3]&&a.swap(2,3),!0))},e.CisTrans.prototype.isGeomStereoBond=function(a,b){var c=this.molecule.bonds.get(a);if(c.type!=e.Struct.BOND.TYPE.DOUBLE)return!1;var d=this.molecule.atoms.get(c.begin).label,f=this.molecule.atoms.get(c.end).label;if("C"!=d&&"N"!=d&&"Si"!=d&&"Ge"!=d)return!1;if("C"!=f&&"N"!=f&&"Si"!=f&&"Ge"!=f)return!1;var g=this.getNeighbors.call(this.context,c.begin),h=this.getNeighbors.call(this.context,c.end);if(g.length<2||g.length>3||h.length<2||h.length>3)return!1;b[0]=-1,b[1]=-1,b[2]=-1,b[3]=-1;var i,j;for(i=0;i<g.length;i++)if(j=g[i],j.bid!=a){if(this.molecule.bonds.get(j.bid).type!=e.Struct.BOND.TYPE.SINGLE)return!1;-1==b[0]?b[0]=j.aid:b[1]=j.aid}for(i=0;i<h.length;i++)if(j=h[i],j.bid!=a){if(this.molecule.bonds.get(j.bid).type!=e.Struct.BOND.TYPE.SINGLE)return!1;-1==b[2]?b[2]=j.aid:b[3]=j.aid}return(-1==b[1]||-1==this._sameside(c.begin,c.end,b[0],b[1]))&&(-1==b[3]||-1==this._sameside(c.begin,c.end,b[2],b[3]))},e.CisTrans.prototype.build=function(a){this.molecule.bonds.each(function(b,c){var d=this.bonds.set(b,{parity:0,substituents:new Array(4)});if((!Object.isArray(a)||!a[b])&&this.isGeomStereoBond(b,d.substituents)&&this._sortSubstituents(d.substituents)){var f=this._sameside(c.begin,c.end,d.substituents[0],d.substituents[2]);1==f?d.parity=e.CisTrans.PARITY.CIS:-1==f&&(d.parity=e.CisTrans.PARITY.TRANS)}},this)}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../util/map":40,"../util/vec2":43,"./element":10,"./struct":16}],9:[function(a,b,c){(function(b){var c=a("../util/set");a("../util/"),a("./element");var d=b.chem=b.chem||{};b.util;d.Dfs=function(a,b,c,e){this.molecule=a,this.atom_data=b,this.components=c,this.nComponentsInReactants=-1,this.nReactants=e,this.vertices=new Array(this.molecule.atoms.count()),this.molecule.atoms.each(function(a){this.vertices[a]=new d.Dfs.VertexDesc},this),this.edges=new Array(this.molecule.bonds.count()),this.molecule.bonds.each(function(a){this.edges[a]=new d.Dfs.EdgeDesc},this),this.v_seq=[]},d.Dfs.VertexDesc=function(){this.dfs_state=0,this.parent_vertex=0,this.parent_edge=0,this.branches=0},d.Dfs.EdgeDesc=function(){this.opening_cycles=0,this.closing_cycle=0},d.Dfs.SeqElem=function(a,b,c){this.idx=a,this.parent_vertex=b,this.parent_edge=c},d.Dfs.prototype.walk=function(){for(var a,b,e=[],f=0,g=0;;){if(e.length<1){for(var h=-1,i=function(a){return 0==this.vertices[a].dfs_state&&(h=a,!0)};f<this.components.length&&-1==h;)h=c.find(this.components[f],i,this),null===h&&(h=-1,f++,f==this.nReactants&&(this.nComponentsInReactants=g));if(-1>h&&this.molecule.atoms.find(i,this),-1==h)break;this.vertices[h].parent_vertex=-1,this.vertices[h].parent_edge=-1,e.push(h),g++}var j=e.pop(),k=this.vertices[j].parent_vertex,l=new d.Dfs.SeqElem(j,k,this.vertices[j].parent_edge);this.v_seq.push(l),this.vertices[j].dfs_state=2;var m=this.atom_data[j];for(a=0;a<m.neighbours.length;a++){var n=m.neighbours[a].aid,o=m.neighbours[a].bid;if(n!=k)if(2==this.vertices[n].dfs_state){for(this.edges[o].closing_cycle=1,b=j;-1!=b&&this.vertices[b].parent_vertex!=n;)b=this.vertices[b].parent_vertex;if(-1==b)throw new Error("cycle unwind error");this.edges[this.vertices[b].parent_edge].opening_cycles++,this.vertices[j].branches++,l=new d.Dfs.SeqElem(n,j,o),this.v_seq.push(l)}else{if(1==this.vertices[n].dfs_state){if(b=e.indexOf(n),-1==b)throw new Error("internal: removing vertex from stack");e.splice(b,1);var p=this.vertices[n].parent_vertex;p>=0&&this.vertices[p].branches--}this.vertices[j].branches++,this.vertices[n].parent_vertex=j,this.vertices[n].parent_edge=o,this.vertices[n].dfs_state=1,e.push(n)}}}},d.Dfs.prototype.edgeClosingCycle=function(a){return 0!=this.edges[a].closing_cycle},d.Dfs.prototype.numBranches=function(a){return this.vertices[a].branches},d.Dfs.prototype.numOpeningCycles=function(a){return this.edges[a].opening_cycles},d.Dfs.prototype.toString=function(){var a="";return this.v_seq.each(function(b){a+=b.idx+" -> "}),a+="*"}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../util/":39,"../util/set":42,"./element":10}],10:[function(a,b,c){function d(a,b,c,d,e){return{label:a,period:b,group:c,putHydrogenOnTheLeft:d,color:e||"#000000"}}var e=a("../util/map"),f=new e({1:d("H",1,1,!1,"#000000"),2:d("He",1,8,!1,"#d9ffff"),3:d("Li",2,1,!1,"#cc80ff"),4:d("Be",2,2,!1,"#c2ff00"),5:d("B",2,3,!1,"#ffb5b5"),6:d("C",2,4,!1,"#000000"),7:d("N",2,5,!1,"#304ff7"),8:d("O",2,6,!0,"#ff0d0d"),9:d("F",2,7,!0,"#8fe04f"),10:d("Ne",2,8,!1,"#b3e3f5"),11:d("Na",3,1,!1,"#ab5cf2"),12:d("Mg",3,2,!1,"#8aff00"),13:d("Al",3,3,!1,"#bfa6a6"),14:d("Si",3,4,!1,"#f0c7a1"),15:d("P",3,5,!1,"#ff8000"),16:d("S",3,6,!0,"#d9a61a"),17:d("Cl",3,7,!0,"#1fd01f"),18:d("Ar",3,8,!1,"#80d1e3"),19:d("K",4,1,!1,"#8f40d4"),20:d("Ca",4,2,!1,"#3dff00"),21:d("Sc",4,3,!1,"#e6e6e6"),22:d("Ti",4,4,!1,"#bfc2c7"),23:d("V",4,5,!1,"#a6a6ab"),24:d("Cr",4,6,!1,"#8a99c7"),25:d("Mn",4,7,!1,"#9c7ac7"),26:d("Fe",4,8,!1,"#e06633"),27:d("Co",4,8,!1,"#f08fa1"),28:d("Ni",4,8,!1,"#4fd14f"),29:d("Cu",4,1,!1,"#c78033"),30:d("Zn",4,2,!1,"#7d80b0"),31:d("Ga",4,3,!1,"#c28f8f"),32:d("Ge",4,4,!1,"#668f8f"),33:d("As",4,5,!1,"#bd80e3"),34:d("Se",4,6,!0,"#ffa100"),35:d("Br",4,7,!0,"#a62929"),36:d("Kr",4,8,!1,"#5cb8d1"),37:d("Rb",5,1,!1,"#702eb0"),38:d("Sr",5,2,!1,"#00ff00"),39:d("Y",5,3,!1,"#94ffff"),40:d("Zr",5,4,!1,"#94e0e0"),41:d("Nb",5,5,!1,"#73c2c9"),42:d("Mo",5,6,!1,"#54b5b5"),43:d("Tc",5,7,!1,"#3b9e9e"),44:d("Ru",5,8,!1,"#248f8f"),45:d("Rh",5,8,!1,"#0a7d8c"),46:d("Pd",5,8,!1,"#006985"),47:d("Ag",5,1,!1,"#bfbfbf"),48:d("Cd",5,2,!1,"#ffd98f"),49:d("In",5,3,!1,"#a67573"),50:d("Sn",5,4,!1,"#668080"),51:d("Sb",5,5,!1,"#9e63b5"),52:d("Te",5,6,!1,"#d47a00"),53:d("I",5,7,!0,"#940094"),54:d("Xe",5,8,!1,"#429eb0"),55:d("Cs",6,1,!1,"#57178f"),56:d("Ba",6,2,!1,"#00c900"),57:d("La",6,3,!1,"#70d4ff"),58:d("Ce",6,3,!1,"#ffffc7"),59:d("Pr",6,3,!1,"#d9ffc7"),60:d("Nd",6,3,!1,"#c7ffc7"),61:d("Pm",6,3,!1,"#a3ffc7"),62:d("Sm",6,3,!1,"#8fffc7"),63:d("Eu",6,3,!1,"#61ffc7"),64:d("Gd",6,3,!1,"#45ffc7"),65:d("Tb",6,3,!1,"#30ffc7"),66:d("Dy",6,3,!1,"#1fffc7"),67:d("Ho",6,3,!1,"#00ff9c"),68:d("Er",6,3,!1,"#00e675"),69:d("Tm",6,3,!1,"#00d452"),70:d("Yb",6,3,!1,"#00bf38"),71:d("Lu",6,3,!1,"#00ab24"),72:d("Hf",6,4,!1,"#4dc2ff"),73:d("Ta",6,5,!1,"#4da6ff"),74:d("W",6,6,!1,"#2194d6"),75:d("Re",6,7,!1,"#267dab"),76:d("Os",6,8,!1,"#266696"),77:d("Ir",6,8,!1,"#175487"),78:d("Pt",6,8,!1,"#d1d1e0"),79:d("Au",6,1,!1,"#ffd124"),80:d("Hg",6,2,!1,"#b8b8d1"),81:d("Tl",6,3,!1,"#a6544d"),82:d("Pb",6,4,!1,"#575961"),83:d("Bi",6,5,!1,"#9e4fb5"),84:d("Po",6,6,!1,"#ab5c00"),85:d("At",6,7,!1,"#754f45"),86:d("Rn",6,8,!1,"#428296"),87:d("Fr",7,1,!1,"#420066"),88:d("Ra",7,2,!1,"#007d00"),89:d("Ac",7,3,!1,"#70abfa"),90:d("Th",7,3,!1,"#00baff"),91:d("Pa",7,3,!1,"#00a1ff"),92:d("U",7,3,!1,"#008fff"),93:d("Np",7,3,!1,"#0080ff"),94:d("Pu",7,3,!1,"#006bff"),95:d("Am",7,3,!1,"#545cf2"),96:d("Cm",7,3,!1,"#785ce3"),97:d("Bk",7,3,!1,"#8a4fe3"),98:d("Cf",7,3,!1,"#a136d4"),99:d("Es",7,3,!1,"#b31fd4"),100:d("Fm",7,3,!1,"#000000"),101:d("Md",7,3,!1,"#000000"),102:d("No",7,3,!1,"#000000"),103:d("Lr",7,3,!1,"#000000"),104:d("Rf",7,4,!1,"#4dc2ff"),105:d("Db",7,5,!1,"#4da6ff"),106:d("Sg",7,6,!1,"#2194d6"),107:d("Bh",7,7,!1,"#267dab"),108:d("Hs",7,8,!1,"#266696"),109:d("Mt",7,8,!1,"#175487"),110:d("Ds",7,8,!1,"#d1d1e0"),111:d("Rg",7,1,!1,"#ffd124"),112:d("Cn",7,2,!1,"#b8b8d1"),113:d("Uut",7,3,!1),114:d("Fl",7,4,!1),115:d("Uup",7,5,!1),116:d("Lv",7,6,!1),117:d("Uus",7,7,!1),118:d("Uuo",7,8,!1)}),g=null;f.getElementByLabel=function(a){return g||(g={},f.each(function(a,b){g[b.label]=a-0})),g[a]||null},b.exports=f},{"../util/map":40}],11:[function(a,b,c){(function(b){a("./struct"),a("./cis_trans"),a("./dfs"),a("./molfile"),a("./sgroup"),a("./smiles"),a("./stereocenters"),a("./struct_valence"),b.chem=b.chem||{}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./cis_trans":8,"./dfs":9,"./molfile":12,"./sgroup":13,"./smiles":14,"./stereocenters":15,"./struct":16,"./struct_valence":17}],12:[function(a,b,c){(function(b){var c=a("../util/map"),d=a("../util/set"),e=a("../util/vec2"),f=a("./element"),g=a("../util"),h=b.chem=b.chem||{};h.Molfile=function(){},h.Molfile.loadRGroupFragments=!0,h.Molfile.parseDecimalInt=function(a){var b=parseInt(a,10);return isNaN(b)?0:b},h.Molfile.partitionLine=function(a,b,c){for(var d=[],e=0,f=0;e<b.length;++e)d.push(a.slice(f,f+b[e])),c&&f++,f+=b[e];return d},h.Molfile.partitionLineFixed=function(a,b,c){for(var d=[],e=0;e<a.length;e+=b)d.push(a.slice(e,e+b)),c&&e++;return d},h.Molfile.parseCTFile=function(a){var b=Array.isArray(a)?a:g.splitNewlines(a),c=null;return c=0==b[0].search("\\$RXN")?h.Molfile.parseRxn(b):h.Molfile.parseMol(b),c.initHalfBonds(),c.initNeighbors(),c.markFragments(),c},h.Molfile.fmtInfo={bondTypeMap:{1:h.Struct.BOND.TYPE.SINGLE,2:h.Struct.BOND.TYPE.DOUBLE,3:h.Struct.BOND.TYPE.TRIPLE,4:h.Struct.BOND.TYPE.AROMATIC,5:h.Struct.BOND.TYPE.SINGLE_OR_DOUBLE,6:h.Struct.BOND.TYPE.SINGLE_OR_AROMATIC,7:h.Struct.BOND.TYPE.DOUBLE_OR_AROMATIC,8:h.Struct.BOND.TYPE.ANY},bondStereoMap:{0:h.Struct.BOND.STEREO.NONE,1:h.Struct.BOND.STEREO.UP,4:h.Struct.BOND.STEREO.EITHER,6:h.Struct.BOND.STEREO.DOWN,3:h.Struct.BOND.STEREO.CIS_TRANS},v30bondStereoMap:{0:h.Struct.BOND.STEREO.NONE,1:h.Struct.BOND.STEREO.UP,2:h.Struct.BOND.STEREO.EITHER,3:h.Struct.BOND.STEREO.DOWN},bondTopologyMap:{0:h.Struct.BOND.TOPOLOGY.EITHER,1:h.Struct.BOND.TOPOLOGY.RING,2:h.Struct.BOND.TOPOLOGY.CHAIN},countsLinePartition:[3,3,3,3,3,3,3,3,3,3,3,6],atomLinePartition:[10,10,10,1,3,2,3,3,3,3,3,3,3,3,3,3,3],bondLinePartition:[3,3,3,3,3,3,3],atomListHeaderPartition:[3,1,1,4,1,1],atomListHeaderLength:11,atomListHeaderItemLength:4,chargeMap:[0,3,2,1,0,-1,-2,-3],valenceMap:[void 0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,0],implicitHydrogenMap:[void 0,0,1,2,3,4],v30atomPropMap:{CHG:"charge",RAD:"radical",MASS:"isotope",VAL:"explicitValence",HCOUNT:"hCount",INVRET:"invRet",SUBST:"substitutionCount",UNSAT:"unsaturatedAtom",RBCNT:"ringBondCount"},rxnItemsPartition:[3,3,3]},h.Molfile.parseAtomLine=function(a){var b=h.Molfile,c=b.partitionLine(a,b.fmtInfo.atomLinePartition),d={pp:new e(parseFloat(c[0]),-parseFloat(c[1])),label:c[4].strip(),explicitValence:b.fmtInfo.valenceMap[b.parseDecimalInt(c[10])],massDifference:b.parseDecimalInt(c[5]),charge:b.fmtInfo.chargeMap[b.parseDecimalInt(c[6])],hCount:b.parseDecimalInt(b.parseDecimalInt(c[8])),stereoCare:0!=b.parseDecimalInt(c[9]),aam:b.parseDecimalInt(c[14]),invRet:b.parseDecimalInt(c[15]),exactChangeFlag:0!=b.parseDecimalInt(c[16])};return new h.Struct.Atom(d)},h.Molfile.stripV30=function(a){if("M  V30 "!=a.slice(0,7))throw Error("Prefix invalid");return a.slice(7)},h.Molfile.parseAtomLineV3000=function(a){var b,c,d,f,g,i=h.Molfile;b=i.spaceparsplit(a);var j={pp:new e(parseFloat(b[2]),-parseFloat(b[3])),aam:b[5].strip()},k=b[1].strip();if('"'==k.charAt(0)&&'"'==k.charAt(k.length-1)&&(k=k.substr(1,k.length-2)),"]"==k.charAt(k.length-1)){k=k.substr(0,k.length-1);var l={};if(l.notList=!1,"NOT ["==k.substr(0,5))l.notList=!0,k=k.substr(5);else{if("["!=k.charAt(0))throw"Error: atom list expected, found '"+k+"'";k=k.substr(1)}l.ids=i.labelsListToIds(k.split(",")),j.atomList=new h.Struct.AtomList(l),j.label="L#"}else j.label=k;for(b.splice(0,6),g=0;g<b.length;++g)if(c=i.splitonce(b[g],"="),d=c[0],f=c[1],d in i.fmtInfo.v30atomPropMap){var m=i.parseDecimalInt(f);if("VAL"==d){if(0==m)continue;-1==m&&(m=0)}j[i.fmtInfo.v30atomPropMap[d]]=m}else if("RGROUPS"==d){f=f.strip().substr(1,f.length-2);var n=f.split(" ").slice(1);j.rglabel=0;for(var o=0;o<n.length;++o)j.rglabel|=1<<n[o]-1}else"ATTCHPT"==d&&(j.attpnt=f.strip()-0);return new h.Struct.Atom(j)},h.Molfile.parseBondLineV3000=function(a){var b,c,d,e,f,g=h.Molfile;b=g.spaceparsplit(a);var i={begin:g.parseDecimalInt(b[2])-1,end:g.parseDecimalInt(b[3])-1,type:g.fmtInfo.bondTypeMap[g.parseDecimalInt(b[1])]};for(b.splice(0,4),f=0;f<b.length;++f)c=g.splitonce(b[f],"="),d=c[0],e=c[1],"CFG"==d?(i.stereo=g.fmtInfo.v30bondStereoMap[g.parseDecimalInt(e)],i.type==h.Struct.BOND.TYPE.DOUBLE&&i.stereo==h.Struct.BOND.STEREO.EITHER&&(i.stereo=h.Struct.BOND.STEREO.CIS_TRANS)):"TOPO"==d?i.topology=g.fmtInfo.bondTopologyMap[g.parseDecimalInt(e)]:"RXCTR"==d?i.reactingCenterStatus=g.parseDecimalInt(e):"STBOX"==d&&(i.stereoCare=g.parseDecimalInt(e));return new h.Struct.Bond(i)},h.Molfile.parseBondLine=function(a){var b=h.Molfile,c=b.partitionLine(a,b.fmtInfo.bondLinePartition),d={begin:b.parseDecimalInt(c[0])-1,end:b.parseDecimalInt(c[1])-1,type:b.fmtInfo.bondTypeMap[b.parseDecimalInt(c[2])],stereo:b.fmtInfo.bondStereoMap[b.parseDecimalInt(c[3])],topology:b.fmtInfo.bondTopologyMap[b.parseDecimalInt(c[5])],reactingCenterStatus:b.parseDecimalInt(c[6])};return new h.Struct.Bond(d)},h.Molfile.parseAtomListLine=function(a){for(var b=h.Molfile,c=b.partitionLine(a,b.fmtInfo.atomListHeaderPartition),d=b.parseDecimalInt(c[0])-1,e="T"==c[2].strip(),f=b.parseDecimalInt(c[4].strip()),g=a.slice(b.fmtInfo.atomListHeaderLength),i=[],j=b.fmtInfo.atomListHeaderItemLength,k=0;f>k;++k)i[k]=b.parseDecimalInt(g.slice(k*j,(k+1)*j-1));return{aid:d,atomList:new h.Struct.AtomList({notList:e,ids:i})}},h.Molfile.readKeyValuePairs=function(a,b){for(var c=h.Molfile,d={},e=c.partitionLineFixed(a,3,!0),f=c.parseDecimalInt(e[0]),g=0;f>g;++g)d[c.parseDecimalInt(e[2*g+1])-1]=b?e[2*g+2].strip():c.parseDecimalInt(e[2*g+2]);return d},h.Molfile.readKeyMultiValuePairs=function(a,b){for(var c=h.Molfile,d=[],e=c.partitionLineFixed(a,3,!0),f=c.parseDecimalInt(e[0]),g=0;f>g;++g)d.push([c.parseDecimalInt(e[2*g+1])-1,b?e[2*g+2].strip():c.parseDecimalInt(e[2*g+2])]);return d},h.Molfile.labelsListToIds=function(a){for(var b=[],c=0;c<a.length;++c)b.push(f.getElementByLabel(a[c].strip()));return b},h.Molfile.parsePropertyLineAtomList=function(a,b){var c=h.Molfile,d=c.parseDecimalInt(a[1])-1,e=c.parseDecimalInt(a[2]),f="T"==a[4].strip(),g=c.labelsListToIds(b.slice(0,e)),i={};return i[d]=new h.Struct.AtomList({notList:f,ids:g}),i},h.Molfile.initSGroup=function(a,b){var c=h.Molfile,d=c.readKeyValuePairs(b,!0);for(var e in d){var f=d[e];if(!(f in h.SGroup.TYPES))throw new Error("Unsupported S-group type");var g=new h.SGroup(f);g.number=e,a[e]=g}},h.Molfile.applySGroupProp=function(a,b,c,d,e){var f=h.Molfile,g=f.readKeyValuePairs(c,!d);for(var i in g)(e?a[i]:a[i].data)[b]=g[i]},h.Molfile.toIntArray=function(a){for(var b=h.Molfile,c=[],d=0;d<a.length;++d)c[d]=b.parseDecimalInt(a[d]);return c},h.Molfile.applySGroupArrayProp=function(a,b,c,d){var e=h.Molfile,f=e.parseDecimalInt(c.slice(1,4))-1,i=e.parseDecimalInt(c.slice(4,8)),j=e.toIntArray(e.partitionLineFixed(c.slice(8),3,!0));if(j.length!=i)throw new Error("File format invalid");d&&g.apply(j,function(a){return a+d}),a[f][b]=a[f][b].concat(j)},h.Molfile.applyDataSGroupName=function(a,b){a.data.fieldName=b},h.Molfile.applyDataSGroupQuery=function(a,b){a.data.query=b},h.Molfile.applyDataSGroupQueryOp=function(a,b){a.data.queryOp=b},h.Molfile.applyDataSGroupDesc=function(a,b){var c=h.Molfile,d=c.partitionLine(b,[4,31,2,20,2,3],!1),e=c.parseDecimalInt(d[0])-1,f=d[1].strip(),g=d[2].strip(),i=d[3].strip(),j=d[4].strip(),k=d[5].strip(),l=a[e];l.data.fieldType=g,l.data.fieldName=f,l.data.units=i,l.data.query=j,l.data.queryOp=k},h.Molfile.applyDataSGroupInfo=function(a,b){var c=h.Molfile,d=c.partitionLine(b,[10,10,4,1,1,1,3,3,3,3,2,3,2],!1),f=parseFloat(d[0]),g=parseFloat(d[1]),i="A"==d[3].strip(),j="A"==d[4].strip(),k="U"==d[5].strip(),l=d[7].strip();l="ALL"==l?-1:c.parseDecimalInt(l);var m=d[10].strip(),n=c.parseDecimalInt(d[11].strip());a.pp=new e(f,-g),a.data.attached=i,a.data.absolute=j,a.data.showUnits=k,a.data.nCharsToDisplay=l,a.data.tagChar=m,a.data.daspPos=n},h.Molfile.applyDataSGroupInfoLine=function(a,b){var c=h.Molfile,d=c.parseDecimalInt(b.substr(0,4))-1,e=a[d];c.applyDataSGroupInfo(e,b.substr(5))},h.Molfile.applyDataSGroupData=function(a,b,c){a.data.fieldValue=(a.data.fieldValue||"")+b,c&&(a.data.fieldValue=g.stripRight(a.data.fieldValue),a.data.fieldValue.startsWith('"')&&a.data.fieldValue.endsWith('"')&&(a.data.fieldValue=a.data.fieldValue.substr(1,a.data.fieldValue.length-2)))},h.Molfile.applyDataSGroupDataLine=function(a,b,c){var d=h.Molfile,e=d.parseDecimalInt(b.substr(0,5))-1,f=b.substr(5),g=a[e];d.applyDataSGroupData(g,f,c)},h.Molfile.parsePropertyLines=function(a,b,d,e,f,g){for(var i=h.Molfile,j=new c;e>d;){var k=b[d];if("A"==k.charAt(0))j.get("label")||j.set("label",new c),j.get("label").set(i.parseDecimalInt(k.slice(3,6))-1,b[++d]);else if("M"==k.charAt(0)){var l=k.slice(3,6),m=k.slice(6);if("END"==l)break;if("CHG"==l)j.get("charge")||j.set("charge",new c),j.get("charge").update(i.readKeyValuePairs(m));else if("RAD"==l)j.get("radical")||j.set("radical",new c),j.get("radical").update(i.readKeyValuePairs(m));else if("ISO"==l)j.get("isotope")||j.set("isotope",new c),j.get("isotope").update(i.readKeyValuePairs(m));else if("RBC"==l)j.get("ringBondCount")||j.set("ringBondCount",new c),j.get("ringBondCount").update(i.readKeyValuePairs(m));else if("SUB"==l)j.get("substitutionCount")||j.set("substitutionCount",new c),j.get("substitutionCount").update(i.readKeyValuePairs(m));else if("UNS"==l)j.get("unsaturatedAtom")||j.set("unsaturatedAtom",new c),j.get("unsaturatedAtom").update(i.readKeyValuePairs(m));else if("RGP"==l){j.get("rglabel")||j.set("rglabel",new c);for(var n=j.get("rglabel"),o=i.readKeyMultiValuePairs(m),p=0;p<o.length;p++){var q=o[p];n.set(q[0],(n.get(q[0])||0)|1<<q[1]-1)}}else if("LOG"==l){m=m.slice(4);var r=i.parseDecimalInt(m.slice(0,3).strip()),s=i.parseDecimalInt(m.slice(4,7).strip()),t=i.parseDecimalInt(m.slice(8,11).strip()),u=m.slice(12).strip(),v={};s>0&&(v.ifthen=s),v.resth=1==t,v.range=u,g[r]=v}else if("APO"==l)j.get("attpnt")||j.set("attpnt",new c),j.get("attpnt").update(i.readKeyValuePairs(m));else if("ALS"==l){j.get("atomList")||j.set("atomList",new c);var w=i.parsePropertyLineAtomList(i.partitionLine(m,[1,3,3,1,1,1]),i.partitionLineFixed(m.slice(10),4,!1));j.get("atomList").update(w),j.get("label")||j.set("label",new c);for(var x in w)j.get("label").set(x,"L#")}else if("STY"==l)i.initSGroup(f,m);else if("SST"==l)i.applySGroupProp(f,"subtype",m);else if("SLB"==l)i.applySGroupProp(f,"label",m,!0);else if("SPL"==l)i.applySGroupProp(f,"parent",m,!0,!0);else if("SCN"==l)i.applySGroupProp(f,"connectivity",m);else if("SAL"==l)i.applySGroupArrayProp(f,"atoms",m,-1);else if("SBL"==l)i.applySGroupArrayProp(f,"bonds",m,-1);else if("SPA"==l)i.applySGroupArrayProp(f,"patoms",m,-1);else if("SMT"==l){var y=i.parseDecimalInt(m.slice(0,4))-1;
f[y].data.subscript=m.slice(4).strip()}else"SDT"==l?i.applyDataSGroupDesc(f,m):"SDD"==l?i.applyDataSGroupInfoLine(f,m):"SCD"==l?i.applyDataSGroupDataLine(f,m,!1):"SED"==l&&i.applyDataSGroupDataLine(f,m,!0)}++d}return j},h.Molfile.applyAtomProp=function(a,b,c){b.each(function(b,d){a.get(b)[c]=d})},h.Molfile.parseCTabV2000=function(a,b){var c,d=new h.Struct,e=h.Molfile,f=e.parseDecimalInt(b[0]),i=e.parseDecimalInt(b[1]),j=e.parseDecimalInt(b[2]);d.isChiral=0!=e.parseDecimalInt(b[4]);var k=e.parseDecimalInt(b[5]),l=e.parseDecimalInt(b[10]),m=0,n=a.slice(m,m+f);m+=f;var o=a.slice(m,m+i);m+=i;var p=a.slice(m,m+j);m+=j+k;var q=n.map(e.parseAtomLine);for(c=0;c<q.length;++c)d.atoms.add(q[c]);var r=o.map(e.parseBondLine);for(c=0;c<r.length;++c)d.bonds.add(r[c]);var s=p.map(e.parseAtomListLine);s.each(function(a){d.atoms.get(a.aid).atomList=a.atomList,d.atoms.get(a.aid).label="L#"});var t={},u={},v=e.parsePropertyLines(d,a,m,Math.min(a.length,m+l),t,u);v.each(function(a,b){e.applyAtomProp(d.atoms,b,a)});var w,x={};for(w in t){var y=t[w];if("DAT"===y.type&&0===y.atoms.length){var z=t[w].parent;if(z>=0){var A=t[z-1];"GEN"===A.type&&(y.atoms=g.array(A.atoms))}}}for(w in t)h.SGroup.addGroup(d,t[w],x);var B=[];for(w in t)h.SGroup.filter(d,t[w],x),0!=t[w].atoms.length||t[w].allAtoms||B.push(w);for(c=0;c<B.length;++c)d.sGroupForest.remove(B[c]),d.sgroups.remove(B[c]);for(var C in u)d.rgroups.set(C,new h.Struct.RGroup(u[C]));return d},h.Molfile.spaceparsplit=function(a){var b,c,d=[],e=0,f=-1,g=a.toArray(),h=!1;for(c=0;c<a.length;++c)b=g[c],"("==b?e++:")"==b&&e--,'"'==b&&(h=!h),h||" "!=g[c]||0!=e||(c>f+1&&d.push(a.slice(f+1,c)),f=c);return c>f+1&&d.push(a.slice(f+1,c)),f=c,d},h.Molfile.splitonce=function(a,b){var c=a.indexOf(b);return[a.slice(0,c),a.slice(c+1)]},h.Molfile.splitSGroupDef=function(a){for(var b=[],c=0,d=!1,e=0;e<a.length;++e){var f=a.charAt(e);'"'==f?d=!d:d||("("==f?c++:")"==f?c--:" "==f&&0==c&&(b.push(a.slice(0,e)),a=a.slice(e+1).strip(),e=0))}if(0!=c)throw"Brace balance broken. S-group properies invalid!";return a.length>0&&b.push(a.strip()),b},h.Molfile.parseBracedNumberList=function(a,b){if(!a)return null;var c=[];a=a.strip(),a=a.substr(1,a.length-2);var d=a.split(" ");b=b||0;for(var e=1;e<d.length;++e)c.push(d[e]-0+b);return c},h.Molfile.v3000parseCollection=function(a,b,c){for(c++;"M  V30 END COLLECTION"!=b[c].strip();)c++;return c++,c},h.Molfile.v3000parseSGroup=function(a,b,c,d,e){var f=h.Molfile,i="";for(e++;e<b.length;){if(i=f.stripV30(b[e++]).strip(),"END SGROUP"==i.strip())return e;for(;"-"==i.charAt(i.length-1);)i=(i.substr(0,i.length-1)+f.stripV30(b[e++])).strip();var j=f.splitSGroupDef(i),k=j[1],l=new h.SGroup(k);l.number=j[0]-0,l.type=k,l.label=j[2]-0,c[l.number]=l;for(var m={},n=3;n<j.length;++n){var o=f.splitonce(j[n],"=");if(2!=o.length)throw"A record of form AAA=BBB or AAA=(...) expected, got '"+j[n]+"'";var p=o[0];p in m||(m[p]=[]),m[p].push(o[1])}l.atoms=f.parseBracedNumberList(m.ATOMS[0],-1),m.PATOMS&&(l.patoms=f.parseBracedNumberList(m.PATOMS[0],-1)),l.bonds=m.BONDS?f.parseBracedNumberList(m.BONDS[0],-1):[];var q=m.BRKXYZ;if(l.brkxyz=[],q)for(var r=0;r<q.length;++r)l.brkxyz.push(f.parseBracedNumberList(q[r]));m.MULT&&(l.data.subscript=m.MULT[0]-0),m.LABEL&&(l.data.subscript=m.LABEL[0].strip()),m.CONNECT&&(l.data.connectivity=m.CONNECT[0].toLowerCase()),m.FIELDDISP&&f.applyDataSGroupInfo(l,g.stripQuotes(m.FIELDDISP[0])),m.FIELDDATA&&f.applyDataSGroupData(l,m.FIELDDATA[0],!0),m.FIELDNAME&&f.applyDataSGroupName(l,m.FIELDNAME[0]),m.QUERYTYPE&&f.applyDataSGroupQuery(l,m.QUERYTYPE[0]),m.QUERYOP&&f.applyDataSGroupQueryOp(l,m.QUERYOP[0]),h.SGroup.addGroup(a,l,d)}throw new Error("S-group declaration incomplete.")},h.Molfile.parseCTabV3000=function(a,b){var c=new h.Struct,d=h.Molfile,e=0;if("M  V30 BEGIN CTAB"!=a[e++].strip())throw Error("CTAB V3000 invalid");if("M  V30 COUNTS"!=a[e].slice(0,13))throw Error("CTAB V3000 invalid");var f=a[e].slice(14).split(" ");if(c.isChiral=1==d.parseDecimalInt(f[4]),e++,"M  V30 BEGIN ATOM"==a[e].strip()){e++;for(var g;e<a.length&&(g=d.stripV30(a[e++]).strip(),"END ATOM"!=g);){for(;"-"==g.charAt(g.length-1);)g=(g.substring(0,g.length-1)+d.stripV30(a[e++])).strip();c.atoms.add(d.parseAtomLineV3000(g))}if("M  V30 BEGIN BOND"==a[e].strip())for(e++;e<a.length&&(g=d.stripV30(a[e++]).strip(),"END BOND"!=g);){for(;"-"==g.charAt(g.length-1);)g=(g.substring(0,g.length-1)+d.stripV30(a[e++])).strip();c.bonds.add(d.parseBondLineV3000(g))}for(var i={},j={};"M  V30 END CTAB"!=a[e].strip();)if("M  V30 BEGIN COLLECTION"==a[e].strip())e=d.v3000parseCollection(c,a,e);else{if("M  V30 BEGIN SGROUP"!=a[e].strip())throw Error("CTAB V3000 invalid");e=d.v3000parseSGroup(c,a,i,j,e)}}if("M  V30 END CTAB"!=a[e++].strip())throw Error("CTAB V3000 invalid");return b||d.readRGroups3000(c,a.slice(e)),c},h.Molfile.readRGroups3000=function(a,b){for(var c={},d={},e=0,f=h.Molfile;e<b.length&&0==b[e].search("M  V30 BEGIN RGROUP");){var g=b[e++].split(" ").pop();for(c[g]=[],d[g]={};;){var i=b[e].strip();if(0!=i.search("M  V30 RLOGIC")){if("M  V30 BEGIN CTAB"!=i)throw Error("CTAB V3000 invalid");for(var j=0;j<b.length&&"M  V30 END CTAB"!=b[e+j].strip();++j);var k=b.slice(e,e+j+1),l=this.parseCTabV3000(k,!0);if(c[g].push(l),e=e+j+1,"M  V30 END RGROUP"==b[e].strip()){e++;break}}else{i=i.slice(13);var m=i.strip().split(/\s+/g),n=f.parseDecimalInt(m[0]),o=f.parseDecimalInt(m[1]),p=m.slice(2).join(" "),q={};n>0&&(q.ifthen=n),q.resth=1==o,q.range=p,d[g]=q,e++}}}for(var r in c)for(var s=0;s<c[r].length;++s){var t=c[r][s];t.rgroups.set(r,new h.Struct.RGroup(d[r]));var u=t.frags.add(new h.Struct.Fragment);t.rgroups.get(r).frags.add(u),t.atoms.each(function(a,b){b.fragment=u}),t.mergeInto(a)}},h.Molfile.parseMol=function(a){if(0==a[0].search("\\$MDL"))return this.parseRg2000(a);var b=this.parseCTab(a.slice(3));return b.name=a[0].strip(),b},h.Molfile.parseCTab=function(a){var b=h.Molfile,c=b.partitionLine(a[0],b.fmtInfo.countsLinePartition),d=c[11].strip();if(a=a.slice(1),"V2000"==d)return this.parseCTabV2000(a,c);if("V3000"==d)return this.parseCTabV3000(a,!h.Molfile.loadRGroupFragments);throw Error("Molfile version unknown: "+d)},h.MolfileSaver=function(a){this.molecule=null,this.molfile=null,this.v3000=a||!1},h.MolfileSaver.prototype.prepareSGroups=function(a,b){var c=this.molecule;c.sgroups;var d=[],e=0;g.each(this.molecule.sGroupForest.getSGroupsBFS().reverse(),function(f){var g=c.sgroups.get(f),h=!1;try{g.prepareForSaving(c)}catch(b){if(!a||"number"!=typeof b.id)throw b;h=!0}(h||!b&&/^INDIGO_.+_DESC$/i.test(g.data.fieldName))&&(e+=h,d.push(g.id))},this),e&&alert("WARNING: "+e+" invalid S-groups were detected. They will be omitted.");for(var f=0;f<d.length;++f)c.sGroupDelete(d[f]);return c},h.MolfileSaver.getComponents=function(a){var b=a.findConnectedComponents(!0),c=[],f=null;a.rxnArrows.each(function(a,b){f=b.pp.x}),a.rxnPluses.each(function(a,b){c.push(b.pp.x)}),null!=f&&c.push(f),c.sort(function(a,b){return a-b});var g,h=[];for(g=0;g<b.length;++g){for(var i=a.getCoordBoundingBox(b[g]),j=e.lc2(i.min,.5,i.max,.5),k=0;j.x>c[k];)++k;h[k]=h[k]||{},d.mergeIn(h[k],b[g])}var l=[],m=[],n=[];for(g=0;g<h.length;++g)h[g]?(i=a.getCoordBoundingBox(h[g]),j=e.lc2(i.min,.5,i.max,.5),j.x<f?m.push(h[g]):n.push(h[g])):l.push("");return{reactants:m,products:n}},h.MolfileSaver.prototype.getCTab=function(a,b){return this.molecule=a.clone(),this.molfile="",this.writeCTab2000(b),this.molfile},h.MolfileSaver.prototype.saveMolecule=function(a,b,c,d){if(this.reaction=a.rxnArrows.count()>0,a.rxnArrows.count()>1)throw new Error("Reaction may not contain more than one arrow");if(this.molfile="",this.reaction){if(a.rgroups.count()>0)throw new Error("Unable to save the structure - reactions with r-groups are not supported at the moment");var e=h.MolfileSaver.getComponents(a),f=e.reactants,i=e.products,j=f.concat(i);this.molfile="$RXN\n\n\n\n"+g.paddedInt(f.length,3)+g.paddedInt(i.length,3)+g.paddedInt(0,3)+"\n";for(var k=0;k<j.length;++k){var l=new h.MolfileSaver(!1),m=a.clone(j[k],null,!0),n=l.saveMolecule(m,!1,!0);this.molfile+="$MOL\n"+n}return this.molfile}if(a.rgroups.count()>0){if(!c){var o=new h.MolfileSaver(!1).getCTab(a.getScaffold(),a.rgroups);return this.molfile="$MDL  REV  1\n$MOL\n$HDR\n\n\n\n$END HDR\n",this.molfile+="$CTAB\n"+o+"$END CTAB\n",a.rgroups.each(function(b,c){this.molfile+="$RGP\n",this.writePaddedNumber(b,3),this.molfile+="\n",c.frags.each(function(b,c){var d=new h.MolfileSaver(!1).getCTab(a.getFragment(c));this.molfile+="$CTAB\n"+d+"$END CTAB\n"},this),this.molfile+="$END RGP\n"},this),this.molfile+="$END MOL\n",this.molfile}a=a.getScaffold()}return this.molecule=a.clone(),this.prepareSGroups(b,d),this.writeHeader(),this.writeCTab2000(),this.molfile},h.MolfileSaver.prototype.writeHeader=function(){var a=new Date;this.writeCR(),this.writeWhiteSpace(2),this.write("Ketcher"),this.writeWhiteSpace(),this.writeCR((a.getMonth()+1).toPaddedString(2)+a.getDate().toPaddedString(2)+(a.getFullYear()%100).toPaddedString(2)+a.getHours().toPaddedString(2)+a.getMinutes().toPaddedString(2)+"2D 1   1.00000     0.00000     0"),this.writeCR()},h.MolfileSaver.prototype.write=function(a){this.molfile+=a},h.MolfileSaver.prototype.writeCR=function(a){0==arguments.length&&(a=""),this.molfile+=a+"\n"},h.MolfileSaver.prototype.writeWhiteSpace=function(a){0==arguments.length&&(a=1),a.times(function(){this.write(" ")},this)},h.MolfileSaver.prototype.writePadded=function(a,b){this.write(a),this.writeWhiteSpace(b-a.length)},h.MolfileSaver.prototype.writePaddedNumber=function(a,b){var c=(a-0).toString();this.writeWhiteSpace(b-c.length),this.write(c)},h.MolfileSaver.prototype.writePaddedFloat=function(a,b,c){this.write(g.paddedFloat(a,b,c))},h.MolfileSaver.prototype.writeCTab2000Header=function(){this.writePaddedNumber(this.molecule.atoms.count(),3),this.writePaddedNumber(this.molecule.bonds.count(),3),this.writePaddedNumber(0,3),this.writeWhiteSpace(3),this.writePaddedNumber(this.molecule.isChiral?1:0,3),this.writePaddedNumber(0,3),this.writeWhiteSpace(12),this.writePaddedNumber(999,3),this.writeCR(" V2000")},h.MolfileSaver.prototype.writeCTab2000=function(a){this.writeCTab2000Header(),this.mapping={};var b=1,c=[],d=[];for(this.molecule.atoms.each(function(a,e){this.writePaddedFloat(e.pp.x,10,4),this.writePaddedFloat(-e.pp.y,10,4),this.writePaddedFloat(0,10,4),this.writeWhiteSpace();var g=e.label;null!=e.atomList?(g="L",c.push(a)):null==f.getElementByLabel(g)&&-1==["A","Q","X","*","R#"].indexOf(g)&&(g="C",d.push(a)),this.writePadded(g,3),this.writePaddedNumber(0,2),this.writePaddedNumber(0,3),this.writePaddedNumber(0,3),Object.isUndefined(e.hCount)&&(e.hCount=0),this.writePaddedNumber(e.hCount,3),Object.isUndefined(e.stereoCare)&&(e.stereoCare=0),this.writePaddedNumber(e.stereoCare,3),this.writePaddedNumber(e.explicitValence<0?0:0==e.explicitValence?15:e.explicitValence,3),this.writePaddedNumber(0,3),this.writePaddedNumber(0,3),this.writePaddedNumber(0,3),Object.isUndefined(e.aam)&&(e.aam=0),this.writePaddedNumber(e.aam,3),Object.isUndefined(e.invRet)&&(e.invRet=0),this.writePaddedNumber(e.invRet,3),Object.isUndefined(e.exactChangeFlag)&&(e.exactChangeFlag=0),this.writePaddedNumber(e.exactChangeFlag,3),this.writeCR(),this.mapping[a]=b,b++},this),this.bondMapping={},b=1,this.molecule.bonds.each(function(a,c){this.bondMapping[a]=b++,this.writePaddedNumber(this.mapping[c.begin],3),this.writePaddedNumber(this.mapping[c.end],3),this.writePaddedNumber(c.type,3),Object.isUndefined(c.stereo)&&(c.stereo=0),this.writePaddedNumber(c.stereo,3),this.writeWhiteSpace(3),Object.isUndefined(c.topology)&&(c.topology=0),this.writePaddedNumber(c.topology,3),Object.isUndefined(c.reactingCenterStatus)&&(c.reactingCenterStatus=0),this.writePaddedNumber(c.reactingCenterStatus,3),this.writeCR()},this);d.length>0;)this.write("A  "),this.writePaddedNumber(d[0]+1,3),this.writeCR(),this.writeCR(this.molecule.atoms.get(d[0]).label),d.splice(0,1);var e=new Array,h=new Array,i=new Array,j=new Array,k=new Array,l=new Array,m=new Array,n=new Array,o=new Array;this.molecule.atoms.each(function(a,b){if(0!=b.charge&&e.push([a,b.charge]),0!=b.isotope&&h.push([a,b.isotope]),0!=b.radical&&i.push([a,b.radical]),null!=b.rglabel&&"R#"==b.label)for(var c=0;32>c;c++)b.rglabel&1<<c&&j.push([a,c+1]);null!=b.attpnt&&l.push([a,b.attpnt]),0!=b.ringBondCount&&m.push([a,b.ringBondCount]),0!=b.substitutionCount&&o.push([a,b.substitutionCount]),0!=b.unsaturatedAtom&&n.push([a,b.unsaturatedAtom])}),a&&a.each(function(a,b){if(b.resth||b.ifthen>0||b.range.length>0){var c="  1 "+g.paddedInt(a,3)+" "+g.paddedInt(b.ifthen,3)+" "+g.paddedInt(b.resth?1:0,3)+"   "+b.range;k.push(c)}});var p=function(a,b){for(;b.length>0;){for(var c=new Array;b.length>0&&c.length<8;)c.push(b[0]),b.splice(0,1);this.write(a),this.writePaddedNumber(c.length,3),c.each(function(a){this.writeWhiteSpace(),this.writePaddedNumber(this.mapping[a[0]],3),this.writeWhiteSpace(),this.writePaddedNumber(a[1],3)},this),this.writeCR()}};p.call(this,"M  CHG",e),p.call(this,"M  ISO",h),p.call(this,"M  RAD",i),p.call(this,"M  RGP",j);for(var q=0;q<k.length;++q)this.write("M  LOG"+k[q]+"\n");if(p.call(this,"M  APO",l),p.call(this,"M  RBC",m),p.call(this,"M  SUB",o),p.call(this,"M  UNS",n),c.length>0)for(q=0;q<c.length;++q){var r=c[q],s=this.molecule.atoms.get(r).atomList;this.write("M  ALS"),this.writePaddedNumber(r+1,4),this.writePaddedNumber(s.ids.length,3),this.writeWhiteSpace(),this.write(s.notList?"T":"F");for(var t=s.labelList(),u=0;u<t.length;++u)this.writeWhiteSpace(),this.writePadded(t[u],3);this.writeCR()}var v={},w=1,x={},y=this.molecule.sGroupForest.getSGroupsBFS();g.each(y,function(a){x[w]=a,v[a]=w++},this);for(var z=1;w>z;++z){var A=x[z],B=this.molecule.sgroups.get(A);this.write("M  STY"),this.writePaddedNumber(1,3),this.writeWhiteSpace(1),this.writePaddedNumber(z,3),this.writeWhiteSpace(1),this.writePadded(B.type,3),this.writeCR(),this.write("M  SLB"),this.writePaddedNumber(1,3),this.writeWhiteSpace(1),this.writePaddedNumber(z,3),this.writeWhiteSpace(1),this.writePaddedNumber(z,3),this.writeCR();var C=this.molecule.sGroupForest.parent.get(A);if(C>=0&&(this.write("M  SPL"),this.writePaddedNumber(1,3),this.writeWhiteSpace(1),this.writePaddedNumber(z,3),this.writeWhiteSpace(1),this.writePaddedNumber(v[C],3),this.writeCR()),"SRU"==B.type&&B.data.connectivity){var D="";D+=" ",D+=g.stringPadded(z.toString(),3),D+=" ",D+=g.stringPadded(B.data.connectivity,3,!0),this.write("M  SCN"),this.writePaddedNumber(1,3),this.write(D.toUpperCase()),this.writeCR()}"SRU"==B.type&&(this.write("M  SMT "),this.writePaddedNumber(z,3),this.writeWhiteSpace(),this.write(B.data.subscript||"n"),this.writeCR()),this.writeCR(B.saveToMolfile(this.molecule,v,this.mapping,this.bondMapping))}this.writeCR("M  END")},h.Molfile.parseRxn=function(a){var b=h.Molfile,c=a[0].strip().split(" ");return c.length>1&&"V3000"==c[1]?b.parseRxn3000(a):b.parseRxn2000(a)},h.Molfile.parseRxn2000=function(a){var b=h.Molfile;a=a.slice(4);var c=b.partitionLine(a[0],b.fmtInfo.rxnItemsPartition),d=c[0]-0,e=c[1]-0,f=c[2]-0;a=a.slice(1);for(var g=[];a.length>0&&"$MOL"==a[0].substr(0,4);){a=a.slice(1);for(var i=0;i<a.length&&"$MOL"!=a[i].substr(0,4);)i++;g.push(h.Molfile.parseMol(a.slice(0,i))),a=a.slice(i)}return b.rxnMerge(g,d,e,f)},h.Molfile.parseRxn3000=function(a){var b=h.Molfile;a=a.slice(4);for(var c=a[0].split(/\s+/g).slice(3),d=c[0]-0,e=c[1]-0,f=c.length>2?c[2]-0:0,i=function(a){g.assert(a,"CTab format invalid")},j=function(b){for(var c=b;c<a.length;++c)if("M  V30 END CTAB"==a[c].strip())return c;i(!1)},k=function(b){for(var c=b;c<a.length;++c)if("M  V30 END RGROUP"==a[c].strip())return c;i(!1)},l=[],m=[],n=null,o=[],p=0;p<a.length;++p){var q=a[p].strip();if(q.startsWith("M  V30 COUNTS"));else{if("M  END"==q)break;if("M  V30 BEGIN PRODUCT"==q)i(null==n),n=m;else if("M  V30 END PRODUCT"==q)i(n===m),n=null;else if("M  V30 BEGIN REACTANT"==q)i(null==n),n=l;else if("M  V30 END REACTANT"==q)i(n===l),n=null;else if(q.startsWith("M  V30 BEGIN RGROUP")){i(null==n);var r=k(p);o.push(a.slice(p,r+1)),p=r}else{if("M  V30 BEGIN CTAB"!=q)throw new Error("line unrecognized: "+q);var r=j(p);n.push(a.slice(p,r+1)),p=r}}}for(var s=[],t=l.concat(m),r=0;r<t.length;++r){var u=h.Molfile.parseCTabV3000(t[r],c);s.push(u)}var v=b.rxnMerge(s,d,e,f);return b.readRGroups3000(v,function(a){for(var b=[],c=0;c<a.length;++c)b=b.concat(a[c]);return b}(o)),v},h.Molfile.rxnMerge=function(a,b,c){h.Molfile;var d,f=new h.Struct,g=[],i=[],j=[],k=[],l=[],m=[],n={cnt:0,totalLength:0};for(d=0;d<a.length;++d){var o=a[d],p=o.getBondLengthData();n.cnt+=p.cnt,n.totalLength+=p.totalLength}var q=1/(0==n.cnt?1:n.totalLength/n.cnt);for(d=0;d<a.length;++d)o=a[d],o.scale(q);for(d=0;d<a.length;++d){o=a[d];var r=o.getCoordBoundingBoxObj();if(r){var s=b>d?h.Struct.FRAGMENT.REACTANT:b+c>d?h.Struct.FRAGMENT.PRODUCT:h.Struct.FRAGMENT.AGENT;s==h.Struct.FRAGMENT.REACTANT?(g.push(r),k.push(o)):s==h.Struct.FRAGMENT.AGENT?(i.push(r),l.push(o)):s==h.Struct.FRAGMENT.PRODUCT&&(j.push(r),m.push(o)),o.atoms.each(function(a,b){b.rxnFragmentType=s})}}var t=0,u=function(a,b,c,d,f){var g=new e(d-c.min.x,f?1-c.min.y:-(c.min.y+c.max.y)/2);return b.atoms.each(function(a,b){b.pp.add_(g)}),b.sgroups.each(function(a,b){b.pp&&b.pp.add_(g)}),c.min.add_(g),c.max.add_(g),b.mergeInto(a),c.max.x-c.min.x};for(d=0;d<k.length;++d)t+=u(f,k[d],g[d],t,!1)+2;for(t+=2,d=0;d<l.length;++d)t+=u(f,l[d],i[d],t,!0)+2;for(t+=2,d=0;d<m.length;++d)t+=u(f,m[d],j[d],t,!1)+2;var v,w,x,y,z=null,A=null;for(d=0;d<g.length-1;++d)v=g[d],w=g[d+1],x=(v.max.x+w.min.x)/2,y=(v.max.y+v.min.y+w.max.y+w.min.y)/4,f.rxnPluses.add(new h.Struct.RxnPlus({pp:new e(x,y)}));for(d=0;d<g.length;++d)0==d?(z={},z.max=new e(g[d].max),z.min=new e(g[d].min)):(z.max=e.max(z.max,g[d].max),z.min=e.min(z.min,g[d].min));for(d=0;d<j.length-1;++d)v=j[d],w=j[d+1],x=(v.max.x+w.min.x)/2,y=(v.max.y+v.min.y+w.max.y+w.min.y)/4,f.rxnPluses.add(new h.Struct.RxnPlus({pp:new e(x,y)}));for(d=0;d<j.length;++d)0==d?(A={},A.max=new e(j[d].max),A.min=new e(j[d].min)):(A.max=e.max(A.max,j[d].max),A.min=e.min(A.min,j[d].min));if(v=z,w=A,v||w){var B=v?new e(v.max.x,(v.max.y+v.min.y)/2):null,C=w?new e(w.min.x,(w.max.y+w.min.y)/2):null,D=3;B||(B=new e(C.x-D,C.y)),C||(C=new e(B.x+D,B.y)),f.rxnArrows.add(new h.Struct.RxnArrow({pp:e.lc2(B,.5,C,.5)}))}else f.rxnArrows.add(new h.Struct.RxnArrow({pp:new e(0,0)}));return f.isReaction=!0,f},h.Molfile.rgMerge=function(a,b){var c=new h.Struct;a.mergeInto(c,null,null,!1,!0);for(var d in b)for(var e=0;e<b[d].length;++e){var f=b[d][e];f.rgroups.set(d,new h.Struct.RGroup);var g=f.frags.add(new h.Struct.Fragment);f.rgroups.get(d).frags.add(g),f.atoms.each(function(a,b){b.fragment=g}),f.mergeInto(c)}return c},h.Molfile.parseRg2000=function(a){var b=h.Molfile;if(a=a.slice(7),"$CTAB"!=a[0].strip())throw new Error("RGFile format invalid");for(var c=1;"$"!=a[c].charAt(0);)c++;if("$END CTAB"!=a[c].strip())throw new Error("RGFile format invalid");var d=a.slice(1,c);a=a.slice(c+1);for(var e={};;){if(0==a.length)throw new Error("Unexpected end of file");var f=a[0].strip();if("$END MOL"==f){a=a.slice(1);break}if("$RGP"!=f)throw new Error("RGFile format invalid");var g=a[1].strip()-0;for(e[g]=[],a=a.slice(2);;){if(0==a.length)throw new Error("Unexpected end of file");if(f=a[0].strip(),"$END RGP"==f){a=a.slice(1);break}if("$CTAB"!=f)throw new Error("RGFile format invalid");for(c=1;"$"!=a[c].charAt(0);)c++;if("$END CTAB"!=a[c].strip())throw new Error("RGFile format invalid");e[g].push(a.slice(1,c)),a=a.slice(c+1)}}var i=h.Molfile.parseCTab(d),j={};if(h.Molfile.loadRGroupFragments)for(var k in e){j[k]=[];for(var l=0;l<e[k].length;++l)j[k].push(h.Molfile.parseCTab(e[k][l]))}return b.rgMerge(i,j)}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../util":39,"../util/map":40,"../util/set":42,"../util/vec2":43,"./element":10}],13:[function(a,b,c){(function(b){var c=a("../util/box2abs"),d=a("../util/map"),e=a("../util/set"),f=a("../util/vec2"),g=a("../util");a("./element"),a("../rnd/restruct_rendering");var h=b.chem=b.chem||{},i=b.rnd;h.SGroup=function(a){if(!(a&&a in h.SGroup.TYPES))throw new Error("Invalid or unsupported s-group type");this.type=a,this.id=-1,h.SGroup.equip(this,a),this.label=-1,this.bracketBox=null,this.bracketDir=new f(1,0),this.areas=[],this.highlight=!1,this.highlighting=null,this.selected=!1,this.selectionPlate=null,this.atoms=[],this.patoms=[],this.bonds=[],this.xBonds=[],this.neiAtoms=[],this.pp=null,this.data={mul:1,connectivity:"ht",name:"",subscript:"n",attached:!1,absolute:!0,showUnits:!1,nCharsToDisplay:-1,tagChar:"",daspPos:1,fieldType:"F",fieldName:"",fieldValue:"",units:"",query:"",queryOp:""}},h.SGroup.prototype.getAttr=function(a){return this.data[a]},h.SGroup.prototype.getAttrs=function(){var a={};for(var b in this.data)a[b]=this.data[b];return a},h.SGroup.prototype.setAttr=function(a,b){var c=this.data[a];return this.data[a]=b,c},h.SGroup.prototype.checkAttr=function(a,b){return this.data[a]==b},h.SGroup.equip=function(a,b){var c=h.SGroup.TYPES[b];for(var d in c)a[d]=c[d]},h.SGroup.numberArrayToString=function(a,b){for(var c=g.stringPadded(a.length,3),d=0;d<a.length;++d)c+=" "+g.stringPadded(b[a[d]],3);return c},h.SGroup.addGroup=function(a,b,c){b.id=a.sgroups.add(b),b.postLoad(a,c);for(var d=0;d<b.atoms.length;++d)a.atoms.has(b.atoms[d])&&e.add(a.atoms.get(b.atoms[d]).sgs,b.id);return a.sGroupForest.insert(b.id),b.id},h.SGroup.bracketsToMolfile=function(a,b,c){var d=[],f=[],i=e.fromList(b.atoms);h.SGroup.getCrossBonds(d,f,a,i),h.SGroup.bracketPos(b,null,a,f);for(var j=b.bracketBox,k=b.bracketDir,l=k.rotateSC(1,0),m=h.SGroup.getBracketParameters(a,f,i,j,k,l,null,b.id),n=[],o=0;o<m.length;++o){for(var p=m[o],q=p.c.addScaled(p.n,-.5*p.h).yComplement(),r=p.c.addScaled(p.n,.5*p.h).yComplement(),s="M  SDI "+c+g.paddedInt(4,3),t=[q.x,q.y,r.x,r.y],u=0;u<t.length;++u)s+=g.paddedFloat(t[u],10,4);n.push(s)}return n},h.SGroup.filterAtoms=function(a,b){for(var c=[],d=0;d<a.length;++d){var e=a[d];"number"!=typeof b[e]?c.push(e):b[e]>=0?c.push(b[e]):c.push(-1)}return c},h.SGroup.removeNegative=function(a){for(var b=[],c=0;c<a.length;++c)a[c]>=0&&b.push(a[c]);return b},h.SGroup.filter=function(a,b,c){b.atoms=h.SGroup.removeNegative(h.SGroup.filterAtoms(b.atoms,c))},h.SGroup.clone=function(a,b){var c=new h.SGroup(a.type);for(var d in a.data)c.data[d]=a.data[d];return c.atoms=g.mapArray(a.atoms,b),c.pp=a.pp,c.bracketBox=a.bracketBox,c.patoms=null,c.bonds=null,c.allAtoms=a.allAtoms,c},h.SGroup.addAtom=function(a,b){a.atoms.push(b)},h.SGroup.removeAtom=function(a,b){for(var c=0;c<a.atoms.length;++c)if(a.atoms[c]===b)return void a.atoms.splice(c,1);throw new Error("The atom is not found in the given s-group")},h.SGroup.getCrossBonds=function(a,b,c,d){c.bonds.each(function(c,f){e.contains(d,f.begin)&&e.contains(d,f.end)?g.isNull(a)||a.push(c):(e.contains(d,f.begin)||e.contains(d,f.end))&&(g.isNull(b)||b.push(c))},this)},h.SGroup.bracketPos=function(a,b,d,e){var h=a.atoms;if(e&&2===e.length){var i=d.bonds.get(e[0]),j=d.bonds.get(e[1]),k=i.getCenter(d),l=j.getCenter(d);a.bracketDir=f.diff(l,k).normalized()}else a.bracketDir=new f(1,0);var m=a.bracketDir,n=m.rotateSC(1,0),o=null,p=[];g.each(h,function(a){var e=d.atoms.get(a),h=b?b.ctab.atoms.get(a).visel.boundingBox:null,i=new f(e.pp);if(g.isNull(h)){h=new c(i,i);var j=new f(.05*3,.05*3);h=h.extend(j,j)}else h=h.translate((b.offset||new f).negated()).transform(b.scaled2obj,b);p.push(h)},this),g.each(d.sGroupForest.children.get(a.id),function(a){var c=b?b.ctab.sgroups.get(a).visel.boundingBox:null;g.isNull(c)||(c=c.translate((b.offset||new f).negated()).transform(b.scaled2obj,b),p.push(c))},this),g.each(p,function(a){var b=null;g.each([a.p0.x,a.p1.x],function(d){g.each([a.p0.y,a.p1.y],function(a){var e=new f(d,a),h=new f(f.dot(e,m),f.dot(e,n));b=g.isNull(b)?new c(h,h):b.include(h)},this)},this),o=g.isNull(o)?b:c.union(o,b)},this);var q=new f(.2,.4);g.isNull(o)||(o=o.extend(q,q)),a.bracketBox=o},h.SGroup.drawBrackets=function(a,b,d,e,g,j,k,l,m,n,o){for(var p=h.SGroup.getBracketParameters(b.ctab.molecule,e,g,j,k,l,b,d.id),q=-1,r=0;r<p.length;++r){var s=p[r],t=h.SGroup.drawBracket(b,b.paper,b.styles,s.d,s.n,s.c,s.w,s.h);a.push(t),(0>q||p[q].d.x<s.d.x||p[q].d.x==s.d.x&&p[q].d.y>s.d.y)&&(q=r)}var u=p[q],v=function(d,e){var g=b.ps(u.c.addScaled(u.n,e*u.h)),h=b.paper.text(g.x,g.y,d).attr({font:b.settings.font,"font-size":b.settings.fontszsub});o&&h.attr(o);var j=c.fromRelBox(i.relBox(h.getBBox())),k=Math.max(f.shiftRayBox(g,u.d.negated(),j),3)+2;h.translateAbs(k*u.d.x,k*u.d.y),a.push(h)};m&&v(m,.5),n&&v(n,-.5)},h.SGroup.drawBracket=function(a,b,c,d,e,f,g,h){g=g||.25,h=h||1;var i=f.addScaled(e,-.5*h),j=f.addScaled(e,.5*h),k=i.addScaled(d,-g),l=j.addScaled(d,-g);return i=a.obj2scaled(i),j=a.obj2scaled(j),k=a.obj2scaled(k),l=a.obj2scaled(l),b.path("M {0}, {1} L {2} , {3} L {4} , {5} L {6} , {7}",k.x,k.y,i.x,i.y,j.x,j.y,l.x,l.y).attr(c.sgroupBracketStyle)},h.SGroup.getBracketParameters=function(a,b,c,d,h,i,j,k){var l=function(a,b,c,d){this.c=a,this.d=b,this.n=b.rotateSC(1,0),this.w=c,this.h=d},m=[];return b.length<2?function(){h=h||new f(1,0),i=i||h.rotateSC(1,0);var a=Math.min(.25,.3*d.sz().x),b=f.lc2(h,d.p0.x,i,.5*(d.p0.y+d.p1.y)),c=f.lc2(h,d.p1.x,i,.5*(d.p0.y+d.p1.y)),e=d.sz().y;m.push(new l(b,h.negated(),a,e),new l(c,h,a,e))}():2===b.length?function(){var c=a.bonds.get(b[0]),d=a.bonds.get(b[1]),e=c.getCenter(a),h=d.getCenter(a),i=-1,n=-1,o=-1,p=-1,q=f.centre(e,h),r=f.diff(h,e).normalized(),s=r.negated(),t=r.rotateSC(1,0),u=t.negated();g.each(a.sGroupForest.children.get(k),function(a){var b=j?j.ctab.sgroups.get(a).visel.boundingBox:null;g.isNull(b)||(b=b.translate((j.offset||new f).negated()).transform(j.scaled2obj,j),i=Math.max(i,f.shiftRayBox(e,s,b)),n=Math.max(n,f.shiftRayBox(h,r,b)),o=Math.max(o,f.shiftRayBox(q,t,b)),p=Math.max(p,f.shiftRayBox(q,u,b)))},this),i=Math.max(i+.2,0),n=Math.max(n+.2,0),o=Math.max(Math.max(o,p)+.1,0);var v=.25,w=1.5+o;m.push(new l(e.addScaled(s,i),s,v,w),new l(h.addScaled(r,n),r,v,w))}():function(){for(var d=0;d<b.length;++d){var f=a.bonds.get(b[d]),g=f.getCenter(a),h=e.contains(c,f.begin)?f.getDir(a):f.getDir(a).negated();m.push(new l(g,h,.2,1))}}(),m},h.SGroup.getObjBBox=function(a,b){if(0==a.length)throw new Error("Atom list is empty");for(var d=b.atoms.get(a[0]).pp,e=new c(d,d),f=1;f<a.length;++f){var g=a[f],h=b.atoms.get(g),i=h.pp;e=e.include(i)}return e},h.SGroup.makeAtomBondLines=function(a,b,c,d){if(!c)return[];for(var e=[],f=0;f<Math.floor((c.length+14)/15);++f){for(var h=Math.min(c.length-15*f,15),i="M  "+a+" "+b+" "+g.paddedInt(h,2),j=0;h>j;++j)i+=" "+g.paddedInt(d[c[15*f+j]],3);e.push(i)}return e},h.SGroup.getAtoms=function(a,b){if(!b.allAtoms)return b.atoms;var c=[];return a.atoms.each(function(a){c.push(a)}),c},h.SGroup.getBonds=function(a,b){var c=h.SGroup.getAtoms(a,b),d=[];return a.bonds.each(function(a,b){c.indexOf(b.begin)>=0&&c.indexOf(b.end)>=0&&d.push(a)}),d},h.SGroup.GroupMul={draw:function(a){var b=a.render,c=b.paper.set(),d=[],f=[],g=e.fromList(this.atoms);h.SGroup.getCrossBonds(d,f,a.molecule,g),h.SGroup.bracketPos(this,b,a.molecule,f);var i=this.bracketBox,j=this.bracketDir,k=j.rotateSC(1,0);return this.areas=[i],h.SGroup.drawBrackets(c,b,this,f,g,i,j,k,this.data.mul),c},saveToMolfile:function(a,b,c,d){var e=g.stringPadded(b[this.id],3),f=[];f=f.concat(h.SGroup.makeAtomBondLines("SAL",e,g.idList(this.atomSet),c)),f=f.concat(h.SGroup.makeAtomBondLines("SPA",e,g.idList(this.parentAtomSet),c)),f=f.concat(h.SGroup.makeAtomBondLines("SBL",e,this.bonds,d));var i="M  SMT "+e+" "+this.data.mul;return f.push(i),f=f.concat(h.SGroup.bracketsToMolfile(a,this,e)),f.join("\n")},prepareForSaving:function(a){var b;this.atoms.sort(),this.atomSet=e.fromList(this.atoms),this.parentAtomSet=e.clone(this.atomSet);var c=[],d=[];if(a.bonds.each(function(a,b){e.contains(this.parentAtomSet,b.begin)&&e.contains(this.parentAtomSet,b.end)?c.push(a):(e.contains(this.parentAtomSet,b.begin)||e.contains(this.parentAtomSet,b.end))&&d.push(a)},this),0!=d.length&&2!=d.length)throw{id:this.id,"error-type":"cross-bond-number",message:"Unsupported cross-bonds number"};var f=-1,i=-1,j=null;if(2==d.length){var k=a.bonds.get(d[0]);f=e.contains(this.parentAtomSet,k.begin)?k.begin:k.end;var l=a.bonds.get(d[1]);i=e.contains(this.parentAtomSet,l.begin)?l.begin:l.end,j=l}var m=null,n=f,o=[];for(b=0;b<this.data.mul-1;++b)if(m={},g.each(this.atoms,function(b){var c=a.atoms.get(b),d=a.atoms.add(new h.Struct.Atom(c));o.push(d),this.atomSet[d]=1,m[b]=d},this),g.each(c,function(b){var c=a.bonds.get(b),d=new h.Struct.Bond(c);d.begin=m[d.begin],d.end=m[d.end],a.bonds.add(d)},this),null!=j){var p=new h.Struct.Bond(j);p.begin=n,p.end=m[i],a.bonds.add(p),n=m[f]}if(g.each(o,function(b){g.each(a.sGroupForest.getPathToRoot(this.id).reverse(),function(c){a.atomAddToSGroup(c,b)},this)},this),n>=0){var q=a.bonds.get(d[0]);q.begin==f?q.begin=n:q.end=n}this.bonds=d},postLoad:function(a,b){this.data.mul=this.data.subscript-0;var c={};this.atoms=h.SGroup.filterAtoms(this.atoms,b),this.patoms=h.SGroup.filterAtoms(this.patoms,b);for(var d=1;d<this.data.mul;++d)for(var e=0;e<this.patoms.length;++e){var f=this.atoms[d*this.patoms.length+e];if(!(0>f)){if(this.patoms[e]<0)throw new Error("parent atom missing");c[f]=this.patoms[e]}}this.patoms=h.SGroup.removeNegative(this.patoms);var i=g.identityMap(this.patoms),j=[];a.bonds.each(function(a,b){var d=b.begin in c,e=b.end in c;d&&e||d&&b.end in i||e&&b.begin in i?j.push(a):d?b.begin=c[b.begin]:e&&(b.end=c[b.end])},this);for(var k=0;k<j.length;++k)a.bonds.remove(j[k]);for(var l in c)a.atoms.remove(l),b[l]=-1;this.atoms=this.patoms,this.patoms=null}},h.SGroup.GroupSru={draw:function(a){var b=a.render,c=b.paper.set(),d=[],f=[],g=e.fromList(this.atoms);h.SGroup.getCrossBonds(d,f,a.molecule,g),h.SGroup.bracketPos(this,b,a.molecule,f);var i=this.bracketBox,j=this.bracketDir,k=j.rotateSC(1,0);this.areas=[i];var l=this.data.connectivity||"eu";"ht"==l&&(l="");var m=this.data.subscript||"n";return h.SGroup.drawBrackets(c,b,this,f,g,i,j,k,m,l),c},saveToMolfile:function(a,b,c,d){var e=g.stringPadded(b[this.id],3),f=[];return f=f.concat(h.SGroup.makeAtomBondLines("SAL",e,this.atoms,c)),f=f.concat(h.SGroup.makeAtomBondLines("SBL",e,this.bonds,d)),f=f.concat(h.SGroup.bracketsToMolfile(a,this,e)),f.join("\n")},prepareForSaving:function(a){var b=[];if(a.bonds.each(function(c,d){var f=a.atoms.get(d.begin),g=a.atoms.get(d.end);(e.contains(f.sgs,this.id)&&!e.contains(g.sgs,this.id)||e.contains(g.sgs,this.id)&&!e.contains(f.sgs,this.id))&&b.push(c)},this),0!=b.length&&2!=b.length)throw{id:this.id,"error-type":"cross-bond-number",message:"Unsupported cross-bonds number"};this.bonds=b},postLoad:function(){this.data.connectivity=(this.data.connectivity||"EU").strip().toLowerCase()}},h.SGroup.GroupSup={draw:function(a){var b=a.render,c=b.paper.set(),d=[],f=[],g=e.fromList(this.atoms);h.SGroup.getCrossBonds(d,f,a.molecule,g),h.SGroup.bracketPos(this,b,a.molecule,f);var i=this.bracketBox,j=this.bracketDir,k=j.rotateSC(1,0);return this.areas=[i],h.SGroup.drawBrackets(c,b,this,f,g,i,j,k,this.data.name,null,{"font-style":"italic"}),c},saveToMolfile:function(a,b,c,d){var e=g.stringPadded(b[this.id],3),f=[];return f=f.concat(h.SGroup.makeAtomBondLines("SAL",e,this.atoms,c)),f=f.concat(h.SGroup.makeAtomBondLines("SBL",e,this.bonds,d)),this.data.name&&""!=this.data.name&&f.push("M  SMT "+e+" "+this.data.name),f.join("\n")},prepareForSaving:function(a){var b=[];a.bonds.each(function(c,d){var f=a.atoms.get(d.begin),g=a.atoms.get(d.end);(e.contains(f.sgs,this.id)&&!e.contains(g.sgs,this.id)||e.contains(g.sgs,this.id)&&!e.contains(f.sgs,this.id))&&b.push(c)},this),this.bonds=b},postLoad:function(){this.data.name=(this.data.subscript||"").strip(),this.data.subscript=""}},h.SGroup.GroupGen={draw:function(a){var b=a.render;b.settings,b.styles;var c=b.paper,d=c.set(),f=[],g=[],i=e.fromList(this.atoms);h.SGroup.getCrossBonds(f,g,a.molecule,i),h.SGroup.bracketPos(this,b,a.molecule,g);
var j=this.bracketBox,k=this.bracketDir,l=k.rotateSC(1,0);return this.areas=[j],h.SGroup.drawBrackets(d,b,this,g,i,j,k,l),d},saveToMolfile:function(a,b,c,d){var e=g.stringPadded(b[this.id],3),f=[];return f=f.concat(h.SGroup.makeAtomBondLines("SAL",e,this.atoms,c)),f=f.concat(h.SGroup.makeAtomBondLines("SBL",e,this.bonds,d)),f=f.concat(h.SGroup.bracketsToMolfile(a,this,e)),f.join("\n")},prepareForSaving:function(){},postLoad:function(){}},h.SGroup.getMassCentre=function(a,b){for(var c=new f,d=0;d<b.length;++d)c=c.addScaled(a.atoms.get(b[d]).pp,1/b.length);return c},h.SGroup.setPos=function(a,b,c){b.pp=c},h.SGroup.GroupDat={showValue:function(a,b,c,d){var e=a.text(b.x,b.y,c.data.fieldValue).attr({font:d.font,"font-size":d.fontsz}),f=e.getBBox(),g=a.rect(f.x-1,f.y-1,f.width+2,f.height+2,3,3).attr({fill:"#fff",stroke:"#fff"}),h=a.set();return h.push(g,e.toFront()),h},draw:function(a){var b,d=a.render,e=d.settings,g=d.paper,j=g.set(),k=h.SGroup.getAtoms(a,this);h.SGroup.bracketPos(this,d,a.molecule),this.areas=this.bracketBox?[this.bracketBox]:[],null==this.pp&&h.SGroup.setPos(a,this,this.bracketBox.p1.add(new f(.5,.5)));var l=this.pp.scaled(e.scaleFactor);if(this.data.attached)for(b=0;b<k.length;++b){var m=a.atoms.get(k[b]),n=d.ps(m.a.pp),o=m.visel.boundingBox;null!=o&&(n.x=Math.max(n.x,o.p1.x)),n.x+=e.lineWidth;var p=this.showValue(g,n,this,e),q=i.relBox(p.getBBox());p.translateAbs(.5*q.width,-.3*q.height),j.push(p);var r=c.fromRelBox(i.relBox(p.getBBox()));r=r.transform(d.scaled2obj,d),this.areas.push(r)}else{var s=this.showValue(g,l,this,e),t=i.relBox(s.getBBox());s.translateAbs(.5*t.width,-.5*t.height),j.push(s);var u=c.fromRelBox(i.relBox(s.getBBox()));this.dataArea=u.transform(d.scaled2obj,d),a.sgroupData.has(this.id)||a.sgroupData.set(this.id,new i.ReDataSGroupData(this))}return j},saveToMolfile:function(a,b,c){var d=g.stringPadded(b[this.id],3),e=this.data,f=this.pp;e.absolute||(f=f.sub(h.SGroup.getMassCentre(a,this.atoms)));var i=[];i=i.concat(h.SGroup.makeAtomBondLines("SAL",d,this.atoms,c));var j="M  SDT "+d+" "+g.stringPadded(e.fieldName,30,!0)+g.stringPadded(e.fieldType,2)+g.stringPadded(e.units,20,!0)+g.stringPadded(e.query,2)+g.stringPadded(e.queryOp,3);i.push(j);var k="M  SDD "+d+" "+g.paddedFloat(f.x,10,4)+g.paddedFloat(-f.y,10,4)+"    "+(e.attached?"A":"D")+(e.absolute?"A":"R")+(e.showUnits?"U":" ")+"   "+(e.nCharnCharsToDisplay>=0?g.paddedInt(e.nCharnCharsToDisplay,3):"ALL")+"  1   "+g.stringPadded(e.tagChar,1)+"  "+g.paddedInt(e.daspPos,1)+"  ";i.push(k);var l=g.normalizeNewlines(e.fieldValue).replace(/\n*$/,""),m=69;return l.split("\n").each(function(a){for(;a.length>m;)i.push("M  SCD "+d+" "+a.slice(0,m)),a=a.slice(m);i.push("M  SED "+d+" "+a)}),i.join("\n")},prepareForSaving:function(a){this.atoms=h.SGroup.getAtoms(a,this)},postLoad:function(a){this.data.absolute||(this.pp=this.pp.add(h.SGroup.getMassCentre(a,this.atoms)))}},h.SGroup.TYPES={MUL:h.SGroup.GroupMul,SRU:h.SGroup.GroupSru,SUP:h.SGroup.GroupSup,DAT:h.SGroup.GroupDat,GEN:h.SGroup.GroupGen},h.SGroupForest=function(a){this.parent=new d,this.children=new d,this.children.set(-1,[]),this.molecule=a},h.SGroupForest.prototype.getSGroupsBFS=function(){var a=[],b=[],c=-1;for(b=g.array(this.children.get(-1));b.length>0;){var c=b.shift();b=b.concat(this.children.get(c)),a.push(c)}return a},h.SGroupForest.prototype.getAtomSets=function(){return this.molecule.sgroups.map(function(a,b){return e.fromList(b.atoms)})},h.SGroupForest.prototype.getAtomSetRelations=function(a,b,c){var f=new d,h=new d,c=this.getAtomSets();c.unset(a),c.each(function(a,c){h.set(a,e.subset(b,c)),f.set(a,e.subset(c,b)&&!e.eq(c,b))},this);var i=c.findAll(function(a){return!!h.get(a)&&!(g.findIndex(this.children.get(a),function(a){return h.get(a)},this)>=0)},this);g.assert(i.length<=1);var j=c.findAll(function(a){return f.get(a)&&!f.get(this.parent.get(a))},this);return{children:j,parent:0===i.length?-1:i[0]}},h.SGroupForest.prototype.getPathToRoot=function(a){for(var b=[],c=a;c>=0;c=this.parent.get(c))g.assert(b.indexOf(c)<0,"SGroupForest: loop detected"),b.push(c);return b},h.SGroupForest.prototype.validate=function(){var a=this.getAtomSets();this.molecule.sgroups.each(function(a){this.getPathToRoot(a)},this);var b=!0;return this.parent.each(function(c,d){d>=0&&!e.subset(a.get(c),a.get(d))&&(b=!1)},this),this.children.each(function(c){for(var d=this.children.get(c),f=0;f<d.length;++f)for(var g=f+1;g<d.length;++g)e.disjoint(a.get(d[f]),a.get(d[g]))||(b=!1)},this),b},h.SGroupForest.prototype.insert=function(a,b,c){g.assert(!this.parent.has(a),"sgid already present in the forest"),g.assert(!this.children.has(a),"sgid already present in the forest"),g.assert(this.validate(),"s-group forest invalid");var d=this.getAtomSets(),f=e.fromList(this.molecule.sgroups.get(a).atoms);if(g.isUndefined(b)||g.isUndefined(c)){var h=this.getAtomSetRelations(a,f,d);b=h.parent,c=h.children}return g.each(c,function(b){g.assert(1===g.arrayRemoveByValue(this.children.get(this.parent.get(b)),b)),this.parent.set(b,a)},this),this.children.set(a,c),this.parent.set(a,b),this.children.get(b).push(a),g.assert(this.validate(),"s-group forest invalid"),{parent:b,children:c}},h.SGroupForest.prototype.remove=function(a){g.assert(this.parent.has(a),"sgid is not in the forest"),g.assert(this.children.has(a),"sgid is not in the forest"),g.assert(this.validate(),"s-group forest invalid");var b=this.parent.get(a);g.each(this.children.get(a),function(a){this.parent.set(a,b),this.children.get(b).push(a)},this),g.assert(1===g.arrayRemoveByValue(this.children.get(b),a)),this.children.unset(a),this.parent.unset(a),g.assert(this.validate(),"s-group forest invalid")}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../rnd/restruct_rendering":24,"../util":39,"../util/box2abs":38,"../util/map":40,"../util/set":42,"../util/vec2":43,"./element":10}],14:[function(a,b,c){(function(b){var c=a("../util/set");a("./struct");var d=a("../util"),e=b.chem=b.chem||{};e.SmilesSaver=function(){this.smiles="",this._written_atoms=[],this._written_components=0,this.ignore_errors=!1},e.SmilesSaver._Atom=function(a){this.neighbours=[],this.aromatic=!1,this.lowercase=!1,this.chirality=0,this.branch_cnt=0,this.paren_written=!1,this.h_count=a,this.parent=-1},e.SmilesSaver.prototype.isBondInRing=function(a){if(d.isUndefined(this.inLoop)||d.isNull(this.inLoop))throw new Error("Init this.inLoop prior to calling this method");return this.inLoop[a]},e.SmilesSaver.prototype.saveMolecule=function(a,b){var f,g,h;Object.isUndefined(b)||(this.ignore_errors=b),a=a.clone(),a.initHalfBonds(),a.initNeighbors(),a.sortNeighbors(),a.setImplicitHydrogen(),a.sgroups.each(function(b,c){if("MUL"==c.type)try{c.prepareForSaving(a)}catch(a){throw{message:"Bad s-group ("+a.message+")"}}else if(!this.ignore_errors)throw new Error("SMILES data format doesn't support s-groups")},this),this.atoms=new Array(a.atoms.count()),a.atoms.each(function(a,b){this.atoms[a]=new e.SmilesSaver._Atom(b.implicitH)},this);var i=["B","C","N","O","P","S","Se","As"];a.bonds.each(function(b,c){c.type==e.Struct.BOND.TYPE.AROMATIC&&(this.atoms[c.begin].aromatic=!0,-1!=i.indexOf(a.atoms.get(c.begin).label)&&(this.atoms[c.begin].lowercase=!0),this.atoms[c.end].aromatic=!0,-1!=i.indexOf(a.atoms.get(c.end).label)&&(this.atoms[c.end].lowercase=!0)),this.atoms[c.begin].neighbours.push({aid:c.end,bid:b}),this.atoms[c.end].neighbours.push({aid:c.begin,bid:b})},this),this.inLoop=function(){a.prepareLoopStructure();var b=c.empty();a.loops.each(function(e,f){f.hbs.length<=6&&c.mergeIn(b,c.fromList(d.map(f.hbs,function(b){return a.halfBonds.get(b).bid},this)))},this);var e={};return c.each(b,function(a){e[a]=1},this),e}(),this._touched_cistransbonds=0,this._markCisTrans(a);var j=e.MolfileSaver.getComponents(a),k=j.reactants.concat(j.products),l=new e.Dfs(a,this.atoms,k,j.reactants.length);for(l.walk(),this.atoms.each(function(a){a.neighbours.clear()},this),f=0;f<l.v_seq.length;f++){var m=l.v_seq[f],n=m.idx,o=m.parent_edge,p=m.parent_vertex;if(o>=0){var q=this.atoms[n],r=l.numOpeningCycles(o);for(g=0;r>g;g++)this.atoms[p].neighbours.push({aid:-1,bid:-1});if(l.edgeClosingCycle(o)){for(h=0;h<q.neighbours.length;h++)if(-1==q.neighbours[h].aid){q.neighbours[h].aid=p,q.neighbours[h].bid=o;break}if(h==q.neighbours.length)throw new Error("internal: can not put closing bond to its place")}else q.neighbours.push({aid:p,bid:o}),q.parent=p;this.atoms[p].neighbours.push({aid:n,bid:o})}}try{var s=new e.Stereocenters(a,function(a){return this.atoms[a].neighbours},this);s.buildFromBonds(this.ignore_errors),s.each(function(a,b){var c=-1;-1==b.pyramid[3]&&(c=3);var d=new Array(4),f=0,i=this.atoms[a];if(-1!=i.parent)for(h=0;4>h;h++)if(b.pyramid[h]==i.parent){d[f++]=h;break}for(-1!=c&&(d[f++]=c),g=0;g!=i.neighbours.length;g++)if(i.neighbours[g].aid!=i.parent)for(h=0;4>h;h++)if(i.neighbours[g].aid==b.pyramid[h]){if(f>=4)throw new Error("internal: pyramid overflow");d[f++]=h;break}if(4==f)f=d[0],d[0]=d[1],d[1]=d[2],d[2]=d[3],d[3]=f;else if(3!=f)throw new Error("cannot calculate chirality");this.atoms[a].chirality=e.Stereocenters.isPyramidMappingRigid(d)?1:2},this)}catch(a){alert("Warning: "+a.message)}var t=[];t.push(0);var u=!0;for(f=0;f<l.v_seq.length;f++){m=l.v_seq[f],n=m.idx,o=m.parent_edge,p=m.parent_vertex;var v=!0;if(p>=0){for(l.numBranches(p)>1&&this.atoms[p].branch_cnt>0&&this.atoms[p].paren_written&&(this.smiles+=")"),r=l.numOpeningCycles(o),g=0;r>g;g++){for(h=1;h<t.length&&-1!=t[h];h++);h==t.length?t.push(p):t[h]=p,this._writeCycleNumber(h)}if(p>=0){var w=l.numBranches(p);if(w>1&&this.atoms[p].branch_cnt<w-1&&(l.edgeClosingCycle(o)?this.atoms[p].paren_written=!1:(this.smiles+="(",this.atoms[p].paren_written=!0)),this.atoms[p].branch_cnt++,this.atoms[p].branch_cnt>w)throw new Error("unexpected branch")}var x=a.bonds.get(o),y=!0,z=0;if(x.type==e.Struct.BOND.TYPE.SINGLE&&(z=this._calcBondDirection(a,o,p)),1==z&&n==x.end||2==z&&n==x.begin?this.smiles+="/":2==z&&n==x.end||1==z&&n==x.begin?this.smiles+="\\":x.type==e.Struct.BOND.TYPE.ANY?this.smiles+="~":x.type==e.Struct.BOND.TYPE.DOUBLE?this.smiles+="=":x.type==e.Struct.BOND.TYPE.TRIPLE?this.smiles+="#":x.type!=e.Struct.BOND.TYPE.AROMATIC||this.atoms[x.begin].lowercase&&this.atoms[x.end].lowercase&&this.isBondInRing(o)?x.type==e.Struct.BOND.TYPE.SINGLE&&this.atoms[x.begin].aromatic&&this.atoms[x.end].aromatic?this.smiles+="-":y=!1:this.smiles+=":",l.edgeClosingCycle(o)){for(g=1;g<t.length&&t[g]!=n;g++);if(g==t.length)throw new Error("cycle number not found");this._writeCycleNumber(g),t[g]=-1,v=!1}}else u||(this.smiles+=this._written_components==l.nComponentsInReactants?">>":"."),u=!1,this._written_components++;v&&(this._writeAtom(a,n,this.atoms[n].aromatic,this.atoms[n].lowercase,this.atoms[n].chirality),this._written_atoms.push(m.idx))}return this.comma=!1,this._writeRadicals(a),this.comma&&(this.smiles+="|"),this.smiles},e.SmilesSaver.prototype._writeCycleNumber=function(a){if(a>0&&10>a)this.smiles+=a;else if(a>=10&&100>a)this.smiles+="%"+a;else{if(!(a>=100&&1e3>a))throw new Error("bad cycle number: "+a);this.smiles+="%%"+a}},e.SmilesSaver.prototype._writeAtom=function(a,b,c,d,e){var f=a.atoms.get(b),g=!1,h=-1,i=0;if("A"==f.label)return void(this.smiles+="*");if("R"==f.label||"R#"==f.label)return void(this.smiles+="[*]");i=f.aam,"C"!=f.label&&"P"!=f.label&&"N"!=f.label&&"S"!=f.label&&"O"!=f.label&&"Cl"!=f.label&&"F"!=f.label&&"Br"!=f.label&&"B"!=f.label&&"I"!=f.label&&(g=!0),(f.explicitValence>=0||0!=f.radical||e>0||c&&"C"!=f.label&&"O"!=f.label||c&&"C"==f.label&&this.atoms[b].neighbours.length<3&&0==this.atoms[b].h_count)&&(h=this.atoms[b].h_count);var j=f.label;if(f.atomList&&!f.atomList.notList?(j=f.atomList.label(),g=!1):f.isPseudo()||f.atomList&&f.atomList.notList?(j="*",g=!0):(e||0!=f.charge||f.isotope>0||h>=0||i>0)&&(g=!0),g&&(-1==h&&(h=this.atoms[b].h_count),this.smiles+="["),f.isotope>0&&(this.smiles+=f.isotope),this.smiles+=d?j.toLowerCase():j,e>0&&(this.smiles+=1==e?"@":"@@",f.implicitH>1))throw new Error(f.implicitH+" implicit H near stereocenter");"H"!=f.label&&(h>1||0==h&&!g?this.smiles+="H"+h:1==h&&(this.smiles+="H")),f.charge>1?this.smiles+="+"+f.charge:f.charge<-1?this.smiles+=f.charge:1==f.charge?this.smiles+="+":-1==f.charge&&(this.smiles+="-"),i>0&&(this.smiles+=":"+i),g&&(this.smiles+="]")},e.SmilesSaver.prototype._markCisTrans=function(a){this.cis_trans=new e.CisTrans(a,function(a){return this.atoms[a].neighbours},this),this.cis_trans.build(),this._dbonds=new Array(a.bonds.count()),a.bonds.each(function(a){this._dbonds[a]={ctbond_beg:-1,ctbond_end:-1,saved:0}},this),this.cis_trans.each(function(b,c){var d=a.bonds.get(b);if(0!=c.parity&&!this.isBondInRing(b)){var f=this.atoms[d.begin].neighbours,g=this.atoms[d.end].neighbours,h=!0,i=!0;if(f.each(function(c){c.bid!=b&&a.bonds.get(c.bid).type==e.Struct.BOND.TYPE.SINGLE&&(h=!1)},this),g.each(function(c){c.bid!=b&&a.bonds.get(c.bid).type==e.Struct.BOND.TYPE.SINGLE&&(i=!1)},this),h||i)return;f.each(function(c){c.bid!=b&&(a.bonds.get(c.bid).begin==d.begin?this._dbonds[c.bid].ctbond_beg=b:this._dbonds[c.bid].ctbond_end=b)},this),g.each(function(c){c.bid!=b&&(a.bonds.get(c.bid).begin==d.end?this._dbonds[c.bid].ctbond_beg=b:this._dbonds[c.bid].ctbond_end=b)},this)}},this)},e.SmilesSaver.prototype._updateSideBonds=function(a,b){var c=a.bonds.get(b),d=this.cis_trans.getSubstituents(b),f=this.cis_trans.getParity(b),g=[-1,-1,-1,-1];g[0]=a.findBondId(d[0],c.begin),-1!=d[1]&&(g[1]=a.findBondId(d[1],c.begin)),g[2]=a.findBondId(d[2],c.end),-1!=d[3]&&(g[3]=a.findBondId(d[3],c.end));var h=0,i=0,j=0,k=0;if(0!=this._dbonds[g[0]].saved&&(1==this._dbonds[g[0]].saved&&a.bonds.get(g[0]).begin==c.begin||2==this._dbonds[g[0]].saved&&a.bonds.get(g[0]).end==c.begin?h++:i++),-1!=g[1]&&0!=this._dbonds[g[1]].saved&&(2==this._dbonds[g[1]].saved&&a.bonds.get(g[1]).begin==c.begin||1==this._dbonds[g[1]].saved&&a.bonds.get(g[1]).end==c.begin?h++:i++),0!=this._dbonds[g[2]].saved&&(1==this._dbonds[g[2]].saved&&a.bonds.get(g[2]).begin==c.end||2==this._dbonds[g[2]].saved&&a.bonds.get(g[2]).end==c.end?j++:k++),-1!=g[3]&&0!=this._dbonds[g[3]].saved&&(2==this._dbonds[g[3]].saved&&a.bonds.get(g[3]).begin==c.end||1==this._dbonds[g[3]].saved&&a.bonds.get(g[3]).end==c.end?j++:k++),f==e.CisTrans.PARITY.CIS?(h+=j,i+=k):(h+=k,i+=j),h>0&&i>0)throw new Error("incompatible cis-trans configuration");return(0!=h||0!=i)&&(h>0&&(this._dbonds[g[0]].saved=a.bonds.get(g[0]).begin==c.begin?1:2,-1!=g[1]&&(this._dbonds[g[1]].saved=a.bonds.get(g[1]).begin==c.begin?2:1),this._dbonds[g[2]].saved=a.bonds.get(g[2]).begin==c.end==(f==e.CisTrans.PARITY.CIS)?1:2,-1!=g[3]&&(this._dbonds[g[3]].saved=a.bonds.get(g[3]).begin==c.end==(f==e.CisTrans.PARITY.CIS)?2:1)),i>0&&(this._dbonds[g[0]].saved=a.bonds.get(g[0]).begin==c.begin?2:1,-1!=g[1]&&(this._dbonds[g[1]].saved=a.bonds.get(g[1]).begin==c.begin?1:2),this._dbonds[g[2]].saved=a.bonds.get(g[2]).begin==c.end==(f==e.CisTrans.PARITY.CIS)?2:1,-1!=g[3]&&(this._dbonds[g[3]].saved=a.bonds.get(g[3]).begin==c.end==(f==e.CisTrans.PARITY.CIS)?1:2)),!0)},e.SmilesSaver.prototype._calcBondDirection=function(a,b,c){var d;if(-1==this._dbonds[b].ctbond_beg&&-1==this._dbonds[b].ctbond_end)return 0;if(a.bonds.get(b).type!=e.Struct.BOND.TYPE.SINGLE)throw new Error("internal: directed bond type "+a.bonds.get(b).type);for(;d=0,this.cis_trans.each(function(b,c){0==c.parity||this.isBondInRing(b)||this._updateSideBonds(a,b)&&d++},this),d!=this._touched_cistransbonds;)this._touched_cistransbonds=d;return 0==this._dbonds[b].saved&&(this._dbonds[b].saved=c==a.bonds.get(b).begin?1:2),this._dbonds[b].saved},e.SmilesSaver.prototype._writeRadicals=function(a){var b,c,d=new Array(this._written_atoms.length);for(b=0;b<this._written_atoms.size();b++)if(!d[b]){var f=a.atoms.get(this._written_atoms[b]).radical;if(0!=f)for(this.comma?this.smiles+=",":(this.smiles+=" |",this.comma=!0),this.smiles+=f==e.Struct.ATOM.RADICAL.SINGLET?"^3:":f==e.Struct.ATOM.RADICAL.DOUPLET?"^1:":"^4:",this.smiles+=b,c=b+1;c<this._written_atoms.length;c++)a.atoms.get(this._written_atoms[c]).radical==f&&(d[c]=!0,this.smiles+=","+c)}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../util":39,"../util/set":42,"./struct":16}],15:[function(a,b,c){(function(b){var c=a("../util/map"),d=a("../util/set"),e=a("../util/vec2"),f=a("../util");a("./struct");var g=b.chem=b.chem||{};g.Stereocenters=function(a,b,d){this.molecule=a,this.atoms=new c,this.getNeighbors=b,this.context=d},g.Stereocenters.prototype.each=function(a,b){this.atoms.each(a,b)},g.Stereocenters.prototype.buildFromBonds=function(a){var b=this.molecule.atoms,c=this.molecule.bonds,e=d.empty();b.each(function(a){var h=this.getNeighbors.call(this.context,a);if(2!=h.length)return!1;var i=h[0],j=h[1];if(f.findIndex([a,i.aid,j.aid],function(a){return["C","Si"].indexOf(b.get(a).label)<0},this)>=0)return!1;if(f.findIndex([i.bid,j.bid],function(a){return c.get(a).type!=g.Struct.BOND.TYPE.DOUBLE},this)>=0)return!1;var k=f.findAll(this.getNeighbors.call(this.context,i.aid),function(b){return b.aid!=a},this),l=f.findAll(this.getNeighbors.call(this.context,j.aid),function(b){return b.aid!=a},this);return!(k.length<1||k.length>2||l.length<1||l.length>2)&&(!(f.findIndex(k.concat(l),function(a){return c.get(a.bid).type!=g.Struct.BOND.TYPE.SINGLE},this)>=0)&&(!(f.findIndex(k.concat(l),function(a){return c.get(a.bid).stereo==g.Struct.BOND.STEREO.EITHER},this)>=0)&&(d.add(e,i.aid),void d.add(e,j.aid))))},this),d.size(e)>0&&alert("This structure may contain allenes, which cannot be represented in the SMILES notation. Relevant stereo-information will be discarded."),b.each(function(b){if(!d.contains(e,b)){var c=this.getNeighbors.call(this.context,b),f=!1;c.find(function(a){var c=this.molecule.bonds.get(a.bid);return c.type==g.Struct.BOND.TYPE.SINGLE&&c.begin==b&&(c.stereo==g.Struct.BOND.STEREO.UP||c.stereo==g.Struct.BOND.STEREO.DOWN)&&(f=!0,!0)},this),f&&(a?this._buildOneCenter(b):this._buildOneCenter(b))}},this)},g.Stereocenters.allowed_stereocenters=[{elem:"C",charge:0,degree:3,n_double_bonds:0,implicit_degree:4},{elem:"C",charge:0,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"Si",charge:0,degree:3,n_double_bonds:0,implicit_degree:4},{elem:"Si",charge:0,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"N",charge:1,degree:3,n_double_bonds:0,implicit_degree:4},{elem:"N",charge:1,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"N",charge:0,degree:3,n_double_bonds:0,implicit_degree:3},{elem:"S",charge:0,degree:4,n_double_bonds:2,implicit_degree:4},{elem:"S",charge:1,degree:3,n_double_bonds:0,implicit_degree:3},{elem:"S",charge:0,degree:3,n_double_bonds:1,implicit_degree:3},{elem:"P",charge:0,degree:3,n_double_bonds:0,implicit_degree:3},{elem:"P",charge:1,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"P",charge:0,degree:4,n_double_bonds:1,implicit_degree:4}],g.Stereocenters.prototype._buildOneCenter=function(a){var b=this.molecule.atoms.get(a),c=this.getNeighbors.call(this.context,a),d=c.length,f=-1,h={group:0,type:0,pyramid:new Array(4)},i=0,j=new Array(4),k=0,l=0;h.pyramid[0]=-1,h.pyramid[1]=-1,h.pyramid[2]=-1,h.pyramid[3]=-1;var m=0;if(d>4)throw new Error("stereocenter with %d bonds are not supported"+d);if(c.each(function(a){var c=this.molecule.atoms.get(a.aid),d=this.molecule.bonds.get(a.bid);if(j[i]={edge_idx:a.bid,nei_idx:a.aid,rank:a.aid,vec:e.diff(c.pp,b.pp).yComplement()},c.pureHydrogen()?(m++,j[i].rank=1e4):"H"==c.label&&(j[i].rank=5e3),!j[i].vec.normalize())throw new Error("zero bond length");if(d.type==g.Struct.BOND.TYPE.TRIPLE)throw new Error("non-single bonds not allowed near stereocenter");if(d.type==g.Struct.BOND.TYPE.AROMATIC)throw new Error("aromatic bonds not allowed near stereocenter");d.type==g.Struct.BOND.TYPE.DOUBLE&&l++,i++},this),g.Stereocenters.allowed_stereocenters.find(function(a){return a.elem==b.label&&a.charge==b.charge&&a.degree==d&&a.n_double_bonds==l&&(f=a.implicit_degree,!0)},this),-1==f)throw new Error("unknown stereocenter configuration: "+b.label+", charge "+b.charge+", "+d+" bonds ("+l+" double)");if(4==d&&m>1)throw new Error(m+" hydrogens near stereocenter");if(3==d&&4==f&&m>0)throw new Error("have hydrogen(s) besides implicit hydrogen near stereocenter");if(4==d){j[0].rank>j[1].rank&&j.swap(0,1),j[1].rank>j[2].rank&&j.swap(1,2),j[2].rank>j[3].rank&&j.swap(2,3),j[1].rank>j[2].rank&&j.swap(1,2),j[0].rank>j[1].rank&&j.swap(0,1),j[1].rank>j[2].rank&&j.swap(1,2);var n=-1,o=-1,p=-1,q=-1,r=0;for(i=0;4>i;i++){var s=this._getBondStereo(a,j[i].edge_idx);if(s==g.Struct.BOND.STEREO.UP||s==g.Struct.BOND.STEREO.DOWN){n=i,r=s;break}}if(-1==n)throw new Error("none of 4 bonds going from stereocenter is stereobond");var t,u;if(-1==o&&(t=g.Stereocenters._xyzzy(j[n].vec,j[(n+1)%4].vec,j[(n+2)%4].vec),u=g.Stereocenters._xyzzy(j[n].vec,j[(n+1)%4].vec,j[(n+3)%4].vec),(3==t+u||12==t+u)&&(o=(n+1)%4,p=(n+2)%4,q=(n+3)%4)),-1==o&&(t=g.Stereocenters._xyzzy(j[n].vec,j[(n+2)%4].vec,j[(n+1)%4].vec),u=g.Stereocenters._xyzzy(j[n].vec,j[(n+2)%4].vec,j[(n+3)%4].vec),(3==t+u||12==t+u)&&(o=(n+2)%4,p=(n+1)%4,q=(n+3)%4)),-1==o&&(t=g.Stereocenters._xyzzy(j[n].vec,j[(n+3)%4].vec,j[(n+1)%4].vec),u=g.Stereocenters._xyzzy(j[n].vec,j[(n+3)%4].vec,j[(n+2)%4].vec),(3==t+u||12==t+u)&&(o=(n+3)%4,p=(n+2)%4,q=(n+1)%4)),-1==o)throw new Error("internal error: can not find opposite bond");if(r==g.Struct.BOND.STEREO.UP&&this._getBondStereo(a,j[o].edge_idx)==g.Struct.BOND.STEREO.DOWN)throw new Error("stereo types of the opposite bonds mismatch");if(r==g.Struct.BOND.STEREO.DOWN&&this._getBondStereo(a,j[o].edge_idx)==g.Struct.BOND.STEREO.UP)throw new Error("stereo types of the opposite bonds mismatch");if(r==this._getBondStereo(a,j[p].edge_idx))throw new Error("stereo types of non-opposite bonds match");if(r==this._getBondStereo(a,j[q].edge_idx))throw new Error("stereo types of non-opposite bonds match");k=3==n||3==o?r:r==g.Struct.BOND.STEREO.UP?g.Struct.BOND.STEREO.DOWN:g.Struct.BOND.STEREO.UP,B=g.Stereocenters._sign(j[0].vec,j[1].vec,j[2].vec),k==g.Struct.BOND.STEREO.UP&&B>0||k==g.Struct.BOND.STEREO.DOWN&&0>B?(h.pyramid[0]=j[0].nei_idx,h.pyramid[1]=j[1].nei_idx,h.pyramid[2]=j[2].nei_idx):(h.pyramid[0]=j[0].nei_idx,h.pyramid[1]=j[2].nei_idx,h.pyramid[2]=j[1].nei_idx),h.pyramid[3]=j[3].nei_idx}else if(3==d){j[0].rank>j[1].rank&&j.swap(0,1),j[1].rank>j[2].rank&&j.swap(1,2),j[0].rank>j[1].rank&&j.swap(0,1);var v=this._getBondStereo(a,j[0].edge_idx),w=this._getBondStereo(a,j[1].edge_idx),x=this._getBondStereo(a,j[2].edge_idx),y=0,z=0;if(y+=v==g.Struct.BOND.STEREO.UP?1:0,y+=w==g.Struct.BOND.STEREO.UP?1:0,y+=x==g.Struct.BOND.STEREO.UP?1:0,z+=v==g.Struct.BOND.STEREO.DOWN?1:0,z+=w==g.Struct.BOND.STEREO.DOWN?1:0,z+=x==g.Struct.BOND.STEREO.DOWN?1:0,4==f){if(3==y)throw new Error("all 3 bonds up near stereoatom");if(3==z)throw new Error("all 3 bonds down near stereoatom");if(0==y&&0==z)throw new Error("no up/down bonds near stereoatom -- indefinite case");if(1==y&&1==z)throw new Error("one bond up, one bond down -- indefinite case");if(r=0,2==y)k=g.Struct.BOND.STEREO.DOWN;else if(2==z)k=g.Struct.BOND.STEREO.UP;else{for(n=-1,p=-1,q=-1,i=0;3>i;i++)if(C=this._getBondStereo(a,j[i].edge_idx),C==g.Struct.BOND.STEREO.UP||C==g.Struct.BOND.STEREO.DOWN){n=i,r=C,p=(i+1)%3,q=(i+2)%3;break}if(-1==n)throw new Error("internal error: can not find up or down bond");var A=g.Stereocenters._xyzzy(j[p].vec,j[q].vec,j[n].vec);if(3==A||4==A)throw new Error("degenerate case for 3 bonds near stereoatom");k=1==A?r:r==g.Struct.BOND.STEREO.UP?g.Struct.BOND.STEREO.DOWN:g.Struct.BOND.STEREO.UP}var B=g.Stereocenters._sign(j[0].vec,j[1].vec,j[2].vec);k==g.Struct.BOND.STEREO.UP&&B>0||k==g.Struct.BOND.STEREO.DOWN&&0>B?(h.pyramid[0]=j[0].nei_idx,h.pyramid[1]=j[1].nei_idx,h.pyramid[2]=j[2].nei_idx):(h.pyramid[0]=j[0].nei_idx,h.pyramid[1]=j[2].nei_idx,h.pyramid[2]=j[1].nei_idx),h.pyramid[3]=-1}else{var C;if(z>0&&y>0)throw new Error("one bond up, one bond down -- indefinite case");if(0==z&&0==y)throw new Error("no up-down bonds attached to stereocenter");C=y>0?1:-1,(1==g.Stereocenters._xyzzy(j[0].vec,j[1].vec,j[2].vec)||1==g.Stereocenters._xyzzy(j[0].vec,j[2].vec,j[1].vec)||1==g.Stereocenters._xyzzy(j[2].vec,j[1].vec,j[0].vec))&&(C=-C),B=g.Stereocenters._sign(j[0].vec,j[1].vec,j[2].vec),B==C?(h.pyramid[0]=j[0].nei_idx,h.pyramid[1]=j[2].nei_idx,h.pyramid[2]=j[1].nei_idx):(h.pyramid[0]=j[0].nei_idx,h.pyramid[1]=j[1].nei_idx,h.pyramid[2]=j[2].nei_idx),h.pyramid[3]=-1}}this.atoms.set(a,h)},g.Stereocenters.prototype._getBondStereo=function(a,b){var c=this.molecule.bonds.get(b);return a!=c.begin?0:c.stereo},g.Stereocenters._xyzzy=function(a,b,c){var d=.001,f=e.cross(a,b),g=e.dot(a,b),h=e.cross(a,c),i=e.dot(a,c);if(Math.abs(f)<d){if(Math.abs(h)<d)throw new Error("degenerate case -- bonds overlap");return h>0?4:8}return-d*d>f*h?2:g>i?2:1},g.Stereocenters._sign=function(a,b,c){var d=(a.x-c.x)*(b.y-c.y)-(a.y-c.y)*(b.x-c.x),e=.001;if(d>e)return 1;if(-e>d)return-1;throw new Error("degenerate triangle")},g.Stereocenters.isPyramidMappingRigid=function(a){var b=a.clone(),c=!0;return b[0]>b[1]&&(b.swap(0,1),c=!c),b[1]>b[2]&&(b.swap(1,2),c=!c),b[2]>b[3]&&(b.swap(2,3),c=!c),b[1]>b[2]&&(b.swap(1,2),c=!c),b[0]>b[1]&&(b.swap(0,1),c=!c),b[1]>b[2]&&(b.swap(1,2),c=!c),c}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../util":39,"../util/map":40,"../util/set":42,"../util/vec2":43,"./struct":16}],16:[function(a,b,c){(function(b){var c=a("../util/map"),d=a("../util/pool"),e=a("../util/set"),f=a("../util/vec2"),g=a("../util"),h=a("./element"),i=b.chem=b.chem||{};i.Struct=function(){this.atoms=new d,this.bonds=new d,this.sgroups=new d,this.halfBonds=new c,this.loops=new d,this.isChiral=!1,this.isReaction=!1,this.rxnArrows=new d,this.rxnPluses=new d,this.frags=new d,this.rgroups=new c,this.name="",this.sGroupForest=new i.SGroupForest(this)},i.Struct.prototype.hasRxnProps=function(){return this.atoms.find(function(a,b){return b.hasRxnProps()},this)>=0||this.bonds.find(function(a,b){return b.hasRxnProps()},this)>=0},i.Struct.prototype.hasRxnArrow=function(){return this.rxnArrows.count()>0},i.Struct.prototype.addRxnArrowIfNecessary=function(){var a=!this.hasRxnArrow()&&this.hasRxnProps();return a&&this.rxnArrows.add(new i.Struct.RxnArrow),a},i.Struct.prototype.getSGroupsInAtomSet=function(a){var b=new Hash;g.each(a,function(a){var c=e.list(this.atoms.get(a).sgs);c.each(function(a){var c=b.get(a);Object.isUndefined(c)?c=1:c++,b.set(a,c)},this)},this);var c=[];return b.each(function(a){var b=parseInt(a.key,10),d=this.sgroups.get(b),e=i.SGroup.getAtoms(this,d);a.value==e.length&&c.push(b)},this),c},i.Struct.prototype.isBlank=function(){return 0===this.atoms.count()&&0===this.rxnArrows.count()&&0===this.rxnPluses.count()&&!this.isChiral},i.Struct.prototype.toLists=function(){var a={},b=[];this.atoms.each(function(c,d){a[c]=b.length,b.push(d)});var c=[];return this.bonds.each(function(b,d){var e=new i.Struct.Bond(d);e.begin=a[d.begin],e.end=a[d.end],c.push(e)}),{atoms:b,bonds:c}},i.Struct.prototype.clone=function(a,b,c,d){var e=new i.Struct;return this.mergeInto(e,a,b,c,!1,d)},i.Struct.prototype.getScaffold=function(){var a=e.empty();return this.atoms.each(function(b){e.add(a,b)},this),this.rgroups.each(function(b,c){c.frags.each(function(b,c){this.atoms.each(function(b,d){d.fragment==c&&e.remove(a,b)},this)},this)},this),this.clone(a)},i.Struct.prototype.getFragmentIds=function(a){var b=e.empty();return this.atoms.each(function(c,d){d.fragment==a&&e.add(b,c)},this),b},i.Struct.prototype.getFragment=function(a){return this.clone(this.getFragmentIds(a))},i.Struct.prototype.mergeInto=function(a,b,c,d,f,g){b=b||e.keySetInt(this.atoms),c=c||e.keySetInt(this.bonds),c=e.filter(c,function(a){var c=this.bonds.get(a);return e.contains(b,c.begin)&&e.contains(b,c.end)},this);var h={};this.atoms.each(function(a,c){e.contains(b,a)&&(h[c.fragment]=1)});var j={};this.frags.each(function(b,c){h[b]&&(j[b]=a.frags.add(c.clone()))}),this.rgroups.each(function(b,c){var d=f;if(d||(c.frags.each(function(a,b){h[b]&&(d=!0)}),d)){var e=a.rgroups.get(b);e?c.frags.each(function(a,b){h[b]&&e.frags.add(j[b])}):a.rgroups.set(b,c.clone(j))}}),("undefined"==typeof g||null===g)&&(g={}),this.atoms.each(function(c,d){e.contains(b,c)&&(g[c]=a.atoms.add(d.clone(j)))});var k={};return this.bonds.each(function(b,d){e.contains(c,b)&&(k[b]=a.bonds.add(d.clone(g)))}),this.sgroups.each(function(c,d){var f;for(f=0;f<d.atoms.length;++f)if(!e.contains(b,d.atoms[f]))return;d=i.SGroup.clone(d,g,k);var h=a.sgroups.add(d);for(d.id=h,f=0;f<d.atoms.length;++f)e.add(a.atoms.get(d.atoms[f]).sgs,h);a.sGroupForest.insert(d.id)}),a.isChiral=this.isChiral,d||(a.isReaction=this.isReaction,this.rxnArrows.each(function(b,c){a.rxnArrows.add(c.clone())}),this.rxnPluses.each(function(b,c){a.rxnPluses.add(c.clone())})),a},i.Struct.prototype.findBondId=function(a,b){var c=-1;return this.bonds.find(function(d,e){return(e.begin==a&&e.end==b||e.begin==b&&e.end==a)&&(c=d,!0)},this),c},i.Struct.ATOM={RADICAL:{NONE:0,SINGLET:1,DOUPLET:2,TRIPLET:3}},i.Struct.radicalElectrons=function(a){if(a-=0,a==i.Struct.ATOM.RADICAL.NONE)return 0;if(a==i.Struct.ATOM.RADICAL.DOUPLET)return 1;if(a==i.Struct.ATOM.RADICAL.SINGLET||a==i.Struct.ATOM.RADICAL.TRIPLET)return 2;throw new Error("Unknown radical value")},i.Struct.BOND={TYPE:{SINGLE:1,DOUBLE:2,TRIPLE:3,AROMATIC:4,SINGLE_OR_DOUBLE:5,SINGLE_OR_AROMATIC:6,DOUBLE_OR_AROMATIC:7,ANY:8},STEREO:{NONE:0,UP:1,EITHER:4,DOWN:6,CIS_TRANS:3},TOPOLOGY:{EITHER:0,RING:1,CHAIN:2},REACTING_CENTER:{NOT_CENTER:-1,UNMARKED:0,CENTER:1,UNCHANGED:2,MADE_OR_BROKEN:4,ORDER_CHANGED:8,MADE_OR_BROKEN_AND_CHANGED:12}},i.Struct.FRAGMENT={NONE:0,REACTANT:1,PRODUCT:2,AGENT:3},i.Struct.Atom=function(a){var b=i.Struct.Atom.attrGetDefault;if(!(a&&"label"in a))throw new Error("label must be specified!");this.label=a.label,this.fragment=Object.isUndefined(a.fragment)?-1:a.fragment,g.ifDef(this,a,"isotope",b("isotope")),g.ifDef(this,a,"radical",b("radical")),g.ifDef(this,a,"charge",b("charge")),g.ifDef(this,a,"rglabel",b("rglabel")),g.ifDef(this,a,"attpnt",b("attpnt")),g.ifDef(this,a,"explicitValence",b("explicitValence")),this.valence=0,this.implicitH=0,this.pp=Object.isUndefined(a.pp)?new f:new f(a.pp),this.sgs={},g.ifDef(this,a,"ringBondCount",b("ringBondCount")),g.ifDef(this,a,"substitutionCount",b("substitutionCount")),g.ifDef(this,a,"unsaturatedAtom",b("unsaturatedAtom")),g.ifDef(this,a,"hCount",b("hCount")),g.ifDef(this,a,"aam",b("aam")),g.ifDef(this,a,"invRet",b("invRet")),g.ifDef(this,a,"exactChangeFlag",b("exactChangeFlag")),g.ifDef(this,a,"rxnFragmentType",-1),this.atomList=Object.isUndefined(a.atomList)||null==a.atomList?null:new i.Struct.AtomList(a.atomList),this.neighbors=[],this.badConn=!1},i.Struct.Atom.getAttrHash=function(a){var b=new Hash;for(var c in i.Struct.Atom.attrlist)"undefined"!=typeof a[c]&&b.set(c,a[c]);return b},i.Struct.Atom.attrGetDefault=function(a){if(a in i.Struct.Atom.attrlist)return i.Struct.Atom.attrlist[a];throw new Error("Attribute unknown")},i.Struct.Atom.attrlist={label:"C",isotope:0,radical:0,charge:0,explicitValence:-1,ringBondCount:0,substitutionCount:0,unsaturatedAtom:0,hCount:0,atomList:null,invRet:0,exactChangeFlag:0,rglabel:null,attpnt:null,aam:0},i.Struct.Atom.prototype.clone=function(a){var b=new i.Struct.Atom(this);return a&&this.fragment in a&&(b.fragment=a[this.fragment]),b},i.Struct.Atom.prototype.isQuery=function(){return null!=this.atomList||"A"==this.label||this.attpnt||this.hCount},i.Struct.Atom.prototype.pureHydrogen=function(){return"H"==this.label&&0==this.isotope},i.Struct.Atom.prototype.isPlainCarbon=function(){return"C"==this.label&&0==this.isotope&&0==this.radical&&0==this.charge&&this.explicitValence<0&&0==this.ringBondCount&&0==this.substitutionCount&&0==this.unsaturatedAtom&&0==this.hCount&&!this.atomList},i.Struct.Atom.prototype.isPseudo=function(){return!this.atomList&&!this.rglabel&&!h.getElementByLabel(this.label);
},i.Struct.Atom.prototype.hasRxnProps=function(){return!(!this.invRet&&!this.exactChangeFlag&&g.isNull(this.attpnt)&&!this.aam)},i.Struct.AtomList=function(a){if(!(a&&"notList"in a&&"ids"in a))throw new Error("'notList' and 'ids' must be specified!");this.notList=a.notList,this.ids=a.ids},i.Struct.AtomList.prototype.labelList=function(){for(var a=[],b=0;b<this.ids.length;++b)a.push(h.get(this.ids[b]).label);return a},i.Struct.AtomList.prototype.label=function(){var a="["+this.labelList().join(",")+"]";return this.notList&&(a="!"+a),a},i.Struct.AtomList.prototype.equals=function(a){return this.notList==a.notList&&(this.ids||[]).sort().toString()==(a.ids||[]).sort().toString()},i.Struct.Bond=function(a){if(!(a&&"begin"in a&&"end"in a&&"type"in a))throw new Error("'begin', 'end' and 'type' properties must be specified!");this.begin=a.begin,this.end=a.end,this.type=a.type,g.ifDef(this,a,"stereo",i.Struct.BOND.STEREO.NONE),g.ifDef(this,a,"topology",i.Struct.BOND.TOPOLOGY.EITHER),g.ifDef(this,a,"reactingCenterStatus",0),this.hb1=null,this.hb2=null,this.len=0,this.center=new f,this.sb=0,this.sa=0,this.angle=0},i.Struct.Bond.attrlist={type:i.Struct.BOND.TYPE.SINGLE,stereo:i.Struct.BOND.STEREO.NONE,topology:i.Struct.BOND.TOPOLOGY.EITHER,reactingCenterStatus:0},i.Struct.Bond.getAttrHash=function(a){var b=new Hash;for(var c in i.Struct.Bond.attrlist)"undefined"!=typeof a[c]&&b.set(c,a[c]);return b},i.Struct.Bond.attrGetDefault=function(a){if(a in i.Struct.Bond.attrlist)return i.Struct.Bond.attrlist[a];throw new Error("Attribute unknown")},i.Struct.Bond.prototype.hasRxnProps=function(){return!!this.reactingCenterStatus},i.Struct.Bond.prototype.getCenter=function(a){var b=a.atoms.get(this.begin).pp,c=a.atoms.get(this.end).pp;return f.lc2(b,.5,c,.5)},i.Struct.Bond.prototype.getDir=function(a){var b=a.atoms.get(this.begin).pp,c=a.atoms.get(this.end).pp;return c.sub(b).normalized()},i.Struct.Bond.prototype.clone=function(a){var b=new i.Struct.Bond(this);return a&&(b.begin=a[b.begin],b.end=a[b.end]),b},i.Struct.Bond.prototype.findOtherEnd=function(a){if(a==this.begin)return this.end;if(a==this.end)return this.begin;throw new Error("bond end not found")},i.HalfBond=function(a,b,c){if(3!=arguments.length)throw new Error("Invalid parameter number!");this.begin=a-0,this.end=b-0,this.bid=c-0,this.dir=new f,this.norm=new f,this.ang=0,this.p=new f,this.loop=-1,this.contra=-1,this.next=-1,this.leftSin=0,this.leftCos=0,this.leftNeighbor=0,this.rightSin=0,this.rightCos=0,this.rightNeighbor=0},i.Struct.prototype.initNeighbors=function(){this.atoms.each(function(a,b){b.neighbors=[]}),this.bonds.each(function(a,b){var c=this.atoms.get(b.begin),d=this.atoms.get(b.end);c.neighbors.push(b.hb1),d.neighbors.push(b.hb2)},this)},i.Struct.prototype.bondInitHalfBonds=function(a,b){b=b||this.bonds.get(a),b.hb1=2*a,b.hb2=2*a+1,this.halfBonds.set(b.hb1,new i.HalfBond(b.begin,b.end,a)),this.halfBonds.set(b.hb2,new i.HalfBond(b.end,b.begin,a));var c=this.halfBonds.get(b.hb1),d=this.halfBonds.get(b.hb2);c.contra=b.hb2,d.contra=b.hb1},i.Struct.prototype.halfBondUpdate=function(a){var b=this.halfBonds.get(a),c=this.atoms.get(b.begin).pp,d=this.atoms.get(b.end).pp,e=f.diff(d,c).normalized();b.dir=f.dist(d,c)>1e-4?e:new f(1,0),b.norm=b.dir.turnLeft(),b.ang=b.dir.oxAngle(),b.loop<0&&(b.loop=-1)},i.Struct.prototype.initHalfBonds=function(){this.halfBonds.clear(),this.bonds.each(this.bondInitHalfBonds,this)},i.Struct.prototype.setHbNext=function(a,b){this.halfBonds.get(this.halfBonds.get(a).contra).next=b},i.Struct.prototype.halfBondSetAngle=function(a,b){var c=this.halfBonds.get(a),d=this.halfBonds.get(b);d.rightCos=c.leftCos=f.dot(d.dir,c.dir),d.rightSin=c.leftSin=f.cross(d.dir,c.dir),c.leftNeighbor=b,d.rightNeighbor=a},i.Struct.prototype.atomAddNeighbor=function(a){var b=this.halfBonds.get(a),c=this.atoms.get(b.begin),d=0;for(d=0;d<c.neighbors.length&&!(this.halfBonds.get(c.neighbors[d]).ang>b.ang);++d);c.neighbors.splice(d,0,a);var e=c.neighbors[(d+1)%c.neighbors.length],f=c.neighbors[(d+c.neighbors.length-1)%c.neighbors.length];this.setHbNext(f,a),this.setHbNext(a,e),this.halfBondSetAngle(a,f),this.halfBondSetAngle(e,a)},i.Struct.prototype.atomSortNeighbors=function(a){var b=this.atoms.get(a);b.neighbors=b.neighbors.sortBy(function(a){return this.halfBonds.get(a).ang},this);var c;for(c=0;c<b.neighbors.length;++c)this.halfBonds.get(this.halfBonds.get(b.neighbors[c]).contra).next=b.neighbors[(c+1)%b.neighbors.length];for(c=0;c<b.neighbors.length;++c)this.halfBondSetAngle(b.neighbors[(c+1)%b.neighbors.length],b.neighbors[c])},i.Struct.prototype.sortNeighbors=function(a){var b=function(a){this.atomSortNeighbors(a)};g.isNullOrUndefined(a)?this.atoms.each(b,this):g.each(a,b,this)},i.Struct.prototype.atomUpdateHalfBonds=function(a){for(var b=this.atoms.get(a).neighbors,c=0;c<b.length;++c){var d=b[c];this.halfBondUpdate(d),this.halfBondUpdate(this.halfBonds.get(d).contra)}},i.Struct.prototype.updateHalfBonds=function(a){var b=function(a){this.atomUpdateHalfBonds(a)};g.isNullOrUndefined(a)?this.atoms.each(b,this):g.each(a,b,this)},i.Struct.prototype.sGroupsRecalcCrossBonds=function(){this.sgroups.each(function(a,b){b.xBonds=[],b.neiAtoms=[]},this),this.bonds.each(function(a,b){var c=this.atoms.get(b.begin),d=this.atoms.get(b.end);e.each(c.sgs,function(c){if(!e.contains(d.sgs,c)){var f=this.sgroups.get(c);f.xBonds.push(a),g.arrayAddIfMissing(f.neiAtoms,b.end)}},this),e.each(d.sgs,function(d){if(!e.contains(c.sgs,d)){var f=this.sgroups.get(d);f.xBonds.push(a),g.arrayAddIfMissing(f.neiAtoms,b.begin)}},this)},this)},i.Struct.prototype.sGroupDelete=function(a){for(var b=this.sgroups.get(a),c=0;c<b.atoms.length;++c)e.remove(this.atoms.get(b.atoms[c]).sgs,a);this.sGroupForest.remove(a),this.sgroups.remove(a)},i.Struct.itemSetPos=function(a,b){a.pp=b},i.Struct.prototype._itemSetPos=function(a,b,c,d){i.Struct.itemSetPos(this[a].get(b),c,d)},i.Struct.prototype._atomSetPos=function(a,b,c){this._itemSetPos("atoms",a,b,c)},i.Struct.prototype._rxnPlusSetPos=function(a,b,c){this._itemSetPos("rxnPluses",a,b,c)},i.Struct.prototype._rxnArrowSetPos=function(a,b,c){this._itemSetPos("rxnArrows",a,b,c)},i.Struct.prototype.getCoordBoundingBox=function(a){var b=null,c=function(a){b?(b.min=f.min(b.min,a),b.max=f.max(b.max,a)):b={min:a,max:a}},d="undefined"==typeof a;return this.atoms.each(function(b,f){(d||e.contains(a,b))&&c(f.pp)}),d&&(this.rxnPluses.each(function(a,b){c(b.pp)}),this.rxnArrows.each(function(a,b){c(b.pp)})),!b&&d&&(b={min:new f(0,0),max:new f(1,1)}),b},i.Struct.prototype.getCoordBoundingBoxObj=function(){var a=null,b=function(b){a?(a.min=f.min(a.min,b),a.max=f.max(a.max,b)):a={min:new f(b),max:new f(b)}};return this.atoms.each(function(a,c){b(c.pp)}),a},i.Struct.prototype.getBondLengthData=function(){var a=0,b=0;return this.bonds.each(function(c,d){a+=f.dist(this.atoms.get(d.begin).pp,this.atoms.get(d.end).pp),b++},this),{cnt:b,totalLength:a}},i.Struct.prototype.getAvgBondLength=function(){var a=this.getBondLengthData();return a.cnt>0?a.totalLength/a.cnt:-1},i.Struct.prototype.getAvgClosestAtomDistance=function(){var a,b,c,d=0,e=0,g=this.atoms.keys();for(b=0;b<g.length;++b){for(a=-1,c=0;c<g.length;++c)c!=b&&(e=f.dist(this.atoms.get(g[c]).pp,this.atoms.get(g[b]).pp),(0>a||a>e)&&(a=e));d+=a}return g.length>0?d/g.length:-1},i.Struct.prototype.checkBondExists=function(a,b){var c=!1;return this.bonds.each(function(d,e){(e.begin==a&&e.end==b||e.end==a&&e.begin==b)&&(c=!0)},this),c},i.Loop=function(a,b,c){this.hbs=a,this.dblBonds=0,this.aromatic=!0,this.convex=c||!1,a.each(function(a){var c=b.bonds.get(b.halfBonds.get(a).bid);c.type!=i.Struct.BOND.TYPE.AROMATIC&&(this.aromatic=!1),c.type==i.Struct.BOND.TYPE.DOUBLE&&this.dblBonds++},this)},i.Struct.RxnPlus=function(a){a=a||{},this.pp=a.pp?new f(a.pp):new f},i.Struct.RxnPlus.prototype.clone=function(){return new i.Struct.RxnPlus(this)},i.Struct.RxnArrow=function(a){a=a||{},this.pp=a.pp?new f(a.pp):new f},i.Struct.RxnArrow.prototype.clone=function(){return new i.Struct.RxnArrow(this)},i.Struct.prototype.findConnectedComponent=function(a){for(var b={},c=[a],d=e.empty();c.length>0;)!function(){var a=c.pop();b[a]=1,e.add(d,a);for(var f=this.atoms.get(a),g=0;g<f.neighbors.length;++g){var h=this.halfBonds.get(f.neighbors[g]).end;e.contains(d,h)||c.push(h)}}.apply(this);return d},i.Struct.prototype.findConnectedComponents=function(a){this.halfBonds.count()||(this.initHalfBonds(),this.initNeighbors(),this.updateHalfBonds(this.atoms.keys()),this.sortNeighbors(this.atoms.keys()));var b={};this.atoms.each(function(a){b[a]=-1},this);var c=[];return this.atoms.each(function(d,f){if((a||f.fragment<0)&&b[d]<0){var g=this.findConnectedComponent(d);c.push(g),e.each(g,function(a){b[a]=1},this)}},this),c},i.Struct.prototype.markFragment=function(a){var b=this.frags.add(new i.Struct.Fragment);e.each(a,function(a){this.atoms.get(a).fragment=b},this)},i.Struct.prototype.markFragmentByAtomId=function(a){this.markFragment(this.findConnectedComponent(a))},i.Struct.prototype.markFragments=function(){for(var a=this.findConnectedComponents(),b=0;b<a.length;++b)this.markFragment(a[b])},i.Struct.Fragment=function(){},i.Struct.Fragment.prototype.clone=function(){return Object.clone(this)},i.Struct.Fragment.getAtoms=function(a,b){var c=[];return a.atoms.each(function(a,d){d.fragment==b&&c.push(a)},this),c},i.Struct.RGroup=function(a){a=a||{},this.frags=new d,this.resth=a.resth||!1,this.range=a.range||"",this.ifthen=a.ifthen||0},i.Struct.RGroup.prototype.getAttrs=function(){return{resth:this.resth,range:this.range,ifthen:this.ifthen}},i.Struct.RGroup.findRGroupByFragment=function(a,b){var c;return a.each(function(a,d){Object.isUndefined(d.frags.keyOf(b))||(c=a)}),c},i.Struct.RGroup.prototype.clone=function(a){var b=new i.Struct.RGroup(this);return this.frags.each(function(c,d){b.frags.add(a?a[d]:d)}),b},i.Struct.prototype.scale=function(a){1!=a&&(this.atoms.each(function(b,c){c.pp=c.pp.scaled(a)},this),this.rxnPluses.each(function(b,c){c.pp=c.pp.scaled(a)},this),this.rxnArrows.each(function(b,c){c.pp=c.pp.scaled(a)},this),this.sgroups.each(function(b,c){c.pp=c.pp?c.pp.scaled(a):null},this))},i.Struct.prototype.rescale=function(){var a=this.getAvgBondLength();0>a&&!this.isReaction&&(a=this.getAvgClosestAtomDistance()),.001>a&&(a=1);var b=1/a;this.scale(b)},i.Struct.prototype.loopHasSelfIntersections=function(a){for(var b=0;b<a.length;++b)for(var c=this.halfBonds.get(a[b]),d=this.atoms.get(c.begin).pp,g=this.atoms.get(c.end).pp,h=e.fromList([c.begin,c.end]),i=b+2;i<a.length;++i){var j=this.halfBonds.get(a[i]);if(!e.contains(h,j.begin)&&!e.contains(h,j.end)){var k=this.atoms.get(j.begin).pp,l=this.atoms.get(j.end).pp;if(f.segmentIntersection(d,g,k,l))return!0}}return!1},i.Struct.prototype.partitionLoop=function(a){var b=[],c=!0;a:for(;c;){for(var d={},e=0;e<a.length;++e){var f=a[e],g=this.halfBonds.get(f).begin,h=this.halfBonds.get(f).end;if(h in d){var i=d[h],j=a.slice(i,e+1);b.push(j),e<a.length&&a.splice(i,e-i+1);continue a}d[g]=e}c=!1,b.push(a)}return b},i.Struct.prototype.halfBondAngle=function(a,b){var c=this.halfBonds.get(a),d=this.halfBonds.get(b);return Math.atan2(f.cross(c.dir,d.dir),f.dot(c.dir,d.dir))},i.Struct.prototype.loopIsConvex=function(a){for(var b=0;b<a.length;++b){var c=this.halfBondAngle(a[b],a[(b+1)%a.length]);if(c>0)return!1}return!0},i.Struct.prototype.loopIsInner=function(a){for(var b=2*Math.PI,c=0;c<a.length;++c){var d=a[c],e=a[(c+1)%a.length],f=this.halfBonds.get(e),g=this.halfBondAngle(d,e);b+=f.contra==a[c]?Math.PI:g}return Math.abs(b)<Math.PI},i.Struct.prototype.findLoops=function(){var a,b,c,d,f=[],h=e.empty();return this.halfBonds.each(function(j,k){if(-1==k.loop)for(a=j,b=0,c=[];b<=this.halfBonds.count();a=this.halfBonds.get(a).next,++b){if(b>0&&a==j){var l=this.partitionLoop(c);g.each(l,function(a){this.loopIsInner(a)&&!this.loopHasSelfIntersections(a)?(d=g.arrayMin(a),this.loops.set(d,new i.Loop(a,this,this.loopIsConvex(a)))):d=-2,a.each(function(a){this.halfBonds.get(a).loop=d,e.add(h,this.halfBonds.get(a).bid)},this),d>=0&&f.push(d)},this);break}c.push(a)}},this),{newLoops:f,bondsToMark:e.list(h)}},i.Struct.prototype.prepareLoopStructure=function(){this.initHalfBonds(),this.initNeighbors(),this.updateHalfBonds(this.atoms.keys()),this.sortNeighbors(this.atoms.keys()),this.findLoops()},i.Struct.prototype.atomAddToSGroup=function(a,b){i.SGroup.addAtom(this.sgroups.get(a),b),e.add(this.atoms.get(b).sgs,a)}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../util":39,"../util/map":40,"../util/pool":41,"../util/set":42,"../util/vec2":43,"./element":10}],17:[function(a,b,c){(function(b){var c=a("../util"),d=a("./element");a("./struct");var e=b.chem=b.chem||{};e.Struct.prototype.calcConn=function(a){for(var b=0,c=this.atoms.get(a),d=!1,f=0;f<c.neighbors.length;++f){var g=this.halfBonds.get(c.neighbors[f]),h=this.bonds.get(g.bid);switch(h.type){case e.Struct.BOND.TYPE.SINGLE:b+=1;break;case e.Struct.BOND.TYPE.DOUBLE:b+=2;break;case e.Struct.BOND.TYPE.TRIPLE:b+=3;break;case e.Struct.BOND.TYPE.AROMATIC:b+=1,d=!0;break;default:return-1}}return d&&(b+=1),b},e.Struct.Atom.prototype.calcValence=function(a){var b=this,c=b.charge,f=b.label;if(b.isQuery())return this.implicitH=0,!0;var g=d.getElementByLabel(f);if(null==g)return this.implicitH=0,!0;var h=d.get(g).group,i=e.Struct.radicalElectrons(b.radical),j=a,k=0,l=Math.abs(c);return 1==h?("H"==f||"Li"==f||"Na"==f||"K"==f||"Rb"==f||"Cs"==f||"Fr"==f)&&(j=1,k=1-i-a-l):3==h?"B"==f||"Al"==f||"Ga"==f||"In"==f?-1==c?(j=4,k=4-i-a):(j=3,k=3-i-a-l):"Tl"==f&&(-1==c?2>=i+a?(j=2,k=2-i-a):(j=4,k=4-i-a):-2==c?3>=i+a?(j=3,k=3-i-a):(j=5,k=5-i-a):1>=i+a+l?(j=1,k=1-i-a-l):(j=3,k=3-i-a-l)):4==h?"C"==f||"Si"==f||"Ge"==f?(j=4,k=4-i-a-l):("Sn"==f||"Pb"==f)&&(2>=a+i+l?(j=2,k=2-i-a-l):(j=4,k=4-i-a-l)):5==h?"N"==f||"P"==f?1==c?(j=4,k=4-i-a):2==c?(j=3,k=3-i-a):"N"==f||3>=i+a+l?(j=3,k=3-i-a-l):(j=5,k=5-i-a-l):("Bi"==f||"Sb"==f||"As"==f)&&(1==c?2>=i+a&&"As"!=f?(j=2,k=2-i-a):(j=4,k=4-i-a):2==c?(j=3,k=3-i-a):3>=i+a?(j=3,k=3-i-a-l):(j=5,k=5-i-a-l)):6==h?"O"==f?c>=1?(j=3,k=3-i-a):(j=2,k=2-i-a-l):"S"==f||"Se"==f||"Po"==f?1==c?3>=a?(j=3,k=3-i-a):(j=5,k=5-i-a):2>=a+i+l?(j=2,k=2-i-a-l):4>=a+i+l?(j=4,k=4-i-a-l):(j=6,k=6-i-a-l):"Te"==f&&(-1==c?2>=a&&(j=2,k=2-i-a-l):(0==c||2==c)&&(2>=a?(j=2,k=2-i-a-l):4>=a?(j=4,k=4-i-a-l):0==c&&6>=a?(j=6,k=6-i-a-l):k=-1)):7==h&&("F"==f?(j=1,k=1-i-a-l):("Cl"==f||"Br"==f||"I"==f||"At"==f)&&(1==c?2>=a?(j=2,k=2-i-a):(3==a||5==a||a>=7)&&(k=-1):0==c&&(1>=a?(j=1,k=1-i-a):2==a||4==a||6==a?1==i?(j=a,k=0):k=-1:a>7&&(k=-1)))),this.valence=j,this.implicitH=k,!(this.implicitH<0)||(this.valence=a,this.implicitH=0,this.badConn=!0,!1)},e.Struct.Atom.prototype.calcValenceMinusHyd=function(a){var b=this,c=b.charge,f=b.label,g=d.getElementByLabel(f);if(null==g)throw new Error("Element "+f+" unknown");if(0>g)return this.implicitH=0,null;var h=d.get(g).group,i=e.Struct.radicalElectrons(b.radical);if(3==h){if(("B"==f||"Al"==f||"Ga"==f||"In"==f)&&-1==c&&4>=i+a)return i+a}else if(5==h){if("N"==f||"P"==f){if(1==c)return i+a;if(2==c)return i+a}else if("Sb"==f||"Bi"==f||"As"==f){if(1==c)return i+a;if(2==c)return i+a}}else if(6==h){if("O"==f){if(c>=1)return i+a}else if(("S"==f||"Se"==f||"Po"==f)&&1==c)return i+a}else if(7==h&&("Cl"==f||"Br"==f||"I"==f||"At"==f)&&1==c)return i+a;return i+a+Math.abs(c)},e.Struct.prototype.calcImplicitHydrogen=function(a){var b=this.calcConn(a),c=this.atoms.get(a);if(c.badConn=!1,0>b||c.isQuery())return void(c.implicitH=0);if(c.explicitValence>=0){var e=d.getElementByLabel(c.label);c.implicitH=0,null!=e&&(c.implicitH=c.explicitValence-c.calcValenceMinusHyd(b),c.implicitH<0&&(c.implicitH=0,c.badConn=!0))}else c.calcValence(b)},e.Struct.prototype.setImplicitHydrogen=function(a){var b=function(a){this.calcImplicitHydrogen(a)};c.isNullOrUndefined(a)?this.atoms.each(b,this):c.each(a,b,this)}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../util":39,"./element":10,"./struct":16}],18:[function(a,b,c){(function(c){function d(a){var b=m.standalone||a,c=b?new n.SmilesSaver:new n.MolfileSaver,d=c.saveMolecule(m.ctab,!0);return b?d:p.server.smiles.sync({moldata:d})}function e(){var a=new n.MolfileSaver;return a.saveMolecule(m.ctab,!0)}function f(a){Object.isString(a)&&m.loadMolecule(a)}function g(a){Object.isString(a)&&m.loadFragment(a)}function h(a,b,c){var d=k.extend({bondLength:75,showSelectionRegions:!1,showBondIds:!1,showHalfBondIds:!1,showLoopIds:!1,showAtomIds:!1,autoScale:!1,autoScaleMargin:4,hideImplicitHydrogen:!1},c),e=new o.Render(a,d.bondLength,d);if(b){var f=n.Molfile.parseCTFile(b);e.setMolecule(f)}return e.update(),e}function i(a){k.assert(a),m.render.addStructChangeHandler(a)}var j=a("query-string"),k=a("./util"),l=a("./api.js");a("./ui"),a("./chem"),a("./rnd");var m=c.ui,n=c.chem,o=c.rnd;window.onload=function(){var a=j.parse(document.location.search);a.api_path&&(p.api_path=a.api_path),p.server=l(p.api_path),m.init(k.extend({},a),p.server)};var p=b.exports={version:"2.0.0",api_path:"",build_date:"2017-03-05 15-42-33",build_number:null,build_options:"__BUILD_NUMBER__",getSmiles:d,getMolfile:e,setMolecule:f,addFragment:g,showMolfile:h,onStructChange:i}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./api.js":7,"./chem":11,"./rnd":21,"./ui":34,"./util":39,"query-string":4}],19:[function(a,b,c){(function(c){var d="undefined"!=typeof window?window.Raphael:"undefined"!=typeof c?c.Raphael:null,e=a("./util/vec2");d.el.translateAbs=function(a,b){this.delta=this.delta||new e,this.delta.x+=a-0,this.delta.y+=b-0,this.transform("t"+this.delta.x.toString()+","+this.delta.y.toString())},d.st.translateAbs=function(a,b){this.forEach(function(c){c.translateAbs(a,b)})},b.exports=d}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./util/vec2":43}],20:[function(a,b,c){(function(b){function c(a,b){return b.type==j.Struct.BOND.TYPE.SINGLE&&a.stereo==j.Struct.BOND.STEREO.NONE&&b.stereo!=j.Struct.BOND.STEREO.NONE&&k.ctab.atoms.get(a.begin).neighbors.length<k.ctab.atoms.get(a.end).neighbors.length}var d=a("../util/set"),e=a("../util/vec2"),f=a("../ui/action"),g=a("../chem/element");a("../util");a("../chem"),a("./restruct"),a("../ui");var i=b.rnd=b.rnd||{},j=b.chem=b.chem||{},k=b.ui;i.Editor=function(a){this.render=a,this._selectionHelper=new i.Editor.SelectionHelper(this)},i.Editor.prototype.selectAll=function(){var a={};for(var b in i.ReStruct.maps)a[b]=k.render.ctab[b].ikeys();this._selectionHelper.setSelection(a)},i.Editor.prototype.deselectAll=function(){this._selectionHelper.setSelection()},i.Editor.prototype.hasSelection=function(a){if("selection"in this._selectionHelper)for(var b in this._selectionHelper.selection)if(this._selectionHelper.selection[b].length>0&&(!a||"sgroupData"!==b))return!0;return!1},i.Editor.prototype.getSelection=function(a){var b={};if("selection"in this._selectionHelper)for(var c in this._selectionHelper.selection)b[c]=this._selectionHelper.selection[c].slice(0);if(a){var d=this.render.ctab.molecule;"bonds"in b&&b.bonds.each(function(a){var c=d.bonds.get(a);b.atoms=b.atoms||[],b.atoms.indexOf(c.begin)<0&&b.atoms.push(c.begin),b.atoms.indexOf(c.end)<0&&b.atoms.push(c.end)},this),"atoms"in b&&"bonds"in b&&d.bonds.each(function(a){if(!("bonds"in b)||b.bonds.indexOf(a)<0){var c=d.bonds.get(a);b.atoms.indexOf(c.begin)>=0&&b.atoms.indexOf(c.end)>=0&&(b.bonds=b.bonds||[],b.bonds.push(a))}},this)}return b},i.Editor.prototype.getSelectionStruct=function(){console.assert(k.ctab==this.render.ctab.molecule,"Another ctab");var a=k.ctab,b=this.getSelection(!0),c=a.clone(d.fromList(b.atoms),d.fromList(b.bonds),!0);return a.rxnArrows.each(function(a,d){-1!=b.rxnArrows.indexOf(a)&&c.rxnArrows.add(d.clone())}),a.rxnPluses.each(function(a,d){-1!=b.rxnPluses.indexOf(a)&&c.rxnPluses.add(d.clone())}),c.isReaction=a.isReaction&&(c.rxnArrows.count()||c.rxnPluses.count()),c},i.Editor.SelectionHelper=function(a){this.editor=a},i.Editor.SelectionHelper.prototype.setSelection=function(a,b){if(!("selection"in this&&b)){this.selection={};for(var c in i.ReStruct.maps)this.selection[c]=[]}if(a&&"id"in a&&"map"in a&&(a[a.map]=a[a.map]||[]).push(a.id),a)for(var d in this.selection)if(d in a)for(var e=0;e<a[d].length;e++)this.selection[d].indexOf(a[d][e])<0&&this.selection[d].push(a[d][e]);this.editor.render.setSelection(this.selection),this.editor.render.update(),k.updateClipboardButtons()},i.Editor.SelectionHelper.prototype.isSelected=function(a){var b=this.editor.render,c=b.ctab;if("frags"==a.map||"rgroups"==a.map){var e="frags"==a.map?c.frags.get(a.id).fragGetAtoms(b,a.id):c.rgroups.get(a.id).getAtoms(b);return!Object.isUndefined(this.selection.atoms)&&d.subset(d.fromList(e),d.fromList(this.selection.atoms))}return"selection"in this&&!Object.isUndefined(this.selection[a.map])&&this.selection[a.map].indexOf(a.id)>-1},i.Editor.EditorTool=function(a){this.editor=a},i.Editor.EditorTool.prototype.processEvent=function(a,b,c){if("touches"in b&&1!=b.touches.length){if("lastEvent"in this.OnMouseDown0)return this.OnMouseUp0(b,c)}else{if(a+"0"in this)return this[a+"0"](b,c);if(a in this)return this[a](b,c);console.log("EditorTool.dispatchEvent: event '"+a+"' is not handled.")}},i.Editor.EditorTool.prototype.OnMouseDown=function(){},i.Editor.EditorTool.prototype.OnMouseMove=function(){},i.Editor.EditorTool.prototype.OnMouseUp=function(){},i.Editor.EditorTool.prototype.OnClick=function(){},i.Editor.EditorTool.prototype.OnDblClick=function(){},i.Editor.EditorTool.prototype.OnMouseLeave=function(){this.OnCancel()},i.Editor.EditorTool.prototype.OnKeyPress=function(){},i.Editor.EditorTool.prototype.OnCancel=function(){},i.Editor.EditorTool.prototype.OnMouseDown0=function(a){return!!k.hideBlurredControls()||(this.OnMouseDown0.lastEvent=a,this.OnMouseMove0.lastEvent=a,"OnMouseDown"in this?this.OnMouseDown(a):void 0)},i.Editor.EditorTool.prototype.OnMouseMove0=function(a){return this.OnMouseMove0.lastEvent=a,"OnMouseMove"in this?this.OnMouseMove(a):void 0},i.Editor.EditorTool.prototype.OnMouseUp0=function(a){if(!("lastEvent"in this.OnMouseDown0))return!0;"lastEvent"in this.OnMouseMove0&&(a=Object.clone(a),a.pageX=this.OnMouseMove0.lastEvent.pageX,a.pageY=this.OnMouseMove0.lastEvent.pageY);try{if("OnMouseUp"in this)return this.OnMouseUp(a)}finally{delete this.OnMouseDown0.lastEvent}},i.Editor.EditorTool.atom_label_map={atom_tool_any:"A",atom_tool_h:"H",atom_tool_c:"C",atom_tool_n:"N",atom_tool_o:"O",atom_tool_s:"S",atom_tool_p:"P",atom_tool_f:"F",atom_tool_br:"Br",atom_tool_cl:"Cl",atom_tool_i:"I"},i.Editor.EditorTool.prototype.OnKeyPress0=function(a,b){if("rgroup_tool_label"===b&&"lastEvent"in this.OnMouseMove0)return i.Editor.RGroupAtomTool.prototype.OnMouseUp.call(this,this.OnMouseMove0.lastEvent);if(b in i.Editor.EditorTool.atom_label_map){var c=i.Editor.EditorTool.atom_label_map[b],d=this.editor.getSelection();if(d&&"atoms"in d&&d.atoms.length>0)return k.addUndoAction(f.fromAtomsAttrs(d.atoms,{label:c},!0),!0),k.render.update(),!0;var e=this.editor.render.findItem(this.OnMouseMove0.lastEvent);if(e)return e.label={label:c},"atoms"===e.map?k.addUndoAction(f.fromAtomsAttrs(e.id,e.label,!0),!0):-1==e.id&&k.addUndoAction(f.fromAtomAddition(k.page2obj(this.OnMouseMove0.lastEvent),e.label),!0),k.render.update(),!0}return"OnKeyPress"in this&&this.OnKeyPress(a)},i.Editor.EditorTool.prototype._calcAngle=function(a,b){var c=e.diff(b,a),d=Math.atan2(c.y,c.x),f=0>d?-1:1,g=Math.floor(Math.abs(d)/(Math.PI/12))*(Math.PI/12);return d=f*(g+(Math.abs(d)-g<Math.PI/24?0:Math.PI/12))},i.Editor.EditorTool.prototype._calcNewAtomPos=function(a,b){var c=new e(1,0).rotate(this._calcAngle(a,b));return c.add_(a),c},i.Editor.EditorTool.HoverHelper=function(a){this.editorTool=a},i.Editor.EditorTool.HoverHelper.prototype.hover=function(a){a&&"Canvas"==a.type&&(a=null),"ci"in this&&(!a||this.ci.type!=a.type||this.ci.id!=a.id)&&(this.editorTool.editor.render.highlightObject(this.ci,!1),delete this.ci),a&&this.editorTool.editor.render.highlightObject(a,!0)&&(this.ci=a)},i.Editor.LassoTool=function(a,b,c){this.editor=a,this._hoverHelper=new i.Editor.EditorTool.HoverHelper(this),this._lassoHelper=new i.Editor.LassoTool.LassoHelper(b||0,a,c),this._sGroupHelper=new i.Editor.SGroupTool.SGroupHelper(a)},i.Editor.LassoTool.prototype=new i.Editor.EditorTool,i.Editor.LassoTool.prototype.OnMouseDown=function(a){var b=this.editor.render,c=b.ctab,d=c.molecule;this._hoverHelper.hover(null);var e=this._lassoHelper.fragment||a.ctrlKey,f=this.editor.render.findItem(a,e?["frags","sgroups","sgroupData","rgroups","rxnArrows","rxnPluses","chiralFlags"]:["atoms","bonds","sgroups","sgroupData","rgroups","rxnArrows","rxnPluses","chiralFlags"]);if(f&&"Canvas"!=f.type){if(this._hoverHelper.hover(null),"onShowLoupe"in this.editor.render&&this.editor.render.onShowLoupe(!0),!this.editor._selectionHelper.isSelected(f))if("frags"==f.map){var g=c.frags.get(f.id);this.editor._selectionHelper.setSelection({atoms:g.fragGetAtoms(b,f.id),bonds:g.fragGetBonds(b,f.id)},a.shiftKey)}else if("sgroups"==f.map){var h=c.sgroups.get(f.id).item;this.editor._selectionHelper.setSelection({atoms:j.SGroup.getAtoms(d,h),bonds:j.SGroup.getBonds(d,h)},a.shiftKey)}else if("rgroups"==f.map){var i=c.rgroups.get(f.id);this.editor._selectionHelper.setSelection({atoms:i.getAtoms(b),bonds:i.getBonds(b)},a.shiftKey)}else this.editor._selectionHelper.setSelection(f,a.shiftKey);if(this.dragCtx={item:f,xy0:k.page2obj(a)},"atoms"==f.map&&!k.is_touch){var l=this;this.dragCtx.timeout=setTimeout(function(){delete l.dragCtx,l.editor._selectionHelper.setSelection(null),k.showLabelEditor(f.id)},750),this.dragCtx.stopTapping=function(){"timeout"in l.dragCtx&&(clearTimeout(l.dragCtx.timeout),delete l.dragCtx.timeout)}}}else this._lassoHelper.fragment||this._lassoHelper.begin(a);return!0},i.Editor.LassoTool.prototype.OnMouseMove=function(a){if("dragCtx"in this){if("stopTapping"in this.dragCtx&&this.dragCtx.stopTapping(),this.dragCtx.action&&(this.dragCtx.action.perform(),this.editor.render.update()),this.dragCtx.action=f.fromMultipleMove(this.editor.getSelection(!0),k.page2obj(a).sub(this.dragCtx.xy0)),["atoms"].indexOf(this.dragCtx.item.map)>=0){var b=this.editor.render.findItem(a,[this.dragCtx.item.map],this.dragCtx.item);this._hoverHelper.hover(b.map==this.dragCtx.item.map?b:null)}this.editor.render.update()}else this._lassoHelper.running()?this.editor._selectionHelper.setSelection(this._lassoHelper.addPoint(a),a.shiftKey):this._hoverHelper.hover(this.editor.render.findItem(a,this._lassoHelper.fragment||a.ctrlKey?["frags","sgroups","sgroupData","rgroups","rxnArrows","rxnPluses","chiralFlags"]:["atoms","bonds","sgroups","sgroupData","rgroups","rxnArrows","rxnPluses","chiralFlags"]));return!0},i.Editor.LassoTool.prototype.OnMouseUp=function(a){if("dragCtx"in this){if("stopTapping"in this.dragCtx&&this.dragCtx.stopTapping(),["atoms"].indexOf(this.dragCtx.item.map)>=0){var b=this.editor.render.findItem(a,[this.dragCtx.item.map],this.dragCtx.item);b.map==this.dragCtx.item.map&&(this._hoverHelper.hover(null),this.editor._selectionHelper.setSelection(),this.dragCtx.action=this.dragCtx.action?f.fromAtomMerge(this.dragCtx.item.id,b.id).mergeWith(this.dragCtx.action):f.fromAtomMerge(this.dragCtx.item.id,b.id))}k.addUndoAction(this.dragCtx.action,!0),this.editor.render.update(),delete this.dragCtx}else this._lassoHelper.running()?this.editor._selectionHelper.setSelection(this._lassoHelper.end(),a.shiftKey):this._lassoHelper.fragment&&this.editor._selectionHelper.setSelection();return!0},i.Editor.LassoTool.prototype.OnDblClick=function(a){var b=this.editor.render.findItem(a);if("atoms"==b.map){this.editor._selectionHelper.setSelection(b);var c=k.ctab.atoms.get(b.id);"R#"==c.label?i.Editor.RGroupAtomTool.prototype.OnMouseUp.call(this,a):"L#"==c.label?k.showElemTable({selection:c,onOk:function(a){return c.label==a.label&&c.atomList.equals(a.atomList)||(k.addUndoAction(f.fromAtomsAttrs(b.id,a)),k.render.update()),!0}.bind(this)}):(g.getElementByLabel(c.label)||121)<120?k.showAtomProperties(b.id):k.showReaGenericsTable({values:[c.label],onOk:function(a){var d=a.values[0];return c.label!=d&&(k.addUndoAction(f.fromAtomsAttrs(b.id,{label:d})),k.render.update()),!0}.bind(this)})}else"bonds"==b.map?(this.editor._selectionHelper.setSelection(b),k.showBondProperties(b.id)):"sgroups"==b.map&&(this.editor._selectionHelper.setSelection(b),this._sGroupHelper.showPropertiesDialog(b.id));return!0},i.Editor.LassoTool.prototype.OnCancel=function(){"dragCtx"in this?("stopTapping"in this.dragCtx&&this.dragCtx.stopTapping(),k.addUndoAction(this.dragCtx.action,!0),this.editor.render.update(),delete this.dragCtx):this._lassoHelper.running()&&this.editor._selectionHelper.setSelection(this._lassoHelper.end()),this._hoverHelper.hover(null)},i.Editor.LassoTool.LassoHelper=function(a,b,c){this.mode=a,this.fragment=c,this.editor=b},i.Editor.LassoTool.LassoHelper.prototype.getSelection=function(){if(0==this.mode)return k.render.getElementsInPolygon(this.points);if(1==this.mode)return k.render.getElementsInRectangle(this.points[0],this.points[1]);throw new Error("Selector mode unknown")},i.Editor.LassoTool.LassoHelper.prototype.begin=function(a){this.points=[k.page2obj(a)],1==this.mode&&this.points.push(this.points[0])},i.Editor.LassoTool.LassoHelper.prototype.running=function(){return"points"in this},i.Editor.LassoTool.LassoHelper.prototype.addPoint=function(a){return!!this.running()&&(0==this.mode?(this.points.push(k.page2obj(a)),this.editor.render.drawSelectionPolygon(this.points)):1==this.mode&&(this.points=[this.points[0],k.page2obj(a)],this.editor.render.drawSelectionRectangle(this.points[0],this.points[1])),this.getSelection())},i.Editor.LassoTool.LassoHelper.prototype.end=function(){var a=this.getSelection();return"points"in this&&(this.editor.render.drawSelectionPolygon(null),delete this.points),a},i.Editor.EraserTool=function(a,b){this.editor=a,this.maps=["atoms","bonds","rxnArrows","rxnPluses","sgroups","sgroupData","chiralFlags"],this._hoverHelper=new i.Editor.EditorTool.HoverHelper(this),this._lassoHelper=new i.Editor.LassoTool.LassoHelper(b||0,a)},i.Editor.EraserTool.prototype=new i.Editor.EditorTool,i.Editor.EraserTool.prototype.OnMouseDown=function(a){var b=this.editor.render.findItem(a,this.maps);b&&"Canvas"!=b.type||this._lassoHelper.begin(a)},i.Editor.EraserTool.prototype.OnMouseMove=function(a){this._lassoHelper.running()?this.editor._selectionHelper.setSelection(this._lassoHelper.addPoint(a)):this._hoverHelper.hover(this.editor.render.findItem(a,this.maps))},i.Editor.EraserTool.prototype.OnMouseUp=function(a){if(this._lassoHelper.running())k.addUndoAction(f.fromFragmentDeletion(this._lassoHelper.end(a))),this.editor.deselectAll(),k.render.update();else{var b=this.editor.render.findItem(a,this.maps);if(b&&"Canvas"!=b.type){if(this._hoverHelper.hover(null),"atoms"==b.map)k.addUndoAction(f.fromAtomDeletion(b.id));else if("bonds"==b.map)k.addUndoAction(f.fromBondDeletion(b.id));else if("sgroups"==b.map||"sgroupData"==b.map)k.addUndoAction(f.fromSgroupDeletion(b.id));else if("rxnArrows"==b.map)k.addUndoAction(f.fromArrowDeletion(b.id));else if("rxnPluses"==b.map)k.addUndoAction(f.fromPlusDeletion(b.id));else{if("chiralFlags"!=b.map)return void console.log("EraserTool: unable to delete the object "+b.map+"["+b.id+"]");k.addUndoAction(f.fromChiralFlagDeletion())}this.editor.deselectAll(),k.render.update()}}},i.Editor.AtomTool=function(a,b){this.editor=a,this.atomProps=b,this.bondProps={type:1,stereo:j.Struct.BOND.STEREO.NONE},this._hoverHelper=new i.Editor.EditorTool.HoverHelper(this)},i.Editor.AtomTool.prototype=new i.Editor.EditorTool,i.Editor.AtomTool.prototype.OnMouseDown=function(a){this._hoverHelper.hover(null);var b=this.editor.render.findItem(a,["atoms"]);b&&"Canvas"!=b.type?"atoms"==b.map&&(this.dragCtx={item:b,xy0:k.page2obj(a)}):this.dragCtx={xy0:k.page2obj(a)
}},i.Editor.AtomTool.prototype.OnMouseMove=function(a){var b=this.editor,c=b.render;if("dragCtx"in this&&"item"in this.dragCtx){var d=this.dragCtx,e=this._calcNewAtomPos(c.atomGetPos(d.item.id),k.page2obj(a));"action"in d&&d.action.perform();var g=f.fromBondAddition(this.bondProps,d.item.id,Object.clone(this.atomProps),e,e);d.action=g[0],d.aid2=g[2],c.update()}else this._hoverHelper.hover(c.findItem(a,["atoms"]))},i.Editor.AtomTool.prototype.OnMouseUp=function(a){if("dragCtx"in this){var b=this.dragCtx;k.addUndoAction("action"in b?b.action:"item"in b?f.fromAtomsAttrs(b.item.id,this.atomProps,!0):f.fromAtomAddition(k.page2obj(a),this.atomProps),!0),this.editor.render.update(),delete this.dragCtx}},i.Editor.BondTool=function(a,b){this.editor=a,this.atomProps={label:"C"},this.bondProps=b,this.plainBondTypes=[j.Struct.BOND.TYPE.SINGLE,j.Struct.BOND.TYPE.DOUBLE,j.Struct.BOND.TYPE.TRIPLE],this._hoverHelper=new i.Editor.EditorTool.HoverHelper(this)},i.Editor.BondTool.prototype=new i.Editor.EditorTool,i.Editor.BondTool.prototype.OnMouseDown=function(a){return this._hoverHelper.hover(null),this.dragCtx={xy0:k.page2obj(a),item:this.editor.render.findItem(a,["atoms","bonds"])},this.dragCtx.item&&"Canvas"!=this.dragCtx.item.type||delete this.dragCtx.item,!0},i.Editor.BondTool.prototype.OnMouseMove=function(a){var b=this.editor,c=b.render;if("dragCtx"in this){var d=this.dragCtx;if(!("item"in d)||"atoms"==d.item.map){"action"in d&&d.action.perform();var g,h,i,j;"item"in d&&"atoms"==d.item.map?(g=d.item.id,h=c.findItem(a,["atoms"],d.item)):(g=this.atomProps,i=d.xy0,h=c.findItem(a,["atoms"]));var l=Number.MAX_VALUE;if(h&&"atoms"==h.map)h=h.id;else{h=this.atomProps;var m=k.page2obj(a);l=e.dist(d.xy0,m),i?j=this._calcNewAtomPos(i,m):i=this._calcNewAtomPos(c.atomGetPos(g),m)}return l>.3?d.action=f.fromBondAddition(this.bondProps,g,h,i,j)[0]:delete d.action,c.update(),!0}}return this._hoverHelper.hover(c.findItem(a,["atoms","bonds"])),!0},i.Editor.BondTool.prototype.OnMouseUp=function(a){if("dragCtx"in this){var b=this.dragCtx;if("action"in b)k.addUndoAction(b.action);else if("item"in b){if("atoms"==b.item.map)k.addUndoAction(f.fromBondAddition(this.bondProps,b.item.id)[0]);else if("bonds"==b.item.map){var d=Object.clone(this.bondProps),g=k.ctab.bonds.get(b.item.id);if(d.stereo!=j.Struct.BOND.STEREO.NONE&&g.type==j.Struct.BOND.TYPE.SINGLE&&d.type==j.Struct.BOND.TYPE.SINGLE&&g.stereo==d.stereo)k.addUndoAction(f.fromBondFlipping(b.item.id));else{if(d.type===j.Struct.BOND.TYPE.SINGLE&&g.stereo===j.Struct.BOND.STEREO.NONE&&d.stereo===j.Struct.BOND.STEREO.NONE){var h=this.plainBondTypes.indexOf(d.type)>=0?this.plainBondTypes:null;h&&(d.type=h[(h.indexOf(g.type)+1)%h.length])}k.addUndoAction(f.fromBondAttrs(b.item.id,d,c(g,d)),!0)}}}else{var i=k.page2obj(a),l=new e(.5,0).rotate(this.bondProps.type==j.Struct.BOND.TYPE.SINGLE?-Math.PI/6:0),m=f.fromBondAddition(this.bondProps,{label:"C"},{label:"C"},{x:i.x-l.x,y:i.y-l.y},{x:i.x+l.x,y:i.y+l.y});k.addUndoAction(m[0])}this.editor.render.update(),delete this.dragCtx}return!0},i.Editor.ChainTool=function(a){this.editor=a,this._hoverHelper=new i.Editor.EditorTool.HoverHelper(this)},i.Editor.ChainTool.prototype=new i.Editor.EditorTool,i.Editor.ChainTool.prototype.OnMouseDown=function(a){return this._hoverHelper.hover(null),this.dragCtx={xy0:k.page2obj(a),item:this.editor.render.findItem(a,["atoms"])},this.dragCtx.item&&"Canvas"!=this.dragCtx.item.type||delete this.dragCtx.item,!0},i.Editor.ChainTool.prototype.OnMouseMove=function(a){var b=this.editor,c=b.render;if("dragCtx"in this){var d=this.dragCtx;"action"in d&&d.action.perform();var g="item"in d?c.atomGetPos(d.item.id):d.xy0,h=k.page2obj(a);return d.action=f.fromChain(g,this._calcAngle(g,h),Math.ceil(e.diff(h,g).length()),"item"in d?d.item.id:null),c.update(),!0}return this._hoverHelper.hover(c.findItem(a,["atoms"])),!0},i.Editor.ChainTool.prototype.OnMouseUp=function(){return"dragCtx"in this&&("action"in this.dragCtx&&k.addUndoAction(this.dragCtx.action),delete this.dragCtx),!0},i.Editor.ChainTool.prototype.OnCancel=function(){this.OnMouseUp()},i.Editor.TemplateTool=function(a,b){if(this.editor=a,this.template=b,!this.template.molecule){var c=j.Molfile.parseCTFile(this.template.molfile);c.rescale();var d=new e;c.atoms.each(function(a,b){d.add_(b.pp)}),this.template.molecule=c,this.template.xy0=d.scaled(1/c.atoms.count()),this.template.angle0=this._calcAngle(c.atoms.get(this.template.aid).pp,this.template.xy0);var f=c.bonds.get(this.template.bid);this.template.sign=this._getSign(c,f,this.template.xy0)}this._hoverHelper=new i.Editor.EditorTool.HoverHelper(this)},i.Editor.TemplateTool.prototype=new i.Editor.EditorTool,i.Editor.TemplateTool.prototype._getSign=function(a,b,c){var d=a.atoms.get(b.begin).pp,f=a.atoms.get(b.end).pp,g=e.cross(e.diff(d,f),e.diff(c,f));return g>0?1:0>g?-1:0},i.Editor.TemplateTool.prototype.OnMouseDown=function(a){var b=this.editor,c=b.render;this._hoverHelper.hover(null),this.dragCtx={xy0:k.page2obj(a),item:c.findItem(a,["atoms","bonds"])};var f=this.dragCtx,g=f.item;if(g&&"Canvas"!=g.type){if("bonds"==g.map){var h=c.ctab.molecule,i=new e,j=h.bonds.get(g.id),l=c.atomGetAttr(j.begin,"fragment"),m=h.getFragmentIds(l),n=0,o=h.halfBonds.get(j.hb1).loop;if(0>o&&(o=h.halfBonds.get(j.hb2).loop),o>=0){var p=h.loops.get(o).hbs;p.each(function(a){i.add_(h.atoms.get(h.halfBonds.get(a).begin).pp),n++})}else d.each(m,function(a){i.add_(h.atoms.get(a).pp),n++});f.v0=i.scaled(1/n);var q=this._getSign(h,j,f.v0);f.sign1=q||1,f.sign2=this.template.sign}}else delete f.item;return!0},i.Editor.TemplateTool.prototype.OnMouseMove=function(a){var b=this.editor,c=b.render;if("dragCtx"in this){var d,g,h,i=this.dragCtx,j=i.item,l=k.page2obj(a);if(i.mouse_moved=!0,j&&"Canvas"!=j.type){if("atoms"==j.map)d=c.atomGetPos(j.id),h=e.dist(d,l)>1;else if("bonds"==j.map){var m=c.ctab.molecule,n=m.bonds.get(j.id),o=this._getSign(m,n,l);return i.sign1*this.template.sign>0&&(o=-o),o==i.sign2&&i.action||("action"in i&&i.action.perform(),i.sign2=o,i.action=f.fromTemplateOnBond(j.id,this.template,this._calcAngle,i.sign1*i.sign2>0),c.update()),!0}}else d=i.xy0;g=this._calcAngle(d,l);var p=Math.round(180/Math.PI*g);if("angle"in i&&i.angle==p){if(!("extra_bond"in i))return!0;if(i.extra_bond==h)return!0}return"action"in i&&i.action.perform(),i.angle=p,j&&"Canvas"!=j.type?"atoms"==j.map&&(i.action=f.fromTemplateOnAtom(j.id,g,h,this.template,this._calcAngle),i.extra_bond=h):i.action=f.fromTemplateOnCanvas(d,g,this.template),c.update(),!0}return this._hoverHelper.hover(c.findItem(a,["atoms","bonds"])),!0},i.Editor.TemplateTool.prototype.OnMouseUp=function(){var a=this.editor,b=a.render;if("dragCtx"in this){var c=this.dragCtx,d=c.item;if(!c.action){if(d&&"Canvas"!=d.type)if("atoms"==d.map){var e=b.atomGetDegree(d.id);if(e>1)c.action=f.fromTemplateOnAtom(d.id,null,!0,this.template,this._calcAngle);else if(1==e){var g=b.ctab.molecule,h=g.halfBonds.get(g.atoms.get(d.id).neighbors[0]).end,i=g.atoms.get(d.id),j=g.atoms.get(h);c.action=f.fromTemplateOnAtom(d.id,this._calcAngle(j.pp,i.pp),!1,this.template,this._calcAngle)}else c.action=f.fromTemplateOnAtom(d.id,0,!1,this.template,this._calcAngle)}else"bonds"==d.map&&(c.action=f.fromTemplateOnBond(d.id,this.template,this._calcAngle,c.sign1*c.sign2>0));else c.action=f.fromTemplateOnCanvas(c.xy0,0,this.template);b.update()}"action"in this.dragCtx&&(this.dragCtx.action.isDummy()||k.addUndoAction(this.dragCtx.action)),delete this.dragCtx}},i.Editor.TemplateTool.prototype.OnCancel=function(){this.OnMouseUp()},i.Editor.ChargeTool=function(a,b){this.editor=a,this.charge=b,this._hoverHelper=new i.Editor.EditorTool.HoverHelper(this)},i.Editor.ChargeTool.prototype=new i.Editor.EditorTool,i.Editor.ChargeTool.prototype.OnMouseMove=function(a){var b=this.editor.render.findItem(a,["atoms"]);return b&&"atoms"==b.map&&null!=g.getElementByLabel(k.ctab.atoms.get(b.id).label)?this._hoverHelper.hover(b):this._hoverHelper.hover(null),!0},i.Editor.ChargeTool.prototype.OnMouseUp=function(a){var b=this.editor,c=b.render,d=c.findItem(a,["atoms"]);return d&&"atoms"==d.map&&null!=g.getElementByLabel(k.ctab.atoms.get(d.id).label)&&(this._hoverHelper.hover(null),k.addUndoAction(f.fromAtomsAttrs(d.id,{charge:c.ctab.molecule.atoms.get(d.id).charge+this.charge})),c.update()),!0},i.Editor.RGroupAtomTool=function(a){this.editor=a,this._hoverHelper=new i.Editor.EditorTool.HoverHelper(this)},i.Editor.RGroupAtomTool.prototype=new i.Editor.EditorTool,i.Editor.RGroupAtomTool.prototype.OnMouseMove=function(a){this._hoverHelper.hover(this.editor.render.findItem(a,["atoms"]))},i.Editor.RGroupAtomTool.prototype.OnMouseUp=function(a){function b(a){for(var b=[],c=0;32>c;c++)if(a&1<<c){var d="R"+(c+1);b.push(d)}return b}function c(a){var b=0;return a.values.forEach(function(a){var c=a.substr(1)-1;b|=1<<c}),b}var d=this.editor.render.findItem(a,["atoms"]);if(!d||"Canvas"==d.type)return this._hoverHelper.hover(null),k.showRGroupTable({mode:"multiple",onOk:function(a){a=c(a),a&&(k.addUndoAction(f.fromAtomAddition(k.page2obj(this.OnMouseMove0.lastEvent),{label:"R#",rglabel:a}),!0),k.render.update())}.bind(this)}),!0;if(d&&"atoms"==d.map){this._hoverHelper.hover(null);var e=this.editor.render.ctab.molecule.atoms.get(d.id),g=e.label,h=e.rglabel;return k.showRGroupTable({mode:"multiple",values:b(h),onOk:function(a){if(a=c(a),h!=a||"R#"!=g){var b=Object.clone(j.Struct.Atom.attrlist);a?(b.label="R#",b.rglabel=a,b.aam=e.aam):(b.label="C",b.aam=e.aam),k.addUndoAction(f.fromAtomsAttrs(d.id,b),!0),k.render.update()}}.bind(this)}),!0}},i.Editor.RGroupFragmentTool=function(a){this.editor=a,this._hoverHelper=new i.Editor.EditorTool.HoverHelper(this)},i.Editor.RGroupFragmentTool.prototype=new i.Editor.EditorTool,i.Editor.RGroupFragmentTool.prototype.OnMouseMove=function(a){this._hoverHelper.hover(this.editor.render.findItem(a,["frags","rgroups"]))},i.Editor.RGroupFragmentTool.prototype.OnMouseUp=function(a){var b=this.editor.render.findItem(a,["frags","rgroups"]);if(b&&"frags"==b.map){this._hoverHelper.hover(null);var c=j.Struct.RGroup.findRGroupByFragment(this.editor.render.ctab.molecule.rgroups,b.id);return k.showRGroupTable({values:c&&["R"+c],onOk:function(a){console.assert(a.values.length<=1,"Too much elements"),a=a.values.length?a.values[0].substr(1)-0:0,c!=a&&(k.addUndoAction(f.fromRGroupFragment(a,b.id),!0),k.render.update())}.bind(this)}),!0}if(b&&"rgroups"==b.map){this._hoverHelper.hover(null);var d=this.editor.render.ctab.molecule.rgroups.get(b.id),e=0;this.editor.render.ctab.molecule.rgroups.each(function(a){e|=1<<a-1});var g={occurrence:d.range,resth:d.resth,ifthen:d.ifthen};return k.showRLogicTable({rgid:b.id,rlogic:g,rgmask:e,onOk:function(a){var c={};if(g.occurrence!=a.occurrence){var d=a.occurrence.split(",").all(function(a){return a.match(/^[>,<,=]?[0-9]+$/g)||a.match(/^[0-9]+\-[0-9]+$/g)});if(!d)return alert("Bad occurrence value"),!1;c.range=a.occurrence}return g.resth!=a.resth&&(c.resth=a.resth),g.ifthen!=a.ifthen&&(c.ifthen=a.ifthen),("range"in c||"resth"in c||"ifthen"in c)&&(k.addUndoAction(f.fromRGroupAttrs(b.id,c)),this.editor.render.update()),!0}.bind(this)}),!0}},i.Editor.APointTool=function(a){this.editor=a,this._hoverHelper=new i.Editor.EditorTool.HoverHelper(this)},i.Editor.APointTool.prototype=new i.Editor.EditorTool,i.Editor.APointTool.prototype.OnMouseMove=function(a){this._hoverHelper.hover(this.editor.render.findItem(a,["atoms"]))},i.Editor.APointTool.prototype.OnMouseUp=function(a){var b=this.editor.render.findItem(a,["atoms"]);if(b&&"atoms"==b.map){this._hoverHelper.hover(null);var c=this.editor.render.ctab.molecule.atoms.get(b.id).attpnt;return k.showAtomAttachmentPoints({selection:c,onOk:function(a){c!=a&&(k.addUndoAction(f.fromAtomsAttrs(b.id,{attpnt:a}),!0),k.render.update())}.bind(this)}),!0}},i.Editor.ReactionArrowTool=function(a){this.editor=a,this._hoverHelper=new i.Editor.EditorTool.HoverHelper(this)},i.Editor.ReactionArrowTool.prototype=new i.Editor.EditorTool,i.Editor.ReactionArrowTool.prototype.OnMouseDown=function(a){var b=this.editor.render.findItem(a,["rxnArrows"]);b&&"rxnArrows"==b.map&&(this._hoverHelper.hover(null),this.editor._selectionHelper.setSelection(b),this.dragCtx={xy0:k.page2obj(a)})},i.Editor.ReactionArrowTool.prototype.OnMouseMove=function(a){"dragCtx"in this?(this.dragCtx.action&&this.dragCtx.action.perform(),this.dragCtx.action=f.fromMultipleMove(this.editor._selectionHelper.selection,k.page2obj(a).sub(this.dragCtx.xy0)),k.render.update()):this._hoverHelper.hover(this.editor.render.findItem(a,["rxnArrows"]))},i.Editor.ReactionArrowTool.prototype.OnMouseUp=function(a){"dragCtx"in this?(k.addUndoAction(this.dragCtx.action,!1),this.editor.render.update(),delete this.dragCtx):this.editor.render.ctab.molecule.rxnArrows.count()<1&&(k.addUndoAction(f.fromArrowAddition(k.page2obj(a))),this.editor.render.update())},i.Editor.ReactionPlusTool=function(a){this.editor=a,this._hoverHelper=new i.Editor.EditorTool.HoverHelper(this)},i.Editor.ReactionPlusTool.prototype=new i.Editor.EditorTool,i.Editor.ReactionPlusTool.prototype.OnMouseDown=function(a){var b=this.editor.render.findItem(a,["rxnPluses"]);b&&"rxnPluses"==b.map&&(this._hoverHelper.hover(null),this.editor._selectionHelper.setSelection(b),this.dragCtx={xy0:k.page2obj(a)})},i.Editor.ReactionPlusTool.prototype.OnMouseMove=function(a){"dragCtx"in this?(this.dragCtx.action&&this.dragCtx.action.perform(),this.dragCtx.action=f.fromMultipleMove(this.editor._selectionHelper.selection,k.page2obj(a).sub(this.dragCtx.xy0)),k.render.update()):this._hoverHelper.hover(this.editor.render.findItem(a,["rxnPluses"]))},i.Editor.ReactionPlusTool.prototype.OnMouseUp=function(a){"dragCtx"in this?(k.addUndoAction(this.dragCtx.action,!1),this.editor.render.update(),delete this.dragCtx):(k.addUndoAction(f.fromPlusAddition(k.page2obj(a))),this.editor.render.update())},i.Editor.ReactionMapTool=function(a){this.editor=a,this._hoverHelper=new i.Editor.EditorTool.HoverHelper(this),this.editor._selectionHelper.setSelection(null),this.rcs=j.MolfileSaver.getComponents(this.editor.render.ctab.molecule)},i.Editor.ReactionMapTool.prototype=new i.Editor.EditorTool,i.Editor.ReactionMapTool.prototype.OnMouseDown=function(a){var b=this.editor.render.findItem(a,["atoms"]);b&&"atoms"==b.map&&(this._hoverHelper.hover(null),this.dragCtx={item:b,xy0:k.page2obj(a)})},i.Editor.ReactionMapTool.prototype.OnMouseMove=function(a){var b=this.editor.render;if("dragCtx"in this){var c=b.findItem(a,["atoms"],this.dragCtx.item);c&&"atoms"==c.map&&this._isValidMap(this.dragCtx.item.id,c.id)?(this._hoverHelper.hover(c),b.drawSelectionLine(b.atomGetPos(this.dragCtx.item.id),b.atomGetPos(c.id))):(this._hoverHelper.hover(null),b.drawSelectionLine(b.atomGetPos(this.dragCtx.item.id),k.page2obj(a)))}else this._hoverHelper.hover(b.findItem(a,["atoms"]))},i.Editor.ReactionMapTool.prototype.OnMouseUp=function(a){if("dragCtx"in this){var b=this.editor.render,c=b.findItem(a,["atoms"],this.dragCtx.item);if(c&&"atoms"==c.map&&this._isValidMap(this.dragCtx.item.id,c.id)){var d=new f,e=b.ctab.molecule.atoms,g=e.get(this.dragCtx.item.id),h=e.get(c.id),i=g.aam,j=h.aam;if(!i||i!=j){if((i&&i!=j||!i&&j)&&e.each(function(a,b){a!=this.dragCtx.item.id&&(i&&b.aam==i||j&&b.aam==j)&&d.mergeWith(f.fromAtomsAttrs(a,{aam:0}))},this),i)d.mergeWith(f.fromAtomsAttrs(c.id,{aam:i}));else{var l=0;e.each(function(a,b){l=Math.max(l,b.aam||0)}),d.mergeWith(f.fromAtomsAttrs(this.dragCtx.item.id,{aam:l+1})),d.mergeWith(f.fromAtomsAttrs(c.id,{aam:l+1}))}k.addUndoAction(d,!0),b.update()}}b.drawSelectionLine(null),delete this.dragCtx}this._hoverHelper.hover(null)},i.Editor.ReactionMapTool.prototype._isValidMap=function(a,b){for(var c,e,f=0;(!c||!e)&&f<this.rcs.reactants.length;f++){var g=d.list(this.rcs.reactants[f]);!c&&g.indexOf(a)>=0&&(c="r"),!e&&g.indexOf(b)>=0&&(e="r")}for(var h=0;(!c||!e)&&h<this.rcs.products.length;h++){var i=d.list(this.rcs.products[h]);!c&&i.indexOf(a)>=0&&(c="p"),!e&&i.indexOf(b)>=0&&(e="p")}return c&&e&&c!=e},i.Editor.ReactionUnmapTool=function(a){this.editor=a,this._hoverHelper=new i.Editor.EditorTool.HoverHelper(this),this.editor._selectionHelper.setSelection(null)},i.Editor.ReactionUnmapTool.prototype=new i.Editor.EditorTool,i.Editor.ReactionUnmapTool.prototype.OnMouseMove=function(a){var b=this.editor.render.findItem(a,["atoms"]);b&&"atoms"==b.map?this._hoverHelper.hover(this.editor.render.ctab.molecule.atoms.get(b.id).aam?b:null):this._hoverHelper.hover(null)},i.Editor.ReactionUnmapTool.prototype.OnMouseUp=function(a){var b=this.editor.render.findItem(a,["atoms"]),c=this.editor.render.ctab.molecule.atoms;if(b&&"atoms"==b.map&&c.get(b.id).aam){var d=new f,e=c.get(b.id).aam;c.each(function(a,b){b.aam==e&&d.mergeWith(f.fromAtomsAttrs(a,{aam:0}))},this),k.addUndoAction(d,!0),this.editor.render.update()}this._hoverHelper.hover(null)},i.Editor.SGroupTool=function(a){this.editor=a,this.maps=["atoms","bonds","sgroups","sgroupData"],this._hoverHelper=new i.Editor.EditorTool.HoverHelper(this),this._lassoHelper=new i.Editor.LassoTool.LassoHelper(1,a),this._sGroupHelper=new i.Editor.SGroupTool.SGroupHelper(a);var b=this.editor.getSelection();b.atoms&&b.atoms.length>0?this._sGroupHelper.showPropertiesDialog(null,b):this.editor.deselectAll()},i.Editor.SGroupTool.prototype=new i.Editor.EditorTool,i.Editor.SGroupTool.prototype.OnMouseDown=function(a){var b=this.editor.render.findItem(a,this.maps);b&&"Canvas"!=b.type||this._lassoHelper.begin(a)},i.Editor.SGroupTool.prototype.OnMouseMove=function(a){this._lassoHelper.running()?this.editor._selectionHelper.setSelection(this._lassoHelper.addPoint(a)):this._hoverHelper.hover(this.editor.render.findItem(a,this.maps))},i.Editor.SGroupTool.SGroupHelper=function(a){this.editor=a,this.selection=null},i.Editor.SGroupTool.SGroupHelper.prototype.showPropertiesDialog=function(a,b){this.selection=b;var c=this.editor.render;if(null==a){var d={},e={};if(b.atoms.each(function(a){e[a]=!0},this),!Object.isUndefined(b.atoms.detect(function(a){var f=c.atomGetSGroups(a);return!Object.isUndefined(f.detect(function(a){if(a in d)return!1;var f=c.sGroupGetAtoms(a);if(f.length<b.atoms.length){if(!Object.isUndefined(f.detect(function(a){return!(a in e)},this)))return!0}else if(!Object.isUndefined(b.atoms.detect(function(a){return-1==f.indexOf(a)},this)))return!0;return!1},this))},this)))return void alert("Partial S-group overlapping is not allowed.")}k.showSGroupProperties({type:null!==a?k.render.sGroupGetType(a):null,attrs:null!==a?k.render.sGroupGetAttrs(a):{},onCancel:function(){this.editor.deselectAll()}.bind(this),onOk:function(b){null==a?(a=k.render.ctab.molecule.sgroups.newId(),k.addUndoAction(f.fromSgroupAddition(b.type,this.selection.atoms,b.attrs,a),!0)):k.addUndoAction(f.fromSgroupType(a,b.type).mergeWith(f.fromSgroupAttrs(a,b.attrs)),!0),this.editor.deselectAll(),this.editor.render.update()}.bind(this)})},i.Editor.SGroupTool.prototype.OnMouseUp=function(a){var b=null,c=null;if(this._lassoHelper.running())c=this._lassoHelper.end(a);else{var d=this.editor.render.findItem(a,this.maps);if(!d||"Canvas"==d.type)return;if(this._hoverHelper.hover(null),"atoms"==d.map)c={atoms:[d.id]};else if("bonds"==d.map){var e=this.editor.render.ctab.bonds.get(d.id);c={atoms:[e.b.begin,e.b.end]}}else{if("sgroups"!=d.map)return;b=d.id}}(null!=b||c&&c.atoms&&c.atoms.length>0)&&this._sGroupHelper.showPropertiesDialog(b,c)},i.Editor.PasteTool=function(a,b){this.editor=a,this.struct=b,this.action=f.fromPaste(this.struct,"lastEvent"in this.OnMouseMove0?k.page2obj(this.OnMouseMove0.lastEvent):void 0),this.editor.render.update()},i.Editor.PasteTool.prototype=new i.Editor.EditorTool,i.Editor.PasteTool.prototype.OnMouseMove=function(a){"action"in this&&this.action.perform(this.editor),this.action=f.fromPaste(this.struct,k.page2obj(a)),this.editor.render.update()},i.Editor.PasteTool.prototype.OnMouseUp=function(){k.addUndoAction(this.action),delete this.action,k.selectAction(null)},i.Editor.PasteTool.prototype.OnCancel=function(){"action"in this&&(this.action.perform(this.editor),delete this.action)},i.Editor.RotateTool=function(a){this.editor=a,this._lassoHelper=new i.Editor.LassoTool.LassoHelper(1,a);var b=this.editor._selectionHelper.selection;b.atoms&&b.atoms.length||this.editor._selectionHelper.setSelection(null)},i.Editor.RotateTool.prototype=new i.Editor.EditorTool,i.Editor.RotateTool.prototype.OnMouseDown=function(a){var b=this.editor._selectionHelper.selection;if(b.atoms&&b.atoms.length){var c=this.editor.render.ctab.molecule,d=new e;if(!b.atoms||!b.atoms.length)return!0;var f=null,g=!1;b.atoms.each(function(a){var e=c.atoms.get(a);d.add_(e.pp),g||e.neighbors.find(function(d){var e=c.halfBonds.get(d);if(-1==b.atoms.indexOf(e.end)){if(e.loop>=0){var h=c.atoms.get(a);if(!Object.isUndefined(h.neighbors.find(function(a){var d=c.halfBonds.get(a);return d.loop>=0&&-1!=b.atoms.indexOf(d.end)})))return g=!0,!0}if(null==f)f=a;else if(f!=a)return g=!0,!0}return!1})}),d=g||null==f?d.scaled(1/b.atoms.length):c.atoms.get(f).pp,this.dragCtx={xy0:d,angle1:this._calcAngle(d,k.page2obj(a)),all:g}}else this._lassoHelper.begin(a);return!0},i.Editor.RotateTool.prototype.OnMouseMove=function(a){if(this._lassoHelper.running())this.editor._selectionHelper.setSelection(this._lassoHelper.addPoint(a));else if("dragCtx"in this){var b=this.editor,c=b.render,d=this.dragCtx,e=k.page2obj(a),g=this._calcAngle(d.xy0,e)-d.angle1,h=Math.round(180*(g/Math.PI));if(h>180?h-=360:-180>=h&&(h+=360),"angle"in d&&d.angle==h)return!0;"action"in d&&d.action.perform(),d.angle=h,d.action=f.fromRotate(d.all?c.ctab.molecule:this.editor.getSelection(),d.xy0,g),$("toolText").update(h+"º"),c.update()}return!0},i.Editor.RotateTool.prototype.OnMouseUp=function(a){var b=null;return this._lassoHelper.running()?b=this._lassoHelper.end(a):"dragCtx"in this&&("action"in this.dragCtx?(k.addUndoAction(this.dragCtx.action,!0),$("toolText").update("")):this.editor._selectionHelper.setSelection(),delete this.dragCtx),!0},i.Editor.RotateTool.prototype.OnCancel=function(){"dragCtx"in this&&("action"in this.dragCtx&&(k.addUndoAction(this.dragCtx.action,!0),$("toolText").update("")),delete this.dragCtx)}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../chem":11,"../chem/element":10,"../ui":34,"../ui/action":26,"../util":39,"../util/set":42,"../util/vec2":43,"./restruct":23}],21:[function(a,b,c){(function(b){a("./visel"),a("./restruct"),a("./editor"),a("./render"),a("./restruct_rendering"),b.rnd=b.rnd||{}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./editor":20,"./render":22,"./restruct":23,"./restruct_rendering":24,"./visel":25}],22:[function(a,b,c){(function(b){var c=a("../raphael-ext.js"),d=a("../util/box2abs"),e=a("../util/set"),f=a("../util/vec2"),g=a("../util");a("./restruct"),a("../ui"),a("../chem"),a("./restruct_rendering");var h=b.rnd=b.rnd||{},i=b.chem=b.chem||{},j=b.ui,k=g.tfx;h.DEBUG=!1,h.logcnt=0,h.logmouse=!1,h.hl=!1;var l={mousemove:"mousemove",mousedown:"mousedown",mouseup:"mouseup"};h.logMethod=function(){},h.RenderDummy=function(a){this.clientArea=a=$(a),a.innerHTML="",this.paper=new c(a),this.paper.rect(0,0,100,100).attr({fill:"#0F0",stroke:"none"}),this.setMolecule=function(){},this.update=function(){}},h.RenderOptions=function(a){a=a||{},this.showSelectionRegions=a.showSelectionRegions||!1,this.showAtomIds=a.showAtomIds||!1,this.showBondIds=a.showBondIds||!1,this.showHalfBondIds=a.showHalfBondIds||!1,this.showLoopIds=a.showLoopIds||!1,this.hideChiralFlag=a.hideChiralFlag||!1,this.showValenceWarnings=!!Object.isUndefined(a.showValenceWarnings)||a.showValenceWarnings,this.autoScale=a.autoScale||!1,this.autoScaleMargin=a.autoScaleMargin||0,this.maxBondLength=a.maxBondLength||0,this.atomColoring=a.atomColoring||0,this.hideImplicitHydrogen=a.hideImplicitHydrogen||!1,this.hideTerminalLabels=a.hideTerminalLabels||!1,this.ignoreMouseEvents=a.ignoreMouseEvents||!1,this.selectionDistanceCoefficient=(a.selectionDistanceCoefficient||.4)-0},h.Render=function(a,b,e,k){this.opt=new h.RenderOptions(e),this.useOldZoom=Prototype.Browser.IE,this.scale=b||100,this.baseScale=this.scale,this.offset=new f,this.clientArea=a=$(a),a.innerHTML="",this.paper=new c(a),this.size=new f,this.viewSz=k||new f(a.clientWidth||100,a.clientHeight||100),this.bb=new d(new f,this.viewSz),this.dirty=!0,this.selectionRect=null,this.rxnArrow=null,this.rxnMode=!1,this.zoom=1,this.structChangeHandlers=[];var m=this,n=0,o=0,p=a;do n+=p.offsetTop||0,o+=p.offsetLeft||0,p=p.offsetParent;while(p);this.clientAreaPos=new f(o,n);var q=this;q.longTapFlag=!1,q.longTapTimeout=null,q.longTapTouchstart=null,q.setLongTapTimeout=function(a){q.longTapFlag=!1,q.longTapTouchstart=a,q.longTapTimeout=setTimeout(function(){q.longTapFlag=!0,q.longTapTimeout=null},500)},q.resetLongTapTimeout=function(a){clearTimeout(q.longTapTimeout),q.longTapTimeout=null,a&&(q.longTapTouchstart=null,q.longTapFlag=!1)},"hiddenPaths"in h.ReStruct.prototype&&a.observe("touchend",function(a){if(0==a.touches.length)for(;h.ReStruct.prototype.hiddenPaths.length>0;)h.ReStruct.prototype.hiddenPaths.pop().remove()}),this.opt.ignoreMouseEvents||(a.observe("selectstart",function(a){return g.stopEventPropagation(a),g.preventDefault(a)}),a.observe("touchstart",function(a){q.resetLongTapTimeout(!0),2==a.touches.length?(this._tui=this._tui||{},this._tui.center={pageX:(a.touches[0].pageX+a.touches[1].pageX)/2,pageY:(a.touches[0].pageY+a.touches[1].pageY)/2},j.setZoomStaticPointInit(j.page2obj(this._tui.center))):1==a.touches.length&&q.setLongTapTimeout(a)}),a.observe("touchmove",function(a){q.resetLongTapTimeout(!0),"_tui"in this&&2==a.touches.length&&(this._tui.center={pageX:(a.touches[0].pageX+a.touches[1].pageX)/2,pageY:(a.touches[0].pageY+a.touches[1].pageY)/2})}),a.observe("gesturestart",function(a){this._tui=this._tui||{},this._tui.scale0=j.render.zoom,a.preventDefault()}),a.observe("gesturechange",function(a){j.setZoomStaticPoint(this._tui.scale0*a.scale,j.page2canvas2(this._tui.center)),j.render.update(),a.preventDefault()}),a.observe("gestureend",function(a){delete this._tui,a.preventDefault()}),a.observe("onresize",function(){m.onResize()}),["Click","DblClick","MouseDown","MouseMove","MouseUp","MouseLeave"].each(function(b){var c=b.toLowerCase();c=l[c]||c,a.observe(c,function(d){if(!("MouseLeave"==b||j&&j.is_touch)){var e=a.cumulativeOffset();e=new f(e[0],e[1]);var h=new f(d.clientX,d.clientY).sub(e),i=new f(a.clientWidth,a.clientHeight);if(!(h.x>0&&h.y>0&&h.x<i.x&&h.y<i.y))return"MouseMove"==b&&j.render.current_tool.processEvent("OnMouseLeave",d),g.preventDefault(d)}return j.render.current_tool.processEvent("On"+b,d),"MouseUp"!=b&&g.stopEventPropagation(d),"touchstart"==c||"touchmove"==c&&2==d.touches.length?void 0:g.preventDefault(d)})},this)),this.ctab=new h.ReStruct(new i.Struct,this),this.settings=null,this.styles=null,this.onCanvasOffsetChanged=null,this.onCanvasSizeChanged=null},h.Render.prototype.addStructChangeHandler=function(a){if(a in this.structChangeHandlers)throw new Error("handler already present");this.structChangeHandlers.push(a)},h.Render.prototype.view2scaled=function(a,b){var c=j.scrollPos();return this.useOldZoom||(a=a.scaled(1/this.zoom),c=c.scaled(1/this.zoom)),a=b?a:a.add(c).sub(this.offset)},h.Render.prototype.scaled2view=function(a,b){return a=b?a:a.add(this.offset).sub(j.scrollPos().scaled(1/this.zoom)),this.useOldZoom||(a=a.scaled(this.zoom)),a},h.Render.prototype.scaled2obj=function(a){return a.scaled(1/this.settings.scaleFactor)},h.Render.prototype.obj2scaled=function(a){return a.scaled(this.settings.scaleFactor)},h.Render.prototype.view2obj=function(a,b){return this.scaled2obj(this.view2scaled(a,b))},h.Render.prototype.obj2view=function(a,b){return this.scaled2view(this.obj2scaled(a,b))},h.Render.prototype.findItem=function(a,b,c){var d=this.findClosestItem("ui"in window&&"page2obj"in j?new f(j.page2obj(a)):new f(a.pageX,a.pageY).sub(this.clientAreaPos),b,c);return"Atom"==d.type?d.map="atoms":"Bond"==d.type?d.map="bonds":"SGroup"==d.type?d.map="sgroups":"DataSGroupData"==d.type?d.map="sgroupData":"RxnArrow"==d.type?d.map="rxnArrows":"RxnPlus"==d.type?d.map="rxnPluses":"Fragment"==d.type?d.map="frags":"RGroup"==d.type?d.map="rgroups":"ChiralFlag"==d.type&&(d.map="chiralFlags"),d},h.Render.prototype.client2Obj=function(a){return new f(a).sub(this.offset)},h.Render.prototype.setMolecule=function(a,b){h.logMethod("setMolecule"),this.paper.clear(),this.ctab=new h.ReStruct(a,this,b),this.offset=null,this.size=null,this.bb=null,this.rxnMode=a.isReaction},h.Render.prototype.atomGetAttr=function(a,b){return h.logMethod("atomGetAttr"),this.ctab.molecule.atoms.get(a)[b]},h.Render.prototype.invalidateAtom=function(a,b){var c=this.ctab.atoms.get(a);this.ctab.markAtom(a,b?1:0);for(var d=this.ctab.molecule.halfBonds,e=0;e<c.a.neighbors.length;++e){var f=c.a.neighbors[e];if(d.has(f)){var g=d.get(f);this.ctab.markBond(g.bid,1),this.ctab.markAtom(g.end,0),b&&this.invalidateLoop(g.bid)}}},h.Render.prototype.invalidateLoop=function(a){var b=this.ctab.bonds.get(a),c=this.ctab.molecule.halfBonds.get(b.b.hb1).loop,d=this.ctab.molecule.halfBonds.get(b.b.hb2).loop;c>=0&&this.ctab.loopRemove(c),d>=0&&this.ctab.loopRemove(d)},h.Render.prototype.invalidateBond=function(a){var b=this.ctab.bonds.get(a);this.invalidateLoop(a),this.invalidateAtom(b.b.begin,0),this.invalidateAtom(b.b.end,0)},h.Render.prototype.invalidateItem=function(a,b,c){"atoms"==a?this.invalidateAtom(b,c):"bonds"==a?(this.invalidateBond(b),c>0&&this.invalidateLoop(b)):this.ctab.markItem(a,b,c)},h.Render.prototype.atomGetDegree=function(a){return h.logMethod("atomGetDegree"),this.ctab.atoms.get(a).a.neighbors.length},h.Render.prototype.isBondInRing=function(a){var b=this.ctab.bonds.get(a);return this.ctab.molecule.halfBonds.get(b.b.hb1).loop>=0||this.ctab.molecule.halfBonds.get(b.b.hb2).loop>=0},h.Render.prototype.atomGetNeighbors=function(a){for(var b=this.ctab.atoms.get(a),c=[],d=0;d<b.a.neighbors.length;++d){var e=this.ctab.molecule.halfBonds.get(b.a.neighbors[d]);c.push({aid:e.end-0,bid:e.bid-0})}return c},h.Render.prototype.atomGetSGroups=function(a){h.logMethod("atomGetSGroups");var b=this.ctab.atoms.get(a);return e.list(b.a.sgs)},h.Render.prototype.sGroupGetAttr=function(a,b){return h.logMethod("sGroupGetAttr"),this.ctab.sgroups.get(a).item.getAttr(b)},h.Render.prototype.sGroupGetAttrs=function(a){return h.logMethod("sGroupGetAttrs"),this.ctab.sgroups.get(a).item.getAttrs()},h.Render.prototype.sGroupGetAtoms=function(a){h.logMethod("sGroupGetAtoms");var b=this.ctab.sgroups.get(a).item;return i.SGroup.getAtoms(this.ctab.molecule,b)},h.Render.prototype.sGroupGetType=function(a){h.logMethod("sGroupGetType");var b=this.ctab.sgroups.get(a).item;return b.type},h.Render.prototype.sGroupsFindCrossBonds=function(){h.logMethod("sGroupsFindCrossBonds"),this.ctab.molecule.sGroupsRecalcCrossBonds()},h.Render.prototype.sGroupGetNeighborAtoms=function(a){h.logMethod("sGroupGetNeighborAtoms");var b=this.ctab.sgroups.get(a).item;return b.neiAtoms},h.Render.prototype.atomIsPlainCarbon=function(a){return h.logMethod("atomIsPlainCarbon"),this.ctab.atoms.get(a).a.isPlainCarbon()},h.Render.prototype.highlightObject=function(a,b){if(!(["atoms","bonds","rxnArrows","rxnPluses","chiralFlags","frags","rgroups","sgroups","sgroupData"].indexOf(a.map)>-1))return!1;var c=this.ctab[a.map].get(a.id);if(null==c)return!0;if("sgroups"==a.map&&"DAT"==c.item.type||"sgroupData"==a.map){var d=this.ctab.sgroups.get(a.id),e=this.ctab.sgroupData.get(a.id);null!=d&&d.setHighlight(b,this),null!=e&&e.setHighlight(b,this)}else c.setHighlight(b,this);return!0},h.Render.prototype.itemGetPos=function(a,b){return this.ctab.molecule[a].get(b).pp},h.Render.prototype.atomGetPos=function(a){return h.logMethod("atomGetPos"),this.itemGetPos("atoms",a)},h.Render.prototype.rxnArrowGetPos=function(a){return h.logMethod("rxnArrowGetPos"),this.itemGetPos("rxnArrows",a)},h.Render.prototype.rxnPlusGetPos=function(a){
return h.logMethod("rxnPlusGetPos"),this.itemGetPos("rxnPluses",a)},h.Render.prototype.getAdjacentBonds=function(a){for(var b=e.fromList(a),c=e.empty(),d=e.empty(),f=0;f<a.length;++f)for(var g=a[f],h=this.ctab.atoms.get(g),i=0;i<h.a.neighbors.length;++i){var j=h.a.neighbors[i],k=this.ctab.molecule.halfBonds.get(j),l=k.end,m=e.contains(b,l)?c:d;e.add(m,k.bid)}return{inner:c,cross:d}},h.Render.prototype.bondGetAttr=function(a,b){return h.logMethod("bondGetAttr"),this.ctab.bonds.get(a).b[b]},h.Render.prototype.setSelection=function(a){h.logMethod("setSelection");for(var b in h.ReStruct.maps)if(h.ReStruct.maps[b].isSelectable()){var c=a?a[b]?g.identityMap(a[b]):{}:null;this.ctab[b].each(function(a,b){var d=c?c[a]===a:b.selected;b.selected=d,this.ctab.showItemSelection(a,b,d)},this)}},h.Render.prototype.initStyles=function(){var a=this.settings;this.styles={},this.styles.lineattr={stroke:"#000","stroke-width":a.lineWidth,"stroke-linecap":"round","stroke-linejoin":"round"},this.styles.selectionStyle={fill:"#7f7",stroke:"none"},this.styles.selectionZoneStyle={fill:"#000",stroke:"none",opacity:0},this.styles.highlightStyle={stroke:"#0c0","stroke-width":.6*a.lineWidth},this.styles.sGroupHighlightStyle={stroke:"#9900ff","stroke-width":.6*a.lineWidth},this.styles.sgroupBracketStyle={stroke:"darkgray","stroke-width":.5*a.lineWidth},this.styles.atomSelectionPlateRadius=1.2*a.labelFontSize},h.Render.prototype.initSettings=function(){var a=this.settings={};a.delta=this.ctab.molecule.getCoordBoundingBox(),a.margin=.1,a.scaleFactor=this.scale,a.lineWidth=a.scaleFactor/20,a.bondShift=a.scaleFactor/6,a.bondSpace=a.scaleFactor/7,a.labelFontSize=Math.ceil(1.9*(a.scaleFactor/6)),a.subFontSize=Math.ceil(.7*a.labelFontSize),a.font='30px "Arial"',a.fontsz=this.settings.labelFontSize,a.fontszsub=this.settings.subFontSize,a.fontRLabel=1.2*this.settings.labelFontSize,a.fontRLogic=.7*this.settings.labelFontSize},h.Render.prototype.getStructCenter=function(a){var b=this.ctab.getVBoxObj(a);return f.lc2(b.p0,.5,b.p1,.5)},h.Render.prototype.onResize=function(){this.setViewSize(new f(this.clientArea.clientWidth,this.clientArea.clientHeight))},h.Render.prototype.setViewSize=function(a){this.viewSz=new f(a)},h.Render.prototype._setPaperSize=function(a){var b=this.zoom;this.paper.setSize(a.x*b,a.y*b),this.setViewBox(b)},h.Render.prototype.setPaperSize=function(a){h.logMethod("setPaperSize");var b=this.sz;this.sz=a,this._setPaperSize(a),this.onCanvasSizeChanged&&this.onCanvasSizeChanged(a,b)},h.Render.prototype.setOffset=function(a){h.logMethod("setOffset"),this.onCanvasOffsetChanged&&this.onCanvasOffsetChanged(a,this.offset),this.offset=a},h.Render.prototype.getElementPos=function(a){var b=0,c=0;if(a.offsetParent)do b+=a.offsetLeft,c+=a.offsetTop;while(a=a.offsetParent);return new f(b,c)},h.Render.prototype.drawSelectionLine=function(a,b){h.logMethod("drawSelectionLine"),this.selectionRect&&(this.selectionRect.remove(),this.selectionRect=null),a&&b&&(a=this.obj2scaled(a).add(this.offset),b=this.obj2scaled(b).add(this.offset),this.selectionRect=this.paper.path(h.ReStruct.makeStroke(a,b)).attr({stroke:"gray","stroke-width":"1px"}))},h.Render.prototype.drawSelectionRectangle=function(a,b){h.logMethod("drawSelectionRectangle"),this.selectionRect&&(this.selectionRect.remove(),this.selectionRect=null),a&&b&&(a=this.obj2scaled(a).add(this.offset),b=this.obj2scaled(b).add(this.offset),this.selectionRect=this.paper.rect(Math.min(a.x,b.x),Math.min(a.y,b.y),Math.abs(b.x-a.x),Math.abs(b.y-a.y)).attr({stroke:"gray","stroke-width":"1px"}))},h.Render.prototype.getElementsInRectangle=function(a,b){h.logMethod("getElementsInRectangle");var c=[],d=[],e=Math.min(a.x,b.x),g=Math.max(a.x,b.x),i=Math.min(a.y,b.y),j=Math.max(a.y,b.y);this.ctab.bonds.each(function(a,b){var d=f.lc2(this.ctab.atoms.get(b.b.begin).a.pp,.5,this.ctab.atoms.get(b.b.end).a.pp,.5);d.x>e&&d.x<g&&d.y>i&&d.y<j&&c.push(a)},this),this.ctab.atoms.each(function(a,b){b.a.pp.x>e&&b.a.pp.x<g&&b.a.pp.y>i&&b.a.pp.y<j&&d.push(a)},this);var k=[],l=[];this.ctab.rxnArrows.each(function(a,b){b.item.pp.x>e&&b.item.pp.x<g&&b.item.pp.y>i&&b.item.pp.y<j&&k.push(a)},this),this.ctab.rxnPluses.each(function(a,b){b.item.pp.x>e&&b.item.pp.x<g&&b.item.pp.y>i&&b.item.pp.y<j&&l.push(a)},this);var m=[];this.ctab.chiralFlags.each(function(a,b){b.pp.x>e&&b.pp.x<g&&b.pp.y>i&&b.pp.y<j&&m.push(a)},this);var n=[];return this.ctab.sgroupData.each(function(a,b){b.sgroup.pp.x>e&&b.sgroup.pp.x<g&&b.sgroup.pp.y>i&&b.sgroup.pp.y<j&&n.push(a)},this),{atoms:d,bonds:c,rxnArrows:k,rxnPluses:l,chiralFlags:m,sgroupData:n}},h.Render.prototype.drawSelectionPolygon=function(a){if(h.logMethod("drawSelectionPolygon"),this.selectionRect&&(this.selectionRect.remove(),this.selectionRect=null),a&&a.length>1){for(var b=this.obj2scaled(a[a.length-1]).add(this.offset),c="M"+k(b.x)+","+k(b.y),d=0;d<a.length;++d)b=this.obj2scaled(a[d]).add(this.offset),c+="L"+k(b.x)+","+k(b.y);this.selectionRect=this.paper.path(c).attr({stroke:"gray","stroke-width":"1px"})}},h.Render.prototype.isPointInPolygon=function(a,b){for(var c=new f(0,1),d=c.rotate(Math.PI/2),e=f.diff(a[a.length-1],b),g=f.dot(d,e),h=f.dot(c,e),i=null,j=0,k=1e-5,l=!1,m=!1,n=0;n<a.length;++n){var o=f.diff(a[n],b),p=f.diff(o,e),q=f.dot(d,o),r=f.dot(c,o);l=!1,0>q*g&&(r*h>-k?h>-k&&(l=!0):(Math.abs(g)*Math.abs(r)-Math.abs(q)*Math.abs(h))*r>0&&(l=!0)),l&&m&&f.dot(p,d)*f(i,d)>=0&&(l=!1),l&&j++,e=o,g=q,h=r,i=p,m=l}return 0!=j%2},h.Render.prototype.ps=function(a){return a.scaled(this.settings.scaleFactor)},h.Render.prototype.getElementsInPolygon=function(a){h.logMethod("getElementsInPolygon");for(var b=[],c=[],d=[],e=0;e<a.length;++e)d[e]=new f(a[e].x,a[e].y);this.ctab.bonds.each(function(a,c){var e=f.lc2(this.ctab.atoms.get(c.b.begin).a.pp,.5,this.ctab.atoms.get(c.b.end).a.pp,.5);this.isPointInPolygon(d,e)&&b.push(a)},this),this.ctab.atoms.each(function(a,b){this.isPointInPolygon(d,b.a.pp)&&c.push(a)},this);var g=[],i=[];this.ctab.rxnArrows.each(function(a,b){this.isPointInPolygon(d,b.item.pp)&&g.push(a)},this),this.ctab.rxnPluses.each(function(a,b){this.isPointInPolygon(d,b.item.pp)&&i.push(a)},this);var j=[];this.ctab.chiralFlags.each(function(a,b){this.isPointInPolygon(d,b.pp)&&j.push(a)},this);var k=[];return this.ctab.sgroupData.each(function(a,b){this.isPointInPolygon(d,b.sgroup.pp)&&k.push(a)},this),{atoms:c,bonds:b,rxnArrows:g,rxnPluses:i,chiralFlags:j,sgroupData:k}},h.Render.prototype.testPolygon=function(a){if(a=a||[{x:50,y:10},{x:20,y:90},{x:90,y:30},{x:10,y:30},{x:90,y:80}],!(a.length<3)){for(var b=a[0],c=a[0],d=1;d<a.length;++d)b=f.min(b,a[d]),c=f.max(c,a[d]);this.drawSelectionPolygon(a);for(var e=10,g=0;1e3>g;++g){var h=new f(Math.random()*e,Math.random()*e),i=this.isPointInPolygon(a,h),j=i?"#0f0":"#f00";this.paper.circle(h.x,h.y,2).attr({fill:j,stroke:"none"})}this.drawSelectionPolygon(a)}},h.Render.prototype.update=function(a){if(h.logMethod("update"),!this.settings||this.dirty){if(this.opt.autoScale){var b=this.ctab.molecule.getCoordBoundingBox(),c=b.max.y-b.min.y>0?.8*this.viewSz.y/(b.max.y-b.min.y):100,e=b.max.x-b.min.x>0?.8*this.viewSz.x/(b.max.x-b.min.x):100;this.scale=Math.min(c,e),this.opt.maxBondLength>0&&this.scale>this.opt.maxBondLength&&(this.scale=this.opt.maxBondLength)}this.initSettings(),this.initStyles(),this.dirty=!1,a=!0}var g=(new Date).getTime(),i=this.ctab.update(a);this.setSelection(null);var k=(new Date).getTime()-g;if(a&&$("log")&&($("log").innerHTML=k.toString()+"\n"),i){var l=this.settings.scaleFactor,m=this.ctab.getVBoxObj().transform(this.obj2scaled,this).translate(this.offset||new f);if(this.opt.autoScale){var n=m.sz(),o=this.opt.autoScaleMargin,p=new f(o,o),q=this.viewSz;if(q.x<2*o+1||q.y<2*o+1)throw new Error("View box too small for the given margin");var r=Math.max(n.x/(q.x-2*o),n.y/(q.y-2*o));this.opt.maxBondLength/r>1&&(r=1);var s=n.add(p.scaled(2*r));this.paper.setViewBox(m.pos().x-o*r-(q.x*r-s.x)/2,m.pos().y-o*r-(q.y*r-s.y)/2,q.x*r,q.y*r)}else{var t=f.UNIT.scaled(l),u=m.sz().length()>0?m.extend(t,t):m;console.assert(j.zoom==this.zoom);var v=new d(j.scrollPos(),this.viewSz.scaled(1/j.zoom).sub(f.UNIT.scaled(20))),w=d.union(v,u);this.oldCb||(this.oldCb=new d);var x=w.sz().floor(),y=this.oldCb.p0.sub(w.p0).ceil();this.oldBb=m,this.sz&&x.x==this.sz.x&&x.y==this.sz.y||this.setPaperSize(x),this.offset=this.offset||new f,(0!=y.x||0!=y.y)&&(this.setOffset(this.offset.add(y)),this.ctab.translate(y))}}},h.Render.prototype.checkBondExists=function(a,b){return this.ctab.molecule.checkBondExists(a,b)},h.Render.prototype.findClosestAtom=function(a,b,c){var d=null,e=this.opt.selectionDistanceCoefficient;return b=b||e,b=Math.min(b,e),this.ctab.atoms.each(function(e,g){if(e!=c){var h=f.dist(a,g.a.pp);b>h&&(d=e,b=h)}},this),null!=d?{id:d,dist:b}:null},h.Render.prototype.findClosestBond=function(a,b){var c=null,d=null,e=this.opt.selectionDistanceCoefficient;b=b||e,b=Math.min(b,e);var g=b;return this.ctab.bonds.each(function(b,c){var e=this.ctab.atoms.get(c.b.begin).a.pp,h=this.ctab.atoms.get(c.b.end).a.pp,i=f.lc2(e,.5,h,.5),j=f.dist(a,i);g>j&&(g=j,d=b)},this),this.ctab.bonds.each(function(d,e){var g=this.ctab.molecule.halfBonds.get(e.b.hb1),h=g.dir,i=g.norm,j=this.ctab.atoms.get(e.b.begin).a.pp,k=this.ctab.atoms.get(e.b.end).a.pp,l=f.dot(a.sub(j),h)*f.dot(a.sub(k),h)<0;if(l){var m=Math.abs(f.dot(a.sub(j),i));b>m&&(c=d,b=m)}},this),null!==c||null!==d?{id:c,dist:b,cid:d,cdist:g}:null},h.Render.prototype.findClosestItem=function(a,b,c){var d=null,e=function(a,b,c){null!=b&&(null==d||d.dist>b.dist||c)&&(d={type:a,id:b.id,dist:b.dist})};if(!b||b.indexOf("atoms")>=0){var f=this.findClosestAtom(a,void 0,Object.isUndefined(c)||"atoms"!=c.map?void 0:c.id);e("Atom",f)}if(!b||b.indexOf("bonds")>=0){var g=this.findClosestBond(a);g&&(null!==g.cid&&e("Bond",{id:g.cid,dist:g.cdist}),(null==d||d.dist>.4*this.scale)&&e("Bond",g))}if(!b||b.indexOf("chiralFlags")>=0){var i=h.ReChiralFlag.findClosest(this,a);e("ChiralFlag",i)}if(!b||b.indexOf("sgroupData")>=0){var j=h.ReDataSGroupData.findClosest(this,a);e("DataSGroupData",j)}if(!b||b.indexOf("sgroups")>=0){var k=h.ReSGroup.findClosest(this,a);e("SGroup",k)}if(!b||b.indexOf("rxnArrows")>=0){var l=h.ReRxnArrow.findClosest(this,a);e("RxnArrow",l)}if(!b||b.indexOf("rxnPluses")>=0){var m=h.ReRxnPlus.findClosest(this,a);e("RxnPlus",m)}if(!b||b.indexOf("frags")>=0){var n=h.ReFrag.findClosest(this,a,c&&"atoms"==c.map?c.id:void 0);e("Fragment",n)}if(!b||b.indexOf("rgroups")>=0){var o=h.ReRGroup.findClosest(this,a);e("RGroup",o)}return d=d||{type:"Canvas",id:-1}},h.Render.prototype.setZoom=function(a){this.zoom=a,this._setPaperSize(this.sz)},h.Render.prototype.extendCanvas=function(a,b,c,d){var e=0,g=0,h=0,i=0;a-=0,c-=0,b-=0,d-=0,0>a&&(e+=-a,h+=-a),0>b&&(g+=-b,i+=-b);var j=this.sz.x*this.zoom,k=this.sz.y*this.zoom;c>j&&(e+=c-j),d>k&&(g+=d-k);var l=new f(h,i).scaled(1/this.zoom);if(g>0||e>0){var m=new f(e,g).scaled(1/this.zoom),n=this.sz.add(m);this.setPaperSize(n),(l.x>0||l.y>0)&&(this.ctab.translate(l),this.setOffset(this.offset.add(l)))}return l},h.Render.prototype.setScale=function(a){this.offset&&(this.offset=this.offset.scaled(1/a).scaled(this.zoom)),this.scale=this.baseScale*this.zoom,this.settings=null,this.update(!0)},h.Render.prototype.setViewBox=function(a){this.useOldZoom?this.setScale(a):this.paper.canvas.setAttribute("viewBox","0 0 "+this.sz.x+" "+this.sz.y)}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../chem":11,"../raphael-ext.js":19,"../ui":34,"../util":39,"../util/box2abs":38,"../util/set":42,"../util/vec2":43,"./restruct":23,"./restruct_rendering":24}],23:[function(a,b,c){(function(b){var c=a("../util/box2abs"),d=a("../util/map"),e=a("../util/pool"),f=a("../util/set"),g=a("../util/vec2"),h=a("../util"),i=a("../chem/element");a("../chem");var j=b.rnd=b.rnd||{},k=b.chem,l=h.tfx;j.ReObject=function(){this.__ext=new g(.05*3,.05*3)},j.ReObject.prototype.init=function(a){this.visel=new j.Visel(a),this.highlight=!1,this.highlighting=null,this.selected=!1,this.selectionPlate=null},j.ReObject.prototype.getVBoxObj=function(a){var b=this.visel.boundingBox;return h.isNull(b)?null:(a.offset&&(b=b.translate(a.offset.negated())),b.transform(a.scaled2obj,a))},j.ReObject.prototype.drawHighlight=function(){console.log("ReObject.drawHighlight is not overridden")},j.ReObject.prototype.setHighlight=function(a,b){if(a){var c="highlighting"in this&&null!=this.highlighting;c&&(c="set"==this.highlighting.type?!this.highlighting[0].removed:!this.highlighting.removed),c=c&&(!("hiddenPaths"in j.ReStruct.prototype)||j.ReStruct.prototype.hiddenPaths.indexOf(this.highlighting)<0),c?this.highlighting.show():(b.paper.setStart(),this.drawHighlight(b),this.highlighting=b.paper.setFinish())}else this.highlighting&&this.highlighting.hide();this.highlight=a},j.ReObject.prototype.makeSelectionPlate=function(){console.log("ReObject.makeSelectionPlate is not overridden")},j.ReAtom=function(a){this.init(j.Visel.TYPE.ATOM),this.a=a,this.showLabel=!1,this.hydrogenOnTheLeft=!1,this.component=-1},j.ReAtom.prototype=new j.ReObject,j.ReAtom.isSelectable=function(){return!0},j.ReAtom.prototype.getVBoxObj=function(a){return this.visel.boundingBox?j.ReObject.prototype.getVBoxObj.call(this,a):new c(this.a.pp,this.a.pp)},j.ReAtom.prototype.drawHighlight=function(a){var b=this.makeHighlightPlate(a);return a.ctab.addReObjectPath("highlighting",this.visel,b),b},j.ReAtom.prototype.makeHighlightPlate=function(a){var b=a.paper,c=a.styles,d=a.ps(this.a.pp);return b.circle(d.x,d.y,c.atomSelectionPlateRadius).attr(c.highlightStyle)},j.ReAtom.prototype.makeSelectionPlate=function(a,b,c){var d=a.render.ps(this.a.pp);return b.circle(d.x,d.y,c.atomSelectionPlateRadius).attr(c.selectionStyle)},j.ReBond=function(a){this.init(j.Visel.TYPE.BOND),this.b=a,this.doubleBondShift=0},j.ReBond.prototype=new j.ReObject,j.ReBond.isSelectable=function(){return!0},j.ReBond.prototype.drawHighlight=function(a){var b=this.makeHighlightPlate(a);return a.ctab.addReObjectPath("highlighting",this.visel,b),b},j.ReBond.prototype.makeHighlightPlate=function(a){a.ctab.bondRecalc(a.settings,this);var b=a.ps(this.b.center);return a.paper.circle(b.x,b.y,.8*a.styles.atomSelectionPlateRadius).attr(a.styles.highlightStyle)},j.ReBond.prototype.makeSelectionPlate=function(a,b,c){a.bondRecalc(a.render.settings,this);var d=a.render.ps(this.b.center);return b.circle(d.x,d.y,.8*c.atomSelectionPlateRadius).attr(c.selectionStyle)},j.ReStruct=function(a,b,c){this.render=b,this.atoms=new d,this.bonds=new d,this.reloops=new d,this.rxnPluses=new d,this.rxnArrows=new d,this.frags=new d,this.rgroups=new d,this.sgroups=new d,this.sgroupData=new d,this.chiralFlags=new d,this.molecule=a||new k.Struct,this.initialized=!1,this.layers=[],this.initLayers(),this.connectedComponents=new e,this.ccFragmentType=new d;for(var f in j.ReStruct.maps)this[f+"Changed"]={};if(this.structChanged=!1,a.atoms.each(function(a,b){this.atoms.set(a,new j.ReAtom(b))},this),a.bonds.each(function(a,b){this.bonds.set(a,new j.ReBond(b))},this),a.loops.each(function(a,b){this.reloops.set(a,new j.ReLoop(b))},this),a.rxnPluses.each(function(a,b){this.rxnPluses.set(a,new j.ReRxnPlus(b))},this),a.rxnArrows.each(function(a,b){this.rxnArrows.set(a,new j.ReRxnArrow(b))},this),a.frags.each(function(a,b){this.frags.set(a,new j.ReFrag(b))},this),a.rgroups.each(function(a,b){this.rgroups.set(a,new j.ReRGroup(b))},this),a.sgroups.each(function(a,b){this.sgroups.set(a,new j.ReSGroup(b)),"DAT"!=b.type||b.data.attached||this.sgroupData.set(a,new j.ReDataSGroupData(b))},this),a.isChiral&&!this.render.opt.hideChiralFlag){var h=a.getCoordBoundingBox();this.chiralFlags.set(0,new j.ReChiralFlag(new g(h.max.x,h.min.y-1)))}this.coordProcess(c)},j.ReStruct.prototype.connectedComponentRemoveAtom=function(a,b){if(b=b||this.atoms.get(a),!(b.component<0)){var c=this.connectedComponents.get(b.component);f.remove(c,a),f.size(c)<1&&this.connectedComponents.remove(b.component),b.component=-1}},j.ReStruct.prototype.printConnectedComponents=function(){var a=[];this.connectedComponents.each(function(b,c){a.push(" "+b+":["+f.list(c).toString()+"]."+f.size(c).toString())},this),console.log(a.toString())},j.ReStruct.prototype.clearConnectedComponents=function(){this.connectedComponents.clear(),this.atoms.each(function(a,b){b.component=-1})},j.ReStruct.prototype.getConnectedComponent=function(a,b){for(var c="number"==typeof a.length?h.array(a):[a],d=f.empty();c.length>0;)!function(){var a=c.pop();f.add(d,a);var e=this.atoms.get(a);e.component>=0&&f.add(b,e.component);for(var g=0;g<e.a.neighbors.length;++g){var h=this.molecule.halfBonds.get(e.a.neighbors[g]).end;f.contains(d,h)||c.push(h)}}.apply(this);return d},j.ReStruct.prototype.addConnectedComponent=function(a){var b=this.connectedComponents.add(a),c=f.empty(),d=this.getConnectedComponent(f.list(a),c);f.remove(c,b);var e=-1;return f.each(d,function(a){var c=this.atoms.get(a);if(c.component=b,-1!=c.a.rxnFragmentType){if(-1!=e&&c.a.rxnFragmentType!=e)throw new Error("reaction fragment type mismatch");e=c.a.rxnFragmentType}},this),this.ccFragmentType.set(b,e),b},j.ReStruct.prototype.removeConnectedComponent=function(a){return f.each(this.connectedComponents.get(a),function(a){this.atoms.get(a).component=-1},this),this.connectedComponents.remove(a)},j.ReStruct.prototype.connectedComponentMergeIn=function(a,b){f.each(b,function(b){this.atoms.get(b).component=a},this),f.mergeIn(this.connectedComponents.get(a),b)},j.ReStruct.prototype.assignConnectedComponents=function(){this.atoms.each(function(a,b){if(!(b.component>=0)){var c=f.empty(),d=this.getConnectedComponent(a,c);f.each(c,function(a){this.removeConnectedComponent(a)},this),this.addConnectedComponent(d)}},this)},j.ReStruct.prototype.connectedComponentGetBoundingBox=function(a,b,c){return b=b||this.connectedComponents.get(a),c=c||{min:null,max:null},f.each(b,function(a){var b=this.render.ps(this.atoms.get(a).a.pp);null==c.min?c.min=c.max=b:(c.min=c.min.min(b),c.max=c.max.max(b))},this),c},j.ReStruct.prototype.initLayers=function(){for(var a in j.ReStruct.layerMap)this.layers[j.ReStruct.layerMap[a]]=this.render.paper.rect(0,0,10,10).attr({fill:"#000",opacity:"0.0"}).toFront()},j.ReStruct.prototype.insertInLayer=function(a,b){b.insertBefore(this.layers[a])},j.ReStruct.prototype.clearMarks=function(){for(var a in j.ReStruct.maps)this[a+"Changed"]={};this.structChanged=!1},j.ReStruct.prototype.markItemRemoved=function(){this.structChanged=!0},j.ReStruct.prototype.markBond=function(a,b){this.markItem("bonds",a,b)},j.ReStruct.prototype.markAtom=function(a,b){this.markItem("atoms",a,b)},j.ReStruct.prototype.markItem=function(a,b,c){var d=this[a+"Changed"];d[b]="undefined"!=typeof d[b]?Math.max(c,d[b]):c,this[a].has(b)&&this.clearVisel(this[a].get(b).visel)},j.ReStruct.prototype.eachVisel=function(a,b){for(var c in j.ReStruct.maps)this[c].each(function(c,d){a.call(b,d.visel)},this)},j.ReStruct.prototype.getVBoxObj=function(a){if(a=a||{},this.selectionIsEmpty(a))for(var b in j.ReStruct.maps)a[b]=this[b].keys();var d=null;for(var b in j.ReStruct.maps)a[b]&&h.each(a[b],function(a){var e=this[b].get(a).getVBoxObj(this.render);e&&(d=d?c.union(d,e):e.clone())},this);return d=d||new c(0,0,0,0)},j.ReStruct.prototype.selectionIsEmpty=function(a){if(h.assert(!h.isUndefined(a),"'selection' is not defined"),h.isNull(a))return!0;for(var b in j.ReStruct.maps)if(a[b]&&a[b].length>0)return!1;return!0},j.ReStruct.prototype.translate=function(a){this.eachVisel(function(b){b.translate(a)},this)},j.ReStruct.prototype.scale=function(a){this.eachVisel(function(b){this.scaleVisel(b,a)},this)},j.ReStruct.prototype.scaleRPath=function(a,b){if("set"==a.type)for(var c=0;c<a.length;++c)this.scaleRPath(a[c],b);else Object.isUndefined(a.attrs)||("font-size"in a.attrs?a.attr("font-size",a.attrs["font-size"]*b):"stroke-width"in a.attrs&&a.attr("stroke-width",a.attrs["stroke-width"]*b)),a.scale(b,b,0,0)},j.ReStruct.prototype.scaleVisel=function(a,b){for(var c=0;c<a.paths.length;++c)this.scaleRPath(a.paths[c],b)},j.ReStruct.prototype.clearVisels=function(){this.eachVisel(function(a){this.clearVisel(a)},this)},j.ReStruct.prototype.findIncomingStereoUpBond=function(a,b,c){return h.findIndex(a.neighbors,function(a){var d=this.molecule.halfBonds.get(a),e=d.bid;if(e===b)return!1;var f=this.bonds.get(e);return f.b.type===k.Struct.BOND.TYPE.SINGLE&&f.b.stereo===k.Struct.BOND.STEREO.UP?f.b.end===d.begin||f.boldStereo&&c:!(f.b.type!==k.Struct.BOND.TYPE.DOUBLE||f.b.stereo!==k.Struct.BOND.STEREO.NONE||!c||!f.boldStereo)},this)},j.ReStruct.prototype.checkStereoBold=function(a,b){var c=h.map([b.b.begin,b.b.end],function(b){var c=this.molecule.atoms.get(b),d=this.findIncomingStereoUpBond(c,a,!1);return 0>d?-1:c.neighbors[d]},this);h.assert(2===c.length),b.boldStereo=c[0]>=0&&c[1]>=0},j.ReStruct.prototype.findIncomingUpBonds=function(a,b){var c=h.map([b.b.begin,b.b.end],function(b){var c=this.molecule.atoms.get(b),d=this.findIncomingStereoUpBond(c,a,!0);return 0>d?-1:c.neighbors[d]},this);h.assert(2===c.length),b.neihbid1=this.atoms.get(b.b.begin).showLabel?-1:c[0],b.neihbid2=this.atoms.get(b.b.end).showLabel?-1:c[1]},j.ReStruct.prototype.checkStereoBoldBonds=function(){this.bonds.each(this.checkStereoBold,this)},j.ReStruct.prototype.update=function(a){a=a||!this.initialized;var b;a?function(){for(var a in j.ReStruct.maps){var b=this[a+"Changed"];this[a].each(function(a){b[a]=1},this)}}.call(this):function(){for(var a in j.ReStruct.maps){var c=this[a+"Changed"];for(b in c)this[a].has(b)||delete c[b]}}.call(this);for(b in this.atomsChanged)this.connectedComponentRemoveAtom(b);for(var c=this.frags.findAll(function(a,b){return!b.calcBBox(this.render,a)},this),e=0;e<c.length;++e){var f=c[e];this.clearVisel(this.frags.get(f).visel),this.frags.unset(f),this.molecule.frags.remove(f)}!function(){for(var a in j.ReStruct.maps){var c=this[a+"Changed"];for(b in c)this.clearVisel(this[a].get(b).visel),this.structChanged|=c[b]>0}}.call(this),this.structChanged&&h.each(this.render.structChangeHandlers,function(a){a.call()}),this.sgroups.each(function(a,b){this.clearVisel(b.visel),b.highlighting=null,b.selectionPlate=null},this),this.frags.each(function(a,b){this.clearVisel(b.visel)},this),this.rgroups.each(function(a,b){this.clearVisel(b.visel)},this),a&&(this.clearConnectedComponents(),this.molecule.initHalfBonds(),this.molecule.initNeighbors()),this.molecule.updateHalfBonds(new d(this.atomsChanged).findAll(function(a,b){return b>=0},this)),this.molecule.sortNeighbors(new d(this.atomsChanged).findAll(function(a,b){return b>=1},this)),this.assignConnectedComponents(),this.setImplicitHydrogen(),this.setHydrogenPos(),this.initialized=!0,this.verifyLoops();var g=a||this.structChanged;return g&&this.updateLoops(),this.setDoubleBondShift(),this.checkLabelsToShow(),this.checkStereoBoldBonds(),this.showLabels(),this.showBonds(),g&&this.renderLoops(),this.drawReactionSymbols(),this.drawSGroups(),this.drawFragments(),this.drawRGroups(),this.chiralFlags.each(function(a,b){this.chiralFlagsChanged[a]>0&&b.draw(this.render)},this),this.clearMarks(),!0},j.ReStruct.prototype.drawReactionSymbols=function(){var a,b;for(b in this.rxnArrowsChanged)a=this.rxnArrows.get(b),this.drawReactionArrow(b,a);for(b in this.rxnPlusesChanged)a=this.rxnPluses.get(b),this.drawReactionPlus(b,a)},j.ReStruct.prototype.drawReactionArrow=function(a,b){var d=this.render.ps(b.item.pp),e=this.drawArrow(new g(d.x-this.render.scale,d.y),new g(d.x+this.render.scale,d.y));b.visel.add(e,c.fromRelBox(j.relBox(e.getBBox())));var f=this.render.offset;null!=f&&e.translateAbs(f.x,f.y)},j.ReStruct.prototype.drawReactionPlus=function(a,b){var d=this.render.ps(b.item.pp),e=this.drawPlus(d);b.visel.add(e,c.fromRelBox(j.relBox(e.getBBox())));var f=this.render.offset;null!=f&&e.translateAbs(f.x,f.y)},j.ReStruct.prototype.drawSGroups=function(){h.each(this.molecule.sGroupForest.getSGroupsBFS().reverse(),function(a){var b=this.sgroups.get(a),c=b.draw(this.render);this.addReObjectPath("data",b.visel,c,null,!0),b.setHighlight(b.highlight,this.render)},this)},j.ReStruct.prototype.drawFragments=function(){this.frags.each(function(a,b){var c=b.draw(this.render,a);c&&this.addReObjectPath("data",b.visel,c,null,!0)},this)},j.ReStruct.prototype.drawRGroups=function(){this.rgroups.each(function(a,b){var c=b.draw(this.render);for(var d in c)for(;c[d].length>0;)this.addReObjectPath(d,b.visel,c[d].shift(),null,!0)},this)},j.ReStruct.prototype.eachCC=function(a,b,c){this.connectedComponents.each(function(d,e){b&&this.ccFragmentType.get(d)!=b||a.call(c||this,d,e)},this)},j.ReStruct.prototype.getGroupBB=function(a){var b={min:null,max:null};return this.eachCC(function(a,c){b=this.connectedComponentGetBoundingBox(a,c,b)},a,this),b},j.ReStruct.prototype.setHydrogenPos=function(){for(var a in this.atomsChanged){var b=this.atoms.get(a);if(0!=b.a.neighbors.length){for(var c=1,d=1,e=0,f=0,g=0;g<b.a.neighbors.length;++g){var h=this.molecule.halfBonds.get(b.a.neighbors[g]).dir;h.x<=0?(c=Math.min(c,Math.abs(h.y)),e++):(d=Math.min(d,Math.abs(h.y)),f++)}b.hydrogenOnTheLeft=.51>c||.51>d?c>d:f>e}else{var j=i.getElementByLabel(b.a.label);null!=j&&(b.hydrogenOnTheLeft=i.get(j).putHydrogenOnTheLeft)}}},j.ReStruct.prototype.setImplicitHydrogen=function(){this.molecule.setImplicitHydrogen(h.idList(this.atomsChanged))},j.ReLoop=function(a){this.loop=a,this.visel=new j.Visel(j.Visel.TYPE.LOOP),this.centre=new g,this.radius=new g},j.ReLoop.prototype=new j.ReObject,j.ReLoop.isSelectable=function(){return!1},j.ReStruct.prototype.coordProcess=function(a){a||this.molecule.rescale()},j.ReStruct.prototype.notifyAtomAdded=function(a){var b=new j.ReAtom(this.molecule.atoms.get(a));b.component=this.connectedComponents.add(f.single(a)),this.atoms.set(a,b),this.markAtom(a,1)},j.ReStruct.prototype.notifyRxnPlusAdded=function(a){this.rxnPluses.set(a,new j.ReRxnPlus(this.molecule.rxnPluses.get(a)))},j.ReStruct.prototype.notifyRxnArrowAdded=function(a){this.rxnArrows.set(a,new j.ReRxnArrow(this.molecule.rxnArrows.get(a)))},j.ReStruct.prototype.notifyRxnArrowRemoved=function(a){this.markItemRemoved(),this.clearVisel(this.rxnArrows.get(a).visel),this.rxnArrows.unset(a)},j.ReStruct.prototype.notifyRxnPlusRemoved=function(a){this.markItemRemoved(),this.clearVisel(this.rxnPluses.get(a).visel),this.rxnPluses.unset(a)},j.ReStruct.prototype.notifyBondAdded=function(a){this.bonds.set(a,new j.ReBond(this.molecule.bonds.get(a))),this.markBond(a,1)},j.ReStruct.prototype.notifyAtomRemoved=function(a){var b=this.atoms.get(a),c=this.connectedComponents.get(b.component);f.remove(c,a),0==f.size(c)&&this.connectedComponents.remove(b.component),this.clearVisel(b.visel),this.atoms.unset(a),this.markItemRemoved()},j.ReStruct.prototype.notifyBondRemoved=function(a){var b=this.bonds.get(a);[b.b.hb1,b.b.hb2].each(function(a){var b=this.molecule.halfBonds.get(a);b.loop>=0&&this.loopRemove(b.loop)},this),this.clearVisel(b.visel),this.bonds.unset(a),this.markItemRemoved()},j.ReStruct.prototype.loopRemove=function(a){if(this.reloops.has(a)){var b=this.reloops.get(a);this.clearVisel(b.visel);for(var c=[],d=0;d<b.loop.hbs.length;++d){var e=b.loop.hbs[d];if(this.molecule.halfBonds.has(e)){var f=this.molecule.halfBonds.get(e);f.loop=-1,this.markBond(f.bid,1),this.markAtom(f.begin,1),c.push(f.bid)}}this.reloops.unset(a),this.molecule.loops.remove(a)}},j.ReStruct.prototype.loopIsValid=function(a,b){var c=this.molecule.halfBonds,d=b.loop,e=!1;return d.hbs.each(function(b){c.has(b)&&c.get(b).loop===a||(e=!0)},this),!e},j.ReStruct.prototype.verifyLoops=function(){var a=[];this.reloops.each(function(b,c){this.loopIsValid(b,c)||a.push(b)},this);for(var b=0;b<a.length;++b)this.loopRemove(a[b])},j.ReStruct.prototype.BFS=function(a,b,c){b-=0;var d=new Array,e={};for(d.push(b),e[b]=1;d.length>0;){var f=d.shift();a.call(c,f);for(var g=this.atoms.get(f),h=0;h<g.a.neighbors.length;++h){var i=g.a.neighbors[h],j=this.molecule.halfBonds.get(i);e[j.end]||(e[j.end]=1,d.push(j.end))}}},j.ReRxnPlus=function(a){this.init(j.Visel.TYPE.PLUS),this.item=a},j.ReRxnPlus.prototype=new j.ReObject,j.ReRxnPlus.isSelectable=function(){return!0},j.ReRxnPlus.findClosest=function(a,b){var c,d;return a.ctab.rxnPluses.each(function(a,e){var f=e.item.pp,g=Math.max(Math.abs(b.x-f.x),Math.abs(b.y-f.y));.5>g&&(!d||c>g)&&(c=g,d={id:a,dist:c})}),d},j.ReRxnPlus.prototype.highlightPath=function(a){var b=a.ps(this.item.pp),c=a.settings.scaleFactor;return a.paper.rect(b.x-c/4,b.y-c/4,c/2,c/2,c/8)},j.ReRxnPlus.prototype.drawHighlight=function(a){var b=this.highlightPath(a).attr(a.styles.highlightStyle);return a.ctab.addReObjectPath("highlighting",this.visel,b),b},j.ReRxnPlus.prototype.makeSelectionPlate=function(a,b,c){return this.highlightPath(a.render).attr(c.selectionStyle)},j.ReRxnArrow=function(a){this.init(j.Visel.TYPE.ARROW),this.item=a},j.ReRxnArrow.prototype=new j.ReObject,j.ReRxnArrow.isSelectable=function(){return!0},j.ReRxnArrow.findClosest=function(a,b){var c,d;return a.ctab.rxnArrows.each(function(a,e){var f=e.item.pp;if(Math.abs(b.x-f.x)<1){var g=Math.abs(b.y-f.y);.3>g&&(!d||c>g)&&(c=g,d={id:a,dist:c})}}),d},j.ReRxnArrow.prototype.highlightPath=function(a){var b=a.ps(this.item.pp),c=a.settings.scaleFactor;return a.paper.rect(b.x-c,b.y-c/4,2*c,c/2,c/8)},j.ReRxnArrow.prototype.drawHighlight=function(a){var b=this.highlightPath(a).attr(a.styles.highlightStyle);return a.ctab.addReObjectPath("highlighting",this.visel,b),b},j.ReRxnArrow.prototype.makeSelectionPlate=function(a,b,c){return this.highlightPath(a.render).attr(c.selectionStyle)},j.ReFrag=function(a){this.init(j.Visel.TYPE.FRAGMENT),this.item=a},j.ReFrag.prototype=new j.ReObject,j.ReFrag.isSelectable=function(){return!1},j.ReFrag.findClosest=function(a,b,c,d){d=Math.min(d||a.opt.selectionDistanceCoefficient,a.opt.selectionDistanceCoefficient);var e;return a.ctab.frags.each(function(f,g){if(f!=c){var h=g.calcBBox(a,f);if(h.p0.y<b.y&&h.p1.y>b.y&&h.p0.x<b.x&&h.p1.x>b.x){var i=Math.min(Math.abs(h.p0.x-b.x),Math.abs(h.p1.x-b.x));(!e||d>i)&&(d=i,e={id:f,dist:d})}}}),e},j.ReFrag.prototype.fragGetAtoms=function(a,b){var c=[];return a.ctab.atoms.each(function(a,d){d.a.fragment==b&&c.push(a)},this),c},j.ReFrag.prototype.fragGetBonds=function(a,b){var c=[];return a.ctab.bonds.each(function(d,e){a.ctab.atoms.get(e.b.begin).a.fragment==b&&a.ctab.atoms.get(e.b.end).a.fragment==b&&c.push(d)},this),c},j.ReFrag.prototype.calcBBox=function(a,b){var d;return a.ctab.atoms.each(function(e,f){if(f.a.fragment==b){var h=f.visel.boundingBox;if(h)h=h.translate((a.offset||new g).negated()).transform(a.scaled2obj,a);else{h=new c(f.a.pp,f.a.pp);var i=new g(.05*3,.05*3);h=h.extend(i,i)}d=d?c.union(d,h):h}},this),d},j.ReFrag.prototype._draw=function(a,b,c){var d=this.calcBBox(a,b);if(d){var e=a.obj2scaled(new g(d.p0.x,d.p0.y)),f=a.obj2scaled(new g(d.p1.x,d.p1.y));return a.paper.rect(e.x,e.y,f.x-e.x,f.y-e.y,0).attr(c)}},j.ReFrag.prototype.draw=function(){return null},j.ReFrag.prototype.drawHighlight=function(){},j.ReFrag.prototype.setHighlight=function(a,b){var c=b.ctab.frags.keyOf(this);Object.isUndefined(c)||(b.ctab.atoms.each(function(d,e){e.a.fragment==c&&e.setHighlight(a,b)},this),b.ctab.bonds.each(function(d,e){b.ctab.atoms.get(e.b.begin).a.fragment==c&&e.setHighlight(a,b)},this))},j.ReRGroup=function(a){this.init(j.Visel.TYPE.RGROUP),this.labelBox=null,this.item=a},j.ReRGroup.prototype=new j.ReObject,j.ReRGroup.isSelectable=function(){return!1},j.ReRGroup.prototype.getAtoms=function(a){var b=[];return this.item.frags.each(function(c,d){b=b.concat(a.ctab.frags.get(d).fragGetAtoms(a,d))}),b},j.ReRGroup.prototype.getBonds=function(a){var b=[];return this.item.frags.each(function(c,d){b=b.concat(a.ctab.frags.get(d).fragGetBonds(a,d))}),b},j.ReRGroup.findClosest=function(a,b,c,d){d=Math.min(d||a.opt.selectionDistanceCoefficient,a.opt.selectionDistanceCoefficient);var e;return a.ctab.rgroups.each(function(a,f){if(a!=c&&f.labelBox&&f.labelBox.contains(b,.5)){var h=g.dist(f.labelBox.centre(),b);(!e||d>h)&&(d=h,e={id:a,dist:d})}}),e;
},j.ReRGroup.prototype.calcBBox=function(a){var b;return this.item.frags.each(function(d,e){var f=a.ctab.frags.get(e).calcBBox(a,e);f&&(b=b?c.union(b,f):f)}),b=b.extend(this.__ext,this.__ext)},j.ReRGroup.drawBrackets=function(a,b,c,d){d=d||new g(1,0);var e=Math.min(.25,.3*c.sz().x),f=c.p1.y-c.p0.y,h=.5*(c.p1.y+c.p0.y),i=k.SGroup.drawBracket(b,b.paper,b.styles,d.negated(),d.negated().rotateSC(1,0),new g(c.p0.x,h),e,f),j=k.SGroup.drawBracket(b,b.paper,b.styles,d,d.rotateSC(1,0),new g(c.p1.x,h),e,f);a.push(i,j)},j.ReRGroup.prototype.draw=function(a){var b=this.calcBBox(a),d=a.settings;if(b){var e={data:[]},f=a.obj2scaled(b.p0),g=a.obj2scaled(b.p1),h=a.paper.set();j.ReRGroup.drawBrackets(h,a,b),e.data.push(h);var i=a.ctab.rgroups.keyOf(this),k=a.paper.set(),l=a.paper.text(f.x,(f.y+g.y)/2,"R"+i+"=").attr({font:d.font,"font-size":d.fontRLabel,fill:"black"}),m=j.relBox(l.getBBox());l.translateAbs(-m.width/2-d.lineWidth,0),k.push(l);var n={font:d.font,"font-size":d.fontRLogic,fill:"black"},o=[];o.push((this.item.ifthen>0?"IF ":"")+"R"+i.toString()+(this.item.range.length>0?this.item.range.startsWith(">")||this.item.range.startsWith("<")||this.item.range.startsWith("=")?this.item.range:"="+this.item.range:">0")+(this.item.resth?" (RestH)":"")+(this.item.ifthen>0?"\nTHEN R"+this.item.ifthen.toString():""));for(var p=m.height/2+d.lineWidth/2,q=0;q<o.length;++q){var r=a.paper.text(f.x,(f.y+g.y)/2,o[q]).attr(n),s=j.relBox(r.getBBox());p+=s.height/2,r.translateAbs(-s.width/2-6*d.lineWidth,p),p+=s.height/2+d.lineWidth/2,e.data.push(r),k.push(r)}return e.data.push(l),this.labelBox=c.fromRelBox(k.getBBox()).transform(a.scaled2obj,a),e}return{}},j.ReRGroup.prototype._draw=function(a,b,c){var d=this.getVBoxObj(a).extend(this.__ext,this.__ext);if(d){var e=a.obj2scaled(d.p0),f=a.obj2scaled(d.p1);return a.paper.rect(e.x,e.y,f.x-e.x,f.y-e.y,0).attr(c)}},j.ReRGroup.prototype.drawHighlight=function(a){var b=a.ctab.rgroups.keyOf(this);if(!Object.isUndefined(b)){var c=this._draw(a,b,a.styles.highlightStyle);return a.ctab.addReObjectPath("highlighting",this.visel,c),this.item.frags.each(function(b,c){a.ctab.frags.get(c).drawHighlight(a)},this),c}},j.ReSGroup=function(a){this.init(j.Visel.TYPE.SGROUP),this.item=a},j.ReSGroup.prototype=new j.ReObject,j.ReSGroup.isSelectable=function(){return!1},j.ReSGroup.findClosest=function(a,b){var c=null,d=a.opt.selectionDistanceCoefficient;return a.ctab.molecule.sgroups.each(function(a,e){for(var f=e.bracketDir,h=f.rotateSC(1,0),i=new g(g.dot(b,f),g.dot(b,h)),j=0;j<e.areas.length;++j){var k=e.areas[j],l=k.p0.y<i.y&&k.p1.y>i.y&&k.p0.x<i.x&&k.p1.x>i.x,m=Math.min(Math.abs(k.p0.x-i.x),Math.abs(k.p1.x-i.x));l&&(null==c||d>m)&&(c=a,d=m)}},this),null!=c?{id:c,dist:d}:null},j.ReSGroup.prototype.draw=function(a){return this.item.draw(a.ctab)},j.ReSGroup.prototype.drawHighlight=function(a){var b=a.styles,c=a.settings,d=a.paper,e=this.item,f=e.bracketBox.transform(a.obj2scaled,a),h=c.lineWidth,i=new g(4*h,6*h);f=f.extend(i,i);var j=e.bracketDir,m=j.rotateSC(1,0),n=g.lc2(j,f.p0.x,m,f.p0.y),o=g.lc2(j,f.p0.x,m,f.p1.y),p=g.lc2(j,f.p1.x,m,f.p0.y),q=g.lc2(j,f.p1.x,m,f.p1.y),r=d.set();e.highlighting=d.path("M{0},{1}L{2},{3}L{4},{5}L{6},{7}L{0},{1}",l(n.x),l(n.y),l(o.x),l(o.y),l(q.x),l(q.y),l(p.x),l(p.y)).attr(b.highlightStyle),r.push(e.highlighting),k.SGroup.getAtoms(a.ctab.molecule,e).each(function(b){r.push(a.ctab.atoms.get(b).makeHighlightPlate(a))},this),k.SGroup.getBonds(a.ctab.molecule,e).each(function(b){r.push(a.ctab.bonds.get(b).makeHighlightPlate(a))},this),a.ctab.addReObjectPath("highlighting",this.visel,r)},j.ReDataSGroupData=function(a){this.init(j.Visel.TYPE.SGROUP_DATA),this.sgroup=a},j.ReDataSGroupData.prototype=new j.ReObject,j.ReDataSGroupData.isSelectable=function(){return!0},j.ReDataSGroupData.findClosest=function(a,b){var c=null,d=null;return a.ctab.sgroupData.each(function(a,e){if("DAT"!=e.sgroup.type)throw new Error("Data group expected");var f=e.sgroup.dataArea,g=f.p0.y<b.y&&f.p1.y>b.y&&f.p0.x<b.x&&f.p1.x>b.x,h=Math.min(Math.abs(f.p0.x-b.x),Math.abs(f.p1.x-b.x));g&&(null==d||c>h)&&(d={id:a,dist:h},c=h)}),d},j.ReDataSGroupData.prototype.highlightPath=function(a){var b=this.sgroup.dataArea,c=a.obj2scaled(b.p0),d=a.obj2scaled(b.p1).sub(c);return a.paper.rect(c.x,c.y,d.x,d.y)},j.ReDataSGroupData.prototype.drawHighlight=function(a){var b=this.highlightPath(a).attr(a.styles.highlightStyle);return a.ctab.addReObjectPath("highlighting",this.visel,b),b},j.ReDataSGroupData.prototype.makeSelectionPlate=function(a,b,c){return this.highlightPath(a.render).attr(c.selectionStyle)},j.ReChiralFlag=function(a){this.init(j.Visel.TYPE.CHIRAL_FLAG),this.pp=a},j.ReChiralFlag.prototype=new j.ReObject,j.ReChiralFlag.isSelectable=function(){return!0},j.ReChiralFlag.findClosest=function(a,b){var c,d;return a.ctab.chiralFlags.each(function(a,e){var f=e.pp;if(Math.abs(b.x-f.x)<1){var g=Math.abs(b.y-f.y);.3>g&&(!d||c>g)&&(c=g,d={id:a,dist:c})}}),d},j.ReChiralFlag.prototype.highlightPath=function(a){var b=c.fromRelBox(this.path.getBBox()),d=b.p1.sub(b.p0),e=b.p0.sub(a.offset);return a.paper.rect(e.x,e.y,d.x,d.y)},j.ReChiralFlag.prototype.drawHighlight=function(a){var b=this.highlightPath(a).attr(a.styles.highlightStyle);return a.ctab.addReObjectPath("highlighting",this.visel,b),b},j.ReChiralFlag.prototype.makeSelectionPlate=function(a,b,c){return this.highlightPath(a.render).attr(c.selectionStyle)},j.ReChiralFlag.prototype.draw=function(a){var b=a.paper,c=a.settings,d=a.ps(this.pp);this.path=b.text(d.x,d.y,"Chiral").attr({font:c.font,"font-size":c.fontsz,fill:"#000"}),a.ctab.addReObjectPath("data",this.visel,this.path,null,!0)},j.ReStruct.maps={atoms:j.ReAtom,bonds:j.ReBond,rxnPluses:j.ReRxnPlus,rxnArrows:j.ReRxnArrow,frags:j.ReFrag,rgroups:j.ReRGroup,sgroupData:j.ReDataSGroupData,chiralFlags:j.ReChiralFlag,sgroups:j.ReSGroup,reloops:j.ReLoop}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../chem":11,"../chem/element":10,"../util":39,"../util/box2abs":38,"../util/map":40,"../util/pool":41,"../util/set":42,"../util/vec2":43}],24:[function(a,b,c){(function(b){var c=a("../util/box2abs"),d=a("../util/vec2"),e=a("../util"),f=a("../chem/element");a("./restruct");var g=b.rnd=b.rnd||{},h=e.tfx;g.relBox=function(a){return{x:a.x,y:a.y,width:a.width,height:a.height}},g.ReStruct.prototype.drawArrow=function(a,b){var c=5,d=7,e=this.render.paper,f=this.render.styles;return e.path("M{0},{1}L{2},{3}L{4},{5}M{2},{3}L{4},{6}",h(a.x),h(a.y),h(b.x),h(b.y),h(b.x-d),h(b.y-c),h(b.y+c)).attr(f.lineattr)},g.ReStruct.prototype.drawPlus=function(a){var b=this.render.scale/5,c=this.render.paper,d=this.render.styles;return c.path("M{0},{4}L{0},{5}M{2},{1}L{3},{1}",h(a.x),h(a.y),h(a.x-b),h(a.x+b),h(a.y-b),h(a.y+b)).attr(d.lineattr)},g.ReStruct.prototype.drawBondSingle=function(a,b){var c=a.p,d=b.p,e=this.render.paper,f=this.render.styles;return e.path(g.ReStruct.makeStroke(c,d)).attr(f.lineattr)},g.ReStruct.prototype.drawBondSingleUp=function(a,b,c){var d=a.p,e=b.p,f=a.norm,g=this.render.settings,i=this.render.paper,j=this.render.styles,k=.7*g.bondSpace,l=e.addScaled(f,k),m=e.addScaled(f,-k);if(c.neihbid2>=0){var n=this.stereoUpBondGetCoordinates(b,c.neihbid2);l=n[0],m=n[1]}return i.path("M{0},{1}L{2},{3}L{4},{5}Z",h(d.x),h(d.y),h(l.x),h(l.y),h(m.x),h(m.y)).attr(j.lineattr).attr({fill:"#000"})},g.ReStruct.prototype.drawVec=function(a,b,c,d){var e=this.render.settings,f=this.render.paper,g=this.render.styles,i=e.bondSpace,j=a.addScaled(b,d||3*i);return f.path("M{0},{1}L{2},{3}",h(a.x),h(a.y),h(j.x),h(j.y)).attr(g.lineattr).attr({stroke:c||"#0F0"})},g.ReStruct.prototype.stereoUpBondGetCoordinates=function(a,b){var c=this.render.settings.bondSpace,e=this.molecule.halfBonds.get(b),f=d.dot(a.dir,e.dir),g=d.cross(a.dir,e.dir),h=Math.sqrt(.5*(1-f)),i=e.dir.rotateSC((g>=0?-1:1)*h,Math.sqrt(.5*(1+f))),j=.3,k=.7,l=a.p.addScaled(i,k*c/(h+j)),m=a.p.addScaled(i.negated(),k*c/(h+j));return g>0?[l,m]:[m,l]},g.ReStruct.prototype.drawBondSingleStereoBold=function(a,b,c,d){var e=this.render.paper,f=this.render.settings,g=this.render.styles,i=this.stereoUpBondGetCoordinates(a,c.neihbid1),j=this.stereoUpBondGetCoordinates(b,c.neihbid2),k=i[0],l=i[1],m=j[0],n=j[1],o=e.path("M{0},{1}L{2},{3}L{4},{5}L{6},{7}Z",h(k.x),h(k.y),h(l.x),h(l.y),h(m.x),h(m.y),h(n.x),h(n.y)).attr(g.lineattr).attr({stroke:"#000",fill:"#000"});if(d){var p=a.p,q=b.p,r=a.norm,s=c.doubleBondShift,t=1.5*f.bondSpace,u=p.addScaled(r,t*s),v=q.addScaled(r,t*s),w=!this.atoms.get(a.begin).showLabel,x=!this.atoms.get(b.begin).showLabel;return s>0?(w&&(u=u.addScaled(a.dir,t*this.getBondLineShift(a.rightCos,a.rightSin))),x&&(v=v.addScaled(a.dir,-t*this.getBondLineShift(b.leftCos,b.leftSin)))):0>s&&(w&&(u=u.addScaled(a.dir,t*this.getBondLineShift(a.leftCos,a.leftSin))),x&&(v=v.addScaled(a.dir,-t*this.getBondLineShift(b.rightCos,b.rightSin)))),e.set([o,e.path("M{0},{1}L{2},{3}",h(u.x),h(u.y),h(v.x),h(v.y)).attr(g.lineattr)])}return o},g.ReStruct.prototype.drawBondSingleDown=function(a,b){var c=a.p,d=b.p,e=a.norm,f=this.render.settings,h=this.render.paper,i=this.render.styles,j=.7*f.bondSpace,k=d.sub(c),l=k.length()+.2;k=k.normalized();for(var m,n,o=1.2*f.lineWidth,p=Math.max(Math.floor((l-f.lineWidth)/(f.lineWidth+o)),0)+2,q=l/(p-1),r="",s=c,t=0;p>t;++t)s=c.addScaled(k,q*t),m=s.addScaled(e,j*(t+.5)/(p-.5)),n=s.addScaled(e,-j*(t+.5)/(p-.5)),r+=g.ReStruct.makeStroke(m,n);return h.path(r).attr(i.lineattr)},g.ReStruct.prototype.drawBondSingleEither=function(a,b){var c=a.p,d=b.p,e=a.norm,f=this.render.settings,g=this.render.paper,i=this.render.styles,j=.7*f.bondSpace,k=d.sub(c),l=k.length();k=k.normalized();for(var m=.6*f.lineWidth,n=Math.max(Math.floor((l-f.lineWidth)/(f.lineWidth+m)),0)+2,o=l/(n-.5),p="M"+h(c.x)+","+h(c.y),q=c,r=0;n>r;++r)q=c.addScaled(k,o*(r+.5)).addScaled(e,(1&r?-1:1)*j*(r+.5)/(n-.5)),p+="L"+h(q.x)+","+h(q.y);return g.path(p).attr(i.lineattr)},g.ReStruct.prototype.getBondLineShift=function(a,b){return 0>b||Math.abs(a)>.9?0:b/(1-a)},g.ReStruct.prototype.drawBondDouble=function(a,b,c,d){var e=a.p,f=b.p,g=a.norm,i=d?0:c.doubleBondShift,j=this.render.settings,k=this.render.paper,l=this.render.styles,m=j.bondSpace/2,n=m,o=-m;n+=i*m,o+=i*m;var p=e.addScaled(g,n),q=f.addScaled(g,n),r=e.addScaled(g,o),s=f.addScaled(g,o),t=!this.atoms.get(a.begin).showLabel,u=!this.atoms.get(b.begin).showLabel;return i>0?(t&&(p=p.addScaled(a.dir,j.bondSpace*this.getBondLineShift(a.rightCos,a.rightSin))),u&&(q=q.addScaled(a.dir,-j.bondSpace*this.getBondLineShift(b.leftCos,b.leftSin)))):0>i&&(t&&(r=r.addScaled(a.dir,j.bondSpace*this.getBondLineShift(a.leftCos,a.leftSin))),u&&(s=s.addScaled(a.dir,-j.bondSpace*this.getBondLineShift(b.rightCos,b.rightSin)))),k.path(d?"M{0},{1}L{6},{7}M{4},{5}L{2},{3}":"M{0},{1}L{2},{3}M{4},{5}L{6},{7}",h(p.x),h(p.y),h(q.x),h(q.y),h(r.x),h(r.y),h(s.x),h(s.y)).attr(l.lineattr)},g.ReStruct.makeStroke=function(a,b){return"M"+h(a.x)+","+h(a.y)+"L"+h(b.x)+","+h(b.y)+"\t"},g.ReStruct.prototype.drawBondSingleOrDouble=function(a,b){var c=a.p,e=b.p,f=a.norm,h=this.render,i=h.settings,j=h.paper,k=h.styles,l=i.bondSpace/2,m=(d.dist(c,e)/(i.bondSpace+i.lineWidth)).toFixed()-0;1&m||(m+=1);for(var n="",o=c,p=1;m>=p;++p){var q=d.lc2(c,(m-p)/m,e,p/m);1&p?n+=g.ReStruct.makeStroke(o,q):(n+=g.ReStruct.makeStroke(o.addScaled(f,l),q.addScaled(f,l)),n+=g.ReStruct.makeStroke(o.addScaled(f,-l),q.addScaled(f,-l))),o=q}return j.path(n).attr(k.lineattr)},g.ReStruct.prototype.drawBondTriple=function(a,b){var c=a.p,d=b.p,e=a.norm,f=this.render,h=f.settings,i=f.paper,j=f.styles,k=c.addScaled(e,h.bondSpace),l=d.addScaled(e,h.bondSpace),m=c.addScaled(e,-h.bondSpace),n=d.addScaled(e,-h.bondSpace);return i.path(g.ReStruct.makeStroke(c,d)+g.ReStruct.makeStroke(k,l)+g.ReStruct.makeStroke(m,n)).attr(j.lineattr)},g.dashedPath=function(a,b,c){for(var e=0,f=d.dist(a,b),g=d.diff(b,a).normalized(),h=!0,i="",j=0;f>e;){var k=c[j%c.length],l=e+Math.min(k,f-e);h&&(i+="M "+a.addScaled(g,e).coordStr()+" L "+a.addScaled(g,l).coordStr()),e+=k,h=!h,j++}return i},g.ReStruct.prototype.drawBondAromatic=function(a,b,c,d){if(!d)return this.drawBondSingle(a,b);var e=c.doubleBondShift,f=this.render.paper,g=this.preparePathsForAromaticBond(a,b,e),h=g[0],i=g[1];return(e>0?h:i).attr({"stroke-dasharray":"- "}),f.set([h,i])},g.dashdotPattern=[.125,.125,.005,.125],g.ReStruct.prototype.drawBondSingleOrAromatic=function(a,b,c){var d=c.doubleBondShift,f=this.render.paper,h=this.render.settings.scaleFactor,i=e.map(g.dashdotPattern,function(a){return a*h}),j=this.preparePathsForAromaticBond(a,b,d,d>0?1:2,i),k=j[0],l=j[1];return f.set([k,l])},g.ReStruct.prototype.preparePathsForAromaticBond=function(a,b,c,d,e){var f=this.render.settings,h=this.render.paper,i=this.render.styles,j=a.p,k=b.p,l=a.norm,m=f.bondSpace/2,n=m,o=-m;n+=c*m,o+=c*m;var p=j.addScaled(l,n),q=k.addScaled(l,n),r=j.addScaled(l,o),s=k.addScaled(l,o),t=!this.atoms.get(a.begin).showLabel,u=!this.atoms.get(b.begin).showLabel;c>0?(t&&(p=p.addScaled(a.dir,f.bondSpace*this.getBondLineShift(a.rightCos,a.rightSin))),u&&(q=q.addScaled(a.dir,-f.bondSpace*this.getBondLineShift(b.leftCos,b.leftSin)))):0>c&&(t&&(r=r.addScaled(a.dir,f.bondSpace*this.getBondLineShift(a.leftCos,a.leftSin))),u&&(s=s.addScaled(a.dir,-f.bondSpace*this.getBondLineShift(b.rightCos,b.rightSin))));var v=h.path(e&&1&d?g.dashedPath(p,q,e):g.ReStruct.makeStroke(p,q)).attr(i.lineattr),w=h.path(e&&2&d?g.dashedPath(r,s,e):g.ReStruct.makeStroke(r,s)).attr(i.lineattr);return[v,w]},g.ReStruct.prototype.drawBondDoubleOrAromatic=function(a,b,c){var d=c.doubleBondShift,f=this.render.paper,h=this.render.settings.scaleFactor,i=e.map(g.dashdotPattern,function(a){return a*h}),j=this.preparePathsForAromaticBond(a,b,d,3,i),k=j[0],l=j[1];return f.set([k,l])},g.ReStruct.prototype.drawBondAny=function(a,b){var c=a.p,d=b.p,e=this.render.paper,f=this.render.styles;return e.path(g.ReStruct.makeStroke(c,d)).attr(f.lineattr).attr({"stroke-dasharray":"- "})},g.ReStruct.prototype.drawReactingCenter=function(a,b,c){var d=b.p,e=c.p,f=e.add(d).scaled(.5),h=e.sub(d).normalized(),i=h.rotateSC(1,0),j=this.render.paper,k=this.render.styles,l=this.render.settings,m=[],n=l.lineWidth,o=l.bondSpace/2,p=n,q=2*n,r=1.5*o,s=1.5*o,t=3*o,u=.2;switch(a.b.reactingCenterStatus){case chem.Struct.BOND.REACTING_CENTER.NOT_CENTER:m.push(f.addScaled(i,t).addScaled(h,u*t)),m.push(f.addScaled(i,-t).addScaled(h,-u*t)),m.push(f.addScaled(i,t).addScaled(h,-u*t)),m.push(f.addScaled(i,-t).addScaled(h,u*t));break;case chem.Struct.BOND.REACTING_CENTER.CENTER:m.push(f.addScaled(i,t).addScaled(h,u*t).addScaled(h,p)),m.push(f.addScaled(i,-t).addScaled(h,-u*t).addScaled(h,p)),m.push(f.addScaled(i,t).addScaled(h,u*t).addScaled(h,-p)),m.push(f.addScaled(i,-t).addScaled(h,-u*t).addScaled(h,-p)),m.push(f.addScaled(h,r).addScaled(i,s)),m.push(f.addScaled(h,-r).addScaled(i,s)),m.push(f.addScaled(h,r).addScaled(i,-s)),m.push(f.addScaled(h,-r).addScaled(i,-s));break;case chem.Struct.BOND.REACTING_CENTER.MADE_OR_BROKEN:m.push(f.addScaled(i,t).addScaled(h,q)),m.push(f.addScaled(i,-t).addScaled(h,q)),m.push(f.addScaled(i,t).addScaled(h,-q)),m.push(f.addScaled(i,-t).addScaled(h,-q));break;case chem.Struct.BOND.REACTING_CENTER.ORDER_CHANGED:m.push(f.addScaled(i,t)),m.push(f.addScaled(i,-t));break;case chem.Struct.BOND.REACTING_CENTER.MADE_OR_BROKEN_AND_CHANGED:m.push(f.addScaled(i,t).addScaled(h,q)),m.push(f.addScaled(i,-t).addScaled(h,q)),m.push(f.addScaled(i,t).addScaled(h,-q)),m.push(f.addScaled(i,-t).addScaled(h,-q)),m.push(f.addScaled(i,t)),m.push(f.addScaled(i,-t));break;default:return null}for(var v="",w=0;w<m.length/2;++w)v+=g.ReStruct.makeStroke(m[2*w],m[2*w+1]);return j.path(v).attr(k.lineattr)},g.ReStruct.prototype.drawTopologyMark=function(a,b,c){var e=null;if(a.b.topology==chem.Struct.BOND.TOPOLOGY.RING)e="rng";else{if(a.b.topology!=chem.Struct.BOND.TOPOLOGY.CHAIN)return null;e="chn"}var f=this.render.paper,h=this.render.settings,i=b.p,j=c.p,k=j.add(i).scaled(.5),l=j.sub(i).normalized(),m=l.rotateSC(1,0),n=h.lineWidth;a.doubleBondShift>0?m=m.scaled(-a.doubleBondShift):0==a.doubleBondShift&&(n+=h.bondSpace/2);var o=new d(2,1).scaled(h.bondSpace);a.b.type==chem.Struct.BOND.TYPE.TRIPLE&&(n+=h.bondSpace);var p=k.add(new d(m.x*(o.x+n),m.y*(o.y+n))),q=f.text(p.x,p.y,e).attr({font:h.font,"font-size":h.fontszsub,fill:"#000"}),r=g.relBox(q.getBBox());return this.centerText(q,r),q},g.ReStruct.prototype.drawBond=function(a,b,c){var d=null,e=this.molecule;switch(a.b.type){case chem.Struct.BOND.TYPE.SINGLE:switch(a.b.stereo){case chem.Struct.BOND.STEREO.UP:this.findIncomingUpBonds(b.bid,a),d=a.boldStereo&&a.neihbid1>=0&&a.neihbid2>=0?this.drawBondSingleStereoBold(b,c,a):this.drawBondSingleUp(b,c,a);break;case chem.Struct.BOND.STEREO.DOWN:d=this.drawBondSingleDown(b,c,a);break;case chem.Struct.BOND.STEREO.EITHER:d=this.drawBondSingleEither(b,c,a);break;default:d=this.drawBondSingle(b,c)}break;case chem.Struct.BOND.TYPE.DOUBLE:this.findIncomingUpBonds(b.bid,a),d=a.b.stereo===chem.Struct.BOND.STEREO.NONE&&a.boldStereo&&a.neihbid1>=0&&a.neihbid2>=0?this.drawBondSingleStereoBold(b,c,a,!0):this.drawBondDouble(b,c,a,a.b.stereo===chem.Struct.BOND.STEREO.CIS_TRANS);break;case chem.Struct.BOND.TYPE.TRIPLE:d=this.drawBondTriple(b,c,a);break;case chem.Struct.BOND.TYPE.AROMATIC:var f=b.loop>=0&&e.loops.get(b.loop).aromatic||c.loop>=0&&e.loops.get(c.loop).aromatic;d=this.drawBondAromatic(b,c,a,!f);break;case chem.Struct.BOND.TYPE.SINGLE_OR_DOUBLE:d=this.drawBondSingleOrDouble(b,c,a);break;case chem.Struct.BOND.TYPE.SINGLE_OR_AROMATIC:d=this.drawBondSingleOrAromatic(b,c,a);break;case chem.Struct.BOND.TYPE.DOUBLE_OR_AROMATIC:d=this.drawBondDoubleOrAromatic(b,c,a);break;case chem.Struct.BOND.TYPE.ANY:d=this.drawBondAny(b,c,a);break;default:throw new Error("Bond type "+a.b.type+" not supported")}return d},g.ReStruct.prototype.radicalCap=function(a){var b=this.render.settings,c=this.render.paper,d=.9*b.lineWidth,e=d,f=2*d;return c.path("M{0},{1}L{2},{3}L{4},{5}",h(a.x-e),h(a.y+f),h(a.x),h(a.y),h(a.x+e),h(a.y+f)).attr({stroke:"#000","stroke-width":.7*b.lineWidth,"stroke-linecap":"square","stroke-linejoin":"miter"})},g.ReStruct.prototype.radicalBullet=function(a){var b=this.render.settings,c=this.render.paper;return c.circle(a.x,a.y,b.lineWidth).attr({stroke:null,fill:"#000"})},g.ReStruct.prototype.centerText=function(a,b){this.render.paper.raphael.vml&&this.pathAndRBoxTranslate(a,b,0,.16*b.height)},g.ReStruct.prototype.showItemSelection=function(a,b,c){var d=null!=b.selectionPlate&&!b.selectionPlate.removed;if(d=d&&(!("hiddenPaths"in g.ReStruct.prototype)||g.ReStruct.prototype.hiddenPaths.indexOf(b.selectionPlate)<0),c){if(!d){var e=this.render,f=e.styles,h=e.paper;b.selectionPlate=b.makeSelectionPlate(this,h,f),this.addReObjectPath("selection-plate",b.visel,b.selectionPlate)}b.selectionPlate&&b.selectionPlate.show()}else d&&b.selectionPlate&&b.selectionPlate.hide()},g.ReStruct.prototype.pathAndRBoxTranslate=function(a,b,c,d){a.translateAbs(c,d),b.x+=c,b.y+=d};g.ReStruct.prototype.showLabels=function(){var a=this.render,b=a.settings,e=a.styles,i=a.opt,j=a.paper,k=.5*b.lineWidth;for(var l in this.atomsChanged){var m=this.atoms.get(l),n=a.ps(m.a.pp),o=null;i.showAtomIds&&(o={},o.text=l.toString(),o.path=j.text(n.x,n.y,o.text).attr({font:b.font,"font-size":b.fontszsub,fill:"#070"}),o.rbb=g.relBox(o.path.getBBox()),this.centerText(o.path,o.rbb),this.addReObjectPath("indices",m.visel,o.path,n)),m.setHighlight(m.highlight,a);var p="#000000";if(m.showLabel){var q=0,r=0,s={};if(null!=m.a.atomList)s.text=m.a.atomList.label();else if("R#"==m.a.label&&null!=m.a.rglabel){s.text="";for(var t=0;32>t;t++)m.a.rglabel&1<<t&&(s.text+="R"+(t+1).toString());""==s.text&&(s="R#")}else if(s.text=m.a.label,i.atomColoring){var u=f.getElementByLabel(s.text);u&&(p=f.get(u).color)}s.path=j.text(n.x,n.y,s.text).attr({font:b.font,"font-size":b.fontsz,fill:p}),s.rbb=g.relBox(s.path.getBBox()),this.centerText(s.path,s.rbb),null!=m.a.atomList&&this.pathAndRBoxTranslate(s.path,s.rbb,(m.hydrogenOnTheLeft?-1:1)*(s.rbb.width-s.rbb.height)/2,0),this.addReObjectPath("data",m.visel,s.path,n,!0),q=s.rbb.width/2,r=-s.rbb.width/2;var v=Math.floor(m.a.implicitH),w="H"==s.text,x={},y=null,z=m.hydrogenOnTheLeft;w&&v>0&&(y={},y.text=(v+1).toString(),y.path=j.text(n.x,n.y,y.text).attr({font:b.font,"font-size":b.fontszsub,fill:p}),y.rbb=g.relBox(y.path.getBBox()),this.centerText(y.path,y.rbb),this.pathAndRBoxTranslate(y.path,y.rbb,q+.5*y.rbb.width+k,.2*s.rbb.height),q+=y.rbb.width+k,this.addReObjectPath("data",m.visel,y.path,n,!0));var A={};if(0!=m.a.radical){var B;switch(m.a.radical){case 1:A.path=j.set(),B=1.6*b.lineWidth,A.path.push(this.radicalBullet(n.add(new d(-B,0))),this.radicalBullet(n.add(new d(B,0)))),A.path.attr("fill",p);break;case 2:A.path=this.radicalBullet(n).attr("fill",p);break;case 3:A.path=j.set(),B=1.6*b.lineWidth,A.path.push(this.radicalCap(n.add(new d(-B,0))),this.radicalCap(n.add(new d(B,0)))),A.path.attr("stroke",p)}A.rbb=g.relBox(A.path.getBBox());var C=-.5*(s.rbb.height+A.rbb.height);3==m.a.radical&&(C-=b.lineWidth/2),this.pathAndRBoxTranslate(A.path,A.rbb,0,C),this.addReObjectPath("data",m.visel,A.path,n,!0)}var D={};0!=m.a.isotope&&(D.text=m.a.isotope.toString(),D.path=j.text(n.x,n.y,D.text).attr({font:b.font,"font-size":b.fontszsub,fill:p}),D.rbb=g.relBox(D.path.getBBox()),this.centerText(D.path,D.rbb),this.pathAndRBoxTranslate(D.path,D.rbb,r-.5*D.rbb.width-k,-.3*s.rbb.height),r-=D.rbb.width+k,this.addReObjectPath("data",m.visel,D.path,n,!0)),!w&&v>0&&!a.opt.hideImplicitHydrogen&&(x.text="H",x.path=j.text(n.x,n.y,x.text).attr({font:b.font,"font-size":b.fontsz,fill:p}),x.rbb=g.relBox(x.path.getBBox()),this.centerText(x.path,x.rbb),z||(this.pathAndRBoxTranslate(x.path,x.rbb,q+.5*x.rbb.width+k,0),q+=x.rbb.width+k),v>1&&(y={},y.text=v.toString(),y.path=j.text(n.x,n.y,y.text).attr({font:b.font,"font-size":b.fontszsub,fill:p}),y.rbb=g.relBox(y.path.getBBox()),this.centerText(y.path,y.rbb),z||(this.pathAndRBoxTranslate(y.path,y.rbb,q+.5*y.rbb.width+k,.2*s.rbb.height),q+=y.rbb.width+k)),z&&(null!=y&&(this.pathAndRBoxTranslate(y.path,y.rbb,r-.5*y.rbb.width-k,.2*s.rbb.height),r-=y.rbb.width+k),this.pathAndRBoxTranslate(x.path,x.rbb,r-.5*x.rbb.width-k,0),r-=x.rbb.width+k),this.addReObjectPath("data",m.visel,x.path,n,!0),null!=y&&this.addReObjectPath("data",m.visel,y.path,n,!0));var E={};if(0!=m.a.charge){E.text="";var F=Math.abs(m.a.charge);1!=F&&(E.text=F.toString()),E.text+=m.a.charge<0?"–":"+",E.path=j.text(n.x,n.y,E.text).attr({font:b.font,"font-size":b.fontszsub,fill:p}),E.rbb=g.relBox(E.path.getBBox()),this.centerText(E.path,E.rbb),this.pathAndRBoxTranslate(E.path,E.rbb,q+.5*E.rbb.width+k,-.3*s.rbb.height),q+=E.rbb.width+k,this.addReObjectPath("data",m.visel,E.path,n,!0)}var G={},H={0:"0",1:"I",2:"II",3:"III",4:"IV",5:"V",6:"VI",7:"VII",8:"VIII",9:"IX",10:"X",11:"XI",12:"XII",13:"XIII",14:"XIV"};if(m.a.explicitValence>=0){if(G.text=H[m.a.explicitValence],!G.text)throw new Error("invalid valence "+m.a.explicitValence.toString());G.text="("+G.text+")",G.path=j.text(n.x,n.y,G.text).attr({font:b.font,"font-size":b.fontszsub,fill:p}),G.rbb=g.relBox(G.path.getBBox()),this.centerText(G.path,G.rbb),this.pathAndRBoxTranslate(G.path,G.rbb,q+.5*G.rbb.width+k,-.3*s.rbb.height),q+=G.rbb.width+k,this.addReObjectPath("data",m.visel,G.path,n,!0)}if(m.a.badConn&&i.showValenceWarnings){var I={},J=n.y+s.rbb.height/2+k;I.path=j.path("M{0},{1}L{2},{3}",h(n.x+r),h(J),h(n.x+q),h(J)).attr(this.render.styles.lineattr).attr({stroke:"#F00"}),I.rbb=g.relBox(I.path.getBBox()),this.addReObjectPath("warnings",m.visel,I.path,n,!0)}o&&this.pathAndRBoxTranslate(o.path,o.rbb,-.5*s.rbb.width-.5*o.rbb.width-k,.3*s.rbb.height)}var K=this.bisectLargestSector(m),L=Prototype.Browser.IE?"*":"∗";if(m.a.attpnt){var M,N,O;for(M=0,N=0;4>M;++M){var P="";if(m.a.attpnt&1<<M){for(P.length>0&&(P+=" "),P+=L,O=0;(0==M?0:M+1)>O;++O)P+="'";var Q=new d(n),R=n.addScaled(K,.7*b.scaleFactor),S=j.text(R.x,R.y,P).attr({font:b.font,"font-size":b.fontsz,fill:p}),T=g.relBox(S.getBBox());this.centerText(S,T);var U=K.negated();R=R.addScaled(U,d.shiftRayBox(R,U,c.fromRelBox(T))+b.lineWidth/2),Q=this.shiftBondEnd(m,Q,K,b.lineWidth);var V=K.rotateSC(1,0),W=R.addScaled(V,.05*b.scaleFactor).addScaled(U,.09*b.scaleFactor),X=R.addScaled(V,-.05*b.scaleFactor).addScaled(U,.09*b.scaleFactor),Y=j.set();Y.push(S,j.path("M{0},{1}L{2},{3}M{4},{5}L{2},{3}L{6},{7}",h(Q.x),h(Q.y),h(R.x),h(R.y),h(W.x),h(W.y),h(X.x),h(X.y)).attr(e.lineattr).attr({"stroke-width":b.lineWidth/2})),this.addReObjectPath("indices",m.visel,Y,n),K=K.rotate(Math.PI/6)}}}var Z="";if(m.a.aam>0&&(Z+=m.a.aam),m.a.invRet>0)if(Z.length>0&&(Z+=","),1==m.a.invRet)Z+="Inv";else{if(2!=m.a.invRet)throw new Error("Invalid value for the invert/retain flag");Z+="Ret"}var $="";if(0!=m.a.ringBondCount)if(m.a.ringBondCount>0)$+="rb"+m.a.ringBondCount.toString();else if(-1==m.a.ringBondCount)$+="rb0";else{if(-2!=m.a.ringBondCount)throw new Error("Ring bond count invalid");$+="rb*"}if(0!=m.a.substitutionCount)if($.length>0&&($+=","),m.a.substitutionCount>0)$+="s"+m.a.substitutionCount.toString();else if(-1==m.a.substitutionCount)$+="s0";else{if(-2!=m.a.substitutionCount)throw new Error("Substitution count invalid");$+="s*"}if(m.a.unsaturatedAtom>0){if($.length>0&&($+=","),1!=m.a.unsaturatedAtom)throw new Error("Unsaturated atom invalid value");$+="u"}if(m.a.hCount>0&&($.length>0&&($+=","),$+="H"+(m.a.hCount-1).toString()),m.a.exactChangeFlag>0){if(Z.length>0&&(Z+=","),1!=m.a.exactChangeFlag)throw new Error("Invalid value for the exact change flag");Z+="ext"}if(Z=($.length>0?$+"\n":"")+(Z.length>0?"."+Z+".":""),Z.length>0){var _=j.text(n.x,n.y,Z).attr({font:b.font,"font-size":b.fontszsub,fill:p}),aa=g.relBox(_.getBBox());this.centerText(_,aa);var ba=this.bisectLargestSector(m),ca=m.visel,da=3;for(M=0;M<ca.exts.length;++M)da=Math.max(da,d.shiftRayBox(n,ba,ca.exts[M].translate(n)));da+=d.shiftRayBox(n,ba.negated(),c.fromRelBox(aa)),ba=ba.scaled(8+da),this.pathAndRBoxTranslate(_,aa,ba.x,ba.y),this.addReObjectPath("data",m.visel,_,n,!0)}}},g.ReStruct.prototype.shiftBondEnd=function(a,b,c,e){for(var f=0,g=a.visel,h=0;h<g.exts.length;++h){var i=g.exts[h].translate(b);f=Math.max(f,d.shiftRayBox(b,c,i))}return f>0&&(b=b.addScaled(c,f+e)),b},g.ReStruct.prototype.bisectLargestSector=function(a){var b=[];a.a.neighbors.each(function(a){var c=this.molecule.halfBonds.get(a);b.push(c.ang)},this),b=b.sort(function(a,b){return a-b});for(var c=[],e=0;e<b.length-1;++e)c.push(b[(e+1)%b.length]-b[e]);c.push(b[0]-b[b.length-1]+2*Math.PI);var f=0,g=-Math.PI/2;for(e=0;e<b.length;++e)c[e]>f&&(f=c[e],g=b[e]+c[e]/2);return new d(Math.cos(g),Math.sin(g))},g.ReStruct.prototype.bondRecalc=function(a,b){var c=this.render,e=this.atoms.get(b.b.begin),f=this.atoms.get(b.b.end),g=c.ps(e.a.pp),h=c.ps(f.a.pp),i=this.molecule.halfBonds.get(b.b.hb1),j=this.molecule.halfBonds.get(b.b.hb2);i.p=this.shiftBondEnd(e,g,i.dir,2*a.lineWidth),j.p=this.shiftBondEnd(f,h,j.dir,2*a.lineWidth),b.b.center=d.lc2(e.a.pp,.5,f.a.pp,.5),b.b.len=d.dist(g,h),b.b.sb=5*a.lineWidth,b.b.sa=Math.max(b.b.sb,b.b.len/2-2*a.lineWidth),b.b.angle=180*Math.atan2(i.dir.y,i.dir.x)/Math.PI},g.ReStruct.prototype.showBonds=function(){var a=this.render,b=a.settings,c=a.paper,e=a.opt;for(var f in this.bondsChanged){var h=this.bonds.get(f),i=this.molecule.halfBonds.get(h.b.hb1),j=this.molecule.halfBonds.get(h.b.hb2);this.bondRecalc(b,h),h.path=this.drawBond(h,i,j),h.rbb=g.relBox(h.path.getBBox()),this.addReObjectPath("data",h.visel,h.path,null,!0);var k={};k.path=this.drawReactingCenter(h,i,j),k.path&&(k.rbb=g.relBox(k.path.getBBox()),this.addReObjectPath("data",h.visel,k.path,null,!0));var l={};l.path=this.drawTopologyMark(h,i,j),l.path&&(l.rbb=g.relBox(l.path.getBBox()),this.addReObjectPath("data",h.visel,l.path,null,!0)),h.setHighlight(h.highlight,a);var m=.6*b.subFontSize,n=null,o=null;if(e.showBondIds){var p=d.lc(i.p,.5,j.p,.5,i.norm,m);n=c.text(p.x,p.y,f.toString()),o=g.relBox(n.getBBox()),this.centerText(n,o),this.addReObjectPath("indices",h.visel,n)}if(e.showHalfBondIds){var q=d.lc(i.p,.8,j.p,.2,i.norm,m);n=c.text(q.x,q.y,h.b.hb1.toString()),o=g.relBox(n.getBBox()),this.centerText(n,o),this.addReObjectPath("indices",h.visel,n);var r=d.lc(i.p,.2,j.p,.8,j.norm,m);n=c.text(r.x,r.y,h.b.hb2.toString()),o=g.relBox(n.getBBox()),this.centerText(n,o),this.addReObjectPath("indices",h.visel,n)}if(e.showLoopIds&&!e.showBondIds){var s=d.lc(i.p,.5,j.p,.5,j.norm,m);n=c.text(s.x,s.y,i.loop.toString()),o=g.relBox(n.getBBox()),this.centerText(n,o),this.addReObjectPath("indices",h.visel,n);var t=d.lc(i.p,.5,j.p,.5,i.norm,m);n=c.text(t.x,t.y,j.loop.toString()),o=g.relBox(n.getBBox()),this.centerText(n,o),this.addReObjectPath("indices",h.visel,n)}}},g.ReStruct.prototype.labelIsVisible=function(a,b){if(0==b.a.neighbors.length||b.a.neighbors.length<2&&!this.render.opt.hideTerminalLabels||"c"!=b.a.label.toLowerCase()||b.a.badConn&&this.render.opt.showValenceWarnings||0!=b.a.isotope||0!=b.a.radical||0!=b.a.charge||b.a.explicitValence>=0||null!=b.a.atomList||null!=b.a.rglabel)return!0;if(2==b.a.neighbors.length){var c=b.a.neighbors[0],e=b.a.neighbors[1],f=this.molecule.halfBonds.get(c),g=this.molecule.halfBonds.get(e),h=this.bonds.get(f.bid),i=this.bonds.get(g.bid);if(h.b.type==i.b.type&&h.b.stereo==chem.Struct.BOND.STEREO.NONE&&i.b.stereo==chem.Struct.BOND.STEREO.NONE&&Math.abs(d.cross(f.dir,g.dir))<.2)return!0}return!1},g.ReStruct.prototype.checkLabelsToShow=function(){for(var a in this.atomsChanged){var b=this.atoms.get(a);b.showLabel=this.labelIsVisible(a,b)}},g.ReStruct.layerMap={background:0,"selection-plate":1,highlighting:2,warnings:3,data:4,indices:5},g.ReStruct.prototype.addReObjectPath=function(a,b,d,e,f){if(d){var h=this.render.offset,i=f?c.fromRelBox(g.relBox(d.getBBox())):null,j=e&&i?i.translate(e.negated()):null;null!==h&&(d.translateAbs(h.x,h.y),i=i?i.translate(h):null),b.add(d,i,j),this.insertInLayer(g.ReStruct.layerMap[a],d)}},g.ReStruct.prototype.clearVisel=function(a){for(var b=0;b<a.paths.length;++b)a.paths[b].remove();a.clear()},g.ReStruct.prototype.selectDoubleBondShift=function(a,b,c,d){return 6==a&&6!=b&&(c>1||1==d)?-1:6==b&&6!=a&&(d>1||1==c)?1:b*c>a*d?-1:a*d>b*c?1:b>a?-1:1},g.ReStruct.prototype.selectDoubleBondShift_Chain=function(a){var b=this.molecule,c=b.halfBonds.get(a.b.hb1),d=b.halfBonds.get(a.b.hb2),e=(c.leftSin>.3?1:0)+(d.rightSin>.3?1:0),f=(d.leftSin>.3?1:0)+(c.rightSin>.3?1:0);return e>f?-1:f>e?1:1==(c.leftSin>.3?1:0)+(c.rightSin>.3?1:0)?1:0},g.ReStruct.prototype.setDoubleBondShift=function(){var a=this.molecule;for(var b in this.bondsChanged){var c,d,e=this.bonds.get(b);if(c=a.halfBonds.get(e.b.hb1).loop,d=a.halfBonds.get(e.b.hb2).loop,c>=0&&d>=0){var f=a.loops.get(c).dblBonds,g=a.loops.get(d).dblBonds,h=a.loops.get(c).hbs.length,i=a.loops.get(d).hbs.length;e.doubleBondShift=this.selectDoubleBondShift(h,i,f,g)}else e.doubleBondShift=c>=0?-1:d>=0?1:this.selectDoubleBondShift_Chain(e)}},g.ReStruct.prototype.updateLoops=function(){this.reloops.each(function(a,b){this.clearVisel(b.visel)},this);var a=this.molecule.findLoops();e.each(a.bondsToMark,function(a){this.markBond(a,1)},this),e.each(a.newLoops,function(a){this.reloops.set(a,new g.ReLoop(this.molecule.loops.get(a)))},this)},g.ReStruct.prototype.renderLoops=function(){var a=this.render,b=a.settings,c=a.paper,e=this.molecule;this.reloops.each(function(f,g){var i=g.loop;g.centre=new d,i.hbs.each(function(b){var c=e.halfBonds.get(b),d=this.bonds.get(c.bid),f=a.ps(this.atoms.get(c.begin).a.pp);d.b.type!=chem.Struct.BOND.TYPE.AROMATIC&&(i.aromatic=!1),g.centre.add_(f)},this),i.convex=!0;for(var j=0;j<g.loop.hbs.length;++j){var k=e.halfBonds.get(i.hbs[j]),l=e.halfBonds.get(i.hbs[(j+1)%i.hbs.length]),m=Math.atan2(d.cross(k.dir,l.dir),d.dot(k.dir,l.dir));m>0&&(i.convex=!1)}if(g.centre=g.centre.scaled(1/i.hbs.length),g.radius=-1,i.hbs.each(function(b){var c=e.halfBonds.get(b),f=a.ps(this.atoms.get(c.begin).a.pp),h=a.ps(this.atoms.get(c.end).a.pp),i=d.diff(h,f).rotateSC(1,0).normalized(),j=d.dot(d.diff(f,g.centre),i);
g.radius=g.radius<0?j:Math.min(g.radius,j)},this),g.radius*=.7,i.aromatic){var n=null;if(i.convex)n=c.circle(g.centre.x,g.centre.y,g.radius).attr({stroke:"#000","stroke-width":b.lineWidth});else{var o="";for(j=0;j<i.hbs.length;++j){k=e.halfBonds.get(i.hbs[j]),l=e.halfBonds.get(i.hbs[(j+1)%i.hbs.length]),m=Math.atan2(d.cross(k.dir,l.dir),d.dot(k.dir,l.dir));var p=(Math.PI-m)/2,q=l.dir.rotate(p),r=a.ps(this.atoms.get(l.begin).a.pp),s=Math.sin(p),t=.1;Math.abs(s)<t&&(s=s*t/Math.abs(s));var u=b.bondSpace/s,v=r.addScaled(q,-u);o+=0==j?"M":"L",o+=h(v.x)+","+h(v.y)}o+="Z",n=c.path(o).attr({stroke:"#000","stroke-width":b.lineWidth,"stroke-dasharray":"- "})}this.addReObjectPath("data",g.visel,n,null,!0)}},this)}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../chem/element":10,"../util":39,"../util/box2abs":38,"../util/vec2":43,"./restruct":23}],25:[function(a,b,c){(function(b){var c=a("../util/box2abs"),d=a("../util/vec2"),e=b.rnd=b.rnd||{};e.Visel=function(a){this.type=a,this.paths=[],this.boxes=[],this.boundingBox=null},e.Visel.TYPE={ATOM:1,BOND:2,LOOP:3,ARROW:4,PLUS:5,SGROUP:6,TMP:7,FRAGMENT:8,RGROUP:9,CHIRAL_FLAG:10},e.Visel.prototype.add=function(a,b,d){this.paths.push(a),b&&(this.boxes.push(b),this.boundingBox=null==this.boundingBox?b:c.union(this.boundingBox,b)),d&&this.exts.push(d)},e.Visel.prototype.clear=function(){this.paths=[],this.boxes=[],this.exts=[],this.boundingBox=null},e.Visel.prototype.translate=function(a,b){if(arguments.length>2)throw new Error("One vector or two scalar arguments expected");if(void 0===b)this.translate(a.x,a.y);else{for(var c=new d(a,b),e=0;e<this.paths.length;++e)this.paths[e].translateAbs(a,b);for(var f=0;f<this.boxes.length;++f)this.boxes[f]=this.boxes[f].translate(c);null!==this.boundingBox&&(this.boundingBox=this.boundingBox.translate(c))}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../util/box2abs":38,"../util/vec2":43}],26:[function(a,b,c){(function(c){function d(){this.operations=[]}function e(a,b){b=new T(b);var c,e=new d,f=W.render,g=f.ctab,h=g.molecule,i=[],j=S.empty(),k=S.empty();if(a.atoms){var l=S.fromList(a.atoms);for(g.bonds.each(function(a,b){S.contains(l,b.b.begin)&&S.contains(l,b.b.end)?(i.push(a),U.each(["hb1","hb2"],function(a){var c=h.halfBonds.get(b.b[a]).loop;c>=0&&S.add(j,c)},this)):S.contains(l,b.b.begin)?S.add(k,b.b.begin):S.contains(l,b.b.end)&&S.add(k,b.b.end)},this),c=0;c<i.length;++c)e.addOp(new V.BondMove(i[c],b));for(S.each(j,function(a){g.reloops.get(a)&&g.reloops.get(a).visel&&e.addOp(new V.LoopMove(a,b))},this),c=0;c<a.atoms.length;++c){var m=a.atoms[c];e.addOp(new V.AtomMove(m,b,!S.contains(k,m)))}}if(a.rxnArrows)for(c=0;c<a.rxnArrows.length;++c)e.addOp(new V.RxnArrowMove(a.rxnArrows[c],b,!0));if(a.rxnPluses)for(c=0;c<a.rxnPluses.length;++c)e.addOp(new V.RxnPlusMove(a.rxnPluses[c],b,!0));if(a.sgroupData)for(c=0;c<a.sgroupData.length;++c)e.addOp(new V.SGroupDataMove(a.sgroupData[c],b));if(a.chiralFlags)for(c=0;c<a.chiralFlags.length;++c)e.addOp(new V.ChiralFlagMove(b));return e.perform()}function f(a,b,c){var e=new d;return("number"==typeof a?[a]:a).each(function(a){for(var d in X.Struct.Atom.attrlist){var f;if(d in b)f=b[d];else{if(!c)continue;f=X.Struct.Atom.attrGetDefault(d)}e.addOp(new V.AtomAttr(a,d,f))}!c&&"label"in b&&null!=b.label&&"L#"!=b.label&&!b.atomList&&e.addOp(new V.AtomAttr(a,"atomList",null))},this),e.perform()}function g(a,b,c,e){var f=new d;for(var g in X.Struct.Bond.attrlist){var h;if(g in b)h=b[g];else{if(!e)continue;h=X.Struct.Bond.attrGetDefault(g)}f.addOp(new V.BondAttr(a,g,h))}return c&&f.mergeWith(y(a)),f.perform()}function i(a,b){b=Object.clone(b);var c=new d;return b.fragment=c.addOp((new V.FragmentAdd).perform(W.editor)).frid,c.addOp(new V.AtomAdd(b,a).perform(W.editor)),c}function j(a,b,c){if(c!=b&&Object.isNumber(c)){var d=X.Struct.RGroup.findRGroupByFragment(W.render.ctab.molecule.rgroups,c);Object.isUndefined(d)||a.mergeWith(M(null,c)),W.render.ctab.molecule.atoms.each(function(d,e){e.fragment==c&&a.addOp(new V.AtomAttr(d,"fragment",b).perform(W.editor))}),a.addOp(new V.FragmentDelete(c).perform(W.editor))}}function k(a){var b=[],c=W.render.atomGetPos(a);W.render.atomGetNeighbors(a).each(function(a){var d=W.render.atomGetPos(a.aid);T.dist(c,d)<.1||b.push({id:a.aid,v:T.diff(d,c)})}),b.sort(function(a,b){return Math.atan2(a.v.y,a.v.x)-Math.atan2(b.v.y,b.v.x)});var d,e,f=0,g=0;for(d=0;d<b.length;d++)e=T.angle(b[d].v,b[(d+1)%b.length].v),0>e&&(e+=2*Math.PI),e>g&&(f=d,g=e);var h=new T(1,0);if(b.length>0){if(1==b.length){g=-(4*Math.PI/3);var i=W.render.atomGetNeighbors(a)[0];if(W.render.atomGetDegree(i.aid)>1){var j=[],k=W.render.atomGetPos(i.aid),l=T.diff(c,k),m=Math.atan2(l.y,l.x);W.render.atomGetNeighbors(i.aid).each(function(a){var b=W.render.atomGetPos(a.aid);if(!(a.bid==i.bid||T.dist(k,b)<.1)){var c=T.diff(b,k),d=Math.atan2(c.y,c.x)-m;0>d&&(d+=2*Math.PI),j.push(d)}}),j.sort(function(a,b){return a-b}),j[0]<=1.01*Math.PI&&j[j.length-1]<=1.01*Math.PI&&(g*=-1)}}e=g/2+Math.atan2(b[f].v.y,b[f].v.x),h=h.rotate(e)}h.add_(c);var n=W.render.findClosestAtom(h,.1);return n=null==n?{label:"C"}:n.id,{atom:n,pos:h}}function l(a,b,c,e,f){if(void 0===c){var g=k(b);c=g.atom,e=g.pos}var h=new d,i=null;if(Object.isNumber(b)){if(i=W.render.atomGetAttr(b,"fragment"),Object.isNumber(c)){var l=W.render.atomGetAttr(c,"fragment");j(h,i,l)}}else Object.isNumber(c)&&(i=W.render.atomGetAttr(c,"fragment"));null==i&&(i=h.addOp((new V.FragmentAdd).perform(W.editor)).frid),Object.isNumber(b)?"*"==W.render.atomGetAttr(b,"label")&&h.addOp(new V.AtomAttr(b,"label","C").perform(W.editor)):(b.fragment=i,b=h.addOp(new V.AtomAdd(b,e).perform(W.editor)).data.aid,e=f),Object.isNumber(c)?"*"==W.render.atomGetAttr(c,"label")&&h.addOp(new V.AtomAttr(c,"label","C").perform(W.editor)):(c.fragment=i,c=h.addOp(new V.AtomAdd(c,e).perform(W.editor)).data.aid,Object.isNumber(b)&&W.render.atomGetSGroups(b).each(function(a){h.addOp(new V.SGroupAtomAdd(a,c).perform(W.editor))},this));var m=h.addOp(new V.BondAdd(b,c,a).perform(W.editor)).data.bid;return h.operations.reverse(),[h,b,c,m]}function m(a){var b=new d;return W.ctab.rxnArrows.count()<1&&b.addOp(new V.RxnArrowAdd(a).perform(W.editor)),b}function n(a){var b=new d;return b.addOp(new V.RxnArrowDelete(a)),b.perform()}function p(){var a=new d;return a.addOp(new V.ChiralFlagDelete),a.perform()}function q(a){var b=new d;return b.addOp(new V.RxnPlusAdd(a).perform(W.editor)),b}function r(a){var b=new d;return b.addOp(new V.RxnPlusDelete(a)),b.perform()}function s(a){var b=new d,c=new Array,e=W.ctab.atoms.get(a).fragment;return W.render.atomGetNeighbors(a).each(function(a){b.addOp(new V.BondDelete(a.bid)),1==W.render.atomGetDegree(a.aid)&&(b.removeAtomFromSgroupIfNeeded(a.aid)&&c.push(a.aid),b.addOp(new V.AtomDelete(a.aid)))},this),b.removeAtomFromSgroupIfNeeded(a)&&c.push(a),b.addOp(new V.AtomDelete(a)),b.removeSgroupIfNeeded(c),b=b.perform(),b.mergeWith(u(e)),b}function t(a){var b=new d,c=W.ctab.bonds.get(a),e=W.ctab.atoms.get(c.begin).fragment,f=new Array;return b.addOp(new V.BondDelete(a)),1==W.render.atomGetDegree(c.begin)&&(b.removeAtomFromSgroupIfNeeded(c.begin)&&f.push(c.begin),b.addOp(new V.AtomDelete(c.begin))),1==W.render.atomGetDegree(c.end)&&(b.removeAtomFromSgroupIfNeeded(c.end)&&f.push(c.end),b.addOp(new V.AtomDelete(c.end))),b.removeSgroupIfNeeded(f),b=b.perform(),b.mergeWith(u(e)),b}function u(a){var b=new d,c=X.Struct.RGroup.findRGroupByFragment(W.ctab.rgroups,a);return W.ctab.atoms.each(function(d,e){if(e.fragment==a){var f=b.addOp((new V.FragmentAdd).perform(W.editor)).frid,g=function(c){b.addOp(new V.AtomAttr(c,"fragment",f).perform(W.editor)),W.render.atomGetNeighbors(c).each(function(b){W.ctab.atoms.get(b.aid).fragment==a&&g(b.aid)})};g(d),c&&b.mergeWith(M(c,f))}}),-1!=a&&(b.mergeWith(M(0,a)),b.addOp(new V.FragmentDelete(a).perform(W.editor))),b}function w(a){a=a||W.editor.getSelection();var b=new d,c=new Array,e=[],f=new d;for(a.sgroupData&&a.sgroupData.each(function(a){f.mergeWith(J(a))},this),a.atoms.each(function(b){W.render.atomGetNeighbors(b).each(function(b){-1==a.bonds.indexOf(b.bid)&&(a.bonds=a.bonds.concat([b.bid]))},this)},this),a.bonds.each(function(d){b.addOp(new V.BondDelete(d));var f=W.ctab.bonds.get(d);if(-1==a.atoms.indexOf(f.begin)&&1==W.render.atomGetDegree(f.begin)){var g=W.ctab.atoms.get(f.begin).fragment;e.indexOf(g)<0&&e.push(g),b.removeAtomFromSgroupIfNeeded(f.begin)&&c.push(f.begin),b.addOp(new V.AtomDelete(f.begin))}if(-1==a.atoms.indexOf(f.end)&&1==W.render.atomGetDegree(f.end)){var h=W.ctab.atoms.get(f.end).fragment;e.indexOf(h)<0&&e.push(h),b.removeAtomFromSgroupIfNeeded(f.end)&&c.push(f.end),b.addOp(new V.AtomDelete(f.end))}},this),a.atoms.each(function(a){var d=W.ctab.atoms.get(a).fragment;e.indexOf(d)<0&&e.push(d),b.removeAtomFromSgroupIfNeeded(a)&&c.push(a),b.addOp(new V.AtomDelete(a))},this),b.removeSgroupIfNeeded(c),a.rxnArrows.each(function(a){b.addOp(new V.RxnArrowDelete(a))},this),a.rxnPluses.each(function(a){b.addOp(new V.RxnPlusDelete(a))},this),a.chiralFlags.each(function(a){b.addOp(new V.ChiralFlagDelete(a))},this),b=b.perform();e.length>0;)b.mergeWith(new u(e.pop()));return b.mergeWith(f),b}function x(a,b){var c=new d,e=W.render.atomGetAttr(a,"fragment"),f=W.render.atomGetAttr(b,"fragment");e!=f&&j(c,e,f);var g=new d;W.render.atomGetNeighbors(a).each(function(a){var c,d,e=W.ctab.bonds.get(a.bid);e.begin==a.aid?(c=a.aid,d=b):(c=b,d=a.aid),b!=e.begin&&b!=e.end&&-1==W.ctab.findBondId(c,d)&&g.addOp(new V.BondAdd(c,d,e)),g.addOp(new V.BondDelete(a.bid))},this);var h=X.Struct.Atom.getAttrHash(W.ctab.atoms.get(a));1==W.render.atomGetDegree(a)&&"*"==h.get("label")&&h.set("label","C"),h.each(function(a){g.addOp(new V.AtomAttr(b,a.key,a.value))},this);var i=g.removeAtomFromSgroupIfNeeded(a);return g.addOp(new V.AtomDelete(a)),i&&g.removeSgroupIfNeeded([a]),g.perform().mergeWith(c)}function y(a){var b=W.ctab.bonds.get(a),c=new d;return c.addOp(new V.BondDelete(a)),c.addOp(new V.BondAdd(b.end,b.begin,b)).data.bid=a,c}function z(a){return y(a).perform()}function A(a,b,c){var e=new d,f=c.molecule,g=(new V.FragmentAdd).perform(W.editor),h={};return f.atoms.each(function(d,f){var i,j=X.Struct.Atom.getAttrHash(f).toObject();j.fragment=g.frid,e.addOp(i=new V.AtomAdd(j,T.diff(f.pp,c.xy0).rotate(b).add(a)).perform(W.editor)),h[d]=i.data.aid}),f.bonds.each(function(a,b){e.addOp(new V.BondAdd(h[b.begin],h[b.end],b).perform(W.editor))}),e.operations.reverse(),e.addOp(g),e}function B(a,b){var c=new d;return U.each(a,function(a){c.addOp(new V.SGroupAtomAdd(a,b).perform(W.editor))},this),c}function C(a,b,c,e,g){var h=new d,i=e.molecule,j=W.render,m=j.ctab,n=m.molecule,o=n.atoms.get(a),p=a,q=null,r=W.render.atomGetSGroups(a),s=j.atomGetAttr(a,"fragment"),t={},u=i.atoms.get(e.aid).pp;if(c){if(null==b){var v=k(a),w=l({type:1},a,v.atom,v.pos);h=w[0],h.operations.reverse(),q=a=w[2]}else{var x;h.addOp(x=new V.AtomAdd({label:"C",fragment:s},new T(1,0).rotate(b).add(o.pp)).perform(W.editor)),h.addOp(new V.BondAdd(a,x.data.aid,{type:1}).perform(W.editor)),q=a=x.data.aid,h.mergeWith(B(r,a))}var y=o;o=n.atoms.get(a);var z=g(y.pp,o.pp)-e.angle0}else null==b&&(v=k(a),b=g(o.pp,v.pos)),z=b-e.angle0;return i.atoms.each(function(b,c){var d=X.Struct.Atom.getAttrHash(c).toObject();if(d.fragment=s,b==e.aid)h.mergeWith(f(a,d,!0)),t[b]=a;else{var g;g=T.diff(c.pp,u).rotate(z).add(o.pp),h.addOp(x=new V.AtomAdd(d,g).perform(W.editor)),t[b]=x.data.aid}t[b]-0!==p-0&&t[b]-0!==q-0&&h.mergeWith(B(r,t[b]))}),i.bonds.each(function(a,b){h.addOp(new V.BondAdd(t[b.begin],t[b.end],b).perform(W.editor))}),h.operations.reverse(),h}function D(a,b,c,e){var h,i,j=new d,k=b.molecule,l=W.render,m=l.ctab,n=m.molecule,o=n.bonds.get(a),p=n.atoms.get(o.begin),q=n.atoms.get(o.end),r=S.list(S.intersection(S.fromList(W.render.atomGetSGroups(o.begin)),S.fromList(W.render.atomGetSGroups(o.end)))),s=k.bonds.get(b.bid),t=l.atomGetAttr(o.begin,"fragment"),u={};e?(h=k.atoms.get(s.end),i=k.atoms.get(s.begin),u[s.end]=o.begin,u[s.begin]=o.end):(h=k.atoms.get(s.begin),i=k.atoms.get(s.end),u[s.begin]=o.begin,u[s.end]=o.end);var v=c(p.pp,q.pp)-c(h.pp,i.pp),w=T.dist(p.pp,q.pp)/T.dist(h.pp,i.pp);return h.pp,k.atoms.each(function(a,b){var c=X.Struct.Atom.getAttrHash(b).toObject();if(c.fragment=t,a==s.begin||a==s.end)return void j.mergeWith(f(u[a],c,!0));var d;d=T.diff(b.pp,h.pp).rotate(v).scaled(w).add(p.pp);var e=l.findClosestAtom(d,.1);if(null==e){var g;j.addOp(g=new V.AtomAdd(c,d).perform(W.editor)),u[a]=g.data.aid,j.mergeWith(B(r,u[a]))}else u[a]=e.id,j.mergeWith(f(u[a],c,!0))}),k.bonds.each(function(a,b){var c=n.findBondId(u[b.begin],u[b.end]);-1==c?j.addOp(new V.BondAdd(u[b.begin],u[b.end],b).perform(W.editor)):j.mergeWith(g(c,s,!1,!0))}),j.operations.reverse(),j}function E(a,b,c,e){var f,g=Math.PI/6,h=Math.cos(g),i=Math.sin(g),j=new d;f=null!=e?W.render.atomGetAttr(e,"fragment"):j.addOp((new V.FragmentAdd).perform(W.editor)).frid;var k=-1;return k=null!=e?e:j.addOp(new V.AtomAdd({label:"C",fragment:f},a).perform(W.editor)).data.aid,j.operations.reverse(),c.times(function(c){var d=new T(h*(c+1),1&c?0:i).rotate(b).add(a),e=W.render.findClosestAtom(d,.1),f=l({},k,e?e.id:{},d);j=f[0].mergeWith(j),k=f[2]},this),j}function F(a){var b=new d;return b.addOp(new V.CanvasLoad(a)),b.perform()}function G(a,b){var c=W.render,e=c.sGroupGetType(a);if(b&&b!=e){var f=U.array(c.sGroupGetAtoms(a)),g=c.sGroupGetAttrs(a),h=J(a),i=K(b,f,g,a);return i.mergeWith(h)}return new d}function H(a,b){var c=new d,e=W.render,f=e.ctab;return f.sgroups.get(a).item,new Hash(b).each(function(b){c.addOp(new V.SGroupAttr(a,b.key,b.value))},this),c.perform()}function I(a,b){var c=new d;return new Hash(b).each(function(b){c.addOp(new V.SGroupAttr(a,b.key,b.value))},this),c}function J(a){var b=new d,c=W.render,e=c.ctab,f=e.molecule;if("SRU"==W.render.sGroupGetType(a)){W.render.sGroupsFindCrossBonds();var g=W.render.sGroupGetNeighborAtoms(a);g.each(function(a){"*"==W.render.atomGetAttr(a,"label")&&b.addOp(new V.AtomAttr(a,"label","C"))},this)}var h=f.sgroups.get(a),i=X.SGroup.getAtoms(f,h),j=h.getAttrs();b.addOp(new V.SGroupRemoveFromHierarchy(a));for(var k=0;k<i.length;++k)b.addOp(new V.SGroupAtomRemove(a,i[k]));return b.addOp(new V.SGroupDelete(a)),b=b.perform(),b.mergeWith(I(a,j)),b}function K(a,b,c,e,f){var g,h=new d;for(e=e-0===e?e:W.render.ctab.molecule.sgroups.newId(),h.addOp(new V.SGroupCreate(e,a,f)),g=0;g<b.length;g++)h.addOp(new V.SGroupAtomAdd(e,b[g]));if(h.addOp(new V.SGroupAddToHierarchy(e)),h=h.perform(),"SRU"==a){W.render.sGroupsFindCrossBonds();var i=new d;W.render.sGroupGetNeighborAtoms(e).each(function(a){1==W.render.atomGetDegree(a)&&W.render.atomIsPlainCarbon(a)&&i.addOp(new V.AtomAttr(a,"label","*"))},this),i=i.perform(),i.mergeWith(h),h=i}return H(e,c).mergeWith(h)}function L(a,b){var c=new d;return new Hash(b).each(function(b){c.addOp(new V.RGroupAttr(a,b.key,b.value))},this),c.perform()}function M(a,b){var c=new d;return c.addOp(new V.RGroupFragment(a,b)),c.perform()}function N(a){if(a.atoms.length){for(var b=1e50,c=b,d=-b,e=-c,f=0;f<a.atoms.length;f++)b=Math.min(b,a.atoms[f].pp.x),c=Math.min(c,a.atoms[f].pp.y),d=Math.max(d,a.atoms[f].pp.x),e=Math.max(e,a.atoms[f].pp.y);return new T((b+d)/2,(c+e)/2)}return a.rxnArrows.length?a.rxnArrows[0].pp:a.rxnPluses.length?a.rxnPluses[0].pp:a.chiralFlags.length?a.chiralFlags[0].pp:null}function O(a){console.assert(!a.isBlank(),"Empty struct");var b={atoms:a.atoms.keys(),bonds:a.bonds.keys(),rxnArrows:a.rxnArrows.keys(),rxnPluses:a.rxnPluses.keys()},c={atoms:[],bonds:[],sgroups:[],rxnArrows:[],rxnPluses:[],chiralFlags:[],rgmap:{},rgroups:{}},d={};b.atoms.each(function(b){var e=new X.Struct.Atom(a.atoms.get(b));e.pos=e.pp,d[b]=c.atoms.push(new X.Struct.Atom(e))-1}),b.bonds.each(function(b){var e=new X.Struct.Bond(a.bonds.get(b));e.begin=d[e.begin],e.end=d[e.end],c.bonds.push(new X.Struct.Bond(e))});var e=a.getSGroupsInAtomSet(b.atoms);U.each(e,function(b){for(var e=a.sgroups.get(b),f=X.SGroup.getAtoms(a,e),g={type:e.type,attrs:e.getAttrs(),atoms:U.array(f),pp:e.pp},h=0;h<g.atoms.length;h++)g.atoms[h]=d[g.atoms[h]];c.sgroups.push(g)},this),b.rxnArrows.each(function(b){var d=new X.Struct.RxnArrow(a.rxnArrows.get(b));d.pos=d.pp,c.rxnArrows.push(d)}),b.rxnPluses.each(function(b){var d=new X.Struct.RxnPlus(a.rxnPluses.get(b));d.pos=d.pp,c.rxnPluses.push(d)});var f={},g=S.empty();b.atoms.each(function(b){var c=a.atoms.get(b),d=c.fragment;f[b]=d,S.add(g,d)});var h=S.empty();return S.each(g,function(b){for(var d=X.Struct.Fragment.getAtoms(a,b),e=0;e<d.length;++e)if(!S.contains(f,d[e]))return;var g=X.Struct.RGroup.findRGroupByFragment(a.rgroups,b);c.rgmap[b]=g,S.add(h,g)},this),S.each(h,function(b){c.rgroups[b]=a.rgroups.get(b).getAttrs()},this),c}function P(a,b){for(var c=O(a),e=b?T.diff(b,N(c)):new T,f=new d,g={},h={},i=0;i<c.atoms.length;i++){var j=Object.clone(c.atoms[i]);j.fragment in h||(h[j.fragment]=f.addOp((new V.FragmentAdd).perform(W.editor)).frid),j.fragment=h[j.fragment],g[i]=f.addOp(new V.AtomAdd(j,j.pp.add(e)).perform(W.editor)).data.aid}var k=[];for(var l in c.rgroups)W.ctab.rgroups.has(l)||k.push(l);for(var m in c.rgmap)f.addOp(new V.RGroupFragment(c.rgmap[m],h[m]).perform(W.editor));for(var n=0;n<k.length;++n)f.mergeWith(L(k[n],c.rgroups[k[n]]));for(var o=0;o<c.bonds.length;o++){var p=Object.clone(c.bonds[o]);f.addOp(new V.BondAdd(g[p.begin],g[p.end],p).perform(W.editor))}for(var q=0;q<c.sgroups.length;q++){for(var r=c.sgroups[q],s=r.atoms,t=[],u=0;u<s.length;u++)t.push(g[s[u]]);for(var v=W.render.ctab.molecule.sgroups.newId(),w=K(r.type,t,r.attrs,v,r.pp?r.pp.add(e):null),x=w.operations.length-1;x>=0;x--)f.addOp(w.operations[x])}if(W.editor.render.ctab.rxnArrows.count()<1)for(var y=0;y<c.rxnArrows.length;y++)f.addOp(new V.RxnArrowAdd(c.rxnArrows[y].pp.add(e)).perform(W.editor));for(var z=0;z<c.rxnPluses.length;z++)f.addOp(new V.RxnPlusAdd(c.rxnPluses[z].pp.add(e)).perform(W.editor));return f.operations.reverse(),f}function Q(a,b){var c,e=W.render,f=e.ctab,g=f.molecule,h=new d,i={};if(a.atoms){for(c=0;c<a.atoms.length;c++){var j=a.atoms[c],k=g.atoms.get(j);k.fragment in i?i[k.fragment].push(j):i[k.fragment]=[j]}if(i=new Hash(i),i.detect(function(a){return!S.eq(g.getFragmentIds(a[0]),S.fromList(a[1]))}))return h;if(i.each(function(a){var c=S.fromList(a[1]),d=g.getCoordBoundingBox(c);S.each(c,function(a){var c=g.atoms.get(a),e=new T;"horizontal"==b?e.x=d.min.x+d.max.x-2*c.pp.x:e.y=d.min.y+d.max.y-2*c.pp.y,h.addOp(new V.AtomMove(a,e))})}),a.bonds)for(c=0;c<a.bonds.length;c++){var l=a.bonds[c],m=g.bonds.get(l);m.type==X.Struct.BOND.TYPE.SINGLE&&(m.stereo==X.Struct.BOND.STEREO.UP?h.addOp(new V.BondAttr(l,"stereo",X.Struct.BOND.STEREO.DOWN)):m.stereo==X.Struct.BOND.STEREO.DOWN&&h.addOp(new V.BondAttr(l,"stereo",X.Struct.BOND.STEREO.UP)))}}return h.perform()}function R(a,b,c){function e(a){var d=a.sub(b);return d=d.rotate(c),d.add_(b),d.sub(a)}var f=W.render,g=f.ctab,h=g.molecule,i=new d;return a.atoms&&a.atoms.each(function(a){var b=h.atoms.get(a);i.addOp(new V.AtomMove(a,e(b.pp)))}),a.rxnArrows&&a.rxnArrows.each(function(a){var b=h.rxnArrows.get(a);i.addOp(new V.RxnArrowMove(a,e(b.pp)))}),a.rxnPluses&&a.rxnPluses.each(function(a){var b=h.rxnPluses.get(a);i.addOp(new V.RxnPlusMove(a,e(b.pp)))}),a.sgroupData&&a.sgroupData.each(function(a){var b=h.sgroups.get(a);i.addOp(new V.SGroupDataMove(a,e(b.pp)))}),a.chiralFlags&&a.chiralFlags.each(function(a){var b=h.chiralFlags.get(a);i.addOp(new V.ChiralFlagMove(a,e(b.pp)))}),i.perform()}var S=a("../util/set"),T=a("../util/vec2"),U=a("../util"),V=a("./op");a("../chem");var W=c.ui,X=c.chem;d.prototype.addOp=function(a){return a.isDummy(W.editor)||this.operations.push(a),a},d.prototype.mergeWith=function(a){return this.operations=this.operations.concat(a.operations),this},d.prototype.perform=function(){var a=new d,b=0;return this.operations.each(function(c){a.addOp(c.perform(W.editor)),b++},this),a.operations.reverse(),a},d.prototype.isDummy=function(){return null==this.operations.detect(function(a){return!a.isDummy(W.editor)},this)},d.prototype.removeAtomFromSgroupIfNeeded=function(a){var b=W.render.atomGetSGroups(a);return b.length>0&&(b.each(function(b){this.addOp(new V.SGroupAtomRemove(b,a))},this),!0)},d.prototype.removeSgroupIfNeeded=function(a){var b=W.render,c=b.ctab,d=c.molecule,e=new Hash;a.each(function(a){var b=W.render.atomGetSGroups(a);b.each(function(a){var b=e.get(a);Object.isUndefined(b)?b=1:b++,e.set(a,b)},this)},this),e.each(function(a){var b=parseInt(a.key),c=W.render.sGroupGetAtoms(b);if(c.length==a.value){var e=d.sgroups.get(b);this.mergeWith(I(b,e.getAttrs())),this.addOp(new V.SGroupRemoveFromHierarchy(b)),this.addOp(new V.SGroupDelete(b))}},this)},b.exports=U.extend(d,{fromMultipleMove:e,fromAtomAddition:i,fromArrowAddition:m,fromArrowDeletion:n,fromChiralFlagDeletion:p,fromPlusAddition:q,fromPlusDeletion:r,fromAtomDeletion:s,fromBondDeletion:t,fromFragmentDeletion:w,fromAtomMerge:x,fromBondFlipping:z,fromTemplateOnCanvas:A,fromTemplateOnAtom:C,fromTemplateOnBond:D,fromAtomsAttrs:f,fromBondAttrs:g,fromChain:E,fromBondAddition:l,fromNewCanvas:F,fromSgroupType:G,fromSgroupDeletion:J,fromSgroupAttrs:H,fromRGroupFragment:M,fromPaste:P,fromRGroupAttrs:L,fromSgroupAddition:K,fromFlip:Q,fromRotate:R})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../chem":11,"../util":39,"../util/set":42,"../util/vec2":43,"./op":35}],27:[function(a,b,c){(function(c){function d(){$("input_label").observe("blur",function(){t.setScope("editor"),this.hide()}),$("input_label").observe("keypress",q),$("input_label").observe("keyup",r),$("atom_label").observe("change",h),$("atom_charge").observe("change",i),$("atom_isotope").observe("change",j),$("atom_valence").observe("change",k),$("atom_prop_cancel").observe("click",function(){x.hideDialog("atom_properties")}),$("atom_prop_ok").observe("click",function(){g()}),$("bond_prop_cancel").observe("click",function(){x.hideDialog("bond_properties")}),$("bond_prop_ok").observe("click",function(){m()})}function e(a){$("atom_ap1").checked=(1&(a.selection||0))>0,$("atom_ap2").checked=(2&(a.selection||0))>0,x.showDialog("atom_attpoints");var b=new Event.Handler("atom_attpoints_ok","click",void 0,function(){b.stop(),c.stop(),x.hideDialog("atom_attpoints"),"onOk"in a&&a.onOk(($("atom_ap1").checked?1:0)+($("atom_ap2").checked?2:0))}).start(),c=new Event.Handler("atom_attpoints_cancel","click",void 0,function(){b.stop(),c.stop(),x.hideDialog("atom_attpoints"),"onCancel"in a&&a.onCancel()}).start();$("atom_attpoints_ok").focus()}function f(a){$("atom_properties").atom_id=a,$("atom_label").value=x.render.atomGetAttr(a,"label"),h.call($("atom_label"));var b=x.render.atomGetAttr(a,"charge")-0;$("atom_charge").value=0==b?"":b,b=x.render.atomGetAttr(a,"isotope")-0,$("atom_isotope").value=0==b?"":b,b=x.render.atomGetAttr(a,"explicitValence")-0,$("atom_valence").value=0>b?"":b,$("atom_radical").value=x.render.atomGetAttr(a,"radical"),$("atom_inversion").value=x.render.atomGetAttr(a,"invRet"),$("atom_exactchange").value=x.render.atomGetAttr(a,"exactChangeFlag")?1:0,$("atom_ringcount").value=x.render.atomGetAttr(a,"ringBondCount"),$("atom_substitution").value=x.render.atomGetAttr(a,"substitutionCount"),$("atom_unsaturation").value=x.render.atomGetAttr(a,"unsaturatedAtom"),$("atom_hcount").value=x.render.atomGetAttr(a,"hCount"),x.showDialog("atom_properties"),$("atom_label").activate()}function g(){x.hideDialog("atom_properties");var a=$("atom_properties").atom_id;x.addUndoAction(w.fromAtomsAttrs(a,{label:$("atom_label").value,charge:""==$("atom_charge").value?0:parseInt($("atom_charge").value,10),isotope:""==$("atom_isotope").value?0:parseInt($("atom_isotope").value,10),explicitValence:""==$("atom_valence").value?-1:parseInt($("atom_valence").value,10),radical:parseInt($("atom_radical").value,10),invRet:parseInt($("atom_inversion").value,10),exactChangeFlag:!!parseInt($("atom_exactchange").value,10),ringBondCount:parseInt($("atom_ringcount").value,10),substitutionCount:parseInt($("atom_substitution").value,10),unsaturatedAtom:parseInt($("atom_unsaturation").value,10),hCount:parseInt($("atom_hcount").value,10)}),!0),x.render.update()}function h(){this.value=this.value.strip().capitalize();var a=u.getElementByLabel(this.value);null==a&&"A"!==this.value&&"*"!==this.value&&"Q"!==this.value&&"X"!==this.value&&"R"!==this.value&&(this.value=x.render.atomGetAttr($("atom_properties").atom_id,"label"),"A"!==this.value&&"*"!==this.value&&(a=u.getElementByLabel(this.value))),$("atom_number").value="A"==this.value||"*"==this.value?"any":a?a.toString():""}function i(){""===this.value.strip()||"0"==this.value?this.value="":this.value.match(/^[1-9][0-9]{0,1}[-+]$/)?this.value=(this.value.endsWith("-")?"-":"")+this.value.substr(0,this.value.length-1):this.value.match(/^[+-]?[1-9][0-9]{0,1}$/)||(this.value=x.render.atomGetAttr($("atom_properties").atom_id,"charge"))}function j(){this.value==v.getElementTextContent($("atom_number"))||""==this.value.strip()||"0"==this.value?this.value="":this.value.match(/^[1-9][0-9]{0,2}$/)||(this.value=x.render.atomGetAttr($("atom_properties").atom_id,"isotope"))}function k(){}function l(a){var b;$("bond_properties").bond_id=a;var c=x.render.bondGetAttr(a,"type"),d=x.render.bondGetAttr(a,"stereo");for(b in x.bondTypeMap)if(x.bondTypeMap[b].type==c&&x.bondTypeMap[b].stereo==d)break;$("bond_type").value=b,$("bond_topology").value=x.render.bondGetAttr(a,"topology")||0,$("bond_center").value=x.render.bondGetAttr(a,"reactingCenterStatus")||0,x.showDialog("bond_properties"),$("bond_type").activate()}function m(){x.hideDialog("bond_properties");var a=$("bond_properties").bond_id,b=Object.clone(x.bondTypeMap[$("bond_type").value]);b.topology=parseInt($("bond_topology").value,10),b.reactingCenterStatus=parseInt($("bond_center").value,10),x.addUndoAction(w.fromBondAttrs(a,b),!0),x.render.update()}function n(a){x.showDialog("automap_properties");var b,c;b=new Event.Handler("automap_ok","click",void 0,function(){b.stop(),c.stop(),a&&"onOk"in a&&a.onOk($("automap_mode").value),x.hideDialog("automap_properties")}).start(),c=new Event.Handler("automap_cancel","click",void 0,function(){b.stop(),c.stop(),x.hideDialog("automap_properties"),a&&"onCancel"in a&&a.onCancel()}).start(),$("automap_mode").activate()}function o(a){var b=a||{};b.rlogic=b.rlogic||{},$("rlogic_occurrence").value=b.rlogic.occurrence||">0",$("rlogic_resth").value=b.rlogic.resth?"1":"0";for(var c='<option value="0">Always</option>',d=1;32>=d;d++)d!=b.rgid&&0!=(b.rgmask&1<<d-1)&&(c+='<option value="'+d+'">IF R'+b.rgid+" THEN R"+d+"</option>");$("rlogic_if").outerHTML='<select id="rlogic_if">'+c+"</select>",$("rlogic_if").value=b.rlogic.ifthen,x.showDialog("rlogic_table");var e=new Event.Handler("rlogic_ok","click",void 0,function(){var a={occurrence:$("rlogic_occurrence").value.replace(/\s*/g,"").replace(/,+/g,",").replace(/^,/,"").replace(/,$/,""),resth:"1"==$("rlogic_resth").value,ifthen:parseInt($("rlogic_if").value,10)};b&&"onOk"in b&&!b.onOk(a)||(e.stop(),f.stop(),x.hideDialog("rlogic_table"))}).start(),f=new Event.Handler("rlogic_cancel","click",void 0,function(){e.stop(),f.stop(),x.hideDialog("rlogic_table"),b&&"onCancel"in b&&b.onCancel()}).start();$("rlogic_occurrence").activate()}function q(a){if(v.stopEventPropagation(a),13==a.keyCode){t.setScope("editor"),this.hide();var b="",c=0,d=this.value.toArray();if("*"==this.value)b="A";else if(this.value.match(/^[*][1-9]?[+-]$/i))b="A",c=2==this.value.length?1:parseInt(d[1]),"-"==d[2]&&(c*=-1);else if(this.value.match(/^[A-Z]{1,2}$/i))b=this.value.capitalize();else if(this.value.match(/^[A-Z]{1,2}[0][+-]?$/i))b=this.value.match(/^[A-Z]{2}/i)?this.value.substr(0,2).capitalize():d[0].capitalize();else if(this.value.match(/^[A-Z]{1,2}[1-9]?[+-]$/i)){b=this.value.match(/^[A-Z]{2}/i)?this.value.substr(0,2).capitalize():d[0].capitalize();var e=this.value.match(/[0-9]/i);c=null!=e?parseInt(e[0]):1,"-"==d[this.value.length-1]&&(c*=-1)}return("A"==b||"Q"==b||"X"==b||"R"==b||null!=u.getElementByLabel(b))&&(x.addUndoAction(w.fromAtomsAttrs(this.atom_id,{label:b,charge:c}),!0),x.render.update()),v.preventDefault(a)}return 27==a.keyCode?(this.hide(),t.setScope("editor"),v.preventDefault(a)):void 0}function r(a){return v.stopEventPropagation(a),27==a.keyCode?(this.hide(),t.setScope("editor"),v.preventDefault(a)):void 0}function s(a){var b=$("input_label");t.setScope("label");var c=Math.min(7*x.render.zoom,16);b.atom_id=a,b.value=x.render.atomGetAttr(a,"label"),b.style.fontSize=2*c+"px",b.show();var d=x.render.obj2view(x.render.atomGetPos(a)),e={left:0,top:0},f=Element.cumulativeOffset(b.offsetParent),g=0;b.style.left=d.x+e.left-f.left-c-g+"px",b.style.top=d.y+e.top-f.top-c-g+"px",b.activate()}var t=a("keymage"),u=a("../../chem/element"),v=a("../../util"),w=a("../action"),x=c.ui;b.exports={initDialogs:d,showAtomAttachmentPoints:e,showAtomProperties:f,showBondProperties:l,showAutomapProperties:n,showRLogicTable:o,showLabelEditor:s}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../chem/element":10,"../../util":39,"../action":26,keymage:2}],28:[function(a,b,c){(function(c){function d(a){var b,c=h.showDialog("open-file"),d=c.select("input[value=OK]")[0],f=c.select("textarea")[0],g=c.select("input[type=file]")[0],i=c.select("input[name=fragment]")[0],j=[];j[0]=c.on("click","input[type=button]",function(b,c){j.forEach(function(a){a.stop()}),h.hideDialog("open-file");var d="on"+c.value.capitalize();a&&d in a&&a[d]({fragment:i.checked,value:f.value})}),j[1]=g.on("change",function(a,d){console.assert(b,"No valid file opener"),d.files.length&&(c.select("input").each(function(a){a.disabled=!0}),b(d.files[0]).then(function(a){f.value=a,c.select("input").each(function(a){a.disabled=!1})},h.echo))}),j[2]=f.on("input",function(){var a=f.value.trim();d.disabled=!a}),f.value="",i.checked=!1,d.disabled=!0,g.disabled=!0,g.parentNode.addClassName("disabled"),e().then(function(a){b=a,g.disabled=!1,g.parentNode.removeClassName("disabled")})}function e(){function a(a){return new g(function(b,c){var d=new FileReader;d.onload=function(a){b(a.target.result)},d.onerror=function(a){c(a)},d.readAsText(a,"UTF-8")})}function b(a,b){var c=a.OpenTextFile(b.name,1),d=c.ReadAll();return c.Close(),d}function d(){}return new g(function(e,f){if(c.FileReader)return e(a);if(c.ActiveXObject)try{var i=new c.ActiveXObject("Scripting.FileSystemObject");return e(function(a){return g.resolve(b(i,a))})}catch(a){}return h.standalone?f("Standalone mode!"):e(d)})}function f(){}var g=a("promise-polyfill"),h=c.ui;d.loadHook=f,b.exports=d}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"promise-polyfill":3}],29:[function(a,b,c){(function(c){function d(a,b){function c(a,b){b=b||"mol",h.value=a,h.className=b,h.activate()}var d,g=j.showDialog("save-file"),h=g.select("textarea")[0],k=g.select("select")[0],l=g.select(".save")[0],m=[];m[0]=g.on("click","input[type=button]",function(b,c){m.forEach(function(a){a.stop()}),j.hideDialog("save-file");var d="on"+c.value.capitalize();a&&d in a&&a[d]({})}),m[1]=k.on("change",function(){var d=k.value;f(b,a.molecule,d).then(function(a){c(a,d)},j.echo)}),m[2]=l.on("click",function(a){d&&(d(h.value,k.value),g.select("input[type=button]")[0].click()),a.preventDefault()}),c((new i.MolfileSaver).saveMolecule(a.molecule)),l.addClassName("disabled"),e(b).then(function(a){d=a,l.removeClassName("disabled")}),k.select("[value=inchi]")[0].disabled=j.standalone}function e(a){var b={smi:"chemical/x-daylight-smiles",mol:"chemical/x-mdl-molfile",rxn:"chemical/x-mdl-rxnfile",inchi:"chemical/x-inchi"};return new g(function(d,e){c.Blob&&h.saveAs?d(function(a,c){"mol"==c&&0==a.indexOf("$RXN")&&(c="rxn"),console.assert(b[c],"Unknown chemical file type");var d=new Blob([a],{type:b[c]});h.saveAs(d,"ketcher."+c)}):j.standalone?e("Standalone mode!"):d(function(b,c){
a.save({filedata:[c,b].join("\n")})})})}function f(a,b,c){return new g(function(d){var e=(new i.MolfileSaver).saveMolecule(b);if("mol"==c)d(e);else if("smi"==c)d(j.standalone?(new i.SmilesSaver).saveMolecule(b):a.smiles({moldata:e}));else if("inchi"==c){if(j.standalone)throw Error("InChI is not supported in the standalone mode");0!==b.rgroups.count()&&j.echo("R-group fragments are not supported and will be discarded"),b=b.getScaffold(),0===b.atoms.count()?d(""):(b=b.clone(),b.sgroups.each(function(a,b){if("MUL"!=b.type&&!/^INDIGO_.+_DESC$/i.test(b.data.fieldName))throw Error("InChi data format doesn't support s-groups")}),d(a.inchi({moldata:e})))}})}var g=a("promise-polyfill"),h=a("filesaver.js");a("../../chem");var i=c.chem,j=c.ui;b.exports=d}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../chem":11,"filesaver.js":1,"promise-polyfill":3}],30:[function(a,b,c){(function(a){function c(a,b){function c(a){f.select(".selected").each(function(a){a.removeClassName("selected")}),a?f.select("button").each(function(b){var c=b.value||b.textContent||b.innerText;a.indexOf(c)>=0&&b.addClassName("selected")}):b.required&&(g.disabled=!0)}function e(){var a=[];return f.select(".selected").each(function(b){var c=b.value||b.textContent||b.innerText;a.push(c)}),a}var f=d.showDialog(a),g=f.select("input[value=OK]")[0],h=b.mode||"single",i=[];i[0]=f.on("click","input[type=button]",function(c,f){i.forEach(function(a){a.stop()}),d.hideDialog(a);var g="on"+f.value.capitalize();console.assert("onOk"!=g||!b.required||0!=e().length,"No elements selected"),b&&g in b&&b[g]({mode:h,values:e()})}),i[1]=f.on("click","button",function(a,d){"single"===h&&(d.hasClassName("selected")?b.required&&g.click():c(null)),d.toggleClassName("selected"),b.required&&(g.disabled=0===f.select(".selected").length),a.stop()}),i[2]=f.on("click","input[name=mode]",function(a,b){b.value!=h&&("single"==b.value&&c(null),h=b.value)}),c(b.values),f.select("input[name=mode]").each(function(a){a.value==h&&(a.checked=!0)})}var d=a.ui;b.exports=c}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],31:[function(a,b,c){(function(c){function d(a){var b=j.showDialog("sgroup_special"),c={},d=[];console.assert(!a.type||"DAT"==a.type),console.assert(!a.type||a.attrs.fieldName);var i=a.type&&h(a.attrs.fieldName,a.attrs.fieldValue)||a.context||"Fragment";f(i,c,!0),a.attrs.fieldName&&g(a.attrs.fieldName,c,!0),$("sgroup_special_value").value=a.attrs.fieldValue,a.attrs.attached?$("sgroup_special_attached").checked=!0:a.attrs.absolute?$("sgroup_special_absolute").checked=!0:$("sgroup_special_relative").checked=!0,d[0]=b.on("click","input[type=button]",function(b,c){var f="on"+c.value.capitalize(),g="onOk"!=f||e();g&&(d.forEach(function(a){a.stop()}),j.hideDialog("sgroup_special"),f in a&&g&&a[f](g))}),d[1]=b.on("change","select",function(a,b){"sgroup_context"==b.id&&f($("sgroup_context").value,c),"sgroup_special_name"==b.id&&g($("sgroup_special_name").value,c)})}function e(){var a={mul:null,connectivity:"",name:"",subscript:""};return a.fieldName=$("sgroup_special_name").value.strip(),a.fieldValue=$("sgroup_special_value").value.strip(),a.absolute=$("sgroup_special_absolute").checked,a.attached=$("sgroup_special_attached").checked,""==a.fieldValue?(alert("Please, specify data field value."),null):{type:"DAT",attrs:a}}function f(a,b,c){if(console.info("set context:",a,b),console.assert(b.context||c,"Field setup should be forced"),c||a!=b.context.name){b.context=i.find(k,function(b){return b.name==a}),console.assert(b.context,"Can't find such context");var d=b.context.value.reduce(function(a,b){return a+'<option value="'+b.name+'">'+b.name+"</option>"},"");$("sgroup_special_name").update(d),g(b.context.value[0].name,b,!0),c&&($("sgroup_context").value=a)}}function g(a,b,c){if(console.info("set field:",a,b),console.assert(b.field||c,"Field setup should be forced"),a||a!=b.field.name){if(b.field=i.find(b.context.value,function(b){return b.name==a}),console.assert(b.field,"Can't find such field"),b.field.value){var d=b.field.value.reduce(function(a,b){return a+'<option value="'+b+'">'+b+"</option>"},"");$("sgroup_special_value").outerHTML='<select size="10" id="sgroup_special_value">'+d+"</select>"}else $("sgroup_special_value").outerHTML='<textarea id="sgroup_special_value"></textarea>';$("sgroup_special_name").value=a}}function h(a,b){console.info("search:",i.unicodeLiteral(a),i.unicodeLiteral(b));var c=i.find(k,function(c){var d=i.find(c.value,function(b){return b.name==a});return!!d&&(!b||!d.value||!!i.find(d.value,function(a){return a==b}))});return c&&c.name}var i=a("../../util"),j=c.ui,k=[{name:"Fragment",value:[{name:"MDLBG_FRAGMENT_STEREO",value:["abs","(+)-enantiomer","(-)-enantiomer","steric","rel","R(a)","S(a)","R(p)","S(p)"]},{name:"MDLBG_FRAGMENT_COEFFICIENT",value:null},{name:"MDLBG_FRAGMENT_CHARGE",value:null},{name:"MDLBG_FRAGMENT_RADICALS",value:null}]},{name:"Single Bond",value:[{name:"MDLBG_STEREO_KEY",value:["erythro","threo","alpha","beta","endo","exo","anti","syn","ECL","STG"]},{name:"MDLBG_BOND_KEY",value:["Value=4"]}]},{name:"Atom",value:[{name:"MDLBG_STEREO_KEY",value:["RS","SR","P-3","P-3-PI","SP-4","SP-4-PI","T-4","T-4-PI","SP-5","SP-5-PI","TB-5","TB-5-PI","OC-6","TB-5-PI","TP-6","PB-7","CU-8","SA-8","DD-8","HB-9","TPS-9","HB-9"]}]},{name:"Group",value:[{name:"MDLBG_STEREO_KEY",value:["cis","trans"]}]}];d.match=function(a){return!a.type||"DAT"==a.type&&!!h(a.attrs.fieldName,a.attrs.fieldValue)},b.exports=d}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../util":39}],32:[function(a,b,c){(function(a){function c(a){var b=g.showDialog("sgroup_properties"),c=a.type||"GEN";switch($("sgroup_type").value=c,$("sgroup_type").activate(),f.call($("sgroup_type")),c){case"SRU":$("sgroup_connection").value=a.attrs.connectivity,$("sgroup_label").value=a.attrs.subscript;break;case"MUL":$("sgroup_label").value=a.attrs.mul;break;case"SUP":$("sgroup_label").value=a.attrs.name;break;case"DAT":$("sgroup_field_name").value=a.attrs.fieldName,$("sgroup_field_value").value=a.attrs.fieldValue,a.attrs.attached?$("sgroup_pos_attached").checked=!0:a.attrs.absolute?$("sgroup_pos_absolute").checked=!0:$("sgroup_pos_relative").checked=!0}"DAT"!=c&&($("sgroup_field_name").value="",$("sgroup_field_value").value="");var h=[];h[0]=b.on("click","input[type=button]",function(b,c){var e="on"+c.value.capitalize(),f="onOk"!=e||d();f&&(h.forEach(function(a){a.stop()}),g.hideDialog("sgroup_properties"),e in a&&f&&a[e](f))}),h[1]=$("sgroup_type").on("change",f),h[2]=$("sgroup_label").on("change",e)}function d(){var a=$("sgroup_type").value,b={mul:null,connectivity:"",name:"",subscript:"",fieldName:"",fieldValue:"",attached:!1,absolute:!1};switch(a){case"SRU":if(b.connectivity=$("sgroup_connection").value.strip(),b.subscript=$("sgroup_label").value.strip(),1!=b.subscript.length||!b.subscript.match(/^[a-zA-Z]$/))return alert(b.subscript.length?"SRU subscript should consist of a single letter.":"Please provide an SRU subscript."),null;break;case"MUL":b.mul=parseInt($("sgroup_label").value);break;case"SUP":if(b.name=$("sgroup_label").value.strip(),!b.name)return alert("Please provide a name for the superatom."),null;break;case"DAT":if(b.fieldName=$("sgroup_field_name").value.strip(),b.fieldValue=$("sgroup_field_value").value.strip(),b.absolute=$("sgroup_pos_absolute").checked,b.attached=$("sgroup_pos_attached").checked,""==b.fieldName||""==b.fieldValue)return alert("Please, specify data field name and value."),null}return{type:a,attrs:b}}function e(){"MUL"!=$("sgroup_type").value||this.value.match(/^[1-9][0-9]{0,2}$/)||(this.value="1")}function f(){var a=$("sgroup_type").value;return"DAT"==a?($$("#sgroup_properties .base")[0].hide(),void $$("#sgroup_properties .data")[0].show()):($$("#sgroup_properties .base")[0].show(),$$("#sgroup_properties .data")[0].hide(),$("sgroup_label").disabled="SRU"!=a&&"MUL"!=a&&"SUP"!=a,$("sgroup_connection").disabled="SRU"!=a,void("MUL"!=a||$("sgroup_label").value.match(/^[1-9][0-9]{0,2}$/)?"SRU"==a?$("sgroup_label").value="n":("GEN"==a||"SUP"==a)&&($("sgroup_label").value=""):$("sgroup_label").value="1"))}var g=a.ui;b.exports=c}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],33:[function(a,b,c){(function(c){function d(a){var b=a.split(/^[$][$][$][$]$/m),c=[];return b.each(function(a){a=a.replace(/\r/g,""),a=a.strip();var b=a.indexOf("M  END");if(-1!=b){var d={};d.molfile=a.substring(0,b+6),d.name=a.substring(0,a.indexOf("\n")).strip(),a=a.substr(b+7).strip();var e=a.split(/^$/m);e.each(function(a){if(a=a.strip(),a.startsWith("> <")){var b=a.split("\n"),c=b[0].strip().substring(3,b[0].lastIndexOf(">")).strip();d[c]=parseInt(b[1].strip())||b[1].strip()}}),c.push(d)}}),c}function e(a){return j(a+"templates.sdf").then(function(a){var b=d(a.responseText),c=[],e=0;return b.each(function(a){c.push({name:(a.name||"customtemplate "+ ++e).capitalize(),molfile:a.molfile,aid:(a.atomid||1)-1,bid:(a.bondid||1)-1})}),c})}function f(a,b){return e(b).then(function(b){return n=b,g(b,function(b){var c=new Element("li");c.title=b.name,a.insert({bottom:c});var d=m.Molfile.parseCTFile(b.molfile),e=new l.Render(c,0,{autoScale:!0,autoScaleMargin:0,ignoreMouseEvents:!0,hideChiralFlag:!0,maxBondLength:30});e.setMolecule(d),e.update()},50)})}function g(a,b,c,d){return new i(function(e){function f(){h>g?(b(a[g],g++),setTimeout(f,c)):e()}var g=0,h=a.length;setTimeout(f,d||c)})}function h(a,b){var c=k.showDialog("custom_templates"),d=c.select(".selected")[0],e=c.select("[value=OK]")[0],g=c.select("ul")[0];if(0===g.children.length){$("loading").style.display="",c.addClassName("loading");var h=f(g,a).then(function(){$("loading").style.display="none",c.removeClassName("loading")});h.then(function(){e.disabled=!0,c.on("click","li",function(a,b){d==b?e.click():(d?d.removeClassName("selected"):e.disabled=!1,b.addClassName("selected"),d=b)}),c.on("click","input",function(a,c){var e,f=c.value,g="on"+c.value.capitalize();if("OK"==f){console.assert(d,"No element selected");var h=d.previousSiblings().size();e=n[h]}k.hideDialog("custom_templates"),b&&g in b&&b[g](e)})})}}var i=a("promise-polyfill");a("../../chem"),a("../../rnd");var n,j=a("../../util/ajax.js"),k=c.ui,l=c.rnd,m=c.chem;b.exports=h}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../chem":11,"../../rnd":21,"../../util/ajax.js":37,"promise-polyfill":3}],34:[function(a,b,c){(function(c){function d(a,b){Ha=$$("[role=application]")[0]||$$("body")[0],Ia=Ha.select("[role=toolbar]")[0],Ka=$("canvas"),Na=b,m(),Na&&Na.knocknock().then(function(){la.standalone=!1,m()},function(){document.title+=" (standalone)"}).then(function(){a.mol&&R(a.mol)}),Ca.initDialogs();var c={};Ia.select("button").each(function(a){var b=a.textContent||a.innerText,d=a.dataset?a.dataset.keys:a.getAttribute("data-keys");if(d){var f=d.split(",").map(function(a){return a.strip()}),g=e(f[0]),h=a.parentNode.id;a.title=(a.title||b)+" ("+g+")",a.innerHTML+=" <kbd>"+g+"</kbd>",f.forEach(function(a){var b=a.toLowerCase();Array.isArray(c[b])?c[b].push(h):c[b]=[h]})}else a.title=a.title||b}),c=sa.extend(c,{a:["atom-any"],"defmod-a":["select-all"],"defmod-shift-a":["deselect-all"],"ctrl-alt-r":["force-update"]}),Object.keys(c).forEach(function(a){pa("editor",a,1==c[a].length?function(b){var d=c[a][0];-1==Pa.indexOf(d)&&(h(c[a][0]),b.preventDefault())}:function(){console.info("actions",c[a])})}),pa.setScope("editor"),Ia.select("li").each(function(a){a.on("click",function(a){"BUTTON"==a.target.tagName&&a.target.parentNode==this&&(this.hasClassName("selected")||a.stop(),h(this.id)),g()?a.stop():"hidden"==this.getStyle("overflow")&&(this.addClassName("opened"),La=this,a.stop())})}),j(Ha),C(),l(),Ka.on("scroll",Y),Ka.on("mousedown",function(){pa.setScope("editor")});var d=new na.RenderOptions(a);d.atomColoring=!0,la.render=new na.Render(Ka,Da,d),la.editor=new na.Editor(la.render),la.render.onCanvasOffsetChanged=Z,h("select-lasso"),L(0,0),la.render.setMolecule(la.ctab),la.render.update()}function e(a){var b=navigator.platform.toUpperCase().indexOf("MAC")>=0;return a.replace(/Defmod/g,b?"⌘":"Ctrl").replace(/-(?!$)/g,"+")}function f(a){return $(a).children[0]}function g(){if(!La)return!1;La.removeClassName("opened");var a=La.select(".selected");if(1==a.length){var b=f(La);b.style.marginTop=-a[0].offsetTop+b.offsetTop+"px"}return Ka.style.visibility="hidden",setTimeout(function(){Ka.style.visibility="visible"},0),La=null,!0}function h(a){a=a||Ja;var b=$(a),c=[].slice.call(arguments,1);if(console.assert(a.startsWith,"id is not a string",a),-1!=Pa.indexOf(a)&&0==c.length)return i(a);if(!b||!f(b).disabled){c.unshift(a);var d=ha.apply(null,c);if(d instanceof na.Editor.EditorTool){var e=Ia.select(".selected")[0];b==e&&b||(la.render.current_tool&&la.render.current_tool.OnCancel(),la.render.current_tool=d,a.startsWith("select-")&&(Ja=a),b&&b.addClassName("selected"),e&&e.removeClassName("selected"))}return d}return null}function i(a){var b=document.queryCommandSupported(a);if(b)try{document.execCommand(a)}catch(a){b=!1}if(!b){var c=f(a),d=c.dataset?c.dataset.keys:c.getAttribute("data-keys");u("These action is unavailble via menu.\nInstead, use "+e(d)+" to "+a+".")}return null}function j(a){var b=new Element("input",{type:"text",class:"cliparea",autofocus:!0}),c=window.clipboardData,d=["chemical/x-mdl-molfile","chemical/x-mdl-rxnfile","chemical/x-cml","text/plain","chemical/x-daylight-smiles","chemical/x-inchi"],e=function(){return"editor"==pa.getScope()&&(b.value=" ",b.focus(),b.select(),!0)},f=function(a,b){var d=(new ma.MolfileSaver).saveMolecule(a);if(!b&&c)c.setData("text",d);else{b.setData("text/plain",d);try{b.setData(a.isReaction?"chemical/x-mdl-rxnfile":"chemical/x-mdl-molfile",d),b.setData("chemical/x-daylight-smiles",(new ma.SmilesSaver).saveMolecule(a))}catch(a){console.info("Could not write exact type",a)}}},g=function(a){var b="";if(!a&&c)b=c.getData("text");else for(var e=0;e<d.length&&!(b=a.getData(d[e]));e++);return console.info("paste",e>=0&&d[e],b.slice(0,50),".."),b};a.insert(b),a.on("mouseup",e),["copy","cut"].forEach(function(b){a.on(b,function(a){if(e()){var c=h(b,!0);c&&f(c,a.clipboardData),a.preventDefault()}})}),a.on("paste",function(a){if(e()){var b=g(a.clipboardData);b&&S(b),a.preventDefault()}})}function k(){f("copy").disabled=f("cut").disabled=!la.editor.hasSelection(!0)}function l(){f("undo").disabled=0==Fa.length,f("redo").disabled=0==Ga.length}function m(){Oa.forEach(function(a){f(a).disabled=la.standalone})}function n(){var a,b=document.createElement("transitionTest"),c={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"};for(a in c)if(void 0!==b.style[a])return c[a];return!1}function o(a,b){Ha.addClassName("animate");var c=n(),d=function(a){setTimeout(function(){a&&a(),Ha.removeClassName("animate")},0)};if(b&&c){var e=function(){d(b),a.removeEventListener(c,e,!1)};a.addEventListener(c,e,!1)}else d(b),b||a()}function p(a){var b=$(a);return pa.setScope("dialog"),o(function(){$$(".overlay")[0].show(),b.style.display=""}),b}function q(a){var b=$$(".overlay")[0];o(b,function(){$(a).style.display="none",b.hide(),pa.setScope("editor")})}function r(a){a.required=!0,ya("elem-table",a)}function s(a){ya("rgroup-table",a)}function t(a){a.required=!0,ya("generics-table",a)}function u(a){alert(a)}function v(a){if("undefined"!=typeof a&&null!=a){la.editor.deselectAll(),w(ta.fromNewCanvas(a)),p("loading");try{la.render.onResize(),la.render.update(),I(null,la.render.getStructCenter())}catch(a){alert(a.message)}finally{q("loading")}}}function w(a,b){null!=a&&(1==b&&a.isDummy()||(Fa.push(a),Ga.clear(),Fa.length>Ea&&Fa.splice(0,1),l()))}function x(){h(null),la.ctab.isBlank()||(w(ta.fromNewCanvas(new ma.Struct)),la.render.update())}function y(){wa({onOk:function(a){a.fragment?S(a.value,!0):R(a.value,!0)}})}function z(){xa({molecule:la.ctab},Na)}function A(a,b){a=a.clone();var c=a.addRxnArrowIfNecessary(),d=(new ma.MolfileSaver).saveMolecule(a);if(la.standalone)throw new Error("Aromatization and dearomatization are not supported in the standalone mode.");var e=b?"aromatize":"dearomatize",f=Na[e]({moldata:d});f.then(function(a){var b=ga(a);c&&b.rxnArrows.clear(),v(b)},u)}function B(){sa.assert(!la.standalone,"Can't calculate in standalone mode!");var a=la.ctab.clone(),b=a.addRxnArrowIfNecessary(),c=(new ma.MolfileSaver).saveMolecule(a),d=Na.calculateCip({moldata:c});d.then(function(a){var c=ga(a);b&&c.rxnArrows.clear(),v(c)},u)}function C(){var a=f("zoom-list");a.on("focus",function(){pa.pushScope("zoom")}),a.on("blur",function(){pa.popScope("zoom")}),a.on("change",F),F(!0)}function D(){f("zoom-list").selectedIndex++,F()}function E(){f("zoom-list").selectedIndex--,F()}function F(a){var b=f("zoom-list"),c=b.selectedIndex,d=b.length;console.assert(c>=0&&d>c,"Zoom out of range"),f("zoom-in").disabled=c==d-1,f("zoom-out").disabled=0==c;var e=parseFloat(b.options[c].innerHTML)/100;la.zoom=e,a||(I(e,la.render.getStructCenter(la.editor.getSelection())),la.render.update())}function G(a){.1>a||a>10||(la.zoom=a,la.render.setZoom(la.zoom))}function I(a,b){if(!b)throw new Error("Center point not specified");a&&G(a),L(0,0);var c=la.render.obj2view(b).sub(la.render.viewSz.scaled(.5));L(c.x,c.y)}function J(a){Ma=new ra(a)}function K(a,b){G(a),L(0,0);var c=la.render.obj2view(Ma),d=c.sub(b);L(d.x,d.y)}function L(a,b){var c=Ka.clientWidth,d=Ka.clientHeight;la.render.extendCanvas(a,b,c+a,d+b),Ka.scrollLeft=a,Ka.scrollTop=b,Qa=Ka.scrollLeft,Ra=Ka.scrollTop}function N(){var a=sa.array(la.editor.getSelection(!0).atoms),b=a.length>0;if(b){var c=qa.fromList(a),d=qa.empty();la.ctab.loops.each(function(a,b){sa.findIndex(b.hbs,function(a){return qa.contains(c,la.ctab.halfBonds.get(a).begin)})>=0&&sa.each(b.hbs,function(a){qa.add(d,la.ctab.halfBonds.get(a).begin)},this)},this),qa.mergeIn(d,c),a=qa.list(d)}la.editor.deselectAll();try{var e={},f=la.ctab.clone(null,null,!1,e);b&&sa.each(a,function(a){a=e[a];var b=new ma.SGroup("DAT"),c=f.sgroups.add(b);b.id=c,b.pp=new ra,b.data.fieldName="_ketcher_selective_layout",b.data.fieldValue="1",f.atomAddToSGroup(c,a)},this);var g=f.addRxnArrowIfNecessary(),h=Na.layout({moldata:(new ma.MolfileSaver).saveMolecule(f)},b?{selective:1}:null);h.then(function(a){var b=ga(a);g&&b.rxnArrows.clear(),v(b)})}catch(a){alert("ERROR: "+a.message)}}function O(){try{A(la.ctab,!0)}catch(a){alert("Molfile: "+a.message)}}function P(){try{A(la.ctab,!1)}catch(a){alert("Molfile: "+a.message)}}function Q(){Ca.showAutomapProperties({onOk:function(a){var b=la.ctab,c=b.addRxnArrowIfNecessary();if(0==b.rxnArrows.count())return void u("Auto-Mapping can only be applied to reactions");var d=(new ma.MolfileSaver).saveMolecule(b,!0),e=Na.automap({moldata:d,mode:a});e.then(function(a){var b=ga(a);c&&b.rxnArrows.clear(),v(b)},u)}})}function R(a,b){return U(a,b).then(v)}function S(a,b){return U(a,b).then(function(a){a.rescale(),h("paste",a)})}function T(a,b){var c=a.trim(),d=c.match(/^(M  END|\$END MOL)$/m);if(d){var e=d.index+d[0].length;if(e==c.length||-1!=c.slice(e,e+20).search(/^\$(MOL|END CTAB)$/m))return"mol"}return"<"==c[0]&&-1!=c.indexOf("<molecule")?"cml":"InChI"==c.slice(0,5)?"inchi":-1==c.indexOf("\n")?"smiles":b?null:"mol"}function U(a,b){return new oa(function(c){var d=T(a);if("mol"==d){var e=ga(a,b);c(e)}else{if(la.standalone)throw d?d.toUpperCase():"Format is not supported in a standalone mode.";var f="smiles"==d?Na.layout_smiles(null,{smiles:a.trim()}):Na.molfile({moldata:a});c(f.then(function(a){return ga(a)}))}})}function V(a){var b=Ka.cumulativeOffset();return new ra(a.pageX-b.left,a.pageY-b.top)}function W(a){return la.render.view2obj(V(a))}function X(){return new ra(Ka.scrollLeft,Ka.scrollTop)}function Y(a){Qa=Ka.scrollLeft,Ra=Ka.scrollTop,sa.stopEventPropagation(a)}function Z(a,b){if(null!=b){var c=new ra(a.x-b.x,a.y-b.y);Ka.scrollLeft+=c.x,Ka.scrollTop+=c.y}}function _(){w(ta.fromFragmentDeletion()),la.editor.deselectAll(),la.render.update()}function aa(){la.render.current_tool&&la.render.current_tool.OnCancel(),la.editor.deselectAll(),Ga.push(Fa.pop().perform()),la.render.update(),l()}function ba(){la.render.current_tool&&la.render.current_tool.OnCancel(),la.editor.deselectAll(),Fa.push(Ga.pop().perform()),la.render.update(),l()}function ca(){r({onOk:function(a){var b;return b="single"==a.mode?{label:va.get(a.values[0]).label}:{label:"L#",atomList:new ma.Struct.AtomList({notList:"not-list"==a.mode,ids:a.values})},Sa=b,h("atom-table"),!0},onCancel:function(){}})}function da(){t({onOk:function(a){return Ta={label:a.values[0]},h("atom-reagenerics"),!0}})}function ea(){za("",{onOk:function(a){return Ua=a,h("template-custom-select"),!0}})}function fa(a){return Aa(a)}function ga(a,b){var c=sa.splitNewlines(a);try{return ma.Molfile.parseCTFile(c)}catch(a){if(b){try{return ma.Molfile.parseCTFile(c.slice(1))}catch(a){}try{return ma.Molfile.parseCTFile([""].concat(c))}catch(a){}}throw a}}function ha(a){console.assert(a,"The null tool");var b=[].slice.call(arguments,1);if(Va[a])return Va[a].apply(null,b);if(la.editor.hasSelection()){if("erase"==a)return _(),null;if(a.startsWith("atom-"))return w(ta.fromAtomsAttrs(la.editor.getSelection().atoms,ja(a)),!0),la.render.update(),null;if(a.startsWith("transform-flip"))return w(ta.fromFlip(la.editor.getSelection(),a.endsWith("h")?"horizontal":"vertical"),!0),la.render.update(),null}return"transform-rotate"!=a&&la.editor.deselectAll(),"select-lasso"==a?new na.Editor.LassoTool(la.editor,0):"select-rectangle"==a?new na.Editor.LassoTool(la.editor,1):"select-fragment"==a?new na.Editor.LassoTool(la.editor,1,!0):"erase"==a?new na.Editor.EraserTool(la.editor,1):a.startsWith("atom-")?new na.Editor.AtomTool(la.editor,ja(a)):a.startsWith("bond-")?new na.Editor.BondTool(la.editor,ia(a)):"chain"==a?new na.Editor.ChainTool(la.editor):a.startsWith("template-custom")?new na.Editor.TemplateTool(la.editor,Ua):a.startsWith("template")?new na.Editor.TemplateTool(la.editor,ua[parseInt(a.split("-")[1])]):"charge-plus"==a?new na.Editor.ChargeTool(la.editor,1):"charge-minus"==a?new na.Editor.ChargeTool(la.editor,-1):"sgroup"==a?new na.Editor.SGroupTool(la.editor):"reaction-arrow"==a?new na.Editor.ReactionArrowTool(la.editor):"reaction-plus"==a?new na.Editor.ReactionPlusTool(la.editor):"reaction-map"==a?new na.Editor.ReactionMapTool(la.editor):"reaction-unmap"==a?new na.Editor.ReactionUnmapTool(la.editor):"rgroup-label"==a?new na.Editor.RGroupAtomTool(la.editor):"rgroup-fragment"==a?new na.Editor.RGroupFragmentTool(la.editor):"rgroup-attpoints"==a?new na.Editor.APointTool(la.editor):a.startsWith("transform-rotate")?new na.Editor.RotateTool(la.editor):null}function ia(a){var b=a.substr(5);return Wa[b]}function ja(a){var b=a.substr(5);switch(b){case"table":return Sa;case"reagenerics":return Ta;case"any":return{label:"A"};default:return b=b.capitalize(),console.assert(va.getElementByLabel(b),"No such atom exist"),{label:b}}}function ka(){ta.fromNewCanvas(new ma.Struct),la.render.update(),Fa.clear(),Ga.clear(),l(),h(null)}var la=c.ui={};a("../chem"),a("../rnd");var Ha,Ia,Ja,La,Ma,Na,ma=c.chem,na=c.rnd,oa=a("promise-polyfill"),pa=a("keymage"),qa=a("../util/set"),ra=a("../util/vec2"),sa=a("../util"),ta=a("./action.js"),ua=a("./templates"),va=a("../chem/element"),wa=a("./dialog/open.js"),xa=a("./dialog/save.js"),ya=a("./dialog/select"),za=a("./dialog/templates"),Aa=a("./dialog/sgroup"),Ca=(a("./dialog/sgroup-special"),a("./dialog/obsolete")),Da=40,Ea=32,Fa=[],Ga=[],Ka=null,Oa=["cleanup","arom","dearom","calc-cip","reaction-automap","template-custom"],Pa=["cut","copy","paste"],Qa=null,Ra=null,Sa=null,Ta=null,Ua=null,Va={new:x,open:y,save:z,undo:aa,redo:ba,"zoom-in":D,"zoom-out":E,cleanup:N,arom:O,dearom:P,"period-table":ca,"generic-groups":da,"template-custom":ea,cut:function(){var a=la.editor.getSelectionStruct();return _(),a.isBlank()?null:a},copy:function(){var a=la.editor.getSelectionStruct();return la.editor.deselectAll(),a.isBlank()?null:a},paste:function(a){if(a.isBlank())throw"Not a valid structure to paste";return la.editor.deselectAll(),new na.Editor.PasteTool(la.editor,a)},info:function(){p("about_dialog")},"select-all":function(){la.editor.selectAll()},"deselect-all":function(){la.editor.deselectAll()},"force-update":function(){la.render.update(!0)},"reaction-automap":Q,"calc-cip":B},Wa={single:{type:1,stereo:ma.Struct.BOND.STEREO.NONE},up:{type:1,stereo:ma.Struct.BOND.STEREO.UP},down:{type:1,stereo:ma.Struct.BOND.STEREO.DOWN},updown:{type:1,stereo:ma.Struct.BOND.STEREO.EITHER},double:{type:2,stereo:ma.Struct.BOND.STEREO.NONE},crossed:{type:2,stereo:ma.Struct.BOND.STEREO.CIS_TRANS},triple:{type:3,stereo:ma.Struct.BOND.STEREO.NONE},aromatic:{type:4,stereo:ma.Struct.BOND.STEREO.NONE},singledouble:{type:5,stereo:ma.Struct.BOND.STEREO.NONE},singlearomatic:{type:6,stereo:ma.Struct.BOND.STEREO.NONE},doublearomatic:{type:7,stereo:ma.Struct.BOND.STEREO.NONE},any:{type:8,stereo:ma.Struct.BOND.STEREO.NONE}};b.exports={init:d,clean:ka,loadMolecule:R,loadFragment:S},sa.extend(la,b.exports),sa.extend(la,{standalone:!0,ctab:new ma.Struct,render:null,editor:null,hideBlurredControls:g,updateClipboardButtons:k,selectAction:h,addUndoAction:w,loadMoleculeFromFile:wa.loadHook,echo:u,showDialog:p,hideDialog:q,bondTypeMap:Wa,zoom:1,setZoomStaticPointInit:J,setZoomStaticPoint:K,page2canvas2:V,scrollPos:X,page2obj:W,showSGroupProperties:fa,showRGroupTable:s,showElemTable:r,showReaGenericsTable:t,showAtomAttachmentPoints:Ca.showAtomAttachmentPoints,showAtomProperties:Ca.showAtomProperties,showBondProperties:Ca.showBondProperties,showRLogicTable:Ca.showRLogicTable,showLabelEditor:Ca.showLabelEditor})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../chem":11,"../chem/element":10,"../rnd":21,"../util":39,"../util/set":42,"../util/vec2":43,"./action.js":26,"./dialog/obsolete":27,"./dialog/open.js":28,"./dialog/save.js":29,"./dialog/select":30,"./dialog/sgroup":32,"./dialog/sgroup-special":31,"./dialog/templates":33,"./templates":36,keymage:2,"promise-polyfill":3}],35:[function(a,b,c){(function(c){function d(){this.type="OpBase",this._execute=function(){throw new Error("Operation._execute() is not implemented")},this._invert=function(){throw new Error("Operation._invert() is not implemented")},this.perform=function(a){return this._execute(a),this.__inverted||(this.__inverted=this._invert(),this.__inverted.__inverted=this),this.__inverted},this.isDummy=function(a){return!!this._isDummy&&this._isDummy(a)}}function e(a,b){this.data={aid:null,atom:a,pos:b},this._execute=function(a){var b=a.render,c=b.ctab,d=c.molecule,e={};if(this.data.atom)for(var f in this.data.atom)e[f]=this.data.atom[f];e.label=e.label||"C",Object.isNumber(this.data.aid)?d.atoms.set(this.data.aid,new M.Struct.Atom(e)):this.data.aid=d.atoms.add(new M.Struct.Atom(e)),c.notifyAtomAdded(this.data.aid),d._atomSetPos(this.data.aid,new J(this.data.pos))},this._invert=function(){var a=new f;return a.data=this.data,a}}function f(a){this.data={aid:a,atom:null,pos:null},this._execute=function(a){var b=a.render,c=b.ctab,d=c.molecule;this.data.atom||(this.data.atom=d.atoms.get(this.data.aid),this.data.pos=b.atomGetPos(this.data.aid)),c.notifyAtomRemoved(this.data.aid),d.atoms.remove(this.data.aid)},this._invert=function(){var a=new e;return a.data=this.data,a}}function g(a,b,c){this.data={aid:a,attribute:b,value:c},this.data2=null,this._execute=function(a){var b=a.render.ctab.molecule.atoms.get(this.data.aid);this.data2||(this.data2={aid:this.data.aid,attribute:this.data.attribute,value:b[this.data.attribute]}),b[this.data.attribute]=this.data.value,a.render.invalidateAtom(this.data.aid)},this._isDummy=function(a){return a.render.ctab.molecule.atoms.get(this.data.aid)[this.data.attribute]==this.data.value},this._invert=function(){var a=new g;return a.data=this.data2,a.data2=this.data,a}}function h(a,b,c){this.data={aid:a,d:b,noinvalidate:c},this._execute=function(a){var b=a.render,c=b.ctab,d=c.molecule,e=this.data.aid,f=this.data.d;d.atoms.get(e).pp.add_(f),c.atoms.get(e).visel.translate(b.ps(f)),this.data.d=f.negated(),this.data.noinvalidate||b.invalidateAtom(e,1)},this._isDummy=function(){return 0==this.data.d.x&&0==this.data.d.y},this._invert=function(){var a=new h;return a.data=this.data,a}}function i(a,b){this.data={bid:a,d:b},this._execute=function(a){var b=a.render,c=b.ctab;c.bonds.get(this.data.bid).visel.translate(b.ps(this.data.d)),this.data.d=this.data.d.negated()},this._invert=function(){var a=new i;return a.data=this.data,a}}function j(a,b){this.data={id:a,d:b},this._execute=function(a){var b=a.render,c=b.ctab;c.reloops.get(this.data.id)&&c.reloops.get(this.data.id).visel&&c.reloops.get(this.data.id).visel.translate(b.ps(this.data.d)),this.data.d=this.data.d.negated()},this._invert=function(){var a=new j;return a.data=this.data,a}}function k(a,b){this.type="OpSGroupAtomAdd",this.data={aid:b,sgid:a},this._execute=function(a){var b=a.render,c=b.ctab,d=c.molecule,e=this.data.aid,f=this.data.sgid,g=d.atoms.get(e),h=d.sgroups.get(f);if(h.atoms.indexOf(e)>=0)throw new Error("The same atom cannot be added to an S-group more than once");if(!g)throw new Error("OpSGroupAtomAdd: Atom "+e+" not found");d.atomAddToSGroup(f,e),b.invalidateAtom(e)},this._invert=function(){var a=new l;return a.data=this.data,a}}function l(a,b){this.type="OpSGroupAtomRemove",this.data={aid:b,sgid:a},this._execute=function(a){var b=this.data.aid,c=this.data.sgid,d=a.render,e=d.ctab,f=e.molecule,g=f.atoms.get(b),h=f.sgroups.get(c);M.SGroup.removeAtom(h,b),K.remove(g.sgs,c),d.invalidateAtom(b)},this._invert=function(){var a=new k;return a.data=this.data,a}}function m(a,b,c){this.type="OpSGroupAttr",this.data={sgid:a,attr:b,value:c},this._execute=function(a){var b=a.render,c=b.ctab,d=c.molecule,e=this.data.sgid,f=d.sgroups.get(e);"DAT"==f.type&&c.sgroupData.has(e)&&(c.clearVisel(c.sgroupData.get(e).visel),c.sgroupData.unset(e)),this.data.value=f.setAttr(this.data.attr,this.data.value)},this._invert=function(){var a=new m;return a.data=this.data,a}}function n(a,b,c){this.type="OpSGroupCreate",this.data={sgid:a,type:b,pp:c},this._execute=function(a){var b=a.render,c=b.ctab,d=c.molecule,e=new M.SGroup(this.data.type),f=this.data.sgid;e.id=f,d.sgroups.set(f,e),this.data.pp&&(d.sgroups.get(f).pp=new J(this.data.pp)),c.sgroups.set(f,new N.ReSGroup(d.sgroups.get(f))),this.data.sgid=f},this._invert=function(){var a=new o;return a.data=this.data,a}}function o(a){this.type="OpSGroupDelete",this.data={sgid:a},this._execute=function(a){var b=a.render,c=b.ctab,d=c.molecule,e=this.data.sgid,f=c.sgroups.get(e);if(this.data.type=f.item.type,this.data.pp=f.item.pp,"DAT"==f.item.type&&c.sgroupData.has(e)&&(c.clearVisel(c.sgroupData.get(e).visel),c.sgroupData.unset(e)),c.clearVisel(f.visel),0!=f.item.atoms.length)throw new Error("S-Group not empty!");c.sgroups.unset(e),d.sgroups.remove(e)},this._invert=function(){var a=new n;return a.data=this.data,a}}function p(a){this.type="OpSGroupAddToHierarchy",this.data={sgid:a},this._execute=function(a){var b=a.render,c=b.ctab,d=c.molecule,e=this.data.sgid,f=d.sGroupForest.insert(e,this.data.parent,this.data.children);this.data.parent=f.parent,this.data.children=f.children},this._invert=function(){var a=new q;return a.data=this.data,a}}function q(a){this.type="OpSGroupRemoveFromHierarchy",this.data={sgid:a},this._execute=function(a){var b=a.render,c=b.ctab,d=c.molecule,e=this.data.sgid;this.data.parent=d.sGroupForest.parent.get(e),this.data.children=d.sGroupForest.children.get(e),d.sGroupForest.remove(e)},this._invert=function(){var a=new p;return a.data=this.data,a}}function r(a,b,c){this.data={bid:null,bond:c,begin:a,end:b},this._execute=function(a){
var b=a.render,c=b.ctab,d=c.molecule;if(this.data.begin==this.data.end)throw new Error("Distinct atoms expected");if(N.DEBUG&&this.molecule.checkBondExists(this.data.begin,this.data.end))throw new Error("Bond already exists");b.invalidateAtom(this.data.begin,1),b.invalidateAtom(this.data.end,1);var e={};if(this.data.bond)for(var f in this.data.bond)e[f]=this.data.bond[f];e.type=e.type||M.Struct.BOND.TYPE.SINGLE,e.begin=this.data.begin,e.end=this.data.end,Object.isNumber(this.data.bid)?d.bonds.set(this.data.bid,new M.Struct.Bond(e)):this.data.bid=d.bonds.add(new M.Struct.Bond(e)),d.bondInitHalfBonds(this.data.bid),d.atomAddNeighbor(d.bonds.get(this.data.bid).hb1),d.atomAddNeighbor(d.bonds.get(this.data.bid).hb2),c.notifyBondAdded(this.data.bid)},this._invert=function(){var a=new s;return a.data=this.data,a}}function s(a){this.data={bid:a,bond:null,begin:null,end:null},this._execute=function(a){var b=a.render,c=b.ctab,d=c.molecule;this.data.bond||(this.data.bond=d.bonds.get(this.data.bid),this.data.begin=this.data.bond.begin,this.data.end=this.data.bond.end),b.invalidateBond(this.data.bid),c.notifyBondRemoved(this.data.bid);var e=d.bonds.get(this.data.bid);[e.hb1,e.hb2].each(function(a){var b=d.halfBonds.get(a),c=d.atoms.get(b.begin),e=c.neighbors.indexOf(a),f=(e+c.neighbors.length-1)%c.neighbors.length,g=(e+1)%c.neighbors.length;d.setHbNext(c.neighbors[f],c.neighbors[g]),c.neighbors.splice(e,1)},this),d.halfBonds.unset(e.hb1),d.halfBonds.unset(e.hb2),d.bonds.remove(this.data.bid)},this._invert=function(){var a=new r;return a.data=this.data,a}}function t(a,b,c){this.data={bid:a,attribute:b,value:c},this.data2=null,this._execute=function(a){var b=a.render.ctab.molecule.bonds.get(this.data.bid);this.data2||(this.data2={bid:this.data.bid,attribute:this.data.attribute,value:b[this.data.attribute]}),b[this.data.attribute]=this.data.value,a.render.invalidateBond(this.data.bid),"type"==this.data.attribute&&a.render.invalidateLoop(this.data.bid)},this._isDummy=function(a){return a.render.ctab.molecule.bonds.get(this.data.bid)[this.data.attribute]==this.data.value},this._invert=function(){var a=new t;return a.data=this.data2,a.data2=this.data,a}}function u(a){this.frid=Object.isUndefined(a)?null:a,this._execute=function(a){var b=a.render.ctab,c=b.molecule,d=new M.Struct.Fragment;null==this.frid?this.frid=c.frags.add(d):c.frags.set(this.frid,d),b.frags.set(this.frid,new N.ReFrag(d))},this._invert=function(){return new v(this.frid)}}function v(a){this.frid=a,this._execute=function(a){var b=a.render,c=b.ctab,d=c.molecule;b.invalidateItem("frags",this.frid,1),c.frags.unset(this.frid),d.frags.remove(this.frid)},this._invert=function(){return new u(this.frid)}}function w(a,b,c){this.data={rgid:a,attribute:b,value:c},this.data2=null,this._execute=function(a){var b=a.render.ctab.molecule.rgroups.get(this.data.rgid);this.data2||(this.data2={rgid:this.data.rgid,attribute:this.data.attribute,value:b[this.data.attribute]}),b[this.data.attribute]=this.data.value,a.render.invalidateItem("rgroups",this.data.rgid)},this._isDummy=function(a){return a.render.ctab.molecule.rgroups.get(this.data.rgid)[this.data.attribute]==this.data.value},this._invert=function(){var a=new w;return a.data=this.data2,a.data2=this.data,a}}function x(a,b,c){this.rgid_new=a,this.rg_new=c,this.rgid_old=null,this.rg_old=null,this.frid=b,this._execute=function(a){var b=a.render.ctab,c=b.molecule;if(this.rgid_old=this.rgid_old||M.Struct.RGroup.findRGroupByFragment(c.rgroups,this.frid),this.rg_old=this.rgid_old?c.rgroups.get(this.rgid_old):null,this.rg_old&&(this.rg_old.frags.remove(this.rg_old.frags.keyOf(this.frid)),b.clearVisel(b.rgroups.get(this.rgid_old).visel),0==this.rg_old.frags.count()?(b.rgroups.unset(this.rgid_old),c.rgroups.unset(this.rgid_old),b.markItemRemoved()):b.markItem("rgroups",this.rgid_old,1)),this.rgid_new){var d=c.rgroups.get(this.rgid_new);d?b.markItem("rgroups",this.rgid_new,1):(d=this.rg_new||new M.Struct.RGroup,c.rgroups.set(this.rgid_new,d),b.rgroups.set(this.rgid_new,new N.ReRGroup(d))),d.frags.add(this.frid)}},this._invert=function(){return new x(this.rgid_old,this.frid,this.rg_old)}}function y(a){this.data={arid:null,pos:a},this._execute=function(a){var b=a.render,c=b.ctab,d=c.molecule;Object.isNumber(this.data.arid)?d.rxnArrows.set(this.data.arid,new M.Struct.RxnArrow):this.data.arid=d.rxnArrows.add(new M.Struct.RxnArrow),c.notifyRxnArrowAdded(this.data.arid),d._rxnArrowSetPos(this.data.arid,new J(this.data.pos)),b.invalidateItem("rxnArrows",this.data.arid,1)},this._invert=function(){var a=new z;return a.data=this.data,a}}function z(a){this.data={arid:a,pos:null},this._execute=function(a){var b=a.render,c=b.ctab,d=c.molecule;this.data.pos||(this.data.pos=b.rxnArrowGetPos(this.data.arid)),c.notifyRxnArrowRemoved(this.data.arid),d.rxnArrows.remove(this.data.arid)},this._invert=function(){var a=new y;return a.data=this.data,a}}function A(a,b,c){this.data={id:a,d:b,noinvalidate:c},this._execute=function(a){var b=a.render,c=b.ctab,d=c.molecule,e=this.data.id,f=this.data.d;d.rxnArrows.get(e).pp.add_(f),c.rxnArrows.get(e).visel.translate(b.ps(f)),this.data.d=f.negated(),this.data.noinvalidate||a.render.invalidateItem("rxnArrows",e,1)},this._invert=function(){var a=new A;return a.data=this.data,a}}function B(a){this.data={plid:null,pos:a},this._execute=function(a){var b=a.render,c=b.ctab,d=c.molecule;Object.isNumber(this.data.plid)?d.rxnPluses.set(this.data.plid,new M.Struct.RxnPlus):this.data.plid=d.rxnPluses.add(new M.Struct.RxnPlus),c.notifyRxnPlusAdded(this.data.plid),d._rxnPlusSetPos(this.data.plid,new J(this.data.pos)),b.invalidateItem("rxnPluses",this.data.plid,1)},this._invert=function(){var a=new C;return a.data=this.data,a}}function C(a){this.data={plid:a,pos:null},this._execute=function(a){var b=a.render,c=b.ctab,d=c.molecule;this.data.pos||(this.data.pos=b.rxnPlusGetPos(this.data.plid)),c.notifyRxnPlusRemoved(this.data.plid),d.rxnPluses.remove(this.data.plid)},this._invert=function(){var a=new B;return a.data=this.data,a}}function D(a,b,c){this.data={id:a,d:b,noinvalidate:c},this._execute=function(a){var b=a.render,c=b.ctab,d=c.molecule,e=this.data.id,f=this.data.d;d.rxnPluses.get(e).pp.add_(f),c.rxnPluses.get(e).visel.translate(b.ps(f)),this.data.d=f.negated(),this.data.noinvalidate||a.render.invalidateItem("rxnPluses",e,1)},this._invert=function(){var a=new D;return a.data=this.data,a}}function E(a,b){this.data={id:a,d:b},this._execute=function(a){L.ctab.sgroups.get(this.data.id).pp.add_(this.data.d),this.data.d=this.data.d.negated(),a.render.invalidateItem("sgroupData",this.data.id,1)},this._invert=function(){var a=new E;return a.data=this.data,a}}function F(a){this.data={ctab:a,norescale:!1},this._execute=function(a){var b=a.render;b.ctab.clearVisels();var c=L.ctab;L.ctab=this.data.ctab,b.setMolecule(L.ctab,this.data.norescale),this.data.ctab=c,this.data.norescale=!0},this._invert=function(){var a=new F;return a.data=this.data,a}}function G(a){this.data={pos:a},this._execute=function(b){var c=b.render,d=c.ctab,e=d.molecule;if(d.chiralFlags.count()>0)throw new Error("Cannot add more than one Chiral flag");d.chiralFlags.set(0,new N.ReChiralFlag(a)),e.isChiral=!0,c.invalidateItem("chiralFlags",0,1)},this._invert=function(){var a=new H;return a.data=this.data,a}}function H(){this.data={pos:null},this._execute=function(a){var b=a.render,c=b.ctab,d=c.molecule;if(c.chiralFlags.count()<1)throw new Error("Cannot remove chiral flag");c.clearVisel(c.chiralFlags.get(0).visel),this.data.pos=c.chiralFlags.get(0).pp,c.chiralFlags.unset(0),d.isChiral=!1},this._invert=function(){var a=new G(this.data.pos);return a.data=this.data,a}}function I(a){this.data={d:a},this._execute=function(a){var b=a.render,c=b.ctab;c.chiralFlags.get(0).pp.add_(this.data.d),this.data.d=this.data.d.negated(),b.invalidateItem("chiralFlags",0,1)},this._invert=function(){var a=new I;return a.data=this.data,a}}var J=a("../util/vec2"),K=a("../util/set");a("../chem"),a("../rnd");var L=c.ui,M=c.chem,N=c.rnd;e.prototype=new d,f.prototype=new d,g.prototype=new d,h.prototype=new d,i.prototype=new d,j.prototype=new d,k.prototype=new d,l.prototype=new d,m.prototype=new d,n.prototype=new d,o.prototype=new d,p.prototype=new d,q.prototype=new d,r.prototype=new d,s.prototype=new d,t.prototype=new d,u.prototype=new d,v.prototype=new d,w.prototype=new d,x.prototype=new d,y.prototype=new d,z.prototype=new d,A.prototype=new d,B.prototype=new d,C.prototype=new d,D.prototype=new d,E.prototype=new d,F.prototype=new d,G.prototype=new d,H.prototype=new d,I.prototype=new d,b.exports={AtomAdd:e,AtomDelete:f,AtomAttr:g,AtomMove:h,BondMove:i,LoopMove:j,SGroupAtomAdd:k,SGroupAtomRemove:l,SGroupAttr:m,SGroupCreate:n,SGroupDelete:o,SGroupAddToHierarchy:p,SGroupRemoveFromHierarchy:q,BondAdd:r,BondDelete:s,BondAttr:t,FragmentAdd:u,FragmentDelete:v,RGroupAttr:w,RGroupFragment:x,RxnArrowAdd:y,RxnArrowDelete:z,RxnArrowMove:A,RxnPlusAdd:B,RxnPlusDelete:C,RxnPlusMove:D,SGroupDataMove:E,CanvasLoad:F,ChiralFlagAdd:G,ChiralFlagDelete:H,ChiralFlagMove:I}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../chem":11,"../rnd":21,"../util/set":42,"../util/vec2":43}],36:[function(a,b,c){b.exports=[{name:"benzene",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  6  6  0     0  0            999 V2000\n    0.8660    2.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7320    1.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7320    0.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.8660    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    0.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    1.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  2  3  2  0     0  0\n  3  4  1  0     0  0\n  4  5  2  0     0  0\n  5  6  1  0     0  0\n  6  1  2  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclopentadiene",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  5  5  0     0  0            999 V2000\n    0.0000    1.4257    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.8090    0.8379    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.5000   -0.1132    0.0000 C   0  0  0  0  0  0        0  0  0\n   -0.5000   -0.1132    0.0000 C   0  0  0  0  0  0        0  0  0\n   -0.8090    0.8379    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  2  3  2  0     0  0\n  3  4  1  0     0  0\n  4  5  2  0     0  0\n  5  1  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclohexane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  6  6  0     0  0            999 V2000\n    0.8660    2.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7320    1.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7320    0.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.8660    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    0.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    1.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  2  3  1  0     0  0\n  3  4  1  0     0  0\n  4  5  1  0     0  0\n  5  6  1  0     0  0\n  6  1  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclopentane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  5  5  0     0  0            999 V2000\n    0.8090    1.5389    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.6180    0.9511    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.3090    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.3090    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    0.9511    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  2  3  1  0     0  0\n  3  4  1  0     0  0\n  4  5  1  0     0  0\n  5  1  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclopropane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  3  3  0     0  0            999 V2000\n   -3.2250   -0.2750    0.0000 C   0  0  0  0  0  0        0  0  0\n   -2.2250   -0.2750    0.0000 C   0  0  0  0  0  0        0  0  0\n   -2.7250    0.5910    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  2  3  1  0     0  0\n  1  3  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclobutane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  4  4  0     0  0            999 V2000\n   -3.8250    1.5500    0.0000 C   0  0  0  0  0  0        0  0  0\n   -3.8250    0.5500    0.0000 C   0  0  0  0  0  0        0  0  0\n   -2.8250    1.5500    0.0000 C   0  0  0  0  0  0        0  0  0\n   -2.8250    0.5500    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  1  3  1  0     0  0\n  3  4  1  0     0  0\n  4  2  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cycloheptane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  7  7  0     0  0            999 V2000\n    0.0000    1.6293    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.7835    2.2465    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7559    2.0242    0.0000 C   0  0  0  0  0  0        0  0  0\n    2.1897    1.1289    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    0.6228    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7566    0.2224    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.7835    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n  6  7  1  0     0  0\n  5  7  1  0     0  0\n  1  5  1  0     0  0\n  4  6  1  0     0  0\n  3  4  1  0     0  0\n  2  3  1  0     0  0\n  1  2  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclooctane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  8  8  0     0  0            999 V2000\n    0.0000    0.7053    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    1.7078    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.7053    2.4131    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.7056    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7079    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    2.4133    0.7053    0.0000 C   0  0  0  0  0  0        0  0  0\n    2.4133    1.7078    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7079    2.4131    0.0000 C   0  0  0  0  0  0        0  0  0\n  8  3  1  0     0  0\n  7  8  1  0     0  0\n  6  7  1  0     0  0\n  5  6  1  0     0  0\n  4  5  1  0     0  0\n  1  4  1  0     0  0\n  2  3  1  0     0  0\n  1  2  1  0     0  0\nM  END\n",bid:0,aid:0}]},{}],37:[function(a,b,c){function d(a,b){var c=h(),d=a.headers||{};c.open(a.method,a.url,!!b,a.user,a.password);for(var e in d)d.hasOwnProperty(e)&&c.setRequestHeader(e,d[e]);if("function"==typeof a.config){var f=a.config(c,a);void 0!==f&&(c=f)}return a.timeout>0&&setTimeout(function(){c.status=-1,c.abort()},a.timeout),b&&(c.onreadystatechange=function(){4===c.readyState&&b(c)}),c.send(a.data),c}function e(a){return a.status>=200&&a.status<300}function f(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")}function g(a){var b=j.extend({method:"GET",headers:{},timeout:6e3},j.isObject(a)?a:{url:a});if(j.isObject(b.data)&&(b.data=JSON.stringify(b.data),b.headers["Content-Type"]="application/json; charset=utf-8"),b.params&&(b.url=b.url+(b.url.indexOf("?")<0?"?":"&")+f(b.params)),!b.sync)return new i(function(a,c){d(b,function(b){var d=e(b)?a:c;d(b)})});var c=d(b);if(!e(c))throw c;return c}var h=a("xhrpolyfill"),i=a("promise-polyfill"),j=a("./index.js");b.exports=g},{"./index.js":39,"promise-polyfill":3,xhrpolyfill:6}],38:[function(a,b,c){var d=a("./index"),e=a("./vec2"),f=function(){1==arguments.length&&"min"in arguments[0]&&"max"in arguments[0]&&(this.p0=arguments[0].min,this.p1=arguments[0].max),2==arguments.length&&arguments[0]instanceof e&&arguments[1]instanceof e?(this.p0=arguments[0],this.p1=arguments[1]):4==arguments.length?(this.p0=new e(arguments[0],arguments[1]),this.p1=new e(arguments[2],arguments[3])):0==arguments.length?(this.p0=new e,this.p1=new e):new Error("Box2Abs constructor only accepts 4 numbers or 2 vectors or no arguments!")};f.prototype.toString=function(){return this.p0.toString()+" "+this.p1.toString()},f.fromRelBox=function(a){return d.assertDefined(a),new f(a.x,a.y,a.x+a.width,a.y+a.height)},f.prototype.clone=function(){return new f(this.p0,this.p1)},f.union=function(a,b){return d.assertDefined(a),d.assertDefined(b),new f(e.min(a.p0,b.p0),e.max(a.p1,b.p1))},f.prototype.extend=function(a,b){return d.assertDefined(a),b=b||a,new f(this.p0.sub(a),this.p1.add(b))},f.prototype.include=function(a){return d.assertDefined(a),new f(this.p0.min(a),this.p1.max(a))},f.prototype.contains=function(a,b){return b=(b||0)-0,d.assertDefined(a),a.x>=this.p0.x-b&&a.x<=this.p1.x+b&&a.y>=this.p0.y-b&&a.y<=this.p1.y+b},f.prototype.translate=function(a){return d.assertDefined(a),new f(this.p0.add(a),this.p1.add(a))},f.prototype.transform=function(a,b){return d.assert(!d.isNullOrUndefined(a)),new f(a.call(b,this.p0),a.call(b,this.p1))},f.prototype.sz=function(){return this.p1.sub(this.p0)},f.prototype.centre=function(){return e.centre(this.p0,this.p1)},f.prototype.pos=function(){return this.p0},b.exports=f},{"./index":39,"./vec2":43}],39:[function(a,b,c){function d(a,b){for(var c=0;c<a.length;c++)if(b(a[c],c,a))return a[c]}function e(a,b,c){for(var d=0;d<a.length;++d)if(b.call(c,a[d],d))return d;return-1}function f(a){return a.replace(t,"\n")}function g(a){return a.split(t)}function h(a){function b(a,b){for(var c=a.toString(16).toUpperCase();c.length<b;)c="0"+c;return c}var c,d="";for(c=0;c<a.length;++c)d+=a.charCodeAt(c)>126||a.charCodeAt(c)<32?"\\u"+b(a.charCodeAt(c),4):a[c];return d}Array.prototype.swap=function(a,b){var c=this[a];this[a]=this[b],this[b]=c};var i=function(a){return(a-0).toFixed(8)},j=function(a,b,c){J(!N(a),"array must be defined");for(var d=0;d<a.length;++d)b.call(c,a[d],d)},l=function(a,b,c){var d,e=[];for(d=0;d<a.length;++d)b.call(c,a[d],d)&&e.push(a[d]);return e},m=function(a){for(var b=[],c=a.length;--c>=0;)b[c]=a[c];return b},n=function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},o=function(a){if("stopPropagation"in a)a.stopPropagation();else{if(!("cancelBubble"in a))throw Error("Browser unrecognized");a.cancelBubble=!0}},p=function(a){return"preventDefault"in a&&a.preventDefault(),Prototype.Browser.IE&&(a.returnValue=!1,a.keyCode=0),!1},q=function(a,b){if("textContent"in a)a.textContent=b;else{if(!("innerText"in a))throw Error("Browser unrecognized");a.innerText=b}},r=function(a){if("textContent"in a)return a.textContent;if("innerText"in a)return a.innerText;throw Error("Browser unrecognized")},s=function(a,b,c){for(var d=a+"",e="";d.length+e.length<b;)e+=" ";return c?a+e:e+a},t=/\r\n|[\n\r]/g,u=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b},v=function(a,b){for(var c=[],d=0;d<a.length;++d)c.push(b[a[d]]);return c},w=function(a){return Math.max.apply(Math,a)},x=function(a){return Math.min.apply(Math,a)},y=function(a,b,c){for(var d=[],e=0;e<a.length;++e)d.push(b.call(c,a[e]));return d},z=function(a,b){for(var c=0;c<a.length;++c)a[c]=b(a[c])},A=function(a,b,c,d){a[c]=Object.isUndefined(b[c])?d:b[c]},B=function(a,b,c,d){a[c]=Object.isUndefined(b[c])||null===b[c]?d:m(b[c])},C=function(a){for(var b={},c=0;c<a.length;++c)b[a[c]]=a[c];return b},D=function(a){return a.replace(/\s*$/,"").replace(/^\s*/,"")},E=function(a){return a.replace(/\s*$/,"")},F=function(a){return'"'===a[0]&&'"'===a[a.length-1]?a.substr(1,a.length-2):a},G=function(a,b,c){var d=a.toFixed(c).replace(",",".");if(d.length>b)throw new Error("number does not fit");return s(d,b)},H=function(a,b){var c=a.toFixed(0);if(c.length>b)throw new Error("number does not fit");return s(c,b)},I=function(a,b){for(var c=0;c<a.length;++c)if(a[c]===b)return!1;return a.push(b),!0},J=function(a,b){if(!a)throw new Error(b?"Assertion failed: "+b:"Assertion failed")},K=function(a){J(!N(a))},L=function(a){return Object.isUndefined(a)},M=function(a){return null===a},N=function(a){return L(a)||M(a)},O=function(a,b){J(!L(a)&&!M(a),"array must be defined");for(var c=a.indexOf(b),d=0;c>=0;)a.splice(c,1),d+=1,c=a.indexOf(b);return d},P=function(a,b){return a[(a.indexOf(b)+1)%a.length]},Q=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},R=function(a){return a===Object(a)};b.exports={tfx:i,each:j,find:d,findIndex:e,findAll:l,array:m,isEmpty:n,stopEventPropagation:o,preventDefault:p,setElementTextContent:q,getElementTextContent:r,stringPadded:s,normalizeNewlines:f,splitNewlines:g,unicodeLiteral:h,idList:u,mapArray:v,arrayMax:w,arrayMin:x,map:y,apply:z,ifDef:A,ifDefList:B,identityMap:C,strip:D,stripRight:E,stripQuotes:F,paddedFloat:G,paddedInt:H,arrayAddIfMissing:I,assert:J,assertDefined:K,isUndefined:L,isNull:M,isNullOrUndefined:N,arrayRemoveByValue:O,listNextRotate:P,extend:Q,isObject:R}},{}],40:[function(a,b,c){var d=a("./index"),e=function(a){if("undefined"!=typeof a&&a.constructor!==Object)throw Error('Passed object is not an instance of "Object"!');this._obj=a||{},this._count=0};e.prototype.each=function(a,b){var c,d,e;for(c in this._obj)e=parseInt(c,10),d=this._obj[c],isNaN(e)||(c=e),a.call(b,c,d)},e.prototype.map=function(a,b){var c=new e;return this.each(function(d,e){c.set(d,a.call(b,d,e))},this),c},e.prototype.find=function(a,b){var c,d,e;for(c in this._obj)if(d=parseInt(c,10),e=this._obj[c],isNaN(d)||(c=d),a.call(b,c,e))return c},e.prototype.findAll=function(a,b){var c,d,e,f=[];for(c in this._obj)d=parseInt(c,10),e=this._obj[c],isNaN(d)||(c=d),a.call(b,c,e)&&f.push(c);return f},e.prototype.keys=function(){var a,b=[];for(a in this._obj)b.push(a);return b},e.prototype.ikeys=function(){var a=[];for(var b in this._obj)a.push(b-0);return a},e.prototype.set=function(a,b){var c;return this._count+=("undefined"!=typeof b?1:0)-("undefined"!=typeof this._obj[a]?1:0),"undefined"==typeof b?(c=this._obj[a],delete this._obj[a],c):(this._obj[a]=b,b)},e.prototype.get=function(a){return this._obj[a]!==Object.prototype[a]?this._obj[a]:void 0},e.prototype.has=function(a){return this._obj[a]!==Object.prototype[a]},e.prototype.unset=function(a){return this.set(a,void 0)},e.prototype.update=function(a){for(var b in a)this.set(b,a[b])},e.prototype.clear=function(){this._obj={},this._count=0},e.prototype.count=function(){return this._count},e.prototype.idList=function(){return d.idList(this._obj)},e.prototype.keyOf=function(a){for(var b in this._obj)if(this._obj[b]===a)return b},b.exports=e},{"./index":39}],41:[function(a,b,c){var d=a("./map.js"),e=function(){this._map=new d,this._nextId=0};e.prototype.newId=function(){return this._nextId++},e.prototype.add=function(a){var b=this._nextId++;return this._map.set(b,a),b},e.prototype.set=function(a,b){this._map.set(a,b)},e.prototype.get=function(a){return this._map.get(a)},e.prototype.has=function(a){return this._map.has(a)},e.prototype.remove=function(a){return this._map.unset(a)},e.prototype.clear=function(){this._map.clear()},e.prototype.keys=function(){return this._map.keys()},e.prototype.ikeys=function(){return this._map.ikeys()},e.prototype.each=function(a,b){this._map.each(a,b)},e.prototype.map=function(a,b){return this._map.map(a,b)},e.prototype.find=function(a,b){return this._map.find(a,b)},e.prototype.count=function(){return this._map.count()},e.prototype.keyOf=function(a){return this._map.keyOf(a)},b.exports=e},{"./map.js":40}],42:[function(a,b,c){var d={empty:function(){return{}},single:function(a){var b={};return d.add(b,a),b},size:function(a){var b=0;for(var c in a)a[c]!==Object.prototype[c]&&b++;return b},contains:function(a,b){return"undefined"!=typeof a[b]&&a[b]!==Object.prototype[b]},subset:function(a,b){for(var c in a)if(a[c]!==Object.prototype[c]&&b[c]!==a[c])return!1;return!0},intersection:function(a,b){var c={};for(var e in a)a[e]!==Object.prototype[e]&&b[e]===a[e]&&d.add(c,e);return c},disjoint:function(a,b){for(var c in a)if(a[c]!==Object.prototype[c]&&b[c]===a[c])return!1;return!0},eq:function(a,b){return d.subset(a,b)&&d.subset(b,a)},each:function(a,b,c){for(var d in a)a[d]!==Object.prototype[d]&&b.call(c,a[d])},filter:function(a,b,c){var d={};for(var e in a)a[e]!==Object.prototype[e]&&b.call(c,a[e])&&(d[a[e]]=a[e]);return d},pick:function(a){for(var b in a)if(a[b]!==Object.prototype[b])return a[b];return null},list:function(a){var b=[];for(var c in a)a[c]!==Object.prototype[c]&&b.push(a[c]);return b},add:function(a,b){a[b]=b},mergeIn:function(a,b){d.each(b,function(b){d.add(a,b)})},remove:function(a,b){var c=a[b];return delete a[b],c},clone:function(a){var b={};return d.mergeIn(b,a),b},fromList:function(a){var b={};if(a)for(var c=0;c<a.length;++c)b[a[c]-0]=a[c]-0;return b},keySetInt:function(a){var b={};return a.each(function(a){b[a-0]=a-0}),b},find:function(a,b,c){for(var d in a)if(a[d]!==Object.prototype[d]&&b.call(c,a[d]))return d;return null}};b.exports=d},{}],43:[function(a,b,c){var d=a("./index"),e=function(a,b){if(0==arguments.length)this.x=0,this.y=0;else if(1==arguments.length)this.x=parseFloat(a.x),this.y=parseFloat(a.y);else{if(2!=arguments.length)throw new Error("Vec2(): invalid arguments");this.x=parseFloat(a),this.y=parseFloat(b)}};e.ZERO=new e(0,0),e.UNIT=new e(1,1),e.segmentIntersection=function(a,b,c,d){var e=(a.x-c.x)*(b.y-c.y)-(a.y-c.y)*(b.x-c.x),f=(a.x-d.x)*(b.y-d.y)-(a.y-d.y)*(b.x-d.x),g=(c.x-a.x)*(d.y-a.y)-(c.y-a.y)*(d.x-a.x),h=(c.x-b.x)*(d.y-b.y)-(c.y-b.y)*(d.x-b.x);return 0>=e*f&&0>=g*h},e.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},e.prototype.equals=function(a){return d.assertDefined(a),this.x==a.x&&this.y==a.y},e.prototype.add=function(a){return d.assertDefined(a),new e(this.x+a.x,this.y+a.y)},e.prototype.add_=function(a){d.assertDefined(a),this.x+=a.x,this.y+=a.y},e.prototype.sub=function(a){return d.assertDefined(a),new e(this.x-a.x,this.y-a.y)},e.prototype.scaled=function(a){return d.assertDefined(a),new e(this.x*a,this.y*a)},e.prototype.negated=function(){return new e(-this.x,-this.y)},e.prototype.yComplement=function(a){return a=a||0,new e(this.x,a-this.y)},e.prototype.addScaled=function(a,b){return d.assertDefined(a),d.assertDefined(b),new e(this.x+a.x*b,this.y+a.y*b)},e.prototype.normalized=function(){return this.scaled(1/this.length())},e.prototype.normalize=function(){var a=this.length();return!(1e-6>a)&&(this.x/=a,this.y/=a,!0)},e.prototype.turnLeft=function(){return new e(-this.y,this.x)},e.prototype.coordStr=function(){return this.x.toString()+" , "+this.y.toString()},e.prototype.toString=function(){return"("+this.x.toFixed(2)+","+this.y.toFixed(2)+")"},e.dist=function(a,b){return d.assertDefined(a),d.assertDefined(b),e.diff(a,b).length()},e.max=function(a,b){return d.assertDefined(a),d.assertDefined(b),new e(Math.max(a.x,b.x),Math.max(a.y,b.y))},e.min=function(a,b){return d.assertDefined(a),d.assertDefined(b),new e(Math.min(a.x,b.x),Math.min(a.y,b.y))},e.prototype.max=function(a){return d.assertDefined(a),new e.max(this,a)},e.prototype.min=function(a){return d.assertDefined(a),new e.min(this,a)},e.prototype.ceil=function(){return new e(Math.ceil(this.x),Math.ceil(this.y))},e.prototype.floor=function(){return new e(Math.floor(this.x),Math.floor(this.y))},e.sum=function(a,b){return d.assertDefined(a),d.assertDefined(b),new e(a.x+b.x,a.y+b.y)},e.dot=function(a,b){return d.assertDefined(a),d.assertDefined(b),a.x*b.x+a.y*b.y},e.cross=function(a,b){return d.assertDefined(a),d.assertDefined(b),a.x*b.y-a.y*b.x},e.prototype.rotate=function(a){d.assertDefined(a);var b=Math.sin(a),c=Math.cos(a);return this.rotateSC(b,c)},e.prototype.rotateSC=function(a,b){return d.assertDefined(a),d.assertDefined(b),new e(this.x*b-this.y*a,this.x*a+this.y*b)},e.angle=function(a,b){return d.assertDefined(a),d.assertDefined(b),Math.atan2(e.cross(a,b),e.dot(a,b))},e.prototype.oxAngle=function(){return Math.atan2(this.y,this.x)},e.diff=function(a,b){return d.assertDefined(a),d.assertDefined(b),new e(a.x-b.x,a.y-b.y)},e.lc=function(){for(var a=new e,b=0;b<arguments.length/2;++b)a=a.addScaled(arguments[2*b],arguments[2*b+1]);return a},e.lc2=function(a,b,c,f){return d.assertDefined(a),d.assertDefined(c),d.assertDefined(b),d.assertDefined(f),new e(a.x*b+c.x*f,a.y*b+c.y*f)},e.centre=function(a,b){return new e.lc2(a,.5,b,.5)},e.shiftRayBox=function(a,b,c){d.assertDefined(a),d.assertDefined(b),d.assertDefined(c);var f=[c.p0,new e(c.p1.x,c.p0.y),c.p1,new e(c.p0.x,c.p1.y)],g=f.map(function(b){return b.sub(a)});b=b.normalized();for(var h=g.map(function(a){return e.cross(a,b)}),i=g.map(function(a){return e.dot(a,b)}),j=-1,k=-1,l=0;4>l;++l)h[l]>0?(0>j||i[j]<i[l])&&(j=l):(0>k||i[k]<i[l])&&(k=l);if(0>k||0>j)return 0;var m,n;return i[j]>i[k]?(m=k,n=j):(m=j,n=k),i[m]+Math.abs(h[m])*(i[n]-i[m])/(Math.abs(h[m])+Math.abs(h[n]))},b.exports=e},{"./index":39}]},{},[18])(18)});