function $A(t){if(!t)return[];if("toArray"in Object(t))return t.toArray();for(var e=t.length||0,i=new Array(e);e--;)i[e]=t[e];return i}function $w(t){return Object.isString(t)?(t=t.strip(),t?t.split(/\s+/):[]):[]}function $H(t){return new Hash(t)}function $R(t,e,i){return new ObjectRange(t,e,i)}function $(t){if(arguments.length>1){for(var e=0,i=[],n=arguments.length;n>e;e++)i.push($(arguments[e]));return i}return Object.isString(t)&&(t=document.getElementById(t)),Element.extend(t)}function hexToRGB(t){return{r:parseInt(t.substring(1,3),16),g:parseInt(t.substring(3,5),16),b:parseInt(t.substring(5,7),16)}}function rgbCompToHex(t){t=t.toFixed(),t=Math.max(Math.min(t,255),0);var e=t.toString(16);return e.length<2&&(e="0"+e),e}function rgbToHex(t){return"#"+rgbCompToHex(t.r)+rgbCompToHex(t.g)+rgbCompToHex(t.b)}function rgbRescale(t,e){var i=.21*t.r+.72*t.g+.07*t.b;return e>=i?t:{r:(t.r*e/i).toFixed()-0,g:(t.g*e/i).toFixed()-0,b:(t.b*e/i).toFixed()-0}}function tfx(t){return(t-0).toFixed(8)}var Prototype={Version:"1.7",Browser:function(){var t=navigator.userAgent,e="[object Opera]"==Object.prototype.toString.call(window.opera);return{IE:!!window.attachEvent&&!e,Opera:e,WebKit:t.indexOf("AppleWebKit/")>-1,Gecko:t.indexOf("Gecko")>-1&&-1===t.indexOf("KHTML"),MobileSafari:/Apple.*Mobile/.test(t)}}(),BrowserFeatures:{XPath:!!document.evaluate,SelectorsAPI:!!document.querySelector,ElementExtensions:function(){var t=window.Element||window.HTMLElement;return!(!t||!t.prototype)}(),SpecificElementExtensions:function(){if("undefined"!=typeof window.HTMLDivElement)return!0;var t=document.createElement("div"),e=document.createElement("form"),i=!1;return t.__proto__&&t.__proto__!==e.__proto__&&(i=!0),t=e=null,i}()},ScriptFragment:"<script[^>]*>([\\S\\s]*?)</script>",JSONFilter:/^\/\*-secure-([\s\S]*)\*\/\s*$/,emptyFunction:function(){},K:function(t){return t}};Prototype.Browser.MobileSafari&&(Prototype.BrowserFeatures.SpecificElementExtensions=!1);var Abstract={},Try={these:function(){for(var t,e=0,i=arguments.length;i>e;e++){var n=arguments[e];try{t=n();break}catch(r){}}return t}},Class=function(){function t(){}function e(){function e(){this.initialize.apply(this,arguments)}var i=null,n=$A(arguments);Object.isFunction(n[0])&&(i=n.shift()),Object.extend(e,Class.Methods),e.superclass=i,e.subclasses=[],i&&(t.prototype=i.prototype,e.prototype=new t,i.subclasses.push(e));for(var r=0,o=n.length;o>r;r++)e.addMethods(n[r]);return e.prototype.initialize||(e.prototype.initialize=Prototype.emptyFunction),e.prototype.constructor=e,e}function i(t){var e=this.superclass&&this.superclass.prototype,i=Object.keys(t);n&&(t.toString!=Object.prototype.toString&&i.push("toString"),t.valueOf!=Object.prototype.valueOf&&i.push("valueOf"));for(var r=0,o=i.length;o>r;r++){var s=i[r],a=t[s];if(e&&Object.isFunction(a)&&"$super"==a.argumentNames()[0]){var l=a;a=function(t){return function(){return e[t].apply(this,arguments)}}(s).wrap(l),a.valueOf=l.valueOf.bind(l),a.toString=l.toString.bind(l)}this.prototype[s]=a}return this}var n=function(){for(var t in{toString:1})if("toString"===t)return!1;return!0}();return{create:e,Methods:{addMethods:i}}}();!function(){function t(t){switch(t){case null:return w;case void 0:return S}var e=typeof t;switch(e){case"boolean":return x;case"number":return _;case"string":return A}return E}function e(t,e){for(var i in e)t[i]=e[i];return t}function i(t){try{return v(t)?"undefined":null===t?"null":t.inspect?t.inspect():String(t)}catch(e){if(e instanceof RangeError)return"...";throw e}}function n(t){return r("",{"":t},[])}function r(e,i,n){var o=i[e],s=typeof o;t(o)===E&&"function"==typeof o.toJSON&&(o=o.toJSON(e));var a=y.call(o);switch(a){case T:case C:case B:o=o.valueOf()}switch(o){case null:return"null";case!0:return"true";case!1:return"false"}switch(s=typeof o){case"string":return o.inspect(!0);case"number":return isFinite(o)?String(o):"null";case"object":for(var l=0,u=n.length;u>l;l++)if(n[l]===o)throw new TypeError;n.push(o);var c=[];if(a===R){for(var l=0,u=o.length;u>l;l++){var h=r(l,o,n);c.push("undefined"==typeof h?"null":h)}c="["+c.join(",")+"]"}else{for(var d=Object.keys(o),l=0,u=d.length;u>l;l++){var e=d[l],h=r(e,o,n);"undefined"!=typeof h&&c.push(e.inspect(!0)+":"+h)}c="{"+c.join(",")+"}"}return n.pop(),c}}function o(t){return JSON.stringify(t)}function s(t){return $H(t).toQueryString()}function a(t){return t&&t.toHTML?t.toHTML():String.interpret(t)}function l(e){if(t(e)!==E)throw new TypeError;var i=[];for(var n in e)e.hasOwnProperty(n)&&i.push(n);return i}function u(t){var e=[];for(var i in t)e.push(t[i]);return e}function c(t){return e({},t)}function h(t){return!(!t||1!=t.nodeType)}function d(t){return y.call(t)===R}function p(t){return t instanceof Hash}function f(t){return y.call(t)===O}function m(t){return y.call(t)===B}function g(t){return y.call(t)===T}function b(t){return y.call(t)===M}function v(t){return"undefined"==typeof t}var y=Object.prototype.toString,w="Null",S="Undefined",x="Boolean",_="Number",A="String",E="Object",O="[object Function]",C="[object Boolean]",T="[object Number]",B="[object String]",R="[object Array]",M="[object Date]",P=window.JSON&&"function"==typeof JSON.stringify&&"0"===JSON.stringify(0)&&"undefined"==typeof JSON.stringify(Prototype.K),N="function"==typeof Array.isArray&&Array.isArray([])&&!Array.isArray({});N&&(d=Array.isArray),e(Object,{extend:e,inspect:i,toJSON:P?o:n,toQueryString:s,toHTML:a,keys:Object.keys||l,values:u,clone:c,isElement:h,isArray:d,isHash:p,isFunction:f,isString:m,isNumber:g,isDate:b,isUndefined:v})}(),Object.extend(Function.prototype,function(){function t(t,e){for(var i=t.length,n=e.length;n--;)t[i+n]=e[n];return t}function e(e,i){return e=c.call(e,0),t(e,i)}function i(){var t=this.toString().match(/^[\s\(]*function[^(]*\(([^)]*)\)/)[1].replace(/\/\/.*?[\r\n]|\/\*(?:.|[\r\n])*?\*\//g,"").replace(/\s+/g,"").split(",");return 1!=t.length||t[0]?t:[]}function n(t){if(arguments.length<2&&Object.isUndefined(arguments[0]))return this;var i=this,n=c.call(arguments,1);return function(){var r=e(n,arguments);return i.apply(t,r)}}function r(e){var i=this,n=c.call(arguments,1);return function(r){var o=t([r||window.event],n);return i.apply(e,o)}}function o(){if(!arguments.length)return this;var t=this,i=c.call(arguments,0);return function(){var n=e(i,arguments);return t.apply(this,n)}}function s(t){var e=this,i=c.call(arguments,1);return t=1e3*t,window.setTimeout(function(){return e.apply(e,i)},t)}function a(){var e=t([.01],arguments);return this.delay.apply(this,e)}function l(e){var i=this;return function(){var n=t([i.bind(this)],arguments);return e.apply(this,n)}}function u(){if(this._methodized)return this._methodized;var e=this;return this._methodized=function(){var i=t([this],arguments);return e.apply(null,i)}}var c=Array.prototype.slice;return{argumentNames:i,bind:n,bindAsEventListener:r,curry:o,delay:s,defer:a,wrap:l,methodize:u}}()),function(t){function e(){return this.getUTCFullYear()+"-"+(this.getUTCMonth()+1).toPaddedString(2)+"-"+this.getUTCDate().toPaddedString(2)+"T"+this.getUTCHours().toPaddedString(2)+":"+this.getUTCMinutes().toPaddedString(2)+":"+this.getUTCSeconds().toPaddedString(2)+"Z"}function i(){return this.toISOString()}t.toISOString||(t.toISOString=e),t.toJSON||(t.toJSON=i)}(Date.prototype),RegExp.prototype.match=RegExp.prototype.test,RegExp.escape=function(t){return String(t).replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1")};var PeriodicalExecuter=Class.create({initialize:function(t,e){this.callback=t,this.frequency=e,this.currentlyExecuting=!1,this.registerCallback()},registerCallback:function(){this.timer=setInterval(this.onTimerEvent.bind(this),1e3*this.frequency)},execute:function(){this.callback(this)},stop:function(){this.timer&&(clearInterval(this.timer),this.timer=null)},onTimerEvent:function(){if(!this.currentlyExecuting)try{this.currentlyExecuting=!0,this.execute(),this.currentlyExecuting=!1}catch(t){throw this.currentlyExecuting=!1,t}}});Object.extend(String,{interpret:function(t){return null==t?"":String(t)},specialChar:{"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r","\\":"\\\\"}}),Object.extend(String.prototype,function(){function prepareReplacement(t){if(Object.isFunction(t))return t;var e=new Template(t);return function(t){return e.evaluate(t)}}function gsub(t,e){var i,n="",r=this;if(e=prepareReplacement(e),Object.isString(t)&&(t=RegExp.escape(t)),!t.length&&!t.source)return e=e(""),e+r.split("").join(e)+e;for(;r.length>0;)(i=r.match(t))?(n+=r.slice(0,i.index),n+=String.interpret(e(i)),r=r.slice(i.index+i[0].length)):(n+=r,r="");return n}function sub(t,e,i){return e=prepareReplacement(e),i=Object.isUndefined(i)?1:i,this.gsub(t,function(t){return--i<0?t[0]:e(t)})}function scan(t,e){return this.gsub(t,e),String(this)}function truncate(t,e){return t=t||30,e=Object.isUndefined(e)?"...":e,this.length>t?this.slice(0,t-e.length)+e:String(this)}function strip(){return this.replace(/^\s+/,"").replace(/\s+$/,"")}function stripTags(){return this.replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi,"")}function stripScripts(){return this.replace(new RegExp(Prototype.ScriptFragment,"img"),"")}function extractScripts(){var t=new RegExp(Prototype.ScriptFragment,"img"),e=new RegExp(Prototype.ScriptFragment,"im");return(this.match(t)||[]).map(function(t){return(t.match(e)||["",""])[1]})}function evalScripts(){return this.extractScripts().map(function(script){return eval(script)})}function escapeHTML(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function unescapeHTML(){return this.stripTags().replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")}function toQueryParams(t){var e=this.strip().match(/([^?#]*)(#.*)?$/);return e?e[1].split(t||"&").inject({},function(t,e){if((e=e.split("="))[0]){var i=decodeURIComponent(e.shift()),n=e.length>1?e.join("="):e[0];void 0!=n&&(n=decodeURIComponent(n)),i in t?(Object.isArray(t[i])||(t[i]=[t[i]]),t[i].push(n)):t[i]=n}return t}):{}}function toArray(){return this.split("")}function succ(){return this.slice(0,this.length-1)+String.fromCharCode(this.charCodeAt(this.length-1)+1)}function times(t){return 1>t?"":new Array(t+1).join(this)}function camelize(){return this.replace(/-+(.)?/g,function(t,e){return e?e.toUpperCase():""})}function capitalize(){return this.charAt(0).toUpperCase()+this.substring(1).toLowerCase()}function underscore(){return this.replace(/::/g,"/").replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").replace(/-/g,"_").toLowerCase()}function dasherize(){return this.replace(/_/g,"-")}function inspect(t){var e=this.replace(/[\x00-\x1f\\]/g,function(t){return t in String.specialChar?String.specialChar[t]:"\\u00"+t.charCodeAt().toPaddedString(2,16)});return t?'"'+e.replace(/"/g,'\\"')+'"':"'"+e.replace(/'/g,"\\'")+"'"}function unfilterJSON(t){return this.replace(t||Prototype.JSONFilter,"$1")}function isJSON(){var t=this;return t.blank()?!1:(t=t.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@"),t=t.replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]"),t=t.replace(/(?:^|:|,)(?:\s*\[)+/g,""),/^[\],:{}\s]*$/.test(t))}function evalJSON(sanitize){var json=this.unfilterJSON(),cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;cx.test(json)&&(json=json.replace(cx,function(t){return"\\u"+("0000"+t.charCodeAt(0).toString(16)).slice(-4)}));try{if(!sanitize||json.isJSON())return eval("("+json+")")}catch(e){}throw new SyntaxError("Badly formed JSON string: "+this.inspect())}function parseJSON(){var t=this.unfilterJSON();return JSON.parse(t)}function include(t){return this.indexOf(t)>-1}function startsWith(t){return 0===this.lastIndexOf(t,0)}function endsWith(t){var e=this.length-t.length;return e>=0&&this.indexOf(t,e)===e}function empty(){return""==this}function blank(){return/^\s*$/.test(this)}function interpolate(t,e){return new Template(this,e).evaluate(t)}var NATIVE_JSON_PARSE_SUPPORT=window.JSON&&"function"==typeof JSON.parse&&JSON.parse('{"test": true}').test;return{gsub:gsub,sub:sub,scan:scan,truncate:truncate,strip:String.prototype.trim||strip,stripTags:stripTags,stripScripts:stripScripts,extractScripts:extractScripts,evalScripts:evalScripts,escapeHTML:escapeHTML,unescapeHTML:unescapeHTML,toQueryParams:toQueryParams,parseQuery:toQueryParams,toArray:toArray,succ:succ,times:times,camelize:camelize,capitalize:capitalize,underscore:underscore,dasherize:dasherize,inspect:inspect,unfilterJSON:unfilterJSON,isJSON:isJSON,evalJSON:NATIVE_JSON_PARSE_SUPPORT?parseJSON:evalJSON,include:include,startsWith:startsWith,endsWith:endsWith,empty:empty,blank:blank,interpolate:interpolate}}());var Template=Class.create({initialize:function(t,e){this.template=t.toString(),this.pattern=e||Template.Pattern},evaluate:function(t){return t&&Object.isFunction(t.toTemplateReplacements)&&(t=t.toTemplateReplacements()),this.template.gsub(this.pattern,function(e){if(null==t)return e[1]+"";var i=e[1]||"";if("\\"==i)return e[2];var n=t,r=e[3],o=/^([^.[]+|\[((?:.*?[^\\])?)\])(\.|\[|$)/;if(e=o.exec(r),null==e)return i;for(;null!=e;){var s=e[1].startsWith("[")?e[2].replace(/\\\\]/g,"]"):e[1];if(n=n[s],null==n||""==e[3])break;r=r.substring("["==e[3]?e[1].length:e[0].length),e=o.exec(r)}return i+String.interpret(n)})}});Template.Pattern=/(^|.|\r|\n)(#\{(.*?)\})/;var $break={},Enumerable=function(){function t(t,e){var i=0;try{this._each(function(n){t.call(e,n,i++)})}catch(n){if(n!=$break)throw n}return this}function e(t,e,i){var n=-t,r=[],o=this.toArray();if(1>t)return o;for(;(n+=t)<o.length;)r.push(o.slice(n,n+t));return r.collect(e,i)}function i(t,e){t=t||Prototype.K;var i=!0;return this.each(function(n,r){if(i=i&&!!t.call(e,n,r),!i)throw $break}),i}function n(t,e){t=t||Prototype.K;var i=!1;return this.each(function(n,r){if(i=!!t.call(e,n,r))throw $break}),i}function r(t,e){t=t||Prototype.K;var i=[];return this.each(function(n,r){i.push(t.call(e,n,r))}),i}function o(t,e){var i;return this.each(function(n,r){if(t.call(e,n,r))throw i=n,$break}),i}function s(t,e){var i=[];return this.each(function(n,r){t.call(e,n,r)&&i.push(n)}),i}function a(t,e,i){e=e||Prototype.K;var n=[];return Object.isString(t)&&(t=new RegExp(RegExp.escape(t))),this.each(function(r,o){t.match(r)&&n.push(e.call(i,r,o))}),n}function l(t){if(Object.isFunction(this.indexOf)&&-1!=this.indexOf(t))return!0;var e=!1;return this.each(function(i){if(i==t)throw e=!0,$break}),e}function u(t,e){return e=Object.isUndefined(e)?null:e,this.eachSlice(t,function(i){for(;i.length<t;)i.push(e);return i})}function c(t,e,i){return this.each(function(n,r){t=e.call(i,t,n,r)}),t}function h(t){var e=$A(arguments).slice(1);return this.map(function(i){return i[t].apply(i,e)})}function d(t,e){t=t||Prototype.K;var i;return this.each(function(n,r){n=t.call(e,n,r),(null==i||n>=i)&&(i=n)}),i}function p(t,e){t=t||Prototype.K;var i;return this.each(function(n,r){n=t.call(e,n,r),(null==i||i>n)&&(i=n)}),i}function f(t,e){t=t||Prototype.K;var i=[],n=[];return this.each(function(r,o){(t.call(e,r,o)?i:n).push(r)}),[i,n]}function m(t){var e=[];return this.each(function(i){e.push(i[t])}),e}function g(t,e){var i=[];return this.each(function(n,r){t.call(e,n,r)||i.push(n)}),i}function b(t,e){return this.map(function(i,n){return{value:i,criteria:t.call(e,i,n)}}).sort(function(t,e){var i=t.criteria,n=e.criteria;return n>i?-1:i>n?1:0}).pluck("value")}function v(){return this.map()}function y(){var t=Prototype.K,e=$A(arguments);Object.isFunction(e.last())&&(t=e.pop());var i=[this].concat(e).map($A);return this.map(function(e,n){return t(i.pluck(n))})}function w(){return this.toArray().length}function S(){return"#<Enumerable:"+this.toArray().inspect()+">"}return{each:t,eachSlice:e,all:i,every:i,any:n,some:n,collect:r,map:r,detect:o,findAll:s,select:s,filter:s,grep:a,include:l,member:l,inGroupsOf:u,inject:c,invoke:h,max:d,min:p,partition:f,pluck:m,reject:g,sortBy:b,toArray:v,entries:v,zip:y,size:w,inspect:S,find:o}}();Array.from=$A,function(){function t(t,e){for(var i=0,n=this.length>>>0;n>i;i++)i in this&&t.call(e,this[i],i,this)}function e(){return this.length=0,this}function i(){return this[0]}function n(){return this[this.length-1]}function r(){return this.select(function(t){return null!=t})}function o(){return this.inject([],function(t,e){return Object.isArray(e)?t.concat(e.flatten()):(t.push(e),t)})}function s(){var t=b.call(arguments,0);return this.select(function(e){return!t.include(e)})}function a(t){return(t===!1?this.toArray():this)._reverse()}function l(t){return this.inject([],function(e,i,n){return 0!=n&&(t?e.last()==i:e.include(i))||e.push(i),e})}function u(t){return this.uniq().findAll(function(e){return t.detect(function(t){return e===t})})}function c(){return b.call(this,0)}function h(){return this.length}function d(){return"["+this.map(Object.inspect).join(", ")+"]"}function p(t,e){e||(e=0);var i=this.length;for(0>e&&(e=i+e);i>e;e++)if(this[e]===t)return e;return-1}function f(t,e){e=isNaN(e)?this.length:(0>e?this.length+e:e)+1;var i=this.slice(0,e).reverse().indexOf(t);return 0>i?i:e-i-1}function m(){for(var t,e=b.call(this,0),i=0,n=arguments.length;n>i;i++)if(t=arguments[i],!Object.isArray(t)||"callee"in t)e.push(t);else for(var r=0,o=t.length;o>r;r++)e.push(t[r]);return e}var g=Array.prototype,b=g.slice,v=g.forEach;v||(v=t),Object.extend(g,Enumerable),g._reverse||(g._reverse=g.reverse),Object.extend(g,{_each:v,clear:e,first:i,last:n,compact:r,flatten:o,without:s,reverse:a,uniq:l,intersect:u,clone:c,toArray:c,size:h,inspect:d});var y=function(){return 1!==[].concat(arguments)[0][0]}(1,2);y&&(g.concat=m),g.indexOf||(g.indexOf=p),g.lastIndexOf||(g.lastIndexOf=f)}();var Hash=Class.create(Enumerable,function(){function t(t){this._object=Object.isHash(t)?t.toObject():Object.clone(t)}function e(t){for(var e in this._object){var i=this._object[e],n=[e,i];n.key=e,n.value=i,t(n)}}function i(t,e){return this._object[t]=e}function n(t){return this._object[t]!==Object.prototype[t]?this._object[t]:void 0}function r(t){var e=this._object[t];return delete this._object[t],e}function o(){return Object.clone(this._object)}function s(){return this.pluck("key")}function a(){return this.pluck("value")}function l(t){var e=this.detect(function(e){return e.value===t});return e&&e.key}function u(t){return this.clone().update(t)}function c(t){return new Hash(t).inject(this,function(t,e){return t.set(e.key,e.value),t})}function h(t,e){return Object.isUndefined(e)?t:t+"="+encodeURIComponent(String.interpret(e))}function d(){return this.inject([],function(t,e){var i=encodeURIComponent(e.key),n=e.value;if(n&&"object"==typeof n){if(Object.isArray(n)){for(var r,o=[],s=0,a=n.length;a>s;s++)r=n[s],o.push(h(i,r));return t.concat(o)}}else t.push(h(i,n));return t}).join("&")}function p(){return"#<Hash:{"+this.map(function(t){return t.map(Object.inspect).join(": ")}).join(", ")+"}>"}function f(){return new Hash(this)}return{initialize:t,_each:e,set:i,get:n,unset:r,toObject:o,toTemplateReplacements:o,keys:s,values:a,index:l,merge:u,update:c,toQueryString:d,inspect:p,toJSON:o,clone:f}}());Hash.from=$H,Object.extend(Number.prototype,function(){function t(){return this.toPaddedString(2,16)}function e(){return this+1}function i(t,e){return $R(0,this,!0).each(t,e),this}function n(t,e){var i=this.toString(e||10);return"0".times(t-i.length)+i}function r(){return Math.abs(this)}function o(){return Math.round(this)}function s(){return Math.ceil(this)}function a(){return Math.floor(this)}return{toColorPart:t,succ:e,times:i,toPaddedString:n,abs:r,round:o,ceil:s,floor:a}}());var ObjectRange=Class.create(Enumerable,function(){function t(t,e,i){this.start=t,this.end=e,this.exclusive=i}function e(t){for(var e=this.start;this.include(e);)t(e),e=e.succ()}function i(t){return t<this.start?!1:this.exclusive?t<this.end:t<=this.end}return{initialize:t,_each:e,include:i}}()),Ajax={getTransport:function(){return Try.these(function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")})||!1},activeRequestCount:0};if(Ajax.Responders={responders:[],_each:function(t){this.responders._each(t)},register:function(t){this.include(t)||this.responders.push(t)},unregister:function(t){this.responders=this.responders.without(t)},dispatch:function(t,e,i,n){this.each(function(r){if(Object.isFunction(r[t]))try{r[t].apply(r,[e,i,n])}catch(o){}})}},Object.extend(Ajax.Responders,Enumerable),Ajax.Responders.register({onCreate:function(){Ajax.activeRequestCount++},onComplete:function(){Ajax.activeRequestCount--}}),Ajax.Base=Class.create({initialize:function(t){this.options={method:"post",asynchronous:!0,contentType:"application/x-www-form-urlencoded",encoding:"UTF-8",parameters:"",evalJSON:!0,evalJS:!0},Object.extend(this.options,t||{}),this.options.method=this.options.method.toLowerCase(),Object.isHash(this.options.parameters)&&(this.options.parameters=this.options.parameters.toObject())}}),Ajax.Request=Class.create(Ajax.Base,{_complete:!1,initialize:function(t,e,i){t(i),this.transport=Ajax.getTransport(),this.request(e)},request:function(t){this.url=t,this.method=this.options.method;var e=Object.isString(this.options.parameters)?this.options.parameters:Object.toQueryString(this.options.parameters);["get","post"].include(this.method)||(e+=(e?"&":"")+"_method="+this.method,this.method="post"),e&&"get"===this.method&&(this.url+=(this.url.include("?")?"&":"?")+e),this.parameters=e.toQueryParams();try{var i=new Ajax.Response(this);this.options.onCreate&&this.options.onCreate(i),Ajax.Responders.dispatch("onCreate",this,i),this.transport.open(this.method.toUpperCase(),this.url,this.options.asynchronous),this.options.asynchronous&&this.respondToReadyState.bind(this).defer(1),this.transport.onreadystatechange=this.onStateChange.bind(this),this.setRequestHeaders(),this.body="post"==this.method?this.options.postBody||e:null,this.transport.send(this.body),!this.options.asynchronous&&this.transport.overrideMimeType&&this.onStateChange()}catch(n){this.dispatchException(n)}},onStateChange:function(){var t=this.transport.readyState;t>1&&(4!=t||!this._complete)&&this.respondToReadyState(this.transport.readyState)},setRequestHeaders:function(){var t={"X-Requested-With":"XMLHttpRequest","X-Prototype-Version":Prototype.Version,Accept:"text/javascript, text/html, application/xml, text/xml, */*"};if("post"==this.method&&(t["Content-type"]=this.options.contentType+(this.options.encoding?"; charset="+this.options.encoding:""),this.transport.overrideMimeType&&(navigator.userAgent.match(/Gecko\/(\d{4})/)||[0,2005])[1]<2005&&(t.Connection="close")),"object"==typeof this.options.requestHeaders){var e=this.options.requestHeaders;if(Object.isFunction(e.push))for(var i=0,n=e.length;n>i;i+=2)t[e[i]]=e[i+1];else $H(e).each(function(e){t[e.key]=e.value})}for(var r in t)this.transport.setRequestHeader(r,t[r])},success:function(){var t=this.getStatus();return!t||t>=200&&300>t||304==t},getStatus:function(){try{return 1223===this.transport.status?204:this.transport.status||0}catch(t){return 0}},respondToReadyState:function(t){var e=Ajax.Request.Events[t],i=new Ajax.Response(this);if("Complete"==e){try{this._complete=!0,(this.options["on"+i.status]||this.options["on"+(this.success()?"Success":"Failure")]||Prototype.emptyFunction)(i,i.headerJSON)}catch(n){this.dispatchException(n)}var r=i.getHeader("Content-type");("force"==this.options.evalJS||this.options.evalJS&&this.isSameOrigin()&&r&&r.match(/^\s*(text|application)\/(x-)?(java|ecma)script(;.*)?\s*$/i))&&this.evalResponse()}try{(this.options["on"+e]||Prototype.emptyFunction)(i,i.headerJSON),Ajax.Responders.dispatch("on"+e,this,i,i.headerJSON)}catch(n){this.dispatchException(n)}"Complete"==e&&(this.transport.onreadystatechange=Prototype.emptyFunction)},isSameOrigin:function(){var t=this.url.match(/^\s*https?:\/\/[^\/]*/);return!t||t[0]=="#{protocol}//#{domain}#{port}".interpolate({protocol:location.protocol,domain:document.domain,port:location.port?":"+location.port:""})},getHeader:function(t){try{return this.transport.getResponseHeader(t)||null}catch(e){return null}},evalResponse:function(){try{return eval((this.transport.responseText||"").unfilterJSON())}catch(e){this.dispatchException(e)}},dispatchException:function(t){(this.options.onException||Prototype.emptyFunction)(this,t),Ajax.Responders.dispatch("onException",this,t)}}),Ajax.Request.Events=["Uninitialized","Loading","Loaded","Interactive","Complete"],Ajax.Response=Class.create({initialize:function(t){this.request=t;var e=this.transport=t.transport,i=this.readyState=e.readyState;if((i>2&&!Prototype.Browser.IE||4==i)&&(this.status=this.getStatus(),this.statusText=this.getStatusText(),this.responseText=String.interpret(e.responseText),this.headerJSON=this._getHeaderJSON()),4==i){var n=e.responseXML;this.responseXML=Object.isUndefined(n)?null:n,this.responseJSON=this._getResponseJSON()}},status:0,statusText:"",getStatus:Ajax.Request.prototype.getStatus,getStatusText:function(){try{return this.transport.statusText||""}catch(t){return""}},getHeader:Ajax.Request.prototype.getHeader,getAllHeaders:function(){try{return this.getAllResponseHeaders()}catch(t){return null}},getResponseHeader:function(t){return this.transport.getResponseHeader(t)},getAllResponseHeaders:function(){return this.transport.getAllResponseHeaders()},_getHeaderJSON:function(){var t=this.getHeader("X-JSON");if(!t)return null;t=decodeURIComponent(escape(t));try{return t.evalJSON(this.request.options.sanitizeJSON||!this.request.isSameOrigin())}catch(e){this.request.dispatchException(e)}},_getResponseJSON:function(){var t=this.request.options;if(!t.evalJSON||"force"!=t.evalJSON&&!(this.getHeader("Content-type")||"").include("application/json")||this.responseText.blank())return null;try{return this.responseText.evalJSON(t.sanitizeJSON||!this.request.isSameOrigin())}catch(e){this.request.dispatchException(e)}}}),Ajax.Updater=Class.create(Ajax.Request,{initialize:function(t,e,i,n){this.container={success:e.success||e,failure:e.failure||(e.success?null:e)},n=Object.clone(n);var r=n.onComplete;n.onComplete=function(t,e){this.updateContent(t.responseText),Object.isFunction(r)&&r(t,e)}.bind(this),t(i,n)},updateContent:function(t){var e=this.container[this.success()?"success":"failure"],i=this.options;if(i.evalScripts||(t=t.stripScripts()),e=$(e))if(i.insertion)if(Object.isString(i.insertion)){var n={};n[i.insertion]=t,e.insert(n)}else i.insertion(e,t);else e.update(t)}}),Ajax.PeriodicalUpdater=Class.create(Ajax.Base,{initialize:function(t,e,i,n){t(n),this.onComplete=this.options.onComplete,this.frequency=this.options.frequency||2,this.decay=this.options.decay||1,this.updater={},this.container=e,this.url=i,this.start()},start:function(){this.options.onComplete=this.updateComplete.bind(this),this.onTimerEvent()},stop:function(){this.updater.options.onComplete=void 0,clearTimeout(this.timer),(this.onComplete||Prototype.emptyFunction).apply(this,arguments)},updateComplete:function(t){this.options.decay&&(this.decay=t.responseText==this.lastText?this.decay*this.options.decay:1,this.lastText=t.responseText),this.timer=this.onTimerEvent.bind(this).delay(this.decay*this.frequency)},onTimerEvent:function(){this.updater=new Ajax.Updater(this.container,this.url,this.options)}}),Prototype.BrowserFeatures.XPath&&(document._getElementsByXPath=function(t,e){for(var i=[],n=document.evaluate(t,$(e)||document,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),r=0,o=n.snapshotLength;o>r;r++)i.push(Element.extend(n.snapshotItem(r)));return i}),!Node)var Node={};Node.ELEMENT_NODE||Object.extend(Node,{ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12}),function(t){function e(t,e){return"select"===t?!1:"type"in e?!1:!0}var i=function(){try{var t=document.createElement('<input name="x">');return"input"===t.tagName.toLowerCase()&&"x"===t.name}catch(e){return!1}}(),n=t.Element;t.Element=function(t,n){n=n||{},t=t.toLowerCase();var r=Element.cache;if(i&&n.name)return t="<"+t+' name="'+n.name+'">',delete n.name,Element.writeAttribute(document.createElement(t),n);r[t]||(r[t]=Element.extend(document.createElement(t)));var o=e(t,n)?r[t].cloneNode(!1):document.createElement(t);return Element.writeAttribute(o,n)},Object.extend(t.Element,n||{}),n&&(t.Element.prototype=n.prototype)}(this),Element.idCounter=1,Element.cache={},Element._purgeElement=function(t){var e=t._prototypeUID;e&&(Element.stopObserving(t),t._prototypeUID=void 0,delete Element.Storage[e])},Element.Methods={visible:function(t){return"none"!=$(t).style.display},toggle:function(t){return t=$(t),Element[Element.visible(t)?"hide":"show"](t),t},hide:function(t){return t=$(t),t.style.display="none",t},show:function(t){return t=$(t),t.style.display="",t},remove:function(t){return t=$(t),t.parentNode.removeChild(t),t},update:function(){function t(t,e){t=$(t);for(var i=Element._purgeElement,s=t.getElementsByTagName("*"),a=s.length;a--;)i(s[a]);if(e&&e.toElement&&(e=e.toElement()),Object.isElement(e))return t.update().insert(e);e=Object.toHTML(e);var l=t.tagName.toUpperCase();if("SCRIPT"===l&&o)return t.text=e,t;if(r)if(l in Element._insertionTranslations.tags){for(;t.firstChild;)t.removeChild(t.firstChild);Element._getContentFromAnonymousElement(l,e.stripScripts()).each(function(e){t.appendChild(e)})}else if(n&&Object.isString(e)&&e.indexOf("<link")>-1){for(;t.firstChild;)t.removeChild(t.firstChild);var u=Element._getContentFromAnonymousElement(l,e.stripScripts(),!0);u.each(function(e){t.appendChild(e)})}else t.innerHTML=e.stripScripts();else t.innerHTML=e.stripScripts();return e.evalScripts.bind(e).defer(),t}var e=function(){var t=document.createElement("select"),e=!0;return t.innerHTML='<option value="test">test</option>',t.options&&t.options[0]&&(e="OPTION"!==t.options[0].nodeName.toUpperCase()),t=null,e}(),i=function(){try{var t=document.createElement("table");if(t&&t.tBodies){t.innerHTML="<tbody><tr><td>test</td></tr></tbody>";var e="undefined"==typeof t.tBodies[0];return t=null,e}}catch(i){return!0}}(),n=function(){try{var t=document.createElement("div");t.innerHTML="<link>";var e=0===t.childNodes.length;return t=null,e}catch(i){return!0}}(),r=e||i||n,o=function(){var t=document.createElement("script"),e=!1;try{t.appendChild(document.createTextNode("")),e=!t.firstChild||t.firstChild&&3!==t.firstChild.nodeType}catch(i){e=!0}return t=null,e}();return t}(),replace:function(t,e){if(t=$(t),e&&e.toElement)e=e.toElement();else if(!Object.isElement(e)){e=Object.toHTML(e);var i=t.ownerDocument.createRange();i.selectNode(t),e.evalScripts.bind(e).defer(),e=i.createContextualFragment(e.stripScripts())}return t.parentNode.replaceChild(e,t),t},insert:function(t,e){t=$(t),(Object.isString(e)||Object.isNumber(e)||Object.isElement(e)||e&&(e.toElement||e.toHTML))&&(e={bottom:e});var i,n,r,o;for(var s in e)i=e[s],s=s.toLowerCase(),n=Element._insertionTranslations[s],i&&i.toElement&&(i=i.toElement()),Object.isElement(i)?n(t,i):(i=Object.toHTML(i),r=("before"==s||"after"==s?t.parentNode:t).tagName.toUpperCase(),o=Element._getContentFromAnonymousElement(r,i.stripScripts()),("top"==s||"after"==s)&&o.reverse(),o.each(n.curry(t)),i.evalScripts.bind(i).defer());return t},wrap:function(t,e,i){return t=$(t),Object.isElement(e)?$(e).writeAttribute(i||{}):e=Object.isString(e)?new Element(e,i):new Element("div",e),t.parentNode&&t.parentNode.replaceChild(e,t),e.appendChild(t),e},inspect:function(t){t=$(t);var e="<"+t.tagName.toLowerCase();return $H({id:"id",className:"class"}).each(function(i){var n=i.first(),r=i.last(),o=(t[n]||"").toString();o&&(e+=" "+r+"="+o.inspect(!0))}),e+">"},recursivelyCollect:function(t,e,i){t=$(t),i=i||-1;for(var n=[];(t=t[e])&&(1==t.nodeType&&n.push(Element.extend(t)),n.length!=i););return n},ancestors:function(t){return Element.recursivelyCollect(t,"parentNode")},descendants:function(t){return Element.select(t,"*");
},firstDescendant:function(t){for(t=$(t).firstChild;t&&1!=t.nodeType;)t=t.nextSibling;return $(t)},immediateDescendants:function(t){for(var e=[],i=$(t).firstChild;i;)1===i.nodeType&&e.push(Element.extend(i)),i=i.nextSibling;return e},previousSiblings:function(t,e){return Element.recursivelyCollect(t,"previousSibling")},nextSiblings:function(t){return Element.recursivelyCollect(t,"nextSibling")},siblings:function(t){return t=$(t),Element.previousSiblings(t).reverse().concat(Element.nextSiblings(t))},match:function(t,e){return t=$(t),Object.isString(e)?Prototype.Selector.match(t,e):e.match(t)},up:function(t,e,i){if(t=$(t),1==arguments.length)return $(t.parentNode);var n=Element.ancestors(t);return Object.isNumber(e)?n[e]:Prototype.Selector.find(n,e,i)},down:function(t,e,i){return t=$(t),1==arguments.length?Element.firstDescendant(t):Object.isNumber(e)?Element.descendants(t)[e]:Element.select(t,e)[i||0]},previous:function(t,e,i){return t=$(t),Object.isNumber(e)&&(i=e,e=!1),Object.isNumber(i)||(i=0),e?Prototype.Selector.find(t.previousSiblings(),e,i):t.recursivelyCollect("previousSibling",i+1)[i]},next:function(t,e,i){if(t=$(t),Object.isNumber(e)&&(i=e,e=!1),Object.isNumber(i)||(i=0),e)return Prototype.Selector.find(t.nextSiblings(),e,i);Object.isNumber(i)?i+1:1;return t.recursivelyCollect("nextSibling",i+1)[i]},select:function(t){t=$(t);var e=Array.prototype.slice.call(arguments,1).join(", ");return Prototype.Selector.select(e,t)},adjacent:function(t){t=$(t);var e=Array.prototype.slice.call(arguments,1).join(", ");return Prototype.Selector.select(e,t.parentNode).without(t)},identify:function(t){t=$(t);var e=Element.readAttribute(t,"id");if(e)return e;do e="anonymous_element_"+Element.idCounter++;while($(e));return Element.writeAttribute(t,"id",e),e},readAttribute:function(t,e){if(t=$(t),Prototype.Browser.IE){var i=Element._attributeTranslations.read;if(i.values[e])return i.values[e](t,e);if(i.names[e]&&(e=i.names[e]),e.include(":"))return t.attributes&&t.attributes[e]?t.attributes[e].value:null}return t.getAttribute(e)},writeAttribute:function(t,e,i){t=$(t);var n={},r=Element._attributeTranslations.write;"object"==typeof e?n=e:n[e]=Object.isUndefined(i)?!0:i;for(var o in n)e=r.names[o]||o,i=n[o],r.values[o]&&(e=r.values[o](t,i)),i===!1||null===i?t.removeAttribute(e):i===!0?t.setAttribute(e,e):t.setAttribute(e,i);return t},getHeight:function(t){return Element.getDimensions(t).height},getWidth:function(t){return Element.getDimensions(t).width},classNames:function(t){return new Element.ClassNames(t)},hasClassName:function(t,e){if(t=$(t)){var i=t.className;return i.length>0&&(i==e||new RegExp("(^|\\s)"+e+"(\\s|$)").test(i))}},addClassName:function(t,e){return(t=$(t))?(Element.hasClassName(t,e)||(t.className+=(t.className?" ":"")+e),t):void 0},removeClassName:function(t,e){return(t=$(t))?(t.className=t.className.replace(new RegExp("(^|\\s+)"+e+"(\\s+|$)")," ").strip(),t):void 0},toggleClassName:function(t,e){return(t=$(t))?Element[Element.hasClassName(t,e)?"removeClassName":"addClassName"](t,e):void 0},cleanWhitespace:function(t){t=$(t);for(var e=t.firstChild;e;){var i=e.nextSibling;3!=e.nodeType||/\S/.test(e.nodeValue)||t.removeChild(e),e=i}return t},empty:function(t){return $(t).innerHTML.blank()},descendantOf:function(t,e){if(t=$(t),e=$(e),t.compareDocumentPosition)return 8===(8&t.compareDocumentPosition(e));if(e.contains)return e.contains(t)&&e!==t;for(;t=t.parentNode;)if(t==e)return!0;return!1},scrollTo:function(t){t=$(t);var e=Element.cumulativeOffset(t);return window.scrollTo(e[0],e[1]),t},getStyle:function(t,e){t=$(t),e="float"==e?"cssFloat":e.camelize();var i=t.style[e];if(!i||"auto"==i){var n=document.defaultView.getComputedStyle(t,null);i=n?n[e]:null}return"opacity"==e?i?parseFloat(i):1:"auto"==i?null:i},getOpacity:function(t){return $(t).getStyle("opacity")},setStyle:function(t,e){t=$(t);var i=t.style;if(Object.isString(e))return t.style.cssText+=";"+e,e.include("opacity")?t.setOpacity(e.match(/opacity:\s*(\d?\.?\d*)/)[1]):t;for(var n in e)"opacity"==n?t.setOpacity(e[n]):i["float"==n||"cssFloat"==n?Object.isUndefined(i.styleFloat)?"cssFloat":"styleFloat":n]=e[n];return t},setOpacity:function(t,e){return t=$(t),t.style.opacity=1==e||""===e?"":1e-5>e?0:e,t},makePositioned:function(t){t=$(t);var e=Element.getStyle(t,"position");return"static"!=e&&e||(t._madePositioned=!0,t.style.position="relative",Prototype.Browser.Opera&&(t.style.top=0,t.style.left=0)),t},undoPositioned:function(t){return t=$(t),t._madePositioned&&(t._madePositioned=void 0,t.style.position=t.style.top=t.style.left=t.style.bottom=t.style.right=""),t},makeClipping:function(t){return t=$(t),t._overflow?t:(t._overflow=Element.getStyle(t,"overflow")||"auto","hidden"!==t._overflow&&(t.style.overflow="hidden"),t)},undoClipping:function(t){return t=$(t),t._overflow?(t.style.overflow="auto"==t._overflow?"":t._overflow,t._overflow=null,t):t},clonePosition:function(t,e){var i=Object.extend({setLeft:!0,setTop:!0,setWidth:!0,setHeight:!0,offsetTop:0,offsetLeft:0},arguments[2]||{});e=$(e);var n=Element.viewportOffset(e),r=[0,0],o=null;return t=$(t),"absolute"==Element.getStyle(t,"position")&&(o=Element.getOffsetParent(t),r=Element.viewportOffset(o)),o==document.body&&(r[0]-=document.body.offsetLeft,r[1]-=document.body.offsetTop),i.setLeft&&(t.style.left=n[0]-r[0]+i.offsetLeft+"px"),i.setTop&&(t.style.top=n[1]-r[1]+i.offsetTop+"px"),i.setWidth&&(t.style.width=e.offsetWidth+"px"),i.setHeight&&(t.style.height=e.offsetHeight+"px"),t}},Object.extend(Element.Methods,{getElementsBySelector:Element.Methods.select,childElements:Element.Methods.immediateDescendants}),Element._attributeTranslations={write:{names:{className:"class",htmlFor:"for"},values:{}}},Prototype.Browser.Opera?(Element.Methods.getStyle=Element.Methods.getStyle.wrap(function(t,e,i){switch(i){case"height":case"width":if(!Element.visible(e))return null;var n=parseInt(t(e,i),10);if(n!==e["offset"+i.capitalize()])return n+"px";var r;return r="height"===i?["border-top-width","padding-top","padding-bottom","border-bottom-width"]:["border-left-width","padding-left","padding-right","border-right-width"],r.inject(n,function(i,n){var r=t(e,n);return null===r?i:i-parseInt(r,10)})+"px";default:return t(e,i)}}),Element.Methods.readAttribute=Element.Methods.readAttribute.wrap(function(t,e,i){return"title"===i?e.title:t(e,i)})):Prototype.Browser.IE?(Element.Methods.getStyle=function(t,e){t=$(t),e="float"==e||"cssFloat"==e?"styleFloat":e.camelize();var i=t.style[e];return!i&&t.currentStyle&&(i=t.currentStyle[e]),"opacity"==e?(i=(t.getStyle("filter")||"").match(/alpha\(opacity=(.*)\)/))&&i[1]?parseFloat(i[1])/100:1:"auto"==i?"width"!=e&&"height"!=e||"none"==t.getStyle("display")?null:t["offset"+e.capitalize()]+"px":i},Element.Methods.setOpacity=function(t,e){function i(t){return t.replace(/alpha\([^\)]*\)/gi,"")}t=$(t);var n=t.currentStyle;(n&&!n.hasLayout||!n&&"normal"==t.style.zoom)&&(t.style.zoom=1);var r=t.getStyle("filter"),o=t.style;return 1==e||""===e?((r=i(r))?o.filter=r:o.removeAttribute("filter"),t):(1e-5>e&&(e=0),o.filter=i(r)+"alpha(opacity="+100*e+")",t)},Element._attributeTranslations=function(){var t="className",e="for",i=document.createElement("div");return i.setAttribute(t,"x"),"x"!==i.className&&(i.setAttribute("class","x"),"x"===i.className&&(t="class")),i=null,i=document.createElement("label"),i.setAttribute(e,"x"),"x"!==i.htmlFor&&(i.setAttribute("htmlFor","x"),"x"===i.htmlFor&&(e="htmlFor")),i=null,{read:{names:{"class":t,className:t,"for":e,htmlFor:e},values:{_getAttr:function(t,e){return t.getAttribute(e)},_getAttr2:function(t,e){return t.getAttribute(e,2)},_getAttrNode:function(t,e){var i=t.getAttributeNode(e);return i?i.value:""},_getEv:function(){var t,e=document.createElement("div");e.onclick=Prototype.emptyFunction;var i=e.getAttribute("onclick");return String(i).indexOf("{")>-1?t=function(t,e){return(e=t.getAttribute(e))?(e=e.toString(),e=e.split("{")[1],e=e.split("}")[0],e.strip()):null}:""===i&&(t=function(t,e){return e=t.getAttribute(e),e?e.strip():null}),e=null,t}(),_flag:function(t,e){return $(t).hasAttribute(e)?e:null},style:function(t){return t.style.cssText.toLowerCase()},title:function(t){return t.title}}}}}(),Element._attributeTranslations.write={names:Object.extend({cellpadding:"cellPadding",cellspacing:"cellSpacing"},Element._attributeTranslations.read.names),values:{checked:function(t,e){t.checked=!!e},style:function(t,e){t.style.cssText=e?e:""}}},Element._attributeTranslations.has={},$w("colSpan rowSpan vAlign dateTime accessKey tabIndex encType maxLength readOnly longDesc frameBorder").each(function(t){Element._attributeTranslations.write.names[t.toLowerCase()]=t,Element._attributeTranslations.has[t.toLowerCase()]=t}),function(t){Object.extend(t,{href:t._getAttr2,src:t._getAttr2,type:t._getAttr,action:t._getAttrNode,disabled:t._flag,checked:t._flag,readonly:t._flag,multiple:t._flag,onload:t._getEv,onunload:t._getEv,onclick:t._getEv,ondblclick:t._getEv,onmousedown:t._getEv,onmouseup:t._getEv,onmouseover:t._getEv,onmousemove:t._getEv,onmouseout:t._getEv,onfocus:t._getEv,onblur:t._getEv,onkeypress:t._getEv,onkeydown:t._getEv,onkeyup:t._getEv,onsubmit:t._getEv,onreset:t._getEv,onselect:t._getEv,onchange:t._getEv})}(Element._attributeTranslations.read.values),Prototype.BrowserFeatures.ElementExtensions&&!function(){function t(t){for(var e,i=t.getElementsByTagName("*"),n=[],r=0;e=i[r];r++)"!"!==e.tagName&&n.push(e);return n}Element.Methods.down=function(e,i,n){return e=$(e),1==arguments.length?e.firstDescendant():Object.isNumber(i)?t(e)[i]:Element.select(e,i)[n||0]}}()):Prototype.Browser.Gecko&&/rv:1\.8\.0/.test(navigator.userAgent)?Element.Methods.setOpacity=function(t,e){return t=$(t),t.style.opacity=1==e?.999999:""===e?"":1e-5>e?0:e,t}:Prototype.Browser.WebKit&&(Element.Methods.setOpacity=function(t,e){if(t=$(t),t.style.opacity=1==e||""===e?"":1e-5>e?0:e,1==e)if("IMG"==t.tagName.toUpperCase()&&t.width)t.width++,t.width--;else try{var i=document.createTextNode(" ");t.appendChild(i),t.removeChild(i)}catch(n){}return t}),"outerHTML"in document.documentElement&&(Element.Methods.replace=function(t,e){if(t=$(t),e&&e.toElement&&(e=e.toElement()),Object.isElement(e))return t.parentNode.replaceChild(e,t),t;e=Object.toHTML(e);var i=t.parentNode,n=i.tagName.toUpperCase();if(Element._insertionTranslations.tags[n]){var r=t.next(),o=Element._getContentFromAnonymousElement(n,e.stripScripts());i.removeChild(t),r?o.each(function(t){i.insertBefore(t,r)}):o.each(function(t){i.appendChild(t)})}else t.outerHTML=e.stripScripts();return e.evalScripts.bind(e).defer(),t}),Element._returnOffset=function(t,e){var i=[t,e];return i.left=t,i.top=e,i},Element._getContentFromAnonymousElement=function(t,e,i){var n=new Element("div"),r=Element._insertionTranslations.tags[t],o=!1;if(r?o=!0:i&&(o=!0,r=["","",0]),o){n.innerHTML="&nbsp;"+r[0]+e+r[1],n.removeChild(n.firstChild);for(var s=r[2];s--;)n=n.firstChild}else n.innerHTML=e;return $A(n.childNodes)},Element._insertionTranslations={before:function(t,e){t.parentNode.insertBefore(e,t)},top:function(t,e){t.insertBefore(e,t.firstChild)},bottom:function(t,e){t.appendChild(e)},after:function(t,e){t.parentNode.insertBefore(e,t.nextSibling)},tags:{TABLE:["<table>","</table>",1],TBODY:["<table><tbody>","</tbody></table>",2],TR:["<table><tbody><tr>","</tr></tbody></table>",3],TD:["<table><tbody><tr><td>","</td></tr></tbody></table>",4],SELECT:["<select>","</select>",1]}},function(){var t=Element._insertionTranslations.tags;Object.extend(t,{THEAD:t.TBODY,TFOOT:t.TBODY,TH:t.TD})}(),Element.Methods.Simulated={hasAttribute:function(t,e){e=Element._attributeTranslations.has[e]||e;var i=$(t).getAttributeNode(e);return!(!i||!i.specified)}},Element.Methods.ByTag={},Object.extend(Element,Element.Methods),function(t){!Prototype.BrowserFeatures.ElementExtensions&&t.__proto__&&(window.HTMLElement={},window.HTMLElement.prototype=t.__proto__,Prototype.BrowserFeatures.ElementExtensions=!0),t=null}(document.createElement("div")),Element.extend=function(){function t(t){if("undefined"!=typeof window.Element){var e=window.Element.prototype;if(e){var i="_"+(Math.random()+"").slice(2),n=document.createElement(t);e[i]="x";var r="x"!==n[i];return delete e[i],n=null,r}}return!1}function e(t,e){for(var i in e){var n=e[i];!Object.isFunction(n)||i in t||(t[i]=n.methodize())}}var i=t("object");if(Prototype.BrowserFeatures.SpecificElementExtensions)return i?function(t){if(t&&"undefined"==typeof t._extendedByPrototype){var i=t.tagName;i&&/^(?:object|applet|embed)$/i.test(i)&&(e(t,Element.Methods),e(t,Element.Methods.Simulated),e(t,Element.Methods.ByTag[i.toUpperCase()]))}return t}:Prototype.K;var n={},r=Element.Methods.ByTag,o=Object.extend(function(t){if(!t||"undefined"!=typeof t._extendedByPrototype||1!=t.nodeType||t==window)return t;var i=Object.clone(n),o=t.tagName.toUpperCase();return r[o]&&Object.extend(i,r[o]),e(t,i),t._extendedByPrototype=Prototype.emptyFunction,t},{refresh:function(){Prototype.BrowserFeatures.ElementExtensions||(Object.extend(n,Element.Methods),Object.extend(n,Element.Methods.Simulated))}});return o.refresh(),o}(),document.documentElement.hasAttribute?Element.hasAttribute=function(t,e){return t.hasAttribute(e)}:Element.hasAttribute=Element.Methods.Simulated.hasAttribute,Element.addMethods=function(t){function e(e){e=e.toUpperCase(),Element.Methods.ByTag[e]||(Element.Methods.ByTag[e]={}),Object.extend(Element.Methods.ByTag[e],t)}function i(t,e,i){i=i||!1;for(var n in t){var r=t[n];Object.isFunction(r)&&(i&&n in e||(e[n]=r.methodize()))}}function n(t){var e,i={OPTGROUP:"OptGroup",TEXTAREA:"TextArea",P:"Paragraph",FIELDSET:"FieldSet",UL:"UList",OL:"OList",DL:"DList",DIR:"Directory",H1:"Heading",H2:"Heading",H3:"Heading",H4:"Heading",H5:"Heading",H6:"Heading",Q:"Quote",INS:"Mod",DEL:"Mod",A:"Anchor",IMG:"Image",CAPTION:"TableCaption",COL:"TableCol",COLGROUP:"TableCol",THEAD:"TableSection",TFOOT:"TableSection",TBODY:"TableSection",TR:"TableRow",TH:"TableCell",TD:"TableCell",FRAMESET:"FrameSet",IFRAME:"IFrame"};if(i[t]&&(e="HTML"+i[t]+"Element"),window[e])return window[e];if(e="HTML"+t+"Element",window[e])return window[e];if(e="HTML"+t.capitalize()+"Element",window[e])return window[e];var n=document.createElement(t),r=n.__proto__||n.constructor.prototype;return n=null,r}var r=Prototype.BrowserFeatures,o=Element.Methods.ByTag;if(t||(Object.extend(Form,Form.Methods),Object.extend(Form.Element,Form.Element.Methods),Object.extend(Element.Methods.ByTag,{FORM:Object.clone(Form.Methods),INPUT:Object.clone(Form.Element.Methods),SELECT:Object.clone(Form.Element.Methods),TEXTAREA:Object.clone(Form.Element.Methods),BUTTON:Object.clone(Form.Element.Methods)})),2==arguments.length){var s=t;t=arguments[1]}s?Object.isArray(s)?s.each(e):e(s):Object.extend(Element.Methods,t||{});var a=window.HTMLElement?HTMLElement.prototype:Element.prototype;if(r.ElementExtensions&&(i(Element.Methods,a),i(Element.Methods.Simulated,a,!0)),r.SpecificElementExtensions)for(var l in Element.Methods.ByTag){var u=n(l);Object.isUndefined(u)||i(o[l],u.prototype)}Object.extend(Element,Element.Methods),delete Element.ByTag,Element.extend.refresh&&Element.extend.refresh(),Element.cache={}},document.viewport={getDimensions:function(){return{width:this.getWidth(),height:this.getHeight()}},getScrollOffsets:function(){return Element._returnOffset(window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft,window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop)}},function(t){function e(){return r.WebKit&&!o.evaluate?document:r.Opera&&window.parseFloat(window.opera.version())<9.5?document.body:document.documentElement}function i(i){return n||(n=e()),s[i]="client"+i,t["get"+i]=function(){return n[s[i]]},t["get"+i]()}var n,r=Prototype.Browser,o=document,s={};t.getWidth=i.curry("Width"),t.getHeight=i.curry("Height")}(document.viewport),Element.Storage={UID:1},Element.addMethods({getStorage:function(t){if(t=$(t)){var e;return t===window?e=0:("undefined"==typeof t._prototypeUID&&(t._prototypeUID=Element.Storage.UID++),e=t._prototypeUID),Element.Storage[e]||(Element.Storage[e]=$H()),Element.Storage[e]}},store:function(t,e,i){return(t=$(t))?(2===arguments.length?Element.getStorage(t).update(e):Element.getStorage(t).set(e,i),t):void 0},retrieve:function(t,e,i){if(t=$(t)){var n=Element.getStorage(t),r=n.get(e);return Object.isUndefined(r)&&(n.set(e,i),r=i),r}},clone:function(t,e){if(t=$(t)){var i=t.cloneNode(e);if(i._prototypeUID=void 0,e)for(var n=Element.select(i,"*"),r=n.length;r--;)n[r]._prototypeUID=void 0;return Element.extend(i)}},purge:function(t){if(t=$(t)){var e=Element._purgeElement;e(t);for(var i=t.getElementsByTagName("*"),n=i.length;n--;)e(i[n]);return null}}}),function(){function t(t){var e=t.match(/^(\d+)%?$/i);return e?Number(e[1])/100:null}function e(e,i,n){var r=null;if(Object.isElement(e)&&(r=e,e=r.getStyle(i)),null===e)return null;if(/^(?:-)?\d+(\.\d+)?(px)?$/i.test(e))return window.parseFloat(e);var o=e.include("%"),s=n===document.viewport;if(/\d/.test(e)&&r&&r.runtimeStyle&&(!o||!s)){var a=r.style.left,l=r.runtimeStyle.left;return r.runtimeStyle.left=r.currentStyle.left,r.style.left=e||0,e=r.style.pixelLeft,r.style.left=a,r.runtimeStyle.left=l,e}if(r&&o){n=n||r.parentNode;var u=t(e),c=null,h=(r.getStyle("position"),i.include("left")||i.include("right")||i.include("width")),d=i.include("top")||i.include("bottom")||i.include("height");return n===document.viewport?h?c=document.viewport.getWidth():d&&(c=document.viewport.getHeight()):h?c=$(n).measure("width"):d&&(c=$(n).measure("height")),null===c?0:c*u}return 0}function i(t){for(;t&&t.parentNode;){var e=t.getStyle("display");if("none"===e)return!1;t=$(t.parentNode)}return!0}function n(t){return t.include("border")&&(t+="-width"),t.camelize()}function r(t,e){return new Element.Layout(t,e)}function o(t,e){return $(t).getLayout().get(e)}function s(t){t=$(t);var e=Element.getStyle(t,"display");if(e&&"none"!==e)return{width:t.offsetWidth,height:t.offsetHeight};var i=t.style,n={visibility:i.visibility,position:i.position,display:i.display},r={visibility:"hidden",display:"block"};"fixed"!==n.position&&(r.position="absolute"),Element.setStyle(t,r);var o={width:t.offsetWidth,height:t.offsetHeight};return Element.setStyle(t,n),o}function a(t){if(t=$(t),g(t)||b(t)||f(t)||m(t))return $(document.body);var e="inline"===Element.getStyle(t,"display");if(!e&&t.offsetParent)return $(t.offsetParent);for(;(t=t.parentNode)&&t!==document.body;)if("static"!==Element.getStyle(t,"position"))return $(m(t)?document.body:t);return $(document.body)}function l(t){t=$(t);var e=0,i=0;if(t.parentNode)do e+=t.offsetTop||0,i+=t.offsetLeft||0,t=t.offsetParent;while(t);return new Element.Offset(i,e)}function u(t){t=$(t);var e=t.getLayout(),i=0,n=0;do if(i+=t.offsetTop||0,n+=t.offsetLeft||0,t=t.offsetParent){if(f(t))break;var r=Element.getStyle(t,"position");if("static"!==r)break}while(t);return n-=e.get("margin-top"),i-=e.get("margin-left"),new Element.Offset(n,i)}function c(t){var e=0,i=0;do e+=t.scrollTop||0,i+=t.scrollLeft||0,t=t.parentNode;while(t);return new Element.Offset(i,e)}function h(t){r=$(r);var e=0,i=0,n=document.body,r=t;do if(e+=r.offsetTop||0,i+=r.offsetLeft||0,r.offsetParent==n&&"absolute"==Element.getStyle(r,"position"))break;while(r=r.offsetParent);r=t;do r!=n&&(e-=r.scrollTop||0,i-=r.scrollLeft||0);while(r=r.parentNode);return new Element.Offset(i,e)}function d(t){if(t=$(t),"absolute"===Element.getStyle(t,"position"))return t;var e=a(t),i=t.viewportOffset(),n=e.viewportOffset(),r=i.relativeTo(n),o=t.getLayout();return t.store("prototype_absolutize_original_styles",{left:t.getStyle("left"),top:t.getStyle("top"),width:t.getStyle("width"),height:t.getStyle("height")}),t.setStyle({position:"absolute",top:r.top+"px",left:r.left+"px",width:o.get("width")+"px",height:o.get("height")+"px"}),t}function p(t){if(t=$(t),"relative"===Element.getStyle(t,"position"))return t;var e=t.retrieve("prototype_absolutize_original_styles");return e&&t.setStyle(e),t}function f(t){return"BODY"===t.nodeName.toUpperCase()}function m(t){return"HTML"===t.nodeName.toUpperCase()}function g(t){return t.nodeType===Node.DOCUMENT_NODE}function b(t){return t!==document.body&&!Element.descendantOf(t,document.body)}var v=Prototype.K;"currentStyle"in document.documentElement&&(v=function(t){return t.currentStyle.hasLayout||(t.style.zoom=1),t}),Element.Layout=Class.create(Hash,{initialize:function(t,e,i){t(),this.element=$(e),Element.Layout.PROPERTIES.each(function(t){this._set(t,null)},this),i&&(this._preComputing=!0,this._begin(),Element.Layout.PROPERTIES.each(this._compute,this),this._end(),this._preComputing=!1)},_set:function(t,e){return Hash.prototype.set.call(this,t,e)},set:function(t,e){throw"Properties of Element.Layout are read-only."},get:function(t,e){var i=t(e);return null===i?this._compute(e):i},_begin:function(){if(!this._prepared){var t=this.element;if(i(t))return void(this._prepared=!0);var n={position:t.style.position||"",width:t.style.width||"",visibility:t.style.visibility||"",display:t.style.display||""};t.store("prototype_original_styles",n);var r=t.getStyle("position"),o=t.getStyle("width");("0px"===o||null===o)&&(t.style.display="block",o=t.getStyle("width"));var s="fixed"===r?document.viewport:t.parentNode;t.setStyle({position:"absolute",visibility:"hidden",display:"block"});var a,l=t.getStyle("width");if(o&&l===o)a=e(t,"width",s);else if("absolute"===r||"fixed"===r)a=e(t,"width",s);else{var u=t.parentNode,c=$(u).getLayout();a=c.get("width")-this.get("margin-left")-this.get("border-left")-this.get("padding-left")-this.get("padding-right")-this.get("border-right")-this.get("margin-right")}t.setStyle({width:a+"px"}),this._prepared=!0}},_end:function(){var t=this.element,e=t.retrieve("prototype_original_styles");t.store("prototype_original_styles",null),t.setStyle(e),this._prepared=!1},_compute:function(t){var e=Element.Layout.COMPUTATIONS;if(!(t in e))throw"Property not found.";return this._set(t,e[t].call(this,this.element))},toObject:function(){var t=$A(arguments),e=0===t.length?Element.Layout.PROPERTIES:t.join(" ").split(" "),i={};return e.each(function(t){if(Element.Layout.PROPERTIES.include(t)){var e=this.get(t);null!=e&&(i[t]=e)}},this),i},toHash:function(){var t=this.toObject.apply(this,arguments);return new Hash(t)},toCSS:function(){var t=$A(arguments),e=0===t.length?Element.Layout.PROPERTIES:t.join(" ").split(" "),i={};return e.each(function(t){if(Element.Layout.PROPERTIES.include(t)&&!Element.Layout.COMPOSITE_PROPERTIES.include(t)){var e=this.get(t);null!=e&&(i[n(t)]=e+"px")}},this),i},inspect:function(){return"#<Element.Layout>"}}),Object.extend(Element.Layout,{PROPERTIES:$w("height width top left right bottom border-left border-right border-top border-bottom padding-left padding-right padding-top padding-bottom margin-top margin-bottom margin-left margin-right padding-box-width padding-box-height border-box-width border-box-height margin-box-width margin-box-height"),COMPOSITE_PROPERTIES:$w("padding-box-width padding-box-height margin-box-width margin-box-height border-box-width border-box-height"),COMPUTATIONS:{height:function(t){this._preComputing||this._begin();var e=this.get("border-box-height");if(0>=e)return this._preComputing||this._end(),0;var i=this.get("border-top"),n=this.get("border-bottom"),r=this.get("padding-top"),o=this.get("padding-bottom");return this._preComputing||this._end(),e-i-n-r-o},width:function(t){this._preComputing||this._begin();var e=this.get("border-box-width");if(0>=e)return this._preComputing||this._end(),0;var i=this.get("border-left"),n=this.get("border-right"),r=this.get("padding-left"),o=this.get("padding-right");return this._preComputing||this._end(),e-i-n-r-o},"padding-box-height":function(t){var e=this.get("height"),i=this.get("padding-top"),n=this.get("padding-bottom");return e+i+n},"padding-box-width":function(t){var e=this.get("width"),i=this.get("padding-left"),n=this.get("padding-right");return e+i+n},"border-box-height":function(t){this._preComputing||this._begin();var e=t.offsetHeight;return this._preComputing||this._end(),e},"border-box-width":function(t){this._preComputing||this._begin();var e=t.offsetWidth;return this._preComputing||this._end(),e},"margin-box-height":function(t){var e=this.get("border-box-height"),i=this.get("margin-top"),n=this.get("margin-bottom");return 0>=e?0:e+i+n},"margin-box-width":function(t){var e=this.get("border-box-width"),i=this.get("margin-left"),n=this.get("margin-right");return 0>=e?0:e+i+n},top:function(t){var e=t.positionedOffset();return e.top},bottom:function(t){var e=t.positionedOffset(),i=t.getOffsetParent(),n=i.measure("height"),r=this.get("border-box-height");return n-r-e.top},left:function(t){var e=t.positionedOffset();return e.left},right:function(t){var e=t.positionedOffset(),i=t.getOffsetParent(),n=i.measure("width"),r=this.get("border-box-width");return n-r-e.left},"padding-top":function(t){return e(t,"paddingTop")},"padding-bottom":function(t){return e(t,"paddingBottom")},"padding-left":function(t){return e(t,"paddingLeft")},"padding-right":function(t){return e(t,"paddingRight")},"border-top":function(t){return e(t,"borderTopWidth")},"border-bottom":function(t){return e(t,"borderBottomWidth")},"border-left":function(t){return e(t,"borderLeftWidth")},"border-right":function(t){return e(t,"borderRightWidth")},"margin-top":function(t){return e(t,"marginTop")},"margin-bottom":function(t){return e(t,"marginBottom")},"margin-left":function(t){return e(t,"marginLeft")},"margin-right":function(t){return e(t,"marginRight")}}}),"getBoundingClientRect"in document.documentElement&&Object.extend(Element.Layout.COMPUTATIONS,{right:function(t){var e=v(t.getOffsetParent()),i=t.getBoundingClientRect(),n=e.getBoundingClientRect();return(n.right-i.right).round()},bottom:function(t){var e=v(t.getOffsetParent()),i=t.getBoundingClientRect(),n=e.getBoundingClientRect();return(n.bottom-i.bottom).round()}}),Element.Offset=Class.create({initialize:function(t,e){this.left=t.round(),this.top=e.round(),this[0]=this.left,this[1]=this.top},relativeTo:function(t){return new Element.Offset(this.left-t.left,this.top-t.top)},inspect:function(){return"#<Element.Offset left: #{left} top: #{top}>".interpolate(this)},toString:function(){return"[#{left}, #{top}]".interpolate(this)},toArray:function(){return[this.left,this.top]}}),Prototype.Browser.IE?(a=a.wrap(function(t,e){if(e=$(e),g(e)||b(e)||f(e)||m(e))return $(document.body);var i=e.getStyle("position");if("static"!==i)return t(e);e.setStyle({position:"relative"});var n=t(e);return e.setStyle({position:i}),n}),u=u.wrap(function(t,e){if(e=$(e),!e.parentNode)return new Element.Offset(0,0);var i=e.getStyle("position");if("static"!==i)return t(e);var n=e.getOffsetParent();n&&"fixed"===n.getStyle("position")&&v(n),e.setStyle({position:"relative"});var r=t(e);return e.setStyle({position:i}),r})):Prototype.Browser.Webkit&&(l=function(t){t=$(t);var e=0,i=0;do{if(e+=t.offsetTop||0,i+=t.offsetLeft||0,t.offsetParent==document.body&&"absolute"==Element.getStyle(t,"position"))break;t=t.offsetParent}while(t);return new Element.Offset(i,e)}),Element.addMethods({getLayout:r,measure:o,getDimensions:s,getOffsetParent:a,cumulativeOffset:l,positionedOffset:u,cumulativeScrollOffset:c,viewportOffset:h,absolutize:d,relativize:p}),"getBoundingClientRect"in document.documentElement&&Element.addMethods({viewportOffset:function(t){if(t=$(t),b(t))return new Element.Offset(0,0);var e=t.getBoundingClientRect(),i=document.documentElement;return new Element.Offset(e.left-i.clientLeft,e.top-i.clientTop)}})}(),window.$$=function(){var t=$A(arguments).join(", ");return Prototype.Selector.select(t,document)},Prototype.Selector=function(){function t(){throw new Error('Method "Prototype.Selector.select" must be defined.')}function e(){throw new Error('Method "Prototype.Selector.match" must be defined.')}function i(t,e,i){i=i||0;var n,r=Prototype.Selector.match,o=t.length,s=0;for(n=0;o>n;n++)if(r(t[n],e)&&i==s++)return Element.extend(t[n])}function n(t){for(var e=0,i=t.length;i>e;e++)Element.extend(t[e]);return t}var r=Prototype.K;return{select:t,match:e,find:i,extendElements:Element.extend===r?r:n,extendElement:Element.extend}}(),Prototype._original_property=window.Sizzle,function(){function t(t,e,i,n,r,o){for(var s="previousSibling"==t&&!o,a=0,l=n.length;l>a;a++){var u=n[a];if(u){s&&1===u.nodeType&&(u.sizcache=i,u.sizset=a),u=u[t];for(var c=!1;u;){if(u.sizcache===i){c=n[u.sizset];break}if(1!==u.nodeType||o||(u.sizcache=i,u.sizset=a),u.nodeName===e){c=u;break}u=u[t]}n[a]=c}}}function e(t,e,i,n,r,o){for(var s="previousSibling"==t&&!o,l=0,u=n.length;u>l;l++){var c=n[l];if(c){s&&1===c.nodeType&&(c.sizcache=i,c.sizset=l),c=c[t];for(var h=!1;c;){if(c.sizcache===i){h=n[c.sizset];break}if(1===c.nodeType)if(o||(c.sizcache=i,c.sizset=l),"string"!=typeof e){if(c===e){h=!0;break}}else if(a.filter(e,[c]).length>0){h=c;break}c=c[t]}n[l]=h}}}var i=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^[\]]*\]|['"][^'"]*['"]|[^[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g,n=0,r=Object.prototype.toString,o=!1,s=!0;[0,0].sort(function(){return s=!1,0});var a=function(t,e,n,o){n=n||[];var s=e=e||document;if(1!==e.nodeType&&9!==e.nodeType)return[];if(!t||"string"!=typeof t)return n;for(var c,d,p,b,v=[],y=!0,w=m(e),S=t;null!==(i.exec(""),c=i.exec(S));)if(S=c[3],v.push(c[1]),c[2]){b=c[3];break}if(v.length>1&&u.exec(t))if(2===v.length&&l.relative[v[0]])d=g(v[0]+v[1],e);else for(d=l.relative[v[0]]?[e]:a(v.shift(),e);v.length;)t=v.shift(),l.relative[t]&&(t+=v.shift()),d=g(t,d);else{if(!o&&v.length>1&&9===e.nodeType&&!w&&l.match.ID.test(v[0])&&!l.match.ID.test(v[v.length-1])){var x=a.find(v.shift(),e,w);e=x.expr?a.filter(x.expr,x.set)[0]:x.set[0]}if(e){var x=o?{expr:v.pop(),set:h(o)}:a.find(v.pop(),1!==v.length||"~"!==v[0]&&"+"!==v[0]||!e.parentNode?e:e.parentNode,w);for(d=x.expr?a.filter(x.expr,x.set):x.set,v.length>0?p=h(d):y=!1;v.length;){var _=v.pop(),A=_;l.relative[_]?A=v.pop():_="",null==A&&(A=e),l.relative[_](p,A,w)}}else p=v=[]}if(p||(p=d),!p)throw"Syntax error, unrecognized expression: "+(_||t);if("[object Array]"===r.call(p))if(y)if(e&&1===e.nodeType)for(var E=0;null!=p[E];E++)p[E]&&(p[E]===!0||1===p[E].nodeType&&f(e,p[E]))&&n.push(d[E]);else for(var E=0;null!=p[E];E++)p[E]&&1===p[E].nodeType&&n.push(d[E]);else n.push.apply(n,p);else h(p,n);return b&&(a(b,s,n,o),a.uniqueSort(n)),n};a.uniqueSort=function(t){if(p&&(o=s,t.sort(p),o))for(var e=1;e<t.length;e++)t[e]===t[e-1]&&t.splice(e--,1);return t},a.matches=function(t,e){return a(t,null,null,e)},a.find=function(t,e,i){var n,r;if(!t)return[];for(var o=0,s=l.order.length;s>o;o++){var r,a=l.order[o];if(r=l.leftMatch[a].exec(t)){var u=r[1];if(r.splice(1,1),"\\"!==u.substr(u.length-1)&&(r[1]=(r[1]||"").replace(/\\/g,""),n=l.find[a](r,e,i),null!=n)){t=t.replace(l.match[a],"");break}}}return n||(n=e.getElementsByTagName("*")),{set:n,expr:t}},a.filter=function(t,e,i,n){for(var r,o,s=t,a=[],u=e,c=e&&e[0]&&m(e[0]);t&&e.length;){for(var h in l.filter)if(null!=(r=l.match[h].exec(t))){var d,p,f=l.filter[h];if(o=!1,u==a&&(a=[]),l.preFilter[h])if(r=l.preFilter[h](r,u,i,a,n,c)){if(r===!0)continue}else o=d=!0;if(r)for(var g=0;null!=(p=u[g]);g++)if(p){d=f(p,r,g,u);var b=n^!!d;i&&null!=d?b?o=!0:u[g]=!1:b&&(a.push(p),o=!0)}if(void 0!==d){if(i||(u=a),t=t.replace(l.match[h],""),!o)return[];break}}if(t==s){if(null==o)throw"Syntax error, unrecognized expression: "+t;break}s=t}return u};var l=a.selectors={order:["ID","NAME","TAG"],match:{ID:/#((?:[\w\u00c0-\uFFFF-]|\\.)+)/,CLASS:/\.((?:[\w\u00c0-\uFFFF-]|\\.)+)/,NAME:/\[name=['"]*((?:[\w\u00c0-\uFFFF-]|\\.)+)['"]*\]/,ATTR:/\[\s*((?:[\w\u00c0-\uFFFF-]|\\.)+)\s*(?:(\S?=)\s*(['"]*)(.*?)\3|)\s*\]/,TAG:/^((?:[\w\u00c0-\uFFFF\*-]|\\.)+)/,CHILD:/:(only|nth|last|first)-child(?:\((even|odd|[\dn+-]*)\))?/,POS:/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^-]|$)/,PSEUDO:/:((?:[\w\u00c0-\uFFFF-]|\\.)+)(?:\((['"]*)((?:\([^\)]+\)|[^\2\(\)]*)+)\2\))?/},leftMatch:{},attrMap:{"class":"className",
"for":"htmlFor"},attrHandle:{href:function(t){return t.getAttribute("href")}},relative:{"+":function(t,e,i){var n="string"==typeof e,r=n&&!/\W/.test(e),o=n&&!r;r&&!i&&(e=e.toUpperCase());for(var s,l=0,u=t.length;u>l;l++)if(s=t[l]){for(;(s=s.previousSibling)&&1!==s.nodeType;);t[l]=o||s&&s.nodeName===e?s||!1:s===e}o&&a.filter(e,t,!0)},">":function(t,e,i){var n="string"==typeof e;if(n&&!/\W/.test(e)){e=i?e:e.toUpperCase();for(var r=0,o=t.length;o>r;r++){var s=t[r];if(s){var l=s.parentNode;t[r]=l.nodeName===e?l:!1}}}else{for(var r=0,o=t.length;o>r;r++){var s=t[r];s&&(t[r]=n?s.parentNode:s.parentNode===e)}n&&a.filter(e,t,!0)}},"":function(i,r,o){var s=n++,a=e;if(!/\W/.test(r)){var l=r=o?r:r.toUpperCase();a=t}a("parentNode",r,s,i,l,o)},"~":function(i,r,o){var s=n++,a=e;if("string"==typeof r&&!/\W/.test(r)){var l=r=o?r:r.toUpperCase();a=t}a("previousSibling",r,s,i,l,o)}},find:{ID:function(t,e,i){if("undefined"!=typeof e.getElementById&&!i){var n=e.getElementById(t[1]);return n?[n]:[]}},NAME:function(t,e,i){if("undefined"!=typeof e.getElementsByName){for(var n=[],r=e.getElementsByName(t[1]),o=0,s=r.length;s>o;o++)r[o].getAttribute("name")===t[1]&&n.push(r[o]);return 0===n.length?null:n}},TAG:function(t,e){return e.getElementsByTagName(t[1])}},preFilter:{CLASS:function(t,e,i,n,r,o){if(t=" "+t[1].replace(/\\/g,"")+" ",o)return t;for(var s,a=0;null!=(s=e[a]);a++)s&&(r^(s.className&&(" "+s.className+" ").indexOf(t)>=0)?i||n.push(s):i&&(e[a]=!1));return!1},ID:function(t){return t[1].replace(/\\/g,"")},TAG:function(t,e){for(var i=0;e[i]===!1;i++);return e[i]&&m(e[i])?t[1]:t[1].toUpperCase()},CHILD:function(t){if("nth"==t[1]){var e=/(-?)(\d*)n((?:\+|-)?\d*)/.exec("even"==t[2]&&"2n"||"odd"==t[2]&&"2n+1"||!/\D/.test(t[2])&&"0n+"+t[2]||t[2]);t[2]=e[1]+(e[2]||1)-0,t[3]=e[3]-0}return t[0]=n++,t},ATTR:function(t,e,i,n,r,o){var s=t[1].replace(/\\/g,"");return!o&&l.attrMap[s]&&(t[1]=l.attrMap[s]),"~="===t[2]&&(t[4]=" "+t[4]+" "),t},PSEUDO:function(t,e,n,r,o){if("not"===t[1]){if(!((i.exec(t[3])||"").length>1||/^\w/.test(t[3]))){var s=a.filter(t[3],e,n,!0^o);return n||r.push.apply(r,s),!1}t[3]=a(t[3],null,null,e)}else if(l.match.POS.test(t[0])||l.match.CHILD.test(t[0]))return!0;return t},POS:function(t){return t.unshift(!0),t}},filters:{enabled:function(t){return t.disabled===!1&&"hidden"!==t.type},disabled:function(t){return t.disabled===!0},checked:function(t){return t.checked===!0},selected:function(t){return t.parentNode.selectedIndex,t.selected===!0},parent:function(t){return!!t.firstChild},empty:function(t){return!t.firstChild},has:function(t,e,i){return!!a(i[3],t).length},header:function(t){return/h\d/i.test(t.nodeName)},text:function(t){return"text"===t.type},radio:function(t){return"radio"===t.type},checkbox:function(t){return"checkbox"===t.type},file:function(t){return"file"===t.type},password:function(t){return"password"===t.type},submit:function(t){return"submit"===t.type},image:function(t){return"image"===t.type},reset:function(t){return"reset"===t.type},button:function(t){return"button"===t.type||"BUTTON"===t.nodeName.toUpperCase()},input:function(t){return/input|select|textarea|button/i.test(t.nodeName)}},setFilters:{first:function(t,e){return 0===e},last:function(t,e,i,n){return e===n.length-1},even:function(t,e){return e%2===0},odd:function(t,e){return e%2===1},lt:function(t,e,i){return e<i[3]-0},gt:function(t,e,i){return e>i[3]-0},nth:function(t,e,i){return i[3]-0==e},eq:function(t,e,i){return i[3]-0==e}},filter:{PSEUDO:function(t,e,i,n){var r=e[1],o=l.filters[r];if(o)return o(t,i,e,n);if("contains"===r)return(t.textContent||t.innerText||"").indexOf(e[3])>=0;if("not"===r){for(var s=e[3],i=0,a=s.length;a>i;i++)if(s[i]===t)return!1;return!0}},CHILD:function(t,e){var i=e[1],n=t;switch(i){case"only":case"first":for(;n=n.previousSibling;)if(1===n.nodeType)return!1;if("first"==i)return!0;n=t;case"last":for(;n=n.nextSibling;)if(1===n.nodeType)return!1;return!0;case"nth":var r=e[2],o=e[3];if(1==r&&0==o)return!0;var s=e[0],a=t.parentNode;if(a&&(a.sizcache!==s||!t.nodeIndex)){var l=0;for(n=a.firstChild;n;n=n.nextSibling)1===n.nodeType&&(n.nodeIndex=++l);a.sizcache=s}var u=t.nodeIndex-o;return 0==r?0==u:u%r==0&&u/r>=0}},ID:function(t,e){return 1===t.nodeType&&t.getAttribute("id")===e},TAG:function(t,e){return"*"===e&&1===t.nodeType||t.nodeName===e},CLASS:function(t,e){return(" "+(t.className||t.getAttribute("class"))+" ").indexOf(e)>-1},ATTR:function(t,e){var i=e[1],n=l.attrHandle[i]?l.attrHandle[i](t):null!=t[i]?t[i]:t.getAttribute(i),r=n+"",o=e[2],s=e[4];return null==n?"!="===o:"="===o?r===s:"*="===o?r.indexOf(s)>=0:"~="===o?(" "+r+" ").indexOf(s)>=0:s?"!="===o?r!=s:"^="===o?0===r.indexOf(s):"$="===o?r.substr(r.length-s.length)===s:"|="===o?r===s||r.substr(0,s.length+1)===s+"-":!1:r&&n!==!1},POS:function(t,e,i,n){var r=e[2],o=l.setFilters[r];return o?o(t,i,e,n):void 0}}},u=l.match.POS;for(var c in l.match)l.match[c]=new RegExp(l.match[c].source+/(?![^\[]*\])(?![^\(]*\))/.source),l.leftMatch[c]=new RegExp(/(^(?:.|\r|\n)*?)/.source+l.match[c].source);var h=function(t,e){return t=Array.prototype.slice.call(t,0),e?(e.push.apply(e,t),e):t};try{Array.prototype.slice.call(document.documentElement.childNodes,0)}catch(d){h=function(t,e){var i=e||[];if("[object Array]"===r.call(t))Array.prototype.push.apply(i,t);else if("number"==typeof t.length)for(var n=0,o=t.length;o>n;n++)i.push(t[n]);else for(var n=0;t[n];n++)i.push(t[n]);return i}}var p;document.documentElement.compareDocumentPosition?p=function(t,e){if(!t.compareDocumentPosition||!e.compareDocumentPosition)return t==e&&(o=!0),0;var i=4&t.compareDocumentPosition(e)?-1:t===e?0:1;return 0===i&&(o=!0),i}:"sourceIndex"in document.documentElement?p=function(t,e){if(!t.sourceIndex||!e.sourceIndex)return t==e&&(o=!0),0;var i=t.sourceIndex-e.sourceIndex;return 0===i&&(o=!0),i}:document.createRange&&(p=function(t,e){if(!t.ownerDocument||!e.ownerDocument)return t==e&&(o=!0),0;var i=t.ownerDocument.createRange(),n=e.ownerDocument.createRange();i.setStart(t,0),i.setEnd(t,0),n.setStart(e,0),n.setEnd(e,0);var r=i.compareBoundaryPoints(Range.START_TO_END,n);return 0===r&&(o=!0),r}),function(){var t=document.createElement("div"),e="script"+(new Date).getTime();t.innerHTML="<a name='"+e+"'/>";var i=document.documentElement;i.insertBefore(t,i.firstChild),document.getElementById(e)&&(l.find.ID=function(t,e,i){if("undefined"!=typeof e.getElementById&&!i){var n=e.getElementById(t[1]);return n?n.id===t[1]||"undefined"!=typeof n.getAttributeNode&&n.getAttributeNode("id").nodeValue===t[1]?[n]:void 0:[]}},l.filter.ID=function(t,e){var i="undefined"!=typeof t.getAttributeNode&&t.getAttributeNode("id");return 1===t.nodeType&&i&&i.nodeValue===e}),i.removeChild(t),i=t=null}(),function(){var t=document.createElement("div");t.appendChild(document.createComment("")),t.getElementsByTagName("*").length>0&&(l.find.TAG=function(t,e){var i=e.getElementsByTagName(t[1]);if("*"===t[1]){for(var n=[],r=0;i[r];r++)1===i[r].nodeType&&n.push(i[r]);i=n}return i}),t.innerHTML="<a href='#'></a>",t.firstChild&&"undefined"!=typeof t.firstChild.getAttribute&&"#"!==t.firstChild.getAttribute("href")&&(l.attrHandle.href=function(t){return t.getAttribute("href",2)}),t=null}(),document.querySelectorAll&&!function(){var t=a,e=document.createElement("div");if(e.innerHTML="<p class='TEST'></p>",!e.querySelectorAll||0!==e.querySelectorAll(".TEST").length){a=function(e,i,n,r){if(i=i||document,!r&&9===i.nodeType&&!m(i))try{return h(i.querySelectorAll(e),n)}catch(o){}return t(e,i,n,r)};for(var i in t)a[i]=t[i];e=null}}(),document.getElementsByClassName&&document.documentElement.getElementsByClassName&&!function(){var t=document.createElement("div");t.innerHTML="<div class='test e'></div><div class='test'></div>",0!==t.getElementsByClassName("e").length&&(t.lastChild.className="e",1!==t.getElementsByClassName("e").length&&(l.order.splice(1,0,"CLASS"),l.find.CLASS=function(t,e,i){return"undefined"==typeof e.getElementsByClassName||i?void 0:e.getElementsByClassName(t[1])},t=null))}();var f=document.compareDocumentPosition?function(t,e){return 16&t.compareDocumentPosition(e)}:function(t,e){return t!==e&&(t.contains?t.contains(e):!0)},m=function(t){return 9===t.nodeType&&"HTML"!==t.documentElement.nodeName||!!t.ownerDocument&&"HTML"!==t.ownerDocument.documentElement.nodeName},g=function(t,e){for(var i,n=[],r="",o=e.nodeType?[e]:e;i=l.match.PSEUDO.exec(t);)r+=i[0],t=t.replace(l.match.PSEUDO,"");t=l.relative[t]?t+"*":t;for(var s=0,u=o.length;u>s;s++)a(t,o[s],n);return a.filter(r,n)};window.Sizzle=a}(),function(t){function e(e,i){return n(t(e,i||document))}function i(e,i){return 1==t.matches(i,[e]).length}var n=Prototype.Selector.extendElements;Prototype.Selector.engine=t,Prototype.Selector.select=e,Prototype.Selector.match=i}(Sizzle),window.Sizzle=Prototype._original_property,delete Prototype._original_property;var Form={reset:function(t){return t=$(t),t.reset(),t},serializeElements:function(t,e){"object"!=typeof e?e={hash:!!e}:Object.isUndefined(e.hash)&&(e.hash=!0);var i,n,r,o,s=!1,a=e.submit;return e.hash?(o={},r=function(t,e,i){return e in t?(Object.isArray(t[e])||(t[e]=[t[e]]),t[e].push(i)):t[e]=i,t}):(o="",r=function(t,e,i){return t+(t?"&":"")+encodeURIComponent(e)+"="+encodeURIComponent(i)}),t.inject(o,function(t,e){return!e.disabled&&e.name&&(i=e.name,n=$(e).getValue(),null==n||"file"==e.type||"submit"==e.type&&(s||a===!1||a&&i!=a||!(s=!0))||(t=r(t,i,n))),t})}};Form.Methods={serialize:function(t,e){return Form.serializeElements(Form.getElements(t),e)},getElements:function(t){for(var e,i=$(t).getElementsByTagName("*"),n=[],r=Form.Element.Serializers,o=0;e=i[o];o++)n.push(e);return n.inject([],function(t,e){return r[e.tagName.toLowerCase()]&&t.push(Element.extend(e)),t})},getInputs:function(t,e,i){t=$(t);var n=t.getElementsByTagName("input");if(!e&&!i)return $A(n).map(Element.extend);for(var r=0,o=[],s=n.length;s>r;r++){var a=n[r];e&&a.type!=e||i&&a.name!=i||o.push(Element.extend(a))}return o},disable:function(t){return t=$(t),Form.getElements(t).invoke("disable"),t},enable:function(t){return t=$(t),Form.getElements(t).invoke("enable"),t},findFirstElement:function(t){var e=$(t).getElements().findAll(function(t){return"hidden"!=t.type&&!t.disabled}),i=e.findAll(function(t){return t.hasAttribute("tabIndex")&&t.tabIndex>=0}).sortBy(function(t){return t.tabIndex}).first();return i?i:e.find(function(t){return/^(?:input|select|textarea)$/i.test(t.tagName)})},focusFirstElement:function(t){t=$(t);var e=t.findFirstElement();return e&&e.activate(),t},request:function(t,e){t=$(t),e=Object.clone(e||{});var i=e.parameters,n=t.readAttribute("action")||"";return n.blank()&&(n=window.location.href),e.parameters=t.serialize(!0),i&&(Object.isString(i)&&(i=i.toQueryParams()),Object.extend(e.parameters,i)),t.hasAttribute("method")&&!e.method&&(e.method=t.method),new Ajax.Request(n,e)}},Form.Element={focus:function(t){return $(t).focus(),t},select:function(t){return $(t).select(),t}},Form.Element.Methods={serialize:function(t){if(t=$(t),!t.disabled&&t.name){var e=t.getValue();if(void 0!=e){var i={};return i[t.name]=e,Object.toQueryString(i)}}return""},getValue:function(t){t=$(t);var e=t.tagName.toLowerCase();return Form.Element.Serializers[e](t)},setValue:function(t,e){t=$(t);var i=t.tagName.toLowerCase();return Form.Element.Serializers[i](t,e),t},clear:function(t){return $(t).value="",t},present:function(t){return""!=$(t).value},activate:function(t){t=$(t);try{t.focus(),!t.select||"input"==t.tagName.toLowerCase()&&/^(?:button|reset|submit)$/i.test(t.type)||t.select()}catch(e){}return t},disable:function(t){return t=$(t),t.disabled=!0,t},enable:function(t){return t=$(t),t.disabled=!1,t}};var Field=Form.Element,$F=Form.Element.Methods.getValue;Form.Element.Serializers=function(){function t(t,n){switch(t.type.toLowerCase()){case"checkbox":case"radio":return e(t,n);default:return i(t,n)}}function e(t,e){return Object.isUndefined(e)?t.checked?t.value:null:void(t.checked=!!e)}function i(t,e){return Object.isUndefined(e)?t.value:void(t.value=e)}function n(t,e){if(Object.isUndefined(e))return("select-one"===t.type?r:o)(t);for(var i,n,s=!Object.isArray(e),a=0,l=t.length;l>a;a++)if(i=t.options[a],n=this.optionValue(i),s){if(n==e)return void(i.selected=!0)}else i.selected=e.include(n)}function r(t){var e=t.selectedIndex;return e>=0?s(t.options[e]):null}function o(t){var e,i=t.length;if(!i)return null;for(var n=0,e=[];i>n;n++){var r=t.options[n];r.selected&&e.push(s(r))}return e}function s(t){return Element.hasAttribute(t,"value")?t.value:t.text}return{input:t,inputSelector:e,textarea:i,select:n,selectOne:r,selectMany:o,optionValue:s,button:i}}(),Abstract.TimedObserver=Class.create(PeriodicalExecuter,{initialize:function(t,e,i,n){t(n,i),this.element=$(e),this.lastValue=this.getValue()},execute:function(){var t=this.getValue();(Object.isString(this.lastValue)&&Object.isString(t)?this.lastValue!=t:String(this.lastValue)!=String(t))&&(this.callback(this.element,t),this.lastValue=t)}}),Form.Element.Observer=Class.create(Abstract.TimedObserver,{getValue:function(){return Form.Element.getValue(this.element)}}),Form.Observer=Class.create(Abstract.TimedObserver,{getValue:function(){return Form.serialize(this.element)}}),Abstract.EventObserver=Class.create({initialize:function(t,e){this.element=$(t),this.callback=e,this.lastValue=this.getValue(),"form"==this.element.tagName.toLowerCase()?this.registerFormCallbacks():this.registerCallback(this.element)},onElementEvent:function(){var t=this.getValue();this.lastValue!=t&&(this.callback(this.element,t),this.lastValue=t)},registerFormCallbacks:function(){Form.getElements(this.element).each(this.registerCallback,this)},registerCallback:function(t){if(t.type)switch(t.type.toLowerCase()){case"checkbox":case"radio":Event.observe(t,"click",this.onElementEvent.bind(this));break;default:Event.observe(t,"change",this.onElementEvent.bind(this))}}}),Form.Element.EventObserver=Class.create(Abstract.EventObserver,{getValue:function(){return Form.Element.getValue(this.element)}}),Form.EventObserver=Class.create(Abstract.EventObserver,{getValue:function(){return Form.serialize(this.element)}}),function(){function t(t,e){return t.which?t.which===e+1:t.button===e}function e(t,e){return t.button===A[e]}function i(t,e){switch(e){case 0:return 1==t.which&&!t.metaKey;case 1:return 2==t.which||1==t.which&&t.metaKey;case 2:return 3==t.which;default:return!1}}function n(t){return _(t,0)}function r(t){return _(t,1)}function o(t){return _(t,2)}function s(t){t=y.extend(t);var e=t.target,i=t.type,n=t.currentTarget;return n&&n.tagName&&("load"===i||"error"===i||"click"===i&&"input"===n.tagName.toLowerCase()&&"radio"===n.type)&&(e=n),e.nodeType==Node.TEXT_NODE&&(e=e.parentNode),Element.extend(e)}function a(t,e){var i=y.element(t);if(!e)return i;for(;i;){if(Object.isElement(i)&&Prototype.Selector.match(i,e))return Element.extend(i);i=i.parentNode}}function l(t){return{x:u(t),y:c(t)}}function u(t){var e=document.documentElement,i=document.body||{scrollLeft:0};return t.pageX||t.clientX+(e.scrollLeft||i.scrollLeft)-(e.clientLeft||0)}function c(t){var e=document.documentElement,i=document.body||{scrollTop:0};return t.pageY||t.clientY+(e.scrollTop||i.scrollTop)-(e.clientTop||0)}function h(t){y.extend(t),t.preventDefault(),t.stopPropagation(),t.stopped=!0}function d(t){var e;switch(t.type){case"mouseover":case"mouseenter":e=t.fromElement;break;case"mouseout":case"mouseleave":e=t.toElement;break;default:return null}return Element.extend(e)}function p(t,e,i){var n=Element.retrieve(t,"prototype_event_registry");Object.isUndefined(n)&&(C.push(t),n=Element.retrieve(t,"prototype_event_registry",$H()));var r=n.get(e);if(Object.isUndefined(r)&&(r=[],n.set(e,r)),r.pluck("handler").include(i))return!1;var o;return e.include(":")?o=function(n){return Object.isUndefined(n.eventName)?!1:n.eventName!==e?!1:(y.extend(n,t),void i.call(t,n))}:S||"mouseenter"!==e&&"mouseleave"!==e?o=function(e){y.extend(e,t),i.call(t,e)}:("mouseenter"===e||"mouseleave"===e)&&(o=function(e){y.extend(e,t);for(var n=e.relatedTarget;n&&n!==t;)try{n=n.parentNode}catch(r){n=t}n!==t&&i.call(t,e)}),o.handler=i,r.push(o),o}function f(){for(var t=0,e=C.length;e>t;t++)y.stopObserving(C[t]),C[t]=null}function m(t,e,i){t=$(t);var n=p(t,e,i);if(!n)return t;if(e.include(":"))t.addEventListener?t.addEventListener("dataavailable",n,!1):(t.attachEvent("ondataavailable",n),t.attachEvent("onlosecapture",n));else{var r=T(e);t.addEventListener?t.addEventListener(r,n,!1):t.attachEvent("on"+r,n)}return t}function g(t,e,i){t=$(t);var n=Element.retrieve(t,"prototype_event_registry");if(!n)return t;if(!e)return n.each(function(e){var i=e.key;g(t,i)}),t;var r=n.get(e);if(!r)return t;if(!i)return r.each(function(i){g(t,e,i.handler)}),t;for(var o,s=r.length;s--;)if(r[s].handler===i){o=r[s];break}if(!o)return t;if(e.include(":"))t.removeEventListener?t.removeEventListener("dataavailable",o,!1):(t.detachEvent("ondataavailable",o),t.detachEvent("onlosecapture",o));else{var a=T(e);t.removeEventListener?t.removeEventListener(a,o,!1):t.detachEvent("on"+a,o)}return n.set(e,r.without(o)),t}function b(t,e,i,n){t=$(t),Object.isUndefined(n)&&(n=!0),t==document&&document.createEvent&&!t.dispatchEvent&&(t=document.documentElement);var r;return document.createEvent?(r=document.createEvent("HTMLEvents"),r.initEvent("dataavailable",n,!0)):(r=document.createEventObject(),r.eventType=n?"ondataavailable":"onlosecapture"),r.eventName=e,r.memo=i||{},document.createEvent?t.dispatchEvent(r):t.fireEvent(r.eventType,r),y.extend(r)}function v(t,e,i,n){return t=$(t),Object.isFunction(i)&&Object.isUndefined(n)&&(n=i,i=null),new y.Handler(t,e,i,n).start()}var y={KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ESC:27,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_DELETE:46,KEY_HOME:36,KEY_END:35,KEY_PAGEUP:33,KEY_PAGEDOWN:34,KEY_INSERT:45,cache:{}},w=document.documentElement,S="onmouseenter"in w&&"onmouseleave"in w,x=function(t){return!1};window.attachEvent&&(x=window.addEventListener?function(t){return!(t instanceof window.Event)}:function(t){return!0});var _,A={0:1,1:4,2:2};_=window.attachEvent?window.addEventListener?function(i,n){return x(i)?e(i,n):t(i,n)}:e:Prototype.Browser.WebKit?i:t,y.Methods={isLeftClick:n,isMiddleClick:r,isRightClick:o,element:s,findElement:a,pointer:l,pointerX:u,pointerY:c,stop:h};var E=Object.keys(y.Methods).inject({},function(t,e){return t[e]=y.Methods[e].methodize(),t});if(window.attachEvent){var O={stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.returnValue=!1},inspect:function(){return"[object Event]"}};y.extend=function(t,e){if(!t)return!1;if(!x(t))return t;if(t._extendedByPrototype)return t;t._extendedByPrototype=Prototype.emptyFunction;var i=y.pointer(t);return Object.extend(t,{target:t.srcElement||e,relatedTarget:d(t),pageX:i.x,pageY:i.y}),Object.extend(t,E),Object.extend(t,O),t}}else y.extend=Prototype.K;window.addEventListener&&(y.prototype=window.Event.prototype||document.createEvent("HTMLEvents").__proto__,Object.extend(y.prototype,E));var C=[];Prototype.Browser.IE&&window.attachEvent("onunload",f),Prototype.Browser.WebKit&&window.addEventListener("unload",Prototype.emptyFunction,!1);var T=Prototype.K,B={mouseenter:"mouseover",mouseleave:"mouseout"};S||(T=function(t){return B[t]||t}),y.Handler=Class.create({initialize:function(t,e,i,n){this.element=$(t),this.eventName=e,this.selector=i,this.callback=n,this.handler=this.handleEvent.bind(this)},start:function(){return y.observe(this.element,this.eventName,this.handler),this},stop:function(){return y.stopObserving(this.element,this.eventName,this.handler),this},handleEvent:function(t){var e=y.findElement(t,this.selector);e&&this.callback.call(this.element,t,e)}}),Object.extend(y,y.Methods),Object.extend(y,{fire:b,observe:m,stopObserving:g,on:v}),Element.addMethods({fire:b,observe:m,stopObserving:g,on:v}),Object.extend(document,{fire:b.methodize(),observe:m.methodize(),stopObserving:g.methodize(),on:v.methodize(),loaded:!1}),window.Event?Object.extend(window.Event,y):window.Event=y}(),function(){function t(){document.loaded||(n&&window.clearTimeout(n),document.loaded=!0,document.fire("dom:loaded"))}function e(){"complete"===document.readyState&&(document.stopObserving("readystatechange",e),t())}function i(){try{document.documentElement.doScroll("left")}catch(e){return void(n=i.defer())}t()}var n;document.addEventListener?document.addEventListener("DOMContentLoaded",t,!1):(document.observe("readystatechange",e),window==top&&(n=i.defer())),Event.observe(window,"load",t)}(),Element.addMethods(),Hash.toQueryString=Object.toQueryString;var Toggle={display:Element.toggle};Element.Methods.childOf=Element.Methods.descendantOf;var Insertion={Before:function(t,e){return Element.insert(t,{before:e})},Top:function(t,e){return Element.insert(t,{top:e})},Bottom:function(t,e){return Element.insert(t,{bottom:e})},After:function(t,e){return Element.insert(t,{after:e})}},$continue=new Error('"throw $continue" is deprecated, use "return" instead'),Position={includeScrollOffsets:!1,prepare:function(){this.deltaX=window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft||0,this.deltaY=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0},within:function(t,e,i){return this.includeScrollOffsets?this.withinIncludingScrolloffsets(t,e,i):(this.xcomp=e,this.ycomp=i,this.offset=Element.cumulativeOffset(t),i>=this.offset[1]&&i<this.offset[1]+t.offsetHeight&&e>=this.offset[0]&&e<this.offset[0]+t.offsetWidth)},withinIncludingScrolloffsets:function(t,e,i){var n=Element.cumulativeScrollOffset(t);return this.xcomp=e+n[0]-this.deltaX,this.ycomp=i+n[1]-this.deltaY,this.offset=Element.cumulativeOffset(t),this.ycomp>=this.offset[1]&&this.ycomp<this.offset[1]+t.offsetHeight&&this.xcomp>=this.offset[0]&&this.xcomp<this.offset[0]+t.offsetWidth},overlap:function(t,e){return t?"vertical"==t?(this.offset[1]+e.offsetHeight-this.ycomp)/e.offsetHeight:"horizontal"==t?(this.offset[0]+e.offsetWidth-this.xcomp)/e.offsetWidth:void 0:0},cumulativeOffset:Element.Methods.cumulativeOffset,positionedOffset:Element.Methods.positionedOffset,absolutize:function(t){return Position.prepare(),Element.absolutize(t)},relativize:function(t){return Position.prepare(),Element.relativize(t)},realOffset:Element.Methods.cumulativeScrollOffset,offsetParent:Element.Methods.getOffsetParent,page:Element.Methods.viewportOffset,clone:function(t,e,i){return i=i||{},Element.clonePosition(e,t,i)}};document.getElementsByClassName||(document.getElementsByClassName=function(t){function e(t){return t.blank()?null:"[contains(concat(' ', @class, ' '), ' "+t+" ')]"}return t.getElementsByClassName=Prototype.BrowserFeatures.XPath?function(t,i){i=i.toString().strip();var n=/\s/.test(i)?$w(i).map(e).join(""):e(i);return n?document._getElementsByXPath(".//*"+n,t):[]}:function(t,e){e=e.toString().strip();var i=[],n=/\s/.test(e)?$w(e):null;if(!n&&!e)return i;var r=$(t).getElementsByTagName("*");e=" "+e+" ";for(var o,s,a=0;o=r[a];a++)o.className&&(s=" "+o.className+" ")&&(s.include(e)||n&&n.all(function(t){return!t.toString().blank()&&s.include(" "+t+" ")}))&&i.push(Element.extend(o));return i},function(t,e){return $(e||document.body).getElementsByClassName(t)}}(Element.Methods)),Element.ClassNames=Class.create(),Element.ClassNames.prototype={initialize:function(t){this.element=$(t)},_each:function(t){this.element.className.split(/\s+/).select(function(t){return t.length>0})._each(t)},set:function(t){this.element.className=t},add:function(t){this.include(t)||this.set($A(this).concat(t).join(" "))},remove:function(t){this.include(t)&&this.set($A(this).without(t).join(" "))},toString:function(){return $A(this).join(" ")}},Object.extend(Element.ClassNames.prototype,Enumerable),function(){window.Selector=Class.create({initialize:function(t){this.expression=t.strip()},findElements:function(t){return Prototype.Selector.select(this.expression,t)},match:function(t){return Prototype.Selector.match(t,this.expression)},toString:function(){return this.expression},inspect:function(){return"#<Selector: "+this.expression+">"}}),Object.extend(Selector,{matchElements:function(t,e){for(var i=Prototype.Selector.match,n=[],r=0,o=t.length;o>r;r++){var s=t[r];i(s,e)&&n.push(Element.extend(s))}return n},findElement:function(t,e,i){i=i||0;for(var n,r=0,o=0,s=t.length;s>o;o++)if(n=t[o],Prototype.Selector.match(n,e)&&i===r++)return Element.extend(n)},findChildElements:function(t,e){var i=e.toArray().join(", ");return Prototype.Selector.select(i,t||document)}})}(),function(t){var e,i,n="0.3.4",r="hasOwnProperty",o=/[\.\/]/,s="*",a=function(){},l=function(t,e){return t-e},u={n:{}},c=function(t,n){var r,o=i,s=Array.prototype.slice.call(arguments,2),a=c.listeners(t),u=0,h=[],d={},p=[],f=e;e=t,i=0;for(var m=0,g=a.length;g>m;m++)"zIndex"in a[m]&&(h.push(a[m].zIndex),a[m].zIndex<0&&(d[a[m].zIndex]=a[m]));for(h.sort(l);h[u]<0;)if(r=d[h[u++]],p.push(r.apply(n,s)),i)return i=o,p;for(m=0;g>m;m++)if(r=a[m],"zIndex"in r)if(r.zIndex==h[u]){if(p.push(r.apply(n,s)),i)break;do if(u++,r=d[h[u]],r&&p.push(r.apply(n,s)),i)break;while(r)}else d[r.zIndex]=r;else if(p.push(r.apply(n,s)),i)break;return i=o,e=f,p.length?p:null};c.listeners=function(t){var e,i,n,r,a,l,c,h,d=t.split(o),p=u,f=[p],m=[];for(r=0,a=d.length;a>r;r++){for(h=[],l=0,c=f.length;c>l;l++)for(p=f[l].n,i=[p[d[r]],p[s]],n=2;n--;)e=i[n],e&&(h.push(e),m=m.concat(e.f||[]));f=h}return m},c.on=function(t,e){for(var i=t.split(o),n=u,r=0,s=i.length;s>r;r++)n=n.n,!n[i[r]]&&(n[i[r]]={n:{}}),n=n[i[r]];for(n.f=n.f||[],r=0,s=n.f.length;s>r;r++)if(n.f[r]==e)return a;return n.f.push(e),function(t){+t==+t&&(e.zIndex=+t)}},c.stop=function(){i=1},c.nt=function(t){return t?new RegExp("(?:\\.|\\/|^)"+t+"(?:\\.|\\/|$)").test(e):e},c.off=c.unbind=function(t,e){var i,n,a,l,c,h,d,p=t.split(o),f=[u];for(l=0,c=p.length;c>l;l++)for(h=0;h<f.length;h+=a.length-2){if(a=[h,1],i=f[h].n,p[l]!=s)i[p[l]]&&a.push(i[p[l]]);else for(n in i)i[r](n)&&a.push(i[n]);f.splice.apply(f,a)}for(l=0,c=f.length;c>l;l++)for(i=f[l];i.n;){if(e){if(i.f){for(h=0,d=i.f.length;d>h;h++)if(i.f[h]==e){i.f.splice(h,1);break}!i.f.length&&delete i.f}for(n in i.n)if(i.n[r](n)&&i.n[n].f){var m=i.n[n].f;for(h=0,d=m.length;d>h;h++)if(m[h]==e){m.splice(h,1);break}!m.length&&delete i.n[n].f}}else{delete i.f;for(n in i.n)i.n[r](n)&&i.n[n].f&&delete i.n[n].f}i=i.n}},c.once=function(t,e){var i=function(){var n=e.apply(this,arguments);return c.unbind(t,i),n};return c.on(t,i)},c.version=n,c.toString=function(){return"You are running Eve "+n},"undefined"!=typeof module&&module.exports?module.exports=c:"undefined"!=typeof define?define("eve",[],function(){return c}):t.eve=c}(this),function(){function t(e){if(t.is(e,"function"))return v?e():eve.on("raphael.DOMload",e);if(t.is(e,U))return t._engine.create[C](t,e.splice(0,3+t.is(e[0],$))).add(e);var i=Array.prototype.slice.call(arguments,0);if(t.is(i[i.length-1],"function")){var n=i.pop();return v?n.call(t._engine.create[C](t,i)):eve.on("raphael.DOMload",function(){n.call(t._engine.create[C](t,i))})}return t._engine.create[C](t,arguments)}function e(t){if(Object(t)!==t)return t;var i=new t.constructor;for(var n in t)t[_](n)&&(i[n]=e(t[n]));return i}function i(t,e){for(var i=0,n=t.length;n>i;i++)if(t[i]===e)return t.push(t.splice(i,1)[0])}function n(t,e,n){function r(){var o=Array.prototype.slice.call(arguments,0),s=o.join(""),a=r.cache=r.cache||{},l=r.count=r.count||[];return a[_](s)?(i(l,s),n?n(a[s]):a[s]):(l.length>=1e3&&delete a[l.shift()],l.push(s),a[s]=t[C](e,o),n?n(a[s]):a[s])}return r}function r(){return this.hex}function o(t,e){for(var i=[],n=0,r=t.length;r-2*!e>n;n+=2){var o=[{x:+t[n-2],y:+t[n-1]},{x:+t[n],y:+t[n+1]},{x:+t[n+2],y:+t[n+3]},{x:+t[n+4],y:+t[n+5]}];e?n?r-4==n?o[3]={x:+t[0],y:+t[1]}:r-2==n&&(o[2]={x:+t[0],y:+t[1]},o[3]={x:+t[2],y:+t[3]}):o[0]={x:+t[r-2],y:+t[r-1]}:r-4==n?o[3]=o[2]:n||(o[0]={x:+t[n],y:+t[n+1]}),i.push(["C",(-o[0].x+6*o[1].x+o[2].x)/6,(-o[0].y+6*o[1].y+o[2].y)/6,(o[1].x+6*o[2].x-o[3].x)/6,(o[1].y+6*o[2].y-o[3].y)/6,o[2].x,o[2].y])}return i}function s(t,e,i,n,r){var o=-3*e+9*i-9*n+3*r,s=t*o+6*e-12*i+6*n;return t*s-3*e+3*i}function a(t,e,i,n,r,o,a,l,u){null==u&&(u=1),u=u>1?1:0>u?0:u;for(var c=u/2,h=12,d=[-.1252,.1252,-.3678,.3678,-.5873,.5873,-.7699,.7699,-.9041,.9041,-.9816,.9816],p=[.2491,.2491,.2335,.2335,.2032,.2032,.1601,.1601,.1069,.1069,.0472,.0472],f=0,m=0;h>m;m++){var g=c*d[m]+c,b=s(g,t,i,r,a),v=s(g,e,n,o,l),y=b*b+v*v;f+=p[m]*I.sqrt(y)}return c*f}function l(t,e,i,n,r,o,s,l,u){if(!(0>u||a(t,e,i,n,r,o,s,l)<u)){var c,h=1,d=h/2,p=h-d,f=.01;for(c=a(t,e,i,n,r,o,s,l,p);F(c-u)>f;)d/=2,p+=(u>c?1:-1)*d,c=a(t,e,i,n,r,o,s,l,p);return p}}function u(t,e,i,n,r,o,s,a){if(!(G(t,i)<V(r,s)||V(t,i)>G(r,s)||G(e,n)<V(o,a)||V(e,n)>G(o,a))){var l=(t*n-e*i)*(r-s)-(t-i)*(r*a-o*s),u=(t*n-e*i)*(o-a)-(e-n)*(r*a-o*s),c=(t-i)*(o-a)-(e-n)*(r-s);if(c){var h=l/c,d=u/c,p=+h.toFixed(2),f=+d.toFixed(2);if(!(p<+V(t,i).toFixed(2)||p>+G(t,i).toFixed(2)||p<+V(r,s).toFixed(2)||p>+G(r,s).toFixed(2)||f<+V(e,n).toFixed(2)||f>+G(e,n).toFixed(2)||f<+V(o,a).toFixed(2)||f>+G(o,a).toFixed(2)))return{x:h,y:d}}}}function c(e,i,n){var r=t.bezierBBox(e),o=t.bezierBBox(i);if(!t.isBBoxIntersect(r,o))return n?0:[];for(var s=a.apply(0,e),l=a.apply(0,i),c=~~(s/5),h=~~(l/5),d=[],p=[],f={},m=n?0:[],g=0;c+1>g;g++){var b=t.findDotsAtSegment.apply(t,e.concat(g/c));d.push({x:b.x,y:b.y,t:g/c})}for(g=0;h+1>g;g++)b=t.findDotsAtSegment.apply(t,i.concat(g/h)),p.push({x:b.x,y:b.y,t:g/h});for(g=0;c>g;g++)for(var v=0;h>v;v++){var y=d[g],w=d[g+1],S=p[v],x=p[v+1],_=F(w.x-y.x)<.001?"y":"x",A=F(x.x-S.x)<.001?"y":"x",E=u(y.x,y.y,w.x,w.y,S.x,S.y,x.x,x.y);if(E){if(f[E.x.toFixed(4)]==E.y.toFixed(4))continue;f[E.x.toFixed(4)]=E.y.toFixed(4);var O=y.t+F((E[_]-y[_])/(w[_]-y[_]))*(w.t-y.t),C=S.t+F((E[A]-S[A])/(x[A]-S[A]))*(x.t-S.t);O>=0&&1>=O&&C>=0&&1>=C&&(n?m++:m.push({x:E.x,y:E.y,t1:O,t2:C}))}}return m}function h(e,i,n){e=t._path2curve(e),i=t._path2curve(i);for(var r,o,s,a,l,u,h,d,p,f,m=n?0:[],g=0,b=e.length;b>g;g++){var v=e[g];if("M"==v[0])r=l=v[1],o=u=v[2];else{"C"==v[0]?(p=[r,o].concat(v.slice(1)),r=p[6],o=p[7]):(p=[r,o,r,o,l,u,l,u],r=l,o=u);for(var y=0,w=i.length;w>y;y++){var S=i[y];if("M"==S[0])s=h=S[1],a=d=S[2];else{"C"==S[0]?(f=[s,a].concat(S.slice(1)),s=f[6],a=f[7]):(f=[s,a,s,a,h,d,h,d],s=h,a=d);var x=c(p,f,n);if(n)m+=x;else{for(var _=0,A=x.length;A>_;_++)x[_].segment1=g,x[_].segment2=y,x[_].bez1=p,x[_].bez2=f;m=m.concat(x)}}}}}return m}function d(t,e,i,n,r,o){null!=t?(this.a=+t,this.b=+e,this.c=+i,this.d=+n,this.e=+r,this.f=+o):(this.a=1,this.b=0,this.c=0,this.d=1,this.e=0,this.f=0)}function p(){return this.x+M+this.y+M+this.width+"  "+this.height}function f(t,e,i,n,r,o){function s(t){return((h*t+c)*t+u)*t}function a(t,e){var i=l(t,e);return((f*i+p)*i+d)*i}function l(t,e){var i,n,r,o,a,l;for(r=t,l=0;8>l;l++){if(o=s(r)-t,F(o)<e)return r;if(a=(3*h*r+2*c)*r+u,F(a)<1e-6)break;r-=o/a}if(i=0,n=1,r=t,i>r)return i;if(r>n)return n;for(;n>i;){if(o=s(r),F(o-t)<e)return r;t>o?i=r:n=r,r=(n-i)/2+i}return r}var u=3*e,c=3*(n-e)-u,h=1-u-c,d=3*i,p=3*(r-i)-d,f=1-d-p;return a(t,1/(200*o))}function m(t,e){var i=[],n={};if(this.ms=e,this.times=1,t){for(var r in t)t[_](r)&&(n[J(r)]=t[r],i.push(J(r)));i.sort(ut)}this.anim=n,this.top=i[i.length-1],this.percents=i}function g(e,i,n,r,o,s){n=J(n);var a,l,u,c,h,p,m=e.ms,g={},b={},v={};if(r)for(S=0,x=oe.length;x>S;S++){var y=oe[S];if(y.el.id==i.id&&y.anim==e){y.percent!=n?(oe.splice(S,1),u=1):l=y,i.attr(y.totalOrigin);break}}else r=+b;for(var S=0,x=e.percents.length;x>S;S++){if(e.percents[S]==n||e.percents[S]>r*e.top){n=e.percents[S],h=e.percents[S-1]||0,m=m/e.top*(n-h),c=e.percents[S+1],a=e.anim[n];break}r&&i.attr(e.anim[e.percents[S]])}if(a){if(l)l.initstatus=r,l.start=new Date-l.ms*r;else{for(var A in a)if(a[_](A)&&(et[_](A)||i.paper.customAttributes[_](A)))switch(g[A]=i.attr(A),null==g[A]&&(g[A]=tt[A]),b[A]=a[A],et[A]){case $:v[A]=(b[A]-g[A])/m;break;case"colour":g[A]=t.getRGB(g[A]);var E=t.getRGB(b[A]);v[A]={r:(E.r-g[A].r)/m,g:(E.g-g[A].g)/m,b:(E.b-g[A].b)/m};break;case"path":
var O=Dt(g[A],b[A]),C=O[1];for(g[A]=O[0],v[A]=[],S=0,x=g[A].length;x>S;S++){v[A][S]=[0];for(var B=1,R=g[A][S].length;R>B;B++)v[A][S][B]=(C[S][B]-g[A][S][B])/m}break;case"transform":var M=i._,D=Vt(M[A],b[A]);if(D)for(g[A]=D.from,b[A]=D.to,v[A]=[],v[A].real=!0,S=0,x=g[A].length;x>S;S++)for(v[A][S]=[g[A][S][0]],B=1,R=g[A][S].length;R>B;B++)v[A][S][B]=(b[A][S][B]-g[A][S][B])/m;else{var k=i.matrix||new d,L={_:{transform:M.transform},getBBox:function(){return i.getBBox(1)}};g[A]=[k.a,k.b,k.c,k.d,k.e,k.f],It(L,b[A]),b[A]=L._.transform,v[A]=[(L.matrix.a-k.a)/m,(L.matrix.b-k.b)/m,(L.matrix.c-k.c)/m,(L.matrix.d-k.d)/m,(L.matrix.e-k.e)/m,(L.matrix.f-k.f)/m]}break;case"csv":var I=P(a[A])[N](w),G=P(g[A])[N](w);if("clip-rect"==A)for(g[A]=G,v[A]=[],S=G.length;S--;)v[A][S]=(I[S]-g[A][S])/m;b[A]=I;break;default:for(I=[][T](a[A]),G=[][T](g[A]),v[A]=[],S=i.paper.customAttributes[A].length;S--;)v[A][S]=((I[S]||0)-(G[S]||0))/m}var V=a.easing,F=t.easing_formulas[V];if(!F)if(F=P(V).match(K),F&&5==F.length){var H=F;F=function(t){return f(t,+H[1],+H[2],+H[3],+H[4],m)}}else F=ht;if(p=a.start||e.start||+new Date,y={anim:e,percent:n,timestamp:p,start:p+(e.del||0),status:0,initstatus:r||0,stop:!1,ms:m,easing:F,from:g,diff:v,to:b,el:i,callback:a.callback,prev:h,next:c,repeat:s||e.times,origin:i.attr(),totalOrigin:o},oe.push(y),r&&!l&&!u&&(y.stop=!0,y.start=new Date-m*r,1==oe.length))return ae();u&&(y.start=new Date-y.ms*r),1==oe.length&&se(ae)}eve("raphael.anim.start."+i.id,i,e)}}function b(t){for(var e=0;e<oe.length;e++)oe[e].el.paper==t&&oe.splice(e--,1)}t.version="2.1.0",t.eve=eve;var v,y,w=/[, ]+/,S={circle:1,rect:1,path:1,ellipse:1,text:1,image:1},x=/\{(\d+)\}/g,_="hasOwnProperty",A={doc:document,win:window},E={was:Object.prototype[_].call(A.win,"Raphael"),is:A.win.Raphael},O=function(){this.ca=this.customAttributes={}},C="apply",T="concat",B="createTouch"in A.doc,R="",M=" ",P=String,N="split",D="click dblclick mousedown mousemove mouseout mouseover mouseup touchstart touchmove touchend touchcancel"[N](M),k={mousedown:"touchstart",mousemove:"touchmove",mouseup:"touchend"},L=P.prototype.toLowerCase,I=Math,G=I.max,V=I.min,F=I.abs,H=I.pow,j=I.PI,$="number",z="string",U="array",W=Object.prototype.toString,Y=(t._ISURL=/^url\(['"]?([^\)]+?)['"]?\)$/i,/^\s*((#[a-f\d]{6})|(#[a-f\d]{3})|rgba?\(\s*([\d\.]+%?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+%?(?:\s*,\s*[\d\.]+%?)?)\s*\)|hsba?\(\s*([\d\.]+(?:deg|\xb0|%)?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+(?:%?\s*,\s*[\d\.]+)?)%?\s*\)|hsla?\(\s*([\d\.]+(?:deg|\xb0|%)?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+(?:%?\s*,\s*[\d\.]+)?)%?\s*\))\s*$/i),q={NaN:1,Infinity:1,"-Infinity":1},K=/^(?:cubic-)?bezier\(([^,]+),([^,]+),([^,]+),([^\)]+)\)/,X=I.round,J=parseFloat,Z=parseInt,Q=P.prototype.toUpperCase,tt=t._availableAttrs={"arrow-end":"none","arrow-start":"none",blur:0,"clip-rect":"0 0 1e9 1e9",cursor:"default",cx:0,cy:0,fill:"#fff","fill-opacity":1,font:'10px "Arial"',"font-family":'"Arial"',"font-size":"10","font-style":"normal","font-weight":400,gradient:0,height:0,href:"http://raphaeljs.com/","letter-spacing":0,opacity:1,path:"M0,0",r:0,rx:0,ry:0,src:"",stroke:"#000","stroke-dasharray":"","stroke-linecap":"butt","stroke-linejoin":"butt","stroke-miterlimit":0,"stroke-opacity":1,"stroke-width":1,target:"_blank","text-anchor":"middle",title:"Raphael",transform:"",width:0,x:0,y:0},et=t._availableAnimAttrs={blur:$,"clip-rect":"csv",cx:$,cy:$,fill:"colour","fill-opacity":$,"font-size":$,height:$,opacity:$,path:"path",r:$,rx:$,ry:$,stroke:"colour","stroke-opacity":$,"stroke-width":$,transform:"transform",width:$,x:$,y:$},it=/[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*/,nt={hs:1,rg:1},rt=/,?([achlmqrstvxz]),?/gi,ot=/([achlmrqstvz])[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*)+)/gi,st=/([rstm])[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*)+)/gi,at=/(-?\d*\.?\d*(?:e[\-+]?\d+)?)[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*/gi,lt=(t._radial_gradient=/^r(?:\(([^,]+?)[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*([^\)]+?)\))?/,{}),ut=function(t,e){return J(t)-J(e)},ct=function(){},ht=function(t){return t},dt=t._rectPath=function(t,e,i,n,r){return r?[["M",t+r,e],["l",i-2*r,0],["a",r,r,0,0,1,r,r],["l",0,n-2*r],["a",r,r,0,0,1,-r,r],["l",2*r-i,0],["a",r,r,0,0,1,-r,-r],["l",0,2*r-n],["a",r,r,0,0,1,r,-r],["z"]]:[["M",t,e],["l",i,0],["l",0,n],["l",-i,0],["z"]]},pt=function(t,e,i,n){return null==n&&(n=i),[["M",t,e],["m",0,-n],["a",i,n,0,1,1,0,2*n],["a",i,n,0,1,1,0,-2*n],["z"]]},ft=t._getPath={path:function(t){return t.attr("path")},circle:function(t){var e=t.attrs;return pt(e.cx,e.cy,e.r)},ellipse:function(t){var e=t.attrs;return pt(e.cx,e.cy,e.rx,e.ry)},rect:function(t){var e=t.attrs;return dt(e.x,e.y,e.width,e.height,e.r)},image:function(t){var e=t.attrs;return dt(e.x,e.y,e.width,e.height)},text:function(t){var e=t._getBBox();return dt(e.x,e.y,e.width,e.height)}},mt=t.mapPath=function(t,e){if(!e)return t;var i,n,r,o,s,a,l;for(t=Dt(t),r=0,s=t.length;s>r;r++)for(l=t[r],o=1,a=l.length;a>o;o+=2)i=e.x(l[o],l[o+1]),n=e.y(l[o],l[o+1]),l[o]=i,l[o+1]=n;return t};if(t._g=A,t.type=A.win.SVGAngle||A.doc.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1")?"SVG":"VML","VML"==t.type){var gt,bt=A.doc.createElement("div");if(bt.innerHTML='<v:shape adj="1"/>',gt=bt.firstChild,gt.style.behavior="url(#default#VML)",!gt||"object"!=typeof gt.adj)return t.type=R;bt=null}t.svg=!(t.vml="VML"==t.type),t._Paper=O,t.fn=y=O.prototype=t.prototype,t._id=0,t._oid=0,t.is=function(t,e){return e=L.call(e),"finite"==e?!q[_](+t):"array"==e?t instanceof Array:"null"==e&&null===t||e==typeof t&&null!==t||"object"==e&&t===Object(t)||"array"==e&&Array.isArray&&Array.isArray(t)||W.call(t).slice(8,-1).toLowerCase()==e},t.angle=function(e,i,n,r,o,s){if(null==o){var a=e-n,l=i-r;return a||l?(180+180*I.atan2(-l,-a)/j+360)%360:0}return t.angle(e,i,o,s)-t.angle(n,r,o,s)},t.rad=function(t){return t%360*j/180},t.deg=function(t){return 180*t/j%360},t.snapTo=function(e,i,n){if(n=t.is(n,"finite")?n:10,t.is(e,U)){for(var r=e.length;r--;)if(F(e[r]-i)<=n)return e[r]}else{e=+e;var o=i%e;if(n>o)return i-o;if(o>e-n)return i-o+e}return i};t.createUUID=function(t,e){return function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(t,e).toUpperCase()}}(/[xy]/g,function(t){var e=16*I.random()|0,i="x"==t?e:3&e|8;return i.toString(16)});t.setWindow=function(e){eve("raphael.setWindow",t,A.win,e),A.win=e,A.doc=A.win.document,t._engine.initWin&&t._engine.initWin(A.win)};var vt=function(e){if(t.vml){var i,r=/^\s+|\s+$/g;try{var o=new ActiveXObject("htmlfile");o.write("<body>"),o.close(),i=o.body}catch(s){i=createPopup().document.body}var a=i.createTextRange();vt=n(function(t){try{i.style.color=P(t).replace(r,R);var e=a.queryCommandValue("ForeColor");return e=(255&e)<<16|65280&e|(16711680&e)>>>16,"#"+("000000"+e.toString(16)).slice(-6)}catch(n){return"none"}})}else{var l=A.doc.createElement("i");l.title="Raphal Colour Picker",l.style.display="none",A.doc.body.appendChild(l),vt=n(function(t){return l.style.color=t,A.doc.defaultView.getComputedStyle(l,R).getPropertyValue("color")})}return vt(e)},yt=function(){return"hsb("+[this.h,this.s,this.b]+")"},wt=function(){return"hsl("+[this.h,this.s,this.l]+")"},St=function(){return this.hex},xt=function(e,i,n){if(null==i&&t.is(e,"object")&&"r"in e&&"g"in e&&"b"in e&&(n=e.b,i=e.g,e=e.r),null==i&&t.is(e,z)){var r=t.getRGB(e);e=r.r,i=r.g,n=r.b}return(e>1||i>1||n>1)&&(e/=255,i/=255,n/=255),[e,i,n]},_t=function(e,i,n,r){e*=255,i*=255,n*=255;var o={r:e,g:i,b:n,hex:t.rgb(e,i,n),toString:St};return t.is(r,"finite")&&(o.opacity=r),o};t.color=function(e){var i;return t.is(e,"object")&&"h"in e&&"s"in e&&"b"in e?(i=t.hsb2rgb(e),e.r=i.r,e.g=i.g,e.b=i.b,e.hex=i.hex):t.is(e,"object")&&"h"in e&&"s"in e&&"l"in e?(i=t.hsl2rgb(e),e.r=i.r,e.g=i.g,e.b=i.b,e.hex=i.hex):(t.is(e,"string")&&(e=t.getRGB(e)),t.is(e,"object")&&"r"in e&&"g"in e&&"b"in e?(i=t.rgb2hsl(e),e.h=i.h,e.s=i.s,e.l=i.l,i=t.rgb2hsb(e),e.v=i.b):(e={hex:"none"},e.r=e.g=e.b=e.h=e.s=e.v=e.l=-1)),e.toString=St,e},t.hsb2rgb=function(t,e,i,n){this.is(t,"object")&&"h"in t&&"s"in t&&"b"in t&&(i=t.b,e=t.s,t=t.h,n=t.o),t*=360;var r,o,s,a,l;return t=t%360/60,l=i*e,a=l*(1-F(t%2-1)),r=o=s=i-l,t=~~t,r+=[l,a,0,0,a,l][t],o+=[a,l,l,a,0,0][t],s+=[0,0,a,l,l,a][t],_t(r,o,s,n)},t.hsl2rgb=function(t,e,i,n){this.is(t,"object")&&"h"in t&&"s"in t&&"l"in t&&(i=t.l,e=t.s,t=t.h),(t>1||e>1||i>1)&&(t/=360,e/=100,i/=100),t*=360;var r,o,s,a,l;return t=t%360/60,l=2*e*(.5>i?i:1-i),a=l*(1-F(t%2-1)),r=o=s=i-l/2,t=~~t,r+=[l,a,0,0,a,l][t],o+=[a,l,l,a,0,0][t],s+=[0,0,a,l,l,a][t],_t(r,o,s,n)},t.rgb2hsb=function(t,e,i){i=xt(t,e,i),t=i[0],e=i[1],i=i[2];var n,r,o,s;return o=G(t,e,i),s=o-V(t,e,i),n=0==s?null:o==t?(e-i)/s:o==e?(i-t)/s+2:(t-e)/s+4,n=(n+360)%6*60/360,r=0==s?0:s/o,{h:n,s:r,b:o,toString:yt}},t.rgb2hsl=function(t,e,i){i=xt(t,e,i),t=i[0],e=i[1],i=i[2];var n,r,o,s,a,l;return s=G(t,e,i),a=V(t,e,i),l=s-a,n=0==l?null:s==t?(e-i)/l:s==e?(i-t)/l+2:(t-e)/l+4,n=(n+360)%6*60/360,o=(s+a)/2,r=0==l?0:.5>o?l/(2*o):l/(2-2*o),{h:n,s:r,l:o,toString:wt}},t._path2string=function(){return this.join(",").replace(rt,"$1")};t._preload=function(t,e){var i=A.doc.createElement("img");i.style.cssText="position:absolute;left:-9999em;top:-9999em",i.onload=function(){e.call(this),this.onload=null,A.doc.body.removeChild(this)},i.onerror=function(){A.doc.body.removeChild(this)},A.doc.body.appendChild(i),i.src=t};t.getRGB=n(function(e){if(!e||(e=P(e)).indexOf("-")+1)return{r:-1,g:-1,b:-1,hex:"none",error:1,toString:r};if("none"==e)return{r:-1,g:-1,b:-1,hex:"none",toString:r};!(nt[_](e.toLowerCase().substring(0,2))||"#"==e.charAt())&&(e=vt(e));var i,n,o,s,a,l,u=e.match(Y);return u?(u[2]&&(o=Z(u[2].substring(5),16),n=Z(u[2].substring(3,5),16),i=Z(u[2].substring(1,3),16)),u[3]&&(o=Z((a=u[3].charAt(3))+a,16),n=Z((a=u[3].charAt(2))+a,16),i=Z((a=u[3].charAt(1))+a,16)),u[4]&&(l=u[4][N](it),i=J(l[0]),"%"==l[0].slice(-1)&&(i*=2.55),n=J(l[1]),"%"==l[1].slice(-1)&&(n*=2.55),o=J(l[2]),"%"==l[2].slice(-1)&&(o*=2.55),"rgba"==u[1].toLowerCase().slice(0,4)&&(s=J(l[3])),l[3]&&"%"==l[3].slice(-1)&&(s/=100)),u[5]?(l=u[5][N](it),i=J(l[0]),"%"==l[0].slice(-1)&&(i*=2.55),n=J(l[1]),"%"==l[1].slice(-1)&&(n*=2.55),o=J(l[2]),"%"==l[2].slice(-1)&&(o*=2.55),("deg"==l[0].slice(-3)||""==l[0].slice(-1))&&(i/=360),"hsba"==u[1].toLowerCase().slice(0,4)&&(s=J(l[3])),l[3]&&"%"==l[3].slice(-1)&&(s/=100),t.hsb2rgb(i,n,o,s)):u[6]?(l=u[6][N](it),i=J(l[0]),"%"==l[0].slice(-1)&&(i*=2.55),n=J(l[1]),"%"==l[1].slice(-1)&&(n*=2.55),o=J(l[2]),"%"==l[2].slice(-1)&&(o*=2.55),("deg"==l[0].slice(-3)||""==l[0].slice(-1))&&(i/=360),"hsla"==u[1].toLowerCase().slice(0,4)&&(s=J(l[3])),l[3]&&"%"==l[3].slice(-1)&&(s/=100),t.hsl2rgb(i,n,o,s)):(u={r:i,g:n,b:o,toString:r},u.hex="#"+(16777216|o|n<<8|i<<16).toString(16).slice(1),t.is(s,"finite")&&(u.opacity=s),u)):{r:-1,g:-1,b:-1,hex:"none",error:1,toString:r}},t),t.hsb=n(function(e,i,n){return t.hsb2rgb(e,i,n).hex}),t.hsl=n(function(e,i,n){return t.hsl2rgb(e,i,n).hex}),t.rgb=n(function(t,e,i){return"#"+(16777216|i|e<<8|t<<16).toString(16).slice(1)}),t.getColor=function(t){var e=this.getColor.start=this.getColor.start||{h:0,s:1,b:t||.75},i=this.hsb2rgb(e.h,e.s,e.b);return e.h+=.075,e.h>1&&(e.h=0,e.s-=.2,e.s<=0&&(this.getColor.start={h:0,s:1,b:e.b})),i.hex},t.getColor.reset=function(){delete this.start},t.parsePathString=function(e){if(!e)return null;var i=At(e);if(i.arr)return Ot(i.arr);var n={a:7,c:6,h:1,l:2,m:2,r:4,q:4,s:4,t:2,v:1,z:0},r=[];return t.is(e,U)&&t.is(e[0],U)&&(r=Ot(e)),r.length||P(e).replace(ot,function(t,e,i){var o=[],s=e.toLowerCase();if(i.replace(at,function(t,e){e&&o.push(+e)}),"m"==s&&o.length>2&&(r.push([e][T](o.splice(0,2))),s="l",e="m"==e?"l":"L"),"r"==s)r.push([e][T](o));else for(;o.length>=n[s]&&(r.push([e][T](o.splice(0,n[s]))),n[s]););}),r.toString=t._path2string,i.arr=Ot(r),r},t.parseTransformString=n(function(e){if(!e)return null;var i=[];return t.is(e,U)&&t.is(e[0],U)&&(i=Ot(e)),i.length||P(e).replace(st,function(t,e,n){var r=[];L.call(e);n.replace(at,function(t,e){e&&r.push(+e)}),i.push([e][T](r))}),i.toString=t._path2string,i});var At=function(t){var e=At.ps=At.ps||{};return e[t]?e[t].sleep=100:e[t]={sleep:100},setTimeout(function(){for(var i in e)e[_](i)&&i!=t&&(e[i].sleep--,!e[i].sleep&&delete e[i])}),e[t]};t.findDotsAtSegment=function(t,e,i,n,r,o,s,a,l){var u=1-l,c=H(u,3),h=H(u,2),d=l*l,p=d*l,f=c*t+3*h*l*i+3*u*l*l*r+p*s,m=c*e+3*h*l*n+3*u*l*l*o+p*a,g=t+2*l*(i-t)+d*(r-2*i+t),b=e+2*l*(n-e)+d*(o-2*n+e),v=i+2*l*(r-i)+d*(s-2*r+i),y=n+2*l*(o-n)+d*(a-2*o+n),w=u*t+l*i,S=u*e+l*n,x=u*r+l*s,_=u*o+l*a,A=90-180*I.atan2(g-v,b-y)/j;return(g>v||y>b)&&(A+=180),{x:f,y:m,m:{x:g,y:b},n:{x:v,y:y},start:{x:w,y:S},end:{x:x,y:_},alpha:A}},t.bezierBBox=function(e,i,n,r,o,s,a,l){t.is(e,"array")||(e=[e,i,n,r,o,s,a,l]);var u=Nt.apply(null,e);return{x:u.min.x,y:u.min.y,x2:u.max.x,y2:u.max.y,width:u.max.x-u.min.x,height:u.max.y-u.min.y}},t.isPointInsideBBox=function(t,e,i){return e>=t.x&&e<=t.x2&&i>=t.y&&i<=t.y2},t.isBBoxIntersect=function(e,i){var n=t.isPointInsideBBox;return n(i,e.x,e.y)||n(i,e.x2,e.y)||n(i,e.x,e.y2)||n(i,e.x2,e.y2)||n(e,i.x,i.y)||n(e,i.x2,i.y)||n(e,i.x,i.y2)||n(e,i.x2,i.y2)||(e.x<i.x2&&e.x>i.x||i.x<e.x2&&i.x>e.x)&&(e.y<i.y2&&e.y>i.y||i.y<e.y2&&i.y>e.y)},t.pathIntersection=function(t,e){return h(t,e)},t.pathIntersectionNumber=function(t,e){return h(t,e,1)},t.isPointInsidePath=function(e,i,n){var r=t.pathBBox(e);return t.isPointInsideBBox(r,i,n)&&h(e,[["M",i,n],["H",r.x2+10]],1)%2==1},t._removedFactory=function(t){return function(){eve("raphael.log",null,"Raphal: you are calling to method "+t+" of removed object",t)}};var Et=t.pathBBox=function(t){var i=At(t);if(!t)return{x:0,y:0,width:0,height:0,x2:0,y2:0};t=Dt(t);for(var n,r=0,o=0,s=[],a=[],l=0,u=t.length;u>l;l++)if(n=t[l],"M"==n[0])r=n[1],o=n[2],s.push(r),a.push(o);else{var c=Nt(r,o,n[1],n[2],n[3],n[4],n[5],n[6]);s=s[T](c.min.x,c.max.x),a=a[T](c.min.y,c.max.y),r=n[5],o=n[6]}var h=V[C](0,s),d=V[C](0,a),p=G[C](0,s),f=G[C](0,a),m={x:h,y:d,x2:p,y2:f,width:p-h,height:f-d};return i.bbox=e(m),m},Ot=function(i){var n=e(i);return n.toString=t._path2string,n},Ct=t._pathToRelative=function(e){var i=At(e);if(i.rel)return Ot(i.rel);t.is(e,U)&&t.is(e&&e[0],U)||(e=t.parsePathString(e));var n=[],r=0,o=0,s=0,a=0,l=0;"M"==e[0][0]&&(r=e[0][1],o=e[0][2],s=r,a=o,l++,n.push(["M",r,o]));for(var u=l,c=e.length;c>u;u++){var h=n[u]=[],d=e[u];if(d[0]!=L.call(d[0]))switch(h[0]=L.call(d[0]),h[0]){case"a":h[1]=d[1],h[2]=d[2],h[3]=d[3],h[4]=d[4],h[5]=d[5],h[6]=+(d[6]-r).toFixed(3),h[7]=+(d[7]-o).toFixed(3);break;case"v":h[1]=+(d[1]-o).toFixed(3);break;case"m":s=d[1],a=d[2];default:for(var p=1,f=d.length;f>p;p++)h[p]=+(d[p]-(p%2?r:o)).toFixed(3)}else{h=n[u]=[],"m"==d[0]&&(s=d[1]+r,a=d[2]+o);for(var m=0,g=d.length;g>m;m++)n[u][m]=d[m]}var b=n[u].length;switch(n[u][0]){case"z":r=s,o=a;break;case"h":r+=+n[u][b-1];break;case"v":o+=+n[u][b-1];break;default:r+=+n[u][b-2],o+=+n[u][b-1]}}return n.toString=t._path2string,i.rel=Ot(n),n},Tt=t._pathToAbsolute=function(e){var i=At(e);if(i.abs)return Ot(i.abs);if(t.is(e,U)&&t.is(e&&e[0],U)||(e=t.parsePathString(e)),!e||!e.length)return[["M",0,0]];var n=[],r=0,s=0,a=0,l=0,u=0;"M"==e[0][0]&&(r=+e[0][1],s=+e[0][2],a=r,l=s,u++,n[0]=["M",r,s]);for(var c,h,d=3==e.length&&"M"==e[0][0]&&"R"==e[1][0].toUpperCase()&&"Z"==e[2][0].toUpperCase(),p=u,f=e.length;f>p;p++){if(n.push(c=[]),h=e[p],h[0]!=Q.call(h[0]))switch(c[0]=Q.call(h[0]),c[0]){case"A":c[1]=h[1],c[2]=h[2],c[3]=h[3],c[4]=h[4],c[5]=h[5],c[6]=+(h[6]+r),c[7]=+(h[7]+s);break;case"V":c[1]=+h[1]+s;break;case"H":c[1]=+h[1]+r;break;case"R":for(var m=[r,s][T](h.slice(1)),g=2,b=m.length;b>g;g++)m[g]=+m[g]+r,m[++g]=+m[g]+s;n.pop(),n=n[T](o(m,d));break;case"M":a=+h[1]+r,l=+h[2]+s;default:for(g=1,b=h.length;b>g;g++)c[g]=+h[g]+(g%2?r:s)}else if("R"==h[0])m=[r,s][T](h.slice(1)),n.pop(),n=n[T](o(m,d)),c=["R"][T](h.slice(-2));else for(var v=0,y=h.length;y>v;v++)c[v]=h[v];switch(c[0]){case"Z":r=a,s=l;break;case"H":r=c[1];break;case"V":s=c[1];break;case"M":a=c[c.length-2],l=c[c.length-1];default:r=c[c.length-2],s=c[c.length-1]}}return n.toString=t._path2string,i.abs=Ot(n),n},Bt=function(t,e,i,n){return[t,e,i,n,i,n]},Rt=function(t,e,i,n,r,o){var s=1/3,a=2/3;return[s*t+a*i,s*e+a*n,s*r+a*i,s*o+a*n,r,o]},Mt=function(t,e,i,r,o,s,a,l,u,c){var h,d=120*j/180,p=j/180*(+o||0),f=[],m=n(function(t,e,i){var n=t*I.cos(i)-e*I.sin(i),r=t*I.sin(i)+e*I.cos(i);return{x:n,y:r}});if(c)A=c[0],E=c[1],x=c[2],_=c[3];else{h=m(t,e,-p),t=h.x,e=h.y,h=m(l,u,-p),l=h.x,u=h.y;var g=(I.cos(j/180*o),I.sin(j/180*o),(t-l)/2),b=(e-u)/2,v=g*g/(i*i)+b*b/(r*r);v>1&&(v=I.sqrt(v),i=v*i,r=v*r);var y=i*i,w=r*r,S=(s==a?-1:1)*I.sqrt(F((y*w-y*b*b-w*g*g)/(y*b*b+w*g*g))),x=S*i*b/r+(t+l)/2,_=S*-r*g/i+(e+u)/2,A=I.asin(((e-_)/r).toFixed(9)),E=I.asin(((u-_)/r).toFixed(9));A=x>t?j-A:A,E=x>l?j-E:E,0>A&&(A=2*j+A),0>E&&(E=2*j+E),a&&A>E&&(A-=2*j),!a&&E>A&&(E-=2*j)}var O=E-A;if(F(O)>d){var C=E,B=l,R=u;E=A+d*(a&&E>A?1:-1),l=x+i*I.cos(E),u=_+r*I.sin(E),f=Mt(l,u,i,r,o,0,a,B,R,[E,C,x,_])}O=E-A;var M=I.cos(A),P=I.sin(A),D=I.cos(E),k=I.sin(E),L=I.tan(O/4),G=4/3*i*L,V=4/3*r*L,H=[t,e],$=[t+G*P,e-V*M],z=[l+G*k,u-V*D],U=[l,u];if($[0]=2*H[0]-$[0],$[1]=2*H[1]-$[1],c)return[$,z,U][T](f);f=[$,z,U][T](f).join()[N](",");for(var W=[],Y=0,q=f.length;q>Y;Y++)W[Y]=Y%2?m(f[Y-1],f[Y],p).y:m(f[Y],f[Y+1],p).x;return W},Pt=function(t,e,i,n,r,o,s,a,l){var u=1-l;return{x:H(u,3)*t+3*H(u,2)*l*i+3*u*l*l*r+H(l,3)*s,y:H(u,3)*e+3*H(u,2)*l*n+3*u*l*l*o+H(l,3)*a}},Nt=n(function(t,e,i,n,r,o,s,a){var l,u=r-2*i+t-(s-2*r+i),c=2*(i-t)-2*(r-i),h=t-i,d=(-c+I.sqrt(c*c-4*u*h))/2/u,p=(-c-I.sqrt(c*c-4*u*h))/2/u,f=[e,a],m=[t,s];return F(d)>"1e12"&&(d=.5),F(p)>"1e12"&&(p=.5),d>0&&1>d&&(l=Pt(t,e,i,n,r,o,s,a,d),m.push(l.x),f.push(l.y)),p>0&&1>p&&(l=Pt(t,e,i,n,r,o,s,a,p),m.push(l.x),f.push(l.y)),u=o-2*n+e-(a-2*o+n),c=2*(n-e)-2*(o-n),h=e-n,d=(-c+I.sqrt(c*c-4*u*h))/2/u,p=(-c-I.sqrt(c*c-4*u*h))/2/u,F(d)>"1e12"&&(d=.5),F(p)>"1e12"&&(p=.5),d>0&&1>d&&(l=Pt(t,e,i,n,r,o,s,a,d),m.push(l.x),f.push(l.y)),p>0&&1>p&&(l=Pt(t,e,i,n,r,o,s,a,p),m.push(l.x),f.push(l.y)),{min:{x:V[C](0,m),y:V[C](0,f)},max:{x:G[C](0,m),y:G[C](0,f)}}}),Dt=t._path2curve=n(function(t,e){var i=!e&&At(t);if(!e&&i.curve)return Ot(i.curve);for(var n=Tt(t),r=e&&Tt(e),o={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},s={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},a=(function(t,e){var i,n;if(!t)return["C",e.x,e.y,e.x,e.y,e.x,e.y];switch(!(t[0]in{T:1,Q:1})&&(e.qx=e.qy=null),t[0]){case"M":e.X=t[1],e.Y=t[2];break;case"A":t=["C"][T](Mt[C](0,[e.x,e.y][T](t.slice(1))));break;case"S":i=e.x+(e.x-(e.bx||e.x)),n=e.y+(e.y-(e.by||e.y)),t=["C",i,n][T](t.slice(1));break;case"T":e.qx=e.x+(e.x-(e.qx||e.x)),e.qy=e.y+(e.y-(e.qy||e.y)),t=["C"][T](Rt(e.x,e.y,e.qx,e.qy,t[1],t[2]));break;case"Q":e.qx=t[1],e.qy=t[2],t=["C"][T](Rt(e.x,e.y,t[1],t[2],t[3],t[4]));break;case"L":t=["C"][T](Bt(e.x,e.y,t[1],t[2]));break;case"H":t=["C"][T](Bt(e.x,e.y,t[1],e.y));break;case"V":t=["C"][T](Bt(e.x,e.y,e.x,t[1]));break;case"Z":t=["C"][T](Bt(e.x,e.y,e.X,e.Y))}return t}),l=function(t,e){if(t[e].length>7){t[e].shift();for(var i=t[e];i.length;)t.splice(e++,0,["C"][T](i.splice(0,6)));t.splice(e,1),h=G(n.length,r&&r.length||0)}},u=function(t,e,i,o,s){t&&e&&"M"==t[s][0]&&"M"!=e[s][0]&&(e.splice(s,0,["M",o.x,o.y]),i.bx=0,i.by=0,i.x=t[s][1],i.y=t[s][2],h=G(n.length,r&&r.length||0))},c=0,h=G(n.length,r&&r.length||0);h>c;c++){n[c]=a(n[c],o),l(n,c),r&&(r[c]=a(r[c],s)),r&&l(r,c),u(n,r,o,s,c),u(r,n,s,o,c);var d=n[c],p=r&&r[c],f=d.length,m=r&&p.length;o.x=d[f-2],o.y=d[f-1],o.bx=J(d[f-4])||o.x,o.by=J(d[f-3])||o.y,s.bx=r&&(J(p[m-4])||s.x),s.by=r&&(J(p[m-3])||s.y),s.x=r&&p[m-2],s.y=r&&p[m-1]}return r||(i.curve=Ot(n)),r?[n,r]:n},null,Ot),kt=(t._parseDots=n(function(e){for(var i=[],n=0,r=e.length;r>n;n++){var o={},s=e[n].match(/^([^:]*):?([\d\.]*)/);if(o.color=t.getRGB(s[1]),o.color.error)return null;o.color=o.color.hex,s[2]&&(o.offset=s[2]+"%"),i.push(o)}for(n=1,r=i.length-1;r>n;n++)if(!i[n].offset){for(var a=J(i[n-1].offset||0),l=0,u=n+1;r>u;u++)if(i[u].offset){l=i[u].offset;break}l||(l=100,u=r),l=J(l);for(var c=(l-a)/(u-n+1);u>n;n++)a+=c,i[n].offset=a+"%"}return i}),t._tear=function(t,e){t==e.top&&(e.top=t.prev),t==e.bottom&&(e.bottom=t.next),t.next&&(t.next.prev=t.prev),t.prev&&(t.prev.next=t.next)}),Lt=(t._tofront=function(t,e){e.top!==t&&(kt(t,e),t.next=null,t.prev=e.top,e.top.next=t,e.top=t)},t._toback=function(t,e){e.bottom!==t&&(kt(t,e),t.next=e.bottom,t.prev=null,e.bottom.prev=t,e.bottom=t)},t._insertafter=function(t,e,i){kt(t,i),e==i.top&&(i.top=t),e.next&&(e.next.prev=t),t.next=e.next,t.prev=e,e.next=t},t._insertbefore=function(t,e,i){kt(t,i),e==i.bottom&&(i.bottom=t),e.prev&&(e.prev.next=t),t.prev=e.prev,e.prev=t,t.next=e},t.toMatrix=function(t,e){var i=Et(t),n={_:{transform:R},getBBox:function(){return i}};return It(n,e),n.matrix}),It=(t.transformPath=function(t,e){return mt(t,Lt(t,e))},t._extractTransform=function(e,i){if(null==i)return e._.transform;i=P(i).replace(/\.{3}|\u2026/g,e._.transform||R);var n=t.parseTransformString(i),r=0,o=0,s=0,a=1,l=1,u=e._,c=new d;if(u.transform=n||[],n)for(var h=0,p=n.length;p>h;h++){var f,m,g,b,v,y=n[h],w=y.length,S=P(y[0]).toLowerCase(),x=y[0]!=S,_=x?c.invert():0;"t"==S&&3==w?x?(f=_.x(0,0),m=_.y(0,0),g=_.x(y[1],y[2]),b=_.y(y[1],y[2]),c.translate(g-f,b-m)):c.translate(y[1],y[2]):"r"==S?2==w?(v=v||e.getBBox(1),c.rotate(y[1],v.x+v.width/2,v.y+v.height/2),r+=y[1]):4==w&&(x?(g=_.x(y[2],y[3]),b=_.y(y[2],y[3]),c.rotate(y[1],g,b)):c.rotate(y[1],y[2],y[3]),r+=y[1]):"s"==S?2==w||3==w?(v=v||e.getBBox(1),c.scale(y[1],y[w-1],v.x+v.width/2,v.y+v.height/2),a*=y[1],l*=y[w-1]):5==w&&(x?(g=_.x(y[3],y[4]),b=_.y(y[3],y[4]),c.scale(y[1],y[2],g,b)):c.scale(y[1],y[2],y[3],y[4]),a*=y[1],l*=y[2]):"m"==S&&7==w&&c.add(y[1],y[2],y[3],y[4],y[5],y[6]),u.dirtyT=1,e.matrix=c}e.matrix=c,u.sx=a,u.sy=l,u.deg=r,u.dx=o=c.e,u.dy=s=c.f,1==a&&1==l&&!r&&u.bbox?(u.bbox.x+=+o,u.bbox.y+=+s):u.dirtyT=1}),Gt=function(t){var e=t[0];switch(e.toLowerCase()){case"t":return[e,0,0];case"m":return[e,1,0,0,1,0,0];case"r":return 4==t.length?[e,0,t[2],t[3]]:[e,0];case"s":return 5==t.length?[e,1,1,t[3],t[4]]:3==t.length?[e,1,1]:[e,1]}},Vt=t._equaliseTransform=function(e,i){i=P(i).replace(/\.{3}|\u2026/g,e),e=t.parseTransformString(e)||[],i=t.parseTransformString(i)||[];for(var n,r,o,s,a=G(e.length,i.length),l=[],u=[],c=0;a>c;c++){if(o=e[c]||Gt(i[c]),s=i[c]||Gt(o),o[0]!=s[0]||"r"==o[0].toLowerCase()&&(o[2]!=s[2]||o[3]!=s[3])||"s"==o[0].toLowerCase()&&(o[3]!=s[3]||o[4]!=s[4]))return;for(l[c]=[],u[c]=[],n=0,r=G(o.length,s.length);r>n;n++)n in o&&(l[c][n]=o[n]),n in s&&(u[c][n]=s[n])}return{from:l,to:u}};t._getContainer=function(e,i,n,r){var o;return o=null!=r||t.is(e,"object")?e:A.doc.getElementById(e),null!=o?o.tagName?null==i?{container:o,width:o.style.pixelWidth||o.offsetWidth,height:o.style.pixelHeight||o.offsetHeight}:{container:o,width:i,height:n}:{container:1,x:e,y:i,width:n,height:r}:void 0},t.pathToRelative=Ct,t._engine={},t.path2curve=Dt,t.matrix=function(t,e,i,n,r,o){return new d(t,e,i,n,r,o)},function(e){function i(t){return t[0]*t[0]+t[1]*t[1]}function n(t){var e=I.sqrt(i(t));t[0]&&(t[0]/=e),t[1]&&(t[1]/=e)}e.add=function(t,e,i,n,r,o){var s,a,l,u,c=[[],[],[]],h=[[this.a,this.c,this.e],[this.b,this.d,this.f],[0,0,1]],p=[[t,i,r],[e,n,o],[0,0,1]];for(t&&t instanceof d&&(p=[[t.a,t.c,t.e],[t.b,t.d,t.f],[0,0,1]]),s=0;3>s;s++)for(a=0;3>a;a++){for(u=0,l=0;3>l;l++)u+=h[s][l]*p[l][a];c[s][a]=u}this.a=c[0][0],this.b=c[1][0],this.c=c[0][1],this.d=c[1][1],this.e=c[0][2],this.f=c[1][2]},e.invert=function(){var t=this,e=t.a*t.d-t.b*t.c;return new d(t.d/e,-t.b/e,-t.c/e,t.a/e,(t.c*t.f-t.d*t.e)/e,(t.b*t.e-t.a*t.f)/e)},e.clone=function(){return new d(this.a,this.b,this.c,this.d,this.e,this.f)},e.translate=function(t,e){this.add(1,0,0,1,t,e)},e.scale=function(t,e,i,n){null==e&&(e=t),(i||n)&&this.add(1,0,0,1,i,n),this.add(t,0,0,e,0,0),(i||n)&&this.add(1,0,0,1,-i,-n)},e.rotate=function(e,i,n){e=t.rad(e),i=i||0,n=n||0;var r=+I.cos(e).toFixed(9),o=+I.sin(e).toFixed(9);this.add(r,o,-o,r,i,n),this.add(1,0,0,1,-i,-n)},e.x=function(t,e){return t*this.a+e*this.c+this.e},e.y=function(t,e){return t*this.b+e*this.d+this.f},e.get=function(t){return+this[P.fromCharCode(97+t)].toFixed(4)},e.toString=function(){return t.svg?"matrix("+[this.get(0),this.get(1),this.get(2),this.get(3),this.get(4),this.get(5)].join()+")":[this.get(0),this.get(2),this.get(1),this.get(3),0,0].join()},e.toFilter=function(){return"progid:DXImageTransform.Microsoft.Matrix(M11="+this.get(0)+", M12="+this.get(2)+", M21="+this.get(1)+", M22="+this.get(3)+", Dx="+this.get(4)+", Dy="+this.get(5)+", sizingmethod='auto expand')"},e.offset=function(){return[this.e.toFixed(4),this.f.toFixed(4)]},e.split=function(){var e={};e.dx=this.e,e.dy=this.f;var r=[[this.a,this.c],[this.b,this.d]];e.scalex=I.sqrt(i(r[0])),n(r[0]),e.shear=r[0][0]*r[1][0]+r[0][1]*r[1][1],r[1]=[r[1][0]-r[0][0]*e.shear,r[1][1]-r[0][1]*e.shear],e.scaley=I.sqrt(i(r[1])),n(r[1]),e.shear/=e.scaley;var o=-r[0][1],s=r[1][1];return 0>s?(e.rotate=t.deg(I.acos(s)),0>o&&(e.rotate=360-e.rotate)):e.rotate=t.deg(I.asin(o)),e.isSimple=!(+e.shear.toFixed(9)||e.scalex.toFixed(9)!=e.scaley.toFixed(9)&&e.rotate),e.isSuperSimple=!+e.shear.toFixed(9)&&e.scalex.toFixed(9)==e.scaley.toFixed(9)&&!e.rotate,e.noRotation=!+e.shear.toFixed(9)&&!e.rotate,e},e.toTransformString=function(t){var e=t||this[N]();return e.isSimple?(e.scalex=+e.scalex.toFixed(4),e.scaley=+e.scaley.toFixed(4),e.rotate=+e.rotate.toFixed(4),(e.dx||e.dy?"t"+[e.dx,e.dy]:R)+(1!=e.scalex||1!=e.scaley?"s"+[e.scalex,e.scaley,0,0]:R)+(e.rotate?"r"+[e.rotate,0,0]:R)):"m"+[this.get(0),this.get(1),this.get(2),this.get(3),this.get(4),this.get(5)]}}(d.prototype);var Ft=navigator.userAgent.match(/Version\/(.*?)\s/)||navigator.userAgent.match(/Chrome\/(\d+)/);"Apple Computer, Inc."==navigator.vendor&&(Ft&&Ft[1]<4||"iP"==navigator.platform.slice(0,2))||"Google Inc."==navigator.vendor&&Ft&&Ft[1]<8?y.safari=function(){var t=this.rect(-99,-99,this.width+99,this.height+99).attr({stroke:"none"});setTimeout(function(){t.remove()})}:y.safari=ct;for(var Ht=function(){this.returnValue=!1},jt=function(){return this.originalEvent.preventDefault()},$t=function(){this.cancelBubble=!0},zt=function(){return this.originalEvent.stopPropagation()},Ut=function(){return A.doc.addEventListener?function(t,e,i,n){var r=B&&k[e]?k[e]:e,o=function(r){var o=A.doc.documentElement.scrollTop||A.doc.body.scrollTop,s=A.doc.documentElement.scrollLeft||A.doc.body.scrollLeft,a=r.clientX+s,l=r.clientY+o;if(B&&k[_](e))for(var u=0,c=r.targetTouches&&r.targetTouches.length;c>u;u++)if(r.targetTouches[u].target==t){var h=r;r=r.targetTouches[u],r.originalEvent=h,r.preventDefault=jt,r.stopPropagation=zt;break}return i.call(n,r,a,l)};return t.addEventListener(r,o,!1),function(){return t.removeEventListener(r,o,!1),!0}}:A.doc.attachEvent?function(t,e,i,n){var r=function(t){t=t||A.win.event;var e=A.doc.documentElement.scrollTop||A.doc.body.scrollTop,r=A.doc.documentElement.scrollLeft||A.doc.body.scrollLeft,o=t.clientX+r,s=t.clientY+e;return t.preventDefault=t.preventDefault||Ht,t.stopPropagation=t.stopPropagation||$t,i.call(n,t,o,s)};t.attachEvent("on"+e,r);var o=function(){return t.detachEvent("on"+e,r),!0};return o}:void 0}(),Wt=[],Yt=function(t){for(var e,i=t.clientX,n=t.clientY,r=A.doc.documentElement.scrollTop||A.doc.body.scrollTop,o=A.doc.documentElement.scrollLeft||A.doc.body.scrollLeft,s=Wt.length;s--;){if(e=Wt[s],B){for(var a,l=t.touches.length;l--;)if(a=t.touches[l],a.identifier==e.el._drag.id){i=a.clientX,n=a.clientY,(t.originalEvent?t.originalEvent:t).preventDefault();break}}else t.preventDefault();var u,c=e.el.node,h=c.nextSibling,d=c.parentNode,p=c.style.display;A.win.opera&&d.removeChild(c),c.style.display="none",u=e.el.paper.getElementByPoint(i,n),c.style.display=p,A.win.opera&&(h?d.insertBefore(c,h):d.appendChild(c)),u&&eve("raphael.drag.over."+e.el.id,e.el,u),i+=o,n+=r,eve("raphael.drag.move."+e.el.id,e.move_scope||e.el,i-e.el._drag.x,n-e.el._drag.y,i,n,t)}},qt=function(e){t.unmousemove(Yt).unmouseup(qt);for(var i,n=Wt.length;n--;)i=Wt[n],i.el._drag={},eve("raphael.drag.end."+i.el.id,i.end_scope||i.start_scope||i.move_scope||i.el,e);Wt=[]},Kt=t.el={},Xt=D.length;Xt--;)!function(e){t[e]=Kt[e]=function(i,n){return t.is(i,"function")&&(this.events=this.events||[],this.events.push({name:e,f:i,unbind:Ut(this.shape||this.node||A.doc,e,i,n||this)})),this},t["un"+e]=Kt["un"+e]=function(t){for(var i=this.events||[],n=i.length;n--;)if(i[n].name==e&&i[n].f==t)return i[n].unbind(),i.splice(n,1),!i.length&&delete this.events,this;return this}}(D[Xt]);Kt.data=function(e,i){var n=lt[this.id]=lt[this.id]||{};if(1==arguments.length){if(t.is(e,"object")){for(var r in e)e[_](r)&&this.data(r,e[r]);return this}return eve("raphael.data.get."+this.id,this,n[e],e),n[e]}return n[e]=i,eve("raphael.data.set."+this.id,this,i,e),this},Kt.removeData=function(t){return null==t?lt[this.id]={}:lt[this.id]&&delete lt[this.id][t],this},Kt.hover=function(t,e,i,n){return this.mouseover(t,i).mouseout(e,n||i)},Kt.unhover=function(t,e){return this.unmouseover(t).unmouseout(e)};var Jt=[];Kt.drag=function(e,i,n,r,o,s){function a(a){(a.originalEvent||a).preventDefault();var l=A.doc.documentElement.scrollTop||A.doc.body.scrollTop,u=A.doc.documentElement.scrollLeft||A.doc.body.scrollLeft;this._drag.x=a.clientX+u,this._drag.y=a.clientY+l,this._drag.id=a.identifier,!Wt.length&&t.mousemove(Yt).mouseup(qt),Wt.push({el:this,move_scope:r,start_scope:o,end_scope:s}),i&&eve.on("raphael.drag.start."+this.id,i),e&&eve.on("raphael.drag.move."+this.id,e),n&&eve.on("raphael.drag.end."+this.id,n),eve("raphael.drag.start."+this.id,o||r||this,a.clientX+u,a.clientY+l,a)}return this._drag={},Jt.push({el:this,start:a}),this.mousedown(a),this},Kt.onDragOver=function(t){t?eve.on("raphael.drag.over."+this.id,t):eve.unbind("raphael.drag.over."+this.id)},Kt.undrag=function(){for(var e=Jt.length;e--;)Jt[e].el==this&&(this.unmousedown(Jt[e].start),Jt.splice(e,1),eve.unbind("raphael.drag.*."+this.id));!Jt.length&&t.unmousemove(Yt).unmouseup(qt)},y.circle=function(e,i,n){var r=t._engine.circle(this,e||0,i||0,n||0);return this.__set__&&this.__set__.push(r),r},y.rect=function(e,i,n,r,o){var s=t._engine.rect(this,e||0,i||0,n||0,r||0,o||0);return this.__set__&&this.__set__.push(s),s},y.ellipse=function(e,i,n,r){var o=t._engine.ellipse(this,e||0,i||0,n||0,r||0);return this.__set__&&this.__set__.push(o),o},y.path=function(e){e&&!t.is(e,z)&&!t.is(e[0],U)&&(e+=R);var i=t._engine.path(t.format[C](t,arguments),this);return this.__set__&&this.__set__.push(i),i},y.image=function(e,i,n,r,o){var s=t._engine.image(this,e||"about:blank",i||0,n||0,r||0,o||0);
return this.__set__&&this.__set__.push(s),s},y.text=function(e,i,n){var r=t._engine.text(this,e||0,i||0,P(n));return this.__set__&&this.__set__.push(r),r},y.set=function(e){!t.is(e,"array")&&(e=Array.prototype.splice.call(arguments,0,arguments.length));var i=new ue(e);return this.__set__&&this.__set__.push(i),i},y.setStart=function(t){this.__set__=t||this.set()},y.setFinish=function(t){var e=this.__set__;return delete this.__set__,e},y.setSize=function(e,i){return t._engine.setSize.call(this,e,i)},y.setViewBox=function(e,i,n,r,o){return t._engine.setViewBox.call(this,e,i,n,r,o)},y.top=y.bottom=null,y.raphael=t;var Zt=function(t){var e=t.getBoundingClientRect(),i=t.ownerDocument,n=i.body,r=i.documentElement,o=r.clientTop||n.clientTop||0,s=r.clientLeft||n.clientLeft||0,a=e.top+(A.win.pageYOffset||r.scrollTop||n.scrollTop)-o,l=e.left+(A.win.pageXOffset||r.scrollLeft||n.scrollLeft)-s;return{y:a,x:l}};y.getElementByPoint=function(t,e){var i=this,n=i.canvas,r=A.doc.elementFromPoint(t,e);if(A.win.opera&&"svg"==r.tagName){var o=Zt(n),s=n.createSVGRect();s.x=t-o.x,s.y=e-o.y,s.width=s.height=1;var a=n.getIntersectionList(s,null);a.length&&(r=a[a.length-1])}if(!r)return null;for(;r.parentNode&&r!=n.parentNode&&!r.raphael;)r=r.parentNode;return r==i.canvas.parentNode&&(r=n),r=r&&r.raphael?i.getById(r.raphaelid):null},y.getById=function(t){for(var e=this.bottom;e;){if(e.id==t)return e;e=e.next}return null},y.forEach=function(t,e){for(var i=this.bottom;i;){if(t.call(e,i)===!1)return this;i=i.next}return this},y.getElementsByPoint=function(t,e){var i=this.set();return this.forEach(function(n){n.isPointInside(t,e)&&i.push(n)}),i},Kt.isPointInside=function(e,i){var n=this.realPath=this.realPath||ft[this.type](this);return t.isPointInsidePath(n,e,i)},Kt.getBBox=function(t){if(this.removed)return{};var e=this._;return t?((e.dirty||!e.bboxwt)&&(this.realPath=ft[this.type](this),e.bboxwt=Et(this.realPath),e.bboxwt.toString=p,e.dirty=0),e.bboxwt):((e.dirty||e.dirtyT||!e.bbox)&&((e.dirty||!this.realPath)&&(e.bboxwt=0,this.realPath=ft[this.type](this)),e.bbox=Et(mt(this.realPath,this.matrix)),e.bbox.toString=p,e.dirty=e.dirtyT=0),e.bbox)},Kt.clone=function(){if(this.removed)return null;var t=this.paper[this.type]().attr(this.attr());return this.__set__&&this.__set__.push(t),t},Kt.glow=function(t){if("text"==this.type)return null;t=t||{};var e={width:(t.width||10)+(+this.attr("stroke-width")||1),fill:t.fill||!1,opacity:t.opacity||.5,offsetx:t.offsetx||0,offsety:t.offsety||0,color:t.color||"#000"},i=e.width/2,n=this.paper,r=n.set(),o=this.realPath||ft[this.type](this);o=this.matrix?mt(o,this.matrix):o;for(var s=1;i+1>s;s++)r.push(n.path(o).attr({stroke:e.color,fill:e.fill?e.color:"none","stroke-linejoin":"round","stroke-linecap":"round","stroke-width":+(e.width/i*s).toFixed(3),opacity:+(e.opacity/i).toFixed(3)}));return r.insertBefore(this).translate(e.offsetx,e.offsety)};var Qt=function(e,i,n,r,o,s,u,c,h){return null==h?a(e,i,n,r,o,s,u,c):t.findDotsAtSegment(e,i,n,r,o,s,u,c,l(e,i,n,r,o,s,u,c,h))},te=function(e,i){return function(n,r,o){n=Dt(n);for(var s,a,l,u,c,h="",d={},p=0,f=0,m=n.length;m>f;f++){if(l=n[f],"M"==l[0])s=+l[1],a=+l[2];else{if(u=Qt(s,a,l[1],l[2],l[3],l[4],l[5],l[6]),p+u>r){if(i&&!d.start){if(c=Qt(s,a,l[1],l[2],l[3],l[4],l[5],l[6],r-p),h+=["C"+c.start.x,c.start.y,c.m.x,c.m.y,c.x,c.y],o)return h;d.start=h,h=["M"+c.x,c.y+"C"+c.n.x,c.n.y,c.end.x,c.end.y,l[5],l[6]].join(),p+=u,s=+l[5],a=+l[6];continue}if(!e&&!i)return c=Qt(s,a,l[1],l[2],l[3],l[4],l[5],l[6],r-p),{x:c.x,y:c.y,alpha:c.alpha}}p+=u,s=+l[5],a=+l[6]}h+=l.shift()+l}return d.end=h,c=e?p:i?d:t.findDotsAtSegment(s,a,l[0],l[1],l[2],l[3],l[4],l[5],1),c.alpha&&(c={x:c.x,y:c.y,alpha:c.alpha}),c}},ee=te(1),ie=te(),ne=te(0,1);t.getTotalLength=ee,t.getPointAtLength=ie,t.getSubpath=function(t,e,i){if(this.getTotalLength(t)-i<1e-6)return ne(t,e).end;var n=ne(t,i,1);return e?ne(n,e).end:n},Kt.getTotalLength=function(){return"path"==this.type?this.node.getTotalLength?this.node.getTotalLength():ee(this.attrs.path):void 0},Kt.getPointAtLength=function(t){return"path"==this.type?ie(this.attrs.path,t):void 0},Kt.getSubpath=function(e,i){return"path"==this.type?t.getSubpath(this.attrs.path,e,i):void 0};var re=t.easing_formulas={linear:function(t){return t},"<":function(t){return H(t,1.7)},">":function(t){return H(t,.48)},"<>":function(t){var e=.48-t/1.04,i=I.sqrt(.1734+e*e),n=i-e,r=H(F(n),1/3)*(0>n?-1:1),o=-i-e,s=H(F(o),1/3)*(0>o?-1:1),a=r+s+.5;return 3*(1-a)*a*a+a*a*a},backIn:function(t){var e=1.70158;return t*t*((e+1)*t-e)},backOut:function(t){t-=1;var e=1.70158;return t*t*((e+1)*t+e)+1},elastic:function(t){return t==!!t?t:H(2,-10*t)*I.sin((t-.075)*(2*j)/.3)+1},bounce:function(t){var e,i=7.5625,n=2.75;return 1/n>t?e=i*t*t:2/n>t?(t-=1.5/n,e=i*t*t+.75):2.5/n>t?(t-=2.25/n,e=i*t*t+.9375):(t-=2.625/n,e=i*t*t+.984375),e}};re.easeIn=re["ease-in"]=re["<"],re.easeOut=re["ease-out"]=re[">"],re.easeInOut=re["ease-in-out"]=re["<>"],re["back-in"]=re.backIn,re["back-out"]=re.backOut;var oe=[],se=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){setTimeout(t,16)},ae=function(){for(var e=+new Date,i=0;i<oe.length;i++){var n=oe[i];if(!n.el.removed&&!n.paused){var r,o,s=e-n.start,a=n.ms,l=n.easing,u=n.from,c=n.diff,h=n.to,d=(n.t,n.el),p={},f={};if(n.initstatus?(s=(n.initstatus*n.anim.top-n.prev)/(n.percent-n.prev)*a,n.status=n.initstatus,delete n.initstatus,n.stop&&oe.splice(i--,1)):n.status=(n.prev+(n.percent-n.prev)*(s/a))/n.anim.top,!(0>s))if(a>s){var m=l(s/a);for(var b in u)if(u[_](b)){switch(et[b]){case $:r=+u[b]+m*a*c[b];break;case"colour":r="rgb("+[le(X(u[b].r+m*a*c[b].r)),le(X(u[b].g+m*a*c[b].g)),le(X(u[b].b+m*a*c[b].b))].join(",")+")";break;case"path":r=[];for(var v=0,y=u[b].length;y>v;v++){r[v]=[u[b][v][0]];for(var w=1,S=u[b][v].length;S>w;w++)r[v][w]=+u[b][v][w]+m*a*c[b][v][w];r[v]=r[v].join(M)}r=r.join(M);break;case"transform":if(c[b].real)for(r=[],v=0,y=u[b].length;y>v;v++)for(r[v]=[u[b][v][0]],w=1,S=u[b][v].length;S>w;w++)r[v][w]=u[b][v][w]+m*a*c[b][v][w];else{var x=function(t){return+u[b][t]+m*a*c[b][t]};r=[["m",x(0),x(1),x(2),x(3),x(4),x(5)]]}break;case"csv":if("clip-rect"==b)for(r=[],v=4;v--;)r[v]=+u[b][v]+m*a*c[b][v];break;default:var A=[][T](u[b]);for(r=[],v=d.paper.customAttributes[b].length;v--;)r[v]=+A[v]+m*a*c[b][v]}p[b]=r}d.attr(p),function(t,e,i){setTimeout(function(){eve("raphael.anim.frame."+t,e,i)})}(d.id,d,n.anim)}else{if(function(e,i,n){setTimeout(function(){eve("raphael.anim.frame."+i.id,i,n),eve("raphael.anim.finish."+i.id,i,n),t.is(e,"function")&&e.call(i)})}(n.callback,d,n.anim),d.attr(h),oe.splice(i--,1),n.repeat>1&&!n.next){for(o in h)h[_](o)&&(f[o]=n.totalOrigin[o]);n.el.attr(f),g(n.anim,n.el,n.anim.percents[0],null,n.totalOrigin,n.repeat-1)}n.next&&!n.stop&&g(n.anim,n.el,n.next,null,n.totalOrigin,n.repeat)}}}t.svg&&d&&d.paper&&d.paper.safari(),oe.length&&se(ae)},le=function(t){return t>255?255:0>t?0:t};Kt.animateWith=function(e,i,n,r,o,s){var a=this;if(a.removed)return s&&s.call(a),a;var l=n instanceof m?n:t.animation(n,r,o,s);g(l,a,l.percents[0],null,a.attr());for(var u=0,c=oe.length;c>u;u++)if(oe[u].anim==i&&oe[u].el==e){oe[c-1].start=oe[u].start;break}return a},Kt.onAnimation=function(t){return t?eve.on("raphael.anim.frame."+this.id,t):eve.unbind("raphael.anim.frame."+this.id),this},m.prototype.delay=function(t){var e=new m(this.anim,this.ms);return e.times=this.times,e.del=+t||0,e},m.prototype.repeat=function(t){var e=new m(this.anim,this.ms);return e.del=this.del,e.times=I.floor(G(t,0))||1,e},t.animation=function(e,i,n,r){if(e instanceof m)return e;(t.is(n,"function")||!n)&&(r=r||n||null,n=null),e=Object(e),i=+i||0;var o,s,a={};for(s in e)e[_](s)&&J(s)!=s&&J(s)+"%"!=s&&(o=!0,a[s]=e[s]);return o?(n&&(a.easing=n),r&&(a.callback=r),new m({100:a},i)):new m(e,i)},Kt.animate=function(e,i,n,r){var o=this;if(o.removed)return r&&r.call(o),o;var s=e instanceof m?e:t.animation(e,i,n,r);return g(s,o,s.percents[0],null,o.attr()),o},Kt.setTime=function(t,e){return t&&null!=e&&this.status(t,V(e,t.ms)/t.ms),this},Kt.status=function(t,e){var i,n,r=[],o=0;if(null!=e)return g(t,this,-1,V(e,1)),this;for(i=oe.length;i>o;o++)if(n=oe[o],n.el.id==this.id&&(!t||n.anim==t)){if(t)return n.status;r.push({anim:n.anim,status:n.status})}return t?0:r},Kt.pause=function(t){for(var e=0;e<oe.length;e++)oe[e].el.id!=this.id||t&&oe[e].anim!=t||eve("raphael.anim.pause."+this.id,this,oe[e].anim)!==!1&&(oe[e].paused=!0);return this},Kt.resume=function(t){for(var e=0;e<oe.length;e++)if(oe[e].el.id==this.id&&(!t||oe[e].anim==t)){var i=oe[e];eve("raphael.anim.resume."+this.id,this,i.anim)!==!1&&(delete i.paused,this.status(i.anim,i.status))}return this},Kt.stop=function(t){for(var e=0;e<oe.length;e++)oe[e].el.id!=this.id||t&&oe[e].anim!=t||eve("raphael.anim.stop."+this.id,this,oe[e].anim)!==!1&&oe.splice(e--,1);return this},eve.on("raphael.remove",b),eve.on("raphael.clear",b),Kt.toString=function(){return"Raphals object"};var ue=function(t){if(this.items=[],this.length=0,this.type="set",t)for(var e=0,i=t.length;i>e;e++)!t[e]||t[e].constructor!=Kt.constructor&&t[e].constructor!=ue||(this[this.items.length]=this.items[this.items.length]=t[e],this.length++)},ce=ue.prototype;ce.push=function(){for(var t,e,i=0,n=arguments.length;n>i;i++)t=arguments[i],!t||t.constructor!=Kt.constructor&&t.constructor!=ue||(e=this.items.length,this[e]=this.items[e]=t,this.length++);return this},ce.pop=function(){return this.length&&delete this[this.length--],this.items.pop()},ce.forEach=function(t,e){for(var i=0,n=this.items.length;n>i;i++)if(t.call(e,this.items[i],i)===!1)return this;return this};for(var he in Kt)Kt[_](he)&&(ce[he]=function(t){return function(){var e=arguments;return this.forEach(function(i){i[t][C](i,e)})}}(he));ce.attr=function(e,i){if(e&&t.is(e,U)&&t.is(e[0],"object"))for(var n=0,r=e.length;r>n;n++)this.items[n].attr(e[n]);else for(var o=0,s=this.items.length;s>o;o++)this.items[o].attr(e,i);return this},ce.clear=function(){for(;this.length;)this.pop()},ce.splice=function(t,e,i){t=0>t?G(this.length+t,0):t,e=G(0,V(this.length-t,e));var n,r=[],o=[],s=[];for(n=2;n<arguments.length;n++)s.push(arguments[n]);for(n=0;e>n;n++)o.push(this[t+n]);for(;n<this.length-t;n++)r.push(this[t+n]);var a=s.length;for(n=0;n<a+r.length;n++)this.items[t+n]=this[t+n]=a>n?s[n]:r[n-a];for(n=this.items.length=this.length-=e-a;this[n];)delete this[n++];return new ue(o)},ce.exclude=function(t){for(var e=0,i=this.length;i>e;e++)if(this[e]==t)return this.splice(e,1),!0},ce.animate=function(e,i,n,r){(t.is(n,"function")||!n)&&(r=n||null);var o,s,a=this.items.length,l=a,u=this;if(!a)return this;r&&(s=function(){!--a&&r.call(u)}),n=t.is(n,z)?n:s;var c=t.animation(e,i,n,s);for(o=this.items[--l].animate(c);l--;)this.items[l]&&!this.items[l].removed&&this.items[l].animateWith(o,c,c);return this},ce.insertAfter=function(t){for(var e=this.items.length;e--;)this.items[e].insertAfter(t);return this},ce.getBBox=function(){for(var t=[],e=[],i=[],n=[],r=this.items.length;r--;)if(!this.items[r].removed){var o=this.items[r].getBBox();t.push(o.x),e.push(o.y),i.push(o.x+o.width),n.push(o.y+o.height)}return t=V[C](0,t),e=V[C](0,e),i=G[C](0,i),n=G[C](0,n),{x:t,y:e,x2:i,y2:n,width:i-t,height:n-e}},ce.clone=function(t){t=new ue;for(var e=0,i=this.items.length;i>e;e++)t.push(this.items[e].clone());return t},ce.toString=function(){return"Raphals set"},t.registerFont=function(t){if(!t.face)return t;this.fonts=this.fonts||{};var e={w:t.w,face:{},glyphs:{}},i=t.face["font-family"];for(var n in t.face)t.face[_](n)&&(e.face[n]=t.face[n]);if(this.fonts[i]?this.fonts[i].push(e):this.fonts[i]=[e],!t.svg){e.face["units-per-em"]=Z(t.face["units-per-em"],10);for(var r in t.glyphs)if(t.glyphs[_](r)){var o=t.glyphs[r];if(e.glyphs[r]={w:o.w,k:{},d:o.d&&"M"+o.d.replace(/[mlcxtrv]/g,function(t){return{l:"L",c:"C",x:"z",t:"m",r:"l",v:"c"}[t]||"M"})+"z"},o.k)for(var s in o.k)o[_](s)&&(e.glyphs[r].k[s]=o.k[s])}}return t},y.getFont=function(e,i,n,r){if(r=r||"normal",n=n||"normal",i=+i||{normal:400,bold:700,lighter:300,bolder:800}[i]||400,t.fonts){var o=t.fonts[e];if(!o){var s=new RegExp("(^|\\s)"+e.replace(/[^\w\d\s+!~.:_-]/g,R)+"(\\s|$)","i");for(var a in t.fonts)if(t.fonts[_](a)&&s.test(a)){o=t.fonts[a];break}}var l;if(o)for(var u=0,c=o.length;c>u&&(l=o[u],l.face["font-weight"]!=i||l.face["font-style"]!=n&&l.face["font-style"]||l.face["font-stretch"]!=r);u++);return l}},y.print=function(e,i,n,r,o,s,a){s=s||"middle",a=G(V(a||0,1),-1);var l,u=P(n)[N](R),c=0,h=0,d=R;if(t.is(r,n)&&(r=this.getFont(r)),r){l=(o||16)/r.face["units-per-em"];for(var p=r.face.bbox[N](w),f=+p[0],m=p[3]-p[1],g=0,b=+p[1]+("baseline"==s?m+ +r.face.descent:m/2),v=0,y=u.length;y>v;v++){if("\n"==u[v])c=0,x=0,h=0,g+=m;else{var S=h&&r.glyphs[u[v-1]]||{},x=r.glyphs[u[v]];c+=h?(S.w||r.w)+(S.k&&S.k[u[v]]||0)+r.w*a:0,h=1}x&&x.d&&(d+=t.transformPath(x.d,["t",c*l,g*l,"s",l,l,f,b,"t",(e-f)/l,(i-b)/l]))}}return this.path(d).attr({fill:"#000",stroke:"none"})},y.add=function(e){if(t.is(e,"array"))for(var i,n=this.set(),r=0,o=e.length;o>r;r++)i=e[r]||{},S[_](i.type)&&n.push(this[i.type]().attr(i));return n},t.format=function(e,i){var n=t.is(i,U)?[0][T](i):arguments;return e&&t.is(e,z)&&n.length-1&&(e=e.replace(x,function(t,e){return null==n[++e]?R:n[e]})),e||R},t.fullfill=function(){var t=/\{([^\}]+)\}/g,e=/(?:(?:^|\.)(.+?)(?=\[|\.|$|\()|\[('|")(.+?)\2\])(\(\))?/g,i=function(t,i,n){var r=n;return i.replace(e,function(t,e,i,n,o){e=e||n,r&&(e in r&&(r=r[e]),"function"==typeof r&&o&&(r=r()))}),r=(null==r||r==n?t:r)+""};return function(e,n){return String(e).replace(t,function(t,e){return i(t,e,n)})}}(),t.ninja=function(){return E.was?A.win.Raphael=E.is:delete Raphael,t},t.st=ce,function(e,i,n){function r(){/in/.test(e.readyState)?setTimeout(r,9):t.eve("raphael.DOMload")}null==e.readyState&&e.addEventListener&&(e.addEventListener(i,n=function(){e.removeEventListener(i,n,!1),e.readyState="complete"},!1),e.readyState="loading"),r()}(document,"DOMContentLoaded"),E.was?A.win.Raphael=t:Raphael=t,eve.on("raphael.DOMload",function(){v=!0})}(),window.Raphael.svg&&function(t){var e="hasOwnProperty",i=String,n=parseFloat,r=parseInt,o=Math,s=o.max,a=o.abs,l=o.pow,u=/[, ]+/,c=t.eve,h="",d=" ",p="http://www.w3.org/1999/xlink",f={block:"M5,0 0,2.5 5,5z",classic:"M5,0 0,2.5 5,5 3.5,3 3.5,2z",diamond:"M2.5,0 5,2.5 2.5,5 0,2.5z",open:"M6,1 1,3.5 6,6",oval:"M2.5,0A2.5,2.5,0,0,1,2.5,5 2.5,2.5,0,0,1,2.5,0z"},m={};t.toString=function(){return"Your browser supports SVG.\nYou are running Raphal "+this.version};var g=function(n,r){if(r){"string"==typeof n&&(n=g(n));for(var o in r)r[e](o)&&("xlink:"==o.substring(0,6)?n.setAttributeNS(p,o.substring(6),i(r[o])):n.setAttribute(o,i(r[o])))}else n=t._g.doc.createElementNS("http://www.w3.org/2000/svg",n),n.style&&(n.style.webkitTapHighlightColor="rgba(0,0,0,0)");return n},b=function(e,r){var u="linear",c=e.id+r,d=.5,p=.5,f=e.node,m=e.paper,b=f.style,v=t._g.doc.getElementById(c);if(!v){if(r=i(r).replace(t._radial_gradient,function(t,e,i){if(u="radial",e&&i){d=n(e),p=n(i);var r=2*(p>.5)-1;l(d-.5,2)+l(p-.5,2)>.25&&(p=o.sqrt(.25-l(d-.5,2))*r+.5)&&.5!=p&&(p=p.toFixed(5)-1e-5*r)}return h}),r=r.split(/\s*\-\s*/),"linear"==u){var y=r.shift();if(y=-n(y),isNaN(y))return null;var w=[0,0,o.cos(t.rad(y)),o.sin(t.rad(y))],S=1/(s(a(w[2]),a(w[3]))||1);w[2]*=S,w[3]*=S,w[2]<0&&(w[0]=-w[2],w[2]=0),w[3]<0&&(w[1]=-w[3],w[3]=0)}var x=t._parseDots(r);if(!x)return null;if(c=c.replace(/[\(\)\s,\xb0#]/g,"_"),e.gradient&&c!=e.gradient.id&&(m.defs.removeChild(e.gradient),delete e.gradient),!e.gradient){v=g(u+"Gradient",{id:c}),e.gradient=v,g(v,"radial"==u?{fx:d,fy:p}:{x1:w[0],y1:w[1],x2:w[2],y2:w[3],gradientTransform:e.matrix.invert()}),m.defs.appendChild(v);for(var _=0,A=x.length;A>_;_++)v.appendChild(g("stop",{offset:x[_].offset?x[_].offset:_?"100%":"0%","stop-color":x[_].color||"#fff"}))}}return g(f,{fill:"url(#"+c+")",opacity:1,"fill-opacity":1}),b.fill=h,b.opacity=1,b.fillOpacity=1,1},v=function(t){var e=t.getBBox(1);g(t.pattern,{patternTransform:t.matrix.invert()+" translate("+e.x+","+e.y+")"})},y=function(n,r,o){if("path"==n.type){for(var s,a,l,u,c,d=i(r).toLowerCase().split("-"),p=n.paper,b=o?"end":"start",v=n.node,y=n.attrs,w=y["stroke-width"],S=d.length,x="classic",_=3,A=3,E=5;S--;)switch(d[S]){case"block":case"classic":case"oval":case"diamond":case"open":case"none":x=d[S];break;case"wide":A=5;break;case"narrow":A=2;break;case"long":_=5;break;case"short":_=2}if("open"==x?(_+=2,A+=2,E+=2,l=1,u=o?4:1,c={fill:"none",stroke:y.stroke}):(u=l=_/2,c={fill:y.stroke,stroke:"none"}),n._.arrows?o?(n._.arrows.endPath&&m[n._.arrows.endPath]--,n._.arrows.endMarker&&m[n._.arrows.endMarker]--):(n._.arrows.startPath&&m[n._.arrows.startPath]--,n._.arrows.startMarker&&m[n._.arrows.startMarker]--):n._.arrows={},"none"!=x){var O="raphael-marker-"+x,C="raphael-marker-"+b+x+_+A;t._g.doc.getElementById(O)?m[O]++:(p.defs.appendChild(g(g("path"),{"stroke-linecap":"round",d:f[x],id:O})),m[O]=1);var T,B=t._g.doc.getElementById(C);B?(m[C]++,T=B.getElementsByTagName("use")[0]):(B=g(g("marker"),{id:C,markerHeight:A,markerWidth:_,orient:"auto",refX:u,refY:A/2}),T=g(g("use"),{"xlink:href":"#"+O,transform:(o?"rotate(180 "+_/2+" "+A/2+") ":h)+"scale("+_/E+","+A/E+")","stroke-width":(1/((_/E+A/E)/2)).toFixed(4)}),B.appendChild(T),p.defs.appendChild(B),m[C]=1),g(T,c);var R=l*("diamond"!=x&&"oval"!=x);o?(s=n._.arrows.startdx*w||0,a=t.getTotalLength(y.path)-R*w):(s=R*w,a=t.getTotalLength(y.path)-(n._.arrows.enddx*w||0)),c={},c["marker-"+b]="url(#"+C+")",(a||s)&&(c.d=Raphael.getSubpath(y.path,s,a)),g(v,c),n._.arrows[b+"Path"]=O,n._.arrows[b+"Marker"]=C,n._.arrows[b+"dx"]=R,n._.arrows[b+"Type"]=x,n._.arrows[b+"String"]=r}else o?(s=n._.arrows.startdx*w||0,a=t.getTotalLength(y.path)-s):(s=0,a=t.getTotalLength(y.path)-(n._.arrows.enddx*w||0)),n._.arrows[b+"Path"]&&g(v,{d:Raphael.getSubpath(y.path,s,a)}),delete n._.arrows[b+"Path"],delete n._.arrows[b+"Marker"],delete n._.arrows[b+"dx"],delete n._.arrows[b+"Type"],delete n._.arrows[b+"String"];for(c in m)if(m[e](c)&&!m[c]){var M=t._g.doc.getElementById(c);M&&M.parentNode.removeChild(M)}}},w={"":[0],none:[0],"-":[3,1],".":[1,1],"-.":[3,1,1,1],"-..":[3,1,1,1,1,1],". ":[1,3],"- ":[4,3],"--":[8,3],"- .":[4,3,1,3],"--.":[8,3,1,3],"--..":[8,3,1,3,1,3]},S=function(t,e,n){if(e=w[i(e).toLowerCase()]){for(var r=t.attrs["stroke-width"]||"1",o={round:r,square:r,butt:0}[t.attrs["stroke-linecap"]||n["stroke-linecap"]]||0,s=[],a=e.length;a--;)s[a]=e[a]*r+(a%2?1:-1)*o;g(t.node,{"stroke-dasharray":s.join(",")})}},x=function(n,o){var l=n.node,c=n.attrs,d=l.style.visibility;l.style.visibility="hidden";for(var f in o)if(o[e](f)){if(!t._availableAttrs[e](f))continue;var m=o[f];switch(c[f]=m,f){case"blur":n.blur(m);break;case"href":case"title":case"target":var w=l.parentNode;if("a"!=w.tagName.toLowerCase()){var x=g("a");w.insertBefore(x,l),x.appendChild(l),w=x}"target"==f?w.setAttributeNS(p,"show","blank"==m?"new":m):w.setAttributeNS(p,f,m);break;case"cursor":l.style.cursor=m;break;case"transform":n.transform(m);break;case"arrow-start":y(n,m);break;case"arrow-end":y(n,m,1);break;case"clip-rect":var _=i(m).split(u);if(4==_.length){n.clip&&n.clip.parentNode.parentNode.removeChild(n.clip.parentNode);var E=g("clipPath"),O=g("rect");E.id=t.createUUID(),g(O,{x:_[0],y:_[1],width:_[2],height:_[3]}),E.appendChild(O),n.paper.defs.appendChild(E),g(l,{"clip-path":"url(#"+E.id+")"}),n.clip=O}if(!m){var C=l.getAttribute("clip-path");if(C){var T=t._g.doc.getElementById(C.replace(/(^url\(#|\)$)/g,h));T&&T.parentNode.removeChild(T),g(l,{"clip-path":h}),delete n.clip}}break;case"path":"path"==n.type&&(g(l,{d:m?c.path=t._pathToAbsolute(m):"M0,0"}),n._.dirty=1,n._.arrows&&("startString"in n._.arrows&&y(n,n._.arrows.startString),"endString"in n._.arrows&&y(n,n._.arrows.endString,1)));break;case"width":if(l.setAttribute(f,m),n._.dirty=1,!c.fx)break;f="x",m=c.x;case"x":c.fx&&(m=-c.x-(c.width||0));case"rx":if("rx"==f&&"rect"==n.type)break;case"cx":l.setAttribute(f,m),n.pattern&&v(n),n._.dirty=1;break;case"height":if(l.setAttribute(f,m),n._.dirty=1,!c.fy)break;f="y",m=c.y;case"y":c.fy&&(m=-c.y-(c.height||0));case"ry":if("ry"==f&&"rect"==n.type)break;case"cy":l.setAttribute(f,m),n.pattern&&v(n),n._.dirty=1;break;case"r":"rect"==n.type?g(l,{rx:m,ry:m}):l.setAttribute(f,m),n._.dirty=1;break;case"src":"image"==n.type&&l.setAttributeNS(p,"href",m);break;case"stroke-width":(1!=n._.sx||1!=n._.sy)&&(m/=s(a(n._.sx),a(n._.sy))||1),n.paper._vbSize&&(m*=n.paper._vbSize),l.setAttribute(f,m),c["stroke-dasharray"]&&S(n,c["stroke-dasharray"],o),n._.arrows&&("startString"in n._.arrows&&y(n,n._.arrows.startString),"endString"in n._.arrows&&y(n,n._.arrows.endString,1));break;case"stroke-dasharray":S(n,m,o);break;case"fill":var B=i(m).match(t._ISURL);if(B){E=g("pattern");var R=g("image");E.id=t.createUUID(),g(E,{x:0,y:0,patternUnits:"userSpaceOnUse",height:1,width:1}),g(R,{x:0,y:0,"xlink:href":B[1]}),E.appendChild(R),function(e){t._preload(B[1],function(){var t=this.offsetWidth,i=this.offsetHeight;g(e,{width:t,height:i}),g(R,{width:t,height:i}),n.paper.safari()})}(E),n.paper.defs.appendChild(E),g(l,{fill:"url(#"+E.id+")"}),n.pattern=E,n.pattern&&v(n);break}var M=t.getRGB(m);if(M.error){if(("circle"==n.type||"ellipse"==n.type||"r"!=i(m).charAt())&&b(n,m)){if("opacity"in c||"fill-opacity"in c){var P=t._g.doc.getElementById(l.getAttribute("fill").replace(/^url\(#|\)$/g,h));if(P){var N=P.getElementsByTagName("stop");g(N[N.length-1],{"stop-opacity":("opacity"in c?c.opacity:1)*("fill-opacity"in c?c["fill-opacity"]:1)})}}c.gradient=m,c.fill="none";break}}else delete o.gradient,delete c.gradient,!t.is(c.opacity,"undefined")&&t.is(o.opacity,"undefined")&&g(l,{opacity:c.opacity}),!t.is(c["fill-opacity"],"undefined")&&t.is(o["fill-opacity"],"undefined")&&g(l,{"fill-opacity":c["fill-opacity"]});M[e]("opacity")&&g(l,{"fill-opacity":M.opacity>1?M.opacity/100:M.opacity});case"stroke":M=t.getRGB(m),l.setAttribute(f,M.hex),"stroke"==f&&M[e]("opacity")&&g(l,{"stroke-opacity":M.opacity>1?M.opacity/100:M.opacity}),"stroke"==f&&n._.arrows&&("startString"in n._.arrows&&y(n,n._.arrows.startString),"endString"in n._.arrows&&y(n,n._.arrows.endString,1));break;case"gradient":("circle"==n.type||"ellipse"==n.type||"r"!=i(m).charAt())&&b(n,m);break;case"opacity":c.gradient&&!c[e]("stroke-opacity")&&g(l,{"stroke-opacity":m>1?m/100:m});case"fill-opacity":if(c.gradient){P=t._g.doc.getElementById(l.getAttribute("fill").replace(/^url\(#|\)$/g,h)),P&&(N=P.getElementsByTagName("stop"),g(N[N.length-1],{"stop-opacity":m}));break}default:"font-size"==f&&(m=r(m,10)+"px");var D=f.replace(/(\-.)/g,function(t){return t.substring(1).toUpperCase()});l.style[D]=m,n._.dirty=1,l.setAttribute(f,m)}}A(n,o),l.style.visibility=d},_=1.2,A=function(n,o){if("text"==n.type&&(o[e]("text")||o[e]("font")||o[e]("font-size")||o[e]("x")||o[e]("y"))){var s=n.attrs,a=n.node,l=a.firstChild?r(t._g.doc.defaultView.getComputedStyle(a.firstChild,h).getPropertyValue("font-size"),10):10;if(o[e]("text")){for(s.text=o.text;a.firstChild;)a.removeChild(a.firstChild);for(var u,c=i(o.text).split("\n"),d=[],p=0,f=c.length;f>p;p++)u=g("tspan"),p&&g(u,{dy:l*_,x:s.x}),u.appendChild(t._g.doc.createTextNode(c[p])),a.appendChild(u),d[p]=u}else for(d=a.getElementsByTagName("tspan"),p=0,f=d.length;f>p;p++)p?g(d[p],{dy:l*_,x:s.x}):g(d[0],{dy:0});g(a,{x:s.x,y:s.y}),n._.dirty=1;var m=n._getBBox(),b=s.y-(m.y+m.height/2);b&&t.is(b,"finite")&&g(d[0],{dy:b})}},E=function(e,i){this[0]=this.node=e,e.raphael=!0,this.id=t._oid++,e.raphaelid=this.id,this.matrix=t.matrix(),this.realPath=null,this.paper=i,this.attrs=this.attrs||{},this._={transform:[],sx:1,sy:1,deg:0,dx:0,dy:0,dirty:1},!i.bottom&&(i.bottom=this),this.prev=i.top,i.top&&(i.top.next=this),i.top=this,this.next=null},O=t.el;E.prototype=O,O.constructor=E,t._engine.path=function(t,e){var i=g("path");e.canvas&&e.canvas.appendChild(i);var n=new E(i,e);return n.type="path",x(n,{fill:"none",stroke:"#000",path:t}),n},O.rotate=function(t,e,r){if(this.removed)return this;if(t=i(t).split(u),t.length-1&&(e=n(t[1]),r=n(t[2])),t=n(t[0]),null==r&&(e=r),null==e||null==r){var o=this.getBBox(1);e=o.x+o.width/2,r=o.y+o.height/2}return this.transform(this._.transform.concat([["r",t,e,r]])),this},O.scale=function(t,e,r,o){if(this.removed)return this;if(t=i(t).split(u),t.length-1&&(e=n(t[1]),r=n(t[2]),o=n(t[3])),t=n(t[0]),null==e&&(e=t),null==o&&(r=o),null==r||null==o)var s=this.getBBox(1);return r=null==r?s.x+s.width/2:r,o=null==o?s.y+s.height/2:o,this.transform(this._.transform.concat([["s",t,e,r,o]])),this},O.translate=function(t,e){return this.removed?this:(t=i(t).split(u),t.length-1&&(e=n(t[1])),t=n(t[0])||0,e=+e||0,this.transform(this._.transform.concat([["t",t,e]])),this)},O.transform=function(i){var n=this._;if(null==i)return n.transform;if(t._extractTransform(this,i),this.clip&&g(this.clip,{transform:this.matrix.invert()}),this.pattern&&v(this),this.node&&g(this.node,{transform:this.matrix}),1!=n.sx||1!=n.sy){var r=this.attrs[e]("stroke-width")?this.attrs["stroke-width"]:1;this.attr({"stroke-width":r})}return this},O.hide=function(){return!this.removed&&this.paper.safari(this.node.style.display="none"),this},O.show=function(){return!this.removed&&this.paper.safari(this.node.style.display=""),this},O.remove=function(){if(!this.removed&&this.node.parentNode){var e=this.paper;e.__set__&&e.__set__.exclude(this),c.unbind("raphael.*.*."+this.id),this.gradient&&e.defs.removeChild(this.gradient),t._tear(this,e),"a"==this.node.parentNode.tagName.toLowerCase()?this.node.parentNode.parentNode.removeChild(this.node.parentNode):this.node.parentNode.removeChild(this.node);for(var i in this)this[i]="function"==typeof this[i]?t._removedFactory(i):null;this.removed=!0}},O._getBBox=function(){if("none"==this.node.style.display){this.show();var t=!0}var e={};try{e=this.node.getBBox()}catch(i){}finally{e=e||{}}return t&&this.hide(),e},O.attr=function(i,n){if(this.removed)return this;if(null==i){var r={};for(var o in this.attrs)this.attrs[e](o)&&(r[o]=this.attrs[o]);return r.gradient&&"none"==r.fill&&(r.fill=r.gradient)&&delete r.gradient,r.transform=this._.transform,r}if(null==n&&t.is(i,"string")){if("fill"==i&&"none"==this.attrs.fill&&this.attrs.gradient)return this.attrs.gradient;if("transform"==i)return this._.transform;for(var s=i.split(u),a={},l=0,h=s.length;h>l;l++)i=s[l],i in this.attrs?a[i]=this.attrs[i]:t.is(this.paper.customAttributes[i],"function")?a[i]=this.paper.customAttributes[i].def:a[i]=t._availableAttrs[i];return h-1?a:a[s[0]]}if(null==n&&t.is(i,"array")){for(a={},l=0,h=i.length;h>l;l++)a[i[l]]=this.attr(i[l]);return a}if(null!=n){var d={};d[i]=n}else null!=i&&t.is(i,"object")&&(d=i);for(var p in d)c("raphael.attr."+p+"."+this.id,this,d[p]);for(p in this.paper.customAttributes)if(this.paper.customAttributes[e](p)&&d[e](p)&&t.is(this.paper.customAttributes[p],"function")){var f=this.paper.customAttributes[p].apply(this,[].concat(d[p]));this.attrs[p]=d[p];for(var m in f)f[e](m)&&(d[m]=f[m])}return x(this,d),this},O.toFront=function(){if(this.removed)return this;"a"==this.node.parentNode.tagName.toLowerCase()?this.node.parentNode.parentNode.appendChild(this.node.parentNode):this.node.parentNode.appendChild(this.node);var e=this.paper;return e.top!=this&&t._tofront(this,e),this},O.toBack=function(){if(this.removed)return this;var e=this.node.parentNode;"a"==e.tagName.toLowerCase()?e.parentNode.insertBefore(this.node.parentNode,this.node.parentNode.parentNode.firstChild):e.firstChild!=this.node&&e.insertBefore(this.node,this.node.parentNode.firstChild),t._toback(this,this.paper);this.paper;return this},O.insertAfter=function(e){if(this.removed)return this;var i=e.node||e[e.length-1].node;return i.nextSibling?i.parentNode.insertBefore(this.node,i.nextSibling):i.parentNode.appendChild(this.node),t._insertafter(this,e,this.paper),this},O.insertBefore=function(e){if(this.removed)return this;var i=e.node||e[0].node;return i.parentNode.insertBefore(this.node,i),t._insertbefore(this,e,this.paper),this},O.blur=function(e){var i=this;if(0!==+e){var n=g("filter"),r=g("feGaussianBlur");i.attrs.blur=e,n.id=t.createUUID(),g(r,{stdDeviation:+e||1.5}),n.appendChild(r),i.paper.defs.appendChild(n),i._blur=n,g(i.node,{filter:"url(#"+n.id+")"})}else i._blur&&(i._blur.parentNode.removeChild(i._blur),delete i._blur,delete i.attrs.blur),i.node.removeAttribute("filter")},t._engine.circle=function(t,e,i,n){var r=g("circle");t.canvas&&t.canvas.appendChild(r);var o=new E(r,t);return o.attrs={cx:e,cy:i,r:n,fill:"none",stroke:"#000"},o.type="circle",g(r,o.attrs),o},t._engine.rect=function(t,e,i,n,r,o){var s=g("rect");t.canvas&&t.canvas.appendChild(s);var a=new E(s,t);return a.attrs={x:e,y:i,width:n,height:r,r:o||0,rx:o||0,ry:o||0,fill:"none",stroke:"#000"},a.type="rect",g(s,a.attrs),a},t._engine.ellipse=function(t,e,i,n,r){var o=g("ellipse");t.canvas&&t.canvas.appendChild(o);var s=new E(o,t);return s.attrs={cx:e,cy:i,rx:n,ry:r,fill:"none",stroke:"#000"},s.type="ellipse",g(o,s.attrs),s},t._engine.image=function(t,e,i,n,r,o){var s=g("image");g(s,{x:i,y:n,width:r,height:o,preserveAspectRatio:"none"}),s.setAttributeNS(p,"href",e),t.canvas&&t.canvas.appendChild(s);var a=new E(s,t);return a.attrs={x:i,y:n,width:r,height:o,src:e},a.type="image",a},t._engine.text=function(e,i,n,r){var o=g("text");e.canvas&&e.canvas.appendChild(o);var s=new E(o,e);return s.attrs={x:i,y:n,"text-anchor":"middle",text:r,font:t._availableAttrs.font,stroke:"none",fill:"#000"},s.type="text",x(s,s.attrs),s},t._engine.setSize=function(t,e){return this.width=t||this.width,this.height=e||this.height,this.canvas.setAttribute("width",this.width),this.canvas.setAttribute("height",this.height),this._viewBox&&this.setViewBox.apply(this,this._viewBox),this},t._engine.create=function(){var e=t._getContainer.apply(0,arguments),i=e&&e.container,n=e.x,r=e.y,o=e.width,s=e.height;if(!i)throw new Error("SVG container not found.");var a,l=g("svg"),u="overflow:hidden;";return n=n||0,r=r||0,o=o||512,s=s||342,g(l,{height:s,version:1.1,width:o,xmlns:"http://www.w3.org/2000/svg"}),1==i?(l.style.cssText=u+"position:absolute;left:"+n+"px;top:"+r+"px",t._g.doc.body.appendChild(l),a=1):(l.style.cssText=u+"position:relative",i.firstChild?i.insertBefore(l,i.firstChild):i.appendChild(l)),i=new t._Paper,i.width=o,i.height=s,i.canvas=l,i.clear(),i._left=i._top=0,a&&(i.renderfix=function(){}),i.renderfix(),i},t._engine.setViewBox=function(t,e,i,n,r){c("raphael.setViewBox",this,this._viewBox,[t,e,i,n,r]);var o,a,l=s(i/this.width,n/this.height),u=this.top,h=r?"meet":"xMinYMin";for(null==t?(this._vbSize&&(l=1),delete this._vbSize,o="0 0 "+this.width+d+this.height):(this._vbSize=l,o=t+d+e+d+i+d+n),g(this.canvas,{viewBox:o,preserveAspectRatio:h});l&&u;)a="stroke-width"in u.attrs?u.attrs["stroke-width"]:1,u.attr({"stroke-width":a}),u._.dirty=1,u._.dirtyT=1,u=u.prev;return this._viewBox=[t,e,i,n,!!r],this},t.prototype.renderfix=function(){var t,e=this.canvas,i=e.style;try{t=e.getScreenCTM()||e.createSVGMatrix()}catch(n){t=e.createSVGMatrix()}var r=-t.e%1,o=-t.f%1;(r||o)&&(r&&(this._left=(this._left+r)%1,i.left=this._left+"px"),o&&(this._top=(this._top+o)%1,i.top=this._top+"px"))},t.prototype.clear=function(){t.eve("raphael.clear",this);for(var e=this.canvas;e.firstChild;)e.removeChild(e.firstChild);this.bottom=this.top=null,(this.desc=g("desc")).appendChild(t._g.doc.createTextNode("Created with Raphal "+t.version)),e.appendChild(this.desc),e.appendChild(this.defs=g("defs"))},t.prototype.remove=function(){c("raphael.remove",this),this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas);for(var e in this)this[e]="function"==typeof this[e]?t._removedFactory(e):null};var C=t.st;for(var T in O)O[e](T)&&!C[e](T)&&(C[T]=function(t){return function(){var e=arguments;return this.forEach(function(i){i[t].apply(i,e)})}}(T))}(window.Raphael),window.Raphael.vml&&function(t){var e="hasOwnProperty",i=String,n=parseFloat,r=Math,o=r.round,s=r.max,a=r.min,l=r.abs,u="fill",c=/[, ]+/,h=t.eve,d=" progid:DXImageTransform.Microsoft",p=" ",f="",m={
M:"m",L:"l",C:"c",Z:"x",m:"t",l:"r",c:"v",z:"x"},g=/([clmz]),?([^clmz]*)/gi,b=/ progid:\S+Blur\([^\)]+\)/g,v=/-?[^,\s-]+/g,y="position:absolute;left:0;top:0;width:1px;height:1px",w=21600,S={path:1,rect:1,image:1},x={circle:1,ellipse:1},_=function(e){var n=/[ahqstv]/gi,r=t._pathToAbsolute;if(i(e).match(n)&&(r=t._path2curve),n=/[clmz]/g,r==t._pathToAbsolute&&!i(e).match(n)){var s=i(e).replace(g,function(t,e,i){var n=[],r="m"==e.toLowerCase(),s=m[e];return i.replace(v,function(t){r&&2==n.length&&(s+=n+m["m"==e?"l":"L"],n=[]),n.push(o(t*w))}),s+n});return s}var a,l,u=r(e);s=[];for(var c=0,h=u.length;h>c;c++){a=u[c],l=u[c][0].toLowerCase(),"z"==l&&(l="x");for(var d=1,b=a.length;b>d;d++)l+=o(a[d]*w)+(d!=b-1?",":f);s.push(l)}return s.join(p)},A=function(e,i,n){var r=t.matrix();return r.rotate(-e,.5,.5),{dx:r.x(i,n),dy:r.y(i,n)}},E=function(t,e,i,n,r,o){var s=t._,a=t.matrix,c=s.fillpos,h=t.node,d=h.style,f=1,m="",g=w/e,b=w/i;if(d.visibility="hidden",e&&i){if(h.coordsize=l(g)+p+l(b),d.rotation=o*(0>e*i?-1:1),o){var v=A(o,n,r);n=v.dx,r=v.dy}if(0>e&&(m+="x"),0>i&&(m+=" y")&&(f=-1),d.flip=m,h.coordorigin=n*-g+p+r*-b,c||s.fillsize){var y=h.getElementsByTagName(u);y=y&&y[0],h.removeChild(y),c&&(v=A(o,a.x(c[0],c[1]),a.y(c[0],c[1])),y.position=v.dx*f+p+v.dy*f),s.fillsize&&(y.size=s.fillsize[0]*l(e)+p+s.fillsize[1]*l(i)),h.appendChild(y)}d.visibility="visible"}};t.toString=function(){return"Your browser doesnt support SVG. Falling down to VML.\nYou are running Raphal "+this.version};var O=function(t,e,n){for(var r=i(e).toLowerCase().split("-"),o=n?"end":"start",s=r.length,a="classic",l="medium",u="medium";s--;)switch(r[s]){case"block":case"classic":case"oval":case"diamond":case"open":case"none":a=r[s];break;case"wide":case"narrow":u=r[s];break;case"long":case"short":l=r[s]}var c=t.node.getElementsByTagName("stroke")[0];c[o+"arrow"]=a,c[o+"arrowlength"]=l,c[o+"arrowwidth"]=u},C=function(r,l){r.attrs=r.attrs||{};var h=r.node,d=r.attrs,m=h.style,g=S[r.type]&&(l.x!=d.x||l.y!=d.y||l.width!=d.width||l.height!=d.height||l.cx!=d.cx||l.cy!=d.cy||l.rx!=d.rx||l.ry!=d.ry||l.r!=d.r),b=x[r.type]&&(d.cx!=l.cx||d.cy!=l.cy||d.r!=l.r||d.rx!=l.rx||d.ry!=l.ry),v=r;for(var y in l)l[e](y)&&(d[y]=l[y]);if(g&&(d.path=t._getPath[r.type](r),r._.dirty=1),l.href&&(h.href=l.href),l.title&&(h.title=l.title),l.target&&(h.target=l.target),l.cursor&&(m.cursor=l.cursor),"blur"in l&&r.blur(l.blur),(l.path&&"path"==r.type||g)&&(h.path=_(~i(d.path).toLowerCase().indexOf("r")?t._pathToAbsolute(d.path):d.path),"image"==r.type&&(r._.fillpos=[d.x,d.y],r._.fillsize=[d.width,d.height],E(r,1,1,0,0,0))),"transform"in l&&r.transform(l.transform),b){var A=+d.cx,C=+d.cy,B=+d.rx||+d.r||0,R=+d.ry||+d.r||0;h.path=t.format("ar{0},{1},{2},{3},{4},{1},{4},{1}x",o((A-B)*w),o((C-R)*w),o((A+B)*w),o((C+R)*w),o(A*w))}if("clip-rect"in l){var P=i(l["clip-rect"]).split(c);if(4==P.length){P[2]=+P[2]+ +P[0],P[3]=+P[3]+ +P[1];var N=h.clipRect||t._g.doc.createElement("div"),D=N.style;D.clip=t.format("rect({1}px {2}px {3}px {0}px)",P),h.clipRect||(D.position="absolute",D.top=0,D.left=0,D.width=r.paper.width+"px",D.height=r.paper.height+"px",h.parentNode.insertBefore(N,h),N.appendChild(h),h.clipRect=N)}l["clip-rect"]||h.clipRect&&(h.clipRect.style.clip="auto")}if(r.textpath){var k=r.textpath.style;l.font&&(k.font=l.font),l["font-family"]&&(k.fontFamily='"'+l["font-family"].split(",")[0].replace(/^['"]+|['"]+$/g,f)+'"'),l["font-size"]&&(k.fontSize=l["font-size"]),l["font-weight"]&&(k.fontWeight=l["font-weight"]),l["font-style"]&&(k.fontStyle=l["font-style"])}if("arrow-start"in l&&O(v,l["arrow-start"]),"arrow-end"in l&&O(v,l["arrow-end"],1),null!=l.opacity||null!=l["stroke-width"]||null!=l.fill||null!=l.src||null!=l.stroke||null!=l["stroke-width"]||null!=l["stroke-opacity"]||null!=l["fill-opacity"]||null!=l["stroke-dasharray"]||null!=l["stroke-miterlimit"]||null!=l["stroke-linejoin"]||null!=l["stroke-linecap"]){var L=h.getElementsByTagName(u),I=!1;if(L=L&&L[0],!L&&(I=L=M(u)),"image"==r.type&&l.src&&(L.src=l.src),l.fill&&(L.on=!0),(null==L.on||"none"==l.fill||null===l.fill)&&(L.on=!1),L.on&&l.fill){var G=i(l.fill).match(t._ISURL);if(G){L.parentNode==h&&h.removeChild(L),L.rotate=!0,L.src=G[1],L.type="tile";var V=r.getBBox(1);L.position=V.x+p+V.y,r._.fillpos=[V.x,V.y],t._preload(G[1],function(){r._.fillsize=[this.offsetWidth,this.offsetHeight]})}else L.color=t.getRGB(l.fill).hex,L.src=f,L.type="solid",t.getRGB(l.fill).error&&(v.type in{circle:1,ellipse:1}||"r"!=i(l.fill).charAt())&&T(v,l.fill,L)&&(d.fill="none",d.gradient=l.fill,L.rotate=!1)}if("fill-opacity"in l||"opacity"in l){var F=((+d["fill-opacity"]+1||2)-1)*((+d.opacity+1||2)-1)*((+t.getRGB(l.fill).o+1||2)-1);F=a(s(F,0),1),L.opacity=F,L.src&&(L.color="none")}h.appendChild(L);var H=h.getElementsByTagName("stroke")&&h.getElementsByTagName("stroke")[0],j=!1;!H&&(j=H=M("stroke")),(l.stroke&&"none"!=l.stroke||l["stroke-width"]||null!=l["stroke-opacity"]||l["stroke-dasharray"]||l["stroke-miterlimit"]||l["stroke-linejoin"]||l["stroke-linecap"])&&(H.on=!0),("none"==l.stroke||null===l.stroke||null==H.on||0==l.stroke||0==l["stroke-width"])&&(H.on=!1);var $=t.getRGB(l.stroke);H.on&&l.stroke&&(H.color=$.hex),F=((+d["stroke-opacity"]+1||2)-1)*((+d.opacity+1||2)-1)*((+$.o+1||2)-1);var z=.75*(n(l["stroke-width"])||1);if(F=a(s(F,0),1),null==l["stroke-width"]&&(z=d["stroke-width"]),l["stroke-width"]&&(H.weight=z),z&&1>z&&(F*=z)&&(H.weight=1),H.opacity=F,l["stroke-linejoin"]&&(H.joinstyle=l["stroke-linejoin"]||"miter"),H.miterlimit=l["stroke-miterlimit"]||8,l["stroke-linecap"]&&(H.endcap="butt"==l["stroke-linecap"]?"flat":"square"==l["stroke-linecap"]?"square":"round"),l["stroke-dasharray"]){var U={"-":"shortdash",".":"shortdot","-.":"shortdashdot","-..":"shortdashdotdot",". ":"dot","- ":"dash","--":"longdash","- .":"dashdot","--.":"longdashdot","--..":"longdashdotdot"};H.dashstyle=U[e](l["stroke-dasharray"])?U[l["stroke-dasharray"]]:f}j&&h.appendChild(H)}if("text"==v.type){v.paper.canvas.style.display=f;var W=v.paper.span,Y=100,q=d.font&&d.font.match(/\d+(?:\.\d*)?(?=px)/);m=W.style,d.font&&(m.font=d.font),d["font-family"]&&(m.fontFamily=d["font-family"]),d["font-weight"]&&(m.fontWeight=d["font-weight"]),d["font-style"]&&(m.fontStyle=d["font-style"]),q=n(d["font-size"]||q&&q[0])||10,m.fontSize=q*Y+"px",v.textpath.string&&(W.innerHTML=i(v.textpath.string).replace(/</g,"&#60;").replace(/&/g,"&#38;").replace(/\n/g,"<br>"));var K=W.getBoundingClientRect();v.W=d.w=(K.right-K.left)/Y,v.H=d.h=(K.bottom-K.top)/Y,v.X=d.x,v.Y=d.y+v.H/2,("x"in l||"y"in l)&&(v.path.v=t.format("m{0},{1}l{2},{1}",o(d.x*w),o(d.y*w),o(d.x*w)+1));for(var X=["x","y","text","font","font-family","font-weight","font-style","font-size"],J=0,Z=X.length;Z>J;J++)if(X[J]in l){v._.dirty=1;break}switch(d["text-anchor"]){case"start":v.textpath.style["v-text-align"]="left",v.bbx=v.W/2;break;case"end":v.textpath.style["v-text-align"]="right",v.bbx=-v.W/2;break;default:v.textpath.style["v-text-align"]="center",v.bbx=0}v.textpath.style["v-text-kern"]=!0}},T=function(e,o,s){e.attrs=e.attrs||{};var a=(e.attrs,Math.pow),l="linear",u=".5 .5";if(e.attrs.gradient=o,o=i(o).replace(t._radial_gradient,function(t,e,i){return l="radial",e&&i&&(e=n(e),i=n(i),a(e-.5,2)+a(i-.5,2)>.25&&(i=r.sqrt(.25-a(e-.5,2))*(2*(i>.5)-1)+.5),u=e+p+i),f}),o=o.split(/\s*\-\s*/),"linear"==l){var c=o.shift();if(c=-n(c),isNaN(c))return null}var h=t._parseDots(o);if(!h)return null;if(e=e.shape||e.node,h.length){e.removeChild(s),s.on=!0,s.method="none",s.color=h[0].color,s.color2=h[h.length-1].color;for(var d=[],m=0,g=h.length;g>m;m++)h[m].offset&&d.push(h[m].offset+p+h[m].color);s.colors=d.length?d.join():"0% "+s.color,"radial"==l?(s.type="gradientTitle",s.focus="100%",s.focussize="0 0",s.focusposition=u,s.angle=0):(s.type="gradient",s.angle=(270-c)%360),e.appendChild(s)}return 1},B=function(e,i){this[0]=this.node=e,e.raphael=!0,this.id=t._oid++,e.raphaelid=this.id,this.X=0,this.Y=0,this.attrs={},this.paper=i,this.matrix=t.matrix(),this._={transform:[],sx:1,sy:1,dx:0,dy:0,deg:0,dirty:1,dirtyT:1},!i.bottom&&(i.bottom=this),this.prev=i.top,i.top&&(i.top.next=this),i.top=this,this.next=null},R=t.el;B.prototype=R,R.constructor=B,R.transform=function(e){if(null==e)return this._.transform;var n,r=this.paper._viewBoxShift,o=r?"s"+[r.scale,r.scale]+"-1-1t"+[r.dx,r.dy]:f;r&&(n=e=i(e).replace(/\.{3}|\u2026/g,this._.transform||f)),t._extractTransform(this,o+e);var s,a=this.matrix.clone(),l=this.skew,u=this.node,c=~i(this.attrs.fill).indexOf("-"),h=!i(this.attrs.fill).indexOf("url(");if(a.translate(-.5,-.5),h||c||"image"==this.type)if(l.matrix="1 0 0 1",l.offset="0 0",s=a.split(),c&&s.noRotation||!s.isSimple){u.style.filter=a.toFilter();var d=this.getBBox(),m=this.getBBox(1),g=d.x-m.x,b=d.y-m.y;u.coordorigin=g*-w+p+b*-w,E(this,1,1,g,b,0)}else u.style.filter=f,E(this,s.scalex,s.scaley,s.dx,s.dy,s.rotate);else u.style.filter=f,l.matrix=i(a),l.offset=a.offset();return n&&(this._.transform=n),this},R.rotate=function(t,e,r){if(this.removed)return this;if(null!=t){if(t=i(t).split(c),t.length-1&&(e=n(t[1]),r=n(t[2])),t=n(t[0]),null==r&&(e=r),null==e||null==r){var o=this.getBBox(1);e=o.x+o.width/2,r=o.y+o.height/2}return this._.dirtyT=1,this.transform(this._.transform.concat([["r",t,e,r]])),this}},R.translate=function(t,e){return this.removed?this:(t=i(t).split(c),t.length-1&&(e=n(t[1])),t=n(t[0])||0,e=+e||0,this._.bbox&&(this._.bbox.x+=t,this._.bbox.y+=e),this.transform(this._.transform.concat([["t",t,e]])),this)},R.scale=function(t,e,r,o){if(this.removed)return this;if(t=i(t).split(c),t.length-1&&(e=n(t[1]),r=n(t[2]),o=n(t[3]),isNaN(r)&&(r=null),isNaN(o)&&(o=null)),t=n(t[0]),null==e&&(e=t),null==o&&(r=o),null==r||null==o)var s=this.getBBox(1);return r=null==r?s.x+s.width/2:r,o=null==o?s.y+s.height/2:o,this.transform(this._.transform.concat([["s",t,e,r,o]])),this._.dirtyT=1,this},R.hide=function(){return!this.removed&&(this.node.style.display="none"),this},R.show=function(){return!this.removed&&(this.node.style.display=f),this},R._getBBox=function(){return this.removed?{}:{x:this.X+(this.bbx||0)-this.W/2,y:this.Y-this.H,width:this.W,height:this.H}},R.remove=function(){if(!this.removed&&this.node.parentNode){this.paper.__set__&&this.paper.__set__.exclude(this),t.eve.unbind("raphael.*.*."+this.id),t._tear(this,this.paper),this.node.parentNode.removeChild(this.node),this.shape&&this.shape.parentNode.removeChild(this.shape);for(var e in this)this[e]="function"==typeof this[e]?t._removedFactory(e):null;this.removed=!0}},R.attr=function(i,n){if(this.removed)return this;if(null==i){var r={};for(var o in this.attrs)this.attrs[e](o)&&(r[o]=this.attrs[o]);return r.gradient&&"none"==r.fill&&(r.fill=r.gradient)&&delete r.gradient,r.transform=this._.transform,r}if(null==n&&t.is(i,"string")){if(i==u&&"none"==this.attrs.fill&&this.attrs.gradient)return this.attrs.gradient;for(var s=i.split(c),a={},l=0,d=s.length;d>l;l++)i=s[l],i in this.attrs?a[i]=this.attrs[i]:t.is(this.paper.customAttributes[i],"function")?a[i]=this.paper.customAttributes[i].def:a[i]=t._availableAttrs[i];return d-1?a:a[s[0]]}if(this.attrs&&null==n&&t.is(i,"array")){for(a={},l=0,d=i.length;d>l;l++)a[i[l]]=this.attr(i[l]);return a}var p;null!=n&&(p={},p[i]=n),null==n&&t.is(i,"object")&&(p=i);for(var f in p)h("raphael.attr."+f+"."+this.id,this,p[f]);if(p){for(f in this.paper.customAttributes)if(this.paper.customAttributes[e](f)&&p[e](f)&&t.is(this.paper.customAttributes[f],"function")){var m=this.paper.customAttributes[f].apply(this,[].concat(p[f]));this.attrs[f]=p[f];for(var g in m)m[e](g)&&(p[g]=m[g])}p.text&&"text"==this.type&&(this.textpath.string=p.text),C(this,p)}return this},R.toFront=function(){return!this.removed&&this.node.parentNode.appendChild(this.node),this.paper&&this.paper.top!=this&&t._tofront(this,this.paper),this},R.toBack=function(){return this.removed?this:(this.node.parentNode.firstChild!=this.node&&(this.node.parentNode.insertBefore(this.node,this.node.parentNode.firstChild),t._toback(this,this.paper)),this)},R.insertAfter=function(e){return this.removed?this:(e.constructor==t.st.constructor&&(e=e[e.length-1]),e.node.nextSibling?e.node.parentNode.insertBefore(this.node,e.node.nextSibling):e.node.parentNode.appendChild(this.node),t._insertafter(this,e,this.paper),this)},R.insertBefore=function(e){return this.removed?this:(e.constructor==t.st.constructor&&(e=e[0]),e.node.parentNode.insertBefore(this.node,e.node),t._insertbefore(this,e,this.paper),this)},R.blur=function(e){var i=this.node.runtimeStyle,n=i.filter;n=n.replace(b,f),0!==+e?(this.attrs.blur=e,i.filter=n+p+d+".Blur(pixelradius="+(+e||1.5)+")",i.margin=t.format("-{0}px 0 0 -{0}px",o(+e||1.5))):(i.filter=n,i.margin=0,delete this.attrs.blur)},t._engine.path=function(t,e){var i=M("shape");i.style.cssText=y,i.coordsize=w+p+w,i.coordorigin=e.coordorigin;var n=new B(i,e),r={fill:"none",stroke:"#000"};t&&(r.path=t),n.type="path",n.path=[],n.Path=f,C(n,r),e.canvas.appendChild(i);var o=M("skew");return o.on=!0,i.appendChild(o),n.skew=o,n.transform(f),n},t._engine.rect=function(e,i,n,r,o,s){var a=t._rectPath(i,n,r,o,s),l=e.path(a),u=l.attrs;return l.X=u.x=i,l.Y=u.y=n,l.W=u.width=r,l.H=u.height=o,u.r=s,u.path=a,l.type="rect",l},t._engine.ellipse=function(t,e,i,n,r){var o=t.path();o.attrs;return o.X=e-n,o.Y=i-r,o.W=2*n,o.H=2*r,o.type="ellipse",C(o,{cx:e,cy:i,rx:n,ry:r}),o},t._engine.circle=function(t,e,i,n){var r=t.path();r.attrs;return r.X=e-n,r.Y=i-n,r.W=r.H=2*n,r.type="circle",C(r,{cx:e,cy:i,r:n}),r},t._engine.image=function(e,i,n,r,o,s){var a=t._rectPath(n,r,o,s),l=e.path(a).attr({stroke:"none"}),c=l.attrs,h=l.node,d=h.getElementsByTagName(u)[0];return c.src=i,l.X=c.x=n,l.Y=c.y=r,l.W=c.width=o,l.H=c.height=s,c.path=a,l.type="image",d.parentNode==h&&h.removeChild(d),d.rotate=!0,d.src=i,d.type="tile",l._.fillpos=[n,r],l._.fillsize=[o,s],h.appendChild(d),E(l,1,1,0,0,0),l},t._engine.text=function(e,n,r,s){var a=M("shape"),l=M("path"),u=M("textpath");n=n||0,r=r||0,s=s||"",l.v=t.format("m{0},{1}l{2},{1}",o(n*w),o(r*w),o(n*w)+1),l.textpathok=!0,u.string=i(s),u.on=!0,a.style.cssText=y,a.coordsize=w+p+w,a.coordorigin="0 0";var c=new B(a,e),h={fill:"#000",stroke:"none",font:t._availableAttrs.font,text:s};c.shape=a,c.path=l,c.textpath=u,c.type="text",c.attrs.text=i(s),c.attrs.x=n,c.attrs.y=r,c.attrs.w=1,c.attrs.h=1,C(c,h),a.appendChild(u),a.appendChild(l),e.canvas.appendChild(a);var d=M("skew");return d.on=!0,a.appendChild(d),c.skew=d,c.transform(f),c},t._engine.setSize=function(e,i){var n=this.canvas.style;return this.width=e,this.height=i,e==+e&&(e+="px"),i==+i&&(i+="px"),n.width=e,n.height=i,n.clip="rect(0 "+e+" "+i+" 0)",this._viewBox&&t._engine.setViewBox.apply(this,this._viewBox),this},t._engine.setViewBox=function(e,i,n,r,o){t.eve("raphael.setViewBox",this,this._viewBox,[e,i,n,r,o]);var a,l,u=this.width,c=this.height,h=1/s(n/u,r/c);return o&&(a=c/r,l=u/n,u>n*a&&(e-=(u-n*a)/2/a),c>r*l&&(i-=(c-r*l)/2/l)),this._viewBox=[e,i,n,r,!!o],this._viewBoxShift={dx:-e,dy:-i,scale:h},this.forEach(function(t){t.transform("...")}),this};var M;t._engine.initWin=function(t){var e=t.document;e.createStyleSheet().addRule(".rvml","behavior:url(#default#VML)");try{!e.namespaces.rvml&&e.namespaces.add("rvml","urn:schemas-microsoft-com:vml"),M=function(t){return e.createElement("<rvml:"+t+' class="rvml">')}}catch(i){M=function(t){return e.createElement("<"+t+' xmlns="urn:schemas-microsoft.com:vml" class="rvml">')}}},t._engine.initWin(t._g.win),t._engine.create=function(){var e=t._getContainer.apply(0,arguments),i=e.container,n=e.height,r=e.width,o=e.x,s=e.y;if(!i)throw new Error("VML container not found.");var a=new t._Paper,l=a.canvas=t._g.doc.createElement("div"),u=l.style;return o=o||0,s=s||0,r=r||512,n=n||342,a.width=r,a.height=n,r==+r&&(r+="px"),n==+n&&(n+="px"),a.coordsize=1e3*w+p+1e3*w,a.coordorigin="0 0",a.span=t._g.doc.createElement("span"),a.span.style.cssText="position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;",l.appendChild(a.span),u.cssText=t.format("top:0;left:0;width:{0};height:{1};display:inline-block;position:relative;clip:rect(0 {0} {1} 0);overflow:hidden",r,n),1==i?(t._g.doc.body.appendChild(l),u.left=o+"px",u.top=s+"px",u.position="absolute"):i.firstChild?i.insertBefore(l,i.firstChild):i.appendChild(l),a.renderfix=function(){},a},t.prototype.clear=function(){t.eve("raphael.clear",this),this.canvas.innerHTML=f,this.span=t._g.doc.createElement("span"),this.span.style.cssText="position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;display:inline;",this.canvas.appendChild(this.span),this.bottom=this.top=null},t.prototype.remove=function(){t.eve("raphael.remove",this),this.canvas.parentNode.removeChild(this.canvas);for(var e in this)this[e]="function"==typeof this[e]?t._removedFactory(e):null;return!0};var P=t.st;for(var N in R)R[e](N)&&!P[e](N)&&(P[N]=function(t){return function(){var e=arguments;return this.forEach(function(i){i[t].apply(i,e)})}}(N))}(window.Raphael);var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(t){var e,i,n,r,o,s,a,l="",u=0;for(t=Base64._utf8_encode(t);u<t.length;)e=t.charCodeAt(u++),i=t.charCodeAt(u++),n=t.charCodeAt(u++),r=e>>2,o=(3&e)<<4|i>>4,s=(15&i)<<2|n>>6,a=63&n,isNaN(i)?s=a=64:isNaN(n)&&(a=64),l=l+this._keyStr.charAt(r)+this._keyStr.charAt(o)+this._keyStr.charAt(s)+this._keyStr.charAt(a);return l},decode:function(t){var e,i,n,r,o,s,a,l="",u=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");u<t.length;)r=this._keyStr.indexOf(t.charAt(u++)),o=this._keyStr.indexOf(t.charAt(u++)),s=this._keyStr.indexOf(t.charAt(u++)),a=this._keyStr.indexOf(t.charAt(u++)),e=r<<2|o>>4,i=(15&o)<<4|s>>2,n=(3&s)<<6|a,l+=String.fromCharCode(e),64!=s&&(l+=String.fromCharCode(i)),64!=a&&(l+=String.fromCharCode(n));return l=Base64._utf8_decode(l)},_utf8_encode:function(t){t=t.replace(/\r\n/g,"\n");for(var e="",i=0;i<t.length;i++){var n=t.charCodeAt(i);128>n?e+=String.fromCharCode(n):n>127&&2048>n?(e+=String.fromCharCode(n>>6|192),e+=String.fromCharCode(63&n|128)):(e+=String.fromCharCode(n>>12|224),e+=String.fromCharCode(n>>6&63|128),e+=String.fromCharCode(63&n|128))}return e},_utf8_decode:function(t){for(var e="",i=0,n=c1=c2=0;i<t.length;)n=t.charCodeAt(i),128>n?(e+=String.fromCharCode(n),i++):n>191&&224>n?(c2=t.charCodeAt(i+1),e+=String.fromCharCode((31&n)<<6|63&c2),i+=2):(c2=t.charCodeAt(i+1),c3=t.charCodeAt(i+2),e+=String.fromCharCode((15&n)<<12|(63&c2)<<6|63&c3),i+=3);return e}};!function(t){function e(t,e){for(var i=t.length;i--;)if(t[i]===e)return i;return-1}function i(t,e){if(t.length!=e.length)return!1;for(var i=0;i<t.length;i++)if(t[i]!==e[i])return!1;return!0}function n(t){for(y in S)S[y]=t[C[y]]}function r(t){var i,r,o,s,l,u;if(i=t.keyCode,-1==e(O,i)&&O.push(i),(93==i||224==i)&&(i=91),i in S){S[i]=!0;for(o in _)_[o]==i&&(a[o]=!0)}else if(n(t),a.filter.call(this,t)&&i in w)for(u=p(),s=0;s<w[i].length;s++)if(r=w[i][s],r.scope==u||"all"==r.scope){l=r.mods.length>0;for(o in S)(!S[o]&&e(r.mods,+o)>-1||S[o]&&-1==e(r.mods,+o))&&(l=!1);(0!=r.mods.length||S[16]||S[18]||S[17]||S[91])&&!l||r.method(t,r)===!1&&(t.preventDefault?t.preventDefault():t.returnValue=!1,t.stopPropagation&&t.stopPropagation(),t.cancelBubble&&(t.cancelBubble=!0))}}function o(t){var i,n=t.keyCode,r=e(O,n);if(r>=0&&O.splice(r,1),(93==n||224==n)&&(n=91),n in S){S[n]=!1;for(i in _)_[i]==n&&(a[i]=!1)}}function s(){for(y in S)S[y]=!1;for(y in _)a[y]=!1}function a(t,e,i){var n,r;n=m(t),void 0===i&&(i=e,e="all");for(var o=0;o<n.length;o++)r=[],t=n[o].split("+"),t.length>1&&(r=g(t),t=[t[t.length-1]]),t=t[0],t=E(t),t in w||(w[t]=[]),w[t].push({shortcut:n[o],scope:e,method:i,key:n[o],mods:r})}function l(t,e){var n,r,o,s,a,l=[];for(n=m(t),s=0;s<n.length;s++){if(r=n[s].split("+"),r.length>1&&(l=g(r),t=r[r.length-1]),t=E(t),void 0===e&&(e=p()),!w[t])return;for(o in w[t])a=w[t][o],a.scope===e&&i(a.mods,l)&&(w[t][o]={})}}function u(t){return"string"==typeof t&&(t=E(t)),-1!=e(O,t)}function c(){return O.slice(0)}function h(t){var e=(t.target||t.srcElement).tagName;return!("INPUT"==e||"SELECT"==e||"TEXTAREA"==e)}function d(t){x=t||"all"}function p(){return x||"all"}function f(t){var e,i,n;for(e in w)for(i=w[e],n=0;n<i.length;)i[n].scope===t?i.splice(n,1):n++}function m(t){var e;return t=t.replace(/\s/g,""),e=t.split(","),""==e[e.length-1]&&(e[e.length-2]+=","),e}function g(t){for(var e=t.slice(0,t.length-1),i=0;i<e.length;i++)e[i]=_[e[i]];return e}function b(t,e,i){t.addEventListener?t.addEventListener(e,i,!1):t.attachEvent&&t.attachEvent("on"+e,function(){i(window.event)})}function v(){var e=t.key;return t.key=T,e}var y,w={},S={16:!1,18:!1,17:!1,91:!1},x="all",_={"":16,shift:16,"":18,alt:18,option:18,"":17,ctrl:17,control:17,"":91,command:91},A={backspace:8,tab:9,clear:12,enter:13,"return":13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,"delete":46,home:36,end:35,pageup:33,pagedown:34,plus:107,equals:61,minus:173,",":188,".":190,"/":191,"`":192,"-":189,"=":187,";":186,"'":222,"[":219,"]":221,"\\":220},E=function(t){return A[t]||t.toUpperCase().charCodeAt(0)},O=[];for(y=1;20>y;y++)A["f"+y]=111+y;var C={16:"shiftKey",18:"altKey",17:"ctrlKey",91:"metaKey"};for(y in _)a[y]=!1;b(document,"keydown",function(t){r(t)}),b(document,"keyup",o),b(window,"focus",s);var T=t.key;t.key=a,t.key.setScope=d,t.key.getScope=p,t.key.deleteScope=f,t.key.filter=h,t.key.isPressed=u,t.key.getPressedKeyCodes=c,t.key.noConflict=v,t.key.unbind=l,"undefined"!=typeof module&&(module.exports=key)}(this),window.util||(util={});var EventMap={mousemove:"mousemove",mousedown:"mousedown",mouseup:"mouseup"};if(Array.prototype.swap=function(t,e){var i=this[t];this[t]=this[e],this[e]=i},util.each=function(t,e,i){util.assert(!util.isNullOrUndefined(t),"array must be defined");for(var n=0;n<t.length;++n)e.call(i,t[n],n)},util.map_each=function(t,e,i){util.assert(!util.isNullOrUndefined(t),"map must be defined");for(var n in t)e.call(i,n,t[n])},util.find=function(t,e,i){for(var n=0;n<t.length;++n)if(e.call(i,t[n],n))return n;return-1},util.findAll=function(t,e,i){for(var n=[],r=0;r<t.length;++r)e.call(i,t[r],r)&&n.push(t[r]);return n},util.array=function(t){for(var e=[],i=t.length;--i>=0;)e[i]=t[i];return e},util.isEmpty=function(t){for(var e in t)return!1;return!0},util.stopEventPropagation=function(t){if("stopPropagation"in t)t.stopPropagation();else{if(!("cancelBubble"in t))throw Error("Browser unrecognized");t.cancelBubble=!0}},util.preventDefault=function(t){return"preventDefault"in t&&t.preventDefault(),Prototype.Browser.IE&&(t.returnValue=!1,t.keyCode=0),!1},util.setElementTextContent=function(t,e){if("textContent"in t)t.textContent=e;else{if(!("innerText"in t))throw Error("Browser unrecognized");t.innerText=e}},util.getElementTextContent=function(t){if("textContent"in t)return t.textContent;if("innerText"in t)return t.innerText;throw Error("Browser unrecognized")},util.stringPadded=function(t,e,i){t+="";for(var n="";t.length+n.length<e;)n+=" ";return i?t+n:n+t},util.idList=function(t){var e=[];for(var i in t)e.push(i);return e},util.mapArray=function(t,e){for(var i=[],n=0;n<t.length;++n)i.push(e[t[n]]);return i},util.arrayMax=function(t){return Math.max.apply(Math,t)},util.arrayMin=function(t){return Math.min.apply(Math,t)},util.map=function(t,e,i){for(var n=[],r=0;r<t.length;++r)n.push(e.call(i,t[r]));return n},util.apply=function(t,e){for(var i=0;i<t.length;++i)t[i]=e(t[i])},util.ifDef=function(t,e,i,n){t[i]=Object.isUndefined(e[i])?n:e[i]},util.ifDefList=function(t,e,i,n){t[i]=Object.isUndefined(e[i])||null===e[i]?n:util.array(e[i])},util.identityMap=function(t){for(var e={},i=0;i<t.length;++i)e[t[i]]=t[i];return e},util.strip=function(t){return t.replace(/\s*$/,"").replace(/^\s*/,"")},util.stripRight=function(t){return t.replace(/\s*$/,"")},util.stripQuotes=function(t){return'"'===t[0]&&'"'===t[t.length-1]?t.substr(1,t.length-2):t},util.paddedFloat=function(t,e,i){var n=t.toFixed(i).replace(",",".");if(n.length>e)throw new Error("number does not fit");return util.stringPadded(n,e)},util.paddedInt=function(t,e){var i=t.toFixed(0);if(i.length>e)throw new Error("number does not fit");return util.stringPadded(i,e)},util.arrayAddIfMissing=function(t,e){for(var i=0;i<t.length;++i)if(t[i]===e)return!1;return t.push(e),!0},util.assert=function(t,e){if(!t)throw new Error(e?"Assertion failed: "+e:"Assertion failed")},util.isUndefined=function(t){return Object.isUndefined(t)},util.isNull=function(t){return null===t},util.isNullOrUndefined=function(t){return util.isUndefined(t)||util.isNull(t)},util.arrayRemoveByValue=function(t,e){util.assert(!util.isUndefined(t)&&!util.isNull(t),"array must be defined");for(var i=t.indexOf(e),n=0;i>=0;)t.splice(i,1),n+=1,i=t.indexOf(e);return n},util.listNextRotate=function(t,e){return t[(t.indexOf(e)+1)%t.length]},window.util||(util={}),util.assertDefined=function(t){util.assert(!util.isNullOrUndefined(t))},util.Vec2=function(t,e){if(0==arguments.length)this.x=0,this.y=0;else if(1==arguments.length)this.x=parseFloat(t.x),this.y=parseFloat(t.y);else{if(2!=arguments.length)throw"util.Vec2(): invalid arguments";this.x=parseFloat(t),this.y=parseFloat(e)}},util.Vec2.ZERO=new util.Vec2(0,0),util.Vec2.UNIT=new util.Vec2(1,1),util.Vec2.segmentIntersection=function(t,e,i,n){var r=(t.x-i.x)*(e.y-i.y)-(t.y-i.y)*(e.x-i.x),o=(t.x-n.x)*(e.y-n.y)-(t.y-n.y)*(e.x-n.x),s=(i.x-t.x)*(n.y-t.y)-(i.y-t.y)*(n.x-t.x),a=(i.x-e.x)*(n.y-e.y)-(i.y-e.y)*(n.x-e.x);return 0>=r*o&&0>=s*a},util.Vec2.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},util.Vec2.prototype.equals=function(t){return util.assertDefined(t),this.x==t.x&&this.y==t.y},util.Vec2.prototype.add=function(t){return util.assertDefined(t),new util.Vec2(this.x+t.x,this.y+t.y)},util.Vec2.prototype.add_=function(t){util.assertDefined(t),this.x+=t.x,this.y+=t.y},util.Vec2.prototype.sub=function(t){return util.assertDefined(t),new util.Vec2(this.x-t.x,this.y-t.y)},util.Vec2.prototype.scaled=function(t){return util.assertDefined(t),new util.Vec2(this.x*t,this.y*t)},util.Vec2.prototype.negated=function(){return new util.Vec2(-this.x,-this.y)},util.Vec2.prototype.yComplement=function(t){return t=t||0,new util.Vec2(this.x,t-this.y)},util.Vec2.prototype.addScaled=function(t,e){return util.assertDefined(t),util.assertDefined(e),new util.Vec2(this.x+t.x*e,this.y+t.y*e)},util.Vec2.prototype.normalized=function(){return this.scaled(1/this.length())},util.Vec2.prototype.normalize=function(){var t=this.length();return 1e-6>t?!1:(this.x/=t,this.y/=t,!0)},util.Vec2.prototype.turnLeft=function(){return new util.Vec2(-this.y,this.x)},util.Vec2.prototype.coordStr=function(){return this.x.toString()+" , "+this.y.toString()},util.Vec2.prototype.toString=function(){return"("+this.x.toFixed(2)+","+this.y.toFixed(2)+")"},util.Vec2.dist=function(t,e){return util.assertDefined(t),util.assertDefined(e),util.Vec2.diff(t,e).length()},util.Vec2.max=function(t,e){return util.assertDefined(t),util.assertDefined(e),new util.Vec2(Math.max(t.x,e.x),Math.max(t.y,e.y))},util.Vec2.min=function(t,e){return util.assertDefined(t),util.assertDefined(e),new util.Vec2(Math.min(t.x,e.x),Math.min(t.y,e.y))},util.Vec2.prototype.max=function(t){return util.assertDefined(t),new util.Vec2.max(this,t)},util.Vec2.prototype.min=function(t){return util.assertDefined(t),new util.Vec2.min(this,t)},util.Vec2.prototype.ceil=function(){return new util.Vec2(Math.ceil(this.x),Math.ceil(this.y))},util.Vec2.prototype.floor=function(){return new util.Vec2(Math.floor(this.x),Math.floor(this.y))},util.Vec2.sum=function(t,e){return util.assertDefined(t),util.assertDefined(e),new util.Vec2(t.x+e.x,t.y+e.y)},util.Vec2.dot=function(t,e){return util.assertDefined(t),util.assertDefined(e),t.x*e.x+t.y*e.y},util.Vec2.cross=function(t,e){return util.assertDefined(t),util.assertDefined(e),t.x*e.y-t.y*e.x},util.Vec2.prototype.rotate=function(t){util.assertDefined(t);var e=Math.sin(t),i=Math.cos(t);return this.rotateSC(e,i)},util.Vec2.prototype.rotateSC=function(t,e){return util.assertDefined(t),util.assertDefined(e),new util.Vec2(this.x*e-this.y*t,this.x*t+this.y*e)},util.Vec2.angle=function(t,e){return util.assertDefined(t),util.assertDefined(e),Math.atan2(util.Vec2.cross(t,e),util.Vec2.dot(t,e))},util.Vec2.prototype.oxAngle=function(){return Math.atan2(this.y,this.x)},util.Vec2.diff=function(t,e){return util.assertDefined(t),util.assertDefined(e),new util.Vec2(t.x-e.x,t.y-e.y)},util.Vec2.lc=function(){for(var t=new util.Vec2,e=0;e<arguments.length/2;++e)t=t.addScaled(arguments[2*e],arguments[2*e+1]);return t},util.Vec2.lc2=function(t,e,i,n){return util.assertDefined(t),util.assertDefined(i),util.assertDefined(e),util.assertDefined(n),new util.Vec2(t.x*e+i.x*n,t.y*e+i.y*n)},util.Vec2.centre=function(t,e){return new util.Vec2.lc2(t,.5,e,.5)},util.Box2Abs=function(){1==arguments.length&&"min"in arguments[0]&&"max"in arguments[0]&&(this.p0=arguments[0].min,this.p1=arguments[0].max),2==arguments.length&&arguments[0]instanceof util.Vec2&&arguments[1]instanceof util.Vec2?(this.p0=arguments[0],this.p1=arguments[1]):4==arguments.length?(this.p0=new util.Vec2(arguments[0],arguments[1]),this.p1=new util.Vec2(arguments[2],arguments[3])):0==arguments.length?(this.p0=new util.Vec2,this.p1=new util.Vec2):new Error("util.Box2Abs constructor only accepts 4 numbers or 2 vectors or no arguments!")},util.Box2Abs.prototype.toString=function(){return this.p0.toString()+" "+this.p1.toString()},util.Box2Abs.fromRelBox=function(t){return util.assertDefined(t),new util.Box2Abs(t.x,t.y,t.x+t.width,t.y+t.height)},util.Box2Abs.prototype.clone=function(){return new util.Box2Abs(this.p0,this.p1)},util.Box2Abs.union=function(t,e){return util.assertDefined(t),util.assertDefined(e),new util.Box2Abs(util.Vec2.min(t.p0,e.p0),util.Vec2.max(t.p1,e.p1))},util.Box2Abs.prototype.extend=function(t,e){return util.assertDefined(t),e=e||t,new util.Box2Abs(this.p0.sub(t),this.p1.add(e))},util.Box2Abs.prototype.include=function(t){return util.assertDefined(t),new util.Box2Abs(this.p0.min(t),this.p1.max(t))},util.Box2Abs.prototype.contains=function(t,e){return e=(e||0)-0,util.assertDefined(t),t.x>=this.p0.x-e&&t.x<=this.p1.x+e&&t.y>=this.p0.y-e&&t.y<=this.p1.y+e},util.Box2Abs.prototype.translate=function(t){return util.assertDefined(t),new util.Box2Abs(this.p0.add(t),this.p1.add(t))},util.Box2Abs.prototype.transform=function(t,e){return util.assert(!util.isNullOrUndefined(t)),new util.Box2Abs(t.call(e,this.p0),t.call(e,this.p1))},util.Box2Abs.prototype.sz=function(){return this.p1.sub(this.p0)},util.Box2Abs.prototype.centre=function(){return util.Vec2.centre(this.p0,this.p1)},util.Box2Abs.prototype.pos=function(){return this.p0},util.Vec2.shiftRayBox=function(t,e,i){util.assertDefined(t),util.assertDefined(e),util.assertDefined(i);var n=[i.p0,new util.Vec2(i.p1.x,i.p0.y),i.p1,new util.Vec2(i.p0.x,i.p1.y)],r=n.map(function(e){return e.sub(t)});e=e.normalized();for(var o=r.map(function(t){return util.Vec2.cross(t,e)}),s=r.map(function(t){return util.Vec2.dot(t,e)}),a=-1,l=-1,u=0;4>u;++u)o[u]>0?(0>a||s[a]<s[u])&&(a=u):(0>l||s[l]<s[u])&&(l=u);if(0>l||0>a)return 0;var c,h;return s[a]>s[l]?(c=l,h=a):(c=a,h=l),s[c]+Math.abs(o[c])*(s[h]-s[c])/(Math.abs(o[c])+Math.abs(o[h]))},window.util||(util={}),util.Set={empty:function(){return{}},single:function(t){var e={};return util.Set.add(e,t),e},size:function(t){var e=0;for(var i in t)t[i]!==Object.prototype[i]&&e++;return e},contains:function(t,e){return"undefined"!=typeof t[e]&&t[e]!==Object.prototype[e]},subset:function(t,e){for(var i in t)if(t[i]!==Object.prototype[i]&&e[i]!==t[i])return!1;return!0},intersection:function(t,e){var i={};for(var n in t)t[n]!==Object.prototype[n]&&e[n]===t[n]&&util.Set.add(i,n);return i},disjoint:function(t,e){for(var i in t)if(t[i]!==Object.prototype[i]&&e[i]===t[i])return!1;return!0},eq:function(t,e){return util.Set.subset(t,e)&&util.Set.subset(e,t)},each:function(t,e,i){for(var n in t)t[n]!==Object.prototype[n]&&e.call(i,t[n])},filter:function(t,e,i){var n={};for(var r in t)t[r]!==Object.prototype[r]&&e.call(i,t[r])&&(n[t[r]]=t[r]);return n},pick:function(t){
for(var e in t)if(t[e]!==Object.prototype[e])return t[e];return null},list:function(t){var e=[];for(var i in t)t[i]!==Object.prototype[i]&&e.push(t[i]);return e},add:function(t,e){t[e]=e},mergeIn:function(t,e){util.Set.each(e,function(e){util.Set.add(t,e)})},remove:function(t,e){var i=t[e];return delete t[e],i},clone:function(t){var e={};return util.Set.mergeIn(e,t),e},fromList:function(t){var e={};if(t)for(var i=0;i<t.length;++i)e[t[i]-0]=t[i]-0;return e},keySetInt:function(t){var e={};return t.each(function(t){e[t-0]=t-0}),e},find:function(t,e,i){for(var n in t)if(t[n]!==Object.prototype[n]&&e.call(i,t[n]))return n;return null}},window.util||(util={}),util.Map=function(t){if("undefined"!=typeof t&&t.constructor!==Object)throw Error("Passed object is not an instance of 'Object'!");this._obj=t||{},this._count=0},util.Map.prototype.each=function(t,e){for(var i in this._obj){var n=parseInt(i),r=this._obj[i];isNaN(n)||(i=n),t.call(e,i,r)}},util.Map.prototype.map=function(t,e){var i=new util.Map;return this.each(function(n,r){i.set(n,t.call(e,n,r))},this),i},util.Map.prototype.find=function(t,e){for(var i in this._obj){var n=parseInt(i),r=this._obj[i];if(isNaN(n)||(i=n),t.call(e,i,r))return i}},util.Map.prototype.findAll=function(t,e){var i=[];for(var n in this._obj){var r=parseInt(n),o=this._obj[n];isNaN(r)||(n=r),t.call(e,n,o)&&i.push(n)}return i},util.Map.prototype.keys=function(){var t=[];for(var e in this._obj)t.push(e);return t},util.Map.prototype.ikeys=function(){var t=[];for(var e in this._obj)t.push(e-0);return t},util.Map.prototype.set=function(t,e){if(this._count+=("undefined"!=typeof e?1:0)-("undefined"!=typeof this._obj[t]?1:0),"undefined"==typeof e){var i=this._obj[t];return delete this._obj[t],i}return this._obj[t]=e},util.Map.prototype.get=function(t){return this._obj[t]!==Object.prototype[t]?this._obj[t]:void 0},util.Map.prototype.has=function(t){return this._obj[t]!==Object.prototype[t]},util.Map.prototype.unset=function(t){return this.set(t,void 0)},util.Map.prototype.update=function(t){for(var e in t)this.set(e,t[e])},util.Map.prototype.clear=function(){this._obj={},this._count=0},util.Map.prototype.count=function(){return this._count},util.Map.prototype.idList=function(){return util.idList(this._obj)},util.Map.prototype.keyOf=function(t){for(var e in this._obj)if(this._obj[e]===t)return e},!window.util||!util.Map)throw new Error("Map should be defined first");if(util.Pool=function(){this._map=new util.Map,this._nextId=0},util.Pool.prototype.newId=function(){return this._nextId++},util.Pool.prototype.add=function(t){var e=this._nextId++;return this._map.set(e,t),e},util.Pool.prototype.set=function(t,e){this._map.set(t,e)},util.Pool.prototype.get=function(t){return this._map.get(t)},util.Pool.prototype.has=function(t){return this._map.has(t)},util.Pool.prototype.remove=function(t){return this._map.unset(t)},util.Pool.prototype.clear=function(){this._map.clear()},util.Pool.prototype.keys=function(){return this._map.keys()},util.Pool.prototype.ikeys=function(){return this._map.ikeys()},util.Pool.prototype.each=function(t,e){this._map.each(t,e)},util.Pool.prototype.map=function(t,e){return this._map.map(t,e)},util.Pool.prototype.find=function(t,e){return this._map.find(t,e)},util.Pool.prototype.count=function(){return this._map.count()},util.Pool.prototype.keyOf=function(t){return this._map.keyOf(t)},!window.util||!util.Vec2)throw new Error("Vec2 should be defined first");if(window.chem||(chem={}),chem.Element=function(t,e,i,n,r,o,s){this.label=t,this.period=e,this.group=i,this.putHydrogenOnTheLeft=n,this.color=r||"#000000",this.labelColor=rgbToHex(rgbRescale(hexToRGB(this.color),150)),this.xpos=s||i,this.ypos=o||e;var a=("0x"+this.color.substring(1,3)-0)/255,l=("0x"+this.color.substring(3,5)-0)/255,u=("0x"+this.color.substring(5,7)-0)/255,c=.299*a+.587*l+.114*u;c>.6&&(a*=.6/c,l*=.6/c,u*=.6/c),a=Math.ceil(Math.min(255*a,255)).toString(16),l=Math.ceil(Math.min(255*l,255)).toString(16),u=Math.ceil(Math.min(255*u,255)).toString(16),a=1==a.length?"0"+a:a,l=1==l.length?"0"+l:l,u=1==u.length?"0"+u:u,this.color="#"+a+l+u},chem.Element.elements=new util.Map({1:new chem.Element("H",1,1,!1,"#000000",1,1),2:new chem.Element("He",1,8,!1,"#d9ffff",1,18),3:new chem.Element("Li",2,1,!1,"#cc80ff",2,1),4:new chem.Element("Be",2,2,!1,"#c2ff00",2,2),5:new chem.Element("B",2,3,!1,"#ffb5b5",2,13),6:new chem.Element("C",2,4,!1,"#000000",2,14),7:new chem.Element("N",2,5,!1,"#304ff7",2,15),8:new chem.Element("O",2,6,!0,"#ff0d0d",2,16),9:new chem.Element("F",2,7,!0,"#8fe04f",2,17),10:new chem.Element("Ne",2,8,!1,"#b3e3f5",2,18),11:new chem.Element("Na",3,1,!1,"#ab5cf2",3,1),12:new chem.Element("Mg",3,2,!1,"#8aff00",3,2),13:new chem.Element("Al",3,3,!1,"#bfa6a6",3,13),14:new chem.Element("Si",3,4,!1,"#f0c7a1",3,14),15:new chem.Element("P",3,5,!1,"#ff8000",3,15),16:new chem.Element("S",3,6,!0,"#d9a61a",3,16),17:new chem.Element("Cl",3,7,!0,"#1fd01f",3,17),18:new chem.Element("Ar",3,8,!1,"#80d1e3",3,18),19:new chem.Element("K",4,1,!1,"#8f40d4",4,1),20:new chem.Element("Ca",4,2,!1,"#3dff00",4,2),21:new chem.Element("Sc",4,3,!1,"#e6e6e6",4,3),22:new chem.Element("Ti",4,4,!1,"#bfc2c7",4,4),23:new chem.Element("V",4,5,!1,"#a6a6ab",4,5),24:new chem.Element("Cr",4,6,!1,"#8a99c7",4,6),25:new chem.Element("Mn",4,7,!1,"#9c7ac7",4,7),26:new chem.Element("Fe",4,8,!1,"#e06633",4,8),27:new chem.Element("Co",4,8,!1,"#f08fa1",4,9),28:new chem.Element("Ni",4,8,!1,"#4fd14f",4,10),29:new chem.Element("Cu",4,1,!1,"#c78033",4,11),30:new chem.Element("Zn",4,2,!1,"#7d80b0",4,12),31:new chem.Element("Ga",4,3,!1,"#c28f8f",4,13),32:new chem.Element("Ge",4,4,!1,"#668f8f",4,14),33:new chem.Element("As",4,5,!1,"#bd80e3",4,15),34:new chem.Element("Se",4,6,!0,"#ffa100",4,16),35:new chem.Element("Br",4,7,!0,"#a62929",4,17),36:new chem.Element("Kr",4,8,!1,"#5cb8d1",4,18),37:new chem.Element("Rb",5,1,!1,"#702eb0",5,1),38:new chem.Element("Sr",5,2,!1,"#00ff00",5,2),39:new chem.Element("Y",5,3,!1,"#94ffff",5,3),40:new chem.Element("Zr",5,4,!1,"#94e0e0",5,4),41:new chem.Element("Nb",5,5,!1,"#73c2c9",5,5),42:new chem.Element("Mo",5,6,!1,"#54b5b5",5,6),43:new chem.Element("Tc",5,7,!1,"#3b9e9e",5,7),44:new chem.Element("Ru",5,8,!1,"#248f8f",5,8),45:new chem.Element("Rh",5,8,!1,"#0a7d8c",5,9),46:new chem.Element("Pd",5,8,!1,"#006985",5,10),47:new chem.Element("Ag",5,1,!1,"#bfbfbf",5,11),48:new chem.Element("Cd",5,2,!1,"#ffd98f",5,12),49:new chem.Element("In",5,3,!1,"#a67573",5,13),50:new chem.Element("Sn",5,4,!1,"#668080",5,14),51:new chem.Element("Sb",5,5,!1,"#9e63b5",5,15),52:new chem.Element("Te",5,6,!1,"#d47a00",5,16),53:new chem.Element("I",5,7,!0,"#940094",5,17),54:new chem.Element("Xe",5,8,!1,"#429eb0",5,18),55:new chem.Element("Cs",6,1,!1,"#57178f",6,1),56:new chem.Element("Ba",6,2,!1,"#00c900",6,2),57:new chem.Element("La",6,3,!1,"#70d4ff",6,3),58:new chem.Element("Ce",6,3,!1,"#ffffc7",8,4),59:new chem.Element("Pr",6,3,!1,"#d9ffc7",8,5),60:new chem.Element("Nd",6,3,!1,"#c7ffc7",8,6),61:new chem.Element("Pm",6,3,!1,"#a3ffc7",8,7),62:new chem.Element("Sm",6,3,!1,"#8fffc7",8,8),63:new chem.Element("Eu",6,3,!1,"#61ffc7",8,9),64:new chem.Element("Gd",6,3,!1,"#45ffc7",8,10),65:new chem.Element("Tb",6,3,!1,"#30ffc7",8,11),66:new chem.Element("Dy",6,3,!1,"#1fffc7",8,12),67:new chem.Element("Ho",6,3,!1,"#00ff9c",8,13),68:new chem.Element("Er",6,3,!1,"#00e675",8,14),69:new chem.Element("Tm",6,3,!1,"#00d452",8,15),70:new chem.Element("Yb",6,3,!1,"#00bf38",8,16),71:new chem.Element("Lu",6,3,!1,"#00ab24",8,17),72:new chem.Element("Hf",6,4,!1,"#4dc2ff",6,4),73:new chem.Element("Ta",6,5,!1,"#4da6ff",6,5),74:new chem.Element("W",6,6,!1,"#2194d6",6,6),75:new chem.Element("Re",6,7,!1,"#267dab",6,7),76:new chem.Element("Os",6,8,!1,"#266696",6,8),77:new chem.Element("Ir",6,8,!1,"#175487",6,9),78:new chem.Element("Pt",6,8,!1,"#d1d1e0",6,10),79:new chem.Element("Au",6,1,!1,"#ffd124",6,11),80:new chem.Element("Hg",6,2,!1,"#b8b8d1",6,12),81:new chem.Element("Tl",6,3,!1,"#a6544d",6,13),82:new chem.Element("Pb",6,4,!1,"#575961",6,14),83:new chem.Element("Bi",6,5,!1,"#9e4fb5",6,15),84:new chem.Element("Po",6,6,!1,"#ab5c00",6,16),85:new chem.Element("At",6,7,!1,"#754f45",6,17),86:new chem.Element("Rn",6,8,!1,"#428296",6,18),87:new chem.Element("Fr",7,1,!1,"#420066",7,1),88:new chem.Element("Ra",7,2,!1,"#007d00",7,2),89:new chem.Element("Ac",7,3,!1,"#70abfa",7,3),90:new chem.Element("Th",7,3,!1,"#00baff",9,4),91:new chem.Element("Pa",7,3,!1,"#00a1ff",9,5),92:new chem.Element("U",7,3,!1,"#008fff",9,6),93:new chem.Element("Np",7,3,!1,"#0080ff",9,7),94:new chem.Element("Pu",7,3,!1,"#006bff",9,8),95:new chem.Element("Am",7,3,!1,"#545cf2",9,9),96:new chem.Element("Cm",7,3,!1,"#785ce3",9,10),97:new chem.Element("Bk",7,3,!1,"#8a4fe3",9,11),98:new chem.Element("Cf",7,3,!1,"#a136d4",9,12),99:new chem.Element("Es",7,3,!1,"#b31fd4",9,13),100:new chem.Element("Fm",7,3,!1,"#000000",9,14),101:new chem.Element("Md",7,3,!1,"#000000",9,15),102:new chem.Element("No",7,3,!1,"#000000",9,16),103:new chem.Element("Lr",7,3,!1,"#000000",9,17),104:new chem.Element("Rf",7,4,!1,"#4dc2ff",7,4),105:new chem.Element("Db",7,5,!1,"#4da6ff",7,5),106:new chem.Element("Sg",7,6,!1,"#2194d6",7,6),107:new chem.Element("Bh",7,7,!1,"#267dab",7,7),108:new chem.Element("Hs",7,8,!1,"#266696",7,8),109:new chem.Element("Mt",7,8,!1,"#175487",7,9),110:new chem.Element("Ds",7,8,!1,"#d1d1e0",7,10),111:new chem.Element("Rg",7,1,!1,"#ffd124",7,11),112:new chem.Element("Cn",7,2,!1,"#b8b8d1",7,12)}),chem.Element.labelMap=null,chem.Element.getElementByLabel=function(t){return this.labelMap||(this.labelMap={},this.elements.each(function(t,e){this.labelMap[e.label]=t-0},this)),this.labelMap.hasOwnProperty(t)?this.labelMap[t]:null},!window.chem||!util.Vec2||!util.Pool)throw new Error("Vec2, Pool should be defined first");if(chem.Struct=function(){this.atoms=new util.Pool,this.bonds=new util.Pool,this.sgroups=new util.Pool,this.halfBonds=new util.Map,this.loops=new util.Pool,this.isChiral=!1,this.isReaction=!1,this.rxnArrows=new util.Pool,this.rxnPluses=new util.Pool,this.frags=new util.Pool,this.rgroups=new util.Map,this.name="",this.sGroupForest=new chem.SGroupForest(this)},chem.Struct.prototype.hasRxnProps=function(){return this.atoms.find(function(t,e){return e.hasRxnProps()},this)>=0||this.bonds.find(function(t,e){return e.hasRxnProps()},this)>=0},chem.Struct.prototype.hasRxnArrow=function(){return this.rxnArrows.count()>0},chem.Struct.prototype.addRxnArrowIfNecessary=function(){var t=!this.hasRxnArrow()&&this.hasRxnProps();return t&&this.rxnArrows.add(new chem.Struct.RxnArrow),t},chem.Struct.prototype.getSGroupsInAtomSet=function(t){var e=new Hash;util.each(t,function(t){var i=util.Set.list(this.atoms.get(t).sgs);i.each(function(t){var i=e.get(t);Object.isUndefined(i)?i=1:i++,e.set(t,i)},this)},this);var i=[];return e.each(function(t){var e=parseInt(t.key),n=this.sgroups.get(e),r=chem.SGroup.getAtoms(this,n);t.value==r.length&&i.push(e)},this),i},chem.Struct.prototype.isBlank=function(){return 0==this.atoms.count()&&0==this.rxnArrows.count()&&0==this.rxnPluses.count()&&!this.isChiral},chem.Struct.prototype.toLists=function(){var t={},e=[];this.atoms.each(function(i,n){t[i]=e.length,e.push(n)});var i=[];return this.bonds.each(function(e,n){var r=new chem.Struct.Bond(n);r.begin=t[n.begin],r.end=t[n.end],i.push(r)}),{atoms:e,bonds:i}},chem.Struct.prototype.clone=function(t,e,i,n){var r=new chem.Struct;return this.mergeInto(r,t,e,i,!1,n)},chem.Struct.prototype.getScaffold=function(){var t=util.Set.empty();return this.atoms.each(function(e){util.Set.add(t,e)},this),this.rgroups.each(function(e,i){i.frags.each(function(e,i){this.atoms.each(function(e,n){n.fragment==i&&util.Set.remove(t,e)},this)},this)},this),this.clone(t)},chem.Struct.prototype.getFragmentIds=function(t){var e=util.Set.empty();return this.atoms.each(function(i,n){n.fragment==t&&util.Set.add(e,i)},this),e},chem.Struct.prototype.getFragment=function(t){return this.clone(this.getFragmentIds(t))},chem.Struct.prototype.mergeInto=function(t,e,i,n,r,o){e=e||util.Set.keySetInt(this.atoms),i=i||util.Set.keySetInt(this.bonds),i=util.Set.filter(i,function(t){var i=this.bonds.get(t);return util.Set.contains(e,i.begin)&&util.Set.contains(e,i.end)},this);var s={};this.atoms.each(function(t,i){util.Set.contains(e,t)&&(s[i.fragment]=1)});var a={};this.frags.each(function(e,i){s[e]&&(a[e]=t.frags.add(i.clone()))}),this.rgroups.each(function(e,i){var n=r;if(n||(i.frags.each(function(t,e){s[e]&&(n=!0)}),n)){var o=t.rgroups.get(e);o?i.frags.each(function(t,e){s[e]&&o.frags.add(a[e])}):t.rgroups.set(e,i.clone(a))}}),("undefined"==typeof o||null===o)&&(o={}),this.atoms.each(function(i,n){util.Set.contains(e,i)&&(o[i]=t.atoms.add(n.clone(a)))});var l={};return this.bonds.each(function(e,n){util.Set.contains(i,e)&&(l[e]=t.bonds.add(n.clone(o)))}),this.sgroups.each(function(i,n){var r;for(r=0;r<n.atoms.length;++r)if(!util.Set.contains(e,n.atoms[r]))return;n=chem.SGroup.clone(n,o,l);var s=t.sgroups.add(n);for(n.id=s,r=0;r<n.atoms.length;++r)util.Set.add(t.atoms.get(n.atoms[r]).sgs,s);t.sGroupForest.insert(n.id)}),t.isChiral=this.isChiral,n||(t.isReaction=this.isReaction,this.rxnArrows.each(function(e,i){t.rxnArrows.add(i.clone())}),this.rxnPluses.each(function(e,i){t.rxnPluses.add(i.clone())})),t},chem.Struct.prototype.findBondId=function(t,e){var i=-1;return this.bonds.find(function(n,r){return r.begin==t&&r.end==e||r.begin==e&&r.end==t?(i=n,!0):!1},this),i},chem.Struct.ATOM={RADICAL:{NONE:0,SINGLET:1,DOUPLET:2,TRIPLET:3}},chem.Struct.radicalElectrons=function(t){if(t-=0,t==chem.Struct.ATOM.RADICAL.NONE)return 0;if(t==chem.Struct.ATOM.RADICAL.DOUPLET)return 1;if(t==chem.Struct.ATOM.RADICAL.SINGLET||t==chem.Struct.ATOM.RADICAL.TRIPLET)return 2;throw new Error("Unknown radical value")},chem.Struct.BOND={TYPE:{SINGLE:1,DOUBLE:2,TRIPLE:3,AROMATIC:4,SINGLE_OR_DOUBLE:5,SINGLE_OR_AROMATIC:6,DOUBLE_OR_AROMATIC:7,ANY:8},STEREO:{NONE:0,UP:1,EITHER:4,DOWN:6,CIS_TRANS:3},TOPOLOGY:{EITHER:0,RING:1,CHAIN:2},REACTING_CENTER:{NOT_CENTER:-1,UNMARKED:0,CENTER:1,UNCHANGED:2,MADE_OR_BROKEN:4,ORDER_CHANGED:8,MADE_OR_BROKEN_AND_CHANGED:12}},chem.Struct.FRAGMENT={NONE:0,REACTANT:1,PRODUCT:2,AGENT:3},chem.Struct.Atom=function(t){var e=chem.Struct.Atom.attrGetDefault;if(!(t&&"label"in t))throw new Error("label must be specified!");this.label=t.label,this.fragment=Object.isUndefined(t.fragment)?-1:t.fragment,util.ifDef(this,t,"isotope",e("isotope")),util.ifDef(this,t,"radical",e("radical")),util.ifDef(this,t,"charge",e("charge")),util.ifDef(this,t,"rglabel",e("rglabel")),util.ifDef(this,t,"attpnt",e("attpnt")),util.ifDef(this,t,"explicitValence",e("explicitValence")),this.valence=0,this.implicitH=0,Object.isUndefined(t.pp)?this.pp=new util.Vec2:this.pp=new util.Vec2(t.pp),this.sgs={},util.ifDef(this,t,"ringBondCount",e("ringBondCount")),util.ifDef(this,t,"substitutionCount",e("substitutionCount")),util.ifDef(this,t,"unsaturatedAtom",e("unsaturatedAtom")),util.ifDef(this,t,"hCount",e("hCount")),util.ifDef(this,t,"aam",e("aam")),util.ifDef(this,t,"invRet",e("invRet")),util.ifDef(this,t,"exactChangeFlag",e("exactChangeFlag")),util.ifDef(this,t,"rxnFragmentType",-1),this.atomList=Object.isUndefined(t.atomList)||null==t.atomList?null:new chem.Struct.AtomList(t.atomList),this.neighbors=[],this.badConn=!1},chem.Struct.Atom.getAttrHash=function(t){var e=new Hash;for(var i in chem.Struct.Atom.attrlist)"undefined"!=typeof t[i]&&e.set(i,t[i]);return e},chem.Struct.Atom.attrGetDefault=function(t){if(t in chem.Struct.Atom.attrlist)return chem.Struct.Atom.attrlist[t];throw new Error("Attribute unknown")},chem.Struct.Atom.attrlist={label:"C",isotope:0,radical:0,charge:0,explicitValence:-1,ringBondCount:0,substitutionCount:0,unsaturatedAtom:0,hCount:0,atomList:null,invRet:0,exactChangeFlag:0,rglabel:null,attpnt:null,aam:0},chem.Struct.Atom.prototype.clone=function(t){var e=new chem.Struct.Atom(this);return t&&this.fragment in t&&(e.fragment=t[this.fragment]),e},chem.Struct.Atom.prototype.isQuery=function(){return null!=this.atomList||"A"==this.label||this.attpnt||this.hCount},chem.Struct.Atom.prototype.pureHydrogen=function(){return"H"==this.label&&0==this.isotope},chem.Struct.Atom.prototype.isPlainCarbon=function(){return"C"==this.label&&0==this.isotope&&0==this.radical&&0==this.charge&&this.explicitValence<0&&0==this.ringBondCount&&0==this.substitutionCount&&0==this.unsaturatedAtom&&0==this.hCount&&!this.atomList},chem.Struct.Atom.prototype.isPseudo=function(){return!this.atomList&&!this.rglabel&&!chem.Element.getElementByLabel(this.label)},chem.Struct.Atom.prototype.hasRxnProps=function(){return!(!this.invRet&&!this.exactChangeFlag&&util.isNull(this.attpnt)&&!this.aam)},chem.Struct.AtomList=function(t){if(!(t&&"notList"in t&&"ids"in t))throw new Error("'notList' and 'ids' must be specified!");this.notList=t.notList,this.ids=t.ids},chem.Struct.AtomList.prototype.labelList=function(){for(var t=[],e=0;e<this.ids.length;++e)t.push(chem.Element.elements.get(this.ids[e]).label);return t},chem.Struct.AtomList.prototype.label=function(){var t="["+this.labelList().join(",")+"]";return this.notList&&(t="!"+t),t},chem.Struct.AtomList.prototype.equals=function(t){return this.notList==t.notList&&(this.ids||[]).sort().toString()==(t.ids||[]).sort().toString()},chem.Struct.Bond=function(t){if(!(t&&"begin"in t&&"end"in t&&"type"in t))throw new Error("'begin', 'end' and 'type' properties must be specified!");this.begin=t.begin,this.end=t.end,this.type=t.type,util.ifDef(this,t,"stereo",chem.Struct.BOND.STEREO.NONE),util.ifDef(this,t,"topology",chem.Struct.BOND.TOPOLOGY.EITHER),util.ifDef(this,t,"reactingCenterStatus",0),this.hb1=null,this.hb2=null,this.len=0,this.center=new util.Vec2,this.sb=0,this.sa=0,this.angle=0},chem.Struct.Bond.attrlist={type:chem.Struct.BOND.TYPE.SINGLE,stereo:chem.Struct.BOND.STEREO.NONE,topology:chem.Struct.BOND.TOPOLOGY.EITHER,reactingCenterStatus:0},chem.Struct.Bond.getAttrHash=function(t){var e=new Hash;for(var i in chem.Struct.Bond.attrlist)"undefined"!=typeof t[i]&&e.set(i,t[i]);return e},chem.Struct.Bond.attrGetDefault=function(t){if(t in chem.Struct.Bond.attrlist)return chem.Struct.Bond.attrlist[t];throw new Error("Attribute unknown")},chem.Struct.Bond.prototype.hasRxnProps=function(){return!!this.reactingCenterStatus},chem.Struct.Bond.prototype.getCenter=function(t){var e=t.atoms.get(this.begin).pp,i=t.atoms.get(this.end).pp;return util.Vec2.lc2(e,.5,i,.5)},chem.Struct.Bond.prototype.getDir=function(t){var e=t.atoms.get(this.begin).pp,i=t.atoms.get(this.end).pp;return i.sub(e).normalized()},chem.Struct.Bond.prototype.clone=function(t){var e=new chem.Struct.Bond(this);return t&&(e.begin=t[e.begin],e.end=t[e.end]),e},chem.Struct.Bond.prototype.findOtherEnd=function(t){if(t==this.begin)return this.end;if(t==this.end)return this.begin;throw new Error("bond end not found")},chem.HalfBond=function(t,e,i){if(3!=arguments.length)throw new Error("Invalid parameter number!");this.begin=t-0,this.end=e-0,this.bid=i-0,this.dir=new util.Vec2,this.norm=new util.Vec2,this.ang=0,this.p=new util.Vec2,this.loop=-1,this.contra=-1,this.next=-1,this.leftSin=0,this.leftCos=0,this.leftNeighbor=0,this.rightSin=0,this.rightCos=0,this.rightNeighbor=0},chem.Struct.prototype.initNeighbors=function(){this.atoms.each(function(t,e){e.neighbors=[]}),this.bonds.each(function(t,e){var i=this.atoms.get(e.begin),n=this.atoms.get(e.end);i.neighbors.push(e.hb1),n.neighbors.push(e.hb2)},this)},chem.Struct.prototype.bondInitHalfBonds=function(t,e){e=e||this.bonds.get(t),e.hb1=2*t,e.hb2=2*t+1,this.halfBonds.set(e.hb1,new chem.HalfBond(e.begin,e.end,t)),this.halfBonds.set(e.hb2,new chem.HalfBond(e.end,e.begin,t));var i=this.halfBonds.get(e.hb1),n=this.halfBonds.get(e.hb2);i.contra=e.hb2,n.contra=e.hb1},chem.Struct.prototype.halfBondUpdate=function(t){var e=this.halfBonds.get(t),i=this.atoms.get(e.begin).pp,n=this.atoms.get(e.end).pp,r=util.Vec2.diff(n,i).normalized();e.dir=util.Vec2.dist(n,i)>1e-4?r:new util.Vec2(1,0),e.norm=e.dir.turnLeft(),e.ang=e.dir.oxAngle(),e.loop<0&&(e.loop=-1)},chem.Struct.prototype.initHalfBonds=function(){this.halfBonds.clear(),this.bonds.each(this.bondInitHalfBonds,this)},chem.Struct.prototype.setHbNext=function(t,e){this.halfBonds.get(this.halfBonds.get(t).contra).next=e},chem.Struct.prototype.halfBondSetAngle=function(t,e){var i=this.halfBonds.get(t),n=this.halfBonds.get(e);n.rightCos=i.leftCos=util.Vec2.dot(n.dir,i.dir),n.rightSin=i.leftSin=util.Vec2.cross(n.dir,i.dir),i.leftNeighbor=e,n.rightNeighbor=t},chem.Struct.prototype.atomAddNeighbor=function(t){var e=this.halfBonds.get(t),i=this.atoms.get(e.begin),n=0;for(n=0;n<i.neighbors.length&&!(this.halfBonds.get(i.neighbors[n]).ang>e.ang);++n);i.neighbors.splice(n,0,t);var r=i.neighbors[(n+1)%i.neighbors.length],o=i.neighbors[(n+i.neighbors.length-1)%i.neighbors.length];this.setHbNext(o,t),this.setHbNext(t,r),this.halfBondSetAngle(t,o),this.halfBondSetAngle(r,t)},chem.Struct.prototype.atomSortNeighbors=function(t){var e=this.atoms.get(t);e.neighbors=e.neighbors.sortBy(function(t){return this.halfBonds.get(t).ang},this);var i;for(i=0;i<e.neighbors.length;++i)this.halfBonds.get(this.halfBonds.get(e.neighbors[i]).contra).next=e.neighbors[(i+1)%e.neighbors.length];for(i=0;i<e.neighbors.length;++i)this.halfBondSetAngle(e.neighbors[(i+1)%e.neighbors.length],e.neighbors[i])},chem.Struct.prototype.sortNeighbors=function(t){util.each(t,function(t){this.atomSortNeighbors(t)},this)},chem.Struct.prototype.atomUpdateHalfBonds=function(t){for(var e=this.atoms.get(t).neighbors,i=0;i<e.length;++i){var n=e[i];this.halfBondUpdate(n),this.halfBondUpdate(this.halfBonds.get(n).contra)}},chem.Struct.prototype.updateHalfBonds=function(t){util.each(t,function(t){this.atomUpdateHalfBonds(t)},this)},chem.Struct.prototype.sGroupsRecalcCrossBonds=function(){this.sgroups.each(function(t,e){e.xBonds=[],e.neiAtoms=[]},this),this.bonds.each(function(t,e){var i=this.atoms.get(e.begin),n=this.atoms.get(e.end);util.Set.each(i.sgs,function(i){if(!util.Set.contains(n.sgs,i)){var r=this.sgroups.get(i);r.xBonds.push(t),util.arrayAddIfMissing(r.neiAtoms,e.end)}},this),util.Set.each(n.sgs,function(n){if(!util.Set.contains(i.sgs,n)){var r=this.sgroups.get(n);r.xBonds.push(t),util.arrayAddIfMissing(r.neiAtoms,e.begin)}},this)},this)},chem.Struct.prototype.sGroupDelete=function(t){for(var e=this.sgroups.get(t),i=0;i<e.atoms.length;++i)util.Set.remove(this.atoms.get(e.atoms[i]).sgs,t);this.sGroupForest.remove(t),this.sgroups.remove(t)},chem.Struct.itemSetPos=function(t,e){t.pp=e},chem.Struct.prototype._itemSetPos=function(t,e,i,n){chem.Struct.itemSetPos(this[t].get(e),i,n)},chem.Struct.prototype._atomSetPos=function(t,e,i){this._itemSetPos("atoms",t,e,i)},chem.Struct.prototype._rxnPlusSetPos=function(t,e,i){this._itemSetPos("rxnPluses",t,e,i)},chem.Struct.prototype._rxnArrowSetPos=function(t,e,i){this._itemSetPos("rxnArrows",t,e,i)},chem.Struct.prototype.getCoordBoundingBox=function(t){var e=null,i=function(t){e?(e.min=util.Vec2.min(e.min,t),e.max=util.Vec2.max(e.max,t)):e={min:t,max:t}},n="undefined"==typeof t;return this.atoms.each(function(e,r){(n||util.Set.contains(t,e))&&i(r.pp)}),n&&(this.rxnPluses.each(function(t,e){i(e.pp)}),this.rxnArrows.each(function(t,e){i(e.pp)})),!e&&n&&(e={min:new util.Vec2(0,0),max:new util.Vec2(1,1)}),e},chem.Struct.prototype.getCoordBoundingBoxObj=function(){var t=null,e=function(e){t?(t.min=util.Vec2.min(t.min,e),t.max=util.Vec2.max(t.max,e)):t={min:new util.Vec2(e),max:new util.Vec2(e)}};return this.atoms.each(function(t,i){e(i.pp)}),t},chem.Struct.prototype.getBondLengthData=function(){var t=0,e=0;return this.bonds.each(function(i,n){t+=util.Vec2.dist(this.atoms.get(n.begin).pp,this.atoms.get(n.end).pp),e++},this),{cnt:e,totalLength:t}},chem.Struct.prototype.getAvgBondLength=function(){var t=this.getBondLengthData();return t.cnt>0?t.totalLength/t.cnt:-1},chem.Struct.prototype.getAvgClosestAtomDistance=function(){var t,e,i,n=0,r=0,o=this.atoms.keys();for(e=0;e<o.length;++e){for(t=-1,i=0;i<o.length;++i)i!=e&&(r=util.Vec2.dist(this.atoms.get(o[i]).pp,this.atoms.get(o[e]).pp),(0>t||t>r)&&(t=r));n+=t}return o.length>0?n/o.length:-1},chem.Struct.prototype.checkBondExists=function(t,e){var i=!1;return this.bonds.each(function(n,r){(r.begin==t&&r.end==e||r.end==t&&r.begin==e)&&(i=!0)},this),i},chem.Loop=function(t,e,i){this.hbs=t,this.dblBonds=0,this.aromatic=!0,this.convex=i||!1,t.each(function(t){var i=e.bonds.get(e.halfBonds.get(t).bid);i.type!=chem.Struct.BOND.TYPE.AROMATIC&&(this.aromatic=!1),i.type==chem.Struct.BOND.TYPE.DOUBLE&&this.dblBonds++},this)},chem.Struct.RxnPlus=function(t){t=t||{},this.pp=t.pp?new util.Vec2(t.pp):new util.Vec2},chem.Struct.RxnPlus.prototype.clone=function(){return new chem.Struct.RxnPlus(this)},chem.Struct.RxnArrow=function(t){t=t||{},this.pp=t.pp?new util.Vec2(t.pp):new util.Vec2},chem.Struct.RxnArrow.prototype.clone=function(){return new chem.Struct.RxnArrow(this)},chem.Struct.prototype.findConnectedComponent=function(t){for(var e={},i=[t],n=util.Set.empty();i.length>0;)(function(){var t=i.pop();e[t]=1,util.Set.add(n,t);for(var r=this.atoms.get(t),o=0;o<r.neighbors.length;++o){var s=this.halfBonds.get(r.neighbors[o]).end;util.Set.contains(n,s)||i.push(s)}}).apply(this);return n},chem.Struct.prototype.findConnectedComponents=function(t){this.halfBonds.count()||(this.initHalfBonds(),this.initNeighbors(),this.updateHalfBonds(this.atoms.keys()),this.sortNeighbors(this.atoms.keys()));var e={};this.atoms.each(function(t,i){e[t]=-1},this);var i=[];return this.atoms.each(function(n,r){if((t||r.fragment<0)&&e[n]<0){var o=this.findConnectedComponent(n);i.push(o),util.Set.each(o,function(t){e[t]=1},this)}},this),i},chem.Struct.prototype.markFragment=function(t){var e=this.frags.add(new chem.Struct.Fragment);util.Set.each(t,function(t){this.atoms.get(t).fragment=e},this)},chem.Struct.prototype.markFragmentByAtomId=function(t){this.markFragment(this.findConnectedComponent(t))},chem.Struct.prototype.markFragments=function(){for(var t=this.findConnectedComponents(),e=0;e<t.length;++e)this.markFragment(t[e])},chem.Struct.Fragment=function(){},chem.Struct.Fragment.prototype.clone=function(){return Object.clone(this)},chem.Struct.Fragment.getAtoms=function(t,e){var i=[];return t.atoms.each(function(t,n){n.fragment==e&&i.push(t)},this),i},chem.Struct.RGroup=function(t){t=t||{},this.frags=new util.Pool,this.resth=t.resth||!1,this.range=t.range||"",this.ifthen=t.ifthen||0},chem.Struct.RGroup.prototype.getAttrs=function(){return{resth:this.resth,range:this.range,ifthen:this.ifthen}},chem.Struct.RGroup.findRGroupByFragment=function(t,e){var i;return t.each(function(t,n){Object.isUndefined(n.frags.keyOf(e))||(i=t)}),i},chem.Struct.RGroup.prototype.clone=function(t){var e=new chem.Struct.RGroup(this);return this.frags.each(function(i,n){e.frags.add(t?t[n]:n)}),e},chem.Struct.prototype.scale=function(t){1!=t&&(this.atoms.each(function(e,i){i.pp=i.pp.scaled(t)},this),this.rxnPluses.each(function(e,i){i.pp=i.pp.scaled(t)},this),this.rxnArrows.each(function(e,i){i.pp=i.pp.scaled(t)},this),this.sgroups.each(function(e,i){i.pp=i.pp?i.pp.scaled(t):null},this))},chem.Struct.prototype.rescale=function(){var t=this.getAvgBondLength();0>t&&!this.isReaction&&(t=this.getAvgClosestAtomDistance()),.001>t&&(t=1);var e=1/t;this.scale(e)},chem.Struct.prototype.loopHasSelfIntersections=function(t){for(var e=0;e<t.length;++e)for(var i=this.halfBonds.get(t[e]),n=this.atoms.get(i.begin).pp,r=this.atoms.get(i.end).pp,o=util.Set.fromList([i.begin,i.end]),s=e+2;s<t.length;++s){var a=this.halfBonds.get(t[s]);if(!util.Set.contains(o,a.begin)&&!util.Set.contains(o,a.end)){var l=this.atoms.get(a.begin).pp,u=this.atoms.get(a.end).pp;if(util.Vec2.segmentIntersection(n,r,l,u))return!0}}return!1},chem.Struct.prototype.partitionLoop=function(t){var e=[],i=!0;t:for(;i;){for(var n={},r=0;r<t.length;++r){var o=t[r],s=this.halfBonds.get(o).begin,a=this.halfBonds.get(o).end;if(a in n){var l=n[a],u=t.slice(l,r+1);e.push(u),r<t.length&&t.splice(l,r-l+1);continue t}n[s]=r}i=!1,e.push(t)}return e},chem.Struct.prototype.halfBondAngle=function(t,e){var i=this.halfBonds.get(t),n=this.halfBonds.get(e);return Math.atan2(util.Vec2.cross(i.dir,n.dir),util.Vec2.dot(i.dir,n.dir))},chem.Struct.prototype.loopIsConvex=function(t){for(var e=0;e<t.length;++e){var i=this.halfBondAngle(t[e],t[(e+1)%t.length]);if(i>0)return!1}return!0},chem.Struct.prototype.loopIsInner=function(t){for(var e=2*Math.PI,i=0;i<t.length;++i){var n=t[i],r=t[(i+1)%t.length],o=this.halfBonds.get(r),s=this.halfBondAngle(n,r);e+=o.contra==t[i]?Math.PI:s}return Math.abs(e)<Math.PI},chem.Struct.prototype.findLoops=function(){var t,e,i,n,r=[],o=util.Set.empty();return this.halfBonds.each(function(s,a){if(-1==a.loop)for(t=s,e=0,i=[];e<=this.halfBonds.count();t=this.halfBonds.get(t).next,++e){if(e>0&&t==s){var l=this.partitionLoop(i);util.each(l,function(t){this.loopIsInner(t)&&!this.loopHasSelfIntersections(t)?(n=util.arrayMin(t),this.loops.set(n,new chem.Loop(t,this,this.loopIsConvex(t)))):n=-2,t.each(function(t){this.halfBonds.get(t).loop=n,util.Set.add(o,this.halfBonds.get(t).bid)},this),n>=0&&r.push(n)},this);break}i.push(t)}},this),{newLoops:r,bondsToMark:util.Set.list(o)}},chem.Struct.prototype.prepareLoopStructure=function(){this.initHalfBonds(),this.initNeighbors(),this.updateHalfBonds(this.atoms.keys()),this.sortNeighbors(this.atoms.keys()),this.findLoops()},chem.Struct.prototype.atomAddToSGroup=function(t,e){chem.SGroup.addAtom(this.sgroups.get(t),e),util.Set.add(this.atoms.get(e).sgs,t)},!window.chem||!util.Vec2||!chem.Struct)throw new Error("Vec2 and Molecule should be defined first");if(chem.Molfile=function(){},chem.Molfile.loadRGroupFragments=!0,chem.Molfile.parseDecimalInt=function(t){var e=parseInt(t,10);return isNaN(e)?0:e},chem.Molfile.partitionLine=function(t,e,i){for(var n=[],r=0,o=0;r<e.length;++r)n.push(t.slice(o,o+e[r])),i&&o++,o+=e[r];return n},chem.Molfile.partitionLineFixed=function(t,e,i){for(var n=[],r=0;r<t.length;r+=e)n.push(t.slice(r,r+e)),i&&r++;return n},chem.Molfile.parseCTFile=function(t){var e=null;return e=0==t[0].search("\\$RXN")?chem.Molfile.parseRxn(t):chem.Molfile.parseMol(t),e.initHalfBonds(),e.initNeighbors(),e.markFragments(),e},chem.Molfile.fmtInfo={bondTypeMap:{1:chem.Struct.BOND.TYPE.SINGLE,2:chem.Struct.BOND.TYPE.DOUBLE,3:chem.Struct.BOND.TYPE.TRIPLE,4:chem.Struct.BOND.TYPE.AROMATIC,5:chem.Struct.BOND.TYPE.SINGLE_OR_DOUBLE,6:chem.Struct.BOND.TYPE.SINGLE_OR_AROMATIC,7:chem.Struct.BOND.TYPE.DOUBLE_OR_AROMATIC,8:chem.Struct.BOND.TYPE.ANY},bondStereoMap:{0:chem.Struct.BOND.STEREO.NONE,1:chem.Struct.BOND.STEREO.UP,4:chem.Struct.BOND.STEREO.EITHER,6:chem.Struct.BOND.STEREO.DOWN,3:chem.Struct.BOND.STEREO.CIS_TRANS},v30bondStereoMap:{0:chem.Struct.BOND.STEREO.NONE,1:chem.Struct.BOND.STEREO.UP,2:chem.Struct.BOND.STEREO.EITHER,3:chem.Struct.BOND.STEREO.DOWN},bondTopologyMap:{0:chem.Struct.BOND.TOPOLOGY.EITHER,1:chem.Struct.BOND.TOPOLOGY.RING,2:chem.Struct.BOND.TOPOLOGY.CHAIN},countsLinePartition:[3,3,3,3,3,3,3,3,3,3,3,6],atomLinePartition:[10,10,10,1,3,2,3,3,3,3,3,3,3,3,3,3,3],bondLinePartition:[3,3,3,3,3,3,3],atomListHeaderPartition:[3,1,1,4,1,1],atomListHeaderLength:11,atomListHeaderItemLength:4,chargeMap:[0,3,2,1,0,-1,-2,-3],valenceMap:[void 0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,0],implicitHydrogenMap:[void 0,0,1,2,3,4],v30atomPropMap:{CHG:"charge",RAD:"radical",MASS:"isotope",VAL:"explicitValence",HCOUNT:"hCount",INVRET:"invRet",SUBST:"substitutionCount",UNSAT:"unsaturatedAtom",RBCNT:"ringBondCount"},rxnItemsPartition:[3,3,3]},chem.Molfile.parseAtomLine=function(t){var e=chem.Molfile,i=e.partitionLine(t,e.fmtInfo.atomLinePartition),n={pp:new util.Vec2(parseFloat(i[0]),-parseFloat(i[1])),label:i[4].strip(),explicitValence:e.fmtInfo.valenceMap[e.parseDecimalInt(i[10])],massDifference:e.parseDecimalInt(i[5]),charge:e.fmtInfo.chargeMap[e.parseDecimalInt(i[6])],hCount:e.parseDecimalInt(e.parseDecimalInt(i[8])),stereoCare:0!=e.parseDecimalInt(i[9]),aam:e.parseDecimalInt(i[14]),invRet:e.parseDecimalInt(i[15]),exactChangeFlag:0!=e.parseDecimalInt(i[16])
};return new chem.Struct.Atom(n)},chem.Molfile.stripV30=function(t){if("M  V30 "!=t.slice(0,7))throw Error("Prefix invalid");return t.slice(7)},chem.Molfile.parseAtomLineV3000=function(t){var e,i,n,r,o,s=chem.Molfile;e=s.spaceparsplit(t);var a={pp:new util.Vec2(parseFloat(e[2]),-parseFloat(e[3])),aam:e[5].strip()},l=e[1].strip();if('"'==l.charAt(0)&&'"'==l.charAt(l.length-1)&&(l=l.substr(1,l.length-2)),"]"==l.charAt(l.length-1)){l=l.substr(0,l.length-1);var u={};if(u.notList=!1,"NOT ["==l.substr(0,5))u.notList=!0,l=l.substr(5);else{if("["!=l.charAt(0))throw"Error: atom list expected, found '"+l+"'";l=l.substr(1)}u.ids=s.labelsListToIds(l.split(",")),a.atomList=new chem.Struct.AtomList(u),a.label="L#"}else a.label=l;for(e.splice(0,6),o=0;o<e.length;++o)if(i=s.splitonce(e[o],"="),n=i[0],r=i[1],n in s.fmtInfo.v30atomPropMap){var c=s.parseDecimalInt(r);if("VAL"==n){if(0==c)continue;-1==c&&(c=0)}a[s.fmtInfo.v30atomPropMap[n]]=c}else if("RGROUPS"==n){r=r.strip().substr(1,r.length-2);var h=r.split(" ").slice(1);a.rglabel=0;for(var d=0;d<h.length;++d)a.rglabel|=1<<h[d]-1}else"ATTCHPT"==n&&(a.attpnt=r.strip()-0);return new chem.Struct.Atom(a)},chem.Molfile.parseBondLineV3000=function(t){var e,i,n,r,o,s=chem.Molfile;e=s.spaceparsplit(t);var a={begin:s.parseDecimalInt(e[2])-1,end:s.parseDecimalInt(e[3])-1,type:s.fmtInfo.bondTypeMap[s.parseDecimalInt(e[1])]};for(e.splice(0,4),o=0;o<e.length;++o)i=s.splitonce(e[o],"="),n=i[0],r=i[1],"CFG"==n?(a.stereo=s.fmtInfo.v30bondStereoMap[s.parseDecimalInt(r)],a.type==chem.Struct.BOND.TYPE.DOUBLE&&a.stereo==chem.Struct.BOND.STEREO.EITHER&&(a.stereo=chem.Struct.BOND.STEREO.CIS_TRANS)):"TOPO"==n?a.topology=s.fmtInfo.bondTopologyMap[s.parseDecimalInt(r)]:"RXCTR"==n?a.reactingCenterStatus=s.parseDecimalInt(r):"STBOX"==n&&(a.stereoCare=s.parseDecimalInt(r));return new chem.Struct.Bond(a)},chem.Molfile.parseBondLine=function(t){var e=chem.Molfile,i=e.partitionLine(t,e.fmtInfo.bondLinePartition),n={begin:e.parseDecimalInt(i[0])-1,end:e.parseDecimalInt(i[1])-1,type:e.fmtInfo.bondTypeMap[e.parseDecimalInt(i[2])],stereo:e.fmtInfo.bondStereoMap[e.parseDecimalInt(i[3])],topology:e.fmtInfo.bondTopologyMap[e.parseDecimalInt(i[5])],reactingCenterStatus:e.parseDecimalInt(i[6])};return new chem.Struct.Bond(n)},chem.Molfile.parseAtomListLine=function(t){for(var e=chem.Molfile,i=e.partitionLine(t,e.fmtInfo.atomListHeaderPartition),n=e.parseDecimalInt(i[0])-1,r="T"==i[2].strip(),o=e.parseDecimalInt(i[4].strip()),s=t.slice(e.fmtInfo.atomListHeaderLength),a=[],l=e.fmtInfo.atomListHeaderItemLength,u=0;o>u;++u)a[u]=e.parseDecimalInt(s.slice(u*l,(u+1)*l-1));return{aid:n,atomList:new chem.Struct.AtomList({notList:r,ids:a})}},chem.Molfile.readKeyValuePairs=function(t,e){for(var i=chem.Molfile,n={},r=i.partitionLineFixed(t,3,!0),o=i.parseDecimalInt(r[0]),s=0;o>s;++s)n[i.parseDecimalInt(r[2*s+1])-1]=e?r[2*s+2].strip():i.parseDecimalInt(r[2*s+2]);return n},chem.Molfile.readKeyMultiValuePairs=function(t,e){for(var i=chem.Molfile,n=[],r=i.partitionLineFixed(t,3,!0),o=i.parseDecimalInt(r[0]),s=0;o>s;++s)n.push([i.parseDecimalInt(r[2*s+1])-1,e?r[2*s+2].strip():i.parseDecimalInt(r[2*s+2])]);return n},chem.Molfile.labelsListToIds=function(t){for(var e=[],i=0;i<t.length;++i)e.push(chem.Element.getElementByLabel(t[i].strip()));return e},chem.Molfile.parsePropertyLineAtomList=function(t,e){var i=chem.Molfile,n=i.parseDecimalInt(t[1])-1,r=i.parseDecimalInt(t[2]),o="T"==t[4].strip(),s=i.labelsListToIds(e.slice(0,r)),a={};return a[n]=new chem.Struct.AtomList({notList:o,ids:s}),a},chem.Molfile.initSGroup=function(t,e){var i=chem.Molfile,n=i.readKeyValuePairs(e,!0);for(var r in n){var o=n[r];if(!(o in chem.SGroup.TYPES))throw new Error("Unsupported S-group type");var s=new chem.SGroup(o);s.number=r,t[r]=s}},chem.Molfile.applySGroupProp=function(t,e,i,n,r){var o=chem.Molfile,s=o.readKeyValuePairs(i,!n);for(var a in s)(r?t[a]:t[a].data)[e]=s[a]},chem.Molfile.toIntArray=function(t){for(var e=chem.Molfile,i=[],n=0;n<t.length;++n)i[n]=e.parseDecimalInt(t[n]);return i},chem.Molfile.applySGroupArrayProp=function(t,e,i,n){var r=chem.Molfile,o=r.parseDecimalInt(i.slice(1,4))-1,s=r.parseDecimalInt(i.slice(4,8)),a=r.toIntArray(r.partitionLineFixed(i.slice(8),3,!0));if(a.length!=s)throw new Error("File format invalid");n&&util.apply(a,function(t){return t+n}),t[o][e]=t[o][e].concat(a)},chem.Molfile.applyDataSGroupName=function(t,e){t.data.fieldName=e},chem.Molfile.applyDataSGroupQuery=function(t,e){t.data.query=e},chem.Molfile.applyDataSGroupQueryOp=function(t,e){t.data.queryOp=e},chem.Molfile.applyDataSGroupDesc=function(t,e){var i=chem.Molfile,n=i.partitionLine(e,[4,31,2,20,2,3],!1),r=i.parseDecimalInt(n[0])-1,o=n[1].strip(),s=n[2].strip(),a=n[3].strip(),l=n[4].strip(),u=n[5].strip(),c=t[r];c.data.fieldType=s,c.data.fieldName=o,c.data.units=a,c.data.query=l,c.data.queryOp=u},chem.Molfile.applyDataSGroupInfo=function(t,e){var i=chem.Molfile,n=i.partitionLine(e,[10,10,4,1,1,1,3,3,3,3,2,3,2],!1),r=parseFloat(n[0]),o=parseFloat(n[1]),s="A"==n[3].strip(),a="A"==n[4].strip(),l="U"==n[5].strip(),u=n[7].strip();u="ALL"==u?-1:i.parseDecimalInt(u);var c=n[10].strip(),h=i.parseDecimalInt(n[11].strip());t.pp=new util.Vec2(r,-o),t.data.attached=s,t.data.absolute=a,t.data.showUnits=l,t.data.nCharsToDisplay=u,t.data.tagChar=c,t.data.daspPos=h},chem.Molfile.applyDataSGroupInfoLine=function(t,e){var i=chem.Molfile,n=i.parseDecimalInt(e.substr(0,4))-1,r=t[n];i.applyDataSGroupInfo(r,e.substr(5))},chem.Molfile.applyDataSGroupData=function(t,e,i){t.data.fieldValue=(t.data.fieldValue||"")+e,i&&(t.data.fieldValue=util.stripRight(t.data.fieldValue),t.data.fieldValue.startsWith('"')&&t.data.fieldValue.endsWith('"')&&(t.data.fieldValue=t.data.fieldValue.substr(1,t.data.fieldValue.length-2)),t.data.fieldValue+="\n")},chem.Molfile.applyDataSGroupDataLine=function(t,e,i){var n=chem.Molfile,r=n.parseDecimalInt(e.substr(0,5))-1,o=e.substr(5),s=t[r];n.applyDataSGroupData(s,o,i)},chem.Molfile.parsePropertyLines=function(t,e,i,n,r,o){for(var s=chem.Molfile,a=new util.Map;n>i;){var l=e[i];if("A"==l.charAt(0))a.get("label")||a.set("label",new util.Map),a.get("label").set(s.parseDecimalInt(l.slice(3,6))-1,e[++i]);else if("M"==l.charAt(0)){var u=l.slice(3,6),c=l.slice(6);if("END"==u)break;if("CHG"==u)a.get("charge")||a.set("charge",new util.Map),a.get("charge").update(s.readKeyValuePairs(c));else if("RAD"==u)a.get("radical")||a.set("radical",new util.Map),a.get("radical").update(s.readKeyValuePairs(c));else if("ISO"==u)a.get("isotope")||a.set("isotope",new util.Map),a.get("isotope").update(s.readKeyValuePairs(c));else if("RBC"==u)a.get("ringBondCount")||a.set("ringBondCount",new util.Map),a.get("ringBondCount").update(s.readKeyValuePairs(c));else if("SUB"==u)a.get("substitutionCount")||a.set("substitutionCount",new util.Map),a.get("substitutionCount").update(s.readKeyValuePairs(c));else if("UNS"==u)a.get("unsaturatedAtom")||a.set("unsaturatedAtom",new util.Map),a.get("unsaturatedAtom").update(s.readKeyValuePairs(c));else if("RGP"==u){a.get("rglabel")||a.set("rglabel",new util.Map);for(var h=a.get("rglabel"),d=s.readKeyMultiValuePairs(c),p=0;p<d.length;p++){var f=d[p];h.set(f[0],(h.get(f[0])||0)|1<<f[1]-1)}}else if("LOG"==u){c=c.slice(4);var m=s.parseDecimalInt(c.slice(0,3).strip()),g=s.parseDecimalInt(c.slice(4,7).strip()),b=s.parseDecimalInt(c.slice(8,11).strip()),v=c.slice(12).strip(),y={};g>0&&(y.ifthen=g),y.resth=1==b,y.range=v,o[m]=y}else if("APO"==u)a.get("attpnt")||a.set("attpnt",new util.Map),a.get("attpnt").update(s.readKeyValuePairs(c));else if("ALS"==u){a.get("atomList")||a.set("atomList",new util.Map);var w=s.parsePropertyLineAtomList(s.partitionLine(c,[1,3,3,1,1,1]),s.partitionLineFixed(c.slice(10),4,!1));a.get("atomList").update(w),a.get("label")||a.set("label",new util.Map);for(var S in w)a.get("label").set(S,"L#")}else if("STY"==u)s.initSGroup(r,c);else if("SST"==u)s.applySGroupProp(r,"subtype",c);else if("SLB"==u)s.applySGroupProp(r,"label",c,!0);else if("SPL"==u)s.applySGroupProp(r,"parent",c,!0,!0);else if("SCN"==u)s.applySGroupProp(r,"connectivity",c);else if("SAL"==u)s.applySGroupArrayProp(r,"atoms",c,-1);else if("SBL"==u)s.applySGroupArrayProp(r,"bonds",c,-1);else if("SPA"==u)s.applySGroupArrayProp(r,"patoms",c,-1);else if("SMT"==u){var x=s.parseDecimalInt(c.slice(0,4))-1;r[x].data.subscript=c.slice(4).strip()}else"SDT"==u?s.applyDataSGroupDesc(r,c):"SDD"==u?s.applyDataSGroupInfoLine(r,c):"SCD"==u?s.applyDataSGroupDataLine(r,c,!1):"SED"==u&&s.applyDataSGroupDataLine(r,c,!0)}++i}return a},chem.Molfile.applyAtomProp=function(t,e,i,n){e.each(function(e,n){t.get(e)[i]=n})},chem.Molfile.parseCTabV2000=function(t,e){var i,n=new chem.Struct,r=chem.Molfile,o=r.parseDecimalInt(e[0]),s=r.parseDecimalInt(e[1]),a=r.parseDecimalInt(e[2]);n.isChiral=0!=r.parseDecimalInt(e[4]);var l=r.parseDecimalInt(e[5]),u=r.parseDecimalInt(e[10]),c=0,h=t.slice(c,c+o);c+=o;var d=t.slice(c,c+s);c+=s;var p=t.slice(c,c+a);c+=a+l;var f=h.map(r.parseAtomLine);for(i=0;i<f.length;++i)n.atoms.add(f[i]);var m=d.map(r.parseBondLine);for(i=0;i<m.length;++i)n.bonds.add(m[i]);var g=p.map(r.parseAtomListLine);g.each(function(t){n.atoms.get(t.aid).atomList=t.atomList,n.atoms.get(t.aid).label="L#"});var b={},v={},y=r.parsePropertyLines(n,t,c,Math.min(t.length,c+u),b,v);y.each(function(t,e){r.applyAtomProp(n.atoms,e,t)});var w,S={};for(w in b){var x=b[w];if("DAT"===x.type&&0===x.atoms.length){var _=b[w].parent;if(_>=0){var A=b[_-1];"GEN"===A.type&&(x.atoms=util.array(A.atoms))}}}for(w in b)chem.SGroup.addGroup(n,b[w],S);var E=[];for(w in b)chem.SGroup.filter(n,b[w],S),0!=b[w].atoms.length||b[w].allAtoms||E.push(w);for(i=0;i<E.length;++i)n.sGroupForest.remove(E[i]),n.sgroups.remove(E[i]);for(var O in v)n.rgroups.set(O,new chem.Struct.RGroup(v[O]));return n},chem.Molfile.spaceparsplit=function(t){var e,i,n=[],r=0,o=-1,s=t.toArray(),a=!1;for(i=0;i<t.length;++i)e=s[i],"("==e?r++:")"==e&&r--,'"'==e&&(a=!a),a||" "!=s[i]||0!=r||(i>o+1&&n.push(t.slice(o+1,i)),o=i);return i>o+1&&n.push(t.slice(o+1,i)),o=i,n},chem.Molfile.splitonce=function(t,e){var i=t.indexOf(e);return[t.slice(0,i),t.slice(i+1)]},chem.Molfile.splitSGroupDef=function(t){for(var e=[],i=0,n=!1,r=0;r<t.length;++r){var o=t.charAt(r);'"'==o?n=!n:n||("("==o?i++:")"==o?i--:" "==o&&0==i&&(e.push(t.slice(0,r)),t=t.slice(r+1).strip(),r=0))}if(0!=i)throw"Brace balance broken. S-group properies invalid!";return t.length>0&&e.push(t.strip()),e},chem.Molfile.parseBracedNumberList=function(t,e){if(!t)return null;var i=[];t=t.strip(),t=t.substr(1,t.length-2);var n=t.split(" ");e=e||0;for(var r=1;r<n.length;++r)i.push(n[r]-0+e);return i},chem.Molfile.v3000parseCollection=function(t,e,i){for(i++;"M  V30 END COLLECTION"!=e[i].strip();)i++;return i++,i},chem.Molfile.v3000parseSGroup=function(t,e,i,n,r){var o=chem.Molfile,s="";for(r++;r<e.length;){if(s=o.stripV30(e[r++]).strip(),"END SGROUP"==s.strip())return r;for(;"-"==s.charAt(s.length-1);)s=(s.substr(0,s.length-1)+o.stripV30(e[r++])).strip();var a=o.splitSGroupDef(s),l=a[1],u=new chem.SGroup(l);u.number=a[0]-0,u.type=l,u.label=a[2]-0,i[u.number]=u;for(var c={},h=3;h<a.length;++h){var d=o.splitonce(a[h],"=");if(2!=d.length)throw"A record of form AAA=BBB or AAA=(...) expected, got '"+a[h]+"'";var p=d[0];p in c||(c[p]=[]),c[p].push(d[1])}u.atoms=o.parseBracedNumberList(c.ATOMS[0],-1),c.PATOMS&&(u.patoms=o.parseBracedNumberList(c.PATOMS[0],-1)),u.bonds=c.BONDS?o.parseBracedNumberList(c.BONDS[0],-1):[];var f=c.BRKXYZ;if(u.brkxyz=[],f)for(var m=0;m<f.length;++m)u.brkxyz.push(o.parseBracedNumberList(f[m]));c.MULT&&(u.data.subscript=c.MULT[0]-0),c.LABEL&&(u.data.subscript=c.LABEL[0].strip()),c.CONNECT&&(u.data.connectivity=c.CONNECT[0].toLowerCase()),c.FIELDDISP&&o.applyDataSGroupInfo(u,util.stripQuotes(c.FIELDDISP[0])),c.FIELDDATA&&o.applyDataSGroupData(u,c.FIELDDATA[0],!0),c.FIELDNAME&&o.applyDataSGroupName(u,c.FIELDNAME[0]),c.QUERYTYPE&&o.applyDataSGroupQuery(u,c.QUERYTYPE[0]),c.QUERYOP&&o.applyDataSGroupQueryOp(u,c.QUERYOP[0]),chem.SGroup.addGroup(t,u,n)}throw new Error("S-group declaration incomplete.")},chem.Molfile.parseCTabV3000=function(t,e){var i=new chem.Struct,n=chem.Molfile,r=0;if("M  V30 BEGIN CTAB"!=t[r++].strip())throw Error("CTAB V3000 invalid");if("M  V30 COUNTS"!=t[r].slice(0,13))throw Error("CTAB V3000 invalid");var o=t[r].slice(14).split(" ");if(i.isChiral=1==n.parseDecimalInt(o[4]),r++,"M  V30 BEGIN ATOM"==t[r].strip()){r++;for(var s;r<t.length&&(s=n.stripV30(t[r++]).strip(),"END ATOM"!=s);){for(;"-"==s.charAt(s.length-1);)s=(s.substring(0,s.length-1)+n.stripV30(t[r++])).strip();i.atoms.add(n.parseAtomLineV3000(s))}if("M  V30 BEGIN BOND"==t[r].strip())for(r++;r<t.length&&(s=n.stripV30(t[r++]).strip(),"END BOND"!=s);){for(;"-"==s.charAt(s.length-1);)s=(s.substring(0,s.length-1)+n.stripV30(t[r++])).strip();i.bonds.add(n.parseBondLineV3000(s))}for(var a={},l={};"M  V30 END CTAB"!=t[r].strip();)if("M  V30 BEGIN COLLECTION"==t[r].strip())r=n.v3000parseCollection(i,t,r);else{if("M  V30 BEGIN SGROUP"!=t[r].strip())throw Error("CTAB V3000 invalid");r=n.v3000parseSGroup(i,t,a,l,r)}}if("M  V30 END CTAB"!=t[r++].strip())throw Error("CTAB V3000 invalid");return e||n.readRGroups3000(i,t.slice(r)),i},chem.Molfile.readRGroups3000=function(t,e){for(var i={},n={},r=0,o=chem.Molfile;r<e.length&&0==e[r].search("M  V30 BEGIN RGROUP");){var s=e[r++].split(" ").pop();for(i[s]=[],n[s]={};;){var a=e[r].strip();if(0!=a.search("M  V30 RLOGIC")){if("M  V30 BEGIN CTAB"!=a)throw Error("CTAB V3000 invalid");for(var l=0;l<e.length&&"M  V30 END CTAB"!=e[r+l].strip();++l);var u=e.slice(r,r+l+1),c=this.parseCTabV3000(u,!0);if(i[s].push(c),r=r+l+1,"M  V30 END RGROUP"==e[r].strip()){r++;break}}else{a=a.slice(13);var h=a.strip().split(/\s+/g),d=o.parseDecimalInt(h[0]),p=o.parseDecimalInt(h[1]),f=h.slice(2).join(" "),m={};d>0&&(m.ifthen=d),m.resth=1==p,m.range=f,n[s]=m,r++}}}for(var g in i)for(var b=0;b<i[g].length;++b){var v=i[g][b];v.rgroups.set(g,new chem.Struct.RGroup(n[g]));var y=v.frags.add(new chem.Struct.Fragment);v.rgroups.get(g).frags.add(y),v.atoms.each(function(t,e){e.fragment=y}),v.mergeInto(t)}},chem.Molfile.parseMol=function(t){if(0==t[0].search("\\$MDL"))return this.parseRg2000(t);var e=this.parseCTab(t.slice(3));return e.name=t[0].strip(),e},chem.Molfile.parseCTab=function(t){var e=chem.Molfile,i=e.partitionLine(t[0],e.fmtInfo.countsLinePartition),n=i[11].strip();if(t=t.slice(1),"V2000"==n)return this.parseCTabV2000(t,i);if("V3000"==n)return this.parseCTabV3000(t,!chem.Molfile.loadRGroupFragments);throw Error("Molfile version unknown: "+n)},chem.MolfileSaver=function(t){this.molecule=null,this.molfile=null,this.v3000=t||!1},chem.MolfileSaver.prototype.prepareSGroups=function(t){var e=this.molecule,i=(e.sgroups,[]);util.each(this.molecule.sGroupForest.getSGroupsBFS().reverse(),function(n){var r=e.sgroups.get(n);try{r.prepareForSaving(e)}catch(o){if(ui.forwardExceptions)throw o;if(!t||"number"!=typeof o.id)throw o;i.push(o.id)}},this),i.length>0&&alert("WARNING: "+i.length.toString()+" invalid S-groups were detected. They will be omitted.");for(var n=0;n<i.length;++n)e.sGroupDelete(i[n]);return e},chem.MolfileSaver.getComponents=function(t){var e=t.findConnectedComponents(!0),i=[],n=null;t.rxnArrows.each(function(t,e){n=e.pp.x}),t.rxnPluses.each(function(t,e){i.push(e.pp.x)}),null!=n&&i.push(n),i.sort(function(t,e){return t-e});var r,o=[];for(r=0;r<e.length;++r){for(var s=t.getCoordBoundingBox(e[r]),a=util.Vec2.lc2(s.min,.5,s.max,.5),l=0;a.x>i[l];)++l;o[l]=o[l]||{},util.Set.mergeIn(o[l],e[r])}var u=[],c=[],h=[];for(r=0;r<o.length;++r)o[r]?(s=t.getCoordBoundingBox(o[r]),a=util.Vec2.lc2(s.min,.5,s.max,.5),a.x<n?c.push(o[r]):h.push(o[r])):u.push("");return{reactants:c,products:h}},chem.MolfileSaver.prototype.getCTab=function(t,e){return this.molecule=t.clone(),this.molfile="",this.writeCTab2000(e),this.molfile},chem.MolfileSaver.prototype.saveMolecule=function(t,e,i){if(this.reaction=t.rxnArrows.count()>0,t.rxnArrows.count()>1)throw new Error("Reaction may not contain more than one arrow");if(this.molfile="",this.reaction){if(t.rgroups.count()>0)throw new Error("Unable to save the structure - reactions with r-groups are not supported at the moment");var n=chem.MolfileSaver.getComponents(t),r=n.reactants,o=n.products,s=r.concat(o);this.molfile="$RXN\n\n\n\n"+util.paddedInt(r.length,3)+util.paddedInt(o.length,3)+util.paddedInt(0,3)+"\n";for(var a=0;a<s.length;++a){var l=new chem.MolfileSaver(!1),u=t.clone(s[a],null,!0),c=l.saveMolecule(u,!1,!0);this.molfile+="$MOL\n"+c}return this.molfile}if(t.rgroups.count()>0){if(!i){var h=new chem.MolfileSaver(!1).getCTab(t.getScaffold(),t.rgroups);return this.molfile="$MDL  REV  1\n$MOL\n$HDR\n\n\n\n$END HDR\n",this.molfile+="$CTAB\n"+h+"$END CTAB\n",t.rgroups.each(function(e,i){this.molfile+="$RGP\n",this.writePaddedNumber(e,3),this.molfile+="\n",i.frags.each(function(e,i){var n=new chem.MolfileSaver(!1).getCTab(t.getFragment(i));this.molfile+="$CTAB\n"+n+"$END CTAB\n"},this),this.molfile+="$END RGP\n"},this),this.molfile+="$END MOL\n",this.molfile}t=t.getScaffold()}return this.molecule=t.clone(),this.prepareSGroups(e),this.writeHeader(),this.writeCTab2000(),this.molfile},chem.MolfileSaver.prototype.writeHeader=function(){var t=new Date;this.writeCR(),this.writeWhiteSpace(2),this.write("Ketcher"),this.writeWhiteSpace(),this.writeCR((t.getMonth()+1).toPaddedString(2)+t.getDate().toPaddedString(2)+(t.getFullYear()%100).toPaddedString(2)+t.getHours().toPaddedString(2)+t.getMinutes().toPaddedString(2)+"2D 1   1.00000     0.00000     0"),this.writeCR()},chem.MolfileSaver.prototype.write=function(t){this.molfile+=t},chem.MolfileSaver.prototype.writeCR=function(t){0==arguments.length&&(t=""),this.molfile+=t+"\n"},chem.MolfileSaver.prototype.writeWhiteSpace=function(t){0==arguments.length&&(t=1),t.times(function(){this.write(" ")},this)},chem.MolfileSaver.prototype.writePadded=function(t,e){this.write(t),this.writeWhiteSpace(e-t.length)},chem.MolfileSaver.prototype.writePaddedNumber=function(t,e){var i=(t-0).toString();this.writeWhiteSpace(e-i.length),this.write(i)},chem.MolfileSaver.prototype.writePaddedFloat=function(t,e,i){this.write(util.paddedFloat(t,e,i))},chem.MolfileSaver.prototype.writeCTab2000Header=function(){this.writePaddedNumber(this.molecule.atoms.count(),3),this.writePaddedNumber(this.molecule.bonds.count(),3),this.writePaddedNumber(0,3),this.writeWhiteSpace(3),this.writePaddedNumber(this.molecule.isChiral?1:0,3),this.writePaddedNumber(0,3),this.writeWhiteSpace(12),this.writePaddedNumber(999,3),this.writeCR(" V2000")},chem.MolfileSaver.prototype.writeCTab2000=function(t){this.writeCTab2000Header(),this.mapping={};var e=1,i=[],n=[];for(this.molecule.atoms.each(function(t,r){this.writePaddedFloat(r.pp.x,10,4),this.writePaddedFloat(-r.pp.y,10,4),this.writePaddedFloat(0,10,4),this.writeWhiteSpace();var o=r.label;null!=r.atomList?(o="L",i.push(t)):null==chem.Element.getElementByLabel(o)&&-1==["A","Q","X","*","R#"].indexOf(o)&&(o="C",n.push(t)),this.writePadded(o,3),this.writePaddedNumber(0,2),this.writePaddedNumber(0,3),this.writePaddedNumber(0,3),Object.isUndefined(r.hCount)&&(r.hCount=0),this.writePaddedNumber(r.hCount,3),Object.isUndefined(r.stereoCare)&&(r.stereoCare=0),this.writePaddedNumber(r.stereoCare,3),this.writePaddedNumber(r.explicitValence<0?0:0==r.explicitValence?15:r.explicitValence,3),this.writePaddedNumber(0,3),this.writePaddedNumber(0,3),this.writePaddedNumber(0,3),Object.isUndefined(r.aam)&&(r.aam=0),this.writePaddedNumber(r.aam,3),Object.isUndefined(r.invRet)&&(r.invRet=0),this.writePaddedNumber(r.invRet,3),Object.isUndefined(r.exactChangeFlag)&&(r.exactChangeFlag=0),this.writePaddedNumber(r.exactChangeFlag,3),this.writeCR(),this.mapping[t]=e,e++},this),this.bondMapping={},e=1,this.molecule.bonds.each(function(t,i){this.bondMapping[t]=e++,this.writePaddedNumber(this.mapping[i.begin],3),this.writePaddedNumber(this.mapping[i.end],3),this.writePaddedNumber(i.type,3),Object.isUndefined(i.stereo)&&(i.stereo=0),this.writePaddedNumber(i.stereo,3),this.writeWhiteSpace(3),Object.isUndefined(i.topology)&&(i.topology=0),this.writePaddedNumber(i.topology,3),Object.isUndefined(i.reactingCenterStatus)&&(i.reactingCenterStatus=0),this.writePaddedNumber(i.reactingCenterStatus,3),this.writeCR()},this);n.length>0;)this.write("A  "),this.writePaddedNumber(n[0]+1,3),this.writeCR(),this.writeCR(this.molecule.atoms.get(n[0]).label),n.splice(0,1);var r=new Array,o=new Array,s=new Array,a=new Array,l=new Array,u=new Array,c=new Array,h=new Array,d=new Array;this.molecule.atoms.each(function(t,e){if(0!=e.charge&&r.push([t,e.charge]),0!=e.isotope&&o.push([t,e.isotope]),0!=e.radical&&s.push([t,e.radical]),null!=e.rglabel&&"R#"==e.label)for(var i=0;32>i;i++)e.rglabel&1<<i&&a.push([t,i+1]);null!=e.attpnt&&u.push([t,e.attpnt]),0!=e.ringBondCount&&c.push([t,e.ringBondCount]),0!=e.substitutionCount&&d.push([t,e.substitutionCount]),0!=e.unsaturatedAtom&&h.push([t,e.unsaturatedAtom])}),t&&t.each(function(t,e){if(e.resth||e.ifthen>0||e.range.length>0){var i="  1 "+util.paddedInt(t,3)+" "+util.paddedInt(e.ifthen,3)+" "+util.paddedInt(e.resth?1:0,3)+"   "+e.range;l.push(i)}});var p=function(t,e){for(;e.length>0;){for(var i=new Array;e.length>0&&i.length<8;)i.push(e[0]),e.splice(0,1);this.write(t),this.writePaddedNumber(i.length,3),i.each(function(t){this.writeWhiteSpace(),this.writePaddedNumber(this.mapping[t[0]],3),this.writeWhiteSpace(),this.writePaddedNumber(t[1],3)},this),this.writeCR()}};p.call(this,"M  CHG",r),p.call(this,"M  ISO",o),p.call(this,"M  RAD",s),p.call(this,"M  RGP",a);for(var f=0;f<l.length;++f)this.write("M  LOG"+l[f]+"\n");if(p.call(this,"M  APO",u),p.call(this,"M  RBC",c),p.call(this,"M  SUB",d),p.call(this,"M  UNS",h),i.length>0)for(f=0;f<i.length;++f){var m=i[f],g=this.molecule.atoms.get(m).atomList;this.write("M  ALS"),this.writePaddedNumber(m+1,4),this.writePaddedNumber(g.ids.length,3),this.writeWhiteSpace(),this.write(g.notList?"T":"F");for(var b=g.labelList(),v=0;v<b.length;++v)this.writeWhiteSpace(),this.writePadded(b[v],3);this.writeCR()}var y={},w=1,S={},x=this.molecule.sGroupForest.getSGroupsBFS();util.each(x,function(t){S[w]=t,y[t]=w++},this);for(var _=1;w>_;++_){var A=S[_],E=this.molecule.sgroups.get(A);this.write("M  STY"),this.writePaddedNumber(1,3),this.writeWhiteSpace(1),this.writePaddedNumber(_,3),this.writeWhiteSpace(1),this.writePadded(E.type,3),this.writeCR(),this.write("M  SLB"),this.writePaddedNumber(1,3),this.writeWhiteSpace(1),this.writePaddedNumber(_,3),this.writeWhiteSpace(1),this.writePaddedNumber(_,3),this.writeCR();var O=this.molecule.sGroupForest.parent.get(A);if(O>=0&&(this.write("M  SPL"),this.writePaddedNumber(1,3),this.writeWhiteSpace(1),this.writePaddedNumber(_,3),this.writeWhiteSpace(1),this.writePaddedNumber(y[O],3),this.writeCR()),"SRU"==E.type&&E.data.connectivity){var C="";C+=" ",C+=util.stringPadded(_.toString(),3),C+=" ",C+=util.stringPadded(E.data.connectivity,3,!0),this.write("M  SCN"),this.writePaddedNumber(1,3),this.write(C.toUpperCase()),this.writeCR()}"SRU"==E.type&&(this.write("M  SMT "),this.writePaddedNumber(_,3),this.writeWhiteSpace(),this.write(E.data.subscript||"n"),this.writeCR()),this.writeCR(E.saveToMolfile(this.molecule,y,this.mapping,this.bondMapping))}this.writeCR("M  END")},chem.Molfile.parseRxn=function(t){var e=chem.Molfile,i=t[0].strip().split(" ");return i.length>1&&"V3000"==i[1]?e.parseRxn3000(t):e.parseRxn2000(t)},chem.Molfile.parseRxn2000=function(t){var e=chem.Molfile;t=t.slice(4);var i=e.partitionLine(t[0],e.fmtInfo.rxnItemsPartition),n=i[0]-0,r=i[1]-0,o=i[2]-0;t=t.slice(1);for(var s=[];t.length>0&&"$MOL"==t[0].substr(0,4);){t=t.slice(1);for(var a=0;a<t.length&&"$MOL"!=t[a].substr(0,4);)a++;s.push(chem.Molfile.parseMol(t.slice(0,a))),t=t.slice(a)}return e.rxnMerge(s,n,r,o)},chem.Molfile.parseRxn3000=function(t){var e=chem.Molfile;t=t.slice(4);for(var i=t[0].split(/\s+/g).slice(3),n=i[0]-0,r=i[1]-0,o=i.length>2?i[2]-0:0,s=function(t){util.assert(t,"CTab format invalid")},a=function(e){for(var i=e;i<t.length;++i)if("M  V30 END CTAB"==t[i].strip())return i;s(!1)},l=function(e){for(var i=e;i<t.length;++i)if("M  V30 END RGROUP"==t[i].strip())return i;s(!1)},u=[],c=[],h=null,d=[],p=0;p<t.length;++p){var f=t[p].strip();if(f.startsWith("M  V30 COUNTS"));else{if("M  END"==f)break;if("M  V30 BEGIN PRODUCT"==f)s(null==h),h=c;else if("M  V30 END PRODUCT"==f)s(h===c),h=null;else if("M  V30 BEGIN REACTANT"==f)s(null==h),h=u;else if("M  V30 END REACTANT"==f)s(h===u),h=null;else if(f.startsWith("M  V30 BEGIN RGROUP")){s(null==h);var m=l(p);d.push(t.slice(p,m+1)),p=m}else{if("M  V30 BEGIN CTAB"!=f)throw new Error("line unrecognized: "+f);var m=a(p);h.push(t.slice(p,m+1)),p=m}}}for(var g=[],b=u.concat(c),m=0;m<b.length;++m){var v=chem.Molfile.parseCTabV3000(b[m],i);g.push(v)}var y=e.rxnMerge(g,n,r,o);return e.readRGroups3000(y,function(t){for(var e=[],i=0;i<t.length;++i)e=e.concat(t[i]);return e}(d)),y},chem.Molfile.rxnMerge=function(t,e,i,n){var r,o=(chem.Molfile,new chem.Struct),s=[],a=[],l=[],u=[],c=[],h=[],d={cnt:0,totalLength:0};for(r=0;r<t.length;++r){var p=t[r],f=p.getBondLengthData();d.cnt+=f.cnt,d.totalLength+=f.totalLength}var m=1/(0==d.cnt?1:d.totalLength/d.cnt);for(r=0;r<t.length;++r)p=t[r],p.scale(m);for(r=0;r<t.length;++r){p=t[r];var g=p.getCoordBoundingBoxObj();if(g){var b=e>r?chem.Struct.FRAGMENT.REACTANT:e+i>r?chem.Struct.FRAGMENT.PRODUCT:chem.Struct.FRAGMENT.AGENT;b==chem.Struct.FRAGMENT.REACTANT?(s.push(g),u.push(p)):b==chem.Struct.FRAGMENT.AGENT?(a.push(g),c.push(p)):b==chem.Struct.FRAGMENT.PRODUCT&&(l.push(g),h.push(p)),p.atoms.each(function(t,e){e.rxnFragmentType=b})}}var v=0,y=function(t,e,i,n,r){var o=new util.Vec2(n-i.min.x,r?1-i.min.y:-(i.min.y+i.max.y)/2);return e.atoms.each(function(t,e){e.pp.add_(o)}),e.sgroups.each(function(t,e){e.pp&&e.pp.add_(o)}),i.min.add_(o),i.max.add_(o),e.mergeInto(t),i.max.x-i.min.x};for(r=0;r<u.length;++r)v+=y(o,u[r],s[r],v,!1)+2;for(v+=2,r=0;r<c.length;++r)v+=y(o,c[r],a[r],v,!0)+2;for(v+=2,r=0;r<h.length;++r)v+=y(o,h[r],l[r],v,!1)+2;var w,S,x,_,A=null,E=null;for(r=0;r<s.length-1;++r)w=s[r],S=s[r+1],x=(w.max.x+S.min.x)/2,_=(w.max.y+w.min.y+S.max.y+S.min.y)/4,o.rxnPluses.add(new chem.Struct.RxnPlus({pp:new util.Vec2(x,_)}));for(r=0;r<s.length;++r)0==r?(A={},A.max=new util.Vec2(s[r].max),A.min=new util.Vec2(s[r].min)):(A.max=util.Vec2.max(A.max,s[r].max),A.min=util.Vec2.min(A.min,s[r].min));for(r=0;r<l.length-1;++r)w=l[r],S=l[r+1],x=(w.max.x+S.min.x)/2,_=(w.max.y+w.min.y+S.max.y+S.min.y)/4,o.rxnPluses.add(new chem.Struct.RxnPlus({pp:new util.Vec2(x,_)}));for(r=0;r<l.length;++r)0==r?(E={},E.max=new util.Vec2(l[r].max),E.min=new util.Vec2(l[r].min)):(E.max=util.Vec2.max(E.max,l[r].max),E.min=util.Vec2.min(E.min,l[r].min));if(w=A,S=E,w||S){var O=w?new util.Vec2(w.max.x,(w.max.y+w.min.y)/2):null,C=S?new util.Vec2(S.min.x,(S.max.y+S.min.y)/2):null,T=3;O||(O=new util.Vec2(C.x-T,C.y)),C||(C=new util.Vec2(O.x+T,O.y)),o.rxnArrows.add(new chem.Struct.RxnArrow({pp:util.Vec2.lc2(O,.5,C,.5)}))}else o.rxnArrows.add(new chem.Struct.RxnArrow({pp:new util.Vec2(0,0)}));return o.isReaction=!0,o},chem.Molfile.rgMerge=function(t,e){var i=new chem.Struct;t.mergeInto(i,null,null,!1,!0);for(var n in e)for(var r=0;r<e[n].length;++r){var o=e[n][r];o.rgroups.set(n,new chem.Struct.RGroup);var s=o.frags.add(new chem.Struct.Fragment);o.rgroups.get(n).frags.add(s),o.atoms.each(function(t,e){e.fragment=s}),o.mergeInto(i)}return i},chem.Molfile.parseRg2000=function(t){var e=chem.Molfile;if(t=t.slice(7),"$CTAB"!=t[0].strip())throw new Error("RGFile format invalid");for(var i=1;"$"!=t[i].charAt(0);)i++;if("$END CTAB"!=t[i].strip())throw new Error("RGFile format invalid");var n=t.slice(1,i);t=t.slice(i+1);for(var r={};;){if(0==t.length)throw new Error("Unexpected end of file");var o=t[0].strip();if("$END MOL"==o){t=t.slice(1);break}if("$RGP"!=o)throw new Error("RGFile format invalid");var s=t[1].strip()-0;for(r[s]=[],t=t.slice(2);;){if(0==t.length)throw new Error("Unexpected end of file");if(o=t[0].strip(),"$END RGP"==o){t=t.slice(1);break}if("$CTAB"!=o)throw new Error("RGFile format invalid");for(i=1;"$"!=t[i].charAt(0);)i++;if("$END CTAB"!=t[i].strip())throw new Error("RGFile format invalid");r[s].push(t.slice(1,i)),t=t.slice(i+1)}}var a=chem.Molfile.parseCTab(n),l={};if(chem.Molfile.loadRGroupFragments)for(var u in r){l[u]=[];for(var c=0;c<r[u].length;++c)l[u].push(chem.Molfile.parseCTab(r[u][c]))}return e.rgMerge(a,l)},!window.chem||!util.Vec2||!util.Pool)throw new Error("Vec2, Pool should be defined first");if(chem.SGroup=function(t){if(!(t&&t in chem.SGroup.TYPES))throw new Error("Invalid or unsupported s-group type");this.type=t,this.id=-1,chem.SGroup.equip(this,t),this.label=-1,this.bracketBox=null,this.bracketDir=new util.Vec2(1,0),this.areas=[],this.highlight=!1,this.highlighting=null,this.selected=!1,this.selectionPlate=null,this.atoms=[],this.patoms=[],this.bonds=[],this.xBonds=[],this.neiAtoms=[],this.pp=null,this.data={mul:1,connectivity:"ht",name:"",subscript:"n",attached:!1,absolute:!0,showUnits:!1,nCharsToDisplay:-1,tagChar:"",daspPos:1,fieldType:"F",fieldName:"",fieldValue:"",units:"",query:"",queryOp:""}},chem.SGroup.prototype.getAttr=function(t){return this.data[t]},chem.SGroup.prototype.getAttrs=function(){var t={};for(var e in this.data)t[e]=this.data[e];return t},chem.SGroup.prototype.setAttr=function(t,e){var i=this.data[t];return this.data[t]=e,i},chem.SGroup.prototype.checkAttr=function(t,e){return this.data[t]==e},chem.SGroup.equip=function(t,e){var i=chem.SGroup.TYPES[e];for(var n in i)t[n]=i[n]},chem.SGroup.numberArrayToString=function(t,e){for(var i=util.stringPadded(t.length,3),n=0;n<t.length;++n)i+=" "+util.stringPadded(e[t[n]],3);return i},chem.SGroup.addGroup=function(t,e,i){e.id=t.sgroups.add(e),e.postLoad(t,i);for(var n=0;n<e.atoms.length;++n)t.atoms.has(e.atoms[n])&&util.Set.add(t.atoms.get(e.atoms[n]).sgs,e.id);return t.sGroupForest.insert(e.id),e.id},chem.SGroup.bracketsToMolfile=function(t,e,i){var n=[],r=[],o=util.Set.fromList(e.atoms);chem.SGroup.getCrossBonds(n,r,t,o),chem.SGroup.bracketPos(e,null,t,r);for(var s=e.bracketBox,a=e.bracketDir,l=a.rotateSC(1,0),u=chem.SGroup.getBracketParameters(t,r,o,s,a,l,null,e.id),c=[],h=0;h<u.length;++h){for(var d=u[h],p=d.c.addScaled(d.n,-.5*d.h).yComplement(),f=d.c.addScaled(d.n,.5*d.h).yComplement(),m="M  SDI "+i+util.paddedInt(4,3),g=[p.x,p.y,f.x,f.y],b=0;b<g.length;++b)m+=util.paddedFloat(g[b],10,4);c.push(m)}return c},chem.SGroup.filterAtoms=function(t,e){for(var i=[],n=0;n<t.length;++n){var r=t[n];"number"!=typeof e[r]?i.push(r):e[r]>=0?i.push(e[r]):i.push(-1)}return i},chem.SGroup.removeNegative=function(t){for(var e=[],i=0;i<t.length;++i)t[i]>=0&&e.push(t[i]);return e},chem.SGroup.filter=function(t,e,i){e.atoms=chem.SGroup.removeNegative(chem.SGroup.filterAtoms(e.atoms,i))},chem.SGroup.clone=function(t,e,i){var n=new chem.SGroup(t.type);for(var r in t.data)n.data[r]=t.data[r];return n.atoms=util.mapArray(t.atoms,e),n.pp=t.pp,n.bracketBox=t.bracketBox,n.patoms=null,n.bonds=null,n.allAtoms=t.allAtoms,n},chem.SGroup.addAtom=function(t,e){t.atoms.push(e)},chem.SGroup.removeAtom=function(t,e){for(var i=0;i<t.atoms.length;++i)if(t.atoms[i]===e)return void t.atoms.splice(i,1);throw new Error("The atom is not found in the given s-group")},chem.SGroup.getCrossBonds=function(t,e,i,n){i.bonds.each(function(i,r){util.Set.contains(n,r.begin)&&util.Set.contains(n,r.end)?util.isNull(t)||t.push(i):(util.Set.contains(n,r.begin)||util.Set.contains(n,r.end))&&(util.isNull(e)||e.push(i))},this)},chem.SGroup.bracketPos=function(t,e,i,n){var r=t.atoms;if(n&&2===n.length){var o=i.bonds.get(n[0]),s=i.bonds.get(n[1]),a=o.getCenter(i),l=s.getCenter(i);t.bracketDir=util.Vec2.diff(l,a).normalized()}else t.bracketDir=new util.Vec2(1,0);var u=t.bracketDir,c=u.rotateSC(1,0),h=null,d=[];util.each(r,function(t){var n=i.atoms.get(t),r=e?e.ctab.atoms.get(t).visel.boundingBox:null,o=new util.Vec2(n.pp);if(util.isNull(r)){r=new util.Box2Abs(o,o);var s=new util.Vec2(.05*3,.05*3);r=r.extend(s,s)}else r=r.translate((e.offset||new util.Vec2).negated()).transform(e.scaled2obj,e);
d.push(r)},this),util.each(i.sGroupForest.children.get(t.id),function(t){var i=e?e.ctab.sgroups.get(t).visel.boundingBox:null;util.isNull(i)||(i=i.translate((e.offset||new util.Vec2).negated()).transform(e.scaled2obj,e),d.push(i))},this),util.each(d,function(t){var e=null;util.each([t.p0.x,t.p1.x],function(i){util.each([t.p0.y,t.p1.y],function(t){var n=new util.Vec2(i,t),r=new util.Vec2(util.Vec2.dot(n,u),util.Vec2.dot(n,c));e=util.isNull(e)?new util.Box2Abs(r,r):e.include(r)},this)},this),h=util.isNull(h)?e:util.Box2Abs.union(h,e)},this);var p=new util.Vec2(.2,.4);util.isNull(h)||(h=h.extend(p,p)),t.bracketBox=h},chem.SGroup.drawBrackets=function(t,e,i,n,r,o,s,a,l,u,c){for(var h=chem.SGroup.getBracketParameters(e.ctab.molecule,n,r,o,s,a,e,i.id),d=-1,p=0;p<h.length;++p){var f=h[p],m=chem.SGroup.drawBracket(e,e.paper,e.styles,f.d,f.n,f.c,f.w,f.h);t.push(m),(0>d||h[d].d.x<f.d.x||h[d].d.x==f.d.x&&h[d].d.y>f.d.y)&&(d=p)}var g=h[d],b=function(i,n){var r=e.ps(g.c.addScaled(g.n,n*g.h)),o=e.paper.text(r.x,r.y,i).attr({font:e.settings.font,"font-size":e.settings.fontszsub});c&&o.attr(c);var s=util.Box2Abs.fromRelBox(rnd.relBox(o.getBBox())),a=Math.max(util.Vec2.shiftRayBox(r,g.d.negated(),s),3)+2;o.translateAbs(a*g.d.x,a*g.d.y),t.push(o)};l&&b(l,.5),u&&b(u,-.5)},chem.SGroup.drawBracket=function(t,e,i,n,r,o,s,a){s=s||.25,a=a||1;var l=o.addScaled(r,-.5*a),u=o.addScaled(r,.5*a),c=l.addScaled(n,-s),h=u.addScaled(n,-s);return l=t.obj2scaled(l),u=t.obj2scaled(u),c=t.obj2scaled(c),h=t.obj2scaled(h),e.path("M {0}, {1} L {2} , {3} L {4} , {5} L {6} , {7}",c.x,c.y,l.x,l.y,u.x,u.y,h.x,h.y).attr(i.sgroupBracketStyle)},chem.SGroup.getBracketParameters=function(t,e,i,n,r,o,s,a){var l=function(t,e,i,n){this.c=t,this.d=e,this.n=e.rotateSC(1,0),this.w=i,this.h=n},u=[];return e.length<2?!function(){r=r||new util.Vec2(1,0),o=o||r.rotateSC(1,0);var t=Math.min(.25,.3*n.sz().x),e=util.Vec2.lc2(r,n.p0.x,o,.5*(n.p0.y+n.p1.y)),i=util.Vec2.lc2(r,n.p1.x,o,.5*(n.p0.y+n.p1.y)),s=n.sz().y;u.push(new l(e,r.negated(),t,s),new l(i,r,t,s))}():2===e.length?!function(){var i=t.bonds.get(e[0]),n=t.bonds.get(e[1]),r=i.getCenter(t),o=n.getCenter(t),c=-1,h=-1,d=-1,p=-1,f=util.Vec2.centre(r,o),m=util.Vec2.diff(o,r).normalized(),g=m.negated(),b=m.rotateSC(1,0),v=b.negated();util.each(t.sGroupForest.children.get(a),function(t){var e=s?s.ctab.sgroups.get(t).visel.boundingBox:null;util.isNull(e)||(e=e.translate((s.offset||new util.Vec2).negated()).transform(s.scaled2obj,s),c=Math.max(c,util.Vec2.shiftRayBox(r,g,e)),h=Math.max(h,util.Vec2.shiftRayBox(o,m,e)),d=Math.max(d,util.Vec2.shiftRayBox(f,b,e)),p=Math.max(p,util.Vec2.shiftRayBox(f,v,e)))},this),c=Math.max(c+.2,0),h=Math.max(h+.2,0),d=Math.max(Math.max(d,p)+.1,0);var y=.25,w=1.5+d;u.push(new l(r.addScaled(g,c),g,y,w),new l(o.addScaled(m,h),m,y,w))}():!function(){for(var n=0;n<e.length;++n){var r=t.bonds.get(e[n]),o=r.getCenter(t),s=util.Set.contains(i,r.begin)?r.getDir(t):r.getDir(t).negated();u.push(new l(o,s,.2,1))}}(),u},chem.SGroup.getObjBBox=function(t,e){if(0==t.length)throw new Error("Atom list is empty");for(var i=e.atoms.get(t[0]).pp,n=new util.Box2Abs(i,i),r=1;r<t.length;++r){var o=t[r],s=e.atoms.get(o),a=s.pp;n=n.include(a)}return n},chem.SGroup.makeAtomBondLines=function(t,e,i,n){if(!i)return[];for(var r=[],o=0;o<Math.floor((i.length+14)/15);++o){for(var s=Math.min(i.length-15*o,15),a="M  "+t+" "+e+" "+util.paddedInt(s,2),l=0;s>l;++l)a+=" "+util.paddedInt(n[i[15*o+l]],3);r.push(a)}return r},chem.SGroup.getAtoms=function(t,e){if(!e.allAtoms)return e.atoms;var i=[];return t.atoms.each(function(t){i.push(t)}),i},chem.SGroup.getBonds=function(t,e){var i=chem.SGroup.getAtoms(t,e),n=[];return t.bonds.each(function(t,e){i.indexOf(e.begin)>=0&&i.indexOf(e.end)>=0&&n.push(t)}),n},chem.SGroup.GroupMul={draw:function(t){var e=t.render,i=e.paper.set(),n=[],r=[],o=util.Set.fromList(this.atoms);chem.SGroup.getCrossBonds(n,r,t.molecule,o),chem.SGroup.bracketPos(this,e,t.molecule,r);var s=this.bracketBox,a=this.bracketDir,l=a.rotateSC(1,0);return this.areas=[s],chem.SGroup.drawBrackets(i,e,this,r,o,s,a,l,this.data.mul),i},saveToMolfile:function(t,e,i,n){var r=util.stringPadded(e[this.id],3),o=[];o=o.concat(chem.SGroup.makeAtomBondLines("SAL",r,util.idList(this.atomSet),i)),o=o.concat(chem.SGroup.makeAtomBondLines("SPA",r,util.idList(this.parentAtomSet),i)),o=o.concat(chem.SGroup.makeAtomBondLines("SBL",r,this.bonds,n));var s="M  SMT "+r+" "+this.data.mul;return o.push(s),o=o.concat(chem.SGroup.bracketsToMolfile(t,this,r)),o.join("\n")},prepareForSaving:function(t){var e;this.atoms.sort(),this.atomSet=util.Set.fromList(this.atoms),this.parentAtomSet=util.Set.clone(this.atomSet);var i=[],n=[];if(t.bonds.each(function(t,e){util.Set.contains(this.parentAtomSet,e.begin)&&util.Set.contains(this.parentAtomSet,e.end)?i.push(t):(util.Set.contains(this.parentAtomSet,e.begin)||util.Set.contains(this.parentAtomSet,e.end))&&n.push(t)},this),0!=n.length&&2!=n.length)throw{id:this.id,"error-type":"cross-bond-number",message:"Unsupported cross-bonds number"};var r=-1,o=-1,s=null;if(2==n.length){var a=t.bonds.get(n[0]);r=util.Set.contains(this.parentAtomSet,a.begin)?a.begin:a.end;var l=t.bonds.get(n[1]);o=util.Set.contains(this.parentAtomSet,l.begin)?l.begin:l.end,s=l}var u=null,c=r,h=[];for(e=0;e<this.data.mul-1;++e)if(u={},util.each(this.atoms,function(e){var i=t.atoms.get(e),n=t.atoms.add(new chem.Struct.Atom(i));h.push(n),this.atomSet[n]=1,u[e]=n},this),util.each(i,function(e){var i=t.bonds.get(e),n=new chem.Struct.Bond(i);n.begin=u[n.begin],n.end=u[n.end],t.bonds.add(n)},this),null!=s){var d=new chem.Struct.Bond(s);d.begin=c,d.end=u[o],t.bonds.add(d),c=u[r]}if(util.each(h,function(e){util.each(t.sGroupForest.getPathToRoot(this.id).reverse(),function(i){t.atomAddToSGroup(i,e)},this)},this),c>=0){var p=t.bonds.get(n[0]);p.begin==r?p.begin=c:p.end=c}this.bonds=n},postLoad:function(t,e){this.data.mul=this.data.subscript-0;var i={};this.atoms=chem.SGroup.filterAtoms(this.atoms,e),this.patoms=chem.SGroup.filterAtoms(this.patoms,e);for(var n=1;n<this.data.mul;++n)for(var r=0;r<this.patoms.length;++r){var o=this.atoms[n*this.patoms.length+r];if(!(0>o)){if(this.patoms[r]<0)throw new Error("parent atom missing");i[o]=this.patoms[r]}}this.patoms=chem.SGroup.removeNegative(this.patoms);var s=util.identityMap(this.patoms),a=[];t.bonds.each(function(t,e){var n=e.begin in i,r=e.end in i;n&&r||n&&e.end in s||r&&e.begin in s?a.push(t):n?e.begin=i[e.begin]:r&&(e.end=i[e.end])},this);for(var l=0;l<a.length;++l)t.bonds.remove(a[l]);for(var u in i)t.atoms.remove(u),e[u]=-1;this.atoms=this.patoms,this.patoms=null}},chem.SGroup.GroupSru={draw:function(t){var e=t.render,i=e.paper.set(),n=[],r=[],o=util.Set.fromList(this.atoms);chem.SGroup.getCrossBonds(n,r,t.molecule,o),chem.SGroup.bracketPos(this,e,t.molecule,r);var s=this.bracketBox,a=this.bracketDir,l=a.rotateSC(1,0);this.areas=[s];var u=this.data.connectivity||"eu";"ht"==u&&(u="");var c=this.data.subscript||"n";return chem.SGroup.drawBrackets(i,e,this,r,o,s,a,l,c,u),i},saveToMolfile:function(t,e,i,n){var r=util.stringPadded(e[this.id],3),o=[];return o=o.concat(chem.SGroup.makeAtomBondLines("SAL",r,this.atoms,i)),o=o.concat(chem.SGroup.makeAtomBondLines("SBL",r,this.bonds,n)),o=o.concat(chem.SGroup.bracketsToMolfile(t,this,r)),o.join("\n")},prepareForSaving:function(t){var e=[];if(t.bonds.each(function(i,n){var r=t.atoms.get(n.begin),o=t.atoms.get(n.end);(util.Set.contains(r.sgs,this.id)&&!util.Set.contains(o.sgs,this.id)||util.Set.contains(o.sgs,this.id)&&!util.Set.contains(r.sgs,this.id))&&e.push(i)},this),0!=e.length&&2!=e.length)throw{id:this.id,"error-type":"cross-bond-number",message:"Unsupported cross-bonds number"};this.bonds=e},postLoad:function(t,e){this.data.connectivity=(this.data.connectivity||"EU").strip().toLowerCase()}},chem.SGroup.GroupSup={draw:function(t){var e=t.render,i=e.paper.set(),n=[],r=[],o=util.Set.fromList(this.atoms);chem.SGroup.getCrossBonds(n,r,t.molecule,o),chem.SGroup.bracketPos(this,e,t.molecule,r);var s=this.bracketBox,a=this.bracketDir,l=a.rotateSC(1,0);return this.areas=[s],chem.SGroup.drawBrackets(i,e,this,r,o,s,a,l,this.data.name,null,{"font-style":"italic"}),i},saveToMolfile:function(t,e,i,n){var r=util.stringPadded(e[this.id],3),o=[];return o=o.concat(chem.SGroup.makeAtomBondLines("SAL",r,this.atoms,i)),o=o.concat(chem.SGroup.makeAtomBondLines("SBL",r,this.bonds,n)),this.data.name&&""!=this.data.name&&o.push("M  SMT "+r+" "+this.data.name),o.join("\n")},prepareForSaving:function(t){var e=[];t.bonds.each(function(i,n){var r=t.atoms.get(n.begin),o=t.atoms.get(n.end);(util.Set.contains(r.sgs,this.id)&&!util.Set.contains(o.sgs,this.id)||util.Set.contains(o.sgs,this.id)&&!util.Set.contains(r.sgs,this.id))&&e.push(i)},this),this.bonds=e},postLoad:function(t,e){this.data.name=(this.data.subscript||"").strip(),this.data.subscript=""}},chem.SGroup.GroupGen={draw:function(t){var e=t.render,i=(e.settings,e.styles,e.paper),n=i.set(),r=[],o=[],s=util.Set.fromList(this.atoms);chem.SGroup.getCrossBonds(r,o,t.molecule,s),chem.SGroup.bracketPos(this,e,t.molecule,o);var a=this.bracketBox,l=this.bracketDir,u=l.rotateSC(1,0);return this.areas=[a],chem.SGroup.drawBrackets(n,e,this,o,s,a,l,u),n},saveToMolfile:function(t,e,i,n){var r=util.stringPadded(e[this.id],3),o=[];return o=o.concat(chem.SGroup.makeAtomBondLines("SAL",r,this.atoms,i)),o=o.concat(chem.SGroup.makeAtomBondLines("SBL",r,this.bonds,n)),o=o.concat(chem.SGroup.bracketsToMolfile(t,this,r)),o.join("\n")},prepareForSaving:function(t){},postLoad:function(t,e){}},chem.SGroup.getMassCentre=function(t,e){for(var i=new util.Vec2,n=0;n<e.length;++n)i=i.addScaled(t.atoms.get(e[n]).pp,1/e.length);return i},chem.SGroup.setPos=function(t,e,i){e.pp=i},chem.SGroup.GroupDat={showValue:function(t,e,i,n){var r=t.text(e.x,e.y,i.data.fieldValue).attr({font:n.font,"font-size":n.fontsz});return r},draw:function(t){var e,i=t.render,n=i.settings,r=i.paper,o=r.set(),s=chem.SGroup.getAtoms(t,this);chem.SGroup.bracketPos(this,i,t.molecule),this.areas=this.bracketBox?[this.bracketBox]:[],null==this.pp&&chem.SGroup.setPos(t,this,this.bracketBox.p1.add(new util.Vec2(.5,.5)));var a=this.pp.scaled(n.scaleFactor);if(this.data.attached)for(e=0;e<s.length;++e){var l=t.atoms.get(s[e]),u=i.ps(l.a.pp),c=l.visel.boundingBox;null!=c&&(u.x=Math.max(u.x,c.p1.x)),u.x+=n.lineWidth;var h=this.showValue(r,u,this,n),d=rnd.relBox(h.getBBox());h.translateAbs(.5*d.width,-.3*d.height),o.push(h);var p=util.Box2Abs.fromRelBox(rnd.relBox(h.getBBox()));p=p.transform(i.scaled2obj,i),this.areas.push(p)}else{var f=this.showValue(r,a,this,n),m=rnd.relBox(f.getBBox());f.translateAbs(.5*m.width,-.5*m.height),o.push(f);var g=util.Box2Abs.fromRelBox(rnd.relBox(f.getBBox()));this.dataArea=g.transform(i.scaled2obj,i),t.sgroupData.has(this.id)||t.sgroupData.set(this.id,new rnd.ReDataSGroupData(this))}return o},saveToMolfile:function(t,e,i,n){var r=util.stringPadded(e[this.id],3),o=this.data,s=this.pp;o.absolute||(s=s.sub(chem.SGroup.getMassCentre(t,this.atoms)));var a=[];a=a.concat(chem.SGroup.makeAtomBondLines("SAL",r,this.atoms,i));var l="M  SDT "+r+" "+util.stringPadded(o.fieldName,30,!0)+util.stringPadded(o.fieldType,2)+util.stringPadded(o.units,20,!0)+util.stringPadded(o.query,2)+util.stringPadded(o.queryOp,3);a.push(l);var u="M  SDD "+r+" "+util.paddedFloat(s.x,10,4)+util.paddedFloat(-s.y,10,4)+"    "+(o.attached?"A":"D")+(o.absolute?"A":"R")+(o.showUnits?"U":" ")+"   "+(o.nCharnCharsToDisplay>=0?util.paddedInt(o.nCharnCharsToDisplay,3):"ALL")+"  1   "+util.stringPadded(o.tagChar,1)+"  "+util.paddedInt(o.daspPos,1)+"  ";return a.push(u),o.fieldValue.replace(/[\r\n|\n|\r]*$/,"").split(/\r\n|\n|\r/).each(function(t){for(var e=69;t.length>e;)a.push("M  SCD "+r+" "+t.slice(0,e)),t=t.slice(69);a.push("M  SED "+r+" "+util.stringPadded(t,e,!0))},this),a.join("\n")},prepareForSaving:function(t){this.atoms=chem.SGroup.getAtoms(t,this)},postLoad:function(t,e){var i=this.atoms.length==t.atoms.count();this.data.absolute||(this.pp=this.pp.add(chem.SGroup.getMassCentre(t,this.atoms))),!i||"MDLBG_FRAGMENT_STEREO"!=this.data.fieldName&&"MDLBG_FRAGMENT_COEFFICIENT"!=this.data.fieldName&&"MDLBG_FRAGMENT_CHARGE"!=this.data.fieldName||(this.atoms=[],this.allAtoms=!0)}},chem.SGroup.TYPES={MUL:chem.SGroup.GroupMul,SRU:chem.SGroup.GroupSru,SUP:chem.SGroup.GroupSup,DAT:chem.SGroup.GroupDat,GEN:chem.SGroup.GroupGen},chem.SGroupForest=function(t){this.parent=new util.Map,this.children=new util.Map,this.children.set(-1,[]),this.molecule=t},chem.SGroupForest.prototype.getSGroupsBFS=function(){var t=[],e=[],i=-1;for(e=util.array(this.children.get(-1));e.length>0;){var i=e.shift();e=e.concat(this.children.get(i)),t.push(i)}return t},chem.SGroupForest.prototype.getAtomSets=function(){return this.molecule.sgroups.map(function(t,e){return util.Set.fromList(e.atoms)})},chem.SGroupForest.prototype.getAtomSetRelations=function(t,e,i){var n=new util.Map,r=new util.Map,i=this.getAtomSets();i.unset(t),i.each(function(t,i){r.set(t,util.Set.subset(e,i)),n.set(t,util.Set.subset(i,e)&&!util.Set.eq(i,e))},this);var o=i.findAll(function(t){return r.get(t)?util.find(this.children.get(t),function(t){return r.get(t)},this)>=0?!1:!0:!1},this);util.assert(o.length<=1);var s=i.findAll(function(t,e){return n.get(t)&&!n.get(this.parent.get(t))},this);return{children:s,parent:0===o.length?-1:o[0]}},chem.SGroupForest.prototype.getPathToRoot=function(t){for(var e=[],i=t;i>=0;i=this.parent.get(i))util.assert(e.indexOf(i)<0,"SGroupForest: loop detected"),e.push(i);return e},chem.SGroupForest.prototype.validate=function(){var t=this.getAtomSets();this.molecule.sgroups.each(function(t){this.getPathToRoot(t)},this);var e=!0;return this.parent.each(function(i,n){n>=0&&!util.Set.subset(t.get(i),t.get(n))&&(e=!1)},this),this.children.each(function(i){for(var n=this.children.get(i),r=0;r<n.length;++r)for(var o=r+1;o<n.length;++o)util.Set.disjoint(t.get(n[r]),t.get(n[o]))||(e=!1)},this),e},chem.SGroupForest.prototype.insert=function(t,e,i){util.assert(!this.parent.has(t),"sgid already present in the forest"),util.assert(!this.children.has(t),"sgid already present in the forest"),util.assert(this.validate(),"s-group forest invalid");var n=this.getAtomSets(),r=util.Set.fromList(this.molecule.sgroups.get(t).atoms);if(util.isUndefined(e)||util.isUndefined(i)){var o=this.getAtomSetRelations(t,r,n);e=o.parent,i=o.children}return util.each(i,function(e){util.assert(1===util.arrayRemoveByValue(this.children.get(this.parent.get(e)),e)),this.parent.set(e,t)},this),this.children.set(t,i),this.parent.set(t,e),this.children.get(e).push(t),util.assert(this.validate(),"s-group forest invalid"),{parent:e,children:i}},chem.SGroupForest.prototype.remove=function(t){util.assert(this.parent.has(t),"sgid is not in the forest"),util.assert(this.children.has(t),"sgid is not in the forest"),util.assert(this.validate(),"s-group forest invalid");var e=this.parent.get(t);util.each(this.children.get(t),function(t){this.parent.set(t,e),this.children.get(e).push(t)},this),util.assert(1===util.arrayRemoveByValue(this.children.get(e),t)),this.children.unset(t),this.parent.unset(t),util.assert(this.validate(),"s-group forest invalid")},!window.chem||!chem.Struct)throw new Error("Include MolData.js first");if(chem.Struct.prototype.calcConn=function(t){for(var e=0,i=this.atoms.get(t),n=!1,r=0;r<i.neighbors.length;++r){var o=this.halfBonds.get(i.neighbors[r]),s=this.bonds.get(o.bid);switch(s.type){case chem.Struct.BOND.TYPE.SINGLE:e+=1;break;case chem.Struct.BOND.TYPE.DOUBLE:e+=2;break;case chem.Struct.BOND.TYPE.TRIPLE:e+=3;break;case chem.Struct.BOND.TYPE.AROMATIC:e+=1,n=!0;break;default:return-1}}return n&&(e+=1),e},chem.Struct.Atom.prototype.calcValence=function(t){var e=this,i=e.charge,n=e.label;if(e.isQuery())return this.implicitH=0,!0;var r=chem.Element.getElementByLabel(n);if(null==r)return this.implicitH=0,!0;var o=chem.Element.elements.get(r).group,s=chem.Struct.radicalElectrons(e.radical),a=t,l=0,u=Math.abs(i);return 1==o?("H"==n||"Li"==n||"Na"==n||"K"==n||"Rb"==n||"Cs"==n||"Fr"==n)&&(a=1,l=1-s-t-u):3==o?"B"==n||"Al"==n||"Ga"==n||"In"==n?-1==i?(a=4,l=4-s-t):(a=3,l=3-s-t-u):"Tl"==n&&(-1==i?2>=s+t?(a=2,l=2-s-t):(a=4,l=4-s-t):-2==i?3>=s+t?(a=3,l=3-s-t):(a=5,l=5-s-t):1>=s+t+u?(a=1,l=1-s-t-u):(a=3,l=3-s-t-u)):4==o?"C"==n||"Si"==n||"Ge"==n?(a=4,l=4-s-t-u):("Sn"==n||"Pb"==n)&&(2>=t+s+u?(a=2,l=2-s-t-u):(a=4,l=4-s-t-u)):5==o?"N"==n||"P"==n?1==i?(a=4,l=4-s-t):2==i?(a=3,l=3-s-t):"N"==n||3>=s+t+u?(a=3,l=3-s-t-u):(a=5,l=5-s-t-u):("Bi"==n||"Sb"==n||"As"==n)&&(1==i?2>=s+t&&"As"!=n?(a=2,l=2-s-t):(a=4,l=4-s-t):2==i?(a=3,l=3-s-t):3>=s+t?(a=3,l=3-s-t-u):(a=5,l=5-s-t-u)):6==o?"O"==n?i>=1?(a=3,l=3-s-t):(a=2,l=2-s-t-u):"S"==n||"Se"==n||"Po"==n?1==i?3>=t?(a=3,l=3-s-t):(a=5,l=5-s-t):2>=t+s+u?(a=2,l=2-s-t-u):4>=t+s+u?(a=4,l=4-s-t-u):(a=6,l=6-s-t-u):"Te"==n&&(-1==i?2>=t&&(a=2,l=2-s-t-u):(0==i||2==i)&&(2>=t?(a=2,l=2-s-t-u):4>=t?(a=4,l=4-s-t-u):0==i&&6>=t?(a=6,l=6-s-t-u):l=-1)):7==o&&("F"==n?(a=1,l=1-s-t-u):("Cl"==n||"Br"==n||"I"==n||"At"==n)&&(1==i?2>=t?(a=2,l=2-s-t):(3==t||5==t||t>=7)&&(l=-1):0==i&&(1>=t?(a=1,l=1-s-t):2==t||4==t||6==t?1==s?(a=t,l=0):l=-1:t>7&&(l=-1)))),this.valence=a,this.implicitH=l,this.implicitH<0?(this.valence=t,this.implicitH=0,this.badConn=!0,!1):!0},chem.Struct.Atom.prototype.calcValenceMinusHyd=function(t){var e=this,i=e.charge,n=e.label,r=chem.Element.getElementByLabel(n);if(null==r)throw new Error("Element "+n+" unknown");if(0>r)return this.implicitH=0,null;var o=chem.Element.elements.get(r).group,s=chem.Struct.radicalElectrons(e.radical);if(3==o){if(("B"==n||"Al"==n||"Ga"==n||"In"==n)&&-1==i&&4>=s+t)return s+t}else if(5==o){if("N"==n||"P"==n){if(1==i)return s+t;if(2==i)return s+t}else if("Sb"==n||"Bi"==n||"As"==n){if(1==i)return s+t;if(2==i)return s+t}}else if(6==o){if("O"==n){if(i>=1)return s+t}else if(("S"==n||"Se"==n||"Po"==n)&&1==i)return s+t}else if(7==o&&("Cl"==n||"Br"==n||"I"==n||"At"==n)&&1==i)return s+t;return s+t+Math.abs(i)},chem.Struct.prototype.calcImplicitHydrogen=function(t){var e=this.calcConn(t),i=this.atoms.get(t);if(i.badConn=!1,0>e||i.isQuery())return void(i.implicitH=0);if(i.explicitValence>=0){var n=chem.Element.getElementByLabel(i.label);i.implicitH=0,null!=n&&(i.implicitH=i.explicitValence-i.calcValenceMinusHyd(e),i.implicitH<0&&(i.implicitH=0,i.badConn=!0))}else i.calcValence(e)},!window.chem||!chem.Struct)throw new Error("Molecule should be defined first");if(chem.Dfs=function(t,e,i,n){this.molecule=t,this.atom_data=e,this.components=i,this.nComponentsInReactants=-1,this.nReactants=n,this.vertices=new Array(this.molecule.atoms.count()),this.molecule.atoms.each(function(t){this.vertices[t]=new chem.Dfs.VertexDesc},this),this.edges=new Array(this.molecule.bonds.count()),this.molecule.bonds.each(function(t){this.edges[t]=new chem.Dfs.EdgeDesc},this),this.v_seq=new Array},chem.Dfs.VertexDesc=function(){this.dfs_state=0,this.parent_vertex=0,this.parent_edge=0,this.branches=0},chem.Dfs.EdgeDesc=function(){this.opening_cycles=0,this.closing_cycle=0},chem.Dfs.SeqElem=function(t,e,i){this.idx=t,this.parent_vertex=e,this.parent_edge=i},chem.Dfs.prototype.walk=function(){for(var t,e,i=new Array,n=0,r=0;;){if(i.length<1){for(var o=-1,s=function(t){return 0==this.vertices[t].dfs_state?(o=t,!0):!1};n<this.components.length&&-1==o;)o=util.Set.find(this.components[n],s,this),null===o&&(o=-1,n++,n==this.nReactants&&(this.nComponentsInReactants=r));if(-1>o&&this.molecule.atoms.find(s,this),-1==o)break;this.vertices[o].parent_vertex=-1,this.vertices[o].parent_edge=-1,i.push(o),r++}var a=i.pop(),l=this.vertices[a].parent_vertex,u=new chem.Dfs.SeqElem(a,l,this.vertices[a].parent_edge);this.v_seq.push(u),this.vertices[a].dfs_state=2;var c=this.atom_data[a];for(t=0;t<c.neighbours.length;t++){var h=c.neighbours[t].aid,d=c.neighbours[t].bid;if(h!=l)if(2==this.vertices[h].dfs_state){for(this.edges[d].closing_cycle=1,e=a;-1!=e&&this.vertices[e].parent_vertex!=h;)e=this.vertices[e].parent_vertex;if(-1==e)throw new Error("cycle unwind error");this.edges[this.vertices[e].parent_edge].opening_cycles++,this.vertices[a].branches++,u=new chem.Dfs.SeqElem(h,a,d),this.v_seq.push(u)}else{if(1==this.vertices[h].dfs_state){if(e=i.indexOf(h),-1==e)throw new Error("internal: removing vertex from stack");i.splice(e,1);var p=this.vertices[h].parent_vertex;p>=0&&this.vertices[p].branches--}this.vertices[a].branches++,this.vertices[h].parent_vertex=a,this.vertices[h].parent_edge=d,this.vertices[h].dfs_state=1,i.push(h)}}}},chem.Dfs.prototype.edgeClosingCycle=function(t){return 0!=this.edges[t].closing_cycle},chem.Dfs.prototype.numBranches=function(t){return this.vertices[t].branches},chem.Dfs.prototype.numOpeningCycles=function(t){return this.edges[t].opening_cycles},chem.Dfs.prototype.toString=function(){var t="";return this.v_seq.each(function(e){t+=e.idx+" -> "}),t+="*"},!window.chem||!chem.Struct)throw new Error("Vec2 and Molecule should be defined first");if(chem.CisTrans=function(t,e,i){this.molecule=t,this.bonds=new util.Map,this.getNeighbors=e,this.context=i},chem.CisTrans.PARITY={NONE:0,CIS:1,TRANS:2},chem.CisTrans.prototype.each=function(t,e){this.bonds.each(t,e)},chem.CisTrans.prototype.getParity=function(t){return this.bonds.get(t).parity},chem.CisTrans.prototype.getSubstituents=function(t){return this.bonds.get(t).substituents},chem.CisTrans.prototype.sameside=function(t,e,i,n){var r=util.Vec2.diff(t,e),o=new util.Vec2(-r.y,r.x);if(!o.normalize())return 0;var s=util.Vec2.diff(i,t),a=util.Vec2.diff(n,e);if(!s.normalize())return 0;if(!a.normalize())return 0;var l=util.Vec2.dot(s,o),u=util.Vec2.dot(a,o);return Math.abs(l)<.001||Math.abs(u)<.001?0:l*u>0?1:-1},chem.CisTrans.prototype._sameside=function(t,e,i,n){return this.sameside(this.molecule.atoms.get(t).pp,this.molecule.atoms.get(e).pp,this.molecule.atoms.get(i).pp,this.molecule.atoms.get(n).pp)},chem.CisTrans.prototype._sortSubstituents=function(t){var e=this.molecule.atoms.get(t[0]).pureHydrogen(),i=t[1]<0||this.molecule.atoms.get(t[1]).pureHydrogen(),n=this.molecule.atoms.get(t[2]).pureHydrogen(),r=t[3]<0||this.molecule.atoms.get(t[3]).pureHydrogen();return e&&i?!1:n&&r?!1:(i?t[1]=-1:e?(t[0]=t[1],t[1]=-1):t[0]>t[1]&&t.swap(0,1),r?t[3]=-1:n?(t[2]=t[3],t[3]=-1):t[2]>t[3]&&t.swap(2,3),!0)},chem.CisTrans.prototype.isGeomStereoBond=function(t,e){var i=this.molecule.bonds.get(t);if(i.type!=chem.Struct.BOND.TYPE.DOUBLE)return!1;var n=this.molecule.atoms.get(i.begin).label,r=this.molecule.atoms.get(i.end).label;if("C"!=n&&"N"!=n&&"Si"!=n&&"Ge"!=n)return!1;if("C"!=r&&"N"!=r&&"Si"!=r&&"Ge"!=r)return!1;var o=this.getNeighbors.call(this.context,i.begin),s=this.getNeighbors.call(this.context,i.end);if(o.length<2||o.length>3||s.length<2||s.length>3)return!1;e[0]=-1,e[1]=-1,e[2]=-1,e[3]=-1;var a,l;for(a=0;a<o.length;a++)if(l=o[a],l.bid!=t){if(this.molecule.bonds.get(l.bid).type!=chem.Struct.BOND.TYPE.SINGLE)return!1;-1==e[0]?e[0]=l.aid:e[1]=l.aid}for(a=0;a<s.length;a++)if(l=s[a],l.bid!=t){if(this.molecule.bonds.get(l.bid).type!=chem.Struct.BOND.TYPE.SINGLE)return!1;-1==e[2]?e[2]=l.aid:e[3]=l.aid}return-1!=e[1]&&-1!=this._sameside(i.begin,i.end,e[0],e[1])?!1:-1!=e[3]&&-1!=this._sameside(i.begin,i.end,e[2],e[3])?!1:!0},chem.CisTrans.prototype.build=function(t){this.molecule.bonds.each(function(e,i){var n=this.bonds.set(e,{parity:0,substituents:new Array(4)});if((!Object.isArray(t)||!t[e])&&this.isGeomStereoBond(e,n.substituents)&&this._sortSubstituents(n.substituents)){var r=this._sameside(i.begin,i.end,n.substituents[0],n.substituents[2]);1==r?n.parity=chem.CisTrans.PARITY.CIS:-1==r&&(n.parity=chem.CisTrans.PARITY.TRANS)}},this)},!window.chem||!chem.Struct)throw new Error("Vec2 and Molecule should be defined first");if(chem.Stereocenters=function(t,e,i){this.molecule=t,this.atoms=new util.Map,this.getNeighbors=e,this.context=i},chem.Stereocenters.prototype.each=function(t,e){this.atoms.each(t,e)},chem.Stereocenters.prototype.buildFromBonds=function(t){var e=this.molecule.atoms,i=this.molecule.bonds,n=util.Set.empty();e.each(function(t,r){var o=this.getNeighbors.call(this.context,t);if(2!=o.length)return!1;var s=o[0],a=o[1];if(util.find([t,s.aid,a.aid],function(t){return["C","Si"].indexOf(e.get(t).label)<0},this)>=0)return!1;if(util.find([s.bid,a.bid],function(t){return i.get(t).type!=chem.Struct.BOND.TYPE.DOUBLE},this)>=0)return!1;var l=util.findAll(this.getNeighbors.call(this.context,s.aid),function(e){return e.aid!=t},this),u=util.findAll(this.getNeighbors.call(this.context,a.aid),function(e){return e.aid!=t},this);return l.length<1||l.length>2||u.length<1||u.length>2?!1:util.find(l.concat(u),function(t){return i.get(t.bid).type!=chem.Struct.BOND.TYPE.SINGLE},this)>=0?!1:util.find(l.concat(u),function(t){return i.get(t.bid).stereo==chem.Struct.BOND.STEREO.EITHER},this)>=0?!1:(util.Set.add(n,s.aid),void util.Set.add(n,a.aid))},this),util.Set.size(n)>0&&alert("This structure may contain allenes, which cannot be represented in the SMILES notation. Relevant stereo-information will be discarded."),e.each(function(e){if(!util.Set.contains(n,e)){var i=this.getNeighbors.call(this.context,e),r=!1;i.find(function(t){var i=this.molecule.bonds.get(t.bid);return i.type!=chem.Struct.BOND.TYPE.SINGLE||i.begin!=e||i.stereo!=chem.Struct.BOND.STEREO.UP&&i.stereo!=chem.Struct.BOND.STEREO.DOWN?!1:(r=!0,!0)},this),r&&(t?this._buildOneCenter(e):this._buildOneCenter(e))}},this)},chem.Stereocenters.allowed_stereocenters=[{elem:"C",charge:0,degree:3,n_double_bonds:0,implicit_degree:4},{elem:"C",charge:0,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"Si",charge:0,degree:3,n_double_bonds:0,implicit_degree:4},{elem:"Si",charge:0,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"N",charge:1,degree:3,n_double_bonds:0,implicit_degree:4},{elem:"N",charge:1,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"N",charge:0,degree:3,n_double_bonds:0,implicit_degree:3},{elem:"S",charge:0,degree:4,n_double_bonds:2,implicit_degree:4},{elem:"S",charge:1,degree:3,n_double_bonds:0,implicit_degree:3},{elem:"S",charge:0,degree:3,n_double_bonds:1,implicit_degree:3},{elem:"P",charge:0,degree:3,n_double_bonds:0,implicit_degree:3},{elem:"P",charge:1,degree:4,n_double_bonds:0,implicit_degree:4},{elem:"P",charge:0,degree:4,n_double_bonds:1,implicit_degree:4}],chem.Stereocenters.prototype._buildOneCenter=function(t){var e=this.molecule.atoms.get(t),i=this.getNeighbors.call(this.context,t),n=i.length,r=-1,o={group:0,type:0,pyramid:new Array(4)},s=0,a=new Array(4),l=0,u=0;o.pyramid[0]=-1,o.pyramid[1]=-1,o.pyramid[2]=-1,o.pyramid[3]=-1;var c=0;if(n>4)throw new Error("stereocenter with %d bonds are not supported"+n);if(i.each(function(t){var i=this.molecule.atoms.get(t.aid),n=this.molecule.bonds.get(t.bid);if(a[s]={edge_idx:t.bid,nei_idx:t.aid,rank:t.aid,vec:util.Vec2.diff(i.pp,e.pp).yComplement()},i.pureHydrogen()?(c++,a[s].rank=1e4):"H"==i.label&&(a[s].rank=5e3),!a[s].vec.normalize())throw new Error("zero bond length");if(n.type==chem.Struct.BOND.TYPE.TRIPLE)throw new Error("non-single bonds not allowed near stereocenter");if(n.type==chem.Struct.BOND.TYPE.AROMATIC)throw new Error("aromatic bonds not allowed near stereocenter");n.type==chem.Struct.BOND.TYPE.DOUBLE&&u++,s++},this),chem.Stereocenters.allowed_stereocenters.find(function(t){return t.elem==e.label&&t.charge==e.charge&&t.degree==n&&t.n_double_bonds==u?(r=t.implicit_degree,!0):!1},this),-1==r)throw new Error("unknown stereocenter configuration: "+e.label+", charge "+e.charge+", "+n+" bonds ("+u+" double)");if(4==n&&c>1)throw new Error(c+" hydrogens near stereocenter");if(3==n&&4==r&&c>0)throw new Error("have hydrogen(s) besides implicit hydrogen near stereocenter");if(4==n){a[0].rank>a[1].rank&&a.swap(0,1),a[1].rank>a[2].rank&&a.swap(1,2),a[2].rank>a[3].rank&&a.swap(2,3),a[1].rank>a[2].rank&&a.swap(1,2),a[0].rank>a[1].rank&&a.swap(0,1),a[1].rank>a[2].rank&&a.swap(1,2);var h=-1,d=-1,p=-1,f=-1,m=0;for(s=0;4>s;s++){var g=this._getBondStereo(t,a[s].edge_idx);if(g==chem.Struct.BOND.STEREO.UP||g==chem.Struct.BOND.STEREO.DOWN){h=s,m=g;break}}if(-1==h)throw new Error("none of 4 bonds going from stereocenter is stereobond");var b,v;if(-1==d&&(b=chem.Stereocenters._xyzzy(a[h].vec,a[(h+1)%4].vec,a[(h+2)%4].vec),v=chem.Stereocenters._xyzzy(a[h].vec,a[(h+1)%4].vec,a[(h+3)%4].vec),(b+v==3||b+v==12)&&(d=(h+1)%4,p=(h+2)%4,f=(h+3)%4)),-1==d&&(b=chem.Stereocenters._xyzzy(a[h].vec,a[(h+2)%4].vec,a[(h+1)%4].vec),v=chem.Stereocenters._xyzzy(a[h].vec,a[(h+2)%4].vec,a[(h+3)%4].vec),(b+v==3||b+v==12)&&(d=(h+2)%4,p=(h+1)%4,f=(h+3)%4)),-1==d&&(b=chem.Stereocenters._xyzzy(a[h].vec,a[(h+3)%4].vec,a[(h+1)%4].vec),v=chem.Stereocenters._xyzzy(a[h].vec,a[(h+3)%4].vec,a[(h+2)%4].vec),(b+v==3||b+v==12)&&(d=(h+3)%4,p=(h+2)%4,f=(h+1)%4)),-1==d)throw new Error("internal error: can not find opposite bond");if(m==chem.Struct.BOND.STEREO.UP&&this._getBondStereo(t,a[d].edge_idx)==chem.Struct.BOND.STEREO.DOWN)throw new Error("stereo types of the opposite bonds mismatch");if(m==chem.Struct.BOND.STEREO.DOWN&&this._getBondStereo(t,a[d].edge_idx)==chem.Struct.BOND.STEREO.UP)throw new Error("stereo types of the opposite bonds mismatch");if(m==this._getBondStereo(t,a[p].edge_idx))throw new Error("stereo types of non-opposite bonds match");if(m==this._getBondStereo(t,a[f].edge_idx))throw new Error("stereo types of non-opposite bonds match");l=3==h||3==d?m:m==chem.Struct.BOND.STEREO.UP?chem.Struct.BOND.STEREO.DOWN:chem.Struct.BOND.STEREO.UP,E=chem.Stereocenters._sign(a[0].vec,a[1].vec,a[2].vec),l==chem.Struct.BOND.STEREO.UP&&E>0||l==chem.Struct.BOND.STEREO.DOWN&&0>E?(o.pyramid[0]=a[0].nei_idx,o.pyramid[1]=a[1].nei_idx,o.pyramid[2]=a[2].nei_idx):(o.pyramid[0]=a[0].nei_idx,o.pyramid[1]=a[2].nei_idx,o.pyramid[2]=a[1].nei_idx),o.pyramid[3]=a[3].nei_idx}else if(3==n){a[0].rank>a[1].rank&&a.swap(0,1),a[1].rank>a[2].rank&&a.swap(1,2),a[0].rank>a[1].rank&&a.swap(0,1);var y=this._getBondStereo(t,a[0].edge_idx),w=this._getBondStereo(t,a[1].edge_idx),S=this._getBondStereo(t,a[2].edge_idx),x=0,_=0;if(x+=y==chem.Struct.BOND.STEREO.UP?1:0,x+=w==chem.Struct.BOND.STEREO.UP?1:0,x+=S==chem.Struct.BOND.STEREO.UP?1:0,_+=y==chem.Struct.BOND.STEREO.DOWN?1:0,_+=w==chem.Struct.BOND.STEREO.DOWN?1:0,_+=S==chem.Struct.BOND.STEREO.DOWN?1:0,4==r){if(3==x)throw new Error("all 3 bonds up near stereoatom");if(3==_)throw new Error("all 3 bonds down near stereoatom");if(0==x&&0==_)throw new Error("no up/down bonds near stereoatom -- indefinite case");if(1==x&&1==_)throw new Error("one bond up, one bond down -- indefinite case");if(m=0,2==x)l=chem.Struct.BOND.STEREO.DOWN;else if(2==_)l=chem.Struct.BOND.STEREO.UP;else{for(h=-1,p=-1,f=-1,s=0;3>s;s++)if(O=this._getBondStereo(t,a[s].edge_idx),O==chem.Struct.BOND.STEREO.UP||O==chem.Struct.BOND.STEREO.DOWN){h=s,m=O,p=(s+1)%3,f=(s+2)%3;break}if(-1==h)throw new Error("internal error: can not find up or down bond");var A=chem.Stereocenters._xyzzy(a[p].vec,a[f].vec,a[h].vec);if(3==A||4==A)throw new Error("degenerate case for 3 bonds near stereoatom");l=1==A?m:m==chem.Struct.BOND.STEREO.UP?chem.Struct.BOND.STEREO.DOWN:chem.Struct.BOND.STEREO.UP}var E=chem.Stereocenters._sign(a[0].vec,a[1].vec,a[2].vec);l==chem.Struct.BOND.STEREO.UP&&E>0||l==chem.Struct.BOND.STEREO.DOWN&&0>E?(o.pyramid[0]=a[0].nei_idx,o.pyramid[1]=a[1].nei_idx,o.pyramid[2]=a[2].nei_idx):(o.pyramid[0]=a[0].nei_idx,o.pyramid[1]=a[2].nei_idx,o.pyramid[2]=a[1].nei_idx),o.pyramid[3]=-1}else{var O;if(_>0&&x>0)throw new Error("one bond up, one bond down -- indefinite case");if(0==_&&0==x)throw new Error("no up-down bonds attached to stereocenter");O=x>0?1:-1,(1==chem.Stereocenters._xyzzy(a[0].vec,a[1].vec,a[2].vec)||1==chem.Stereocenters._xyzzy(a[0].vec,a[2].vec,a[1].vec)||1==chem.Stereocenters._xyzzy(a[2].vec,a[1].vec,a[0].vec))&&(O=-O),E=chem.Stereocenters._sign(a[0].vec,a[1].vec,a[2].vec),E==O?(o.pyramid[0]=a[0].nei_idx,o.pyramid[1]=a[2].nei_idx,o.pyramid[2]=a[1].nei_idx):(o.pyramid[0]=a[0].nei_idx,o.pyramid[1]=a[1].nei_idx,o.pyramid[2]=a[2].nei_idx),o.pyramid[3]=-1}}this.atoms.set(t,o)},chem.Stereocenters.prototype._getBondStereo=function(t,e){var i=this.molecule.bonds.get(e);
return t!=i.begin?0:i.stereo},chem.Stereocenters._xyzzy=function(t,e,i){var n=.001,r=util.Vec2.cross(t,e),o=util.Vec2.dot(t,e),s=util.Vec2.cross(t,i),a=util.Vec2.dot(t,i);if(Math.abs(r)<n){if(Math.abs(s)<n)throw new Error("degenerate case -- bonds overlap");return s>0?4:8}return-n*n>r*s?2:o>a?2:1},chem.Stereocenters._sign=function(t,e,i){var n=(t.x-i.x)*(e.y-i.y)-(t.y-i.y)*(e.x-i.x),r=.001;if(n>r)return 1;if(-r>n)return-1;throw new Error("degenerate triangle")},chem.Stereocenters.isPyramidMappingRigid=function(t){var e=t.clone(),i=!0;return e[0]>e[1]&&(e.swap(0,1),i=!i),e[1]>e[2]&&(e.swap(1,2),i=!i),e[2]>e[3]&&(e.swap(2,3),i=!i),e[1]>e[2]&&(e.swap(1,2),i=!i),e[0]>e[1]&&(e.swap(0,1),i=!i),e[1]>e[2]&&(e.swap(1,2),i=!i),i},!window.chem||!chem.Struct)throw new Error("Vec2 and Molecule should be defined first");if(chem.SmilesSaver=function(){this.smiles="",this._written_atoms=new Array,this._written_components=0,this.ignore_errors=!1},chem.SmilesSaver._Atom=function(t){this.neighbours=new Array,this.aromatic=!1,this.lowercase=!1,this.chirality=0,this.branch_cnt=0,this.paren_written=!1,this.h_count=t,this.parent=-1},chem.SmilesSaver.prototype.isBondInRing=function(t){if(util.isUndefined(this.inLoop)||util.isNull(this.inLoop))throw new Error("Init this.inLoop prior to calling this method");return this.inLoop[t]},chem.SmilesSaver.prototype.saveMolecule=function(t,e){var i,n,r;Object.isUndefined(e)||(this.ignore_errors=e),t=t.clone(),t.sgroups.each(function(e,i){if("MUL"==i.type)try{i.prepareForSaving(t)}catch(n){throw{message:"Bad s-group ("+n.message+")"}}else if(!this.ignore_errors)throw new Error("SMILES data format doesn't support s-groups")},this),this.atoms=new Array(t.atoms.count()),t.atoms.each(function(t,e){this.atoms[t]=new chem.SmilesSaver._Atom(e.implicitH)},this);var o=["B","C","N","O","P","S","Se","As"];t.bonds.each(function(e,i){i.type==chem.Struct.BOND.TYPE.AROMATIC&&(this.atoms[i.begin].aromatic=!0,-1!=o.indexOf(t.atoms.get(i.begin).label)&&(this.atoms[i.begin].lowercase=!0),this.atoms[i.end].aromatic=!0,-1!=o.indexOf(t.atoms.get(i.end).label)&&(this.atoms[i.end].lowercase=!0)),this.atoms[i.begin].neighbours.push({aid:i.end,bid:e}),this.atoms[i.end].neighbours.push({aid:i.begin,bid:e})},this),this.inLoop=function(){t.prepareLoopStructure();var e=util.Set.empty();t.loops.each(function(i,n){n.hbs.length<=6&&util.Set.mergeIn(e,util.Set.fromList(util.map(n.hbs,function(e){return t.halfBonds.get(e).bid},this)))},this);var i={};return util.Set.each(e,function(t){i[t]=1},this),i}(),this._touched_cistransbonds=0,this._markCisTrans(t);var s=chem.MolfileSaver.getComponents(t),a=s.reactants.concat(s.products),l=new chem.Dfs(t,this.atoms,a,s.reactants.length);for(l.walk(),this.atoms.each(function(t){t.neighbours.clear()},this),i=0;i<l.v_seq.length;i++){var u=l.v_seq[i],c=u.idx,h=u.parent_edge,d=u.parent_vertex;if(h>=0){var p=this.atoms[c],f=l.numOpeningCycles(h);for(n=0;f>n;n++)this.atoms[d].neighbours.push({aid:-1,bid:-1});if(l.edgeClosingCycle(h)){for(r=0;r<p.neighbours.length;r++)if(-1==p.neighbours[r].aid){p.neighbours[r].aid=d,p.neighbours[r].bid=h;break}if(r==p.neighbours.length)throw new Error("internal: can not put closing bond to its place")}else p.neighbours.push({aid:d,bid:h}),p.parent=d;this.atoms[d].neighbours.push({aid:c,bid:h})}}try{var m=new chem.Stereocenters(t,function(t){return this.atoms[t].neighbours},this);m.buildFromBonds(this.ignore_errors),m.each(function(t,e){var i=-1;-1==e.pyramid[3]&&(i=3);var o=new Array(4),s=0,a=this.atoms[t];if(-1!=a.parent)for(r=0;4>r;r++)if(e.pyramid[r]==a.parent){o[s++]=r;break}for(-1!=i&&(o[s++]=i),n=0;n!=a.neighbours.length;n++)if(a.neighbours[n].aid!=a.parent)for(r=0;4>r;r++)if(a.neighbours[n].aid==e.pyramid[r]){if(s>=4)throw new Error("internal: pyramid overflow");o[s++]=r;break}if(4==s)s=o[0],o[0]=o[1],o[1]=o[2],o[2]=o[3],o[3]=s;else if(3!=s)throw new Error("cannot calculate chirality");chem.Stereocenters.isPyramidMappingRigid(o)?this.atoms[t].chirality=1:this.atoms[t].chirality=2},this)}catch(g){alert("Warning: "+g.message)}var b=new Array;b.push(0);var v=!0;for(i=0;i<l.v_seq.length;i++){u=l.v_seq[i],c=u.idx,h=u.parent_edge,d=u.parent_vertex;var y=!0;if(d>=0){for(l.numBranches(d)>1&&this.atoms[d].branch_cnt>0&&this.atoms[d].paren_written&&(this.smiles+=")"),f=l.numOpeningCycles(h),n=0;f>n;n++){for(r=1;r<b.length&&-1!=b[r];r++);r==b.length?b.push(d):b[r]=d,this._writeCycleNumber(r)}if(d>=0){var w=l.numBranches(d);if(w>1&&this.atoms[d].branch_cnt<w-1&&(l.edgeClosingCycle(h)?this.atoms[d].paren_written=!1:(this.smiles+="(",this.atoms[d].paren_written=!0)),this.atoms[d].branch_cnt++,this.atoms[d].branch_cnt>w)throw new Error("unexpected branch")}var S=t.bonds.get(h),x=!0,_=0;if(S.type==chem.Struct.BOND.TYPE.SINGLE&&(_=this._calcBondDirection(t,h,d)),1==_&&c==S.end||2==_&&c==S.begin?this.smiles+="/":2==_&&c==S.end||1==_&&c==S.begin?this.smiles+="\\":S.type==chem.Struct.BOND.TYPE.ANY?this.smiles+="~":S.type==chem.Struct.BOND.TYPE.DOUBLE?this.smiles+="=":S.type==chem.Struct.BOND.TYPE.TRIPLE?this.smiles+="#":S.type!=chem.Struct.BOND.TYPE.AROMATIC||this.atoms[S.begin].lowercase&&this.atoms[S.end].lowercase&&this.isBondInRing(h)?S.type==chem.Struct.BOND.TYPE.SINGLE&&this.atoms[S.begin].aromatic&&this.atoms[S.end].aromatic?this.smiles+="-":x=!1:this.smiles+=":",l.edgeClosingCycle(h)){for(n=1;n<b.length&&b[n]!=c;n++);if(n==b.length)throw new Error("cycle number not found");this._writeCycleNumber(n),b[n]=-1,y=!1}}else v||(this.smiles+=this._written_components==l.nComponentsInReactants?">>":"."),v=!1,this._written_components++;y&&(this._writeAtom(t,c,this.atoms[c].aromatic,this.atoms[c].lowercase,this.atoms[c].chirality),this._written_atoms.push(u.idx))}return this.comma=!1,this._writeRadicals(t),this.comma&&(this.smiles+="|"),this.smiles},chem.SmilesSaver.prototype._writeCycleNumber=function(t){if(t>0&&10>t)this.smiles+=t;else if(t>=10&&100>t)this.smiles+="%"+t;else{if(!(t>=100&&1e3>t))throw new Error("bad cycle number: "+t);this.smiles+="%%"+t}},chem.SmilesSaver.prototype._writeAtom=function(t,e,i,n,r){var o=t.atoms.get(e),s=!1,a=-1,l=0;if("A"==o.label)return void(this.smiles+="*");if("R"==o.label||"R#"==o.label)return void(this.smiles+="[*]");l=o.aam,"C"!=o.label&&"P"!=o.label&&"N"!=o.label&&"S"!=o.label&&"O"!=o.label&&"Cl"!=o.label&&"F"!=o.label&&"Br"!=o.label&&"B"!=o.label&&"I"!=o.label&&(s=!0),(o.explicitValence>=0||0!=o.radical||r>0||i&&"C"!=o.label&&"O"!=o.label||i&&"C"==o.label&&this.atoms[e].neighbours.length<3&&0==this.atoms[e].h_count)&&(a=this.atoms[e].h_count);var u=o.label;if(o.atomList&&!o.atomList.notList?(u=o.atomList.label(),s=!1):o.isPseudo()||o.atomList&&o.atomList.notList?(u="*",s=!0):(r||0!=o.charge||o.isotope>0||a>=0||l>0)&&(s=!0),s&&(-1==a&&(a=this.atoms[e].h_count),this.smiles+="["),o.isotope>0&&(this.smiles+=o.isotope),n?this.smiles+=u.toLowerCase():this.smiles+=u,r>0&&(1==r?this.smiles+="@":this.smiles+="@@",o.implicitH>1))throw new Error(o.implicitH+" implicit H near stereocenter");"H"!=o.label&&(a>1||0==a&&!s?this.smiles+="H"+a:1==a&&(this.smiles+="H")),o.charge>1?this.smiles+="+"+o.charge:o.charge<-1?this.smiles+=o.charge:1==o.charge?this.smiles+="+":-1==o.charge&&(this.smiles+="-"),l>0&&(this.smiles+=":"+l),s&&(this.smiles+="]")},chem.SmilesSaver.prototype._markCisTrans=function(t){this.cis_trans=new chem.CisTrans(t,function(t){return this.atoms[t].neighbours},this),this.cis_trans.build(),this._dbonds=new Array(t.bonds.count()),t.bonds.each(function(t){this._dbonds[t]={ctbond_beg:-1,ctbond_end:-1,saved:0}},this),this.cis_trans.each(function(e,i){var n=t.bonds.get(e);if(0!=i.parity&&!this.isBondInRing(e)){var r=this.atoms[n.begin].neighbours,o=this.atoms[n.end].neighbours,s=!0,a=!0;if(r.each(function(i){i.bid!=e&&t.bonds.get(i.bid).type==chem.Struct.BOND.TYPE.SINGLE&&(s=!1)},this),o.each(function(i){i.bid!=e&&t.bonds.get(i.bid).type==chem.Struct.BOND.TYPE.SINGLE&&(a=!1)},this),s||a)return;r.each(function(i){i.bid!=e&&(t.bonds.get(i.bid).begin==n.begin?this._dbonds[i.bid].ctbond_beg=e:this._dbonds[i.bid].ctbond_end=e)},this),o.each(function(i){i.bid!=e&&(t.bonds.get(i.bid).begin==n.end?this._dbonds[i.bid].ctbond_beg=e:this._dbonds[i.bid].ctbond_end=e)},this)}},this)},chem.SmilesSaver.prototype._updateSideBonds=function(t,e){var i=t.bonds.get(e),n=this.cis_trans.getSubstituents(e),r=this.cis_trans.getParity(e),o=[-1,-1,-1,-1];o[0]=t.findBondId(n[0],i.begin),-1!=n[1]&&(o[1]=t.findBondId(n[1],i.begin)),o[2]=t.findBondId(n[2],i.end),-1!=n[3]&&(o[3]=t.findBondId(n[3],i.end));var s=0,a=0,l=0,u=0;if(0!=this._dbonds[o[0]].saved&&(1==this._dbonds[o[0]].saved&&t.bonds.get(o[0]).begin==i.begin||2==this._dbonds[o[0]].saved&&t.bonds.get(o[0]).end==i.begin?s++:a++),-1!=o[1]&&0!=this._dbonds[o[1]].saved&&(2==this._dbonds[o[1]].saved&&t.bonds.get(o[1]).begin==i.begin||1==this._dbonds[o[1]].saved&&t.bonds.get(o[1]).end==i.begin?s++:a++),0!=this._dbonds[o[2]].saved&&(1==this._dbonds[o[2]].saved&&t.bonds.get(o[2]).begin==i.end||2==this._dbonds[o[2]].saved&&t.bonds.get(o[2]).end==i.end?l++:u++),-1!=o[3]&&0!=this._dbonds[o[3]].saved&&(2==this._dbonds[o[3]].saved&&t.bonds.get(o[3]).begin==i.end||1==this._dbonds[o[3]].saved&&t.bonds.get(o[3]).end==i.end?l++:u++),r==chem.CisTrans.PARITY.CIS?(s+=l,a+=u):(s+=u,a+=l),s>0&&a>0)throw new Error("incompatible cis-trans configuration");return 0==s&&0==a?!1:(s>0&&(this._dbonds[o[0]].saved=t.bonds.get(o[0]).begin==i.begin?1:2,-1!=o[1]&&(this._dbonds[o[1]].saved=t.bonds.get(o[1]).begin==i.begin?2:1),this._dbonds[o[2]].saved=t.bonds.get(o[2]).begin==i.end==(r==chem.CisTrans.PARITY.CIS)?1:2,-1!=o[3]&&(this._dbonds[o[3]].saved=t.bonds.get(o[3]).begin==i.end==(r==chem.CisTrans.PARITY.CIS)?2:1)),a>0&&(this._dbonds[o[0]].saved=t.bonds.get(o[0]).begin==i.begin?2:1,-1!=o[1]&&(this._dbonds[o[1]].saved=t.bonds.get(o[1]).begin==i.begin?1:2),this._dbonds[o[2]].saved=t.bonds.get(o[2]).begin==i.end==(r==chem.CisTrans.PARITY.CIS)?2:1,-1!=o[3]&&(this._dbonds[o[3]].saved=t.bonds.get(o[3]).begin==i.end==(r==chem.CisTrans.PARITY.CIS)?1:2)),!0)},chem.SmilesSaver.prototype._calcBondDirection=function(t,e,i){var n;if(-1==this._dbonds[e].ctbond_beg&&-1==this._dbonds[e].ctbond_end)return 0;if(t.bonds.get(e).type!=chem.Struct.BOND.TYPE.SINGLE)throw new Error("internal: directed bond type "+t.bonds.get(e).type);for(;;){if(n=0,this.cis_trans.each(function(e,i){0==i.parity||this.isBondInRing(e)||this._updateSideBonds(t,e)&&n++},this),n==this._touched_cistransbonds)break;this._touched_cistransbonds=n}return 0==this._dbonds[e].saved&&(i==t.bonds.get(e).begin?this._dbonds[e].saved=1:this._dbonds[e].saved=2),this._dbonds[e].saved},chem.SmilesSaver.prototype._writeRadicals=function(t){var e,i,n=new Array(this._written_atoms.length);for(e=0;e<this._written_atoms.size();e++)if(!n[e]){var r=t.atoms.get(this._written_atoms[e]).radical;if(0!=r)for(this.comma?this.smiles+=",":(this.smiles+=" |",this.comma=!0),r==chem.Struct.ATOM.RADICAL.SINGLET?this.smiles+="^3:":r==chem.Struct.ATOM.RADICAL.DOUPLET?this.smiles+="^1:":this.smiles+="^4:",this.smiles+=e,i=e+1;i<this._written_atoms.length;i++)t.atoms.get(this._written_atoms[i]).radical==r&&(n[i]=!0,this.smiles+=","+i)}},!window.chem||!chem.Struct)throw new Error("chem.Molecule should be defined first");if(chem.InChiSaver=function(){},chem.InChiSaver.prototype.saveMolecule=function(t){var e="",i=null;if(ui.standalone)throw{message:"InChI is not supported in the standalone mode"};if(0!==t.rgroups.count()&&alert("R-group fragments are not supported and will be discarded"),t=t.getScaffold(),0===t.atoms.count())return e;t=t.clone(),t.sgroups.each(function(t,e){if("MUL"!==e.type)throw{message:"InChi data format doesn't support s-groups"}},this);var n=(new chem.MolfileSaver).saveMolecule(t);if(new Ajax.Request(ui.api_path+"getinchi",{method:"post",asynchronous:!1,parameters:{moldata:n},onComplete:function(t){t.responseText.startsWith("Ok.")?e=t.responseText.split("\n")[1]:i=t.responseText.startsWith("Error.")?{message:t.responseText.split("\n")[1]}:{message:"Unexpected server message ("+t.responseText+")"}}}),i)throw i;return e},!window.chem||!util.Vec2||!chem.Struct)throw new Error("Vec2 and Molecule, should be defined first");if(window.rnd||(rnd={}),rnd.Visel=function(t){this.type=t,this.paths=[],this.boxes=[],this.boundingBox=null},rnd.Visel.TYPE={ATOM:1,BOND:2,LOOP:3,ARROW:4,PLUS:5,SGROUP:6,TMP:7,FRAGMENT:8,RGROUP:9,CHIRAL_FLAG:10},rnd.Visel.prototype.add=function(t,e,i){this.paths.push(t),e&&(this.boxes.push(e),this.boundingBox=null==this.boundingBox?e:util.Box2Abs.union(this.boundingBox,e)),i&&this.exts.push(i)},rnd.Visel.prototype.clear=function(){this.paths=[],this.boxes=[],this.exts=[],this.boundingBox=null},rnd.Visel.prototype.translate=function(t,e){if(1===arguments.length)e=t.y,t=t.x;else if(2!==arguments.length)throw new Error("One vector or two scalar arguments expected");for(var i=0;i<this.paths.length;++i)this.paths[i].translateAbs(t,e);for(var n=new util.Vec2(t,e),r=0;r<this.boxes.length;++r)this.boxes[r]=this.boxes[r].translate(n);null!==this.boundingBox&&(this.boundingBox=this.boundingBox.translate(n))},!(window.chem&&util.Vec2&&chem.Struct&&window.rnd&&rnd.Visel))throw new Error("Vec2, Molecule and Visel should be defined first");if(window.rnd||(rnd={}),Raphael.el.translateAbs=function(t,e){this.delta=this.delta||new util.Vec2,this.delta.x+=t-0,this.delta.y+=e-0,this.transform("t"+this.delta.x.toString()+","+this.delta.y.toString())},Raphael.st.translateAbs=function(t,e){this.forEach(function(i){i.translateAbs(t,e)})},rnd.ReObject=function(){this.__ext=new util.Vec2(.05*3,.05*3)},rnd.ReObject.prototype.init=function(t){this.visel=new rnd.Visel(t),this.highlight=!1,this.highlighting=null,this.selected=!1,this.selectionPlate=null},rnd.ReObject.prototype.getVBoxObj=function(t){var e=this.visel.boundingBox;return util.isNull(e)?null:(t.offset&&(e=e.translate(t.offset.negated())),e.transform(t.scaled2obj,t))},rnd.ReObject.prototype.drawHighlight=function(t){},rnd.ReObject.prototype.setHighlight=function(t,e){if(t){var i="highlighting"in this&&null!=this.highlighting;i&&(i="set"==this.highlighting.type?!this.highlighting[0].removed:!this.highlighting.removed),i=i&&(!("hiddenPaths"in rnd.ReStruct.prototype)||rnd.ReStruct.prototype.hiddenPaths.indexOf(this.highlighting)<0),i?this.highlighting.show():(e.paper.setStart(),this.drawHighlight(e),this.highlighting=e.paper.setFinish())}else this.highlighting&&this.highlighting.hide();this.highlight=t},rnd.ReObject.prototype.makeSelectionPlate=function(t){},rnd.ReAtom=function(t){this.init(rnd.Visel.TYPE.ATOM),this.a=t,this.showLabel=!1,this.hydrogenOnTheLeft=!1,this.component=-1},rnd.ReAtom.prototype=new rnd.ReObject,rnd.ReAtom.isSelectable=function(){return!0},rnd.ReAtom.prototype.getVBoxObj=function(t){return this.visel.boundingBox?rnd.ReObject.prototype.getVBoxObj.call(this,t):new util.Box2Abs(this.a.pp,this.a.pp)},rnd.ReAtom.prototype.drawHighlight=function(t){var e=this.makeHighlightPlate(t);return t.ctab.addReObjectPath("highlighting",this.visel,e),e},rnd.ReAtom.prototype.makeHighlightPlate=function(t){var e=t.paper,i=t.styles,n=t.ps(this.a.pp);return e.circle(n.x,n.y,i.atomSelectionPlateRadius).attr(i.highlightStyle)},rnd.ReAtom.prototype.makeSelectionPlate=function(t,e,i){var n=t.render.ps(this.a.pp);return e.circle(n.x,n.y,i.atomSelectionPlateRadius).attr(i.selectionStyle)},rnd.ReBond=function(t){this.init(rnd.Visel.TYPE.BOND),this.b=t,this.doubleBondShift=0},rnd.ReBond.prototype=new rnd.ReObject,rnd.ReBond.isSelectable=function(){return!0},rnd.ReBond.prototype.drawHighlight=function(t){var e=this.makeHighlightPlate(t);return t.ctab.addReObjectPath("highlighting",this.visel,e),e},rnd.ReBond.prototype.makeHighlightPlate=function(t){t.ctab.bondRecalc(t.settings,this);var e=t.ps(this.b.center);return t.paper.circle(e.x,e.y,.8*t.styles.atomSelectionPlateRadius).attr(t.styles.highlightStyle)},rnd.ReBond.prototype.makeSelectionPlate=function(t,e,i){t.bondRecalc(t.render.settings,this);var n=t.render.ps(this.b.center);return e.circle(n.x,n.y,.8*i.atomSelectionPlateRadius).attr(i.selectionStyle)},rnd.ReStruct=function(t,e,i){this.render=e,this.atoms=new util.Map,this.bonds=new util.Map,this.reloops=new util.Map,this.rxnPluses=new util.Map,this.rxnArrows=new util.Map,this.frags=new util.Map,this.rgroups=new util.Map,this.sgroups=new util.Map,this.sgroupData=new util.Map,this.chiralFlags=new util.Map,this.molecule=t||new chem.Struct,this.initialized=!1,this.layers=[],this.initLayers(),this.connectedComponents=new util.Pool,this.ccFragmentType=new util.Map;for(var n in rnd.ReStruct.maps)this[n+"Changed"]={};if(this.structChanged=!1,t.atoms.each(function(t,e){this.atoms.set(t,new rnd.ReAtom(e))},this),t.bonds.each(function(t,e){this.bonds.set(t,new rnd.ReBond(e))},this),t.loops.each(function(t,e){this.reloops.set(t,new rnd.ReLoop(e))},this),t.rxnPluses.each(function(t,e){this.rxnPluses.set(t,new rnd.ReRxnPlus(e))},this),t.rxnArrows.each(function(t,e){this.rxnArrows.set(t,new rnd.ReRxnArrow(e))},this),t.frags.each(function(t,e){this.frags.set(t,new rnd.ReFrag(e))},this),t.rgroups.each(function(t,e){this.rgroups.set(t,new rnd.ReRGroup(e))},this),t.sgroups.each(function(t,e){this.sgroups.set(t,new rnd.ReSGroup(e)),"DAT"!=e.type||e.data.attached||this.sgroupData.set(t,new rnd.ReDataSGroupData(e))},this),t.isChiral){var r=t.getCoordBoundingBox();this.chiralFlags.set(0,new rnd.ReChiralFlag(new util.Vec2(r.max.x,r.min.y-1)))}this.coordProcess(i)},rnd.ReStruct.prototype.connectedComponentRemoveAtom=function(t,e){if(e=e||this.atoms.get(t),!(e.component<0)){var i=this.connectedComponents.get(e.component);util.Set.remove(i,t),util.Set.size(i)<1&&this.connectedComponents.remove(e.component),e.component=-1}},rnd.ReStruct.prototype.printConnectedComponents=function(){var t=[];this.connectedComponents.each(function(e,i){t.push(" "+e+":["+util.Set.list(i).toString()+"]."+util.Set.size(i).toString())},this)},rnd.ReStruct.prototype.clearConnectedComponents=function(){this.connectedComponents.clear(),this.atoms.each(function(t,e){e.component=-1})},rnd.ReStruct.prototype.getConnectedComponent=function(t,e){for(var i="number"==typeof t.length?util.array(t):[t],n=util.Set.empty();i.length>0;)(function(){var t=i.pop();util.Set.add(n,t);var r=this.atoms.get(t);r.component>=0&&util.Set.add(e,r.component);for(var o=0;o<r.a.neighbors.length;++o){var s=this.molecule.halfBonds.get(r.a.neighbors[o]).end;util.Set.contains(n,s)||i.push(s)}}).apply(this);return n},rnd.ReStruct.prototype.addConnectedComponent=function(t){var e=this.connectedComponents.add(t),i=util.Set.empty(),n=this.getConnectedComponent(util.Set.list(t),i);util.Set.remove(i,e);var r=-1;return util.Set.each(n,function(t){var i=this.atoms.get(t);if(i.component=e,-1!=i.a.rxnFragmentType){if(-1!=r&&i.a.rxnFragmentType!=r)throw new Error("reaction fragment type mismatch");r=i.a.rxnFragmentType}},this),this.ccFragmentType.set(e,r),e},rnd.ReStruct.prototype.removeConnectedComponent=function(t){return util.Set.each(this.connectedComponents.get(t),function(t){this.atoms.get(t).component=-1},this),this.connectedComponents.remove(t)},rnd.ReStruct.prototype.connectedComponentMergeIn=function(t,e){util.Set.each(e,function(e){this.atoms.get(e).component=t},this),util.Set.mergeIn(this.connectedComponents.get(t),e)},rnd.ReStruct.prototype.assignConnectedComponents=function(){this.atoms.each(function(t,e){if(!(e.component>=0)){var i=util.Set.empty(),n=this.getConnectedComponent(t,i);util.Set.each(i,function(t){this.removeConnectedComponent(t)},this),this.addConnectedComponent(n)}},this)},rnd.ReStruct.prototype.connectedComponentGetBoundingBox=function(t,e,i){return e=e||this.connectedComponents.get(t),i=i||{min:null,max:null},util.Set.each(e,function(t){var e=this.render.ps(this.atoms.get(t).a.pp);null==i.min?i.min=i.max=e:(i.min=i.min.min(e),i.max=i.max.max(e))},this),i},rnd.ReStruct.prototype.initLayers=function(){for(var t in rnd.ReStruct.layerMap)this.layers[rnd.ReStruct.layerMap[t]]=this.render.paper.rect(0,0,10,10).attr({fill:"#000",opacity:"0.0"}).toFront()},rnd.ReStruct.prototype.insertInLayer=function(t,e){e.insertBefore(this.layers[t])},rnd.ReStruct.prototype.clearMarks=function(){for(var t in rnd.ReStruct.maps)this[t+"Changed"]={};this.structChanged=!1},rnd.ReStruct.prototype.markItemRemoved=function(){this.structChanged=!0},rnd.ReStruct.prototype.markBond=function(t,e){this.markItem("bonds",t,e)},rnd.ReStruct.prototype.markAtom=function(t,e){this.markItem("atoms",t,e)},rnd.ReStruct.prototype.markItem=function(t,e,i){var n=this[t+"Changed"];n[e]="undefined"!=typeof n[e]?Math.max(i,n[e]):i,this[t].has(e)&&this.clearVisel(this[t].get(e).visel)},rnd.ReStruct.prototype.eachVisel=function(t,e){for(var i in rnd.ReStruct.maps)this[i].each(function(i,n){t.call(e,n.visel)},this)},rnd.ReStruct.prototype.getVBoxObj=function(t){if(t=t||{},this.selectionIsEmpty(t))for(var e in rnd.ReStruct.maps)t[e]=this[e].keys();var i=null;for(var e in rnd.ReStruct.maps)t[e]&&util.each(t[e],function(t){var n=this[e].get(t).getVBoxObj(this.render);n&&(i=i?util.Box2Abs.union(i,n):n.clone())},this);return i=i||new util.Box2Abs(0,0,0,0)},rnd.ReStruct.prototype.selectionIsEmpty=function(t){if(util.assert(!util.isUndefined(t),"'selection' is not defined"),util.isNull(t))return!0;for(var e in rnd.ReStruct.maps)if(t[e]&&t[e].length>0)return!1;return!0},rnd.ReStruct.prototype.translate=function(t){this.eachVisel(function(e){e.translate(t)},this)},rnd.ReStruct.prototype.scale=function(t){this.eachVisel(function(e){this.scaleVisel(e,t)},this)},rnd.ReStruct.prototype.scaleRPath=function(t,e){if("set"==t.type)for(var i=0;i<t.length;++i)this.scaleRPath(t[i],e);else Object.isUndefined(t.attrs)||("font-size"in t.attrs?t.attr("font-size",t.attrs["font-size"]*e):"stroke-width"in t.attrs&&t.attr("stroke-width",t.attrs["stroke-width"]*e)),t.scale(e,e,0,0)},rnd.ReStruct.prototype.scaleVisel=function(t,e){for(var i=0;i<t.paths.length;++i)this.scaleRPath(t.paths[i],e)},rnd.ReStruct.prototype.clearVisels=function(){this.eachVisel(function(t){this.clearVisel(t)},this)},rnd.ReStruct.prototype.findIncomingStereoUpBond=function(t,e,i){return util.find(t.neighbors,function(t){var n=this.molecule.halfBonds.get(t),r=n.bid;if(r===e)return!1;var o=this.bonds.get(r);return o.b.type===chem.Struct.BOND.TYPE.SINGLE&&o.b.stereo===chem.Struct.BOND.STEREO.UP?o.b.end===n.begin||o.boldStereo&&i:o.b.type===chem.Struct.BOND.TYPE.DOUBLE&&o.b.stereo===chem.Struct.BOND.STEREO.NONE&&i&&o.boldStereo?!0:!1},this)},rnd.ReStruct.prototype.checkStereoBold=function(t,e){var i=util.map([e.b.begin,e.b.end],function(e){var i=this.molecule.atoms.get(e),n=this.findIncomingStereoUpBond(i,t,!1);return 0>n?-1:i.neighbors[n]},this);util.assert(2===i.length),e.boldStereo=i[0]>=0&&i[1]>=0},rnd.ReStruct.prototype.findIncomingUpBonds=function(t,e){var i=util.map([e.b.begin,e.b.end],function(e){var i=this.molecule.atoms.get(e),n=this.findIncomingStereoUpBond(i,t,!0);return 0>n?-1:i.neighbors[n]},this);util.assert(2===i.length),e.neihbid1=this.atoms.get(e.b.begin).showLabel?-1:i[0],e.neihbid2=this.atoms.get(e.b.end).showLabel?-1:i[1]},rnd.ReStruct.prototype.checkStereoBoldBonds=function(){this.bonds.each(this.checkStereoBold,this)},rnd.ReStruct.prototype.update=function(t){t=t||!this.initialized;var e;t?function(){for(var t in rnd.ReStruct.maps){var e=this[t+"Changed"];this[t].each(function(t){e[t]=1},this)}}.call(this):function(){for(var t in rnd.ReStruct.maps){var i=this[t+"Changed"];for(e in i)this[t].has(e)||delete i[e]}}.call(this);for(e in this.atomsChanged)this.connectedComponentRemoveAtom(e);for(var i=this.frags.findAll(function(t,e){return!e.calcBBox(this.render,t)},this),n=0;n<i.length;++n){var r=i[n];this.clearVisel(this.frags.get(r).visel),this.frags.unset(r),this.molecule.frags.remove(r)}(function(){for(var t in rnd.ReStruct.maps){var i=this[t+"Changed"];for(e in i)this.clearVisel(this[t].get(e).visel),this.structChanged|=i[e]>0}}).call(this),this.sgroups.each(function(t,e){this.clearVisel(e.visel),e.highlighting=null,e.selectionPlate=null},this),this.frags.each(function(t,e){this.clearVisel(e.visel)},this),this.rgroups.each(function(t,e){this.clearVisel(e.visel)},this),t&&(this.clearConnectedComponents(),this.molecule.initHalfBonds(),this.molecule.initNeighbors()),this.molecule.updateHalfBonds(new util.Map(this.atomsChanged).findAll(function(t,e){return e>=0},this)),this.molecule.sortNeighbors(new util.Map(this.atomsChanged).findAll(function(t,e){return e>=1},this)),this.assignConnectedComponents(),this.setImplicitHydrogen(),this.setHydrogenPos(),this.initialized=!0,this.verifyLoops();var o=t||this.structChanged;return o&&this.updateLoops(),this.setDoubleBondShift(),this.checkLabelsToShow(),this.checkStereoBoldBonds(),this.showLabels(),this.showBonds(),o&&this.renderLoops(),this.drawReactionSymbols(),this.drawSGroups(),this.drawFragments(),this.drawRGroups(),this.chiralFlags.each(function(t,e){this.chiralFlagsChanged[t]>0&&e.draw(this.render)},this),this.clearMarks(),!0},rnd.ReStruct.prototype.drawReactionSymbols=function(){var t,e;for(e in this.rxnArrowsChanged)t=this.rxnArrows.get(e),this.drawReactionArrow(e,t);for(e in this.rxnPlusesChanged)t=this.rxnPluses.get(e),this.drawReactionPlus(e,t)},rnd.ReStruct.prototype.drawReactionArrow=function(t,e){var i=this.render.ps(e.item.pp),n=this.drawArrow(new util.Vec2(i.x-this.render.scale,i.y),new util.Vec2(i.x+this.render.scale,i.y));e.visel.add(n,util.Box2Abs.fromRelBox(rnd.relBox(n.getBBox())));var r=this.render.offset;null!=r&&n.translateAbs(r.x,r.y)},rnd.ReStruct.prototype.drawReactionPlus=function(t,e){var i=this.render.ps(e.item.pp),n=this.drawPlus(i);e.visel.add(n,util.Box2Abs.fromRelBox(rnd.relBox(n.getBBox())));var r=this.render.offset;null!=r&&n.translateAbs(r.x,r.y)},rnd.ReStruct.prototype.drawSGroups=function(){util.each(this.molecule.sGroupForest.getSGroupsBFS().reverse(),function(t){var e=this.sgroups.get(t),i=e.draw(this.render);this.addReObjectPath("data",e.visel,i,null,!0),e.setHighlight(e.highlight,this.render)},this)},rnd.ReStruct.prototype.drawFragments=function(){this.frags.each(function(t,e){var i=e.draw(this.render,t);i&&this.addReObjectPath("data",e.visel,i,null,!0)},this)},rnd.ReStruct.prototype.drawRGroups=function(){this.rgroups.each(function(t,e){var i=e.draw(this.render);for(var n in i)for(;i[n].length>0;)this.addReObjectPath(n,e.visel,i[n].shift(),null,!0)},this)},rnd.ReStruct.prototype.eachCC=function(t,e,i){this.connectedComponents.each(function(n,r){e&&this.ccFragmentType.get(n)!=e||t.call(i||this,n,r)},this)},rnd.ReStruct.prototype.getGroupBB=function(t){var e={min:null,max:null};return this.eachCC(function(t,i){e=this.connectedComponentGetBoundingBox(t,i,e)},t,this),e},rnd.ReStruct.prototype.setHydrogenPos=function(){for(var t in this.atomsChanged){var e=this.atoms.get(t);if(0!=e.a.neighbors.length){for(var i=1,n=1,r=0,o=0,s=0;s<e.a.neighbors.length;++s){var a=this.molecule.halfBonds.get(e.a.neighbors[s]).dir;a.x<=0?(i=Math.min(i,Math.abs(a.y)),r++):(n=Math.min(n,Math.abs(a.y)),o++)}.51>i||.51>n?e.hydrogenOnTheLeft=i>n:e.hydrogenOnTheLeft=o>r}else{var l=chem.Element.getElementByLabel(e.a.label);null!=l&&(e.hydrogenOnTheLeft=chem.Element.elements.get(l).putHydrogenOnTheLeft)}}},rnd.ReStruct.prototype.setImplicitHydrogen=function(){for(var t in this.atomsChanged)this.molecule.calcImplicitHydrogen(t)},rnd.ReLoop=function(t){this.loop=t,this.visel=new rnd.Visel(rnd.Visel.TYPE.LOOP),this.centre=new util.Vec2,this.radius=new util.Vec2},rnd.ReLoop.prototype=new rnd.ReObject,rnd.ReLoop.isSelectable=function(){return!1},rnd.ReStruct.prototype.coordProcess=function(t){t||this.molecule.rescale()},rnd.ReStruct.prototype.notifyAtomAdded=function(t){var e=new rnd.ReAtom(this.molecule.atoms.get(t));e.component=this.connectedComponents.add(util.Set.single(t)),this.atoms.set(t,e),this.markAtom(t,1)},rnd.ReStruct.prototype.notifyRxnPlusAdded=function(t){this.rxnPluses.set(t,new rnd.ReRxnPlus(this.molecule.rxnPluses.get(t)))},rnd.ReStruct.prototype.notifyRxnArrowAdded=function(t){this.rxnArrows.set(t,new rnd.ReRxnArrow(this.molecule.rxnArrows.get(t)))},rnd.ReStruct.prototype.notifyRxnArrowRemoved=function(t){this.markItemRemoved(),this.clearVisel(this.rxnArrows.get(t).visel),this.rxnArrows.unset(t)},rnd.ReStruct.prototype.notifyRxnPlusRemoved=function(t){this.markItemRemoved(),this.clearVisel(this.rxnPluses.get(t).visel),this.rxnPluses.unset(t)},rnd.ReStruct.prototype.notifyBondAdded=function(t){this.bonds.set(t,new rnd.ReBond(this.molecule.bonds.get(t))),this.markBond(t,1)},rnd.ReStruct.prototype.notifyAtomRemoved=function(t){var e=this.atoms.get(t),i=this.connectedComponents.get(e.component);util.Set.remove(i,t),0==util.Set.size(i)&&this.connectedComponents.remove(e.component),this.clearVisel(e.visel),this.atoms.unset(t),this.markItemRemoved()},rnd.ReStruct.prototype.notifyBondRemoved=function(t){var e=this.bonds.get(t);[e.b.hb1,e.b.hb2].each(function(t){var e=this.molecule.halfBonds.get(t);e.loop>=0&&this.loopRemove(e.loop)},this),this.clearVisel(e.visel),this.bonds.unset(t),this.markItemRemoved()},rnd.ReStruct.prototype.loopRemove=function(t){if(this.reloops.has(t)){var e=this.reloops.get(t);this.clearVisel(e.visel);for(var i=[],n=0;n<e.loop.hbs.length;++n){var r=e.loop.hbs[n];if(this.molecule.halfBonds.has(r)){var o=this.molecule.halfBonds.get(r);o.loop=-1,this.markBond(o.bid,1),this.markAtom(o.begin,1),i.push(o.bid)}}this.reloops.unset(t),this.molecule.loops.remove(t)}},rnd.ReStruct.prototype.loopIsValid=function(t,e){var i=this.molecule.halfBonds,n=e.loop,r=!1;return n.hbs.each(function(e){i.has(e)&&i.get(e).loop===t||(r=!0)},this),!r},rnd.ReStruct.prototype.verifyLoops=function(){var t=[];this.reloops.each(function(e,i){this.loopIsValid(e,i)||t.push(e)},this);for(var e=0;e<t.length;++e)this.loopRemove(t[e])},rnd.ReStruct.prototype.BFS=function(t,e,i){e-=0;var n=new Array,r={};for(n.push(e),r[e]=1;n.length>0;){var o=n.shift();t.call(i,o);for(var s=this.atoms.get(o),a=0;a<s.a.neighbors.length;++a){var l=s.a.neighbors[a],u=this.molecule.halfBonds.get(l);r[u.end]||(r[u.end]=1,n.push(u.end))}}},rnd.ReRxnPlus=function(t){this.init(rnd.Visel.TYPE.PLUS),this.item=t},rnd.ReRxnPlus.prototype=new rnd.ReObject,rnd.ReRxnPlus.isSelectable=function(){return!0},rnd.ReRxnPlus.findClosest=function(t,e){var i,n;return t.ctab.rxnPluses.each(function(t,r){var o=r.item.pp,s=Math.max(Math.abs(e.x-o.x),Math.abs(e.y-o.y));.5>s&&(!n||i>s)&&(i=s,n={id:t,dist:i})}),n},rnd.ReRxnPlus.prototype.highlightPath=function(t){var e=t.ps(this.item.pp),i=t.settings.scaleFactor;return t.paper.rect(e.x-i/4,e.y-i/4,i/2,i/2,i/8)},rnd.ReRxnPlus.prototype.drawHighlight=function(t){var e=this.highlightPath(t).attr(t.styles.highlightStyle);return t.ctab.addReObjectPath("highlighting",this.visel,e),e},rnd.ReRxnPlus.prototype.makeSelectionPlate=function(t,e,i){return this.highlightPath(t.render).attr(i.selectionStyle)},rnd.ReRxnArrow=function(t){this.init(rnd.Visel.TYPE.ARROW),this.item=t},rnd.ReRxnArrow.prototype=new rnd.ReObject,rnd.ReRxnArrow.isSelectable=function(){return!0},rnd.ReRxnArrow.findClosest=function(t,e){var i,n;return t.ctab.rxnArrows.each(function(t,r){var o=r.item.pp;if(Math.abs(e.x-o.x)<1){var s=Math.abs(e.y-o.y);.3>s&&(!n||i>s)&&(i=s,n={id:t,dist:i})}}),n},rnd.ReRxnArrow.prototype.highlightPath=function(t){var e=t.ps(this.item.pp),i=t.settings.scaleFactor;return t.paper.rect(e.x-i,e.y-i/4,2*i,i/2,i/8)},rnd.ReRxnArrow.prototype.drawHighlight=function(t){var e=this.highlightPath(t).attr(t.styles.highlightStyle);return t.ctab.addReObjectPath("highlighting",this.visel,e),e},rnd.ReRxnArrow.prototype.makeSelectionPlate=function(t,e,i){return this.highlightPath(t.render).attr(i.selectionStyle)},rnd.ReFrag=function(t){this.init(rnd.Visel.TYPE.FRAGMENT),this.item=t},rnd.ReFrag.prototype=new rnd.ReObject,rnd.ReFrag.isSelectable=function(){return!1},rnd.ReFrag.findClosest=function(t,e,i,n){n=Math.min(n||t.opt.selectionDistanceCoefficient,t.opt.selectionDistanceCoefficient);var r;return t.ctab.frags.each(function(o,s){if(o!=i){var a=s.calcBBox(t,o);if(a.p0.y<e.y&&a.p1.y>e.y&&a.p0.x<e.x&&a.p1.x>e.x){
var l=Math.min(Math.abs(a.p0.x-e.x),Math.abs(a.p1.x-e.x));(!r||n>l)&&(n=l,r={id:o,dist:n})}}}),r},rnd.ReFrag.prototype.fragGetAtoms=function(t,e){var i=[];return t.ctab.atoms.each(function(t,n){n.a.fragment==e&&i.push(t)},this),i},rnd.ReFrag.prototype.fragGetBonds=function(t,e){var i=[];return t.ctab.bonds.each(function(n,r){t.ctab.atoms.get(r.b.begin).a.fragment==e&&t.ctab.atoms.get(r.b.end).a.fragment==e&&i.push(n)},this),i},rnd.ReFrag.prototype.calcBBox=function(t,e){var i;return t.ctab.atoms.each(function(n,r){if(r.a.fragment==e){var o=r.visel.boundingBox;if(o)o=o.translate((t.offset||new util.Vec2).negated()).transform(t.scaled2obj,t);else{o=new util.Box2Abs(r.a.pp,r.a.pp);var s=new util.Vec2(.05*3,.05*3);o=o.extend(s,s)}i=i?util.Box2Abs.union(i,o):o}},this),i},rnd.ReFrag.prototype._draw=function(t,e,i){var n=this.calcBBox(t,e);if(n){var r=t.obj2scaled(new util.Vec2(n.p0.x,n.p0.y)),o=t.obj2scaled(new util.Vec2(n.p1.x,n.p1.y));return t.paper.rect(r.x,r.y,o.x-r.x,o.y-r.y,0).attr(i)}},rnd.ReFrag.prototype.draw=function(t){return null},rnd.ReFrag.prototype.drawHighlight=function(t){},rnd.ReFrag.prototype.setHighlight=function(t,e){var i=e.ctab.frags.keyOf(this);Object.isUndefined(i)||(e.ctab.atoms.each(function(n,r){r.a.fragment==i&&r.setHighlight(t,e)},this),e.ctab.bonds.each(function(n,r){e.ctab.atoms.get(r.b.begin).a.fragment==i&&r.setHighlight(t,e)},this))},rnd.ReRGroup=function(t){this.init(rnd.Visel.TYPE.RGROUP),this.labelBox=null,this.item=t},rnd.ReRGroup.prototype=new rnd.ReObject,rnd.ReRGroup.isSelectable=function(){return!1},rnd.ReRGroup.prototype.getAtoms=function(t){var e=[];return this.item.frags.each(function(i,n){e=e.concat(t.ctab.frags.get(n).fragGetAtoms(t,n))}),e},rnd.ReRGroup.prototype.getBonds=function(t){var e=[];return this.item.frags.each(function(i,n){e=e.concat(t.ctab.frags.get(n).fragGetBonds(t,n))}),e},rnd.ReRGroup.findClosest=function(t,e,i,n){n=Math.min(n||t.opt.selectionDistanceCoefficient,t.opt.selectionDistanceCoefficient);var r;return t.ctab.rgroups.each(function(t,o){if(t!=i&&o.labelBox&&o.labelBox.contains(e,.5)){var s=util.Vec2.dist(o.labelBox.centre(),e);(!r||n>s)&&(n=s,r={id:t,dist:n})}}),r},rnd.ReRGroup.prototype.calcBBox=function(t){var e;return this.item.frags.each(function(i,n){var r=t.ctab.frags.get(n).calcBBox(t,n);r&&(e=e?util.Box2Abs.union(e,r):r)}),e=e.extend(this.__ext,this.__ext)},rnd.ReRGroup.drawBrackets=function(t,e,i,n,r){n=n||new util.Vec2(1,0);var o=Math.min(.25,.3*i.sz().x),s=i.p1.y-i.p0.y,a=.5*(i.p1.y+i.p0.y),l=chem.SGroup.drawBracket(e,e.paper,e.styles,n.negated(),n.negated().rotateSC(1,0),new util.Vec2(i.p0.x,a),o,s),u=chem.SGroup.drawBracket(e,e.paper,e.styles,n,n.rotateSC(1,0),new util.Vec2(i.p1.x,a),o,s);t.push(l,u)},rnd.ReRGroup.prototype.draw=function(t){var e=this.calcBBox(t),i=t.settings;if(e){var n={data:[]},r=t.obj2scaled(e.p0),o=t.obj2scaled(e.p1),s=t.paper.set();rnd.ReRGroup.drawBrackets(s,t,e),n.data.push(s);var a=t.ctab.rgroups.keyOf(this),l=t.paper.set(),u=t.paper.text(r.x,(r.y+o.y)/2,"R"+a+"=").attr({font:i.font,"font-size":i.fontRLabel,fill:"black"}),c=rnd.relBox(u.getBBox());u.translateAbs(-c.width/2-i.lineWidth,0),l.push(u);var h={font:i.font,"font-size":i.fontRLogic,fill:"black"},d=[];d.push((this.item.ifthen>0?"IF ":"")+"R"+a.toString()+(this.item.range.length>0?this.item.range.startsWith(">")||this.item.range.startsWith("<")||this.item.range.startsWith("=")?this.item.range:"="+this.item.range:">0")+(this.item.resth?" (RestH)":"")+(this.item.ifthen>0?"\nTHEN R"+this.item.ifthen.toString():""));for(var p=c.height/2+i.lineWidth/2,f=0;f<d.length;++f){var m=t.paper.text(r.x,(r.y+o.y)/2,d[f]).attr(h),g=rnd.relBox(m.getBBox());p+=g.height/2,m.translateAbs(-g.width/2-6*i.lineWidth,p),p+=g.height/2+i.lineWidth/2,n.data.push(m),l.push(m)}return n.data.push(u),this.labelBox=util.Box2Abs.fromRelBox(l.getBBox()).transform(t.scaled2obj,t),n}return{}},rnd.ReRGroup.prototype._draw=function(t,e,i){var n=this.getVBoxObj(t).extend(this.__ext,this.__ext);if(n){var r=t.obj2scaled(n.p0),o=t.obj2scaled(n.p1);return t.paper.rect(r.x,r.y,o.x-r.x,o.y-r.y,0).attr(i)}},rnd.ReRGroup.prototype.drawHighlight=function(t){var e=t.ctab.rgroups.keyOf(this);if(!Object.isUndefined(e)){var i=this._draw(t,e,t.styles.highlightStyle);return t.ctab.addReObjectPath("highlighting",this.visel,i),this.item.frags.each(function(e,i){t.ctab.frags.get(i).drawHighlight(t)},this),i}},rnd.ReSGroup=function(t){this.init(rnd.Visel.TYPE.SGROUP),this.item=t},rnd.ReSGroup.prototype=new rnd.ReObject,rnd.ReSGroup.isSelectable=function(){return!1},rnd.ReSGroup.findClosest=function(t,e){var i=null,n=t.opt.selectionDistanceCoefficient;return t.ctab.molecule.sgroups.each(function(t,r){for(var o=r.bracketDir,s=o.rotateSC(1,0),a=new util.Vec2(util.Vec2.dot(e,o),util.Vec2.dot(e,s)),l=0;l<r.areas.length;++l){var u=r.areas[l],c=u.p0.y<a.y&&u.p1.y>a.y&&u.p0.x<a.x&&u.p1.x>a.x,h=Math.min(Math.abs(u.p0.x-a.x),Math.abs(u.p1.x-a.x));c&&(null==i||n>h)&&(i=t,n=h)}},this),null!=i?{id:i,dist:n}:null},rnd.ReSGroup.prototype.draw=function(t){return this.item.draw(t.ctab)},rnd.ReSGroup.prototype.drawHighlight=function(t){var e=t.styles,i=t.settings,n=t.paper,r=this.item,o=r.bracketBox.transform(t.obj2scaled,t),s=i.lineWidth,a=new util.Vec2(4*s,6*s);o=o.extend(a,a);var l=r.bracketDir,u=l.rotateSC(1,0),c=util.Vec2.lc2(l,o.p0.x,u,o.p0.y),h=util.Vec2.lc2(l,o.p0.x,u,o.p1.y),d=util.Vec2.lc2(l,o.p1.x,u,o.p0.y),p=util.Vec2.lc2(l,o.p1.x,u,o.p1.y),f=n.set();r.highlighting=n.path("M{0},{1}L{2},{3}L{4},{5}L{6},{7}L{0},{1}",tfx(c.x),tfx(c.y),tfx(h.x),tfx(h.y),tfx(p.x),tfx(p.y),tfx(d.x),tfx(d.y)).attr(e.highlightStyle),f.push(r.highlighting),chem.SGroup.getAtoms(t.ctab.molecule,r).each(function(e){f.push(t.ctab.atoms.get(e).makeHighlightPlate(t))},this),chem.SGroup.getBonds(t.ctab.molecule,r).each(function(e){f.push(t.ctab.bonds.get(e).makeHighlightPlate(t))},this),t.ctab.addReObjectPath("highlighting",this.visel,f)},rnd.ReDataSGroupData=function(t){this.init(rnd.Visel.TYPE.SGROUP_DATA),this.sgroup=t},rnd.ReDataSGroupData.prototype=new rnd.ReObject,rnd.ReDataSGroupData.isSelectable=function(){return!0},rnd.ReDataSGroupData.findClosest=function(t,e){var i=null,n=null;return t.ctab.sgroupData.each(function(t,r){if("DAT"!=r.sgroup.type)throw new Error("Data group expected");var o=r.sgroup.dataArea,s=o.p0.y<e.y&&o.p1.y>e.y&&o.p0.x<e.x&&o.p1.x>e.x,a=Math.min(Math.abs(o.p0.x-e.x),Math.abs(o.p1.x-e.x));s&&(null==n||i>a)&&(n={id:t,dist:a},i=a)}),n},rnd.ReDataSGroupData.prototype.highlightPath=function(t){var e=this.sgroup.dataArea,i=t.obj2scaled(e.p0),n=t.obj2scaled(e.p1).sub(i);return t.paper.rect(i.x,i.y,n.x,n.y)},rnd.ReDataSGroupData.prototype.drawHighlight=function(t){var e=this.highlightPath(t).attr(t.styles.highlightStyle);return t.ctab.addReObjectPath("highlighting",this.visel,e),e},rnd.ReDataSGroupData.prototype.makeSelectionPlate=function(t,e,i){return this.highlightPath(t.render).attr(i.selectionStyle)},rnd.ReChiralFlag=function(t){this.init(rnd.Visel.TYPE.CHIRAL_FLAG),this.pp=t},rnd.ReChiralFlag.prototype=new rnd.ReObject,rnd.ReChiralFlag.isSelectable=function(){return!0},rnd.ReChiralFlag.findClosest=function(t,e){var i,n;return t.ctab.chiralFlags.each(function(t,r){var o=r.pp;if(Math.abs(e.x-o.x)<1){var s=Math.abs(e.y-o.y);.3>s&&(!n||i>s)&&(i=s,n={id:t,dist:i})}}),n},rnd.ReChiralFlag.prototype.highlightPath=function(t){var e=util.Box2Abs.fromRelBox(this.path.getBBox()),i=e.p1.sub(e.p0),n=e.p0.sub(t.offset);return t.paper.rect(n.x,n.y,i.x,i.y)},rnd.ReChiralFlag.prototype.drawHighlight=function(t){var e=this.highlightPath(t).attr(t.styles.highlightStyle);return t.ctab.addReObjectPath("highlighting",this.visel,e),e},rnd.ReChiralFlag.prototype.makeSelectionPlate=function(t,e,i){return this.highlightPath(t.render).attr(i.selectionStyle)},rnd.ReChiralFlag.prototype.draw=function(t){var e=t.paper,i=t.settings,n=t.ps(this.pp);this.path=e.text(n.x,n.y,"Chiral").attr({font:i.font,"font-size":i.fontsz,fill:"#000"}),t.ctab.addReObjectPath("data",this.visel,this.path,null,!0)},rnd.ReStruct.maps={atoms:rnd.ReAtom,bonds:rnd.ReBond,rxnPluses:rnd.ReRxnPlus,rxnArrows:rnd.ReRxnArrow,frags:rnd.ReFrag,rgroups:rnd.ReRGroup,sgroupData:rnd.ReDataSGroupData,chiralFlags:rnd.ReChiralFlag,sgroups:rnd.ReSGroup,reloops:rnd.ReLoop},!window.rnd||!rnd.ReStruct)throw new Error("MolData should be defined first");rnd.relBox=function(t){return{x:t.x,y:t.y,width:t.width,height:t.height}},rnd.ReStruct.prototype.drawArrow=function(t,e){var i=5,n=7,r=this.render.paper,o=this.render.styles;return r.path("M{0},{1}L{2},{3}L{4},{5}M{2},{3}L{4},{6}",tfx(t.x),tfx(t.y),tfx(e.x),tfx(e.y),tfx(e.x-n),tfx(e.y-i),tfx(e.y+i)).attr(o.lineattr)},rnd.ReStruct.prototype.drawPlus=function(t){var e=this.render.scale/5,i=this.render.paper,n=this.render.styles;return i.path("M{0},{4}L{0},{5}M{2},{1}L{3},{1}",tfx(t.x),tfx(t.y),tfx(t.x-e),tfx(t.x+e),tfx(t.y-e),tfx(t.y+e)).attr(n.lineattr)},rnd.ReStruct.prototype.drawBondSingle=function(t,e){var i=t.p,n=e.p,r=this.render.paper,o=this.render.styles;return r.path(rnd.ReStruct.makeStroke(i,n)).attr(o.lineattr)},rnd.ReStruct.prototype.drawBondSingleUp=function(t,e,i){var n=t.p,r=e.p,o=t.norm,s=this.render.settings,a=this.render.paper,l=this.render.styles,u=.7*s.bondSpace,c=r.addScaled(o,u),h=r.addScaled(o,-u);if(i.neihbid2>=0){var d=this.stereoUpBondGetCoordinates(e,i.neihbid2);c=d[0],h=d[1]}return a.path("M{0},{1}L{2},{3}L{4},{5}Z",tfx(n.x),tfx(n.y),tfx(c.x),tfx(c.y),tfx(h.x),tfx(h.y)).attr(l.lineattr).attr({fill:"#000"})},rnd.ReStruct.prototype.drawVec=function(t,e,i,n){var r=this.render.settings,o=this.render.paper,s=this.render.styles,a=r.bondSpace,l=t.addScaled(e,n||3*a);return o.path("M{0},{1}L{2},{3}",tfx(t.x),tfx(t.y),tfx(l.x),tfx(l.y)).attr(s.lineattr).attr({stroke:i||"#0F0"})},rnd.ReStruct.prototype.stereoUpBondGetCoordinates=function(t,e){var i=this.render.settings.bondSpace,n=this.molecule.halfBonds.get(e),r=util.Vec2.dot(t.dir,n.dir),o=util.Vec2.cross(t.dir,n.dir),s=Math.sqrt(.5*(1-r)),a=n.dir.rotateSC((o>=0?-1:1)*s,Math.sqrt(.5*(1+r))),l=.3,u=.7,c=t.p.addScaled(a,u*i/(s+l)),h=t.p.addScaled(a.negated(),u*i/(s+l));return o>0?[c,h]:[h,c]},rnd.ReStruct.prototype.drawBondSingleStereoBold=function(t,e,i,n){var r=this.render.paper,o=this.render.settings,s=this.render.styles,a=this.stereoUpBondGetCoordinates(t,i.neihbid1),l=this.stereoUpBondGetCoordinates(e,i.neihbid2),u=a[0],c=a[1],h=l[0],d=l[1],p=r.path("M{0},{1}L{2},{3}L{4},{5}L{6},{7}Z",tfx(u.x),tfx(u.y),tfx(c.x),tfx(c.y),tfx(h.x),tfx(h.y),tfx(d.x),tfx(d.y)).attr(s.lineattr).attr({stroke:"#000",fill:"#000"});if(n){var f=t.p,m=e.p,g=t.norm,b=i.doubleBondShift,v=1.5*o.bondSpace,y=f.addScaled(g,v*b),w=m.addScaled(g,v*b),S=!this.atoms.get(t.begin).showLabel,x=!this.atoms.get(e.begin).showLabel;return b>0?(S&&(y=y.addScaled(t.dir,v*this.getBondLineShift(t.rightCos,t.rightSin))),x&&(w=w.addScaled(t.dir,-v*this.getBondLineShift(e.leftCos,e.leftSin)))):0>b&&(S&&(y=y.addScaled(t.dir,v*this.getBondLineShift(t.leftCos,t.leftSin))),x&&(w=w.addScaled(t.dir,-v*this.getBondLineShift(e.rightCos,e.rightSin)))),r.set([p,r.path("M{0},{1}L{2},{3}",tfx(y.x),tfx(y.y),tfx(w.x),tfx(w.y)).attr(s.lineattr)])}return p},rnd.ReStruct.prototype.drawBondSingleDown=function(t,e){var i=t.p,n=e.p,r=t.norm,o=this.render.settings,s=this.render.paper,a=this.render.styles,l=.7*o.bondSpace,u=n.sub(i),c=u.length()+.2;u=u.normalized();for(var h,d,p=1.2*o.lineWidth,f=Math.max(Math.floor((c-o.lineWidth)/(o.lineWidth+p)),0)+2,m=c/(f-1),g="",b=i,v=0;f>v;++v)b=i.addScaled(u,m*v),h=b.addScaled(r,l*(v+.5)/(f-.5)),d=b.addScaled(r,-l*(v+.5)/(f-.5)),g+=rnd.ReStruct.makeStroke(h,d);return s.path(g).attr(a.lineattr)},rnd.ReStruct.prototype.drawBondSingleEither=function(t,e){var i=t.p,n=e.p,r=t.norm,o=this.render.settings,s=this.render.paper,a=this.render.styles,l=.7*o.bondSpace,u=n.sub(i),c=u.length();u=u.normalized();for(var h=.6*o.lineWidth,d=Math.max(Math.floor((c-o.lineWidth)/(o.lineWidth+h)),0)+2,p=c/(d-.5),f="M"+tfx(i.x)+","+tfx(i.y),m=i,g=0;d>g;++g)m=i.addScaled(u,p*(g+.5)).addScaled(r,(1&g?-1:1)*l*(g+.5)/(d-.5)),f+="L"+tfx(m.x)+","+tfx(m.y);return s.path(f).attr(a.lineattr)},rnd.ReStruct.prototype.getBondLineShift=function(t,e){return 0>e||Math.abs(t)>.9?0:e/(1-t)},rnd.ReStruct.prototype.drawBondDouble=function(t,e,i,n){var r=t.p,o=e.p,s=t.norm,a=n?0:i.doubleBondShift,l=this.render.settings,u=this.render.paper,c=this.render.styles,h=l.bondSpace/2,d=h,p=-h;d+=a*h,p+=a*h;var f=r.addScaled(s,d),m=o.addScaled(s,d),g=r.addScaled(s,p),b=o.addScaled(s,p),v=!this.atoms.get(t.begin).showLabel,y=!this.atoms.get(e.begin).showLabel;return a>0?(v&&(f=f.addScaled(t.dir,l.bondSpace*this.getBondLineShift(t.rightCos,t.rightSin))),y&&(m=m.addScaled(t.dir,-l.bondSpace*this.getBondLineShift(e.leftCos,e.leftSin)))):0>a&&(v&&(g=g.addScaled(t.dir,l.bondSpace*this.getBondLineShift(t.leftCos,t.leftSin))),y&&(b=b.addScaled(t.dir,-l.bondSpace*this.getBondLineShift(e.rightCos,e.rightSin)))),u.path(n?"M{0},{1}L{6},{7}M{4},{5}L{2},{3}":"M{0},{1}L{2},{3}M{4},{5}L{6},{7}",tfx(f.x),tfx(f.y),tfx(m.x),tfx(m.y),tfx(g.x),tfx(g.y),tfx(b.x),tfx(b.y)).attr(c.lineattr)},rnd.ReStruct.makeStroke=function(t,e){return"M"+tfx(t.x)+","+tfx(t.y)+"L"+tfx(e.x)+","+tfx(e.y)+"	"},rnd.ReStruct.prototype.drawBondSingleOrDouble=function(t,e){var i=t.p,n=e.p,r=t.norm,o=this.render,s=o.settings,a=o.paper,l=o.styles,u=s.bondSpace/2,c=(util.Vec2.dist(i,n)/(s.bondSpace+s.lineWidth)).toFixed()-0;1&c||(c+=1);for(var h="",d=i,p=1;c>=p;++p){var f=util.Vec2.lc2(i,(c-p)/c,n,p/c);1&p?h+=rnd.ReStruct.makeStroke(d,f):(h+=rnd.ReStruct.makeStroke(d.addScaled(r,u),f.addScaled(r,u)),h+=rnd.ReStruct.makeStroke(d.addScaled(r,-u),f.addScaled(r,-u))),d=f}return a.path(h).attr(l.lineattr)},rnd.ReStruct.prototype.drawBondTriple=function(t,e){var i=t.p,n=e.p,r=t.norm,o=this.render,s=o.settings,a=o.paper,l=o.styles,u=i.addScaled(r,s.bondSpace),c=n.addScaled(r,s.bondSpace),h=i.addScaled(r,-s.bondSpace),d=n.addScaled(r,-s.bondSpace);return a.path(rnd.ReStruct.makeStroke(i,n)+rnd.ReStruct.makeStroke(u,c)+rnd.ReStruct.makeStroke(h,d)).attr(l.lineattr)},rnd.dashedPath=function(t,e,i){for(var n=0,r=util.Vec2.dist(t,e),o=util.Vec2.diff(e,t).normalized(),s=!0,a="",l=0;r>n;){var u=i[l%i.length],c=n+Math.min(u,r-n);s&&(a+="M "+t.addScaled(o,n).coordStr()+" L "+t.addScaled(o,c).coordStr()),n+=u,s=!s,l++}return a},rnd.ReStruct.prototype.drawBondAromatic=function(t,e,i,n){if(!n)return this.drawBondSingle(t,e);var r=i.doubleBondShift,o=this.render.paper,s=this.preparePathsForAromaticBond(t,e,r),a=s[0],l=s[1];return(r>0?a:l).attr({"stroke-dasharray":"- "}),o.set([a,l])},rnd.dashdotPattern=[.125,.125,.005,.125],rnd.ReStruct.prototype.drawBondSingleOrAromatic=function(t,e,i){var n=i.doubleBondShift,r=this.render.paper,o=this.render.settings.scaleFactor,s=util.map(rnd.dashdotPattern,function(t){return t*o}),a=this.preparePathsForAromaticBond(t,e,n,n>0?1:2,s),l=a[0],u=a[1];return r.set([l,u])},rnd.ReStruct.prototype.preparePathsForAromaticBond=function(t,e,i,n,r){var o=this.render.settings,s=this.render.paper,a=this.render.styles,l=t.p,u=e.p,c=t.norm,h=o.bondSpace/2,d=h,p=-h;d+=i*h,p+=i*h;var f=l.addScaled(c,d),m=u.addScaled(c,d),g=l.addScaled(c,p),b=u.addScaled(c,p),v=!this.atoms.get(t.begin).showLabel,y=!this.atoms.get(e.begin).showLabel;i>0?(v&&(f=f.addScaled(t.dir,o.bondSpace*this.getBondLineShift(t.rightCos,t.rightSin))),y&&(m=m.addScaled(t.dir,-o.bondSpace*this.getBondLineShift(e.leftCos,e.leftSin)))):0>i&&(v&&(g=g.addScaled(t.dir,o.bondSpace*this.getBondLineShift(t.leftCos,t.leftSin))),y&&(b=b.addScaled(t.dir,-o.bondSpace*this.getBondLineShift(e.rightCos,e.rightSin))));var w=s.path(r&&1&n?rnd.dashedPath(f,m,r):rnd.ReStruct.makeStroke(f,m)).attr(a.lineattr),S=s.path(r&&2&n?rnd.dashedPath(g,b,r):rnd.ReStruct.makeStroke(g,b)).attr(a.lineattr);return[w,S]},rnd.ReStruct.prototype.drawBondDoubleOrAromatic=function(t,e,i){var n=i.doubleBondShift,r=this.render.paper,o=this.render.settings.scaleFactor,s=util.map(rnd.dashdotPattern,function(t){return t*o}),a=this.preparePathsForAromaticBond(t,e,n,3,s),l=a[0],u=a[1];return r.set([l,u])},rnd.ReStruct.prototype.drawBondAny=function(t,e){var i=t.p,n=e.p,r=this.render.paper,o=this.render.styles;return r.path(rnd.ReStruct.makeStroke(i,n)).attr(o.lineattr).attr({"stroke-dasharray":"- "})},rnd.ReStruct.prototype.drawReactingCenter=function(t,e,i){var n=e.p,r=i.p,o=r.add(n).scaled(.5),s=r.sub(n).normalized(),a=s.rotateSC(1,0),l=this.render.paper,u=this.render.styles,c=this.render.settings,h=[],d=c.lineWidth,p=c.bondSpace/2,f=d,m=2*d,g=1.5*p,b=1.5*p,v=3*p,y=.2;switch(t.b.reactingCenterStatus){case chem.Struct.BOND.REACTING_CENTER.NOT_CENTER:h.push(o.addScaled(a,v).addScaled(s,y*v)),h.push(o.addScaled(a,-v).addScaled(s,-y*v)),h.push(o.addScaled(a,v).addScaled(s,-y*v)),h.push(o.addScaled(a,-v).addScaled(s,y*v));break;case chem.Struct.BOND.REACTING_CENTER.CENTER:h.push(o.addScaled(a,v).addScaled(s,y*v).addScaled(s,f)),h.push(o.addScaled(a,-v).addScaled(s,-y*v).addScaled(s,f)),h.push(o.addScaled(a,v).addScaled(s,y*v).addScaled(s,-f)),h.push(o.addScaled(a,-v).addScaled(s,-y*v).addScaled(s,-f)),h.push(o.addScaled(s,g).addScaled(a,b)),h.push(o.addScaled(s,-g).addScaled(a,b)),h.push(o.addScaled(s,g).addScaled(a,-b)),h.push(o.addScaled(s,-g).addScaled(a,-b));break;case chem.Struct.BOND.REACTING_CENTER.MADE_OR_BROKEN:h.push(o.addScaled(a,v).addScaled(s,m)),h.push(o.addScaled(a,-v).addScaled(s,m)),h.push(o.addScaled(a,v).addScaled(s,-m)),h.push(o.addScaled(a,-v).addScaled(s,-m));break;case chem.Struct.BOND.REACTING_CENTER.ORDER_CHANGED:h.push(o.addScaled(a,v)),h.push(o.addScaled(a,-v));break;case chem.Struct.BOND.REACTING_CENTER.MADE_OR_BROKEN_AND_CHANGED:h.push(o.addScaled(a,v).addScaled(s,m)),h.push(o.addScaled(a,-v).addScaled(s,m)),h.push(o.addScaled(a,v).addScaled(s,-m)),h.push(o.addScaled(a,-v).addScaled(s,-m)),h.push(o.addScaled(a,v)),h.push(o.addScaled(a,-v));break;default:return null}for(var w="",S=0;S<h.length/2;++S)w+=rnd.ReStruct.makeStroke(h[2*S],h[2*S+1]);return l.path(w).attr(u.lineattr)},rnd.ReStruct.prototype.drawTopologyMark=function(t,e,i){var n=null;if(t.b.topology==chem.Struct.BOND.TOPOLOGY.RING)n="rng";else{if(t.b.topology!=chem.Struct.BOND.TOPOLOGY.CHAIN)return null;n="chn"}var r=this.render.paper,o=this.render.settings,s=e.p,a=i.p,l=a.add(s).scaled(.5),u=a.sub(s).normalized(),c=u.rotateSC(1,0),h=o.lineWidth;t.doubleBondShift>0?c=c.scaled(-t.doubleBondShift):0==t.doubleBondShift&&(h+=o.bondSpace/2);var d=new util.Vec2(2,1).scaled(o.bondSpace);t.b.type==chem.Struct.BOND.TYPE.TRIPLE&&(h+=o.bondSpace);var p=l.add(new util.Vec2(c.x*(d.x+h),c.y*(d.y+h))),f=r.text(p.x,p.y,n).attr({font:o.font,"font-size":o.fontszsub,fill:"#000"}),m=rnd.relBox(f.getBBox());return this.centerText(f,m),f},rnd.ReStruct.prototype.drawBond=function(t,e,i){var n=null,r=this.molecule;switch(t.b.type){case chem.Struct.BOND.TYPE.SINGLE:switch(t.b.stereo){case chem.Struct.BOND.STEREO.UP:this.findIncomingUpBonds(e.bid,t),n=t.boldStereo&&t.neihbid1>=0&&t.neihbid2>=0?this.drawBondSingleStereoBold(e,i,t):this.drawBondSingleUp(e,i,t);break;case chem.Struct.BOND.STEREO.DOWN:n=this.drawBondSingleDown(e,i,t);break;case chem.Struct.BOND.STEREO.EITHER:n=this.drawBondSingleEither(e,i,t);break;default:n=this.drawBondSingle(e,i)}break;case chem.Struct.BOND.TYPE.DOUBLE:this.findIncomingUpBonds(e.bid,t),n=t.b.stereo===chem.Struct.BOND.STEREO.NONE&&t.boldStereo&&t.neihbid1>=0&&t.neihbid2>=0?this.drawBondSingleStereoBold(e,i,t,!0):this.drawBondDouble(e,i,t,t.b.stereo===chem.Struct.BOND.STEREO.CIS_TRANS);break;case chem.Struct.BOND.TYPE.TRIPLE:n=this.drawBondTriple(e,i,t);break;case chem.Struct.BOND.TYPE.AROMATIC:var o=e.loop>=0&&r.loops.get(e.loop).aromatic||i.loop>=0&&r.loops.get(i.loop).aromatic;n=this.drawBondAromatic(e,i,t,!o);break;case chem.Struct.BOND.TYPE.SINGLE_OR_DOUBLE:n=this.drawBondSingleOrDouble(e,i,t);break;case chem.Struct.BOND.TYPE.SINGLE_OR_AROMATIC:n=this.drawBondSingleOrAromatic(e,i,t);break;case chem.Struct.BOND.TYPE.DOUBLE_OR_AROMATIC:n=this.drawBondDoubleOrAromatic(e,i,t);break;case chem.Struct.BOND.TYPE.ANY:n=this.drawBondAny(e,i,t);break;default:throw new Error("Bond type "+t.b.type+" not supported")}return n},rnd.ReStruct.prototype.radicalCap=function(t){var e=this.render.settings,i=this.render.paper,n=.9*e.lineWidth,r=n,o=2*n;return i.path("M{0},{1}L{2},{3}L{4},{5}",tfx(t.x-r),tfx(t.y+o),tfx(t.x),tfx(t.y),tfx(t.x+r),tfx(t.y+o)).attr({stroke:"#000","stroke-width":.7*e.lineWidth,"stroke-linecap":"square","stroke-linejoin":"miter"})},rnd.ReStruct.prototype.radicalBullet=function(t){var e=this.render.settings,i=this.render.paper;return i.circle(t.x,t.y,e.lineWidth).attr({stroke:null,fill:"#000"})},rnd.ReStruct.prototype.centerText=function(t,e){this.render.paper.raphael.vml&&this.pathAndRBoxTranslate(t,e,0,.16*e.height)},rnd.ReStruct.prototype.showItemSelection=function(t,e,i){var n=null!=e.selectionPlate&&!e.selectionPlate.removed;if(n=n&&(!("hiddenPaths"in rnd.ReStruct.prototype)||rnd.ReStruct.prototype.hiddenPaths.indexOf(e.selectionPlate)<0),i){if(!n){var r=this.render,o=r.styles,s=r.paper;e.selectionPlate=e.makeSelectionPlate(this,s,o),this.addReObjectPath("selection-plate",e.visel,e.selectionPlate)}e.selectionPlate&&e.selectionPlate.show()}else n&&e.selectionPlate&&e.selectionPlate.hide()},rnd.ReStruct.prototype.pathAndRBoxTranslate=function(t,e,i,n){t.translateAbs(i,n),e.x+=i,e.y+=n};var markerColors=["black","cyan","magenta","red","green","blue","green"];if(rnd.ReStruct.prototype.showLabels=function(){var t=this.render,e=t.settings,i=t.styles,n=t.opt,r=t.paper,o=.5*e.lineWidth;for(var s in this.atomsChanged){var a=this.atoms.get(s),l=t.ps(a.a.pp),u=null;n.showAtomIds&&(u={},u.text=s.toString(),u.path=r.text(l.x,l.y,u.text).attr({font:e.font,"font-size":e.fontszsub,fill:"#070"}),u.rbb=rnd.relBox(u.path.getBBox()),this.centerText(u.path,u.rbb),this.addReObjectPath("indices",a.visel,u.path,l)),a.setHighlight(a.highlight,t);var h="#000000";if(a.showLabel){var d=0,p=0,f={};if(null!=a.a.atomList)f.text=a.a.atomList.label();else if("R#"==a.a.label&&null!=a.a.rglabel){f.text="";for(var m=0;32>m;m++)a.a.rglabel&1<<m&&(f.text+="R"+(m+1).toString());""==f.text&&(f="R#")}else if(f.text=a.a.label,n.atomColoring){var g=chem.Element.getElementByLabel(f.text);g&&(h=chem.Element.elements.get(g).color)}f.path=r.text(l.x,l.y,f.text).attr({font:e.font,"font-size":e.fontsz,fill:h}),f.rbb=rnd.relBox(f.path.getBBox()),this.centerText(f.path,f.rbb),null!=a.a.atomList&&this.pathAndRBoxTranslate(f.path,f.rbb,(a.hydrogenOnTheLeft?-1:1)*(f.rbb.width-f.rbb.height)/2,0),this.addReObjectPath("data",a.visel,f.path,l,!0),d=f.rbb.width/2,p=-f.rbb.width/2;var b=Math.floor(a.a.implicitH),v="H"==f.text,y={},w=null,S=a.hydrogenOnTheLeft;v&&b>0&&(w={},w.text=(b+1).toString(),w.path=r.text(l.x,l.y,w.text).attr({font:e.font,"font-size":e.fontszsub,fill:h}),w.rbb=rnd.relBox(w.path.getBBox()),this.centerText(w.path,w.rbb),this.pathAndRBoxTranslate(w.path,w.rbb,d+.5*w.rbb.width+o,.2*f.rbb.height),d+=w.rbb.width+o,this.addReObjectPath("data",a.visel,w.path,l,!0));var x={};if(0!=a.a.radical){var _;switch(a.a.radical){case 1:x.path=r.set(),_=1.6*e.lineWidth,x.path.push(this.radicalBullet(l.add(new util.Vec2(-_,0))),this.radicalBullet(l.add(new util.Vec2(_,0)))),x.path.attr("fill",h);break;case 2:x.path=this.radicalBullet(l).attr("fill",h);break;case 3:x.path=r.set(),_=1.6*e.lineWidth,x.path.push(this.radicalCap(l.add(new util.Vec2(-_,0))),this.radicalCap(l.add(new util.Vec2(_,0)))),x.path.attr("stroke",h)}x.rbb=rnd.relBox(x.path.getBBox());var A=-.5*(f.rbb.height+x.rbb.height);3==a.a.radical&&(A-=e.lineWidth/2),this.pathAndRBoxTranslate(x.path,x.rbb,0,A),this.addReObjectPath("data",a.visel,x.path,l,!0)}var E={};0!=a.a.isotope&&(E.text=a.a.isotope.toString(),E.path=r.text(l.x,l.y,E.text).attr({font:e.font,"font-size":e.fontszsub,fill:h}),E.rbb=rnd.relBox(E.path.getBBox()),this.centerText(E.path,E.rbb),this.pathAndRBoxTranslate(E.path,E.rbb,p-.5*E.rbb.width-o,-.3*f.rbb.height),p-=E.rbb.width+o,this.addReObjectPath("data",a.visel,E.path,l,!0)),!v&&b>0&&!t.opt.hideImplicitHydrogen&&(y.text="H",y.path=r.text(l.x,l.y,y.text).attr({font:e.font,"font-size":e.fontsz,fill:h}),y.rbb=rnd.relBox(y.path.getBBox()),this.centerText(y.path,y.rbb),S||(this.pathAndRBoxTranslate(y.path,y.rbb,d+.5*y.rbb.width+o,0),d+=y.rbb.width+o),b>1&&(w={},w.text=b.toString(),w.path=r.text(l.x,l.y,w.text).attr({font:e.font,"font-size":e.fontszsub,fill:h}),w.rbb=rnd.relBox(w.path.getBBox()),this.centerText(w.path,w.rbb),S||(this.pathAndRBoxTranslate(w.path,w.rbb,d+.5*w.rbb.width+o,.2*f.rbb.height),d+=w.rbb.width+o)),S&&(null!=w&&(this.pathAndRBoxTranslate(w.path,w.rbb,p-.5*w.rbb.width-o,.2*f.rbb.height),p-=w.rbb.width+o),this.pathAndRBoxTranslate(y.path,y.rbb,p-.5*y.rbb.width-o,0),p-=y.rbb.width+o),this.addReObjectPath("data",a.visel,y.path,l,!0),null!=w&&this.addReObjectPath("data",a.visel,w.path,l,!0));var O={};if(0!=a.a.charge){O.text="";var C=Math.abs(a.a.charge);1!=C&&(O.text=C.toString()),a.a.charge<0?O.text+="":O.text+="+",O.path=r.text(l.x,l.y,O.text).attr({font:e.font,"font-size":e.fontszsub,fill:h}),O.rbb=rnd.relBox(O.path.getBBox()),this.centerText(O.path,O.rbb),this.pathAndRBoxTranslate(O.path,O.rbb,d+.5*O.rbb.width+o,-.3*f.rbb.height),d+=O.rbb.width+o,this.addReObjectPath("data",a.visel,O.path,l,!0)}var T={},B={0:"0",1:"I",2:"II",3:"III",4:"IV",5:"V",6:"VI",7:"VII",8:"VIII",9:"IX",10:"X",11:"XI",12:"XII",13:"XIII",14:"XIV"};if(a.a.explicitValence>=0){if(T.text=B[a.a.explicitValence],!T.text)throw new Error("invalid valence "+a.a.explicitValence.toString());T.text="("+T.text+")",T.path=r.text(l.x,l.y,T.text).attr({font:e.font,"font-size":e.fontszsub,fill:h}),T.rbb=rnd.relBox(T.path.getBBox()),this.centerText(T.path,T.rbb),this.pathAndRBoxTranslate(T.path,T.rbb,d+.5*T.rbb.width+o,-.3*f.rbb.height),d+=T.rbb.width+o,this.addReObjectPath("data",a.visel,T.path,l,!0)}if(a.a.badConn&&n.showValenceWarnings){var R={},M=l.y+f.rbb.height/2+o;R.path=r.path("M{0},{1}L{2},{3}",tfx(l.x+p),tfx(M),tfx(l.x+d),tfx(M)).attr(this.render.styles.lineattr).attr({stroke:"#F00"}),R.rbb=rnd.relBox(R.path.getBBox()),this.addReObjectPath("warnings",a.visel,R.path,l,!0)}u&&this.pathAndRBoxTranslate(u.path,u.rbb,-.5*f.rbb.width-.5*u.rbb.width-o,.3*f.rbb.height)}var P=this.bisectLargestSector(a),N=Prototype.Browser.IE?"*":"";if(a.a.attpnt){var D,k;for(D=0,c=0;4>D;++D){var L="";if(a.a.attpnt&1<<D){for(L.length>0&&(L+=" "),L+=N,k=0;(0==D?0:D+1)>k;++k)L+="'";var I=new util.Vec2(l),G=l.addScaled(P,.7*e.scaleFactor),V=r.text(G.x,G.y,L).attr({font:e.font,"font-size":e.fontsz,fill:h}),F=rnd.relBox(V.getBBox());this.centerText(V,F);var H=P.negated();G=G.addScaled(H,util.Vec2.shiftRayBox(G,H,util.Box2Abs.fromRelBox(F))+e.lineWidth/2),I=this.shiftBondEnd(a,I,P,e.lineWidth);var j=P.rotateSC(1,0),$=G.addScaled(j,.05*e.scaleFactor).addScaled(H,.09*e.scaleFactor),z=G.addScaled(j,-.05*e.scaleFactor).addScaled(H,.09*e.scaleFactor),U=r.set();U.push(V,r.path("M{0},{1}L{2},{3}M{4},{5}L{2},{3}L{6},{7}",tfx(I.x),tfx(I.y),tfx(G.x),tfx(G.y),tfx($.x),tfx($.y),tfx(z.x),tfx(z.y)).attr(i.lineattr).attr({"stroke-width":e.lineWidth/2})),this.addReObjectPath("indices",a.visel,U,l),P=P.rotate(Math.PI/6)}}}var W="";if(a.a.aam>0&&(W+=a.a.aam),a.a.invRet>0)if(W.length>0&&(W+=","),1==a.a.invRet)W+="Inv";else{if(2!=a.a.invRet)throw new Error("Invalid value for the invert/retain flag");W+="Ret"}var Y="";if(0!=a.a.ringBondCount)if(a.a.ringBondCount>0)Y+="rb"+a.a.ringBondCount.toString();else if(-1==a.a.ringBondCount)Y+="rb0";else{if(-2!=a.a.ringBondCount)throw new Error("Ring bond count invalid");Y+="rb*"}if(0!=a.a.substitutionCount)if(Y.length>0&&(Y+=","),a.a.substitutionCount>0)Y+="s"+a.a.substitutionCount.toString();else if(-1==a.a.substitutionCount)Y+="s0";else{if(-2!=a.a.substitutionCount)throw new Error("Substitution count invalid");Y+="s*"}if(a.a.unsaturatedAtom>0){if(Y.length>0&&(Y+=","),1!=a.a.unsaturatedAtom)throw new Error("Unsaturated atom invalid value");Y+="u"}if(a.a.hCount>0&&(Y.length>0&&(Y+=","),Y+="H"+(a.a.hCount-1).toString()),a.a.exactChangeFlag>0){if(W.length>0&&(W+=","),1!=a.a.exactChangeFlag)throw new Error("Invalid value for the exact change flag");W+="ext"}if(W=(Y.length>0?Y+"\n":"")+(W.length>0?"."+W+".":""),W.length>0){var q=r.text(l.x,l.y,W).attr({font:e.font,"font-size":e.fontszsub,fill:h}),K=rnd.relBox(q.getBBox());this.centerText(q,K);var X=this.bisectLargestSector(a),J=a.visel,Z=3;for(D=0;D<J.exts.length;++D)Z=Math.max(Z,util.Vec2.shiftRayBox(l,X,J.exts[D].translate(l)));Z+=util.Vec2.shiftRayBox(l,X.negated(),util.Box2Abs.fromRelBox(K)),X=X.scaled(8+Z),this.pathAndRBoxTranslate(q,K,X.x,X.y),this.addReObjectPath("data",a.visel,q,l,!0)}}},rnd.ReStruct.prototype.shiftBondEnd=function(t,e,i,n){for(var r=0,o=t.visel,s=0;s<o.exts.length;++s){var a=o.exts[s].translate(e);r=Math.max(r,util.Vec2.shiftRayBox(e,i,a))}return r>0&&(e=e.addScaled(i,r+n)),e},rnd.ReStruct.prototype.bisectLargestSector=function(t){var e=[];t.a.neighbors.each(function(t){var i=this.molecule.halfBonds.get(t);e.push(i.ang)},this),e=e.sort(function(t,e){return t-e});for(var i=[],n=0;n<e.length-1;++n)i.push(e[(n+1)%e.length]-e[n]);i.push(e[0]-e[e.length-1]+2*Math.PI);var r=0,o=-Math.PI/2;for(n=0;n<e.length;++n)i[n]>r&&(r=i[n],o=e[n]+i[n]/2);return new util.Vec2(Math.cos(o),Math.sin(o))},rnd.ReStruct.prototype.bondRecalc=function(t,e){var i=this.render,n=this.atoms.get(e.b.begin),r=this.atoms.get(e.b.end),o=i.ps(n.a.pp),s=i.ps(r.a.pp),a=this.molecule.halfBonds.get(e.b.hb1),l=this.molecule.halfBonds.get(e.b.hb2);a.p=this.shiftBondEnd(n,o,a.dir,2*t.lineWidth),l.p=this.shiftBondEnd(r,s,l.dir,2*t.lineWidth),e.b.center=util.Vec2.lc2(n.a.pp,.5,r.a.pp,.5),e.b.len=util.Vec2.dist(o,s),e.b.sb=5*t.lineWidth,e.b.sa=Math.max(e.b.sb,e.b.len/2-2*t.lineWidth),e.b.angle=180*Math.atan2(a.dir.y,a.dir.x)/Math.PI},rnd.ReStruct.prototype.showBonds=function(){var t=this.render,e=t.settings,i=t.paper,n=t.opt;for(var r in this.bondsChanged){var o=this.bonds.get(r),s=this.molecule.halfBonds.get(o.b.hb1),a=this.molecule.halfBonds.get(o.b.hb2);this.bondRecalc(e,o),o.path=this.drawBond(o,s,a),o.rbb=rnd.relBox(o.path.getBBox()),this.addReObjectPath("data",o.visel,o.path,null,!0);var l={};l.path=this.drawReactingCenter(o,s,a),l.path&&(l.rbb=rnd.relBox(l.path.getBBox()),this.addReObjectPath("data",o.visel,l.path,null,!0));var u={};u.path=this.drawTopologyMark(o,s,a),u.path&&(u.rbb=rnd.relBox(u.path.getBBox()),this.addReObjectPath("data",o.visel,u.path,null,!0)),o.setHighlight(o.highlight,t);var c=.6*e.subFontSize,h=null,d=null;if(n.showBondIds){var p=util.Vec2.lc(s.p,.5,a.p,.5,s.norm,c);h=i.text(p.x,p.y,r.toString()),d=rnd.relBox(h.getBBox()),this.centerText(h,d),this.addReObjectPath("indices",o.visel,h)}if(n.showHalfBondIds){var f=util.Vec2.lc(s.p,.8,a.p,.2,s.norm,c);h=i.text(f.x,f.y,o.b.hb1.toString()),d=rnd.relBox(h.getBBox()),this.centerText(h,d),this.addReObjectPath("indices",o.visel,h);var m=util.Vec2.lc(s.p,.2,a.p,.8,a.norm,c);h=i.text(m.x,m.y,o.b.hb2.toString()),d=rnd.relBox(h.getBBox()),this.centerText(h,d),this.addReObjectPath("indices",o.visel,h)}if(n.showLoopIds&&!n.showBondIds){var g=util.Vec2.lc(s.p,.5,a.p,.5,a.norm,c);h=i.text(g.x,g.y,s.loop.toString()),d=rnd.relBox(h.getBBox()),this.centerText(h,d),this.addReObjectPath("indices",o.visel,h);var b=util.Vec2.lc(s.p,.5,a.p,.5,s.norm,c);h=i.text(b.x,b.y,a.loop.toString()),d=rnd.relBox(h.getBBox()),this.centerText(h,d),this.addReObjectPath("indices",o.visel,h)}}},rnd.ReStruct.prototype.labelIsVisible=function(t,e){if(0==e.a.neighbors.length||e.a.neighbors.length<2&&!this.render.opt.hideTerminalLabels||"c"!=e.a.label.toLowerCase()||e.a.badConn&&this.render.opt.showValenceWarnings||0!=e.a.isotope||0!=e.a.radical||0!=e.a.charge||e.a.explicitValence>=0||null!=e.a.atomList||null!=e.a.rglabel)return!0;if(2==e.a.neighbors.length){var i=e.a.neighbors[0],n=e.a.neighbors[1],r=this.molecule.halfBonds.get(i),o=this.molecule.halfBonds.get(n),s=this.bonds.get(r.bid),a=this.bonds.get(o.bid);if(s.b.type==a.b.type&&s.b.stereo==chem.Struct.BOND.STEREO.NONE&&a.b.stereo==chem.Struct.BOND.STEREO.NONE&&Math.abs(util.Vec2.cross(r.dir,o.dir))<.2)return!0;
}return!1},rnd.ReStruct.prototype.checkLabelsToShow=function(){for(var t in this.atomsChanged){var e=this.atoms.get(t);e.showLabel=this.labelIsVisible(t,e)}},rnd.ReStruct.layerMap={background:0,"selection-plate":1,highlighting:2,warnings:3,data:4,indices:5},rnd.ReStruct.prototype.addReObjectPath=function(t,e,i,n,r){if(i){var o=this.render.offset,s=r?util.Box2Abs.fromRelBox(rnd.relBox(i.getBBox())):null,a=n&&s?s.translate(n.negated()):null;null!==o&&(i.translateAbs(o.x,o.y),s=s?s.translate(o):null),e.add(i,s,a),this.insertInLayer(rnd.ReStruct.layerMap[t],i)}},rnd.ReStruct.prototype.clearVisel=function(t){for(var e=0;e<t.paths.length;++e)t.paths[e].remove();t.clear()},rnd.ReStruct.prototype.selectDoubleBondShift=function(t,e,i,n){return 6==t&&6!=e&&(i>1||1==n)?-1:6==e&&6!=t&&(n>1||1==i)?1:e*i>t*n?-1:t*n>e*i?1:e>t?-1:1},rnd.ReStruct.prototype.selectDoubleBondShift_Chain=function(t){var e=this.molecule,i=e.halfBonds.get(t.b.hb1),n=e.halfBonds.get(t.b.hb2),r=(i.leftSin>.3?1:0)+(n.rightSin>.3?1:0),o=(n.leftSin>.3?1:0)+(i.rightSin>.3?1:0);return r>o?-1:o>r?1:(i.leftSin>.3?1:0)+(i.rightSin>.3?1:0)==1?1:0},rnd.ReStruct.prototype.setDoubleBondShift=function(){var t=this.molecule;for(var e in this.bondsChanged){var i,n,r=this.bonds.get(e);if(i=t.halfBonds.get(r.b.hb1).loop,n=t.halfBonds.get(r.b.hb2).loop,i>=0&&n>=0){var o=t.loops.get(i).dblBonds,s=t.loops.get(n).dblBonds,a=t.loops.get(i).hbs.length,l=t.loops.get(n).hbs.length;r.doubleBondShift=this.selectDoubleBondShift(a,l,o,s)}else i>=0?r.doubleBondShift=-1:n>=0?r.doubleBondShift=1:r.doubleBondShift=this.selectDoubleBondShift_Chain(r)}},rnd.ReStruct.prototype.updateLoops=function(){this.reloops.each(function(t,e){this.clearVisel(e.visel)},this);var t=this.molecule.findLoops();util.each(t.bondsToMark,function(t){this.markBond(t,1)},this),util.each(t.newLoops,function(t){this.reloops.set(t,new rnd.ReLoop(this.molecule.loops.get(t)))},this)},rnd.ReStruct.prototype.renderLoops=function(){var t=this.render,e=t.settings,i=t.paper,n=this.molecule;this.reloops.each(function(r,o){var s=o.loop;o.centre=new util.Vec2,s.hbs.each(function(e){var i=n.halfBonds.get(e),r=this.bonds.get(i.bid),a=t.ps(this.atoms.get(i.begin).a.pp);r.b.type!=chem.Struct.BOND.TYPE.AROMATIC&&(s.aromatic=!1),o.centre.add_(a)},this),s.convex=!0;for(var a=0;a<o.loop.hbs.length;++a){var l=n.halfBonds.get(s.hbs[a]),u=n.halfBonds.get(s.hbs[(a+1)%s.hbs.length]),c=Math.atan2(util.Vec2.cross(l.dir,u.dir),util.Vec2.dot(l.dir,u.dir));c>0&&(s.convex=!1)}if(o.centre=o.centre.scaled(1/s.hbs.length),o.radius=-1,s.hbs.each(function(e){var i=n.halfBonds.get(e),r=t.ps(this.atoms.get(i.begin).a.pp),s=t.ps(this.atoms.get(i.end).a.pp),a=util.Vec2.diff(s,r).rotateSC(1,0).normalized(),l=util.Vec2.dot(util.Vec2.diff(r,o.centre),a);o.radius<0?o.radius=l:o.radius=Math.min(o.radius,l)},this),o.radius*=.7,s.aromatic){var h=null;if(s.convex)h=i.circle(o.centre.x,o.centre.y,o.radius).attr({stroke:"#000","stroke-width":e.lineWidth});else{var d="";for(a=0;a<s.hbs.length;++a){l=n.halfBonds.get(s.hbs[a]),u=n.halfBonds.get(s.hbs[(a+1)%s.hbs.length]),c=Math.atan2(util.Vec2.cross(l.dir,u.dir),util.Vec2.dot(l.dir,u.dir));var p=(Math.PI-c)/2,f=u.dir.rotate(p),m=t.ps(this.atoms.get(u.begin).a.pp),g=Math.sin(p),b=.1;Math.abs(g)<b&&(g=g*b/Math.abs(g));var v=e.bondSpace/g,y=m.addScaled(f,-v);d+=0==a?"M":"L",d+=tfx(y.x)+","+tfx(y.y)}d+="Z",h=i.path(d).attr({stroke:"#000","stroke-width":e.lineWidth,"stroke-dasharray":"- "})}this.addReObjectPath("data",o.visel,h,null,!0)}},this)},!window.Prototype)throw new Error("Prototype.js should be loaded first");if(!window.rnd||!rnd.ReStruct)throw new Error("rnd.MolData should be defined prior to loading this file");if(rnd.DEBUG=!1,rnd.logcnt=0,rnd.logmouse=!1,rnd.hl=!1,rnd.logMethod=function(){},rnd.RenderDummy=function(t,e,i,n){this.clientArea=t=$(t),t.innerHTML="",this.paper=new Raphael(t),this.paper.rect(0,0,100,100).attr({fill:"#0F0",stroke:"none"}),this.setMolecule=function(){},this.update=function(){}},rnd.RenderOptions=function(t){t=t||{},this.showSelectionRegions=t.showSelectionRegions||!1,this.showAtomIds=t.showAtomIds||!1,this.showBondIds=t.showBondIds||!1,this.showHalfBondIds=t.showHalfBondIds||!1,this.showLoopIds=t.showLoopIds||!1,this.showValenceWarnings=Object.isUndefined(t.showValenceWarnings)?!0:t.showValenceWarnings,this.autoScale=t.autoScale||!1,this.autoScaleMargin=t.autoScaleMargin||0,this.atomColoring=t.atomColoring||0,this.hideImplicitHydrogen=t.hideImplicitHydrogen||!1,this.hideTerminalLabels=t.hideTerminalLabels||!1,this.ignoreMouseEvents=t.ignoreMouseEvents||!1,this.selectionDistanceCoefficient=(t.selectionDistanceCoefficient||.4)-0},rnd.Render=function(t,e,i,n){this.opt=new rnd.RenderOptions(i),this.useOldZoom=Prototype.Browser.IE,this.scale=e||100,this.baseScale=this.scale,this.offset=new util.Vec2,this.clientArea=t=$(t),t.innerHTML="",this.paper=new Raphael(t),this.size=new util.Vec2,this.viewSz=n||new util.Vec2(t.clientWidth||100,t.clientHeight||100),this.bb=new util.Box2Abs(new util.Vec2,this.viewSz),this.dirty=!0,this.selectionRect=null,this.rxnArrow=null,this.rxnMode=!1,this.zoom=1;var r=this,o=0,s=0,a=t;do o+=a.offsetTop||0,s+=a.offsetLeft||0,a=a.offsetParent;while(a);this.clientAreaPos=new util.Vec2(s,o),t.observe("selectstart",function(t){return util.stopEventPropagation(t),util.preventDefault(t)});var l=this;l.longTapFlag=!1,l.longTapTimeout=null,l.longTapTouchstart=null,l.setLongTapTimeout=function(t){l.longTapFlag=!1,l.longTapTouchstart=t,l.longTapTimeout=setTimeout(function(){l.longTapFlag=!0,l.longTapTimeout=null},500)},l.resetLongTapTimeout=function(t){clearTimeout(l.longTapTimeout),l.longTapTimeout=null,t&&(l.longTapTouchstart=null,l.longTapFlag=!1)},t.observe("touchstart",function(t){l.resetLongTapTimeout(!0),2==t.touches.length?(this._tui=this._tui||{},this._tui.center={pageX:(t.touches[0].pageX+t.touches[1].pageX)/2,pageY:(t.touches[0].pageY+t.touches[1].pageY)/2},ui.setZoomStaticPointInit(ui.page2obj(this._tui.center))):1==t.touches.length&&l.setLongTapTimeout(t)}),t.observe("touchmove",function(t){l.resetLongTapTimeout(!0),"_tui"in this&&2==t.touches.length&&(this._tui.center={pageX:(t.touches[0].pageX+t.touches[1].pageX)/2,pageY:(t.touches[0].pageY+t.touches[1].pageY)/2})}),t.observe("gesturestart",function(t){this._tui=this._tui||{},this._tui.scale0=ui.render.zoom,t.preventDefault()}),t.observe("gesturechange",function(t){ui.setZoomStaticPoint(this._tui.scale0*t.scale,ui.page2canvas2(this._tui.center)),ui.render.update(),t.preventDefault()}),t.observe("gestureend",function(t){delete this._tui,t.preventDefault()}),t.observe("onresize",function(t){r.onResize()}),"hiddenPaths"in rnd.ReStruct.prototype&&t.observe("touchend",function(t){if(0==t.touches.length)for(;rnd.ReStruct.prototype.hiddenPaths.length>0;)rnd.ReStruct.prototype.hiddenPaths.pop().remove()}),t.observe("touchend",function(t){return l.resetLongTapTimeout(!1),l.longTapFlag?(ui.render.current_tool&&ui.render.current_tool.processEvent("OnDblClick",l.longTapTouchstart),l.resetLongTapTimeout(!0),util.preventDefault(t)):void(0==t.touches.length&&ui.render.current_tool&&ui.render.current_tool.processEvent("OnMouseUp",t))}),this.opt.ignoreMouseEvents||["Click","DblClick","MouseDown","MouseMove","MouseUp","MouseLeave"].each(function(e){var i=e.toLowerCase();i=EventMap[i]||i,t.observe(i,function(n){if(!("MouseLeave"==e||ui&&ui.is_touch)){var r=t.cumulativeOffset();r=new util.Vec2(r[0],r[1]);var o=new util.Vec2(n.clientX,n.clientY).sub(r),s=new util.Vec2(t.clientWidth,t.clientHeight);if(!(o.x>0&&o.y>0&&o.x<s.x&&o.y<s.y))return"MouseMove"==e&&ui.render.current_tool.processEvent("OnMouseLeave",n),util.preventDefault(n)}return ui.render.current_tool.processEvent("On"+e,n),util.stopEventPropagation(n),"touchstart"==i||"touchmove"==i&&2==n.touches.length?void 0:util.preventDefault(n)})},this),this.ctab=new rnd.ReStruct(new chem.Struct,this),this.settings=null,this.styles=null,this.onCanvasOffsetChanged=null,this.onCanvasSizeChanged=null},rnd.Render.prototype.view2scaled=function(t,e){var i=ui.scrollPos();return this.useOldZoom||(t=t.scaled(1/this.zoom),i=i.scaled(1/this.zoom)),t=e?t:t.add(i).sub(this.offset)},rnd.Render.prototype.scaled2view=function(t,e){return t=e?t:t.add(this.offset).sub(ui.scrollPos().scaled(1/this.zoom)),this.useOldZoom||(t=t.scaled(this.zoom)),t},rnd.Render.prototype.scaled2obj=function(t){return t.scaled(1/this.settings.scaleFactor)},rnd.Render.prototype.obj2scaled=function(t){return t.scaled(this.settings.scaleFactor)},rnd.Render.prototype.view2obj=function(t,e){return this.scaled2obj(this.view2scaled(t,e))},rnd.Render.prototype.obj2view=function(t,e){return this.scaled2view(this.obj2scaled(t,e))},rnd.Render.prototype.findItem=function(t,e,i){var n=this.findClosestItem("ui"in window&&"page2obj"in ui?new util.Vec2(ui.page2obj(t)):new util.Vec2(t.pageX,t.pageY).sub(this.clientAreaPos),e,i);return"Atom"==n.type?n.map="atoms":"Bond"==n.type?n.map="bonds":"SGroup"==n.type?n.map="sgroups":"DataSGroupData"==n.type?n.map="sgroupData":"RxnArrow"==n.type?n.map="rxnArrows":"RxnPlus"==n.type?n.map="rxnPluses":"Fragment"==n.type?n.map="frags":"RGroup"==n.type?n.map="rgroups":"ChiralFlag"==n.type&&(n.map="chiralFlags"),n},rnd.Render.prototype.client2Obj=function(t){return new util.Vec2(t).sub(this.offset)},rnd.Render.prototype.setMolecule=function(t,e){rnd.logMethod("setMolecule"),this.paper.clear(),this.ctab=new rnd.ReStruct(t,this,e),this.offset=null,this.size=null,this.bb=null,this.rxnMode=t.isReaction},rnd.Render.prototype.atomGetAttr=function(t,e){return rnd.logMethod("atomGetAttr"),this.ctab.molecule.atoms.get(t)[e]},rnd.Render.prototype.invalidateAtom=function(t,e){var i=this.ctab.atoms.get(t);this.ctab.markAtom(t,e?1:0);for(var n=this.ctab.molecule.halfBonds,r=0;r<i.a.neighbors.length;++r){var o=i.a.neighbors[r];if(n.has(o)){var s=n.get(o);this.ctab.markBond(s.bid,1),this.ctab.markAtom(s.end,0),e&&this.invalidateLoop(s.bid)}}},rnd.Render.prototype.invalidateLoop=function(t){var e=this.ctab.bonds.get(t),i=this.ctab.molecule.halfBonds.get(e.b.hb1).loop,n=this.ctab.molecule.halfBonds.get(e.b.hb2).loop;i>=0&&this.ctab.loopRemove(i),n>=0&&this.ctab.loopRemove(n)},rnd.Render.prototype.invalidateBond=function(t){var e=this.ctab.bonds.get(t);this.invalidateLoop(t),this.invalidateAtom(e.b.begin,0),this.invalidateAtom(e.b.end,0)},rnd.Render.prototype.invalidateItem=function(t,e,i){"atoms"==t?this.invalidateAtom(e,i):"bonds"==t?(this.invalidateBond(e),i>0&&this.invalidateLoop(e)):this.ctab.markItem(t,e,i)},rnd.Render.prototype.atomGetDegree=function(t){return rnd.logMethod("atomGetDegree"),this.ctab.atoms.get(t).a.neighbors.length},rnd.Render.prototype.isBondInRing=function(t){var e=this.ctab.bonds.get(t);return this.ctab.molecule.halfBonds.get(e.b.hb1).loop>=0||this.ctab.molecule.halfBonds.get(e.b.hb2).loop>=0},rnd.Render.prototype.atomGetNeighbors=function(t){for(var e=this.ctab.atoms.get(t),i=[],n=0;n<e.a.neighbors.length;++n){var r=this.ctab.molecule.halfBonds.get(e.a.neighbors[n]);i.push({aid:r.end-0,bid:r.bid-0})}return i},rnd.Render.prototype.atomGetSGroups=function(t){rnd.logMethod("atomGetSGroups");var e=this.ctab.atoms.get(t);return util.Set.list(e.a.sgs)},rnd.Render.prototype.sGroupGetAttr=function(t,e){return rnd.logMethod("sGroupGetAttr"),this.ctab.sgroups.get(t).item.getAttr(e)},rnd.Render.prototype.sGroupGetAttrs=function(t){return rnd.logMethod("sGroupGetAttrs"),this.ctab.sgroups.get(t).item.getAttrs()},rnd.Render.prototype.sGroupGetAtoms=function(t){rnd.logMethod("sGroupGetAtoms");var e=this.ctab.sgroups.get(t).item;return chem.SGroup.getAtoms(this.ctab.molecule,e)},rnd.Render.prototype.sGroupGetType=function(t){rnd.logMethod("sGroupGetType");var e=this.ctab.sgroups.get(t).item;return e.type},rnd.Render.prototype.sGroupsFindCrossBonds=function(){rnd.logMethod("sGroupsFindCrossBonds"),this.ctab.molecule.sGroupsRecalcCrossBonds()},rnd.Render.prototype.sGroupGetNeighborAtoms=function(t){rnd.logMethod("sGroupGetNeighborAtoms");var e=this.ctab.sgroups.get(t).item;return e.neiAtoms},rnd.Render.prototype.atomIsPlainCarbon=function(t){return rnd.logMethod("atomIsPlainCarbon"),this.ctab.atoms.get(t).a.isPlainCarbon()},rnd.Render.prototype.highlightObject=function(t,e){if(!(["atoms","bonds","rxnArrows","rxnPluses","chiralFlags","frags","rgroups","sgroups","sgroupData"].indexOf(t.map)>-1))return!1;var i=this.ctab[t.map].get(t.id);if(null==i)return!0;if("sgroups"==t.map&&"DAT"==i.item.type||"sgroupData"==t.map){var n=this.ctab.sgroups.get(t.id),r=this.ctab.sgroupData.get(t.id);null!=n&&n.setHighlight(e,this),null!=r&&r.setHighlight(e,this)}else i.setHighlight(e,this);return!0},rnd.Render.prototype.itemGetPos=function(t,e){return this.ctab.molecule[t].get(e).pp},rnd.Render.prototype.atomGetPos=function(t){return rnd.logMethod("atomGetPos"),this.itemGetPos("atoms",t)},rnd.Render.prototype.rxnArrowGetPos=function(t){return rnd.logMethod("rxnArrowGetPos"),this.itemGetPos("rxnArrows",t)},rnd.Render.prototype.rxnPlusGetPos=function(t){return rnd.logMethod("rxnPlusGetPos"),this.itemGetPos("rxnPluses",t)},rnd.Render.prototype.getAdjacentBonds=function(t){for(var e=util.Set.fromList(t),i=util.Set.empty(),n=util.Set.empty(),r=0;r<t.length;++r)for(var o=t[r],s=this.ctab.atoms.get(o),a=0;a<s.a.neighbors.length;++a){var l=s.a.neighbors[a],u=this.ctab.molecule.halfBonds.get(l),c=u.end,h=util.Set.contains(e,c)?i:n;util.Set.add(h,u.bid)}return{inner:i,cross:n}},rnd.Render.prototype.bondGetAttr=function(t,e){return rnd.logMethod("bondGetAttr"),this.ctab.bonds.get(t).b[e]},rnd.Render.prototype.setSelection=function(t){rnd.logMethod("setSelection");for(var e in rnd.ReStruct.maps)if(rnd.ReStruct.maps[e].isSelectable()){var i=t?t[e]?util.identityMap(t[e]):{}:null;this.ctab[e].each(function(t,e){var n=i?i[t]===t:e.selected;e.selected=n,this.ctab.showItemSelection(t,e,n)},this)}},rnd.Render.prototype.initStyles=function(){var t=this.settings;this.styles={},this.styles.lineattr={stroke:"#000","stroke-width":t.lineWidth,"stroke-linecap":"round","stroke-linejoin":"round"},this.styles.selectionStyle={fill:"#7f7",stroke:"none"},this.styles.selectionZoneStyle={fill:"#000",stroke:"none",opacity:0},this.styles.highlightStyle={stroke:"#0c0","stroke-width":.6*t.lineWidth},this.styles.sGroupHighlightStyle={stroke:"#9900ff","stroke-width":.6*t.lineWidth},this.styles.sgroupBracketStyle={stroke:"darkgray","stroke-width":.5*t.lineWidth},this.styles.atomSelectionPlateRadius=1.2*t.labelFontSize},rnd.Render.prototype.initSettings=function(){var t=this.settings={};t.delta=this.ctab.molecule.getCoordBoundingBox(),t.margin=.1,t.scaleFactor=this.scale,t.lineWidth=t.scaleFactor/20,t.bondShift=t.scaleFactor/6,t.bondSpace=t.scaleFactor/7,t.labelFontSize=Math.ceil(1.9*(t.scaleFactor/6)),t.subFontSize=Math.ceil(.7*t.labelFontSize),t.font='30px "Arial"',t.fontsz=this.settings.labelFontSize,t.fontszsub=this.settings.subFontSize,t.fontRLabel=1.2*this.settings.labelFontSize,t.fontRLogic=.7*this.settings.labelFontSize},rnd.Render.prototype.getStructCenter=function(t){var e=this.ctab.getVBoxObj(t);return util.Vec2.lc2(e.p0,.5,e.p1,.5)},rnd.Render.prototype.onResize=function(){this.setViewSize(new util.Vec2(this.clientArea.clientWidth,this.clientArea.clientHeight))},rnd.Render.prototype.setViewSize=function(t){this.viewSz=new util.Vec2(t)},rnd.Render.prototype._setPaperSize=function(t){var e=this.zoom;this.paper.setSize(t.x*e,t.y*e),this.setViewBox(e)},rnd.Render.prototype.setPaperSize=function(t){rnd.logMethod("setPaperSize");var e=this.sz;this.sz=t,this._setPaperSize(t),this.onCanvasSizeChanged&&this.onCanvasSizeChanged(t,e)},rnd.Render.prototype.setOffset=function(t){rnd.logMethod("setOffset");var e=this.offset;this.offset=t,this.onCanvasOffsetChanged&&this.onCanvasOffsetChanged(t,e)},rnd.Render.prototype.getElementPos=function(t){var e=0,i=0;if(t.offsetParent)do e+=t.offsetLeft,i+=t.offsetTop;while(t=t.offsetParent);return new util.Vec2(e,i)},rnd.Render.prototype.drawSelectionLine=function(t,e){rnd.logMethod("drawSelectionLine"),this.selectionRect&&(this.selectionRect.remove(),this.selectionRect=null),t&&e&&(t=this.obj2scaled(t).add(this.offset),e=this.obj2scaled(e).add(this.offset),this.selectionRect=this.paper.path(rnd.ReStruct.makeStroke(t,e)).attr({stroke:"gray","stroke-width":"1px"}))},rnd.Render.prototype.drawSelectionRectangle=function(t,e){rnd.logMethod("drawSelectionRectangle"),this.selectionRect&&(this.selectionRect.remove(),this.selectionRect=null),t&&e&&(t=this.obj2scaled(t).add(this.offset),e=this.obj2scaled(e).add(this.offset),this.selectionRect=this.paper.rect(Math.min(t.x,e.x),Math.min(t.y,e.y),Math.abs(e.x-t.x),Math.abs(e.y-t.y)).attr({stroke:"gray","stroke-width":"1px"}))},rnd.Render.prototype.getElementsInRectangle=function(t,e){rnd.logMethod("getElementsInRectangle");var i=new Array,n=new Array,r=Math.min(t.x,e.x),o=Math.max(t.x,e.x),s=Math.min(t.y,e.y),a=Math.max(t.y,e.y);this.ctab.bonds.each(function(t,e){var n=util.Vec2.lc2(this.ctab.atoms.get(e.b.begin).a.pp,.5,this.ctab.atoms.get(e.b.end).a.pp,.5);n.x>r&&n.x<o&&n.y>s&&n.y<a&&i.push(t)},this),this.ctab.atoms.each(function(t,e){e.a.pp.x>r&&e.a.pp.x<o&&e.a.pp.y>s&&e.a.pp.y<a&&n.push(t)},this);var l=new Array,u=new Array;this.ctab.rxnArrows.each(function(t,e){e.item.pp.x>r&&e.item.pp.x<o&&e.item.pp.y>s&&e.item.pp.y<a&&l.push(t)},this),this.ctab.rxnPluses.each(function(t,e){e.item.pp.x>r&&e.item.pp.x<o&&e.item.pp.y>s&&e.item.pp.y<a&&u.push(t)},this);var c=new Array;this.ctab.chiralFlags.each(function(t,e){e.pp.x>r&&e.pp.x<o&&e.pp.y>s&&e.pp.y<a&&c.push(t)},this);var h=new Array;return this.ctab.sgroupData.each(function(t,e){e.sgroup.pp.x>r&&e.sgroup.pp.x<o&&e.sgroup.pp.y>s&&e.sgroup.pp.y<a&&h.push(t)},this),{atoms:n,bonds:i,rxnArrows:l,rxnPluses:u,chiralFlags:c,sgroupData:h}},rnd.Render.prototype.drawSelectionPolygon=function(t){if(rnd.logMethod("drawSelectionPolygon"),this.selectionRect&&(this.selectionRect.remove(),this.selectionRect=null),t&&t.length>1){for(var e=this.obj2scaled(t[t.length-1]).add(this.offset),i="M"+tfx(e.x)+","+tfx(e.y),n=0;n<t.length;++n)e=this.obj2scaled(t[n]).add(this.offset),i+="L"+tfx(e.x)+","+tfx(e.y);this.selectionRect=this.paper.path(i).attr({stroke:"gray","stroke-width":"1px"})}},rnd.Render.prototype.isPointInPolygon=function(t,e){for(var i=new util.Vec2(0,1),n=i.rotate(Math.PI/2),r=util.Vec2.diff(t[t.length-1],e),o=util.Vec2.dot(n,r),s=util.Vec2.dot(i,r),a=null,l=0,u=1e-5,c=!1,h=!1,d=0;d<t.length;++d){var p=util.Vec2.diff(t[d],e),f=util.Vec2.diff(p,r),m=util.Vec2.dot(n,p),g=util.Vec2.dot(i,p);c=!1,0>m*o&&(g*s>-u?s>-u&&(c=!0):(Math.abs(o)*Math.abs(g)-Math.abs(m)*Math.abs(s))*g>0&&(c=!0)),c&&h&&util.Vec2.dot(f,n)*util.Vec2(a,n)>=0&&(c=!1),c&&l++,r=p,o=m,s=g,a=f,h=c}return l%2!=0},rnd.Render.prototype.ps=function(t){return t.scaled(this.settings.scaleFactor)},rnd.Render.prototype.getElementsInPolygon=function(t){rnd.logMethod("getElementsInPolygon");for(var e=new Array,i=new Array,n=[],r=0;r<t.length;++r)n[r]=new util.Vec2(t[r].x,t[r].y);this.ctab.bonds.each(function(t,i){var r=util.Vec2.lc2(this.ctab.atoms.get(i.b.begin).a.pp,.5,this.ctab.atoms.get(i.b.end).a.pp,.5);this.isPointInPolygon(n,r)&&e.push(t)},this),this.ctab.atoms.each(function(t,e){this.isPointInPolygon(n,e.a.pp)&&i.push(t)},this);var o=new Array,s=new Array;this.ctab.rxnArrows.each(function(t,e){this.isPointInPolygon(n,e.item.pp)&&o.push(t)},this),this.ctab.rxnPluses.each(function(t,e){this.isPointInPolygon(n,e.item.pp)&&s.push(t)},this);var a=new Array;this.ctab.chiralFlags.each(function(t,e){this.isPointInPolygon(n,e.pp)&&a.push(t)},this);var l=new Array;return this.ctab.sgroupData.each(function(t,e){this.isPointInPolygon(n,e.sgroup.pp)&&l.push(t)},this),{atoms:i,bonds:e,rxnArrows:o,rxnPluses:s,chiralFlags:a,sgroupData:l}},rnd.Render.prototype.testPolygon=function(t){if(t=t||[{x:50,y:10},{x:20,y:90},{x:90,y:30},{x:10,y:30},{x:90,y:80}],!(t.length<3)){for(var e=t[0],i=t[0],n=1;n<t.length;++n)e=util.Vec2.min(e,t[n]),i=util.Vec2.max(i,t[n]);this.drawSelectionPolygon(t);for(var r=0;1e3>r;++r){var o=new util.Vec2(Math.random()*zz,Math.random()*zz),s=this.isPointInPolygon(t,o),a=s?"#0f0":"#f00";this.paper.circle(o.x,o.y,2).attr({fill:a,stroke:"none"})}this.drawSelectionPolygon(t)}},rnd.Render.prototype.update=function(t){if(rnd.logMethod("update"),!this.settings||this.dirty){if(this.opt.autoScale){var e=this.ctab.molecule.getCoordBoundingBox(),i=e.max.y-e.min.y>0?.8*this.viewSz.y/(e.max.y-e.min.y):100,n=e.max.x-e.min.x>0?.8*this.viewSz.x/(e.max.x-e.min.x):100;this.scale=Math.min(i,n)}this.initSettings(),this.initStyles(),this.dirty=!1,t=!0}var r=(new Date).getTime(),o=this.ctab.update(t);this.setSelection(null);var s=(new Date).getTime()-r;if(t&&$("log")&&($("log").innerHTML=s.toString()+"\n"),o){var a=this.settings.scaleFactor,l=this.ctab.getVBoxObj().transform(this.obj2scaled,this).translate(this.offset||new util.Vec2);if(this.opt.autoScale){var u=l.sz(),c=this.opt.autoScaleMargin,h=new util.Vec2(c,c),d=this.viewSz;if(d.x<2*c+1||d.y<2*c+1)throw new Error("View box too small for the given margin");var p=Math.max(u.x/(d.x-2*c),u.y/(d.y-2*c)),f=u.add(h.scaled(2*p));this.paper.setViewBox(l.pos().x-c*p-(d.x*p-f.x)/2,l.pos().y-c*p-(d.y*p-f.y)/2,d.x*p,d.y*p)}else{var m=util.Vec2.UNIT.scaled(a);l=l.extend(m,m),this.bb||(this.bb=new util.Box2Abs(util.Vec2.ZERO,this.viewSz)),this.bb=util.Box2Abs.union(this.bb,l),l=this.bb.clone();var g=util.Vec2.max(l.sz().floor(),this.viewSz),b=l.p0.negated().ceil();(!this.sz||g.x>this.sz.x||g.y>this.sz.y)&&this.setPaperSize(g);var v=this.offset||new util.Vec2,y=b.sub(v);(!this.offset||y.x>0||y.y>0)&&(this.setOffset(b),this.ctab.translate(y),this.bb.translate(y))}}},rnd.Render.prototype.checkBondExists=function(t,e){return this.ctab.molecule.checkBondExists(t,e)},rnd.Render.prototype.findClosestAtom=function(t,e,i){var n=null,r=this.opt.selectionDistanceCoefficient;return e=e||r,e=Math.min(e,r),this.ctab.atoms.each(function(r,o){if(r!=i){var s=util.Vec2.dist(t,o.a.pp);e>s&&(n=r,e=s)}},this),null!=n?{id:n,dist:e}:null},rnd.Render.prototype.findClosestBond=function(t,e){var i=null,n=null,r=this.opt.selectionDistanceCoefficient;e=e||r,e=Math.min(e,r);var o=e;return this.ctab.bonds.each(function(e,i){var r=this.ctab.atoms.get(i.b.begin).a.pp,s=this.ctab.atoms.get(i.b.end).a.pp,a=util.Vec2.lc2(r,.5,s,.5),l=util.Vec2.dist(t,a);o>l&&(o=l,n=e)},this),this.ctab.bonds.each(function(n,r){var o=this.ctab.molecule.halfBonds.get(r.b.hb1),s=o.dir,a=o.norm,l=this.ctab.atoms.get(r.b.begin).a.pp,u=this.ctab.atoms.get(r.b.end).a.pp,c=util.Vec2.dot(t.sub(l),s)*util.Vec2.dot(t.sub(u),s)<0;if(c){var h=Math.abs(util.Vec2.dot(t.sub(l),a));e>h&&(i=n,e=h)}},this),null!==i||null!==n?{id:i,dist:e,cid:n,cdist:o}:null},rnd.Render.prototype.findClosestItem=function(t,e,i){var n=null,r=function(t,e,i){null!=e&&(null==n||n.dist>e.dist||i)&&(n={type:t,id:e.id,dist:e.dist})};if(!e||e.indexOf("atoms")>=0){var o=this.findClosestAtom(t,void 0,Object.isUndefined(i)||"atoms"!=i.map?void 0:i.id);r("Atom",o)}if(!e||e.indexOf("bonds")>=0){var s=this.findClosestBond(t);s&&(null!==s.cid&&r("Bond",{id:s.cid,dist:s.cdist}),(null==n||n.dist>.4*this.scale)&&r("Bond",s))}if(!e||e.indexOf("chiralFlags")>=0){var a=rnd.ReChiralFlag.findClosest(this,t);r("ChiralFlag",a)}if(!e||e.indexOf("sgroupData")>=0){var l=rnd.ReDataSGroupData.findClosest(this,t);r("DataSGroupData",l)}if(!e||e.indexOf("sgroups")>=0){var u=rnd.ReSGroup.findClosest(this,t);r("SGroup",u)}if(!e||e.indexOf("rxnArrows")>=0){var c=rnd.ReRxnArrow.findClosest(this,t);r("RxnArrow",c)}if(!e||e.indexOf("rxnPluses")>=0){var h=rnd.ReRxnPlus.findClosest(this,t);r("RxnPlus",h)}if(!e||e.indexOf("frags")>=0){var d=rnd.ReFrag.findClosest(this,t,i&&"atoms"==i.map?i.id:void 0);r("Fragment",d)}if(!e||e.indexOf("rgroups")>=0){var p=rnd.ReRGroup.findClosest(this,t);r("RGroup",p)}return n=n||{type:"Canvas",id:-1}},rnd.Render.prototype.setZoom=function(t){this.zoom=t,this._setPaperSize(this.sz)},rnd.Render.prototype.extendCanvas=function(t,e,i,n){var r=0,o=0,s=0,a=0;t-=0,i-=0,e-=0,n-=0,0>t&&(r+=-t,s+=-t),0>e&&(o+=-e,a+=-e);var l=this.sz.x*this.zoom,u=this.sz.y*this.zoom;i>l&&(r+=i-l),n>u&&(o+=n-u);var c=new util.Vec2(s,a).scaled(1/this.zoom);if(o>0||r>0){var h=new util.Vec2(r,o).scaled(1/this.zoom),d=this.sz.add(h);this.setPaperSize(d),(c.x>0||c.y>0)&&(this.setOffset(this.offset.add(c)),this.ctab.translate(c),this.bb.translate(c))}return c},rnd.Render.prototype.setScale=function(t){this.offset&&(this.offset=this.offset.scaled(1/t).scaled(this.zoom)),this.scale=this.baseScale*this.zoom,this.settings=null,this.update(!0)},rnd.Render.prototype.setViewBox=function(t){this.useOldZoom?this.setScale(t):this.paper.canvas.setAttribute("viewBox","0 0 "+this.sz.x+" "+this.sz.y)},!window.rnd)throw new Error("rnd should be defined prior to loading this file");if(rnd.templates=[{name:"benzene",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  6  6  0     0  0            999 V2000\n    0.8660    2.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7320    1.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7320    0.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.8660    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    0.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    1.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  2  3  2  0     0  0\n  3  4  1  0     0  0\n  4  5  2  0     0  0\n  5  6  1  0     0  0\n  6  1  2  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclopentadiene",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  5  5  0     0  0            999 V2000\n    0.0000    1.4257    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.8090    0.8379    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.5000   -0.1132    0.0000 C   0  0  0  0  0  0        0  0  0\n   -0.5000   -0.1132    0.0000 C   0  0  0  0  0  0        0  0  0\n   -0.8090    0.8379    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  2  3  2  0     0  0\n  3  4  1  0     0  0\n  4  5  2  0     0  0\n  5  1  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclohexane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  6  6  0     0  0            999 V2000\n    0.8660    2.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7320    1.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7320    0.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.8660    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    0.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    1.5000    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  2  3  1  0     0  0\n  3  4  1  0     0  0\n  4  5  1  0     0  0\n  5  6  1  0     0  0\n  6  1  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclopentane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  5  5  0     0  0            999 V2000\n    0.8090    1.5389    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.6180    0.9511    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.3090    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.3090    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    0.9511    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  2  3  1  0     0  0\n  3  4  1  0     0  0\n  4  5  1  0     0  0\n  5  1  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclopropane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  3  3  0     0  0            999 V2000\n   -3.2250   -0.2750    0.0000 C   0  0  0  0  0  0        0  0  0\n   -2.2250   -0.2750    0.0000 C   0  0  0  0  0  0        0  0  0\n   -2.7250    0.5910    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  2  3  1  0     0  0\n  1  3  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclobutane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  4  4  0     0  0            999 V2000\n   -3.8250    1.5500    0.0000 C   0  0  0  0  0  0        0  0  0\n   -3.8250    0.5500    0.0000 C   0  0  0  0  0  0        0  0  0\n   -2.8250    1.5500    0.0000 C   0  0  0  0  0  0        0  0  0\n   -2.8250    0.5500    0.0000 C   0  0  0  0  0  0        0  0  0\n  1  2  1  0     0  0\n  1  3  1  0     0  0\n  3  4  1  0     0  0\n  4  2  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cycloheptane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  7  7  0     0  0            999 V2000\n    0.0000    1.6293    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.7835    2.2465    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7559    2.0242    0.0000 C   0  0  0  0  0  0        0  0  0\n    2.1897    1.1289    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    0.6228    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7566    0.2224    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.7835    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n  6  7  1  0     0  0\n  5  7  1  0     0  0\n  1  5  1  0     0  0\n  4  6  1  0     0  0\n  3  4  1  0     0  0\n  2  3  1  0     0  0\n  1  2  1  0     0  0\nM  END\n",bid:0,aid:0},{name:"cyclooctane",molfile:"\n  Ketcher 11161218352D 1   1.00000     0.00000     0\n\n  8  8  0     0  0            999 V2000\n    0.0000    0.7053    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.0000    1.7078    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.7053    2.4131    0.0000 C   0  0  0  0  0  0        0  0  0\n    0.7056    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7079    0.0000    0.0000 C   0  0  0  0  0  0        0  0  0\n    2.4133    0.7053    0.0000 C   0  0  0  0  0  0        0  0  0\n    2.4133    1.7078    0.0000 C   0  0  0  0  0  0        0  0  0\n    1.7079    2.4131    0.0000 C   0  0  0  0  0  0        0  0  0\n  8  3  1  0     0  0\n  7  8  1  0     0  0\n  6  7  1  0     0  0\n  5  6  1  0     0  0\n  4  5  1  0     0  0\n  1  4  1  0     0  0\n  2  3  1  0     0  0\n  1  2  1  0     0  0\nM  END\n",bid:0,aid:0}],!window.Prototype)throw new Error("Prototype.js should be loaded first");if(!window.rnd||!rnd.ReStruct)throw new Error("rnd.MolData should be defined prior to loading this file");if(rnd.Editor=function(t){this.ui=ui,this.render=t,this._selectionHelper=new rnd.Editor.SelectionHelper(this)},rnd.Editor.prototype.selectAll=function(){var t={};for(var e in rnd.ReStruct.maps)t[e]=ui.render.ctab[e].ikeys();this._selectionHelper.setSelection(t)},rnd.Editor.prototype.deselectAll=function(){this._selectionHelper.setSelection()},rnd.Editor.prototype.hasSelection=function(t){if("selection"in this._selectionHelper)for(var e in this._selectionHelper.selection)if(this._selectionHelper.selection[e].length>0&&(!t||"sgroupData"!==e))return!0;return!1},rnd.Editor.prototype.getSelection=function(t){var e={};if("selection"in this._selectionHelper)for(var i in this._selectionHelper.selection)e[i]=this._selectionHelper.selection[i].slice(0);if(t){var n=this.render.ctab.molecule;"bonds"in e&&e.bonds.each(function(t){var i=n.bonds.get(t);e.atoms=e.atoms||[],e.atoms.indexOf(i.begin)<0&&e.atoms.push(i.begin),e.atoms.indexOf(i.end)<0&&e.atoms.push(i.end)},this),"atoms"in e&&"bonds"in e&&n.bonds.each(function(t){if(!("bonds"in e)||e.bonds.indexOf(t)<0){var i=n.bonds.get(t);e.atoms.indexOf(i.begin)>=0&&e.atoms.indexOf(i.end)>=0&&(e.bonds=e.bonds||[],e.bonds.push(t))}},this)}return e},rnd.Editor.prototype.toolFor=function(t){return"selector_lasso"==t?new rnd.Editor.LassoTool(this,0):"selector_square"==t?new rnd.Editor.LassoTool(this,1):"selector_fragment"==t?new rnd.Editor.LassoTool(this,1,!0):"select_erase"==t?new rnd.Editor.EraserTool(this,1):t.startsWith("atom_")?new rnd.Editor.AtomTool(this,ui.atomLabel(t)):t.startsWith("bond_")?new rnd.Editor.BondTool(this,ui.bondType(t)):"chain"==t?new rnd.Editor.ChainTool(this):t.startsWith("template_")?new rnd.Editor.TemplateTool(this,rnd.templates[parseInt(t.split("_")[1])]):t.startsWith("customtemplate_")?new rnd.Editor.TemplateTool(this,rnd.customtemplates[parseInt(t.split("_")[1])]):"charge_plus"==t?new rnd.Editor.ChargeTool(this,1):"charge_minus"==t?new rnd.Editor.ChargeTool(this,-1):"sgroup"==t?new rnd.Editor.SGroupTool(this):"paste"==t?new rnd.Editor.PasteTool(this):"reaction_arrow"==t?new rnd.Editor.ReactionArrowTool(this):"reaction_plus"==t?new rnd.Editor.ReactionPlusTool(this):"reaction_map"==t?new rnd.Editor.ReactionMapTool(this):"reaction_unmap"==t?new rnd.Editor.ReactionUnmapTool(this):"rgroup_label"==t?new rnd.Editor.RGroupAtomTool(this):"rgroup_fragment"==t?new rnd.Editor.RGroupFragmentTool(this):"rgroup_attpoints"==t?new rnd.Editor.APointTool(this):t.startsWith("transform_rotate")?new rnd.Editor.RotateTool(this):null;
},rnd.Editor.SelectionHelper=function(t){this.editor=t},rnd.Editor.SelectionHelper.prototype.setSelection=function(t,e){if(!("selection"in this&&e)){this.selection={};for(var i in rnd.ReStruct.maps)this.selection[i]=[]}if(t&&"id"in t&&"map"in t&&(t[t.map]=t[t.map]||[]).push(t.id),t)for(var n in this.selection)if(n in t)for(var r=0;r<t[n].length;r++)this.selection[n].indexOf(t[n][r])<0&&this.selection[n].push(t[n][r]);this.editor.render.setSelection(this.selection),this.editor.render.update(),ui.updateClipboardButtons()},rnd.Editor.SelectionHelper.prototype.isSelected=function(t){var e=this.editor.render,i=e.ctab;if("frags"==t.map||"rgroups"==t.map){var n="frags"==t.map?i.frags.get(t.id).fragGetAtoms(e,t.id):i.rgroups.get(t.id).getAtoms(e);return!Object.isUndefined(this.selection.atoms)&&util.Set.subset(util.Set.fromList(n),util.Set.fromList(this.selection.atoms))}return"selection"in this&&!Object.isUndefined(this.selection[t.map])&&this.selection[t.map].indexOf(t.id)>-1},rnd.Editor.EditorTool=function(t){this.editor=t},rnd.Editor.EditorTool.prototype.processEvent=function(t,e,i){if("touches"in e&&1!=e.touches.length){if("lastEvent"in this.OnMouseDown0)return this.OnMouseUp0(e,i)}else{if(t+"0"in this)return this[t+"0"](e,i);if(t in this)return this[t](e,i)}},rnd.Editor.EditorTool.prototype.OnMouseDown=function(){},rnd.Editor.EditorTool.prototype.OnMouseMove=function(){},rnd.Editor.EditorTool.prototype.OnMouseUp=function(){},rnd.Editor.EditorTool.prototype.OnClick=function(){},rnd.Editor.EditorTool.prototype.OnDblClick=function(){},rnd.Editor.EditorTool.prototype.OnMouseLeave=function(){this.OnCancel()},rnd.Editor.EditorTool.prototype.OnKeyPress=function(){},rnd.Editor.EditorTool.prototype.OnCancel=function(){},rnd.Editor.EditorTool.prototype.OnMouseDown0=function(t){return this.editor.ui.hideBlurredControls()?!0:(this.OnMouseDown0.lastEvent=t,this.OnMouseMove0.lastEvent=t,"OnMouseDown"in this?this.OnMouseDown(t):void 0)},rnd.Editor.EditorTool.prototype.OnMouseMove0=function(t){return this.OnMouseMove0.lastEvent=t,"OnMouseMove"in this?this.OnMouseMove(t):void 0},rnd.Editor.EditorTool.prototype.OnMouseUp0=function(t){if(!("lastEvent"in this.OnMouseDown0))return!0;"lastEvent"in this.OnMouseMove0&&(t=Object.clone(t),t.pageX=this.OnMouseMove0.lastEvent.pageX,t.pageY=this.OnMouseMove0.lastEvent.pageY);try{if("OnMouseUp"in this)return this.OnMouseUp(t)}finally{delete this.OnMouseDown0.lastEvent}},rnd.Editor.EditorTool.atom_label_map={atom_tool_any:"A",atom_tool_h:"H",atom_tool_c:"C",atom_tool_n:"N",atom_tool_o:"O",atom_tool_s:"S",atom_tool_p:"P",atom_tool_f:"F",atom_tool_br:"Br",atom_tool_cl:"Cl",atom_tool_i:"I"},rnd.Editor.EditorTool.prototype.OnKeyPress0=function(t,e){if("rgroup_tool_label"===e&&"lastEvent"in this.OnMouseMove0)return rnd.Editor.RGroupAtomTool.prototype.OnMouseUp.call(this,this.OnMouseMove0.lastEvent);if(e in rnd.Editor.EditorTool.atom_label_map){var i=rnd.Editor.EditorTool.atom_label_map[e],n=this.editor.getSelection();if(n&&"atoms"in n&&n.atoms.length>0)return this.editor.ui.addUndoAction(this.editor.ui.Action.fromAtomsAttrs(n.atoms,{label:i},!0),!0),this.editor.ui.render.update(),!0;var r=this.editor.render.findItem(this.OnMouseMove0.lastEvent);if(r)return r.label={label:i},"atoms"===r.map?this.editor.ui.addUndoAction(ui.Action.fromAtomsAttrs(r.id,r.label,!0),!0):-1==r.id&&this.editor.ui.addUndoAction(this.editor.ui.Action.fromAtomAddition(this.editor.ui.page2obj(this.OnMouseMove0.lastEvent),r.label),!0),this.editor.ui.render.update(),!0}return"OnKeyPress"in this?this.OnKeyPress(t):!1},rnd.Editor.EditorTool.prototype._calcAngle=function(t,e){var i=util.Vec2.diff(e,t),n=Math.atan2(i.y,i.x),r=0>n?-1:1,o=Math.floor(Math.abs(n)/(Math.PI/12))*(Math.PI/12);return n=r*(o+(Math.abs(n)-o<Math.PI/24?0:Math.PI/12))},rnd.Editor.EditorTool.prototype._calcNewAtomPos=function(t,e){var i=new util.Vec2(1,0).rotate(this._calcAngle(t,e));return i.add_(t),i},rnd.Editor.EditorTool.HoverHelper=function(t){this.editorTool=t},rnd.Editor.EditorTool.HoverHelper.prototype.hover=function(t){t&&"Canvas"==t.type&&(t=null),"ci"in this&&(!t||this.ci.type!=t.type||this.ci.id!=t.id)&&(this.editorTool.editor.render.highlightObject(this.ci,!1),delete this.ci),t&&this.editorTool.editor.render.highlightObject(t,!0)&&(this.ci=t)},rnd.Editor.LassoTool=function(t,e,i){this.editor=t,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this),this._lassoHelper=new rnd.Editor.LassoTool.LassoHelper(e||0,t,i),this._sGroupHelper=new rnd.Editor.SGroupTool.SGroupHelper(t)},rnd.Editor.LassoTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.LassoTool.prototype.OnMouseDown=function(t){var e=this.editor.render,i=e.ctab,n=i.molecule;this._hoverHelper.hover(null);var r=this._lassoHelper.fragment||t.ctrlKey,o=this.editor.render.findItem(t,r?["frags","sgroups","sgroupData","rgroups","rxnArrows","rxnPluses","chiralFlags"]:["atoms","bonds","sgroups","sgroupData","rgroups","rxnArrows","rxnPluses","chiralFlags"]);if(o&&"Canvas"!=o.type){if(this._hoverHelper.hover(null),"onShowLoupe"in this.editor.render&&this.editor.render.onShowLoupe(!0),!this.editor._selectionHelper.isSelected(o))if("frags"==o.map){var s=i.frags.get(o.id);this.editor._selectionHelper.setSelection({atoms:s.fragGetAtoms(e,o.id),bonds:s.fragGetBonds(e,o.id)},t.shiftKey)}else if("sgroups"==o.map){var a=i.sgroups.get(o.id).item;this.editor._selectionHelper.setSelection({atoms:chem.SGroup.getAtoms(n,a),bonds:chem.SGroup.getBonds(n,a)},t.shiftKey)}else if("rgroups"==o.map){var l=i.rgroups.get(o.id);this.editor._selectionHelper.setSelection({atoms:l.getAtoms(e),bonds:l.getBonds(e)},t.shiftKey)}else this.editor._selectionHelper.setSelection(o,t.shiftKey);if(this.dragCtx={item:o,xy0:this.editor.ui.page2obj(t)},"atoms"==o.map&&!this.editor.ui.is_touch){var u=this;this.dragCtx.timeout=setTimeout(function(){delete u.dragCtx,u.editor._selectionHelper.setSelection(null),u.editor.ui.showLabelEditor(o.id)},750),this.dragCtx.stopTapping=function(){"timeout"in u.dragCtx&&(clearTimeout(u.dragCtx.timeout),delete u.dragCtx.timeout)}}}else this._lassoHelper.fragment||this._lassoHelper.begin(t);return!0},rnd.Editor.LassoTool.prototype.OnMouseMove=function(t){if("dragCtx"in this){if("stopTapping"in this.dragCtx&&this.dragCtx.stopTapping(),this.dragCtx.action&&(this.dragCtx.action.perform(),this.editor.render.update()),this.dragCtx.action=ui.Action.fromMultipleMove(this.editor.getSelection(!0),this.editor.ui.page2obj(t).sub(this.dragCtx.xy0)),["atoms"].indexOf(this.dragCtx.item.map)>=0){var e=this.editor.render.findItem(t,[this.dragCtx.item.map],this.dragCtx.item);this._hoverHelper.hover(e.map==this.dragCtx.item.map?e:null)}this.editor.render.update()}else this._lassoHelper.running()?this.editor._selectionHelper.setSelection(this._lassoHelper.addPoint(t),t.shiftKey):this._hoverHelper.hover(this.editor.render.findItem(t,this._lassoHelper.fragment||t.ctrlKey?["frags","sgroups","sgroupData","rgroups","rxnArrows","rxnPluses","chiralFlags"]:["atoms","bonds","sgroups","sgroupData","rgroups","rxnArrows","rxnPluses","chiralFlags"]));return!0},rnd.Editor.LassoTool.prototype.OnMouseUp=function(t){if("dragCtx"in this){if("stopTapping"in this.dragCtx&&this.dragCtx.stopTapping(),["atoms"].indexOf(this.dragCtx.item.map)>=0){var e=this.editor.render.findItem(t,[this.dragCtx.item.map],this.dragCtx.item);e.map==this.dragCtx.item.map&&(this._hoverHelper.hover(null),this.editor._selectionHelper.setSelection(),this.dragCtx.action=this.dragCtx.action?this.editor.ui.Action.fromAtomMerge(this.dragCtx.item.id,e.id).mergeWith(this.dragCtx.action):this.editor.ui.Action.fromAtomMerge(this.dragCtx.item.id,e.id))}this.editor.ui.addUndoAction(this.dragCtx.action,!0),this.editor.render.update(),delete this.dragCtx}else this._lassoHelper.running()?this.editor._selectionHelper.setSelection(this._lassoHelper.end(),t.shiftKey):this._lassoHelper.fragment&&this.editor._selectionHelper.setSelection();return!0},rnd.Editor.LassoTool.prototype.OnDblClick=function(t){var e=this.editor.render.findItem(t);if("atoms"==e.map){this.editor._selectionHelper.setSelection(e);var i=this.editor.ui.ctab.atoms.get(e.id);"R#"==i.label?rnd.Editor.RGroupAtomTool.prototype.OnMouseUp.call(this,t):"L#"==i.label?ui.showElemTable({selection:i,onOk:function(t){return i.label==t.label&&i.atomList.equals(t.atomList)||(this.editor.ui.addUndoAction(this.editor.ui.Action.fromAtomsAttrs(e.id,t)),this.editor.ui.render.update()),!0}.bind(this)}):(chem.Element.getElementByLabel(i.label)||121)<120?this.editor.ui.showAtomProperties(e.id):ui.showReaGenericsTable({selection:i.label,onOk:function(t){return i.label!=t.label&&(this.editor.ui.addUndoAction(this.editor.ui.Action.fromAtomsAttrs(e.id,t)),this.editor.ui.render.update()),!0}.bind(this)})}else"bonds"==e.map?(this.editor._selectionHelper.setSelection(e),this.editor.ui.showBondProperties(e.id)):"sgroups"==e.map&&(this.editor._selectionHelper.setSelection(e),this._sGroupHelper.showPropertiesDialog(e.id));return!0},rnd.Editor.LassoTool.prototype.OnCancel=function(){"dragCtx"in this?("stopTapping"in this.dragCtx&&this.dragCtx.stopTapping(),this.editor.ui.addUndoAction(this.dragCtx.action,!0),this.editor.render.update(),delete this.dragCtx):this._lassoHelper.running()&&this.editor._selectionHelper.setSelection(this._lassoHelper.end()),this._hoverHelper.hover(null)},rnd.Editor.LassoTool.LassoHelper=function(t,e,i){this.mode=t,this.fragment=i,this.editor=e},rnd.Editor.LassoTool.LassoHelper.prototype.getSelection=function(){if(0==this.mode)return this.editor.ui.render.getElementsInPolygon(this.points);if(1==this.mode)return this.editor.ui.render.getElementsInRectangle(this.points[0],this.points[1]);throw new Error("Selector mode unknown")},rnd.Editor.LassoTool.LassoHelper.prototype.begin=function(t){this.points=[this.editor.ui.page2obj(t)],1==this.mode&&this.points.push(this.points[0])},rnd.Editor.LassoTool.LassoHelper.prototype.running=function(){return"points"in this},rnd.Editor.LassoTool.LassoHelper.prototype.addPoint=function(t){return this.running()?(0==this.mode?(this.points.push(this.editor.ui.page2obj(t)),this.editor.render.drawSelectionPolygon(this.points)):1==this.mode&&(this.points=[this.points[0],this.editor.ui.page2obj(t)],this.editor.render.drawSelectionRectangle(this.points[0],this.points[1])),this.getSelection()):!1},rnd.Editor.LassoTool.LassoHelper.prototype.end=function(){var t=this.getSelection();return"points"in this&&(this.editor.render.drawSelectionPolygon(null),delete this.points),t},rnd.Editor.EraserTool=function(t,e){this.editor=t,this.maps=["atoms","bonds","rxnArrows","rxnPluses","sgroups","sgroupData","chiralFlags"],this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this),this._lassoHelper=new rnd.Editor.LassoTool.LassoHelper(e||0,t)},rnd.Editor.EraserTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.EraserTool.prototype.OnMouseDown=function(t){var e=this.editor.render.findItem(t,this.maps);e&&"Canvas"!=e.type||this._lassoHelper.begin(t)},rnd.Editor.EraserTool.prototype.OnMouseMove=function(t){this._lassoHelper.running()?this.editor._selectionHelper.setSelection(this._lassoHelper.addPoint(t)):this._hoverHelper.hover(this.editor.render.findItem(t,this.maps))},rnd.Editor.EraserTool.prototype.OnMouseUp=function(t){if(this._lassoHelper.running())this.editor.ui.addUndoAction(this.editor.ui.Action.fromFragmentDeletion(this._lassoHelper.end(t))),this.editor.deselectAll(),this.editor.ui.render.update();else{var e=this.editor.render.findItem(t,this.maps);if(e&&"Canvas"!=e.type){if(this._hoverHelper.hover(null),"atoms"==e.map)this.editor.ui.addUndoAction(this.editor.ui.Action.fromAtomDeletion(e.id));else if("bonds"==e.map)this.editor.ui.addUndoAction(this.editor.ui.Action.fromBondDeletion(e.id));else if("sgroups"==e.map||"sgroupData"==e.map)this.editor.ui.addUndoAction(this.editor.ui.Action.fromSgroupDeletion(e.id));else if("rxnArrows"==e.map)this.editor.ui.addUndoAction(this.editor.ui.Action.fromArrowDeletion(e.id));else if("rxnPluses"==e.map)this.editor.ui.addUndoAction(this.editor.ui.Action.fromPlusDeletion(e.id));else{if("chiralFlags"!=e.map)return;this.editor.ui.addUndoAction(this.editor.ui.Action.fromChiralFlagDeletion())}this.editor.deselectAll(),this.editor.ui.render.update()}}},rnd.Editor.AtomTool=function(t,e){this.editor=t,this.atomProps=e,this.bondProps={type:1,stereo:chem.Struct.BOND.STEREO.NONE},this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.AtomTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.AtomTool.prototype.OnMouseDown=function(t){this._hoverHelper.hover(null);var e=this.editor.render.findItem(t,["atoms"]);e&&"Canvas"!=e.type?"atoms"==e.map&&(this.dragCtx={item:e,xy0:this.editor.ui.page2obj(t)}):this.dragCtx={xy0:this.editor.ui.page2obj(t)}},rnd.Editor.AtomTool.prototype.OnMouseMove=function(t){var e=this.editor,i=e.render;if("dragCtx"in this&&"item"in this.dragCtx){var n=this.dragCtx,r=this._calcNewAtomPos(i.atomGetPos(n.item.id),e.ui.page2obj(t));"action"in n&&n.action.perform();var o=e.ui.Action.fromBondAddition(this.bondProps,n.item.id,Object.clone(this.atomProps),r,r);n.action=o[0],n.aid2=o[2],i.update()}else this._hoverHelper.hover(i.findItem(t,["atoms"]))},rnd.Editor.AtomTool.prototype.OnMouseUp=function(t){if("dragCtx"in this){var e=this.editor.ui,i=this.dragCtx;e.addUndoAction("action"in i?i.action:"item"in i?e.Action.fromAtomsAttrs(i.item.id,this.atomProps,!0):e.Action.fromAtomAddition(e.page2obj(t),this.atomProps),!0),this.editor.render.update(),delete this.dragCtx}},rnd.Editor.BondTool=function(t,e){this.editor=t,this.atomProps={label:"C"},this.bondProps=e,this.plainBondTypes=[chem.Struct.BOND.TYPE.SINGLE,chem.Struct.BOND.TYPE.DOUBLE,chem.Struct.BOND.TYPE.TRIPLE],this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.BondTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.BondTool.prototype.OnMouseDown=function(t){return this._hoverHelper.hover(null),this.dragCtx={xy0:this.editor.ui.page2obj(t),item:this.editor.render.findItem(t,["atoms","bonds"])},this.dragCtx.item&&"Canvas"!=this.dragCtx.item.type||delete this.dragCtx.item,!0},rnd.Editor.BondTool.prototype.OnMouseMove=function(t){var e=this.editor,i=e.render;if("dragCtx"in this){var n=this.dragCtx;if(!("item"in n)||"atoms"==n.item.map){"action"in n&&n.action.perform();var r,o,s,a;"item"in n&&"atoms"==n.item.map?(r=n.item.id,o=i.findItem(t,["atoms"],n.item)):(r=this.atomProps,s=n.xy0,o=i.findItem(t,["atoms"]));var l=Number.MAX_VALUE;if(o&&"atoms"==o.map)o=o.id;else{o=this.atomProps;var u=e.ui.page2obj(t);l=util.Vec2.dist(n.xy0,u),s?a=this._calcNewAtomPos(s,u):s=this._calcNewAtomPos(i.atomGetPos(r),u)}return l>.3?n.action=e.ui.Action.fromBondAddition(this.bondProps,r,o,s,a)[0]:delete n.action,i.update(),!0}}return this._hoverHelper.hover(i.findItem(t,["atoms","bonds"])),!0},rnd.Editor.BondTool.prototype.OnMouseUp=function(t){if("dragCtx"in this){var e=this.editor.ui,i=this.dragCtx;if("action"in i)e.addUndoAction(i.action);else if("item"in i){if("atoms"==i.item.map){var n=e.atomForNewBond(i.item.id);e.addUndoAction(e.Action.fromBondAddition(this.bondProps,i.item.id,n.atom,n.pos)[0])}else if("bonds"==i.item.map){var r=Object.clone(this.bondProps),o=e.ctab.bonds.get(i.item.id);if(r.stereo!=chem.Struct.BOND.STEREO.NONE&&o.type==chem.Struct.BOND.TYPE.SINGLE&&r.type==chem.Struct.BOND.TYPE.SINGLE&&o.stereo==r.stereo)e.addUndoAction(e.Action.fromBondFlipping(i.item.id));else{if(r.type===chem.Struct.BOND.TYPE.SINGLE&&o.stereo===chem.Struct.BOND.STEREO.NONE&&r.stereo===chem.Struct.BOND.STEREO.NONE){var s=this.plainBondTypes.indexOf(r.type)>=0?this.plainBondTypes:null;s&&(r.type=s[(s.indexOf(o.type)+1)%s.length])}e.addUndoAction(e.Action.fromBondAttrs(i.item.id,r,e.bondFlipRequired(o,r)),!0)}}}else{var a=this.editor.ui.page2obj(t),l=new util.Vec2(.5,0).rotate(this.bondProps.type==chem.Struct.BOND.TYPE.SINGLE?-Math.PI/6:0),u=e.Action.fromBondAddition(this.bondProps,{label:"C"},{label:"C"},{x:a.x-l.x,y:a.y-l.y},{x:a.x+l.x,y:a.y+l.y});e.addUndoAction(u[0])}this.editor.render.update(),delete this.dragCtx}return!0},rnd.Editor.ChainTool=function(t){this.editor=t,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.ChainTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.ChainTool.prototype.OnMouseDown=function(t){return this._hoverHelper.hover(null),this.dragCtx={xy0:this.editor.ui.page2obj(t),item:this.editor.render.findItem(t,["atoms"])},this.dragCtx.item&&"Canvas"!=this.dragCtx.item.type||delete this.dragCtx.item,!0},rnd.Editor.ChainTool.prototype.OnMouseMove=function(t){var e=this.editor,i=e.render;if("dragCtx"in this){var n=this.dragCtx;"action"in n&&n.action.perform();var r="item"in n?i.atomGetPos(n.item.id):n.xy0,o=e.ui.page2obj(t);return n.action=e.ui.Action.fromChain(r,this._calcAngle(r,o),Math.ceil(util.Vec2.diff(o,r).length()),"item"in n?n.item.id:null),i.update(),!0}return this._hoverHelper.hover(i.findItem(t,["atoms"])),!0},rnd.Editor.ChainTool.prototype.OnMouseUp=function(){return"dragCtx"in this&&("action"in this.dragCtx&&this.editor.ui.addUndoAction(this.dragCtx.action),delete this.dragCtx),!0},rnd.Editor.ChainTool.prototype.OnCancel=function(){this.OnMouseUp()},rnd.Editor.TemplateTool=function(t,e){if(this.editor=t,this.template=e,!this.template.molecule){var i=this.template.molfile.split("\n"),n=chem.Molfile.parseCTFile(i);n.rescale();var r=new util.Vec2;n.atoms.each(function(t,e){r.add_(e.pp)}),this.template.molecule=n,this.template.xy0=r.scaled(1/n.atoms.count()),this.template.angle0=this._calcAngle(n.atoms.get(this.template.aid).pp,this.template.xy0);var o=n.bonds.get(this.template.bid);this.template.sign=this._getSign(n,o,this.template.xy0)}this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.TemplateTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.TemplateTool.prototype._getSign=function(t,e,i){var n=t.atoms.get(e.begin).pp,r=t.atoms.get(e.end).pp,o=util.Vec2.cross(util.Vec2.diff(n,r),util.Vec2.diff(i,r));return o>0?1:0>o?-1:0},rnd.Editor.TemplateTool.prototype.OnMouseDown=function(t){var e=this.editor,i=e.render;this._hoverHelper.hover(null),this.dragCtx={xy0:e.ui.page2obj(t),item:i.findItem(t,["atoms","bonds"])};var n=this.dragCtx,r=n.item;if(r&&"Canvas"!=r.type){if("bonds"==r.map){var o=i.ctab.molecule,s=new util.Vec2,a=o.bonds.get(r.id),l=i.atomGetAttr(a.begin,"fragment"),u=o.getFragmentIds(l),c=0,h=o.halfBonds.get(a.hb1).loop;if(0>h&&(h=o.halfBonds.get(a.hb2).loop),h>=0){var d=o.loops.get(h).hbs;d.each(function(t){s.add_(o.atoms.get(o.halfBonds.get(t).begin).pp),c++})}else util.Set.each(u,function(t){s.add_(o.atoms.get(t).pp),c++});n.v0=s.scaled(1/c);var p=this._getSign(o,a,n.v0);n.sign1=p||1,n.sign2=this.template.sign}}else delete n.item;return!0},rnd.Editor.TemplateTool.prototype.OnMouseMove=function(t){var e=this.editor,i=e.render;if("dragCtx"in this){var n,r,o,s=this.dragCtx,a=s.item,l=e.ui.page2obj(t);if(s.mouse_moved=!0,a&&"Canvas"!=a.type){if("atoms"==a.map)n=i.atomGetPos(a.id),o=util.Vec2.dist(n,l)>1;else if("bonds"==a.map){var u=i.ctab.molecule,c=u.bonds.get(a.id),h=this._getSign(u,c,l);return s.sign1*this.template.sign>0&&(h=-h),h==s.sign2&&s.action||("action"in s&&s.action.perform(),s.sign2=h,s.action=e.ui.Action.fromTemplateOnBond(a.id,this.template,this._calcAngle,s.sign1*s.sign2>0),i.update()),!0}}else n=s.xy0;r=this._calcAngle(n,l);var d=Math.round(180/Math.PI*r);if("angle"in s&&s.angle==d){if(!("extra_bond"in s))return!0;if(s.extra_bond==o)return!0}return"action"in s&&s.action.perform(),s.angle=d,a&&"Canvas"!=a.type?"atoms"==a.map&&(s.action=e.ui.Action.fromTemplateOnAtom(a.id,r,o,this.template,this._calcAngle),s.extra_bond=o):s.action=e.ui.Action.fromTemplateOnCanvas(n,r,this.template),i.update(),!0}return this._hoverHelper.hover(i.findItem(t,["atoms","bonds"])),!0},rnd.Editor.TemplateTool.prototype.OnMouseUp=function(t){var e=this.editor,i=e.render;if("dragCtx"in this){var n=this.dragCtx,r=n.item;if(!n.action){if(r&&"Canvas"!=r.type)if("atoms"==r.map){var o=i.atomGetDegree(r.id);if(o>1)n.action=e.ui.Action.fromTemplateOnAtom(r.id,null,!0,this.template,this._calcAngle);else if(1==o){var s=i.ctab.molecule,a=s.halfBonds.get(s.atoms.get(r.id).neighbors[0]).end,l=s.atoms.get(r.id),u=s.atoms.get(a);n.action=e.ui.Action.fromTemplateOnAtom(r.id,this._calcAngle(u.pp,l.pp),!1,this.template,this._calcAngle)}else n.action=e.ui.Action.fromTemplateOnAtom(r.id,0,!1,this.template,this._calcAngle)}else"bonds"==r.map&&(n.action=e.ui.Action.fromTemplateOnBond(r.id,this.template,this._calcAngle,n.sign1*n.sign2>0));else n.action=e.ui.Action.fromTemplateOnCanvas(n.xy0,0,this.template);i.update()}"action"in this.dragCtx&&(this.dragCtx.action.isDummy()||this.editor.ui.addUndoAction(this.dragCtx.action)),delete this.dragCtx}},rnd.Editor.TemplateTool.prototype.OnCancel=function(){this.OnMouseUp()},rnd.Editor.ChargeTool=function(t,e){this.editor=t,this.charge=e,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.ChargeTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.ChargeTool.prototype.OnMouseMove=function(t){var e=this.editor.render.findItem(t,["atoms"]);return e&&"atoms"==e.map&&null!=chem.Element.getElementByLabel(this.editor.ui.ctab.atoms.get(e.id).label)?this._hoverHelper.hover(e):this._hoverHelper.hover(null),!0},rnd.Editor.ChargeTool.prototype.OnMouseUp=function(t){var e=this.editor,i=e.render,n=i.findItem(t,["atoms"]);return n&&"atoms"==n.map&&null!=chem.Element.getElementByLabel(this.editor.ui.ctab.atoms.get(n.id).label)&&(this._hoverHelper.hover(null),e.ui.addUndoAction(e.ui.Action.fromAtomsAttrs(n.id,{charge:i.ctab.molecule.atoms.get(n.id).charge+this.charge})),i.update()),!0},rnd.Editor.RGroupAtomTool=function(t){this.editor=t,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.RGroupAtomTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.RGroupAtomTool.prototype.OnMouseMove=function(t){this._hoverHelper.hover(this.editor.render.findItem(t,["atoms"]))},rnd.Editor.RGroupAtomTool.prototype.OnMouseUp=function(t){var e=this.editor.render.findItem(t,["atoms"]);if(!e||"Canvas"==e.type)return this._hoverHelper.hover(null),this.editor.ui.showRGroupTable({onOk:function(t){t&&(this.editor.ui.addUndoAction(this.editor.ui.Action.fromAtomAddition(this.editor.ui.page2obj(this.OnMouseMove0.lastEvent),{label:"R#",rglabel:t}),!0),this.editor.ui.render.update())}.bind(this)}),!0;if(e&&"atoms"==e.map){this._hoverHelper.hover(null);var i=this.editor.render.ctab.molecule.atoms.get(e.id),n=i.label,r=i.rglabel;return this.editor.ui.showRGroupTable({selection:r,onOk:function(t){if(r!=t||"R#"!=n){var o=Object.clone(chem.Struct.Atom.attrlist);t?(o.label="R#",o.rglabel=t,o.aam=i.aam):(o.label="C",o.aam=i.aam),this.editor.ui.addUndoAction(this.editor.ui.Action.fromAtomsAttrs(e.id,o),!0),this.editor.ui.render.update()}}.bind(this)}),!0}},rnd.Editor.RGroupFragmentTool=function(t){this.editor=t,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.RGroupFragmentTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.RGroupFragmentTool.prototype.OnMouseMove=function(t){this._hoverHelper.hover(this.editor.render.findItem(t,["frags","rgroups"]))},rnd.Editor.RGroupFragmentTool.prototype.OnMouseUp=function(t){var e=this.editor.render.findItem(t,["frags","rgroups"]);if(e&&"frags"==e.map){this._hoverHelper.hover(null);var i=chem.Struct.RGroup.findRGroupByFragment(this.editor.render.ctab.molecule.rgroups,e.id);return this.editor.ui.showRGroupTable({mode:"single",selection:i?1<<i-1:0,onOk:function(t){for(var n=0;32>n;n++)if(t&1<<n){t=n+1;break}i!=t&&(this.editor.ui.addUndoAction(this.editor.ui.Action.fromRGroupFragment(t,e.id),!0),this.editor.ui.render.update())}.bind(this)}),!0}if(e&&"rgroups"==e.map){this._hoverHelper.hover(null);var n=this.editor.render.ctab.molecule.rgroups.get(e.id),r=0;this.editor.render.ctab.molecule.rgroups.each(function(t){r|=1<<t-1});var o={occurrence:n.range,resth:n.resth,ifthen:n.ifthen};return this.editor.ui.showRLogicTable({rgid:e.id,rlogic:o,rgmask:r,onOk:function(t){var i={};if(o.occurrence!=t.occurrence){var n=t.occurrence.split(",").all(function(t){return t.match(/^[>,<,=]?[0-9]+$/g)||t.match(/^[0-9]+\-[0-9]+$/g)});if(!n)return alert("Bad occurrence value"),!1;i.range=t.occurrence}return o.resth!=t.resth&&(i.resth=t.resth),o.ifthen!=t.ifthen&&(i.ifthen=t.ifthen),("range"in i||"resth"in i||"ifthen"in i)&&(this.editor.ui.addUndoAction(this.editor.ui.Action.fromRGroupAttrs(e.id,i)),this.editor.render.update()),!0}.bind(this)}),!0}},rnd.Editor.APointTool=function(t){this.editor=t,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.APointTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.APointTool.prototype.OnMouseMove=function(t){this._hoverHelper.hover(this.editor.render.findItem(t,["atoms"]))},rnd.Editor.APointTool.prototype.OnMouseUp=function(t){var e=this.editor.render.findItem(t,["atoms"]);if(e&&"atoms"==e.map){this._hoverHelper.hover(null);var i=this.editor.render.ctab.molecule.atoms.get(e.id).attpnt;return this.editor.ui.showAtomAttachmentPoints({selection:i,onOk:function(t){i!=t&&(this.editor.ui.addUndoAction(this.editor.ui.Action.fromAtomsAttrs(e.id,{attpnt:t}),!0),this.editor.ui.render.update())}.bind(this)}),!0}},rnd.Editor.ReactionArrowTool=function(t){this.editor=t,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.ReactionArrowTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.ReactionArrowTool.prototype.OnMouseDown=function(t){var e=this.editor.render.findItem(t,["rxnArrows"]);e&&"rxnArrows"==e.map&&(this._hoverHelper.hover(null),this.editor._selectionHelper.setSelection(e),this.dragCtx={xy0:this.editor.ui.page2obj(t)})},rnd.Editor.ReactionArrowTool.prototype.OnMouseMove=function(t){"dragCtx"in this?(this.dragCtx.action&&this.dragCtx.action.perform(),this.dragCtx.action=ui.Action.fromMultipleMove(this.editor._selectionHelper.selection,this.editor.ui.page2obj(t).sub(this.dragCtx.xy0)),this.editor.ui.render.update()):this._hoverHelper.hover(this.editor.render.findItem(t,["rxnArrows"]))},rnd.Editor.ReactionArrowTool.prototype.OnMouseUp=function(t){"dragCtx"in this?(this.editor.ui.addUndoAction(this.dragCtx.action,!1),this.editor.render.update(),delete this.dragCtx):this.editor.render.ctab.molecule.rxnArrows.count()<1&&(this.editor.ui.addUndoAction(this.editor.ui.Action.fromArrowAddition(this.editor.ui.page2obj(t))),this.editor.render.update())},rnd.Editor.ReactionPlusTool=function(t){this.editor=t,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this)},rnd.Editor.ReactionPlusTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.ReactionPlusTool.prototype.OnMouseDown=function(t){var e=this.editor.render.findItem(t,["rxnPluses"]);e&&"rxnPluses"==e.map&&(this._hoverHelper.hover(null),this.editor._selectionHelper.setSelection(e),this.dragCtx={xy0:this.editor.ui.page2obj(t)})},rnd.Editor.ReactionPlusTool.prototype.OnMouseMove=function(t){"dragCtx"in this?(this.dragCtx.action&&this.dragCtx.action.perform(),this.dragCtx.action=ui.Action.fromMultipleMove(this.editor._selectionHelper.selection,this.editor.ui.page2obj(t).sub(this.dragCtx.xy0)),this.editor.ui.render.update()):this._hoverHelper.hover(this.editor.render.findItem(t,["rxnPluses"]))},rnd.Editor.ReactionPlusTool.prototype.OnMouseUp=function(t){"dragCtx"in this?(this.editor.ui.addUndoAction(this.dragCtx.action,!1),this.editor.render.update(),delete this.dragCtx):(this.editor.ui.addUndoAction(this.editor.ui.Action.fromPlusAddition(this.editor.ui.page2obj(t))),this.editor.render.update())},rnd.Editor.ReactionMapTool=function(t){this.editor=t,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this),this.editor._selectionHelper.setSelection(null),this.rcs=chem.MolfileSaver.getComponents(this.editor.render.ctab.molecule)},rnd.Editor.ReactionMapTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.ReactionMapTool.prototype.OnMouseDown=function(t){var e=this.editor.render.findItem(t,["atoms"]);e&&"atoms"==e.map&&(this._hoverHelper.hover(null),this.dragCtx={item:e,xy0:this.editor.ui.page2obj(t)})},rnd.Editor.ReactionMapTool.prototype.OnMouseMove=function(t){var e=this.editor.render;if("dragCtx"in this){var i=e.findItem(t,["atoms"],this.dragCtx.item);i&&"atoms"==i.map&&this._isValidMap(this.dragCtx.item.id,i.id)?(this._hoverHelper.hover(i),e.drawSelectionLine(e.atomGetPos(this.dragCtx.item.id),e.atomGetPos(i.id))):(this._hoverHelper.hover(null),e.drawSelectionLine(e.atomGetPos(this.dragCtx.item.id),this.editor.ui.page2obj(t)))}else this._hoverHelper.hover(e.findItem(t,["atoms"]))},rnd.Editor.ReactionMapTool.prototype.OnMouseUp=function(t){if("dragCtx"in this){var e=this.editor.render,i=e.findItem(t,["atoms"],this.dragCtx.item);if(i&&"atoms"==i.map&&this._isValidMap(this.dragCtx.item.id,i.id)){var n=new this.editor.ui.Action,r=e.ctab.molecule.atoms,o=r.get(this.dragCtx.item.id),s=r.get(i.id),a=o.aam,l=s.aam;if(!a||a!=l){if((a&&a!=l||!a&&l)&&r.each(function(t,e){t!=this.dragCtx.item.id&&(a&&e.aam==a||l&&e.aam==l)&&n.mergeWith(this.editor.ui.Action.fromAtomsAttrs(t,{aam:0}))},this),a)n.mergeWith(this.editor.ui.Action.fromAtomsAttrs(i.id,{aam:a}));else{var u=0;r.each(function(t,e){u=Math.max(u,e.aam||0)}),n.mergeWith(this.editor.ui.Action.fromAtomsAttrs(this.dragCtx.item.id,{aam:u+1})),n.mergeWith(this.editor.ui.Action.fromAtomsAttrs(i.id,{aam:u+1}))}this.editor.ui.addUndoAction(n,!0),e.update()}}e.drawSelectionLine(null),delete this.dragCtx}this._hoverHelper.hover(null)},rnd.Editor.ReactionMapTool.prototype._isValidMap=function(t,e){for(var i,n,r=0;(!i||!n)&&r<this.rcs.reactants.length;r++){var o=util.Set.list(this.rcs.reactants[r]);!i&&o.indexOf(t)>=0&&(i="r"),!n&&o.indexOf(e)>=0&&(n="r")}for(var s=0;(!i||!n)&&s<this.rcs.products.length;s++){var a=util.Set.list(this.rcs.products[s]);!i&&a.indexOf(t)>=0&&(i="p"),!n&&a.indexOf(e)>=0&&(n="p")}return i&&n&&i!=n},rnd.Editor.ReactionUnmapTool=function(t){this.editor=t,this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this),this.editor._selectionHelper.setSelection(null)},rnd.Editor.ReactionUnmapTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.ReactionUnmapTool.prototype.OnMouseMove=function(t){var e=this.editor.render.findItem(t,["atoms"]);e&&"atoms"==e.map?this._hoverHelper.hover(this.editor.render.ctab.molecule.atoms.get(e.id).aam?e:null):this._hoverHelper.hover(null)},rnd.Editor.ReactionUnmapTool.prototype.OnMouseUp=function(t){var e=this.editor.render.findItem(t,["atoms"]),i=this.editor.render.ctab.molecule.atoms;if(e&&"atoms"==e.map&&i.get(e.id).aam){var n=new this.editor.ui.Action,r=i.get(e.id).aam;i.each(function(t,e){e.aam==r&&n.mergeWith(this.editor.ui.Action.fromAtomsAttrs(t,{aam:0}))},this),this.editor.ui.addUndoAction(n,!0),this.editor.render.update()}this._hoverHelper.hover(null)},rnd.Editor.SGroupTool=function(t){this.editor=t,this.maps=["atoms","bonds","sgroups","sgroupData"],this._hoverHelper=new rnd.Editor.EditorTool.HoverHelper(this),this._lassoHelper=new rnd.Editor.LassoTool.LassoHelper(1,t),this._sGroupHelper=new rnd.Editor.SGroupTool.SGroupHelper(t);var e=this.editor.getSelection();e.atoms&&e.atoms.length>0?this._sGroupHelper.showPropertiesDialog(null,e):this.editor.deselectAll()},rnd.Editor.SGroupTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.SGroupTool.prototype.OnMouseDown=function(t){var e=this.editor.render.findItem(t,this.maps);e&&"Canvas"!=e.type||this._lassoHelper.begin(t)},rnd.Editor.SGroupTool.prototype.OnMouseMove=function(t){this._lassoHelper.running()?this.editor._selectionHelper.setSelection(this._lassoHelper.addPoint(t)):this._hoverHelper.hover(this.editor.render.findItem(t,this.maps))},rnd.Editor.SGroupTool.SGroupHelper=function(t){this.editor=t,this.selection=null},rnd.Editor.SGroupTool.SGroupHelper.prototype.showPropertiesDialog=function(t,e){this.selection=e;var i=this.editor.render;if(null==t){var n={},r={};if(e.atoms.each(function(t){r[t]=!0},this),!Object.isUndefined(e.atoms.detect(function(t){var o=i.atomGetSGroups(t);return!Object.isUndefined(o.detect(function(t){if(t in n)return!1;var o=i.sGroupGetAtoms(t);if(o.length<e.atoms.length){if(!Object.isUndefined(o.detect(function(t){
return!(t in r)},this)))return!0}else if(!Object.isUndefined(e.atoms.detect(function(t){return-1==o.indexOf(t)},this)))return!0;return!1},this))},this)))return void alert("Partial S-group overlapping is not allowed.")}this.editor.ui.showSGroupProperties(t,this,this.selection,this.OnPropertiesDialogOk,this.OnPropertiesDialogCancel)},rnd.Editor.SGroupTool.prototype.OnMouseUp=function(t){var e=null,i=null;if(this._lassoHelper.running())i=this._lassoHelper.end(t);else{var n=this.editor.render.findItem(t,this.maps);if(!n||"Canvas"==n.type)return;if(this._hoverHelper.hover(null),"atoms"==n.map)i={atoms:[n.id]};else if("bonds"==n.map){var r=this.editor.render.ctab.bonds.get(n.id);i={atoms:[r.b.begin,r.b.end]}}else{if("sgroups"!=n.map)return;e=n.id}}(null!=e||i&&i.atoms&&i.atoms.length>0)&&this._sGroupHelper.showPropertiesDialog(e,i)},rnd.Editor.SGroupTool.SGroupHelper.prototype.postClose=function(){this.editor.deselectAll(),this.editor.render.update()},rnd.Editor.SGroupTool.SGroupHelper.prototype.OnPropertiesDialogOk=function(t,e,i){null==t?(t=ui.render.ctab.molecule.sgroups.newId(),this.editor.ui.addUndoAction(this.editor.ui.Action.fromSgroupAddition(e,this.selection.atoms,i,t),!0)):this.editor.ui.addUndoAction(this.editor.ui.Action.fromSgroupType(t,e).mergeWith(this.editor.ui.Action.fromSgroupAttrs(t,i)),!0),this.postClose()},rnd.Editor.SGroupTool.SGroupHelper.prototype.OnPropertiesDialogCancel=function(){this.postClose()},rnd.Editor.PasteTool=function(t){this.editor=t,this.action=this.editor.ui.Action.fromPaste(this.editor.ui.clipboard,"lastEvent"in this.OnMouseMove0?util.Vec2.diff(this.editor.ui.page2obj(this.OnMouseMove0.lastEvent),this.editor.ui.clipboard.getAnchorPosition()):void 0),this.editor.render.update()},rnd.Editor.PasteTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.PasteTool.prototype.OnMouseMove=function(t){"action"in this&&this.action.perform(this.editor),this.action=this.editor.ui.Action.fromPaste(this.editor.ui.clipboard,util.Vec2.diff(this.editor.ui.page2obj(t),this.editor.ui.clipboard.getAnchorPosition())),this.editor.render.update()},rnd.Editor.PasteTool.prototype.OnMouseUp=function(){this.editor.ui.addUndoAction(this.action),delete this.action,this.editor.ui.selectMode(this.editor.ui.defaultSelector)},rnd.Editor.PasteTool.prototype.OnCancel=function(){"action"in this&&(this.action.perform(this.editor),delete this.action)},rnd.Editor.RotateTool=function(t){this.editor=t,this._lassoHelper=new rnd.Editor.LassoTool.LassoHelper(1,t);var e=this.editor._selectionHelper.selection;e.atoms&&e.atoms.length||this.editor._selectionHelper.setSelection(null)},rnd.Editor.RotateTool.prototype=new rnd.Editor.EditorTool,rnd.Editor.RotateTool.prototype.OnMouseDown=function(t){var e=this.editor._selectionHelper.selection;if(e.atoms&&e.atoms.length){var i=this.editor.render.ctab.molecule,n=new util.Vec2;if(!e.atoms||!e.atoms.length)return!0;var r=null,o=!1;e.atoms.each(function(t){var s=i.atoms.get(t);n.add_(s.pp),o||s.neighbors.find(function(n){var s=i.halfBonds.get(n);if(-1==e.atoms.indexOf(s.end)){if(s.loop>=0){var a=i.atoms.get(t);if(!Object.isUndefined(a.neighbors.find(function(t){var n=i.halfBonds.get(t);return n.loop>=0&&-1!=e.atoms.indexOf(n.end)})))return o=!0,!0}if(null==r)r=t;else if(r!=t)return o=!0,!0}return!1})}),n=o||null==r?n.scaled(1/e.atoms.length):i.atoms.get(r).pp,this.dragCtx={xy0:n,angle1:this._calcAngle(n,this.editor.ui.page2obj(t)),all:o}}else this._lassoHelper.begin(t);return!0},rnd.Editor.RotateTool.prototype.OnMouseMove=function(t){if(this._lassoHelper.running())this.editor._selectionHelper.setSelection(this._lassoHelper.addPoint(t));else if("dragCtx"in this){var e=this.editor,i=e.render,n=this.dragCtx,r=e.ui.page2obj(t),o=this._calcAngle(n.xy0,r)-n.angle1,s=Math.round(o/Math.PI*180);if(s>180?s-=360:-180>=s&&(s+=360),"angle"in n&&n.angle==s)return!0;"action"in n&&n.action.perform(),n.angle=s,n.action=e.ui.Action.fromRotate(n.all?i.ctab.molecule:this.editor.getSelection(),n.xy0,o),$("toolText").update(s+""),i.update()}return!0},rnd.Editor.RotateTool.prototype.OnMouseUp=function(t){var e=null;return this._lassoHelper.running()?e=this._lassoHelper.end(t):"dragCtx"in this&&("action"in this.dragCtx?(this.editor.ui.addUndoAction(this.dragCtx.action,!0),$("toolText").update("")):this.editor._selectionHelper.setSelection(),delete this.dragCtx),!0},rnd.Editor.RotateTool.prototype.OnCancel=function(){"dragCtx"in this&&("action"in this.dragCtx&&(this.editor.ui.addUndoAction(this.dragCtx.action,!0),$("toolText").update("")),delete this.dragCtx)},!window.Prototype)throw new Error("Prototype.js should be loaded first");if(!window.rnd)throw new Error("rnd should be defined prior to loading this file");if(rnd.ElementTable=function(t,e,i){e=e||{},t=$(t),t.innerHTML="";var n=this;this.onClick=e.onClick||function(t){"single"==this.mode?n.setElementSingle(t):n.setElementSelected(t,!n.items[t].selected),n.updateAtomProps()};var r=e.buttonHalfSize||16;this.elemHalfSz=new util.Vec2(r,r),this.elemSz=this.elemHalfSz.scaled(2),this.spacing=new util.Vec2(3,3),this.cornerRadius=0,this.orig=this.elemSz.scaled(0),this.mode="single",i&&(this.size=new util.Vec2(18*(this.elemSz.x+this.spacing.x)+this.spacing.x,9*(this.elemSz.y+this.spacing.y)+this.spacing.y),t.style.width=this.size.x.toString()+"px",t.style.height=this.size.y.toString()+"px"),this.viewSz=new util.Vec2(t.clientWidth||100,t.clientHeight||100),this.paper=new Raphael(t,this.viewSz.x,this.viewSz.y),this.bb=new util.Box2Abs(new util.Vec2,this.viewSz),this.fillColor=e.fillColor||"#def",this.fillColorSelected=e.fillColorSelected||"#fcb",this.frameColor=e.frameColor||"#9ad",this.frameThickness=e.frameThickness||"1pt",this.fontSize=e.fontSize||19,this.fontType=e.fontType||"Arial",this.frameAttrs={fill:this.fillColor,stroke:this.frameColor,"stroke-width":this.frameThickness},this.fontAttrs={"font-family":this.fontType,"font-size":this.fontSize},this.items={},this.selectedLabels=util.Set.empty(),this.singleLabel=-1,this.atomProps={}},rnd.ElementTable.prototype.updateAtomProps=function(){if(this.atomProps={},"single"==this.mode){if(this.singleLabel<0)return;this.atomProps.label=chem.Element.elements.get(this.singleLabel).label}else{if(0==util.Set.size(this.selectedLabels))return;var t="notlist"==this.mode,e=util.Set.list(this.selectedLabels);e.sort(function(t,e){return t-e}),this.atomProps={label:"L#",atomList:new chem.Struct.AtomList({notList:t,ids:e})}}},rnd.ElementTable.prototype.getAtomProps=function(){return this.atomProps},rnd.ElementTable.prototype.renderTable=function(){var t=this;chem.Element.elements.each(function(e,i){var n=new util.Vec2(this.orig.x+(i.xpos-1)*(this.spacing.x+this.elemSz.x)+this.elemHalfSz.x+this.spacing.x,this.orig.y+(i.ypos-1)*(this.spacing.y+this.elemSz.y)+this.elemHalfSz.y+this.spacing.y),r=this.paper.rect(n.x-this.elemHalfSz.x,n.y-this.elemHalfSz.y,this.elemSz.x,this.elemSz.y,this.cornerRadius).attr(this.frameAttrs),o=this.paper.text(n.x,n.y,i.label).attr(this.fontAttrs).attr("fill",i.labelColor);r.node.onclick=function(){t.onClick(e)},o.node.onclick=function(){t.onClick(e)},this.items[e]={box:r,label:o,selected:!1}},this)},rnd.ElementTable.prototype.renderSingle=function(t){var e=chem.Element.getElementByLabel(t),i=chem.Element.elements.get(e);this.items[t]=this.paper.text(this.viewSz.x/2,this.viewSz.y/2,t).attr(this.fontAttrs).attr("fill",i?i.color:"#000")},rnd.ElementTable.prototype.renderArrow=function(){var t=4,e=16,i=6,n=4;this.items.arrow=this.paper.path("M{1},{3}L{2},{4}L{1},{5}M{0},{4}L{2},{4}",t,2*e-i-t,2*e-t,e-n,e,e+n).attr({stroke:"#000","stroke-width":"2px"})},rnd.ElementTable.prototype.renderPlus=function(){var t=16,e=9;this.items.plus=this.paper.path("M{1},{0}L{1},{2}M{0},{1}L{2},{1}",t-e,t,t+e).attr({stroke:"#000","stroke-width":"2px"})},rnd.ElementTable.prototype.markSelected=function(t,e){var i=this.items[t];e?i.box.attr("fill",this.fillColorSelected):i.box.attr("fill",this.fillColor),i.selected=e},rnd.ElementTable.prototype.setElementSingle=function(t){this.singleLabel>=0&&this.markSelected(this.singleLabel,!1),t>=0&&this.markSelected(t,!0),this.singleLabel=t},rnd.ElementTable.prototype.setElementSelected=function(t,e){this.markSelected(t,e),e?util.Set.add(this.selectedLabels,t):util.Set.remove(this.selectedLabels,t)},rnd.ElementTable.prototype.setMode=function(t){"single"==t?(util.Set.each(this.selectedLabels,function(t){this.markSelected(t,!1)},this),this.selectedLabels=util.Set.empty()):this.setElementSingle(-1),this.mode=t,this.updateAtomProps()},rnd.ElementTable.prototype.store=function(){this.old={selectedLabels:util.Set.clone(this.selectedLabels),singleLabel:this.singleLabel,mode:this.mode}},rnd.ElementTable.prototype.restore=function(){util.Set.each(this.selectedLabels,function(t){this.markSelected(t,!1)},this),this.singleLabel>=0&&this.markSelected(this.singleLabel,!1),this.setMode(this.old.mode),"single"==this.old.mode?this.setElementSingle(this.old.singleLabel):(util.Set.each(this.old.selectedLabels,function(t){this.markSelected(t,!0)},this),this.selectedLabels=util.Set.clone(this.old.selectedLabels)),$("elem_table_"+this.old.mode).checked=!0,this.updateAtomProps()},rnd.ElementTable.prototype.setSelection=function(t){t&&(util.Set.each(this.selectedLabels,function(t){this.setElementSelected(t,!1)},this),this.setElementSingle(-1),"L#"==t.label?($(t.atomList&&t.atomList.notList?"elem_table_notlist":"elem_table_list").click(),(t.atomList.ids||[]).each(function(t){this.setElementSelected(t,!0)},this)):($("elem_table_single").click(),this.setElementSingle(chem.Element.getElementByLabel(t.label)||-1)),this.updateAtomProps())},!window.Prototype)throw new Error("Prototype.js should be loaded first");if(!window.rnd)throw new Error("rnd should be defined prior to loading this file");if(rnd.RGroupTable=function(t,e,i){e=e||{},t=$(t),t.innerHTML="",this.onClick=e.onClick||function(t){this.setSelection("single"==this.mode?this.selection==1<<t?0:1<<t:4294967295&(this.selection^1<<t))};var n=e.buttonHalfSize||16;this.elemHalfSz=new util.Vec2(n,n),this.elemSz=this.elemHalfSz.scaled(2),this.spacing=new util.Vec2(3,3),this.cornerRadius=0,this.orig=this.elemSz.scaled(0),this.mode=e.mode||"multiple",this.selection=0,i&&(this.size=new util.Vec2(8*(this.elemSz.x+this.spacing.x)+this.spacing.x,4*(this.elemSz.y+this.spacing.y)+this.spacing.y),t.style.width=this.size.x.toString()+"px",t.style.height=this.size.y.toString()+"px"),this.viewSz=new util.Vec2(t.clientWidth||100,t.clientHeight||100),this.paper=new Raphael(t,this.viewSz.x,this.viewSz.y),this.bb=new util.Box2Abs(new util.Vec2,this.viewSz),this.fillColor=e.fillColor||"#def",this.fillColorSelected=e.fillColorSelected||"#fcb",this.frameColor=e.frameColor||"#9ad",this.frameThickness=e.frameThickness||"1pt",this.fontSize=e.fontSize||18,this.fontType=e.fontType||"Arial",this.frameAttrs={fill:this.fillColor,stroke:this.frameColor,"stroke-width":this.frameThickness},this.fontAttrs={"font-family":this.fontType,"font-size":this.fontSize},this.items=[];for(var r=0;32>r;r++)(function(t){var e=new util.Vec2(this.orig.x+t%8*(this.spacing.x+this.elemSz.x)+this.elemHalfSz.x+this.spacing.x,this.orig.y+parseInt(t/8)*(this.spacing.y+this.elemSz.y)+this.elemHalfSz.y+this.spacing.y),i=this.paper.rect(e.x-this.elemHalfSz.x,e.y-this.elemHalfSz.y,this.elemSz.x,this.elemSz.y,this.cornerRadius).attr(this.frameAttrs),n=this.paper.text(e.x,e.y,"R"+(t+1).toString()).attr(this.fontAttrs),r=this;i.node.onclick=function(){r.onClick(t)},n.node.onclick=function(){r.onClick(t)},this.items[t]={box:i,label:n}}).apply(this,[r])},rnd.RGroupTable.prototype.setMode=function(t){this.mode=t},rnd.RGroupTable.prototype.setSelection=function(t){this.selection=t;for(var e=0;32>e;e++)this.items[e].box.attr("fill",this.selection&1<<e?this.fillColorSelected:this.fillColor)},"undefined"==typeof ui&&(ui=function(){}),ui.standalone=!0,ui.forwardExceptions=!1,ui.api_path="/",ui.base_url="",ui.scale=40,ui.zoomValues=[.2,.3,.4,.5,.6,.7,.8,.9,1,1.1,1.2,1.3,1.4,1.5,1.7,2,2.5,3,3.5,4],ui.zoomIdx=ui.zoomValues.indexOf(1),ui.zoom=1,ui.DBLCLICK_INTERVAL=300,ui.HISTORY_LENGTH=32,ui.DEBUG=!1,ui.render=null,ui.ctab=new chem.Struct,ui.client_area=null,ui.mode_id=null,ui.undoStack=new Array,ui.redoStack=new Array,ui.is_osx=!1,ui.is_touch=!1,ui.initialized=!1,ui.initButton=function(t){t.observe(EventMap.mousedown,function(t){this.hasClassName("buttonDisabled")||(this.addClassName("buttonPressed"),ui.hideBlurredControls(),util.stopEventPropagation(t))}),t.observe(EventMap.mouseup,function(){this.removeClassName("buttonPressed")}),t.observe("mouseover",function(){if(!this.hasClassName("buttonDisabled")){this.addClassName("buttonHighlight");var t=this.getAttribute("title");null!=t&&(window.status=t)}}),t.observe("mouseout",function(){this.removeClassName("buttonPressed"),this.removeClassName("buttonHighlight"),window.status=""})},ui.initTemplates=function(){function t(t){var e=t.split(/^[$][$][$][$]$/m),i=[];return e.each(function(t){t=t.replace(/\r/g,""),t=t.strip();var e=t.indexOf("M  END");if(-1!=e){var n={};n.molfile=t.substring(0,e+6),n.name=t.substring(0,t.indexOf("\n")).strip(),t=t.substr(e+7).strip();var r=t.split(/^$/m);r.each(function(t){if(t=t.strip(),t.startsWith("> <")){var e=t.split("\n"),i=e[0].strip().substring(3,e[0].lastIndexOf(">")).strip();n[i]=parseInt(e[1].strip())||e[1].strip()}}),i.push(n)}}),i}new Ajax.Request(ui.base_url+"templates.sdf",{method:"get",requestHeaders:{Accept:"application/octet-stream"},asynchronous:!1,onComplete:function(e){try{var i=t(e.responseText)}catch(n){if(ui.forwardExceptions)throw n;return}if(0!=i.length){rnd.customtemplates=[],ui.customtemplate_tool_modes.clear();var r=$("customtemplate_dropdown_list").select("table > tbody")[0];r.update();var o=0;i.each(function(t){var e={name:(t.name||"customtemplate "+(o+1)).capitalize(),molfile:t.molfile,aid:(t.atomid||1)-1,bid:(t.bondid||1)-1};rnd.customtemplates.push(e),ui.customtemplate_tool_modes.push("customtemplate_"+o),r.insert('<tr class="dropdownListItem" id="customtemplate_'+o+'" title="'+e.name+' (Shift+T)"><td><div id="customtemplate_'+o+'_preview" style="float:right"><img style="align:right" class="dropdownIconTemplate" src="icons/png/customtemplate/customtemplate'+o+'.dropdown.png" alt="" /></div></td><td>'+e.name+"</td></tr>"),o++}),ui.DropdownListSetIconAndTitle($("customtemplate"),$("customtemplate_0"))}}})},ui.onClick_SideButton=function(){this.hasClassName("buttonDisabled")||(this.hasClassName("stateButton")&&this.hasClassName("buttonSelected")?ui.toggleDropdownList(this.id+"_dropdown"):ui.selectMode(this.getAttribute("selid")||this.id))},ui.onClick_DropdownButton=function(){this.hasClassName("buttonDisabled")||ui.toggleDropdownList(this.id)},ui.DropdownListSetIconAndTitle=function(t,e){t.setAttribute("src",e.select("img")[0].getAttribute("src").replace(".dropdown.",".sidebar.")),t.title=e.title},ui.onMouseDown_DropdownListItem=function(t){ui.selectMode(this.id);var e=this.id.split("_")[0];return $(e+"_dropdown_list").hide(),ui.mode_id==this.id&&(ui.DropdownListSetIconAndTitle($(e),this),$(e).setAttribute("selid",ui.mode_id)),t?(util.stopEventPropagation(t),util.preventDefault(t)):void 0},ui.defaultSelector="selector_last",ui.init=function(t,e){if(e=new rnd.RenderOptions(e),t=t||{},this.actionComplete=t.actionComplete||function(){},this.initialized)return this.Action.fromNewCanvas(new chem.Struct),this.render.update(),this.undoStack.clear(),this.redoStack.clear(),this.updateActionButtons(),void this.selectMode(ui.defaultSelector);this.is_osx=-1!=navigator.userAgent.indexOf("Mac OS X"),this.is_touch="ontouchstart"in document&&util.isNull(document.ontouchstart),ui.api_path=t.ketcher_api_url||document.location.pathname.substring(0,document.location.pathname.lastIndexOf("/")+1),ui.base_url=document.location.pathname.substring(0,document.location.pathname.lastIndexOf("/")+1),Prototype.Browser.IE&&($$(".chemicalText").each(function(t){t.addClassName("chemicalText_IE")}),-1!=navigator.userAgent.indexOf("MSIE 6.0")&&$$(".dialogWindow").each(function(t){t.style.width="300px"})),ui.is_osx&&$$(".toolButton, .toolButton > img, .sideButton").each(function(t){t.title=t.title.replace("Ctrl","Cmd")},this),ui.is_touch&&(EventMap={mousemove:"touchmove",mousedown:"touchstart",mouseup:"touchend"},$("output_mol").removeAttribute("readonly"),rnd.ReStruct.prototype.hiddenPaths=[],rnd.ReStruct.prototype.clearVisel=function(t){for(var e=0;e<t.paths.length;++e)t.paths[e].hide(),this.hiddenPaths.push(t.paths[e]);t.clear()}),["http:","https:"].indexOf(window.location.protocol)>=0&&new Ajax.Request(ui.api_path+"knocknock",{method:"get",asynchronous:!1,onComplete:function(t){"You are welcome!"==t.responseText&&(ui.standalone=!1)}}),this.standalone||this.initTemplates(),ui.setKeyboardShortcuts(),document.observe(EventMap.mousedown,ui.onMouseDown_Ketcher),document.observe(EventMap.mouseup,ui.onMouseUp_Ketcher),$$(".toolButton").each(ui.initButton),$$(".modeButton").each(function(t){ui.initButton(t),"atom_table"!=t.identify()&&"atom_reagenerics"!=t.identify()&&t.observe("click",ui.onClick_SideButton)}),$$(".dropdownButton").each(function(t){t.observe("click",ui.onClick_DropdownButton)}),$$(".dropdownListItem").each(function(t){t.observe(EventMap.mousedown,ui.onMouseDown_DropdownListItem),t.observe("mouseover",function(){this.addClassName("highlightedItem")}),t.observe("mouseout",function(){this.removeClassName("highlightedItem")})}),$("new").observe("click",ui.onClick_NewFile),$("open").observe("click",ui.onClick_OpenFile),$("save").observe("click",ui.onClick_SaveFile),$("undo").observe("click",ui.onClick_Undo),$("redo").observe("click",ui.onClick_Redo),$("cut").observe("click",ui.onClick_Cut),$("copy").observe("click",ui.onClick_Copy),$("paste").observe("click",ui.onClick_Paste),$("zoom_in").observe("click",ui.onClick_ZoomIn),$("zoom_out").observe("click",ui.onClick_ZoomOut),$("clean_up").observe("click",ui.onClick_CleanUp),$("aromatize").observe("click",ui.onClick_Aromatize),$("dearomatize").observe("click",ui.onClick_Dearomatize),$("atom_table").observe("click",ui.onClick_ElemTableButton),$("elem_table_list").observe("click",ui.onSelect_ElemTableNotList),$("elem_table_notlist").observe("click",ui.onSelect_ElemTableNotList),$("atom_reagenerics").observe("click",ui.onClick_ReaGenericsTableButton),this.client_area=$("client_area"),this.client_area.observe("scroll",ui.onScroll_ClientArea),$$(".dialogWindow").each(function(t){t.observe("keypress",ui.onKeyPress_Dialog),t.observe("keyup",ui.onKeyPress_Dialog)}),$("atom_label").observe("change",ui.onChange_AtomLabel),$("atom_charge").observe("change",ui.onChange_AtomCharge),$("atom_isotope").observe("change",ui.onChange_AtomIsotope),$("atom_valence").observe("change",ui.onChange_AtomValence),$("atom_prop_cancel").observe("click",function(){ui.hideDialog("atom_properties")}),$("atom_prop_ok").observe("click",function(){ui.applyAtomProperties()}),$("bond_prop_cancel").observe("click",function(){ui.hideDialog("bond_properties")}),$("bond_prop_ok").observe("click",function(){ui.applyBondProperties()}),$("sgroup_type").observe("change",ui.onChange_SGroupType),$("sgroup_label").observe("change",ui.onChange_SGroupLabel),$("input_label").observe("blur",function(){this.hide()}),$("input_label").observe("keypress",ui.onKeyPress_InputLabel),$("input_label").observe("keyup",ui.onKeyUp_InputLabel),$("radio_open_from_input").observe("click",ui.onSelect_OpenFromInput),$("radio_open_from_file").observe("click",ui.onSelect_OpenFromFile),$("input_mol").observe("keyup",ui.onChange_Input),$("input_mol").observe("click",ui.onChange_Input),$("read_cancel").observe("click",function(){ui.hideDialog("open_file")}),$("read_ok").observe("click",function(){ui.loadMoleculeFromInput()}),$("upload_mol").observe("submit",function(){ui.hideDialog("open_file")}),$("upload_cancel").observe("click",function(){ui.hideDialog("open_file")}),$("file_format").observe("change",ui.onChange_FileFormat),$("save_ok").observe("click",function(){ui.hideDialog("save_file")});for(var i=$("zoom_list");i.options.length>0;)i.options.remove(0);for(var n=0;n<ui.zoomValues.length;++n){var r=document.createElement("option");r.text=(100*ui.zoomValues[n]).toFixed(0)+"%",r.value=n,i.options.add(r)}i.selectedIndex=ui.zoomIdx,i.observe("change",function(){ui.zoomSet(i.value-0),i.blur()}),ui.onResize_Ketcher(),Prototype.Browser.IE&&(ui.client_area.absolutize(),$("ketcher_window").observe("resize",ui.onResize_Ketcher)),this.standalone?($$(".serverRequired").each(function(t){t.hasClassName("toolButton")?t.addClassName("buttonDisabled"):t.hide()}),document.title+=" (standalone)"):($("upload_mol").action=ui.api_path+"open",$("download_mol").action=ui.api_path+"save"),e.atomColoring=!0,this.render=new rnd.Render(this.client_area,ui.scale,e),this.editor=new rnd.Editor(this.render),this.selectMode("selector_lasso"),this.render.onCanvasOffsetChanged=this.onOffsetChanged,ui.setScrollOffset(0,0),this.render.setMolecule(this.ctab),this.render.update(),this.initialized=!0},ui.showDialog=function(t){$("window_cover").style.width=$("ketcher_window").getWidth().toString()+"px",$("window_cover").style.height=$("ketcher_window").getHeight().toString()+"px",$("window_cover").show(),$(t).show()},ui.hideDialog=function(t){$(t).hide(),$("window_cover").hide(),$("window_cover").style.width="0px",$("window_cover").style.height="0px"},ui.toggleDropdownList=function(t){var e=t+"_list";$(e).visible()?$(e).hide():$(e).show()},ui.onResize_Ketcher=function(){Prototype.Browser.IE&&(ui.client_area.style.width=(Element.getWidth(ui.client_area.parentNode)-2).toString()+"px"),ui.client_area.style.height=(Element.getHeight(ui.client_area.parentNode)-2).toString()+"px"},ui.updateMolecule=function(t){"undefined"!=typeof t&&null!=t&&(ui.editor.deselectAll(),this.addUndoAction(this.Action.fromNewCanvas(t)),ui.showDialog("loading"),setTimeout(function(){try{ui.render.onResize(),ui.render.update(),ui.setZoomCentered(null,ui.render.getStructCenter())}catch(t){if(ui.forwardExceptions)throw t;alert(t.message)}finally{ui.hideDialog("loading")}},50))},ui.parseCTFile=function(t,e){var i=t.split("\n");i.length>0&&"Ok."==i[0]&&i.shift();try{try{return chem.Molfile.parseCTFile(i)}catch(n){if(ui.forwardExceptions)throw n;if(e){try{return chem.Molfile.parseCTFile(i.slice(1))}catch(r){if(ui.forwardExceptions)throw r}try{return chem.Molfile.parseCTFile([""].concat(i))}catch(o){if(ui.forwardExceptions)throw o}}throw n}}catch(s){if(ui.forwardExceptions)throw s;return alert("Error loading molfile.\n"+s.toString()),null}},ui.selectMode=function(t){if(t.startsWith("selector_")&&("selector_last"==t?t=this.selector_last||"selector_lasso":this.selector_last=t),"reaction_automap"==t)return void ui.showAutomapProperties({onOk:function(t){var e=ui.ctab,i=e.addRxnArrowIfNecessary();if(0==e.rxnArrows.count())return void alert("Auto-Mapping can only be applied to reactions");var n=(new chem.MolfileSaver).saveMolecule(e,!0);new Ajax.Request(ui.api_path+"automap",{method:"post",asynchronous:!0,parameters:{moldata:n,mode:t},onComplete:function(t){if(t.responseText.startsWith("Ok.")){var e=ui.parseCTFile(t.responseText);i&&e.rxnArrows.clear(),ui.updateMolecule(e)}else{if(!t.responseText.startsWith("Error."))throw new Error("Something went wrong"+t.responseText);alert(t.responseText.split("\n")[1])}}})}});if(null!=t){if($(t).hasClassName("buttonDisabled"))return;if(ui.editor.hasSelection()){if("select_erase"==t)return void ui.removeSelected();if(t.startsWith("atom_"))return ui.addUndoAction(ui.Action.fromAtomsAttrs(ui.editor.getSelection().atoms,ui.atomLabel(t)),!0),void ui.render.update()}if(t.startsWith("transform_flip_"))return t.endsWith("h")?ui.addUndoAction(ui.Action.fromFlip(ui.editor.getSelection(),"horizontal"),!0):ui.addUndoAction(ui.Action.fromFlip(ui.editor.getSelection(),"vertical"),!0),void ui.render.update()}if(null!=this.mode_id&&this.mode_id!=t){var e=this.mode_id.split("_")[0],i=$(e)&&$(e).hasClassName("stateButton")||!1;i?t&&!t.startsWith(e)&&$(e).removeClassName("buttonSelected"):$(this.mode_id).removeClassName("buttonSelected")}"transform_rotate"!=t&&this.editor.deselectAll(),this.render.current_tool&&this.render.current_tool.OnCancel(),null==t?(this.mode_id=null,delete this.render.current_tool):(this.render.current_tool=this.editor.toolFor(t),this.mode_id=t,e=this.mode_id.split("_")[0],i=$(e)&&$(e).hasClassName("stateButton")||!1,i?$(e).addClassName("buttonSelected"):$(this.mode_id).addClassName("buttonSelected"))},ui.bondTypeMap={single:{type:1,stereo:chem.Struct.BOND.STEREO.NONE},up:{type:1,stereo:chem.Struct.BOND.STEREO.UP},down:{type:1,stereo:chem.Struct.BOND.STEREO.DOWN},updown:{type:1,stereo:chem.Struct.BOND.STEREO.EITHER},"double":{type:2,stereo:chem.Struct.BOND.STEREO.NONE},crossed:{type:2,stereo:chem.Struct.BOND.STEREO.CIS_TRANS},triple:{type:3,stereo:chem.Struct.BOND.STEREO.NONE},aromatic:{type:4,stereo:chem.Struct.BOND.STEREO.NONE},singledouble:{type:5,stereo:chem.Struct.BOND.STEREO.NONE},singlearomatic:{type:6,stereo:chem.Struct.BOND.STEREO.NONE},doublearomatic:{type:7,stereo:chem.Struct.BOND.STEREO.NONE},any:{type:8,stereo:chem.Struct.BOND.STEREO.NONE}},ui.bondType=function(t){var e;return e=Object.isUndefined(t)?ui.mode_id.substr(5):t.substr(5),ui.bondTypeMap[e]},ui.atomLabel=function(t){var e;return e=Object.isUndefined(t)?ui.mode_id.substr(5):t.substr(5),"table"==e?ui.elem_table_obj.getAtomProps():"reagenerics"==e?ui.reagenerics_table_obj.getAtomProps():"any"==e?{label:"A"}:{label:e.capitalize()}},ui.onClick_NewFile=function(){this.hasClassName("buttonDisabled")||(ui.selectMode(ui.defaultSelector),ui.ctab.isBlank()||(ui.addUndoAction(ui.Action.fromNewCanvas(new chem.Struct)),ui.render.update()))},ui.onKeyPress_Pre=function(t,e,i,n){return util.stopEventPropagation(e),$("window_cover").visible()&&!n?!1:ui&&ui.render.current_tool&&(ui.render.resetLongTapTimeout(!0),ui.render.current_tool.processEvent("OnKeyPress",e,t))?!1:!0},ui.keyboardShortcuts_OSX={remove_selected:"backspace"},ui.keyboardShortcuts_nonOSX={remove_selected:"delete"},ui.setKeyboardShortcuts=function(){var t=function(t,e){if(!(t in ui.keyboardActions))throw new Error('Keyboard action not defined for action "'+t+'"');ui.is_osx&&(e=e.replace(/ctrl/g,"")),key.apply(this,[e,ui.keyboardCallbackProxy(t,function(t,e,i){if(!ui.onKeyPress_Pre(t,e,i,ui.doNotStopIfCoverIsVisible[t]))return!1;var n=ui.keyboardActions[t].call(this,e,i);return n||util.preventDefault(e),n})])};util.map_each(ui.keyboardShortcuts,t),util.map_each(ui.is_osx?ui.keyboardShortcuts_OSX:ui.keyboardShortcuts_nonOSX,t)},ui.keyboardShortcuts={copy:"ctrl+C",cut:"ctrl+X",paste:"ctrl+V",zoom_in:"=, shift+=, plus, shift+plus, equals, shift+equals",zoom_out:"-, minus",undo:"ctrl+Z",redo:"ctrl+shift+Z,ctrl+Y",bond_tool_any:"0",bond_tool_single:"1",bond_tool_double:"2",bond_tool_triple:"3",bond_tool_aromatic:"4",select_charge_tool:"5",selector:"`",atom_tool_any:"A",atom_tool_h:"H",atom_tool_c:"C",atom_tool_n:"N",atom_tool_o:"O",atom_tool_s:"S",atom_tool_p:"P",atom_tool_f:"F",atom_tool_br:"shift+B",atom_tool_cl:"shift+C",atom_tool_i:"I",rgroup_tool_label:"R",rgroup_tool_select:"shift+R",select_all:"ctrl+A",sgroup_tool:"ctrl+G",cleanup_tool:"ctrl+L",new_document:"ctrl+N",open_document:"ctrl+O",save_document:"ctrl+S",rotate_tool:"ctrl+R",template_tool:"T",customtemplate_tool:"shift+T",escape:"escape",force_update:"ctrl+alt+shift+R"},ui.selector_tool_modes=["selector_lasso","selector_square","selector_fragment"],ui.bond_tool_single_bonds=["bond_single","bond_up","bond_down","bond_updown"],ui.bond_tool_double_bonds=["bond_double","bond_crossed"],ui.charge_tool_modes=["charge_plus","charge_minus"],ui.rgroup_tool_modes=["rgroup_label","rgroup_fragment","rgroup_attpoints"],ui.template_tool_modes=["template_0","template_1","template_2","template_3","template_4","template_5","template_6","template_7"],ui.customtemplate_tool_modes=[],ui.keyboardActions={zoom_in:function(){ui.onClick_ZoomIn.call($("zoom_in"))},zoom_out:function(){ui.onClick_ZoomOut.call($("zoom_out"))},copy:function(){ui.onClick_Copy.call($("copy"))},cut:function(){ui.onClick_Cut.call($("cut"))},paste:function(){ui.onClick_Paste.call($("paste"))},undo:function(){ui.onClick_Undo.call($("undo"))},redo:function(){ui.onClick_Redo.call($("redo"))},remove_selected:function(){ui.editor.hasSelection()&&ui.removeSelected()},bond_tool_any:function(){ui.onMouseDown_DropdownListItem.call($("bond_any"))},bond_tool_single:function(){ui.onMouseDown_DropdownListItem.call($(util.listNextRotate(ui.bond_tool_single_bonds,ui.mode_id)))},bond_tool_double:function(){ui.onMouseDown_DropdownListItem.call($(util.listNextRotate(ui.bond_tool_double_bonds,ui.mode_id)))},bond_tool_triple:function(){ui.onMouseDown_DropdownListItem.call($("bond_triple"))},bond_tool_aromatic:function(){ui.onMouseDown_DropdownListItem.call($("bond_aromatic"))},select_charge_tool:function(){ui.selectMode(util.listNextRotate(ui.charge_tool_modes,ui.mode_id))},atom_tool_any:function(){ui.selectMode("atom_any")},atom_tool_h:function(){ui.selectMode("atom_h")},atom_tool_c:function(){ui.selectMode("atom_c")},atom_tool_n:function(){ui.selectMode("atom_n")},atom_tool_o:function(){ui.selectMode("atom_o")},atom_tool_s:function(){ui.selectMode("atom_s")},atom_tool_p:function(){ui.selectMode("atom_p")},atom_tool_f:function(){ui.selectMode("atom_f")},atom_tool_br:function(){ui.selectMode("atom_br")},atom_tool_cl:function(){ui.selectMode("atom_cl")},atom_tool_i:function(){ui.selectMode("atom_i")},rgroup_tool_label:function(){},rgroup_tool_select:function(){ui.onMouseDown_DropdownListItem.call($(util.listNextRotate(ui.rgroup_tool_modes,ui.mode_id)))},select_all:function(){ui.selectAll()},sgroup_tool:function(){ui.onClick_SideButton.call($("sgroup"))},cleanup_tool:function(){ui.onClick_CleanUp.call($("clean_up"))},new_document:function(){ui.onClick_NewFile.call($("new"))},open_document:function(){ui.onClick_OpenFile.call($("open"))},save_document:function(){ui.onClick_SaveFile.call($("save"))},rotate_tool:function(){ui.selectMode("transform_rotate")},template_tool:function(){ui.onMouseDown_DropdownListItem.call($(util.listNextRotate(ui.template_tool_modes,ui.mode_id)))},customtemplate_tool:function(){ui.customtemplate_tool_modes.length<1||ui.onMouseDown_DropdownListItem.call($(util.listNextRotate(ui.customtemplate_tool_modes,ui.mode_id)))},escape:function(t){$("window_cover").visible()||ui.selectMode(ui.defaultSelector)},selector:function(){ui.onMouseDown_DropdownListItem.call($(util.listNextRotate(ui.selector_tool_modes,ui.mode_id)))},force_update:function(){ui.render.update(!0)}},ui.keyboardCallbackProxy=function(t,e){var i=t;return function(t,n){return e.call(this,i,t,n)}},ui.doNotStopIfCoverIsVisible={escape:!0},ui.onKeyPress_Dialog=function(t){return util.stopEventPropagation(t),27===t.keyCode?(ui.hideDialog(this.id),util.preventDefault(t)):void 0},ui.onKeyPress_InputLabel=function(t){if(util.stopEventPropagation(t),13==t.keyCode){this.hide();var e="",i=0,n=this.value.toArray();if("*"==this.value)e="A";else if(this.value.match(/^[*][1-9]?[+-]$/i))e="A",i=2==this.value.length?1:parseInt(n[1]),"-"==n[2]&&(i*=-1);else if(this.value.match(/^[A-Z]{1,2}$/i))e=this.value.capitalize();else if(this.value.match(/^[A-Z]{1,2}[0][+-]?$/i))e=this.value.match(/^[A-Z]{2}/i)?this.value.substr(0,2).capitalize():n[0].capitalize();else if(this.value.match(/^[A-Z]{1,2}[1-9]?[+-]$/i)){e=this.value.match(/^[A-Z]{2}/i)?this.value.substr(0,2).capitalize():n[0].capitalize();var r=this.value.match(/[0-9]/i);i=null!=r?parseInt(r[0]):1,"-"==n[this.value.length-1]&&(i*=-1)}return("A"==e||"Q"==e||"X"==e||"R"==e||null!=chem.Element.getElementByLabel(e))&&(ui.addUndoAction(ui.Action.fromAtomsAttrs(this.atom_id,{label:e,charge:i}),!0),ui.render.update()),util.preventDefault(t)}return 27==t.keyCode?(this.hide(),util.preventDefault(t)):void 0},ui.onKeyUp_InputLabel=function(t){return util.stopEventPropagation(t),27==t.keyCode?(this.hide(),util.preventDefault(t)):void 0},ui.onClick_OpenFile=function(){this.hasClassName("buttonDisabled")||(ui.showDialog("open_file"),
$("radio_open_from_input").checked=!0,$("checkbox_open_copy").checked=!1,ui.onSelect_OpenFromInput())},ui.getFile=function(){var t;return t="contentDocument"in $("buffer_frame")?$("buffer_frame").contentDocument.body:document.frames.buffer_frame.document.body,Base64.decode(t.title)},ui.loadMolecule=function(t,e,i,n,r,o){var s=t.strip(),a=function(t){r&&t.rxnArrows.clear(),n?function(t){return t.rescale(),ui.copy(t)?(ui.editor.deselectAll(),void ui.selectMode("paste")):void alert("Not a valid structure to paste")}.call(this,t):ui.updateMolecule.call(this,t)};if(-1==s.indexOf("\n")){if(ui.standalone)return void(""!=s&&alert("SMILES is not supported in a standalone mode."));new Ajax.Request(ui.api_path+"layout?smiles="+encodeURIComponent(s),{method:"get",asynchronous:!0,onComplete:function(t){if(t.responseText.startsWith("Ok."))a.call(ui,ui.parseCTFile(t.responseText));else{if(!t.responseText.startsWith("Error."))throw new Error("Something went wrong"+t.responseText);alert(t.responseText.split("\n")[1])}}})}else!ui.standalone&&e?new Ajax.Request(ui.api_path+"layout"+(o?"?selective":""),{method:"post",asynchronous:!0,parameters:{moldata:t},onComplete:function(t){if(t.responseText.startsWith("Ok."))a.call(ui,ui.parseCTFile(t.responseText));else{if(!t.responseText.startsWith("Error."))throw new Error("Something went wrong"+t.responseText);alert(t.responseText.split("\n")[1])}}}):a.call(ui,ui.parseCTFile(t,i))},ui.dearomatizeMolecule=function(t,e){t=t.clone();var i=t.addRxnArrowIfNecessary(),n=(new chem.MolfileSaver).saveMolecule(t);if(ui.standalone)throw new Error("Aromatization and dearomatization are not supported in the standalone mode.");new Ajax.Request(ui.api_path+(e?"aromatize":"dearomatize"),{method:"post",asynchronous:!0,parameters:{moldata:n},onComplete:function(t){if(t.responseText.startsWith("Ok.")){var e=ui.parseCTFile(t.responseText);i&&e.rxnArrows.clear(),ui.updateMolecule(e)}else{if(!t.responseText.startsWith("Error."))throw new Error("Something went wrong"+t.responseText);alert(t.responseText.split("\n")[1])}}})},ui.loadMoleculeFromFile=function(){var t=ui.getFile();t.startsWith("Ok.")&&ui.loadMolecule(t.substr(t.indexOf("\n")+1),!1,!1,$("checkbox_open_copy").checked)},ui.loadMoleculeFromInput=function(){return util.strip($("input_mol").value)?(ui.hideDialog("open_file"),void ui.loadMolecule($("input_mol").value,!1,!0,$("checkbox_open_copy").checked)):void alert("The inpus field is empty. Please enter a structure in SMILES or MOLFile/RXNFile format.")},ui.onSelect_OpenFromInput=function(){$("open_from_input").show(),$("open_from_file").hide(),ui.onChange_Input.call($("input_mol")),$("input_mol").activate()},ui.onSelect_OpenFromFile=function(){$("open_from_file").show(),$("open_from_input").hide(),$("molfile_path").focus()},ui.onChange_Input=function(){var t=this;setTimeout(function(){t.value.strip().startsWith("InChI=")&&ui.standalone?alert("InChI are not supported in the standalone mode"):-1!=t.value.strip().indexOf("\n")?"normal"!=t.style.wordWrap&&(t.style.wordWrap="normal"):"break-word"!=t.style.wordWrap&&(t.style.wordWrap="break-word")},200)},ui.onClick_SaveFile=function(){this.hasClassName("buttonDisabled")||($("file_format").value="mol",$("file_format_inchi").disabled=ui.standalone,ui.showDialog("save_file"),ui.onChange_FileFormat(null))},ui.onChange_FileFormat=function(t){var e=$("file_format").value,i=$("output_mol");try{if("mol"==e)i.value=(new chem.MolfileSaver).saveMolecule(ui.ctab),i.style.wordWrap="normal";else if("smi"==e)i.value=(new chem.SmilesSaver).saveMolecule(ui.ctab),i.style.wordWrap="break-word";else{if("inchi"!=e)throw{message:"Unsupported data format"};i.value=(new chem.InChiSaver).saveMolecule(ui.ctab),i.style.wordWrap="break-word"}}catch(n){if(ui.forwardExceptions)throw n;i.value="",ui.hideDialog("save_file"),alert("ERROR: "+n.message)}$("mol_data").value=e+"\n"+i.value,i.activate()},ui.onClick_ZoomIn=function(){this.hasClassName("buttonDisabled")||ui.zoomSet(ui.zoomIdx+1)},ui.onClick_ZoomOut=function(){this.hasClassName("buttonDisabled")||ui.zoomSet(ui.zoomIdx-1)},ui.zoomSet=function(t){if(0>t||t>=ui.zoomValues.length)throw new Error("Zoom index out of range");t>=ui.zoomValues.length-1?$("zoom_in").addClassName("buttonDisabled"):$("zoom_in").removeClassName("buttonDisabled"),0>=t?$("zoom_out").addClassName("buttonDisabled"):$("zoom_out").removeClassName("buttonDisabled"),ui.zoomIdx=t,ui.setZoomCentered(ui.zoomValues[ui.zoomIdx],ui.render.getStructCenter(ui.editor.getSelection())),zoom_list.selectedIndex=ui.zoomIdx,ui.render.update()},ui.setZoomRegular=function(t){.1>t||t>10||(ui.zoom=t,ui.render.setZoom(ui.zoom))},ui.getViewSz=function(){return new util.Vec2(ui.render.viewSz)},ui.setZoomCentered=function(t,e){if(!e)throw new Error("Center point not specified");t&&ui.setZoomRegular(t),ui.setScrollOffset(0,0);var i=ui.render.obj2view(e).sub(ui.render.viewSz.scaled(.5));ui.setScrollOffset(i.x,i.y)},ui.setZoomStaticPointInit=function(t){ui.zspObj=new util.Vec2(t)},ui.setZoomStaticPoint=function(t,e){ui.setZoomRegular(t),ui.setScrollOffset(0,0);var i=ui.render.obj2view(ui.zspObj),n=i.sub(e);ui.setScrollOffset(n.x,n.y)},ui.setScrollOffset=function(t,e){var i=ui.client_area.clientWidth,n=ui.client_area.clientHeight;ui.render.extendCanvas(t,e,i+t,n+e),ui.client_area.scrollLeft=t,ui.client_area.scrollTop=e,ui.scrollLeft=ui.client_area.scrollLeft,ui.scrollTop=ui.client_area.scrollTop},ui.setScrollOffsetRel=function(t,e){ui.setScrollOffset(ui.client_area.scrollLeft+t,ui.client_area.scrollTop+e)},ui.onClick_CleanUp=function(){if(!this.hasClassName("buttonDisabled")){var t=util.array(ui.editor.getSelection(!0).atoms),e=t.length>0;if(e){var i=util.Set.fromList(t);atomSetExtended=util.Set.empty(),ui.ctab.loops.each(function(t,e){util.find(e.hbs,function(t){return util.Set.contains(i,ui.ctab.halfBonds.get(t).begin)})>=0&&util.each(e.hbs,function(t){util.Set.add(atomSetExtended,ui.ctab.halfBonds.get(t).begin)},this)},this),util.Set.mergeIn(atomSetExtended,i),t=util.Set.list(atomSetExtended)}ui.editor.deselectAll();try{var n={},r=ui.ctab.clone(null,null,!1,n);e&&util.each(t,function(t){t=n[t];var e=new chem.SGroup("DAT"),i=r.sgroups.add(e);e.id=i,e.pp=new util.Vec2,e.data.fieldName="_ketcher_selective_layout",e.data.fieldValue="1",r.atomAddToSGroup(i,t)},this);var o=r.addRxnArrowIfNecessary();ui.loadMolecule((new chem.MolfileSaver).saveMolecule(r),!0,!1,!1,o,e)}catch(s){if(ui.forwardExceptions)throw s;alert("ERROR: "+s.message)}}},ui.onClick_Aromatize=function(){if(!this.hasClassName("buttonDisabled"))try{ui.dearomatizeMolecule(ui.ctab,!0)}catch(t){if(ui.forwardExceptions)throw t;alert("Molfile: "+t.message)}},ui.onClick_Dearomatize=function(){if(!this.hasClassName("buttonDisabled"))try{ui.dearomatizeMolecule(ui.ctab,!1)}catch(t){if(ui.forwardExceptions)throw t;alert("Molfile: "+t.message)}},ui.page2canvas2=function(t){var e=ui.client_area.cumulativeOffset();return new util.Vec2(t.pageX-e.left,t.pageY-e.top)},ui.page2obj=function(t){return ui.render.view2obj(ui.page2canvas2(t))},ui.scrollPos=function(){return new util.Vec2(ui.client_area.scrollLeft,ui.client_area.scrollTop)},ui.scrollLeft=null,ui.scrollTop=null,ui.onScroll_ClientArea=function(t){$("input_label").visible()&&$("input_label").hide(),ui.scrollLeft=ui.client_area.scrollLeft,ui.scrollTop=ui.client_area.scrollTop,util.stopEventPropagation(t)},ui.dbl_click=!1,ui.bondFlipRequired=function(t,e){return e.type==chem.Struct.BOND.TYPE.SINGLE&&t.stereo==chem.Struct.BOND.STEREO.NONE&&e.stereo!=chem.Struct.BOND.STEREO.NONE&&ui.ctab.atoms.get(t.begin).neighbors.length<ui.ctab.atoms.get(t.end).neighbors.length},ui.atomForNewBond=function(t){var e=new Array,i=ui.render.atomGetPos(t);ui.render.atomGetNeighbors(t).each(function(t){var n=ui.render.atomGetPos(t.aid);util.Vec2.dist(i,n)<.1||e.push({id:t.aid,v:util.Vec2.diff(n,i)})}),e.sort(function(t,e){return Math.atan2(t.v.y,t.v.x)-Math.atan2(e.v.y,e.v.x)});var n,r,o=0,s=0;for(n=0;n<e.length;n++)r=util.Vec2.angle(e[n].v,e[(n+1)%e.length].v),0>r&&(r+=2*Math.PI),r>s&&(o=n,s=r);var a=new util.Vec2(1,0);if(e.length>0){if(1==e.length){s=-(4*Math.PI/3);var l=ui.render.atomGetNeighbors(t)[0];if(ui.render.atomGetDegree(l.aid)>1){var u=new Array,c=ui.render.atomGetPos(l.aid),h=util.Vec2.diff(i,c),d=Math.atan2(h.y,h.x);ui.render.atomGetNeighbors(l.aid).each(function(t){var e=ui.render.atomGetPos(t.aid);if(!(t.bid==l.bid||util.Vec2.dist(c,e)<.1)){var i=util.Vec2.diff(e,c),n=Math.atan2(i.y,i.x)-d;0>n&&(n+=2*Math.PI),u.push(n)}}),u.sort(function(t,e){return t-e}),u[0]<=1.01*Math.PI&&u[u.length-1]<=1.01*Math.PI&&(s*=-1)}}r=s/2+Math.atan2(e[o].v.y,e[o].v.x),a=a.rotate(r)}a.add_(i);var p=ui.render.findClosestAtom(a,.1);return p=null==p?{label:"C"}:p.id,{atom:p,pos:a}},ui.onOffsetChanged=function(t,e){if(null!=e){var i=new util.Vec2(t.x-e.x,t.y-e.y);ui.client_area.scrollLeft+=i.x,ui.client_area.scrollTop+=i.y}},ui.selectAll=function(){ui.ctab.isBlank()||(ui.selectMode($("selector").getAttribute("selid")),ui.editor.selectAll())},ui.removeSelected=function(){ui.addUndoAction(ui.Action.fromFragmentDeletion()),ui.editor.deselectAll(),ui.render.update()},ui.hideBlurredControls=function(){var t=!1;return["input_label","selector_dropdown_list","bond_dropdown_list","template_dropdown_list","customtemplate_dropdown_list","reaction_dropdown_list","rgroup_dropdown_list","transform_dropdown_list"].each(function(e){e=$(e),e.visible()&&(e.hide(),t=!0)}),t},ui.onMouseDown_Ketcher=function(t){ui.hideBlurredControls()},ui.onMouseUp_Ketcher=function(t){util.stopEventPropagation(t)},ui.showAtomAttachmentPoints=function(t){$("atom_ap1").checked=(1&(t.selection||0))>0,$("atom_ap2").checked=(2&(t.selection||0))>0,ui.showDialog("atom_attpoints");var e=new Event.Handler("atom_attpoints_ok","click",void 0,function(){e.stop(),i.stop(),ui.hideDialog("atom_attpoints"),"onOk"in t&&t.onOk(($("atom_ap1").checked?1:0)+($("atom_ap2").checked?2:0))}).start(),i=new Event.Handler("atom_attpoints_cancel","click",void 0,function(){e.stop(),i.stop(),ui.hideDialog("atom_attpoints"),"onCancel"in t&&t.onCancel()}).start();$("atom_attpoints_ok").focus()},ui.showAtomProperties=function(t){$("atom_properties").atom_id=t,$("atom_label").value=ui.render.atomGetAttr(t,"label"),ui.onChange_AtomLabel.call($("atom_label"));var e=ui.render.atomGetAttr(t,"charge")-0;$("atom_charge").value=0==e?"":e,e=ui.render.atomGetAttr(t,"isotope")-0,$("atom_isotope").value=0==e?"":e,e=ui.render.atomGetAttr(t,"explicitValence")-0,$("atom_valence").value=0>e?"":e,$("atom_radical").value=ui.render.atomGetAttr(t,"radical"),$("atom_inversion").value=ui.render.atomGetAttr(t,"invRet"),$("atom_exactchange").value=ui.render.atomGetAttr(t,"exactChangeFlag")?1:0,$("atom_ringcount").value=ui.render.atomGetAttr(t,"ringBondCount"),$("atom_substitution").value=ui.render.atomGetAttr(t,"substitutionCount"),$("atom_unsaturation").value=ui.render.atomGetAttr(t,"unsaturatedAtom"),$("atom_hcount").value=ui.render.atomGetAttr(t,"hCount"),ui.showDialog("atom_properties"),$("atom_label").activate()},ui.applyAtomProperties=function(){ui.hideDialog("atom_properties");var t=$("atom_properties").atom_id;ui.addUndoAction(ui.Action.fromAtomsAttrs(t,{label:$("atom_label").value,charge:""==$("atom_charge").value?0:parseInt($("atom_charge").value),isotope:""==$("atom_isotope").value?0:parseInt($("atom_isotope").value),explicitValence:""==$("atom_valence").value?-1:parseInt($("atom_valence").value),radical:parseInt($("atom_radical").value),invRet:parseInt($("atom_inversion").value),exactChangeFlag:parseInt($("atom_exactchange").value)?!0:!1,ringBondCount:parseInt($("atom_ringcount").value),substitutionCount:parseInt($("atom_substitution").value),unsaturatedAtom:parseInt($("atom_unsaturation").value),hCount:parseInt($("atom_hcount").value)}),!0),ui.render.update()},ui.onChange_AtomLabel=function(){this.value=this.value.strip().capitalize();var t=chem.Element.getElementByLabel(this.value);null==t&&"A"!=this.value&&"*"!=this.value&&"Q"!=this.value&&"X"!=this.value&&"R"!=this.value&&(this.value=ui.render.atomGetAttr($("atom_properties").atom_id,"label"),"A"!=this.value&&"*"!=this.value&&(t=chem.Element.getElementByLabel(this.value))),"A"==this.value||"*"==this.value?$("atom_number").value="any":t?$("atom_number").value=t.toString():$("atom_number").value=""},ui.onChange_AtomCharge=function(){""==this.value.strip()||"0"==this.value?this.value="":this.value.match(/^[1-9][0-9]{0,1}[-+]$/)?this.value=(this.value.endsWith("-")?"-":"")+this.value.substr(0,this.value.length-1):this.value.match(/^[+-]?[1-9][0-9]{0,1}$/)||(this.value=ui.render.atomGetAttr($("atom_properties").atom_id,"charge"))},ui.onChange_AtomIsotope=function(){this.value==util.getElementTextContent($("atom_number"))||""==this.value.strip()||"0"==this.value?this.value="":this.value.match(/^[1-9][0-9]{0,2}$/)||(this.value=ui.render.atomGetAttr($("atom_properties").atom_id,"isotope"))},ui.onChange_AtomValence=function(){},ui.showBondProperties=function(t){$("bond_properties").bond_id=t;var e=ui.render.bondGetAttr(t,"type"),i=ui.render.bondGetAttr(t,"stereo");for(var n in ui.bondTypeMap)if(ui.bondTypeMap[n].type==e&&ui.bondTypeMap[n].stereo==i)break;$("bond_type").value=n,$("bond_topology").value=ui.render.bondGetAttr(t,"topology")||0,$("bond_center").value=ui.render.bondGetAttr(t,"reactingCenterStatus")||0,ui.showDialog("bond_properties"),$("bond_type").activate()},ui.applyBondProperties=function(){ui.hideDialog("bond_properties");var t=$("bond_properties").bond_id,e=Object.clone(ui.bondTypeMap[$("bond_type").value]);e.topology=parseInt($("bond_topology").value),e.reactingCenterStatus=parseInt($("bond_center").value),ui.addUndoAction(ui.Action.fromBondAttrs(t,e),!0),ui.render.update()},ui.showSGroupProperties=function(t,e,i,n,r){if(!e)throw new Error("Tool not specified. Note: this method should only be invoked by rnd.Editor.SGroupTool.SGroupHelper, all other usages are obsolete.");if(!$("sgroup_properties").visible()){var o=null==t?"GEN":ui.render.sGroupGetType(t);switch($("sgroup_properties").sgroup_id=t,$("sgroup_type").value=o,ui.onChange_SGroupType.call($("sgroup_type")),o){case"SRU":$("sgroup_connection").value=ui.render.sGroupGetAttr(t,"connectivity"),$("sgroup_label").value=ui.render.sGroupGetAttr(t,"subscript");break;case"MUL":$("sgroup_label").value=ui.render.sGroupGetAttr(t,"mul");break;case"SUP":$("sgroup_label").value=ui.render.sGroupGetAttr(t,"name");break;case"DAT":$("sgroup_field_name").value=ui.render.sGroupGetAttr(t,"fieldName"),$("sgroup_field_value").value=ui.render.sGroupGetAttr(t,"fieldValue");var s=ui.render.sGroupGetAttr(t,"attached"),a=ui.render.sGroupGetAttr(t,"absolute");$(s?"sgroup_pos_attached":a?"sgroup_pos_absolute":"sgroup_pos_relative").checked=!0}"DAT"!=o&&($("sgroup_field_name").value="",$("sgroup_field_value").value="");var l=function(){ui.hideDialog("sgroup_properties"),c(),r.call(e)},u=function(){ui.hideDialog("sgroup_properties");var t=$("sgroup_properties").sgroup_id,i=$("sgroup_type").value,r={mul:null,connectivity:"",name:"",subscript:"",fieldName:"",fieldValue:""};switch(i){case"SRU":if(r.connectivity=$("sgroup_connection").value.strip(),r.subscript=$("sgroup_label").value.strip(),1!=r.subscript.length||!r.subscript.match(/^[a-zA-Z]$/))return alert(r.subscript.length?"SRU subscript should consist of a single letter.":"Please provide an SRU subscript."),void ui.showDialog("sgroup_properties");break;case"MUL":r.mul=parseInt($("sgroup_label").value);break;case"SUP":if(r.name=$("sgroup_label").value.strip(),!r.name)return alert("Please provide a name for the superatom."),void ui.showDialog("sgroup_properties");break;case"DAT":if(r.fieldName=$("sgroup_field_name").value.strip(),r.fieldValue=$("sgroup_field_value").value.strip(),r.absolute=$("sgroup_pos_absolute").checked,r.attached=$("sgroup_pos_attached").checked,""==r.fieldName||""==r.fieldValue)return alert("Please, specify data field name and value."),void ui.showDialog("sgroup_properties")}c(),n.call(e,t,i,r)},c=function(){$("sgroup_prop_cancel").stopObserving("click",l),$("sgroup_prop_ok").stopObserving("click",u)};$("sgroup_prop_cancel").observe("click",l),$("sgroup_prop_ok").observe("click",u),ui.showDialog("sgroup_properties"),ui.sGroupDlgSelection=i,$("sgroup_type").activate()}},ui.onChange_SGroupLabel=function(){"MUL"!=$("sgroup_type").value||this.value.match(/^[1-9][0-9]{0,2}$/)||(this.value="1")},ui.onChange_SGroupType=function(){var t=$("sgroup_type").value;return"DAT"==t?($$(".generalSGroup").each(function(t){t.hide()}),void $$(".dataSGroup").each(function(t){t.show()})):($$(".generalSGroup").each(function(t){t.show()}),$$(".dataSGroup").each(function(t){t.hide()}),$("sgroup_label").disabled="SRU"!=t&&"MUL"!=t&&"SUP"!=t,$("sgroup_connection").disabled="SRU"!=t,void("MUL"!=t||$("sgroup_label").value.match(/^[1-9][0-9]{0,2}$/)?"SRU"==t?$("sgroup_label").value="n":("GEN"==t||"SUP"==t)&&($("sgroup_label").value=""):$("sgroup_label").value="1"))},ui.showAutomapProperties=function(t){ui.showDialog("automap_properties");var e=new Event.Handler("automap_ok","click",void 0,function(){e.stop(),i.stop(),t&&"onOk"in t&&t.onOk($("automap_mode").value),ui.hideDialog("automap_properties")}).start(),i=new Event.Handler("automap_cancel","click",void 0,function(){e.stop(),i.stop(),ui.hideDialog("automap_properties"),t&&"onCancel"in t&&t.onCancel()}).start();$("automap_mode").activate()},ui.onClick_ElemTableButton=function(){this.hasClassName("buttonDisabled")||ui.showElemTable({onOk:function(){return ui.onClick_SideButton.apply($("atom_table")),!0},onCancel:function(){ui.elem_table_obj.restore()}})},ui.showElemTable=function(t){if(!$("elem_table").visible()){t=t||{},ui.showDialog("elem_table"),"undefined"==typeof ui.elem_table_obj&&(ui.elem_table_obj=new rnd.ElementTable("elem_table_area",{fillColor:"#DADADA",fillColorSelected:"#FFFFFF",frameColor:"#E8E8E8",fontSize:23,buttonHalfSize:18},!0),ui.elem_table_area=ui.elem_table_obj.renderTable(),$("elem_table_single").checked=!0),ui.elem_table_obj.store(),ui.elem_table_obj.setSelection(t.selection);var e=new Event.Handler("elem_table_ok","click",void 0,function(){t&&"onOk"in t&&!t.onOk(ui.elem_table_obj.getAtomProps())||(e.stop(),i.stop(),ui.hideDialog("elem_table"))}).start(),i=new Event.Handler("elem_table_cancel","click",void 0,function(){e.stop(),i.stop(),ui.hideDialog("elem_table"),t&&"onCancel"in t&&t.onCancel()}).start();$("elem_table_ok").focus()}},ui.showRGroupTable=function(t){if(!$("rgroup_table").visible()){t=t||{},ui.showDialog("rgroup_table"),"undefined"==typeof ui.rgroup_table_obj&&(ui.rgroup_table_obj=new rnd.RGroupTable("rgroup_table_area",{fillColor:"#DADADA",fillColorSelected:"#FFFFFF",frameColor:"#E8E8E8",fontSize:18,buttonHalfSize:18},!0)),ui.rgroup_table_obj.setMode(t.mode||"multiple"),ui.rgroup_table_obj.setSelection(t.selection||0);var e=new Event.Handler("rgroup_table_ok","click",void 0,function(){e.stop(),i.stop(),ui.hideDialog("rgroup_table"),"onOk"in t&&t.onOk(ui.rgroup_table_obj.selection)}).start(),i=new Event.Handler("rgroup_table_cancel","click",void 0,function(){e.stop(),i.stop(),ui.hideDialog("rgroup_table"),"onCancel"in t&&t.onCancel()}).start();$("rgroup_table_ok").focus()}},ui.showRLogicTable=function(t){t=t||{},t.rlogic=t.rlogic||{},$("rlogic_occurrence").value=t.rlogic.occurrence||">0",$("rlogic_resth").value=t.rlogic.resth?"1":"0";for(var e='<option value="0">Always</option>',i=1;32>=i;i++)i!=t.rgid&&0!=(t.rgmask&1<<i-1)&&(e+='<option value="'+i+'">IF R'+t.rgid+" THEN R"+i+"</option>");$("rlogic_if").outerHTML='<select id="rlogic_if">'+e+"</select>",$("rlogic_if").value=t.rlogic.ifthen,ui.showDialog("rlogic_table");var n=new Event.Handler("rlogic_ok","click",void 0,function(){var e={occurrence:$("rlogic_occurrence").value.replace(/\s*/g,"").replace(/,+/g,",").replace(/^,/,"").replace(/,$/,""),resth:"1"==$("rlogic_resth").value,ifthen:parseInt($("rlogic_if").value)};t&&"onOk"in t&&!t.onOk(e)||(n.stop(),r.stop(),ui.hideDialog("rlogic_table"))}).start(),r=new Event.Handler("rlogic_cancel","click",void 0,function(){n.stop(),r.stop(),ui.hideDialog("rlogic_table"),t&&"onCancel"in t&&t.onCancel()}).start();$("rlogic_occurrence").activate()},ui.onSelect_ElemTableNotList=function(){try{ui.elem_table_obj.updateAtomProps()}catch(t){if(ui.forwardExceptions)throw t;ErrorHandler.handleError(t)}},ui.clipboard=null,ui.isClipboardEmpty=function(){return null==ui.clipboard},ui.updateClipboardButtons=function(){ui.isClipboardEmpty()?$("paste").addClassName("buttonDisabled"):$("paste").removeClassName("buttonDisabled"),ui.editor.hasSelection(!0)?($("copy").removeClassName("buttonDisabled"),$("cut").removeClassName("buttonDisabled")):($("copy").addClassName("buttonDisabled"),$("cut").addClassName("buttonDisabled"))},ui.copy=function(t,e){return t||(t=ui.ctab,e=ui.editor.getSelection(!0)),e&&e.sgroupData&&e.sgroupData.clear(),ui.clipboard={atoms:new Array,bonds:new Array,sgroups:new Array,rxnArrows:new Array,rxnPluses:new Array,chiralFlags:new Array,rgmap:{},rgroups:{},getAnchorPosition:function(){if(this.atoms.length){for(var t=1e50,e=t,i=-t,n=-e,r=0;r<this.atoms.length;r++)t=Math.min(t,this.atoms[r].pp.x),e=Math.min(e,this.atoms[r].pp.y),i=Math.max(i,this.atoms[r].pp.x),n=Math.max(n,this.atoms[r].pp.y);return new util.Vec2((t+i)/2,(e+n)/2)}return this.rxnArrows.length?this.rxnArrows[0].pp:this.rxnPluses.length?this.rxnPluses[0].pp:this.chiralFlags.length?this.chiralFlags[0].pp:null}},ui.structToClipboard(ui.clipboard,t,e),!!ui.clipboard.getAnchorPosition()},ui.structToClipboard=function(t,e,i){i=i||{atoms:e.atoms.keys(),bonds:e.bonds.keys(),rxnArrows:e.rxnArrows.keys(),rxnPluses:e.rxnPluses.keys()};var n={};i.atoms.each(function(i){var r=new chem.Struct.Atom(e.atoms.get(i));r.pos=r.pp,n[i]=t.atoms.push(new chem.Struct.Atom(r))-1}),i.bonds.each(function(i){var r=new chem.Struct.Bond(e.bonds.get(i));r.begin=n[r.begin],r.end=n[r.end],t.bonds.push(new chem.Struct.Bond(r))});var r=e.getSGroupsInAtomSet(i.atoms);util.each(r,function(i){for(var r=e.sgroups.get(i),o=chem.SGroup.getAtoms(e,r),s={type:r.type,attrs:r.getAttrs(),atoms:util.array(o),pp:r.pp},a=0;a<s.atoms.length;a++)s.atoms[a]=n[s.atoms[a]];t.sgroups.push(s)},this),i.rxnArrows.each(function(i){var n=new chem.Struct.RxnArrow(e.rxnArrows.get(i));n.pos=n.pp,t.rxnArrows.push(n)}),i.rxnPluses.each(function(i){var n=new chem.Struct.RxnPlus(e.rxnPluses.get(i));n.pos=n.pp,t.rxnPluses.push(n)});var o={},s=util.Set.empty();i.atoms.each(function(t){var i=e.atoms.get(t),n=i.fragment;o[t]=n,util.Set.add(s,n)});var a=util.Set.empty();util.Set.each(s,function(i){for(var n=chem.Struct.Fragment.getAtoms(e,i),r=0;r<n.length;++r)if(!util.Set.contains(o,n[r]))return;var s=chem.Struct.RGroup.findRGroupByFragment(e.rgroups,i);t.rgmap[i]=s,util.Set.add(a,s)},this),util.Set.each(a,function(i){t.rgroups[i]=e.rgroups.get(i).getAttrs()},this)},ui.onClick_Cut=function(){this.hasClassName("buttonDisabled")||ui.copy()&&ui.removeSelected()},ui.onClick_Copy=function(){this.hasClassName("buttonDisabled")||ui.copy()&&ui.editor.deselectAll()},ui.onClick_Paste=function(){this.hasClassName("buttonDisabled")||ui.selectMode("paste")},ui.onClick_Undo=function(){this.hasClassName("buttonDisabled")||ui.undo()},ui.onClick_Redo=function(){this.hasClassName("buttonDisabled")||ui.redo()},ui.showLabelEditor=function(t){var e=$("input_label"),i=Math.min(6*ui.zoom,16);e.atom_id=t,e.value=ui.render.atomGetAttr(t,"label"),e.style.fontSize=(2*i).toString()+"px",e.show();var n=ui.render.obj2view(ui.render.atomGetPos(t)),r=ui.client_area.cumulativeOffset(),o=Element.cumulativeOffset(e.offsetParent),s=0;e.style.left=(n.x+r.left-o.left-i-s).toString()+"px",e.style.top=(n.y+r.top-o.top-i-s).toString()+"px",e.activate()},"undefined"==typeof ui&&(ui=function(){}),ui.Action=function(){this.operations=new Array},ui.Action.prototype.addOp=function(t){return t.isDummy(ui.editor)||this.operations.push(t),t},ui.Action.prototype.mergeWith=function(t){return this.operations=this.operations.concat(t.operations),this},ui.Action.prototype.perform=function(){var t=new ui.Action,e=0;return this.operations.each(function(i){t.addOp(i.perform(ui.editor)),e++},this),t.operations.reverse(),t},ui.Action.prototype.isDummy=function(){return null==this.operations.detect(function(t){return!t.isDummy(ui.editor)},this)},ui.Action.fromMultipleMove=function(t,e){e=new util.Vec2(e);var i,n=new ui.Action,r=ui.render,o=r.ctab,s=o.molecule,a=[],l=util.Set.empty(),u=util.Set.empty();if(t.atoms){var c=util.Set.fromList(t.atoms);for(o.bonds.each(function(t,e){util.Set.contains(c,e.b.begin)&&util.Set.contains(c,e.b.end)?(a.push(t),util.each(["hb1","hb2"],function(t){var i=s.halfBonds.get(e.b[t]).loop;i>=0&&util.Set.add(l,i)},this)):util.Set.contains(c,e.b.begin)?util.Set.add(u,e.b.begin):util.Set.contains(c,e.b.end)&&util.Set.add(u,e.b.end)},this),i=0;i<a.length;++i)n.addOp(new ui.Action.OpBondMove(a[i],e));for(util.Set.each(l,function(t){o.reloops.get(t)&&o.reloops.get(t).visel&&n.addOp(new ui.Action.OpLoopMove(t,e))},this),i=0;i<t.atoms.length;++i){var h=t.atoms[i];n.addOp(new ui.Action.OpAtomMove(h,e,!util.Set.contains(u,h)))}}if(t.rxnArrows)for(i=0;i<t.rxnArrows.length;++i)n.addOp(new ui.Action.OpRxnArrowMove(t.rxnArrows[i],e,!0));if(t.rxnPluses)for(i=0;i<t.rxnPluses.length;++i)n.addOp(new ui.Action.OpRxnPlusMove(t.rxnPluses[i],e,!0));if(t.sgroupData)for(i=0;i<t.sgroupData.length;++i)n.addOp(new ui.Action.OpSGroupDataMove(t.sgroupData[i],e));if(t.chiralFlags)for(i=0;i<t.chiralFlags.length;++i)n.addOp(new ui.Action.OpChiralFlagMove(e));return n.perform()},ui.Action.fromAtomsAttrs=function(t,e,i){var n=new ui.Action;return("number"==typeof t?[t]:t).each(function(t){for(var r in chem.Struct.Atom.attrlist){var o;if(r in e)o=e[r];else{if(!i)continue;o=chem.Struct.Atom.attrGetDefault(r)}n.addOp(new ui.Action.OpAtomAttr(t,r,o))}!i&&"label"in e&&null!=e.label&&"L#"!=e.label&&!e.atomList&&n.addOp(new ui.Action.OpAtomAttr(t,"atomList",null))},this),n.perform()},ui.Action.fromBondAttrs=function(t,e,i,n){var r=new ui.Action;for(var o in chem.Struct.Bond.attrlist){var s;if(o in e)s=e[o];else{if(!n)continue;s=chem.Struct.Bond.attrGetDefault(o)}r.addOp(new ui.Action.OpBondAttr(t,o,s))}return i&&r.mergeWith(ui.Action.toBondFlipping(t)),r.perform()},ui.Action.fromSelectedBondsAttrs=function(t,e){var i=new ui.Action;return t=new Hash(t),ui.editor.getSelection().bonds.each(function(e){t.each(function(t){i.addOp(new ui.Action.OpBondAttr(e,t.key,t.value))},this)},this),e&&e.each(function(t){i.mergeWith(ui.Action.toBondFlipping(t))},this),i.perform()},ui.Action.fromAtomAddition=function(t,e){e=Object.clone(e);var i=new ui.Action;return e.fragment=i.addOp((new ui.Action.OpFragmentAdd).perform(ui.editor)).frid,i.addOp(new ui.Action.OpAtomAdd(e,t).perform(ui.editor)),i},ui.Action.mergeFragments=function(t,e,i){if(i!=e&&Object.isNumber(i)){var n=chem.Struct.RGroup.findRGroupByFragment(ui.render.ctab.molecule.rgroups,i);Object.isUndefined(n)||t.mergeWith(ui.Action.fromRGroupFragment(null,i)),ui.render.ctab.molecule.atoms.each(function(n,r){r.fragment==i&&t.addOp(new ui.Action.OpAtomAttr(n,"fragment",e).perform(ui.editor))}),t.addOp(new ui.Action.OpFragmentDelete(i).perform(ui.editor))}},ui.Action.fromBondAddition=function(t,e,i,n,r){var o=new ui.Action,s=null;if(Object.isNumber(e)){if(s=ui.render.atomGetAttr(e,"fragment"),Object.isNumber(i)){var a=ui.render.atomGetAttr(i,"fragment");ui.Action.mergeFragments(o,s,a)}}else Object.isNumber(i)&&(s=ui.render.atomGetAttr(i,"fragment"));null==s&&(s=o.addOp((new ui.Action.OpFragmentAdd).perform(ui.editor)).frid),Object.isNumber(e)?"*"==ui.render.atomGetAttr(e,"label")&&o.addOp(new ui.Action.OpAtomAttr(e,"label","C").perform(ui.editor)):(e.fragment=s,e=o.addOp(new ui.Action.OpAtomAdd(e,n).perform(ui.editor)).data.aid,n=r),Object.isNumber(i)?"*"==ui.render.atomGetAttr(i,"label")&&o.addOp(new ui.Action.OpAtomAttr(i,"label","C").perform(ui.editor)):(i.fragment=s,i=o.addOp(new ui.Action.OpAtomAdd(i,n).perform(ui.editor)).data.aid,Object.isNumber(e)&&ui.render.atomGetSGroups(e).each(function(t){o.addOp(new ui.Action.OpSGroupAtomAdd(t,i).perform(ui.editor))},this));var l=o.addOp(new ui.Action.OpBondAdd(e,i,t).perform(ui.editor)).data.bid;return o.operations.reverse(),[o,e,i,l]},ui.Action.fromArrowAddition=function(t){var e=new ui.Action;return ui.ctab.rxnArrows.count()<1&&e.addOp(new ui.Action.OpRxnArrowAdd(t).perform(ui.editor)),e},ui.Action.fromArrowDeletion=function(t){var e=new ui.Action;return e.addOp(new ui.Action.OpRxnArrowDelete(t)),e.perform()},ui.Action.fromChiralFlagAddition=function(t){var e=new ui.Action;return ui.render.ctab.chiralFlags.count()<1&&e.addOp(new ui.Action.OpChiralFlagAdd(t).perform(ui.editor)),e},ui.Action.fromChiralFlagDeletion=function(){var t=new ui.Action;return t.addOp(new ui.Action.OpChiralFlagDelete),t.perform()},ui.Action.fromPlusAddition=function(t){var e=new ui.Action;return e.addOp(new ui.Action.OpRxnPlusAdd(t).perform(ui.editor)),e},ui.Action.fromPlusDeletion=function(t){var e=new ui.Action;return e.addOp(new ui.Action.OpRxnPlusDelete(t)),e.perform()},ui.Action.prototype.removeAtomFromSgroupIfNeeded=function(t){var e=ui.render.atomGetSGroups(t);return e.length>0?(e.each(function(e){this.addOp(new ui.Action.OpSGroupAtomRemove(e,t))},this),!0):!1},ui.Action.prototype.removeSgroupIfNeeded=function(t){var e=ui.render,i=e.ctab,n=i.molecule,r=new Hash;t.each(function(t){var e=ui.render.atomGetSGroups(t);e.each(function(t){var e=r.get(t);Object.isUndefined(e)?e=1:e++,r.set(t,e)},this)},this),r.each(function(t){var e=parseInt(t.key),i=ui.render.sGroupGetAtoms(e);if(i.length==t.value){var r=n.sgroups.get(e);this.mergeWith(ui.Action.sGroupAttributeAction(e,r.getAttrs())),this.addOp(new ui.Action.OpSGroupRemoveFromHierarchy(e)),this.addOp(new ui.Action.OpSGroupDelete(e))}},this)},ui.Action.fromAtomDeletion=function(t){var e=new ui.Action,i=new Array,n=ui.ctab.atoms.get(t).fragment;return ui.render.atomGetNeighbors(t).each(function(t){e.addOp(new ui.Action.OpBondDelete(t.bid)),1==ui.render.atomGetDegree(t.aid)&&(e.removeAtomFromSgroupIfNeeded(t.aid)&&i.push(t.aid),e.addOp(new ui.Action.OpAtomDelete(t.aid)))},this),e.removeAtomFromSgroupIfNeeded(t)&&i.push(t),e.addOp(new ui.Action.OpAtomDelete(t)),e.removeSgroupIfNeeded(i),e=e.perform(),e.mergeWith(ui.Action.__fromFragmentSplit(n)),e},ui.Action.fromBondDeletion=function(t){var e=new ui.Action,i=ui.ctab.bonds.get(t),n=ui.ctab.atoms.get(i.begin).fragment,r=new Array;return e.addOp(new ui.Action.OpBondDelete(t)),1==ui.render.atomGetDegree(i.begin)&&(e.removeAtomFromSgroupIfNeeded(i.begin)&&r.push(i.begin),e.addOp(new ui.Action.OpAtomDelete(i.begin))),1==ui.render.atomGetDegree(i.end)&&(e.removeAtomFromSgroupIfNeeded(i.end)&&r.push(i.end),e.addOp(new ui.Action.OpAtomDelete(i.end))),e.removeSgroupIfNeeded(r),e=e.perform(),e.mergeWith(ui.Action.__fromFragmentSplit(n)),e},ui.Action.__fromFragmentSplit=function(t){var e=new ui.Action,i=chem.Struct.RGroup.findRGroupByFragment(ui.ctab.rgroups,t);return ui.ctab.atoms.each(function(n,r){if(r.fragment==t){var o=e.addOp((new ui.Action.OpFragmentAdd).perform(ui.editor)).frid,s=function(i){e.addOp(new ui.Action.OpAtomAttr(i,"fragment",o).perform(ui.editor)),ui.render.atomGetNeighbors(i).each(function(e){ui.ctab.atoms.get(e.aid).fragment==t&&s(e.aid)})};s(n),i&&e.mergeWith(ui.Action.fromRGroupFragment(i,o))}}),-1!=t&&(e.mergeWith(ui.Action.fromRGroupFragment(0,t)),e.addOp(new ui.Action.OpFragmentDelete(t).perform(ui.editor))),e},ui.Action.fromFragmentAddition=function(t,e,i,n,r){var o=new ui.Action;return i.each(function(t){o.addOp(new ui.Action.OpSGroupRemoveFromHierarchy(t)),o.addOp(new ui.Action.OpSGroupDelete(t))},this),e.each(function(t){o.addOp(new ui.Action.OpBondDelete(t))},this),t.each(function(t){o.addOp(new ui.Action.OpAtomDelete(t))},this),n.each(function(t){o.addOp(new ui.Action.OpRxnArrowDelete(t))},this),r.each(function(t){o.addOp(new ui.Action.OpRxnPlusDelete(t))},this),o.mergeWith(new ui.Action.__fromFragmentSplit(-1)),o},ui.Action.fromFragmentDeletion=function(t){t=t||ui.editor.getSelection();
var e=new ui.Action,i=new Array,n=[],r=new ui.Action;for(t.sgroupData&&t.sgroupData.each(function(t){r.mergeWith(ui.Action.fromSgroupDeletion(t))},this),t.atoms.each(function(e){ui.render.atomGetNeighbors(e).each(function(e){-1==t.bonds.indexOf(e.bid)&&(t.bonds=t.bonds.concat([e.bid]))},this)},this),t.bonds.each(function(r){e.addOp(new ui.Action.OpBondDelete(r));var o=ui.ctab.bonds.get(r);if(-1==t.atoms.indexOf(o.begin)&&1==ui.render.atomGetDegree(o.begin)){var s=ui.ctab.atoms.get(o.begin).fragment;n.indexOf(s)<0&&n.push(s),e.removeAtomFromSgroupIfNeeded(o.begin)&&i.push(o.begin),e.addOp(new ui.Action.OpAtomDelete(o.begin))}if(-1==t.atoms.indexOf(o.end)&&1==ui.render.atomGetDegree(o.end)){var a=ui.ctab.atoms.get(o.end).fragment;n.indexOf(a)<0&&n.push(a),e.removeAtomFromSgroupIfNeeded(o.end)&&i.push(o.end),e.addOp(new ui.Action.OpAtomDelete(o.end))}},this),t.atoms.each(function(t){var r=ui.ctab.atoms.get(t).fragment;n.indexOf(r)<0&&n.push(r),e.removeAtomFromSgroupIfNeeded(t)&&i.push(t),e.addOp(new ui.Action.OpAtomDelete(t))},this),e.removeSgroupIfNeeded(i),t.rxnArrows.each(function(t){e.addOp(new ui.Action.OpRxnArrowDelete(t))},this),t.rxnPluses.each(function(t){e.addOp(new ui.Action.OpRxnPlusDelete(t))},this),t.chiralFlags.each(function(t){e.addOp(new ui.Action.OpChiralFlagDelete(t))},this),e=e.perform();n.length>0;)e.mergeWith(new ui.Action.__fromFragmentSplit(n.pop()));return e.mergeWith(r),e},ui.Action.fromAtomMerge=function(t,e){var i=new ui.Action,n=ui.render.atomGetAttr(t,"fragment"),r=ui.render.atomGetAttr(e,"fragment");n!=r&&ui.Action.mergeFragments(i,n,r);var o=new ui.Action;ui.render.atomGetNeighbors(t).each(function(t){var i,n,r=ui.ctab.bonds.get(t.bid);r.begin==t.aid?(i=t.aid,n=e):(i=e,n=t.aid),e!=r.begin&&e!=r.end&&-1==ui.ctab.findBondId(i,n)&&o.addOp(new ui.Action.OpBondAdd(i,n,r)),o.addOp(new ui.Action.OpBondDelete(t.bid))},this);var s=chem.Struct.Atom.getAttrHash(ui.ctab.atoms.get(t));1==ui.render.atomGetDegree(t)&&"*"==s.get("label")&&s.set("label","C"),s.each(function(t){o.addOp(new ui.Action.OpAtomAttr(e,t.key,t.value))},this);var a=o.removeAtomFromSgroupIfNeeded(t);return o.addOp(new ui.Action.OpAtomDelete(t)),a&&o.removeSgroupIfNeeded([t]),o.perform().mergeWith(i)},ui.Action.toBondFlipping=function(t){var e=ui.ctab.bonds.get(t),i=new ui.Action;return i.addOp(new ui.Action.OpBondDelete(t)),i.addOp(new ui.Action.OpBondAdd(e.end,e.begin,e)).data.bid=t,i},ui.Action.fromBondFlipping=function(t){return ui.Action.toBondFlipping(t).perform()},ui.Action.fromTemplateOnCanvas=function(t,e,i){var n=new ui.Action,r=i.molecule,o=(new ui.Action.OpFragmentAdd).perform(ui.editor),s={};return r.atoms.each(function(r,a){var l,u=chem.Struct.Atom.getAttrHash(a).toObject();u.fragment=o.frid,n.addOp(l=new ui.Action.OpAtomAdd(u,util.Vec2.diff(a.pp,i.xy0).rotate(e).add(t)).perform(ui.editor)),s[r]=l.data.aid}),r.bonds.each(function(t,e){n.addOp(new ui.Action.OpBondAdd(s[e.begin],s[e.end],e).perform(ui.editor))}),n.operations.reverse(),n.addOp(o),n},ui.Action.atomAddToSGroups=function(t,e){var i=new ui.Action;return util.each(t,function(t){i.addOp(new ui.Action.OpSGroupAtomAdd(t,e).perform(ui.editor))},this),i},ui.Action.fromTemplateOnAtom=function(t,e,i,n,r){var o=new ui.Action,s=n.molecule,a=ui.render,l=a.ctab,u=l.molecule,c=u.atoms.get(t),h=t,d=null,p=ui.render.atomGetSGroups(t),f=a.atomGetAttr(t,"fragment"),m={},g=s.atoms.get(n.aid).pp;if(i){if(null==e){var b=ui.atomForNewBond(t),v=ui.Action.fromBondAddition({type:1},t,b.atom,b.pos);o=v[0],o.operations.reverse(),d=t=v[2]}else{var y;o.addOp(y=new ui.Action.OpAtomAdd({label:"C",fragment:f},new util.Vec2(1,0).rotate(e).add(c.pp)).perform(ui.editor)),o.addOp(new ui.Action.OpBondAdd(t,y.data.aid,{type:1}).perform(ui.editor)),d=t=y.data.aid,o.mergeWith(ui.Action.atomAddToSGroups(p,t))}var w=c;c=u.atoms.get(t);var S=r(w.pp,c.pp)-n.angle0}else null==e&&(b=ui.atomForNewBond(t),e=r(c.pp,b.pos)),S=e-n.angle0;return s.atoms.each(function(e,i){var r=chem.Struct.Atom.getAttrHash(i).toObject();if(r.fragment=f,e==n.aid)o.mergeWith(ui.Action.fromAtomsAttrs(t,r,!0)),m[e]=t;else{var s;s=util.Vec2.diff(i.pp,g).rotate(S).add(c.pp),o.addOp(y=new ui.Action.OpAtomAdd(r,s).perform(ui.editor)),m[e]=y.data.aid}m[e]-0!==h-0&&m[e]-0!==d-0&&o.mergeWith(ui.Action.atomAddToSGroups(p,m[e]))}),s.bonds.each(function(t,e){o.addOp(new ui.Action.OpBondAdd(m[e.begin],m[e.end],e).perform(ui.editor))}),o.operations.reverse(),o},ui.Action.fromTemplateOnBond=function(t,e,i,n){var r,o,s=new ui.Action,a=e.molecule,l=ui.render,u=l.ctab,c=u.molecule,h=c.bonds.get(t),d=c.atoms.get(h.begin),p=c.atoms.get(h.end),f=util.Set.list(util.Set.intersection(util.Set.fromList(ui.render.atomGetSGroups(h.begin)),util.Set.fromList(ui.render.atomGetSGroups(h.end)))),m=a.bonds.get(e.bid),g=l.atomGetAttr(h.begin,"fragment"),b={};n?(r=a.atoms.get(m.end),o=a.atoms.get(m.begin),b[m.end]=h.begin,b[m.begin]=h.end):(r=a.atoms.get(m.begin),o=a.atoms.get(m.end),b[m.begin]=h.begin,b[m.end]=h.end);var v=i(d.pp,p.pp)-i(r.pp,o.pp),y=util.Vec2.dist(d.pp,p.pp)/util.Vec2.dist(r.pp,o.pp);r.pp;return a.atoms.each(function(t,e){var i=chem.Struct.Atom.getAttrHash(e).toObject();if(i.fragment=g,t==m.begin||t==m.end)return void s.mergeWith(ui.Action.fromAtomsAttrs(b[t],i,!0));var n;n=util.Vec2.diff(e.pp,r.pp).rotate(v).scaled(y).add(d.pp);var o=l.findClosestAtom(n,.1);if(null==o){var a;s.addOp(a=new ui.Action.OpAtomAdd(i,n).perform(ui.editor)),b[t]=a.data.aid,s.mergeWith(ui.Action.atomAddToSGroups(f,b[t]))}else b[t]=o.id,s.mergeWith(ui.Action.fromAtomsAttrs(b[t],i,!0))}),a.bonds.each(function(t,e){var i=c.findBondId(b[e.begin],b[e.end]);-1==i?s.addOp(new ui.Action.OpBondAdd(b[e.begin],b[e.end],e).perform(ui.editor)):s.mergeWith(ui.Action.fromBondAttrs(i,m,!1,!0))}),s.operations.reverse(),s},ui.Action.fromChain=function(t,e,i,n){var r,o=Math.PI/6,s=Math.cos(o),a=Math.sin(o),l=new ui.Action;r=null!=n?ui.render.atomGetAttr(n,"fragment"):l.addOp((new ui.Action.OpFragmentAdd).perform(ui.editor)).frid;var u=-1;return u=null!=n?n:l.addOp(new ui.Action.OpAtomAdd({label:"C",fragment:r},t).perform(ui.editor)).data.aid,l.operations.reverse(),i.times(function(i){var n=new util.Vec2(s*(i+1),1&i?0:a).rotate(e).add(t),r=ui.render.findClosestAtom(n,.1),o=ui.Action.fromBondAddition({},u,r?r.id:{},n);l=o[0].mergeWith(l),u=o[2]},this),l},ui.Action.fromNewCanvas=function(t){var e=new ui.Action;return e.addOp(new ui.Action.OpCanvasLoad(t)),e.perform()},ui.Action.fromSgroupType=function(t,e){var i=ui.render,n=i.sGroupGetType(t);if(e&&e!=n){var r=util.array(i.sGroupGetAtoms(t)),o=i.sGroupGetAttrs(t),s=ui.Action.fromSgroupDeletion(t),a=ui.Action.fromSgroupAddition(e,r,o,t);return a.mergeWith(s)}return new ui.Action},ui.Action.fromSgroupAttrs=function(t,e){var i=new ui.Action,n=ui.render,r=n.ctab;r.sgroups.get(t).item;return new Hash(e).each(function(e){i.addOp(new ui.Action.OpSGroupAttr(t,e.key,e.value))},this),i.perform()},ui.Action.sGroupAttributeAction=function(t,e){var i=new ui.Action;return new Hash(e).each(function(e){i.addOp(new ui.Action.OpSGroupAttr(t,e.key,e.value))},this),i},ui.Action.fromSgroupDeletion=function(t){var e=new ui.Action,i=ui.render,n=i.ctab,r=n.molecule;if("SRU"==ui.render.sGroupGetType(t)){ui.render.sGroupsFindCrossBonds();var o=ui.render.sGroupGetNeighborAtoms(t);o.each(function(t){"*"==ui.render.atomGetAttr(t,"label")&&e.addOp(new ui.Action.OpAtomAttr(t,"label","C"))},this)}var s=r.sgroups.get(t),a=chem.SGroup.getAtoms(r,s),l=s.getAttrs();e.addOp(new ui.Action.OpSGroupRemoveFromHierarchy(t));for(var u=0;u<a.length;++u)e.addOp(new ui.Action.OpSGroupAtomRemove(t,a[u]));return e.addOp(new ui.Action.OpSGroupDelete(t)),e=e.perform(),e.mergeWith(ui.Action.sGroupAttributeAction(t,l)),e},ui.Action.fromSgroupAddition=function(t,e,i,n,r){var o,s=new ui.Action;for(n=n-0===n?n:ui.render.ctab.molecule.sgroups.newId(),s.addOp(new ui.Action.OpSGroupCreate(n,t,r)),o=0;o<e.length;o++)s.addOp(new ui.Action.OpSGroupAtomAdd(n,e[o]));if(s.addOp(new ui.Action.OpSGroupAddToHierarchy(n)),s=s.perform(),"SRU"==t){ui.render.sGroupsFindCrossBonds();var a=new ui.Action;ui.render.sGroupGetNeighborAtoms(n).each(function(t){1==ui.render.atomGetDegree(t)&&ui.render.atomIsPlainCarbon(t)&&a.addOp(new ui.Action.OpAtomAttr(t,"label","*"))},this),a=a.perform(),a.mergeWith(s),s=a}return ui.Action.fromSgroupAttrs(n,i).mergeWith(s)},ui.Action.fromRGroupAttrs=function(t,e){var i=new ui.Action;return new Hash(e).each(function(e){i.addOp(new ui.Action.OpRGroupAttr(t,e.key,e.value))},this),i.perform()},ui.Action.fromRGroupFragment=function(t,e){var i=new ui.Action;return i.addOp(new ui.Action.OpRGroupFragment(t,e)),i.perform()},ui.Action.fromPaste=function(t,e){e=e||new util.Vec2;for(var i=new ui.Action,n={},r={},o=0;o<t.atoms.length;o++){var s=Object.clone(t.atoms[o]);s.fragment in r||(r[s.fragment]=i.addOp((new ui.Action.OpFragmentAdd).perform(ui.editor)).frid),s.fragment=r[s.fragment],n[o]=i.addOp(new ui.Action.OpAtomAdd(s,s.pp.add(e)).perform(ui.editor)).data.aid}var a=[];for(var l in ui.clipboard.rgroups)ui.ctab.rgroups.has(l)||a.push(l);for(var u in ui.clipboard.rgmap)i.addOp(new ui.Action.OpRGroupFragment(ui.clipboard.rgmap[u],r[u]).perform(ui.editor));for(var c=0;c<a.length;++c)i.mergeWith(ui.Action.fromRGroupAttrs(a[c],ui.clipboard.rgroups[a[c]]));for(var h=0;h<t.bonds.length;h++){var d=Object.clone(t.bonds[h]);i.addOp(new ui.Action.OpBondAdd(n[d.begin],n[d.end],d).perform(ui.editor))}for(var p=0;p<t.sgroups.length;p++){for(var f=t.sgroups[p],m=f.atoms,g=[],b=0;b<m.length;b++)g.push(n[m[b]]);for(var v=ui.render.ctab.molecule.sgroups.newId(),y=ui.Action.fromSgroupAddition(f.type,g,f.attrs,v,f.pp?f.pp.add(e):null),w=y.operations.length-1;w>=0;w--)i.addOp(y.operations[w])}if(ui.editor.render.ctab.rxnArrows.count()<1)for(var S=0;S<t.rxnArrows.length;S++)i.addOp(new ui.Action.OpRxnArrowAdd(t.rxnArrows[S].pp.add(e)).perform(ui.editor));for(var x=0;x<t.rxnPluses.length;x++)i.addOp(new ui.Action.OpRxnPlusAdd(t.rxnPluses[x].pp.add(e)).perform(ui.editor));return i.operations.reverse(),i},ui.Action.fromFlip=function(t,e){var i,n=ui.render,r=n.ctab,o=r.molecule,s=new ui.Action,a={};if(t.atoms){for(i=0;i<t.atoms.length;i++){var l=t.atoms[i],u=o.atoms.get(l);u.fragment in a?a[u.fragment].push(l):a[u.fragment]=[l]}if(a=new Hash(a),a.detect(function(t){return!util.Set.eq(o.getFragmentIds(t[0]),util.Set.fromList(t[1]))}))return s;if(a.each(function(t){var i=util.Set.fromList(t[1]),n=o.getCoordBoundingBox(i);util.Set.each(i,function(t){var i=o.atoms.get(t),r=new util.Vec2;"horizontal"==e?r.x=n.min.x+n.max.x-2*i.pp.x:r.y=n.min.y+n.max.y-2*i.pp.y,s.addOp(new ui.Action.OpAtomMove(t,r))})}),t.bonds)for(i=0;i<t.bonds.length;i++){var c=t.bonds[i],h=o.bonds.get(c);h.type==chem.Struct.BOND.TYPE.SINGLE&&(h.stereo==chem.Struct.BOND.STEREO.UP?s.addOp(new ui.Action.OpBondAttr(c,"stereo",chem.Struct.BOND.STEREO.DOWN)):h.stereo==chem.Struct.BOND.STEREO.DOWN&&s.addOp(new ui.Action.OpBondAttr(c,"stereo",chem.Struct.BOND.STEREO.UP)))}}return s.perform()},ui.Action.fromRotate=function(t,e,i){function n(t){var n=t.sub(e);return n=n.rotate(i),n.add_(e),n.sub(t)}var r=ui.render,o=r.ctab,s=o.molecule,a=new ui.Action;return t.atoms&&t.atoms.each(function(t){var e=s.atoms.get(t);a.addOp(new ui.Action.OpAtomMove(t,n(e.pp)))}),t.rxnArrows&&t.rxnArrows.each(function(t){var e=s.rxnArrows.get(t);a.addOp(new ui.Action.OpRxnArrowMove(t,n(e.pp)))}),t.rxnPluses&&t.rxnPluses.each(function(t){var e=s.rxnPluses.get(t);a.addOp(new ui.Action.OpRxnPlusMove(t,n(e.pp)))}),t.sgroupData&&t.sgroupData.each(function(t){var e=s.sgroups.get(t);a.addOp(new ui.Action.OpSGroupDataMove(t,n(e.pp)))}),t.chiralFlags&&t.chiralFlags.each(function(t){var e=s.chiralFlags.get(t);a.addOp(new ui.Action.OpChiralFlagMove(t,n(e.pp)))}),a.perform()},ui.addUndoAction=function(t,e){null!=t&&(1==e&&t.isDummy()||(ui.undoStack.push(t),ui.redoStack.clear(),ui.undoStack.length>ui.HISTORY_LENGTH&&ui.undoStack.splice(0,1),ui.updateActionButtons(),ui.actionComplete()))},ui.removeDummyAction=function(){0!=ui.undoStack.length&&ui.undoStack.last().isDummy()&&(ui.undoStack.pop(),ui.updateActionButtons())},ui.updateActionButtons=function(){0==ui.undoStack.length?$("undo").addClassName("buttonDisabled"):$("undo").removeClassName("buttonDisabled"),0==ui.redoStack.length?$("redo").addClassName("buttonDisabled"):$("redo").removeClassName("buttonDisabled")},ui.undo=function(){this.render.current_tool&&this.render.current_tool.OnCancel(),ui.editor.deselectAll(),ui.redoStack.push(ui.undoStack.pop().perform()),ui.render.update(),ui.updateActionButtons(),ui.actionComplete()},ui.redo=function(){this.render.current_tool&&this.render.current_tool.OnCancel(),ui.editor.deselectAll(),ui.undoStack.push(ui.redoStack.pop().perform()),ui.render.update(),ui.updateActionButtons(),ui.actionComplete()},ui.Action.OpBase=function(){},ui.Action.OpBase.prototype.type="OpBase",ui.Action.OpBase.prototype._execute=function(){throw new Error("Operation._execute() is not implemented")},ui.Action.OpBase.prototype._invert=function(){throw new Error("Operation._invert() is not implemented")},ui.Action.OpBase.prototype.perform=function(t){return this._execute(t),"__inverted"in this||(this.__inverted=this._invert(),this.__inverted.__inverted=this),this.__inverted},ui.Action.OpBase.prototype.isDummy=function(t){return"_isDummy"in this?this._isDummy(t):!1},ui.Action.OpAtomAdd=function(t,e){this.data={aid:null,atom:t,pos:e},this._execute=function(t){var e=t.render,i=e.ctab,n=i.molecule,r={};if(this.data.atom)for(var o in this.data.atom)r[o]=this.data.atom[o];r.label=r.label||"C",Object.isNumber(this.data.aid)?n.atoms.set(this.data.aid,new chem.Struct.Atom(r)):this.data.aid=n.atoms.add(new chem.Struct.Atom(r)),i.notifyAtomAdded(this.data.aid),n._atomSetPos(this.data.aid,new util.Vec2(this.data.pos))},this._invert=function(){var t=new ui.Action.OpAtomDelete;return t.data=this.data,t}},ui.Action.OpAtomAdd.prototype=new ui.Action.OpBase,ui.Action.OpAtomDelete=function(t){this.data={aid:t,atom:null,pos:null},this._execute=function(t){var e=t.render,i=e.ctab,n=i.molecule;this.data.atom||(this.data.atom=n.atoms.get(this.data.aid),this.data.pos=e.atomGetPos(this.data.aid)),i.notifyAtomRemoved(this.data.aid),n.atoms.remove(this.data.aid)},this._invert=function(){var t=new ui.Action.OpAtomAdd;return t.data=this.data,t}},ui.Action.OpAtomDelete.prototype=new ui.Action.OpBase,ui.Action.OpAtomAttr=function(t,e,i){this.data={aid:t,attribute:e,value:i},this.data2=null,this._execute=function(t){var e=t.render.ctab.molecule.atoms.get(this.data.aid);this.data2||(this.data2={aid:this.data.aid,attribute:this.data.attribute,value:e[this.data.attribute]}),e[this.data.attribute]=this.data.value,t.render.invalidateAtom(this.data.aid)},this._isDummy=function(t){return t.render.ctab.molecule.atoms.get(this.data.aid)[this.data.attribute]==this.data.value},this._invert=function(){var t=new ui.Action.OpAtomAttr;return t.data=this.data2,t.data2=this.data,t}},ui.Action.OpAtomAttr.prototype=new ui.Action.OpBase,ui.Action.OpAtomMove=function(t,e,i){this.data={aid:t,d:e,noinvalidate:i},this._execute=function(t){var e=t.render,i=e.ctab,n=i.molecule,r=this.data.aid,o=this.data.d;n.atoms.get(r).pp.add_(o),i.atoms.get(r).visel.translate(e.ps(o)),this.data.d=o.negated(),this.data.noinvalidate||e.invalidateAtom(r,1)},this._isDummy=function(t){return 0==this.data.d.x&&0==this.data.d.y},this._invert=function(){var t=new ui.Action.OpAtomMove;return t.data=this.data,t}},ui.Action.OpAtomMove.prototype=new ui.Action.OpBase,ui.Action.OpBondMove=function(t,e){this.data={bid:t,d:e},this._execute=function(t){var e=t.render,i=e.ctab;i.bonds.get(this.data.bid).visel.translate(e.ps(this.data.d)),this.data.d=this.data.d.negated()},this._invert=function(){var t=new ui.Action.OpBondMove;return t.data=this.data,t}},ui.Action.OpBondMove.prototype=new ui.Action.OpBase,ui.Action.OpLoopMove=function(t,e){this.data={id:t,d:e},this._execute=function(t){var e=t.render,i=e.ctab;i.reloops.get(this.data.id)&&i.reloops.get(this.data.id).visel&&i.reloops.get(this.data.id).visel.translate(e.ps(this.data.d)),this.data.d=this.data.d.negated()},this._invert=function(){var t=new ui.Action.OpLoopMove;return t.data=this.data,t}},ui.Action.OpLoopMove.prototype=new ui.Action.OpBase,ui.Action.OpSGroupAtomAdd=function(t,e){this.type="OpSGroupAtomAdd",this.data={aid:e,sgid:t},this._execute=function(t){var e=t.render,i=e.ctab,n=i.molecule,r=this.data.aid,o=this.data.sgid,s=n.atoms.get(r),a=n.sgroups.get(o);if(a.atoms.indexOf(r)>=0)throw new Error("The same atom cannot be added to an S-group more than once");if(!s)throw new Error("OpSGroupAtomAdd: Atom "+r+" not found");n.atomAddToSGroup(o,r),e.invalidateAtom(r)},this._invert=function(){var t=new ui.Action.OpSGroupAtomRemove;return t.data=this.data,t}},ui.Action.OpSGroupAtomAdd.prototype=new ui.Action.OpBase,ui.Action.OpSGroupAtomRemove=function(t,e){this.type="OpSGroupAtomRemove",this.data={aid:e,sgid:t},this._execute=function(t){var e=this.data.aid,i=this.data.sgid,n=t.render,r=n.ctab,o=r.molecule,s=o.atoms.get(e),a=o.sgroups.get(i);chem.SGroup.removeAtom(a,e),util.Set.remove(s.sgs,i),n.invalidateAtom(e)},this._invert=function(){var t=new ui.Action.OpSGroupAtomAdd;return t.data=this.data,t}},ui.Action.OpSGroupAtomRemove.prototype=new ui.Action.OpBase,ui.Action.OpSGroupAttr=function(t,e,i){this.type="OpSGroupAttr",this.data={sgid:t,attr:e,value:i},this._execute=function(t){var e=t.render,i=e.ctab,n=i.molecule,r=this.data.sgid,o=n.sgroups.get(r);"DAT"==o.type&&i.sgroupData.has(r)&&(i.clearVisel(i.sgroupData.get(r).visel),i.sgroupData.unset(r)),this.data.value=o.setAttr(this.data.attr,this.data.value)},this._invert=function(){var t=new ui.Action.OpSGroupAttr;return t.data=this.data,t}},ui.Action.OpSGroupAttr.prototype=new ui.Action.OpBase,ui.Action.OpSGroupCreate=function(t,e,i){this.type="OpSGroupCreate",this.data={sgid:t,type:e,pp:i},this._execute=function(t){var e=t.render,i=e.ctab,n=i.molecule,r=new chem.SGroup(this.data.type),o=this.data.sgid;r.id=o,n.sgroups.set(o,r),this.data.pp&&(n.sgroups.get(o).pp=new util.Vec2(this.data.pp)),i.sgroups.set(o,new rnd.ReSGroup(n.sgroups.get(o))),this.data.sgid=o},this._invert=function(){var t=new ui.Action.OpSGroupDelete;return t.data=this.data,t}},ui.Action.OpSGroupCreate.prototype=new ui.Action.OpBase,ui.Action.OpSGroupDelete=function(t){this.type="OpSGroupDelete",this.data={sgid:t},this._execute=function(t){var e=t.render,i=e.ctab,n=i.molecule,r=this.data.sgid,o=i.sgroups.get(r);if(this.data.type=o.item.type,this.data.pp=o.item.pp,"DAT"==o.item.type&&i.sgroupData.has(r)&&(i.clearVisel(i.sgroupData.get(r).visel),i.sgroupData.unset(r)),i.clearVisel(o.visel),0!=o.item.atoms.length)throw new Error("S-Group not empty!");i.sgroups.unset(r),n.sgroups.remove(r)},this._invert=function(){var t=new ui.Action.OpSGroupCreate;return t.data=this.data,t}},ui.Action.OpSGroupDelete.prototype=new ui.Action.OpBase,ui.Action.OpSGroupAddToHierarchy=function(t){this.type="OpSGroupAddToHierarchy",this.data={sgid:t},this._execute=function(t){var e=t.render,i=e.ctab,n=i.molecule,r=this.data.sgid,o=n.sGroupForest.insert(r,this.data.parent,this.data.children);this.data.parent=o.parent,this.data.children=o.children},this._invert=function(){var t=new ui.Action.OpSGroupRemoveFromHierarchy;return t.data=this.data,t}},ui.Action.OpSGroupAddToHierarchy.prototype=new ui.Action.OpBase,ui.Action.OpSGroupRemoveFromHierarchy=function(t){this.type="OpSGroupRemoveFromHierarchy",this.data={sgid:t},this._execute=function(t){var e=t.render,i=e.ctab,n=i.molecule,r=this.data.sgid;this.data.parent=n.sGroupForest.parent.get(r),this.data.children=n.sGroupForest.children.get(r),n.sGroupForest.remove(r)},this._invert=function(){var t=new ui.Action.OpSGroupAddToHierarchy;return t.data=this.data,t}},ui.Action.OpSGroupRemoveFromHierarchy.prototype=new ui.Action.OpBase,ui.Action.OpBondAdd=function(t,e,i){this.data={bid:null,bond:i,begin:t,end:e},this._execute=function(t){var e=t.render,i=e.ctab,n=i.molecule;if(this.data.begin==this.data.end)throw new Error("Distinct atoms expected");if(rnd.DEBUG&&this.molecule.checkBondExists(this.data.begin,this.data.end))throw new Error("Bond already exists");e.invalidateAtom(this.data.begin,1),e.invalidateAtom(this.data.end,1);var r={};if(this.data.bond)for(var o in this.data.bond)r[o]=this.data.bond[o];r.type=r.type||chem.Struct.BOND.TYPE.SINGLE,r.begin=this.data.begin,r.end=this.data.end,Object.isNumber(this.data.bid)?n.bonds.set(this.data.bid,new chem.Struct.Bond(r)):this.data.bid=n.bonds.add(new chem.Struct.Bond(r)),n.bondInitHalfBonds(this.data.bid),n.atomAddNeighbor(n.bonds.get(this.data.bid).hb1),n.atomAddNeighbor(n.bonds.get(this.data.bid).hb2),i.notifyBondAdded(this.data.bid)},this._invert=function(){var t=new ui.Action.OpBondDelete;return t.data=this.data,t}},ui.Action.OpBondAdd.prototype=new ui.Action.OpBase,ui.Action.OpBondDelete=function(t){this.data={bid:t,bond:null,begin:null,end:null},this._execute=function(t){var e=t.render,i=e.ctab,n=i.molecule;this.data.bond||(this.data.bond=n.bonds.get(this.data.bid),this.data.begin=this.data.bond.begin,this.data.end=this.data.bond.end),e.invalidateBond(this.data.bid),i.notifyBondRemoved(this.data.bid);var r=n.bonds.get(this.data.bid);[r.hb1,r.hb2].each(function(t){var e=n.halfBonds.get(t),i=n.atoms.get(e.begin),r=i.neighbors.indexOf(t),o=(r+i.neighbors.length-1)%i.neighbors.length,s=(r+1)%i.neighbors.length;n.setHbNext(i.neighbors[o],i.neighbors[s]),i.neighbors.splice(r,1)},this),n.halfBonds.unset(r.hb1),n.halfBonds.unset(r.hb2),n.bonds.remove(this.data.bid)},this._invert=function(){var t=new ui.Action.OpBondAdd;return t.data=this.data,t}},ui.Action.OpBondDelete.prototype=new ui.Action.OpBase,ui.Action.OpBondAttr=function(t,e,i){this.data={bid:t,attribute:e,value:i},this.data2=null,this._execute=function(t){var e=t.render.ctab.molecule.bonds.get(this.data.bid);this.data2||(this.data2={bid:this.data.bid,attribute:this.data.attribute,value:e[this.data.attribute]}),e[this.data.attribute]=this.data.value,t.render.invalidateBond(this.data.bid),"type"==this.data.attribute&&t.render.invalidateLoop(this.data.bid)},this._isDummy=function(t){return t.render.ctab.molecule.bonds.get(this.data.bid)[this.data.attribute]==this.data.value},this._invert=function(){var t=new ui.Action.OpBondAttr;return t.data=this.data2,t.data2=this.data,t}},ui.Action.OpBondAttr.prototype=new ui.Action.OpBase,ui.Action.OpFragmentAdd=function(t){this.frid=Object.isUndefined(t)?null:t,this._execute=function(t){var e=t.render.ctab,i=e.molecule,n=new chem.Struct.Fragment;null==this.frid?this.frid=i.frags.add(n):i.frags.set(this.frid,n),e.frags.set(this.frid,new rnd.ReFrag(n))},this._invert=function(){return new ui.Action.OpFragmentDelete(this.frid)}},ui.Action.OpFragmentAdd.prototype=new ui.Action.OpBase,ui.Action.OpFragmentDelete=function(t){this.frid=t,this._execute=function(t){var e=t.render,i=e.ctab,n=i.molecule;e.invalidateItem("frags",this.frid,1),i.frags.unset(this.frid),n.frags.remove(this.frid)},this._invert=function(){return new ui.Action.OpFragmentAdd(this.frid)}},ui.Action.OpFragmentDelete.prototype=new ui.Action.OpBase,ui.Action.OpRGroupAttr=function(t,e,i){this.data={rgid:t,attribute:e,value:i},this.data2=null,this._execute=function(t){var e=t.render.ctab.molecule.rgroups.get(this.data.rgid);this.data2||(this.data2={rgid:this.data.rgid,attribute:this.data.attribute,value:e[this.data.attribute]}),e[this.data.attribute]=this.data.value,t.render.invalidateItem("rgroups",this.data.rgid)},this._isDummy=function(t){return t.render.ctab.molecule.rgroups.get(this.data.rgid)[this.data.attribute]==this.data.value},this._invert=function(){var t=new ui.Action.OpRGroupAttr;return t.data=this.data2,t.data2=this.data,t}},ui.Action.OpRGroupAttr.prototype=new ui.Action.OpBase,ui.Action.OpRGroupFragment=function(t,e,i){this.rgid_new=t,this.rg_new=i,this.rgid_old=null,this.rg_old=null,this.frid=e,this._execute=function(t){var e=t.render.ctab,i=e.molecule;if(this.rgid_old=this.rgid_old||chem.Struct.RGroup.findRGroupByFragment(i.rgroups,this.frid),this.rg_old=this.rgid_old?i.rgroups.get(this.rgid_old):null,this.rg_old&&(this.rg_old.frags.remove(this.rg_old.frags.keyOf(this.frid)),e.clearVisel(e.rgroups.get(this.rgid_old).visel),0==this.rg_old.frags.count()?(e.rgroups.unset(this.rgid_old),i.rgroups.unset(this.rgid_old),e.markItemRemoved()):e.markItem("rgroups",this.rgid_old,1)),this.rgid_new){var n=i.rgroups.get(this.rgid_new);n?e.markItem("rgroups",this.rgid_new,1):(n=this.rg_new||new chem.Struct.RGroup,i.rgroups.set(this.rgid_new,n),e.rgroups.set(this.rgid_new,new rnd.ReRGroup(n))),n.frags.add(this.frid)}},this._invert=function(){return new ui.Action.OpRGroupFragment(this.rgid_old,this.frid,this.rg_old)}},ui.Action.OpRGroupFragment.prototype=new ui.Action.OpBase,ui.Action.OpRxnArrowAdd=function(t){this.data={arid:null,pos:t},this._execute=function(t){var e=t.render,i=e.ctab,n=i.molecule;Object.isNumber(this.data.arid)?n.rxnArrows.set(this.data.arid,new chem.Struct.RxnArrow):this.data.arid=n.rxnArrows.add(new chem.Struct.RxnArrow),i.notifyRxnArrowAdded(this.data.arid),n._rxnArrowSetPos(this.data.arid,new util.Vec2(this.data.pos)),e.invalidateItem("rxnArrows",this.data.arid,1)},this._invert=function(){var t=new ui.Action.OpRxnArrowDelete;return t.data=this.data,t}},ui.Action.OpRxnArrowAdd.prototype=new ui.Action.OpBase,ui.Action.OpRxnArrowDelete=function(t){this.data={arid:t,pos:null},this._execute=function(t){var e=t.render,i=e.ctab,n=i.molecule;this.data.pos||(this.data.pos=e.rxnArrowGetPos(this.data.arid)),i.notifyRxnArrowRemoved(this.data.arid),n.rxnArrows.remove(this.data.arid)},this._invert=function(){var t=new ui.Action.OpRxnArrowAdd;return t.data=this.data,t}},ui.Action.OpRxnArrowDelete.prototype=new ui.Action.OpBase,ui.Action.OpRxnArrowMove=function(t,e,i){this.data={id:t,d:e,noinvalidate:i},this._execute=function(t){var e=t.render,i=e.ctab,n=i.molecule,r=this.data.id,o=this.data.d;n.rxnArrows.get(r).pp.add_(o),i.rxnArrows.get(r).visel.translate(e.ps(o)),this.data.d=o.negated(),this.data.noinvalidate||t.render.invalidateItem("rxnArrows",r,1)},this._invert=function(){var t=new ui.Action.OpRxnArrowMove;return t.data=this.data,t}},ui.Action.OpRxnArrowMove.prototype=new ui.Action.OpBase,ui.Action.OpRxnPlusAdd=function(t){this.data={plid:null,pos:t},this._execute=function(t){var e=t.render,i=e.ctab,n=i.molecule;Object.isNumber(this.data.plid)?n.rxnPluses.set(this.data.plid,new chem.Struct.RxnPlus):this.data.plid=n.rxnPluses.add(new chem.Struct.RxnPlus),i.notifyRxnPlusAdded(this.data.plid),n._rxnPlusSetPos(this.data.plid,new util.Vec2(this.data.pos)),e.invalidateItem("rxnPluses",this.data.plid,1)},this._invert=function(){var t=new ui.Action.OpRxnPlusDelete;return t.data=this.data,t}},ui.Action.OpRxnPlusAdd.prototype=new ui.Action.OpBase,ui.Action.OpRxnPlusDelete=function(t){this.data={plid:t,pos:null},this._execute=function(t){var e=t.render,i=e.ctab,n=i.molecule;this.data.pos||(this.data.pos=e.rxnPlusGetPos(this.data.plid)),i.notifyRxnPlusRemoved(this.data.plid),n.rxnPluses.remove(this.data.plid)},this._invert=function(){var t=new ui.Action.OpRxnPlusAdd;return t.data=this.data,t}},ui.Action.OpRxnPlusDelete.prototype=new ui.Action.OpBase,ui.Action.OpRxnPlusMove=function(t,e,i){this.data={id:t,d:e,noinvalidate:i},this._execute=function(t){var e=t.render,i=e.ctab,n=i.molecule,r=this.data.id,o=this.data.d;n.rxnPluses.get(r).pp.add_(o),i.rxnPluses.get(r).visel.translate(e.ps(o)),this.data.d=o.negated(),this.data.noinvalidate||t.render.invalidateItem("rxnPluses",r,1)},this._invert=function(){var t=new ui.Action.OpRxnPlusMove;return t.data=this.data,t}},ui.Action.OpRxnPlusMove.prototype=new ui.Action.OpBase,ui.Action.OpSGroupDataMove=function(t,e){this.data={id:t,d:e},this._execute=function(t){ui.ctab.sgroups.get(this.data.id).pp.add_(this.data.d),this.data.d=this.data.d.negated(),t.render.invalidateItem("sgroupData",this.data.id,1)},this._invert=function(){var t=new ui.Action.OpSGroupDataMove;return t.data=this.data,t}},ui.Action.OpSGroupDataMove.prototype=new ui.Action.OpBase,ui.Action.OpCanvasLoad=function(t){this.data={ctab:t,norescale:!1},this._execute=function(t){var e=t.render;e.ctab.clearVisels();var i=ui.ctab;ui.ctab=this.data.ctab,e.setMolecule(ui.ctab,this.data.norescale),this.data.ctab=i,this.data.norescale=!0},this._invert=function(){var t=new ui.Action.OpCanvasLoad;return t.data=this.data,t}},ui.Action.OpCanvasLoad.prototype=new ui.Action.OpBase,ui.Action.OpChiralFlagAdd=function(t){this.data={pos:t},this._execute=function(e){var i=e.render,n=i.ctab,r=n.molecule;if(n.chiralFlags.count()>0)throw new Error("Cannot add more than one Chiral flag");n.chiralFlags.set(0,new rnd.ReChiralFlag(t)),r.isChiral=!0,i.invalidateItem("chiralFlags",0,1)},this._invert=function(){var t=new ui.Action.OpChiralFlagDelete;return t.data=this.data,t}},ui.Action.OpChiralFlagAdd.prototype=new ui.Action.OpBase,ui.Action.OpChiralFlagDelete=function(){this.data={pos:null},this._execute=function(t){var e=t.render,i=e.ctab,n=i.molecule;if(i.chiralFlags.count()<1)throw new Error("Cannot remove chiral flag");i.clearVisel(i.chiralFlags.get(0).visel),this.data.pos=i.chiralFlags.get(0).pp,i.chiralFlags.unset(0),n.isChiral=!1},this._invert=function(){var t=new ui.Action.OpChiralFlagAdd(this.data.pos);return t.data=this.data,t}},ui.Action.OpChiralFlagDelete.prototype=new ui.Action.OpBase,ui.Action.OpChiralFlagMove=function(t){this.data={d:t},this._execute=function(t){var e=t.render,i=e.ctab;i.chiralFlags.get(0).pp.add_(this.data.d),this.data.d=this.data.d.negated(),e.invalidateItem("chiralFlags",0,1)},this._invert=function(){var t=new ui.Action.OpChiralFlagMove;return t.data=this.data,t}},ui.Action.OpChiralFlagMove.prototype=new ui.Action.OpBase,!window.Prototype)throw new Error("Prototype.js should be loaded first");if(!window.rnd)throw new Error("rnd should be defined prior to loading this file");if(!window.ui)throw new Error("ui should be defined prior to loading this file");rnd.ReaGenericsTable=function(t,e){e=e||{},t=$(t),t.style.width="610px",t.style.height="390px",t.innerHTML="",this.onClick=function(t){this.setSelection(t)},this.elemHalfSz=new util.Vec2(22,14),this.elemSz=this.elemHalfSz.scaled(2),this.spacing=new util.Vec2(3,3),this.cornerRadius=2,this.orig=this.elemSz.scaled(0),this.viewSz=new util.Vec2(t.clientWidth||100,t.clientHeight||100),this.paper=new Raphael(t,this.viewSz.x,this.viewSz.y),this.bb=new util.Box2Abs(new util.Vec2,this.viewSz),this.bgColor=t.getStyle("background-color"),this.fillColor=e.fillColor||"#def",this.fillColorSelected=e.fillColorSelected||"#fcb",this.frameColor=e.frameColor||"#9ad",this.frameThickness=e.frameThickness||"1pt",this.fontSize=e.fontSize||18,this.fontType=e.fontType||"Arial",this.atomProps=null,this.frameAttrs={fill:this.fillColor,stroke:this.frameColor,"stroke-width":this.frameThickness},this.fontAttrs={"font-family":this.fontType,"font-size":this.fontSize},this.groupRectAttrs={stroke:"lightgray","stroke-width":"1px"},this.labelTextAttrs={"font-family":"Arial","font-size":13,fill:"gray"},this.labelRectAttrs={fill:this.bgColor,stroke:this.bgColor},this.items=[];var i=function(t,e,i,n,r,o){o=o||"start",this.paper.rect(t,e,i,n,this.cornerRadius).attr(this.groupRectAttrs);var s=this.paper.text("left"==o?t+10:"right"==o?t+i-10:t+i/2,e,r).attr(this.labelTextAttrs).attr("text-anchor","left"==o?"start":"right"==o?"end":"middle");this.paper.rect().attr(s.getBBox()).attr(this.labelRectAttrs),s.toFront()},n=function(t,e,i,n){this.paper.text(t,e,i).attr(this.labelTextAttrs).attr("text-anchor","left"==n?"start":"right"==n?"end":"middle")},r=function(t,e){var i=this.paper.rect(t.x-this.elemHalfSz.x,t.y-this.elemHalfSz.y,this.elemSz.x,this.elemSz.y,this.cornerRadius).attr(this.frameAttrs),n=this.paper.text(t.x,t.y,e).attr(this.fontAttrs),r=this;i.node.onclick=function(){r.onClick(e)},n.node.onclick=function(){r.onClick(e)},this.items.push({text:e,box:i,label:n})},o=this.spacing.x+this.elemSz.x;i.apply(this,[5,5,600,75,"Atom Generics","left"]),r.apply(this,[new util.Vec2(57,30),"A"]),
r.apply(this,[new util.Vec2(57+o,30),"AH"]),n.apply(this,[81,60,"any atom\n	"]),r.apply(this,[new util.Vec2(207,30),"Q"]),r.apply(this,[new util.Vec2(207+o,30),"QH"]),n.apply(this,[231,60,"any atom except\ncarbon or hydrogen"]),r.apply(this,[new util.Vec2(357,30),"M"]),r.apply(this,[new util.Vec2(357+o,30),"MH"]),n.apply(this,[381,60,"any metal\n	"]),r.apply(this,[new util.Vec2(507,30),"X"]),r.apply(this,[new util.Vec2(507+o,30),"XH"]),n.apply(this,[531,60,"any halogen\n	"]),i.apply(this,[5,90,600,300,"Group Generics","left"]),n.apply(this,[210,115,"any","right"]),r.apply(this,[new util.Vec2(286-o,115),"G"]),r.apply(this,[new util.Vec2(286,115),"GH"]),r.apply(this,[new util.Vec2(286+o,115),"G*"]),r.apply(this,[new util.Vec2(286+2*o,115),"GH*"]),i.apply(this,[10,140,235,245,"ACYCLIC"]),n.apply(this,[74,165,"acyclic","right"]),r.apply(this,[new util.Vec2(104,165),"ACY"]),r.apply(this,[new util.Vec2(104+o,165),"ACH"]),i.apply(this,[15,190,110,190,"CARB"]),r.apply(this,[new util.Vec2(46,215),"ABC"]),r.apply(this,[new util.Vec2(46+o,215),"ABH"]),n.apply(this,[68,235,"carb"]),r.apply(this,[new util.Vec2(46,260),"AYL"]),r.apply(this,[new util.Vec2(46+o,260),"AYH"]),n.apply(this,[68,280,"alkynyl"]),r.apply(this,[new util.Vec2(46,305),"ALK"]),r.apply(this,[new util.Vec2(46+o,305),"ALH"]),n.apply(this,[68,325,"alkyl"]),r.apply(this,[new util.Vec2(46,350),"AEL"]),r.apply(this,[new util.Vec2(46+o,350),"AEH"]),n.apply(this,[68,370,"alkenyl"]),i.apply(this,[130,190,110,190,"HETERO"]),r.apply(this,[new util.Vec2(161,215),"AHC"]),r.apply(this,[new util.Vec2(161+o,215),"AHH"]),n.apply(this,[183,235,"hetero"]),r.apply(this,[new util.Vec2(161,260),"AOX"]),r.apply(this,[new util.Vec2(161+o,260),"AOH"]),n.apply(this,[183,280,"alkoxy"]),i.apply(this,[250,140,350,245,"CYCLIC"]),n.apply(this,[371,165,"cyclic","right"]),r.apply(this,[new util.Vec2(401,165),"CYC"]),r.apply(this,[new util.Vec2(401+o,165),"CYH"]),i.apply(this,[255,190,110,190,"CARBO"]),r.apply(this,[new util.Vec2(286,215),"CBC"]),r.apply(this,[new util.Vec2(286+o,215),"CBH"]),n.apply(this,[308,235,"carbo"]),r.apply(this,[new util.Vec2(286,260),"ARY"]),r.apply(this,[new util.Vec2(286+o,260),"ARH"]),n.apply(this,[308,280,"aryl"]),r.apply(this,[new util.Vec2(286,305),"CAL"]),r.apply(this,[new util.Vec2(286+o,305),"CAH"]),n.apply(this,[308,325,"cycloalkyl"]),r.apply(this,[new util.Vec2(286,350),"CEL"]),r.apply(this,[new util.Vec2(286+o,350),"CEH"]),n.apply(this,[308,370,"cycloalkenyl"]),i.apply(this,[370,190,110,190,"HETERO"]),r.apply(this,[new util.Vec2(401,215),"CHC"]),r.apply(this,[new util.Vec2(401+o,215),"CHH"]),n.apply(this,[423,235,"hetero"]),r.apply(this,[new util.Vec2(401,260),"HAR"]),r.apply(this,[new util.Vec2(401+o,260),"HAH"]),n.apply(this,[423,280,"hetero aryl"]),i.apply(this,[485,190,110,190,"CYCLIC"]),r.apply(this,[new util.Vec2(516,215),"CXX"]),r.apply(this,[new util.Vec2(516+o,215),"CXH"]),n.apply(this,[538,235,"no carbon"])},rnd.ReaGenericsTable.prototype.getAtomProps=function(){return this.atomProps},rnd.ReaGenericsTable.prototype.setSelection=function(t){this.atomProps={label:t};for(var e=0;e<this.items.length;e++)this.items[e].box.attr("fill",this.items[e].text==t?this.fillColorSelected:this.fillColor);$("reagenerics_table_ok").disabled=!t||""==t},ui.showReaGenericsTable=function(t){if(!$("reagenerics_table").visible()){t=t||{},ui.showDialog("reagenerics_table"),"undefined"==typeof ui.reagenerics_table_obj&&(ui.reagenerics_table_obj=new rnd.ReaGenericsTable("reagenerics_table_area",{fillColor:"#DADADA",fillColorSelected:"#FFFFFF",frameColor:"#E8E8E8",fontSize:18,buttonHalfSize:18},!0)),t.selection&&ui.reagenerics_table_obj.setSelection(t.selection);var e=new Event.Handler("reagenerics_table_ok","click",void 0,function(){t&&"onOk"in t&&!t.onOk(ui.reagenerics_table_obj.getAtomProps())||(e.stop(),i.stop(),ui.hideDialog("reagenerics_table"))}).start(),i=new Event.Handler("reagenerics_table_cancel","click",void 0,function(){e.stop(),i.stop(),ui.hideDialog("reagenerics_table"),t&&"onCancel"in t&&t.onCancel()}).start();$($("reagenerics_table_ok").disabled?"reagenerics_table_cancel":"reagenerics_table_ok").focus()}},ui.onClick_ReaGenericsTableButton=function(){this.hasClassName("buttonDisabled")||ui.showReaGenericsTable({onOk:function(){return ui.selectMode("atom_reagenerics"),!0}})},ketcher=function(){this.render=null},ketcher.version="1.1-beta",ketcher.init=function(t,e){document.title+=" v"+ketcher.version,ketcher.button_areas={};var i={fontSize:25};ketcher.button_areas.atom_h=new rnd.ElementTable("atom_h",i).renderSingle("H"),ketcher.button_areas.atom_c=new rnd.ElementTable("atom_c",i).renderSingle("C"),ketcher.button_areas.atom_n=new rnd.ElementTable("atom_n",i).renderSingle("N"),ketcher.button_areas.atom_o=new rnd.ElementTable("atom_o",i).renderSingle("O"),ketcher.button_areas.atom_s=new rnd.ElementTable("atom_s",i).renderSingle("S"),ketcher.button_areas.atom_p=new rnd.ElementTable("atom_p",i).renderSingle("P"),ketcher.button_areas.atom_f=new rnd.ElementTable("atom_f",i).renderSingle("F"),ketcher.button_areas.atom_cl=new rnd.ElementTable("atom_cl",i).renderSingle("Cl"),ketcher.button_areas.atom_br=new rnd.ElementTable("atom_br",i).renderSingle("Br"),ketcher.button_areas.atom_i=new rnd.ElementTable("atom_i",i).renderSingle("I"),ketcher.button_areas.atom_table=new rnd.ElementTable("atom_table",i).renderSingle("..."),ketcher.button_areas.atom_any=new rnd.ElementTable("atom_reagenerics",{fontSize:9}).renderSingle("Generic\nGroups"),ui.init(t,e),$("ketcher_version").innerHTML="Version "+ketcher.version},ketcher.getSmiles=function(){var t=new chem.SmilesSaver;return t.saveMolecule(ui.ctab,!0)},ketcher.getMolfile=function(){var t=new chem.MolfileSaver;return t.saveMolecule(ui.ctab,!0)},ketcher.setMolecule=function(t){Object.isString(t)&&ui.loadMolecule(t)},ketcher.addFragment=function(t){Object.isString(t)&&ui.loadMolecule(t,void 0,void 0,!0)},ketcher.showMolfile=function(t,e,i,n){return ketcher.showMolfileOpts(t,e,75,{showSelectionRegions:!1,showBondIds:!1,showHalfBondIds:!1,showLoopIds:!1,showAtomIds:!1,autoScale:i||!1,autoScaleMargin:4,hideImplicitHydrogen:n||!1})},ketcher.showMolfileOpts=function(t,e,i,n){return this.render=new rnd.Render(t,i,n),e&&this.render.setMolecule(chem.Molfile.parseCTFile("string"==typeof e?e.split("\n"):e)),this.render.update(),this.render},ketcher.testSegment=function(t){for(var e=600,i=50,n=50,r=e,o=e,s=new util.Box2Abs(i,n,i+r,n+o),a=new Raphael(t),l=[],u=0;1e5>u;++u){for(var c=new util.Vec2(Math.random()*e+50,Math.random()*e+50),s=new util.Vec2(Math.random()*e+50,Math.random()*e+50),h=!0,d=0;d<l.length;++d)if(util.Vec2.segmentIntersection(c,s,l[d][0],l[d][1])){h=!1;break}h&&l.push([c,s])}a.rect(50,50,e,e).attr({stroke:"#0f0"});for(var d=0;d<l.length;++d)a.path("M{0},{1}L{2},{3}",l[d][0].x,l[d][0].y,l[d][1].x,l[d][1].y).attr({"stroke-width":1,stroke:"#000"})};