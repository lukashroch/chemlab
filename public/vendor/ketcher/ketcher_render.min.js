function hexToRGB(t){return{r:parseInt(t.substring(1,3),16),g:parseInt(t.substring(3,5),16),b:parseInt(t.substring(5,7),16)}}function rgbCompToHex(t){t=t.toFixed(),t=Math.max(Math.min(t,255),0);var e=t.toString(16);return e.length<2&&(e="0"+e),e}function rgbToHex(t){return"#"+rgbCompToHex(t.r)+rgbCompToHex(t.g)+rgbCompToHex(t.b)}function rgbRescale(t,e){var n=.21*t.r+.72*t.g+.07*t.b;return e>=n?t:{r:(t.r*e/n).toFixed()-0,g:(t.g*e/n).toFixed()-0,b:(t.b*e/n).toFixed()-0}}function $A(t){if(!t)return[];if("toArray"in Object(t))return t.toArray();for(var e=t.length||0,n=new Array(e);e--;)n[e]=t[e];return n}function $w(t){return Object.isString(t)?(t=t.strip(),t?t.split(/\s+/):[]):[]}function $H(t){return new Hash(t)}function $R(t,e,n){return new ObjectRange(t,e,n)}function $(t){if(arguments.length>1){for(var e=0,n=[],r=arguments.length;r>e;e++)n.push($(arguments[e]));return n}return Object.isString(t)&&(t=document.getElementById(t)),Element.extend(t)}function tfx(t){return(t-0).toFixed(8)}!function(t){var e,n,r="0.3.4",i="hasOwnProperty",o=/[\.\/]/,s="*",a=function(){},l=function(t,e){return t-e},c={n:{}},h=function(t,r){var i,o=n,s=Array.prototype.slice.call(arguments,2),a=h.listeners(t),c=0,u=[],d={},p=[],f=e;e=t,n=0;for(var m=0,g=a.length;g>m;m++)"zIndex"in a[m]&&(u.push(a[m].zIndex),a[m].zIndex<0&&(d[a[m].zIndex]=a[m]));for(u.sort(l);u[c]<0;)if(i=d[u[c++]],p.push(i.apply(r,s)),n)return n=o,p;for(m=0;g>m;m++)if(i=a[m],"zIndex"in i)if(i.zIndex==u[c]){if(p.push(i.apply(r,s)),n)break;do if(c++,i=d[u[c]],i&&p.push(i.apply(r,s)),n)break;while(i)}else d[i.zIndex]=i;else if(p.push(i.apply(r,s)),n)break;return n=o,e=f,p.length?p:null};h.listeners=function(t){var e,n,r,i,a,l,h,u,d=t.split(o),p=c,f=[p],m=[];for(i=0,a=d.length;a>i;i++){for(u=[],l=0,h=f.length;h>l;l++)for(p=f[l].n,n=[p[d[i]],p[s]],r=2;r--;)e=n[r],e&&(u.push(e),m=m.concat(e.f||[]));f=u}return m},h.on=function(t,e){for(var n=t.split(o),r=c,i=0,s=n.length;s>i;i++)r=r.n,!r[n[i]]&&(r[n[i]]={n:{}}),r=r[n[i]];for(r.f=r.f||[],i=0,s=r.f.length;s>i;i++)if(r.f[i]==e)return a;return r.f.push(e),function(t){+t==+t&&(e.zIndex=+t)}},h.stop=function(){n=1},h.nt=function(t){return t?new RegExp("(?:\\.|\\/|^)"+t+"(?:\\.|\\/|$)").test(e):e},h.off=h.unbind=function(t,e){var n,r,a,l,h,u,d,p=t.split(o),f=[c];for(l=0,h=p.length;h>l;l++)for(u=0;u<f.length;u+=a.length-2){if(a=[u,1],n=f[u].n,p[l]!=s)n[p[l]]&&a.push(n[p[l]]);else for(r in n)n[i](r)&&a.push(n[r]);f.splice.apply(f,a)}for(l=0,h=f.length;h>l;l++)for(n=f[l];n.n;){if(e){if(n.f){for(u=0,d=n.f.length;d>u;u++)if(n.f[u]==e){n.f.splice(u,1);break}!n.f.length&&delete n.f}for(r in n.n)if(n.n[i](r)&&n.n[r].f){var m=n.n[r].f;for(u=0,d=m.length;d>u;u++)if(m[u]==e){m.splice(u,1);break}!m.length&&delete n.n[r].f}}else{delete n.f;for(r in n.n)n.n[i](r)&&n.n[r].f&&delete n.n[r].f}n=n.n}},h.once=function(t,e){var n=function(){var r=e.apply(this,arguments);return h.unbind(t,n),r};return h.on(t,n)},h.version=r,h.toString=function(){return"You are running Eve "+r},"undefined"!=typeof module&&module.exports?module.exports=h:"undefined"!=typeof define?define("eve",[],function(){return h}):t.eve=h}(this),function(){function t(e){if(t.is(e,"function"))return v?e():eve.on("raphael.DOMload",e);if(t.is(e,$))return t._engine.create[A](t,e.splice(0,3+t.is(e[0],z))).add(e);var n=Array.prototype.slice.call(arguments,0);if(t.is(n[n.length-1],"function")){var r=n.pop();return v?r.call(t._engine.create[A](t,n)):eve.on("raphael.DOMload",function(){r.call(t._engine.create[A](t,n))})}return t._engine.create[A](t,arguments)}function e(t){if(Object(t)!==t)return t;var n=new t.constructor;for(var r in t)t[E](r)&&(n[r]=e(t[r]));return n}function n(t,e){for(var n=0,r=t.length;r>n;n++)if(t[n]===e)return t.push(t.splice(n,1)[0])}function r(t,e,r){function i(){var o=Array.prototype.slice.call(arguments,0),s=o.join("␀"),a=i.cache=i.cache||{},l=i.count=i.count||[];return a[E](s)?(n(l,s),r?r(a[s]):a[s]):(l.length>=1e3&&delete a[l.shift()],l.push(s),a[s]=t[A](e,o),r?r(a[s]):a[s])}return i}function i(){return this.hex}function o(t,e){for(var n=[],r=0,i=t.length;i-2*!e>r;r+=2){var o=[{x:+t[r-2],y:+t[r-1]},{x:+t[r],y:+t[r+1]},{x:+t[r+2],y:+t[r+3]},{x:+t[r+4],y:+t[r+5]}];e?r?i-4==r?o[3]={x:+t[0],y:+t[1]}:i-2==r&&(o[2]={x:+t[0],y:+t[1]},o[3]={x:+t[2],y:+t[3]}):o[0]={x:+t[i-2],y:+t[i-1]}:i-4==r?o[3]=o[2]:r||(o[0]={x:+t[r],y:+t[r+1]}),n.push(["C",(-o[0].x+6*o[1].x+o[2].x)/6,(-o[0].y+6*o[1].y+o[2].y)/6,(o[1].x+6*o[2].x-o[3].x)/6,(o[1].y+6*o[2].y-o[3].y)/6,o[2].x,o[2].y])}return n}function s(t,e,n,r,i){var o=-3*e+9*n-9*r+3*i,s=t*o+6*e-12*n+6*r;return t*s-3*e+3*n}function a(t,e,n,r,i,o,a,l,c){null==c&&(c=1),c=c>1?1:0>c?0:c;for(var h=c/2,u=12,d=[-.1252,.1252,-.3678,.3678,-.5873,.5873,-.7699,.7699,-.9041,.9041,-.9816,.9816],p=[.2491,.2491,.2335,.2335,.2032,.2032,.1601,.1601,.1069,.1069,.0472,.0472],f=0,m=0;u>m;m++){var g=h*d[m]+h,b=s(g,t,n,i,a),v=s(g,e,r,o,l),y=b*b+v*v;f+=p[m]*I.sqrt(y)}return h*f}function l(t,e,n,r,i,o,s,l,c){if(!(0>c||a(t,e,n,r,i,o,s,l)<c)){var h,u=1,d=u/2,p=u-d,f=.01;for(h=a(t,e,n,r,i,o,s,l,p);G(h-c)>f;)d/=2,p+=(c>h?1:-1)*d,h=a(t,e,n,r,i,o,s,l,p);return p}}function c(t,e,n,r,i,o,s,a){if(!(V(t,n)<j(i,s)||j(t,n)>V(i,s)||V(e,r)<j(o,a)||j(e,r)>V(o,a))){var l=(t*r-e*n)*(i-s)-(t-n)*(i*a-o*s),c=(t*r-e*n)*(o-a)-(e-r)*(i*a-o*s),h=(t-n)*(o-a)-(e-r)*(i-s);if(h){var u=l/h,d=c/h,p=+u.toFixed(2),f=+d.toFixed(2);if(!(p<+j(t,n).toFixed(2)||p>+V(t,n).toFixed(2)||p<+j(i,s).toFixed(2)||p>+V(i,s).toFixed(2)||f<+j(e,r).toFixed(2)||f>+V(e,r).toFixed(2)||f<+j(o,a).toFixed(2)||f>+V(o,a).toFixed(2)))return{x:u,y:d}}}}function h(e,n,r){var i=t.bezierBBox(e),o=t.bezierBBox(n);if(!t.isBBoxIntersect(i,o))return r?0:[];for(var s=a.apply(0,e),l=a.apply(0,n),h=~~(s/5),u=~~(l/5),d=[],p=[],f={},m=r?0:[],g=0;h+1>g;g++){var b=t.findDotsAtSegment.apply(t,e.concat(g/h));d.push({x:b.x,y:b.y,t:g/h})}for(g=0;u+1>g;g++)b=t.findDotsAtSegment.apply(t,n.concat(g/u)),p.push({x:b.x,y:b.y,t:g/u});for(g=0;h>g;g++)for(var v=0;u>v;v++){var y=d[g],x=d[g+1],S=p[v],w=p[v+1],E=G(x.x-y.x)<.001?"y":"x",B=G(w.x-S.x)<.001?"y":"x",R=c(y.x,y.y,x.x,x.y,S.x,S.y,w.x,w.y);if(R){if(f[R.x.toFixed(4)]==R.y.toFixed(4))continue;f[R.x.toFixed(4)]=R.y.toFixed(4);var C=y.t+G((R[E]-y[E])/(x[E]-y[E]))*(x.t-y.t),A=S.t+G((R[B]-S[B])/(w[B]-S[B]))*(w.t-S.t);C>=0&&1>=C&&A>=0&&1>=A&&(r?m++:m.push({x:R.x,y:R.y,t1:C,t2:A}))}}return m}function u(e,n,r){e=t._path2curve(e),n=t._path2curve(n);for(var i,o,s,a,l,c,u,d,p,f,m=r?0:[],g=0,b=e.length;b>g;g++){var v=e[g];if("M"==v[0])i=l=v[1],o=c=v[2];else{"C"==v[0]?(p=[i,o].concat(v.slice(1)),i=p[6],o=p[7]):(p=[i,o,i,o,l,c,l,c],i=l,o=c);for(var y=0,x=n.length;x>y;y++){var S=n[y];if("M"==S[0])s=u=S[1],a=d=S[2];else{"C"==S[0]?(f=[s,a].concat(S.slice(1)),s=f[6],a=f[7]):(f=[s,a,s,a,u,d,u,d],s=u,a=d);var w=h(p,f,r);if(r)m+=w;else{for(var E=0,B=w.length;B>E;E++)w[E].segment1=g,w[E].segment2=y,w[E].bez1=p,w[E].bez2=f;m=m.concat(w)}}}}}return m}function d(t,e,n,r,i,o){null!=t?(this.a=+t,this.b=+e,this.c=+n,this.d=+r,this.e=+i,this.f=+o):(this.a=1,this.b=0,this.c=0,this.d=1,this.e=0,this.f=0)}function p(){return this.x+P+this.y+P+this.width+" × "+this.height}function f(t,e,n,r,i,o){function s(t){return((u*t+h)*t+c)*t}function a(t,e){var n=l(t,e);return((f*n+p)*n+d)*n}function l(t,e){var n,r,i,o,a,l;for(i=t,l=0;8>l;l++){if(o=s(i)-t,G(o)<e)return i;if(a=(3*u*i+2*h)*i+c,G(a)<1e-6)break;i-=o/a}if(n=0,r=1,i=t,n>i)return n;if(i>r)return r;for(;r>n;){if(o=s(i),G(o-t)<e)return i;t>o?n=i:r=i,i=(r-n)/2+n}return i}var c=3*e,h=3*(r-e)-c,u=1-c-h,d=3*n,p=3*(i-n)-d,f=1-d-p;return a(t,1/(200*o))}function m(t,e){var n=[],r={};if(this.ms=e,this.times=1,t){for(var i in t)t[E](i)&&(r[J(i)]=t[i],n.push(J(i)));n.sort(ct)}this.anim=r,this.top=n[n.length-1],this.percents=n}function g(e,n,r,i,o,s){r=J(r);var a,l,c,h,u,p,m=e.ms,g={},b={},v={};if(i)for(S=0,w=oe.length;w>S;S++){var y=oe[S];if(y.el.id==n.id&&y.anim==e){y.percent!=r?(oe.splice(S,1),c=1):l=y,n.attr(y.totalOrigin);break}}else i=+b;for(var S=0,w=e.percents.length;w>S;S++){if(e.percents[S]==r||e.percents[S]>i*e.top){r=e.percents[S],u=e.percents[S-1]||0,m=m/e.top*(r-u),h=e.percents[S+1],a=e.anim[r];break}i&&n.attr(e.anim[e.percents[S]])}if(a){if(l)l.initstatus=i,l.start=new Date-l.ms*i;else{for(var B in a)if(a[E](B)&&(et[E](B)||n.paper.customAttributes[E](B)))switch(g[B]=n.attr(B),null==g[B]&&(g[B]=tt[B]),b[B]=a[B],et[B]){case z:v[B]=(b[B]-g[B])/m;break;case"colour":g[B]=t.getRGB(g[B]);var R=t.getRGB(b[B]);v[B]={r:(R.r-g[B].r)/m,g:(R.g-g[B].g)/m,b:(R.b-g[B].b)/m};break;case"path":var C=Lt(g[B],b[B]),A=C[1];for(g[B]=C[0],v[B]=[],S=0,w=g[B].length;w>S;S++){v[B][S]=[0];for(var O=1,T=g[B][S].length;T>O;O++)v[B][S][O]=(A[S][O]-g[B][S][O])/m}break;case"transform":var P=n._,L=jt(P[B],b[B]);if(L)for(g[B]=L.from,b[B]=L.to,v[B]=[],v[B].real=!0,S=0,w=g[B].length;w>S;S++)for(v[B][S]=[g[B][S][0]],O=1,T=g[B][S].length;T>O;O++)v[B][S][O]=(b[B][S][O]-g[B][S][O])/m;else{var k=n.matrix||new d,D={_:{transform:P.transform},getBBox:function(){return n.getBBox(1)}};g[B]=[k.a,k.b,k.c,k.d,k.e,k.f],It(D,b[B]),b[B]=D._.transform,v[B]=[(D.matrix.a-k.a)/m,(D.matrix.b-k.b)/m,(D.matrix.c-k.c)/m,(D.matrix.d-k.d)/m,(D.matrix.e-k.e)/m,(D.matrix.f-k.f)/m]}break;case"csv":var I=M(a[B])[N](x),V=M(g[B])[N](x);if("clip-rect"==B)for(g[B]=V,v[B]=[],S=V.length;S--;)v[B][S]=(I[S]-g[B][S])/m;b[B]=I;break;default:for(I=[][_](a[B]),V=[][_](g[B]),v[B]=[],S=n.paper.customAttributes[B].length;S--;)v[B][S]=((I[S]||0)-(V[S]||0))/m}var j=a.easing,G=t.easing_formulas[j];if(!G)if(G=M(j).match(X),G&&5==G.length){var F=G;G=function(t){return f(t,+F[1],+F[2],+F[3],+F[4],m)}}else G=ut;if(p=a.start||e.start||+new Date,y={anim:e,percent:r,timestamp:p,start:p+(e.del||0),status:0,initstatus:i||0,stop:!1,ms:m,easing:G,from:g,diff:v,to:b,el:n,callback:a.callback,prev:u,next:h,repeat:s||e.times,origin:n.attr(),totalOrigin:o},oe.push(y),i&&!l&&!c&&(y.stop=!0,y.start=new Date-m*i,1==oe.length))return ae();c&&(y.start=new Date-y.ms*i),1==oe.length&&se(ae)}eve("raphael.anim.start."+n.id,n,e)}}function b(t){for(var e=0;e<oe.length;e++)oe[e].el.paper==t&&oe.splice(e--,1)}t.version="2.1.0",t.eve=eve;var v,y,x=/[, ]+/,S={circle:1,rect:1,path:1,ellipse:1,text:1,image:1},w=/\{(\d+)\}/g,E="hasOwnProperty",B={doc:document,win:window},R={was:Object.prototype[E].call(B.win,"Raphael"),is:B.win.Raphael},C=function(){this.ca=this.customAttributes={}},A="apply",_="concat",O="createTouch"in B.doc,T="",P=" ",M=String,N="split",L="click dblclick mousedown mousemove mouseout mouseover mouseup touchstart touchmove touchend touchcancel"[N](P),k={mousedown:"touchstart",mousemove:"touchmove",mouseup:"touchend"},D=M.prototype.toLowerCase,I=Math,V=I.max,j=I.min,G=I.abs,F=I.pow,H=I.PI,z="number",U="string",$="array",Y=Object.prototype.toString,W=(t._ISURL=/^url\(['"]?([^\)]+?)['"]?\)$/i,/^\s*((#[a-f\d]{6})|(#[a-f\d]{3})|rgba?\(\s*([\d\.]+%?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+%?(?:\s*,\s*[\d\.]+%?)?)\s*\)|hsba?\(\s*([\d\.]+(?:deg|\xb0|%)?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+(?:%?\s*,\s*[\d\.]+)?)%?\s*\)|hsla?\(\s*([\d\.]+(?:deg|\xb0|%)?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+(?:%?\s*,\s*[\d\.]+)?)%?\s*\))\s*$/i),q={NaN:1,Infinity:1,"-Infinity":1},X=/^(?:cubic-)?bezier\(([^,]+),([^,]+),([^,]+),([^\)]+)\)/,K=I.round,J=parseFloat,Q=parseInt,Z=M.prototype.toUpperCase,tt=t._availableAttrs={"arrow-end":"none","arrow-start":"none",blur:0,"clip-rect":"0 0 1e9 1e9",cursor:"default",cx:0,cy:0,fill:"#fff","fill-opacity":1,font:'10px "Arial"',"font-family":'"Arial"',"font-size":"10","font-style":"normal","font-weight":400,gradient:0,height:0,href:"http://raphaeljs.com/","letter-spacing":0,opacity:1,path:"M0,0",r:0,rx:0,ry:0,src:"",stroke:"#000","stroke-dasharray":"","stroke-linecap":"butt","stroke-linejoin":"butt","stroke-miterlimit":0,"stroke-opacity":1,"stroke-width":1,target:"_blank","text-anchor":"middle",title:"Raphael",transform:"",width:0,x:0,y:0},et=t._availableAnimAttrs={blur:z,"clip-rect":"csv",cx:z,cy:z,fill:"colour","fill-opacity":z,"font-size":z,height:z,opacity:z,path:"path",r:z,rx:z,ry:z,stroke:"colour","stroke-opacity":z,"stroke-width":z,transform:"transform",width:z,x:z,y:z},nt=/[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*/,rt={hs:1,rg:1},it=/,?([achlmqrstvxz]),?/gi,ot=/([achlmrqstvz])[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*)+)/gi,st=/([rstm])[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*)+)/gi,at=/(-?\d*\.?\d*(?:e[\-+]?\d+)?)[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*/gi,lt=(t._radial_gradient=/^r(?:\(([^,]+?)[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*([^\)]+?)\))?/,{}),ct=function(t,e){return J(t)-J(e)},ht=function(){},ut=function(t){return t},dt=t._rectPath=function(t,e,n,r,i){return i?[["M",t+i,e],["l",n-2*i,0],["a",i,i,0,0,1,i,i],["l",0,r-2*i],["a",i,i,0,0,1,-i,i],["l",2*i-n,0],["a",i,i,0,0,1,-i,-i],["l",0,2*i-r],["a",i,i,0,0,1,i,-i],["z"]]:[["M",t,e],["l",n,0],["l",0,r],["l",-n,0],["z"]]},pt=function(t,e,n,r){return null==r&&(r=n),[["M",t,e],["m",0,-r],["a",n,r,0,1,1,0,2*r],["a",n,r,0,1,1,0,-2*r],["z"]]},ft=t._getPath={path:function(t){return t.attr("path")},circle:function(t){var e=t.attrs;return pt(e.cx,e.cy,e.r)},ellipse:function(t){var e=t.attrs;return pt(e.cx,e.cy,e.rx,e.ry)},rect:function(t){var e=t.attrs;return dt(e.x,e.y,e.width,e.height,e.r)},image:function(t){var e=t.attrs;return dt(e.x,e.y,e.width,e.height)},text:function(t){var e=t._getBBox();return dt(e.x,e.y,e.width,e.height)}},mt=t.mapPath=function(t,e){if(!e)return t;var n,r,i,o,s,a,l;for(t=Lt(t),i=0,s=t.length;s>i;i++)for(l=t[i],o=1,a=l.length;a>o;o+=2)n=e.x(l[o],l[o+1]),r=e.y(l[o],l[o+1]),l[o]=n,l[o+1]=r;return t};if(t._g=B,t.type=B.win.SVGAngle||B.doc.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1")?"SVG":"VML","VML"==t.type){var gt,bt=B.doc.createElement("div");if(bt.innerHTML='<v:shape adj="1"/>',gt=bt.firstChild,gt.style.behavior="url(#default#VML)",!gt||"object"!=typeof gt.adj)return t.type=T;bt=null}t.svg=!(t.vml="VML"==t.type),t._Paper=C,t.fn=y=C.prototype=t.prototype,t._id=0,t._oid=0,t.is=function(t,e){return e=D.call(e),"finite"==e?!q[E](+t):"array"==e?t instanceof Array:"null"==e&&null===t||e==typeof t&&null!==t||"object"==e&&t===Object(t)||"array"==e&&Array.isArray&&Array.isArray(t)||Y.call(t).slice(8,-1).toLowerCase()==e},t.angle=function(e,n,r,i,o,s){if(null==o){var a=e-r,l=n-i;return a||l?(180+180*I.atan2(-l,-a)/H+360)%360:0}return t.angle(e,n,o,s)-t.angle(r,i,o,s)},t.rad=function(t){return t%360*H/180},t.deg=function(t){return 180*t/H%360},t.snapTo=function(e,n,r){if(r=t.is(r,"finite")?r:10,t.is(e,$)){for(var i=e.length;i--;)if(G(e[i]-n)<=r)return e[i]}else{e=+e;var o=n%e;if(r>o)return n-o;if(o>e-r)return n-o+e}return n};t.createUUID=function(t,e){return function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(t,e).toUpperCase()}}(/[xy]/g,function(t){var e=16*I.random()|0,n="x"==t?e:3&e|8;return n.toString(16)});t.setWindow=function(e){eve("raphael.setWindow",t,B.win,e),B.win=e,B.doc=B.win.document,t._engine.initWin&&t._engine.initWin(B.win)};var vt=function(e){if(t.vml){var n,i=/^\s+|\s+$/g;try{var o=new ActiveXObject("htmlfile");o.write("<body>"),o.close(),n=o.body}catch(s){n=createPopup().document.body}var a=n.createTextRange();vt=r(function(t){try{n.style.color=M(t).replace(i,T);var e=a.queryCommandValue("ForeColor");return e=(255&e)<<16|65280&e|(16711680&e)>>>16,"#"+("000000"+e.toString(16)).slice(-6)}catch(r){return"none"}})}else{var l=B.doc.createElement("i");l.title="Raphaël Colour Picker",l.style.display="none",B.doc.body.appendChild(l),vt=r(function(t){return l.style.color=t,B.doc.defaultView.getComputedStyle(l,T).getPropertyValue("color")})}return vt(e)},yt=function(){return"hsb("+[this.h,this.s,this.b]+")"},xt=function(){return"hsl("+[this.h,this.s,this.l]+")"},St=function(){return this.hex},wt=function(e,n,r){if(null==n&&t.is(e,"object")&&"r"in e&&"g"in e&&"b"in e&&(r=e.b,n=e.g,e=e.r),null==n&&t.is(e,U)){var i=t.getRGB(e);e=i.r,n=i.g,r=i.b}return(e>1||n>1||r>1)&&(e/=255,n/=255,r/=255),[e,n,r]},Et=function(e,n,r,i){e*=255,n*=255,r*=255;var o={r:e,g:n,b:r,hex:t.rgb(e,n,r),toString:St};return t.is(i,"finite")&&(o.opacity=i),o};t.color=function(e){var n;return t.is(e,"object")&&"h"in e&&"s"in e&&"b"in e?(n=t.hsb2rgb(e),e.r=n.r,e.g=n.g,e.b=n.b,e.hex=n.hex):t.is(e,"object")&&"h"in e&&"s"in e&&"l"in e?(n=t.hsl2rgb(e),e.r=n.r,e.g=n.g,e.b=n.b,e.hex=n.hex):(t.is(e,"string")&&(e=t.getRGB(e)),t.is(e,"object")&&"r"in e&&"g"in e&&"b"in e?(n=t.rgb2hsl(e),e.h=n.h,e.s=n.s,e.l=n.l,n=t.rgb2hsb(e),e.v=n.b):(e={hex:"none"},e.r=e.g=e.b=e.h=e.s=e.v=e.l=-1)),e.toString=St,e},t.hsb2rgb=function(t,e,n,r){this.is(t,"object")&&"h"in t&&"s"in t&&"b"in t&&(n=t.b,e=t.s,t=t.h,r=t.o),t*=360;var i,o,s,a,l;return t=t%360/60,l=n*e,a=l*(1-G(t%2-1)),i=o=s=n-l,t=~~t,i+=[l,a,0,0,a,l][t],o+=[a,l,l,a,0,0][t],s+=[0,0,a,l,l,a][t],Et(i,o,s,r)},t.hsl2rgb=function(t,e,n,r){this.is(t,"object")&&"h"in t&&"s"in t&&"l"in t&&(n=t.l,e=t.s,t=t.h),(t>1||e>1||n>1)&&(t/=360,e/=100,n/=100),t*=360;var i,o,s,a,l;return t=t%360/60,l=2*e*(.5>n?n:1-n),a=l*(1-G(t%2-1)),i=o=s=n-l/2,t=~~t,i+=[l,a,0,0,a,l][t],o+=[a,l,l,a,0,0][t],s+=[0,0,a,l,l,a][t],Et(i,o,s,r)},t.rgb2hsb=function(t,e,n){n=wt(t,e,n),t=n[0],e=n[1],n=n[2];var r,i,o,s;return o=V(t,e,n),s=o-j(t,e,n),r=0==s?null:o==t?(e-n)/s:o==e?(n-t)/s+2:(t-e)/s+4,r=(r+360)%6*60/360,i=0==s?0:s/o,{h:r,s:i,b:o,toString:yt}},t.rgb2hsl=function(t,e,n){n=wt(t,e,n),t=n[0],e=n[1],n=n[2];var r,i,o,s,a,l;return s=V(t,e,n),a=j(t,e,n),l=s-a,r=0==l?null:s==t?(e-n)/l:s==e?(n-t)/l+2:(t-e)/l+4,r=(r+360)%6*60/360,o=(s+a)/2,i=0==l?0:.5>o?l/(2*o):l/(2-2*o),{h:r,s:i,l:o,toString:xt}},t._path2string=function(){return this.join(",").replace(it,"$1")};t._preload=function(t,e){var n=B.doc.createElement("img");n.style.cssText="position:absolute;left:-9999em;top:-9999em",n.onload=function(){e.call(this),this.onload=null,B.doc.body.removeChild(this)},n.onerror=function(){B.doc.body.removeChild(this)},B.doc.body.appendChild(n),n.src=t};t.getRGB=r(function(e){if(!e||(e=M(e)).indexOf("-")+1)return{r:-1,g:-1,b:-1,hex:"none",error:1,toString:i};if("none"==e)return{r:-1,g:-1,b:-1,hex:"none",toString:i};!(rt[E](e.toLowerCase().substring(0,2))||"#"==e.charAt())&&(e=vt(e));var n,r,o,s,a,l,c=e.match(W);return c?(c[2]&&(o=Q(c[2].substring(5),16),r=Q(c[2].substring(3,5),16),n=Q(c[2].substring(1,3),16)),c[3]&&(o=Q((a=c[3].charAt(3))+a,16),r=Q((a=c[3].charAt(2))+a,16),n=Q((a=c[3].charAt(1))+a,16)),c[4]&&(l=c[4][N](nt),n=J(l[0]),"%"==l[0].slice(-1)&&(n*=2.55),r=J(l[1]),"%"==l[1].slice(-1)&&(r*=2.55),o=J(l[2]),"%"==l[2].slice(-1)&&(o*=2.55),"rgba"==c[1].toLowerCase().slice(0,4)&&(s=J(l[3])),l[3]&&"%"==l[3].slice(-1)&&(s/=100)),c[5]?(l=c[5][N](nt),n=J(l[0]),"%"==l[0].slice(-1)&&(n*=2.55),r=J(l[1]),"%"==l[1].slice(-1)&&(r*=2.55),o=J(l[2]),"%"==l[2].slice(-1)&&(o*=2.55),("deg"==l[0].slice(-3)||"°"==l[0].slice(-1))&&(n/=360),"hsba"==c[1].toLowerCase().slice(0,4)&&(s=J(l[3])),l[3]&&"%"==l[3].slice(-1)&&(s/=100),t.hsb2rgb(n,r,o,s)):c[6]?(l=c[6][N](nt),n=J(l[0]),"%"==l[0].slice(-1)&&(n*=2.55),r=J(l[1]),"%"==l[1].slice(-1)&&(r*=2.55),o=J(l[2]),"%"==l[2].slice(-1)&&(o*=2.55),("deg"==l[0].slice(-3)||"°"==l[0].slice(-1))&&(n/=360),"hsla"==c[1].toLowerCase().slice(0,4)&&(s=J(l[3])),l[3]&&"%"==l[3].slice(-1)&&(s/=100),t.hsl2rgb(n,r,o,s)):(c={r:n,g:r,b:o,toString:i},c.hex="#"+(16777216|o|r<<8|n<<16).toString(16).slice(1),t.is(s,"finite")&&(c.opacity=s),c)):{r:-1,g:-1,b:-1,hex:"none",error:1,toString:i}},t),t.hsb=r(function(e,n,r){return t.hsb2rgb(e,n,r).hex}),t.hsl=r(function(e,n,r){return t.hsl2rgb(e,n,r).hex}),t.rgb=r(function(t,e,n){return"#"+(16777216|n|e<<8|t<<16).toString(16).slice(1)}),t.getColor=function(t){var e=this.getColor.start=this.getColor.start||{h:0,s:1,b:t||.75},n=this.hsb2rgb(e.h,e.s,e.b);return e.h+=.075,e.h>1&&(e.h=0,e.s-=.2,e.s<=0&&(this.getColor.start={h:0,s:1,b:e.b})),n.hex},t.getColor.reset=function(){delete this.start},t.parsePathString=function(e){if(!e)return null;var n=Bt(e);if(n.arr)return Ct(n.arr);var r={a:7,c:6,h:1,l:2,m:2,r:4,q:4,s:4,t:2,v:1,z:0},i=[];return t.is(e,$)&&t.is(e[0],$)&&(i=Ct(e)),i.length||M(e).replace(ot,function(t,e,n){var o=[],s=e.toLowerCase();if(n.replace(at,function(t,e){e&&o.push(+e)}),"m"==s&&o.length>2&&(i.push([e][_](o.splice(0,2))),s="l",e="m"==e?"l":"L"),"r"==s)i.push([e][_](o));else for(;o.length>=r[s]&&(i.push([e][_](o.splice(0,r[s]))),r[s]););}),i.toString=t._path2string,n.arr=Ct(i),i},t.parseTransformString=r(function(e){if(!e)return null;var n=[];return t.is(e,$)&&t.is(e[0],$)&&(n=Ct(e)),n.length||M(e).replace(st,function(t,e,r){var i=[];D.call(e);r.replace(at,function(t,e){e&&i.push(+e)}),n.push([e][_](i))}),n.toString=t._path2string,n});var Bt=function(t){var e=Bt.ps=Bt.ps||{};return e[t]?e[t].sleep=100:e[t]={sleep:100},setTimeout(function(){for(var n in e)e[E](n)&&n!=t&&(e[n].sleep--,!e[n].sleep&&delete e[n])}),e[t]};t.findDotsAtSegment=function(t,e,n,r,i,o,s,a,l){var c=1-l,h=F(c,3),u=F(c,2),d=l*l,p=d*l,f=h*t+3*u*l*n+3*c*l*l*i+p*s,m=h*e+3*u*l*r+3*c*l*l*o+p*a,g=t+2*l*(n-t)+d*(i-2*n+t),b=e+2*l*(r-e)+d*(o-2*r+e),v=n+2*l*(i-n)+d*(s-2*i+n),y=r+2*l*(o-r)+d*(a-2*o+r),x=c*t+l*n,S=c*e+l*r,w=c*i+l*s,E=c*o+l*a,B=90-180*I.atan2(g-v,b-y)/H;return(g>v||y>b)&&(B+=180),{x:f,y:m,m:{x:g,y:b},n:{x:v,y:y},start:{x:x,y:S},end:{x:w,y:E},alpha:B}},t.bezierBBox=function(e,n,r,i,o,s,a,l){t.is(e,"array")||(e=[e,n,r,i,o,s,a,l]);var c=Nt.apply(null,e);return{x:c.min.x,y:c.min.y,x2:c.max.x,y2:c.max.y,width:c.max.x-c.min.x,height:c.max.y-c.min.y}},t.isPointInsideBBox=function(t,e,n){return e>=t.x&&e<=t.x2&&n>=t.y&&n<=t.y2},t.isBBoxIntersect=function(e,n){var r=t.isPointInsideBBox;return r(n,e.x,e.y)||r(n,e.x2,e.y)||r(n,e.x,e.y2)||r(n,e.x2,e.y2)||r(e,n.x,n.y)||r(e,n.x2,n.y)||r(e,n.x,n.y2)||r(e,n.x2,n.y2)||(e.x<n.x2&&e.x>n.x||n.x<e.x2&&n.x>e.x)&&(e.y<n.y2&&e.y>n.y||n.y<e.y2&&n.y>e.y)},t.pathIntersection=function(t,e){return u(t,e)},t.pathIntersectionNumber=function(t,e){return u(t,e,1)},t.isPointInsidePath=function(e,n,r){var i=t.pathBBox(e);return t.isPointInsideBBox(i,n,r)&&u(e,[["M",n,r],["H",i.x2+10]],1)%2==1},t._removedFactory=function(t){return function(){eve("raphael.log",null,"Raphaël: you are calling to method “"+t+"” of removed object",t)}};var Rt=t.pathBBox=function(t){var n=Bt(t);if(!t)return{x:0,y:0,width:0,height:0,x2:0,y2:0};t=Lt(t);for(var r,i=0,o=0,s=[],a=[],l=0,c=t.length;c>l;l++)if(r=t[l],"M"==r[0])i=r[1],o=r[2],s.push(i),a.push(o);else{var h=Nt(i,o,r[1],r[2],r[3],r[4],r[5],r[6]);s=s[_](h.min.x,h.max.x),a=a[_](h.min.y,h.max.y),i=r[5],o=r[6]}var u=j[A](0,s),d=j[A](0,a),p=V[A](0,s),f=V[A](0,a),m={x:u,y:d,x2:p,y2:f,width:p-u,height:f-d};return n.bbox=e(m),m},Ct=function(n){var r=e(n);return r.toString=t._path2string,r},At=t._pathToRelative=function(e){var n=Bt(e);if(n.rel)return Ct(n.rel);t.is(e,$)&&t.is(e&&e[0],$)||(e=t.parsePathString(e));var r=[],i=0,o=0,s=0,a=0,l=0;"M"==e[0][0]&&(i=e[0][1],o=e[0][2],s=i,a=o,l++,r.push(["M",i,o]));for(var c=l,h=e.length;h>c;c++){var u=r[c]=[],d=e[c];if(d[0]!=D.call(d[0]))switch(u[0]=D.call(d[0]),u[0]){case"a":u[1]=d[1],u[2]=d[2],u[3]=d[3],u[4]=d[4],u[5]=d[5],u[6]=+(d[6]-i).toFixed(3),u[7]=+(d[7]-o).toFixed(3);break;case"v":u[1]=+(d[1]-o).toFixed(3);break;case"m":s=d[1],a=d[2];default:for(var p=1,f=d.length;f>p;p++)u[p]=+(d[p]-(p%2?i:o)).toFixed(3)}else{u=r[c]=[],"m"==d[0]&&(s=d[1]+i,a=d[2]+o);for(var m=0,g=d.length;g>m;m++)r[c][m]=d[m]}var b=r[c].length;switch(r[c][0]){case"z":i=s,o=a;break;case"h":i+=+r[c][b-1];break;case"v":o+=+r[c][b-1];break;default:i+=+r[c][b-2],o+=+r[c][b-1]}}return r.toString=t._path2string,n.rel=Ct(r),r},_t=t._pathToAbsolute=function(e){var n=Bt(e);if(n.abs)return Ct(n.abs);if(t.is(e,$)&&t.is(e&&e[0],$)||(e=t.parsePathString(e)),!e||!e.length)return[["M",0,0]];var r=[],i=0,s=0,a=0,l=0,c=0;"M"==e[0][0]&&(i=+e[0][1],s=+e[0][2],a=i,l=s,c++,r[0]=["M",i,s]);for(var h,u,d=3==e.length&&"M"==e[0][0]&&"R"==e[1][0].toUpperCase()&&"Z"==e[2][0].toUpperCase(),p=c,f=e.length;f>p;p++){if(r.push(h=[]),u=e[p],u[0]!=Z.call(u[0]))switch(h[0]=Z.call(u[0]),h[0]){case"A":h[1]=u[1],h[2]=u[2],h[3]=u[3],h[4]=u[4],h[5]=u[5],h[6]=+(u[6]+i),h[7]=+(u[7]+s);break;case"V":h[1]=+u[1]+s;break;case"H":h[1]=+u[1]+i;break;case"R":for(var m=[i,s][_](u.slice(1)),g=2,b=m.length;b>g;g++)m[g]=+m[g]+i,m[++g]=+m[g]+s;r.pop(),r=r[_](o(m,d));break;case"M":a=+u[1]+i,l=+u[2]+s;default:for(g=1,b=u.length;b>g;g++)h[g]=+u[g]+(g%2?i:s)}else if("R"==u[0])m=[i,s][_](u.slice(1)),r.pop(),r=r[_](o(m,d)),h=["R"][_](u.slice(-2));else for(var v=0,y=u.length;y>v;v++)h[v]=u[v];switch(h[0]){case"Z":i=a,s=l;break;case"H":i=h[1];break;case"V":s=h[1];break;case"M":a=h[h.length-2],l=h[h.length-1];default:i=h[h.length-2],s=h[h.length-1]}}return r.toString=t._path2string,n.abs=Ct(r),r},Ot=function(t,e,n,r){return[t,e,n,r,n,r]},Tt=function(t,e,n,r,i,o){var s=1/3,a=2/3;return[s*t+a*n,s*e+a*r,s*i+a*n,s*o+a*r,i,o]},Pt=function(t,e,n,i,o,s,a,l,c,h){var u,d=120*H/180,p=H/180*(+o||0),f=[],m=r(function(t,e,n){var r=t*I.cos(n)-e*I.sin(n),i=t*I.sin(n)+e*I.cos(n);return{x:r,y:i}});if(h)B=h[0],R=h[1],w=h[2],E=h[3];else{u=m(t,e,-p),t=u.x,e=u.y,u=m(l,c,-p),l=u.x,c=u.y;var g=(I.cos(H/180*o),I.sin(H/180*o),(t-l)/2),b=(e-c)/2,v=g*g/(n*n)+b*b/(i*i);v>1&&(v=I.sqrt(v),n=v*n,i=v*i);var y=n*n,x=i*i,S=(s==a?-1:1)*I.sqrt(G((y*x-y*b*b-x*g*g)/(y*b*b+x*g*g))),w=S*n*b/i+(t+l)/2,E=S*-i*g/n+(e+c)/2,B=I.asin(((e-E)/i).toFixed(9)),R=I.asin(((c-E)/i).toFixed(9));B=w>t?H-B:B,R=w>l?H-R:R,0>B&&(B=2*H+B),0>R&&(R=2*H+R),a&&B>R&&(B-=2*H),!a&&R>B&&(R-=2*H)}var C=R-B;if(G(C)>d){var A=R,O=l,T=c;R=B+d*(a&&R>B?1:-1),l=w+n*I.cos(R),c=E+i*I.sin(R),f=Pt(l,c,n,i,o,0,a,O,T,[R,A,w,E])}C=R-B;var P=I.cos(B),M=I.sin(B),L=I.cos(R),k=I.sin(R),D=I.tan(C/4),V=4/3*n*D,j=4/3*i*D,F=[t,e],z=[t+V*M,e-j*P],U=[l+V*k,c-j*L],$=[l,c];if(z[0]=2*F[0]-z[0],z[1]=2*F[1]-z[1],h)return[z,U,$][_](f);f=[z,U,$][_](f).join()[N](",");for(var Y=[],W=0,q=f.length;q>W;W++)Y[W]=W%2?m(f[W-1],f[W],p).y:m(f[W],f[W+1],p).x;return Y},Mt=function(t,e,n,r,i,o,s,a,l){var c=1-l;return{x:F(c,3)*t+3*F(c,2)*l*n+3*c*l*l*i+F(l,3)*s,y:F(c,3)*e+3*F(c,2)*l*r+3*c*l*l*o+F(l,3)*a}},Nt=r(function(t,e,n,r,i,o,s,a){var l,c=i-2*n+t-(s-2*i+n),h=2*(n-t)-2*(i-n),u=t-n,d=(-h+I.sqrt(h*h-4*c*u))/2/c,p=(-h-I.sqrt(h*h-4*c*u))/2/c,f=[e,a],m=[t,s];return G(d)>"1e12"&&(d=.5),G(p)>"1e12"&&(p=.5),d>0&&1>d&&(l=Mt(t,e,n,r,i,o,s,a,d),m.push(l.x),f.push(l.y)),p>0&&1>p&&(l=Mt(t,e,n,r,i,o,s,a,p),m.push(l.x),f.push(l.y)),c=o-2*r+e-(a-2*o+r),h=2*(r-e)-2*(o-r),u=e-r,d=(-h+I.sqrt(h*h-4*c*u))/2/c,p=(-h-I.sqrt(h*h-4*c*u))/2/c,G(d)>"1e12"&&(d=.5),G(p)>"1e12"&&(p=.5),d>0&&1>d&&(l=Mt(t,e,n,r,i,o,s,a,d),m.push(l.x),f.push(l.y)),p>0&&1>p&&(l=Mt(t,e,n,r,i,o,s,a,p),m.push(l.x),f.push(l.y)),{min:{x:j[A](0,m),y:j[A](0,f)},max:{x:V[A](0,m),y:V[A](0,f)}}}),Lt=t._path2curve=r(function(t,e){var n=!e&&Bt(t);if(!e&&n.curve)return Ct(n.curve);for(var r=_t(t),i=e&&_t(e),o={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},s={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},a=(function(t,e){var n,r;if(!t)return["C",e.x,e.y,e.x,e.y,e.x,e.y];switch(!(t[0]in{T:1,Q:1})&&(e.qx=e.qy=null),t[0]){case"M":e.X=t[1],e.Y=t[2];break;case"A":t=["C"][_](Pt[A](0,[e.x,e.y][_](t.slice(1))));break;case"S":n=e.x+(e.x-(e.bx||e.x)),r=e.y+(e.y-(e.by||e.y)),t=["C",n,r][_](t.slice(1));break;case"T":e.qx=e.x+(e.x-(e.qx||e.x)),e.qy=e.y+(e.y-(e.qy||e.y)),t=["C"][_](Tt(e.x,e.y,e.qx,e.qy,t[1],t[2]));break;case"Q":e.qx=t[1],e.qy=t[2],t=["C"][_](Tt(e.x,e.y,t[1],t[2],t[3],t[4]));break;case"L":t=["C"][_](Ot(e.x,e.y,t[1],t[2]));break;case"H":t=["C"][_](Ot(e.x,e.y,t[1],e.y));break;case"V":t=["C"][_](Ot(e.x,e.y,e.x,t[1]));break;case"Z":t=["C"][_](Ot(e.x,e.y,e.X,e.Y))}return t}),l=function(t,e){if(t[e].length>7){t[e].shift();for(var n=t[e];n.length;)t.splice(e++,0,["C"][_](n.splice(0,6)));t.splice(e,1),u=V(r.length,i&&i.length||0)}},c=function(t,e,n,o,s){t&&e&&"M"==t[s][0]&&"M"!=e[s][0]&&(e.splice(s,0,["M",o.x,o.y]),n.bx=0,n.by=0,n.x=t[s][1],n.y=t[s][2],u=V(r.length,i&&i.length||0))},h=0,u=V(r.length,i&&i.length||0);u>h;h++){r[h]=a(r[h],o),l(r,h),i&&(i[h]=a(i[h],s)),i&&l(i,h),c(r,i,o,s,h),c(i,r,s,o,h);var d=r[h],p=i&&i[h],f=d.length,m=i&&p.length;o.x=d[f-2],o.y=d[f-1],o.bx=J(d[f-4])||o.x,o.by=J(d[f-3])||o.y,s.bx=i&&(J(p[m-4])||s.x),s.by=i&&(J(p[m-3])||s.y),s.x=i&&p[m-2],s.y=i&&p[m-1]}return i||(n.curve=Ct(r)),i?[r,i]:r},null,Ct),kt=(t._parseDots=r(function(e){for(var n=[],r=0,i=e.length;i>r;r++){var o={},s=e[r].match(/^([^:]*):?([\d\.]*)/);if(o.color=t.getRGB(s[1]),o.color.error)return null;o.color=o.color.hex,s[2]&&(o.offset=s[2]+"%"),n.push(o)}for(r=1,i=n.length-1;i>r;r++)if(!n[r].offset){for(var a=J(n[r-1].offset||0),l=0,c=r+1;i>c;c++)if(n[c].offset){l=n[c].offset;break}l||(l=100,c=i),l=J(l);for(var h=(l-a)/(c-r+1);c>r;r++)a+=h,n[r].offset=a+"%"}return n}),t._tear=function(t,e){t==e.top&&(e.top=t.prev),t==e.bottom&&(e.bottom=t.next),t.next&&(t.next.prev=t.prev),t.prev&&(t.prev.next=t.next)}),Dt=(t._tofront=function(t,e){e.top!==t&&(kt(t,e),t.next=null,t.prev=e.top,e.top.next=t,e.top=t)},t._toback=function(t,e){e.bottom!==t&&(kt(t,e),t.next=e.bottom,t.prev=null,e.bottom.prev=t,e.bottom=t)},t._insertafter=function(t,e,n){kt(t,n),e==n.top&&(n.top=t),e.next&&(e.next.prev=t),t.next=e.next,t.prev=e,e.next=t},t._insertbefore=function(t,e,n){kt(t,n),e==n.bottom&&(n.bottom=t),e.prev&&(e.prev.next=t),t.prev=e.prev,e.prev=t,t.next=e},t.toMatrix=function(t,e){var n=Rt(t),r={_:{transform:T},getBBox:function(){return n}};return It(r,e),r.matrix}),It=(t.transformPath=function(t,e){return mt(t,Dt(t,e))},t._extractTransform=function(e,n){if(null==n)return e._.transform;n=M(n).replace(/\.{3}|\u2026/g,e._.transform||T);var r=t.parseTransformString(n),i=0,o=0,s=0,a=1,l=1,c=e._,h=new d;if(c.transform=r||[],r)for(var u=0,p=r.length;p>u;u++){var f,m,g,b,v,y=r[u],x=y.length,S=M(y[0]).toLowerCase(),w=y[0]!=S,E=w?h.invert():0;"t"==S&&3==x?w?(f=E.x(0,0),m=E.y(0,0),g=E.x(y[1],y[2]),b=E.y(y[1],y[2]),h.translate(g-f,b-m)):h.translate(y[1],y[2]):"r"==S?2==x?(v=v||e.getBBox(1),h.rotate(y[1],v.x+v.width/2,v.y+v.height/2),i+=y[1]):4==x&&(w?(g=E.x(y[2],y[3]),b=E.y(y[2],y[3]),h.rotate(y[1],g,b)):h.rotate(y[1],y[2],y[3]),i+=y[1]):"s"==S?2==x||3==x?(v=v||e.getBBox(1),h.scale(y[1],y[x-1],v.x+v.width/2,v.y+v.height/2),a*=y[1],l*=y[x-1]):5==x&&(w?(g=E.x(y[3],y[4]),b=E.y(y[3],y[4]),h.scale(y[1],y[2],g,b)):h.scale(y[1],y[2],y[3],y[4]),a*=y[1],l*=y[2]):"m"==S&&7==x&&h.add(y[1],y[2],y[3],y[4],y[5],y[6]),c.dirtyT=1,e.matrix=h}e.matrix=h,c.sx=a,c.sy=l,c.deg=i,c.dx=o=h.e,c.dy=s=h.f,1==a&&1==l&&!i&&c.bbox?(c.bbox.x+=+o,c.bbox.y+=+s):c.dirtyT=1}),Vt=function(t){var e=t[0];switch(e.toLowerCase()){case"t":return[e,0,0];case"m":return[e,1,0,0,1,0,0];case"r":return 4==t.length?[e,0,t[2],t[3]]:[e,0];case"s":return 5==t.length?[e,1,1,t[3],t[4]]:3==t.length?[e,1,1]:[e,1]}},jt=t._equaliseTransform=function(e,n){
n=M(n).replace(/\.{3}|\u2026/g,e),e=t.parseTransformString(e)||[],n=t.parseTransformString(n)||[];for(var r,i,o,s,a=V(e.length,n.length),l=[],c=[],h=0;a>h;h++){if(o=e[h]||Vt(n[h]),s=n[h]||Vt(o),o[0]!=s[0]||"r"==o[0].toLowerCase()&&(o[2]!=s[2]||o[3]!=s[3])||"s"==o[0].toLowerCase()&&(o[3]!=s[3]||o[4]!=s[4]))return;for(l[h]=[],c[h]=[],r=0,i=V(o.length,s.length);i>r;r++)r in o&&(l[h][r]=o[r]),r in s&&(c[h][r]=s[r])}return{from:l,to:c}};t._getContainer=function(e,n,r,i){var o;return o=null!=i||t.is(e,"object")?e:B.doc.getElementById(e),null!=o?o.tagName?null==n?{container:o,width:o.style.pixelWidth||o.offsetWidth,height:o.style.pixelHeight||o.offsetHeight}:{container:o,width:n,height:r}:{container:1,x:e,y:n,width:r,height:i}:void 0},t.pathToRelative=At,t._engine={},t.path2curve=Lt,t.matrix=function(t,e,n,r,i,o){return new d(t,e,n,r,i,o)},function(e){function n(t){return t[0]*t[0]+t[1]*t[1]}function r(t){var e=I.sqrt(n(t));t[0]&&(t[0]/=e),t[1]&&(t[1]/=e)}e.add=function(t,e,n,r,i,o){var s,a,l,c,h=[[],[],[]],u=[[this.a,this.c,this.e],[this.b,this.d,this.f],[0,0,1]],p=[[t,n,i],[e,r,o],[0,0,1]];for(t&&t instanceof d&&(p=[[t.a,t.c,t.e],[t.b,t.d,t.f],[0,0,1]]),s=0;3>s;s++)for(a=0;3>a;a++){for(c=0,l=0;3>l;l++)c+=u[s][l]*p[l][a];h[s][a]=c}this.a=h[0][0],this.b=h[1][0],this.c=h[0][1],this.d=h[1][1],this.e=h[0][2],this.f=h[1][2]},e.invert=function(){var t=this,e=t.a*t.d-t.b*t.c;return new d(t.d/e,-t.b/e,-t.c/e,t.a/e,(t.c*t.f-t.d*t.e)/e,(t.b*t.e-t.a*t.f)/e)},e.clone=function(){return new d(this.a,this.b,this.c,this.d,this.e,this.f)},e.translate=function(t,e){this.add(1,0,0,1,t,e)},e.scale=function(t,e,n,r){null==e&&(e=t),(n||r)&&this.add(1,0,0,1,n,r),this.add(t,0,0,e,0,0),(n||r)&&this.add(1,0,0,1,-n,-r)},e.rotate=function(e,n,r){e=t.rad(e),n=n||0,r=r||0;var i=+I.cos(e).toFixed(9),o=+I.sin(e).toFixed(9);this.add(i,o,-o,i,n,r),this.add(1,0,0,1,-n,-r)},e.x=function(t,e){return t*this.a+e*this.c+this.e},e.y=function(t,e){return t*this.b+e*this.d+this.f},e.get=function(t){return+this[M.fromCharCode(97+t)].toFixed(4)},e.toString=function(){return t.svg?"matrix("+[this.get(0),this.get(1),this.get(2),this.get(3),this.get(4),this.get(5)].join()+")":[this.get(0),this.get(2),this.get(1),this.get(3),0,0].join()},e.toFilter=function(){return"progid:DXImageTransform.Microsoft.Matrix(M11="+this.get(0)+", M12="+this.get(2)+", M21="+this.get(1)+", M22="+this.get(3)+", Dx="+this.get(4)+", Dy="+this.get(5)+", sizingmethod='auto expand')"},e.offset=function(){return[this.e.toFixed(4),this.f.toFixed(4)]},e.split=function(){var e={};e.dx=this.e,e.dy=this.f;var i=[[this.a,this.c],[this.b,this.d]];e.scalex=I.sqrt(n(i[0])),r(i[0]),e.shear=i[0][0]*i[1][0]+i[0][1]*i[1][1],i[1]=[i[1][0]-i[0][0]*e.shear,i[1][1]-i[0][1]*e.shear],e.scaley=I.sqrt(n(i[1])),r(i[1]),e.shear/=e.scaley;var o=-i[0][1],s=i[1][1];return 0>s?(e.rotate=t.deg(I.acos(s)),0>o&&(e.rotate=360-e.rotate)):e.rotate=t.deg(I.asin(o)),e.isSimple=!(+e.shear.toFixed(9)||e.scalex.toFixed(9)!=e.scaley.toFixed(9)&&e.rotate),e.isSuperSimple=!+e.shear.toFixed(9)&&e.scalex.toFixed(9)==e.scaley.toFixed(9)&&!e.rotate,e.noRotation=!+e.shear.toFixed(9)&&!e.rotate,e},e.toTransformString=function(t){var e=t||this[N]();return e.isSimple?(e.scalex=+e.scalex.toFixed(4),e.scaley=+e.scaley.toFixed(4),e.rotate=+e.rotate.toFixed(4),(e.dx||e.dy?"t"+[e.dx,e.dy]:T)+(1!=e.scalex||1!=e.scaley?"s"+[e.scalex,e.scaley,0,0]:T)+(e.rotate?"r"+[e.rotate,0,0]:T)):"m"+[this.get(0),this.get(1),this.get(2),this.get(3),this.get(4),this.get(5)]}}(d.prototype);var Gt=navigator.userAgent.match(/Version\/(.*?)\s/)||navigator.userAgent.match(/Chrome\/(\d+)/);"Apple Computer, Inc."==navigator.vendor&&(Gt&&Gt[1]<4||"iP"==navigator.platform.slice(0,2))||"Google Inc."==navigator.vendor&&Gt&&Gt[1]<8?y.safari=function(){var t=this.rect(-99,-99,this.width+99,this.height+99).attr({stroke:"none"});setTimeout(function(){t.remove()})}:y.safari=ht;for(var Ft=function(){this.returnValue=!1},Ht=function(){return this.originalEvent.preventDefault()},zt=function(){this.cancelBubble=!0},Ut=function(){return this.originalEvent.stopPropagation()},$t=function(){return B.doc.addEventListener?function(t,e,n,r){var i=O&&k[e]?k[e]:e,o=function(i){var o=B.doc.documentElement.scrollTop||B.doc.body.scrollTop,s=B.doc.documentElement.scrollLeft||B.doc.body.scrollLeft,a=i.clientX+s,l=i.clientY+o;if(O&&k[E](e))for(var c=0,h=i.targetTouches&&i.targetTouches.length;h>c;c++)if(i.targetTouches[c].target==t){var u=i;i=i.targetTouches[c],i.originalEvent=u,i.preventDefault=Ht,i.stopPropagation=Ut;break}return n.call(r,i,a,l)};return t.addEventListener(i,o,!1),function(){return t.removeEventListener(i,o,!1),!0}}:B.doc.attachEvent?function(t,e,n,r){var i=function(t){t=t||B.win.event;var e=B.doc.documentElement.scrollTop||B.doc.body.scrollTop,i=B.doc.documentElement.scrollLeft||B.doc.body.scrollLeft,o=t.clientX+i,s=t.clientY+e;return t.preventDefault=t.preventDefault||Ft,t.stopPropagation=t.stopPropagation||zt,n.call(r,t,o,s)};t.attachEvent("on"+e,i);var o=function(){return t.detachEvent("on"+e,i),!0};return o}:void 0}(),Yt=[],Wt=function(t){for(var e,n=t.clientX,r=t.clientY,i=B.doc.documentElement.scrollTop||B.doc.body.scrollTop,o=B.doc.documentElement.scrollLeft||B.doc.body.scrollLeft,s=Yt.length;s--;){if(e=Yt[s],O){for(var a,l=t.touches.length;l--;)if(a=t.touches[l],a.identifier==e.el._drag.id){n=a.clientX,r=a.clientY,(t.originalEvent?t.originalEvent:t).preventDefault();break}}else t.preventDefault();var c,h=e.el.node,u=h.nextSibling,d=h.parentNode,p=h.style.display;B.win.opera&&d.removeChild(h),h.style.display="none",c=e.el.paper.getElementByPoint(n,r),h.style.display=p,B.win.opera&&(u?d.insertBefore(h,u):d.appendChild(h)),c&&eve("raphael.drag.over."+e.el.id,e.el,c),n+=o,r+=i,eve("raphael.drag.move."+e.el.id,e.move_scope||e.el,n-e.el._drag.x,r-e.el._drag.y,n,r,t)}},qt=function(e){t.unmousemove(Wt).unmouseup(qt);for(var n,r=Yt.length;r--;)n=Yt[r],n.el._drag={},eve("raphael.drag.end."+n.el.id,n.end_scope||n.start_scope||n.move_scope||n.el,e);Yt=[]},Xt=t.el={},Kt=L.length;Kt--;)!function(e){t[e]=Xt[e]=function(n,r){return t.is(n,"function")&&(this.events=this.events||[],this.events.push({name:e,f:n,unbind:$t(this.shape||this.node||B.doc,e,n,r||this)})),this},t["un"+e]=Xt["un"+e]=function(t){for(var n=this.events||[],r=n.length;r--;)if(n[r].name==e&&n[r].f==t)return n[r].unbind(),n.splice(r,1),!n.length&&delete this.events,this;return this}}(L[Kt]);Xt.data=function(e,n){var r=lt[this.id]=lt[this.id]||{};if(1==arguments.length){if(t.is(e,"object")){for(var i in e)e[E](i)&&this.data(i,e[i]);return this}return eve("raphael.data.get."+this.id,this,r[e],e),r[e]}return r[e]=n,eve("raphael.data.set."+this.id,this,n,e),this},Xt.removeData=function(t){return null==t?lt[this.id]={}:lt[this.id]&&delete lt[this.id][t],this},Xt.hover=function(t,e,n,r){return this.mouseover(t,n).mouseout(e,r||n)},Xt.unhover=function(t,e){return this.unmouseover(t).unmouseout(e)};var Jt=[];Xt.drag=function(e,n,r,i,o,s){function a(a){(a.originalEvent||a).preventDefault();var l=B.doc.documentElement.scrollTop||B.doc.body.scrollTop,c=B.doc.documentElement.scrollLeft||B.doc.body.scrollLeft;this._drag.x=a.clientX+c,this._drag.y=a.clientY+l,this._drag.id=a.identifier,!Yt.length&&t.mousemove(Wt).mouseup(qt),Yt.push({el:this,move_scope:i,start_scope:o,end_scope:s}),n&&eve.on("raphael.drag.start."+this.id,n),e&&eve.on("raphael.drag.move."+this.id,e),r&&eve.on("raphael.drag.end."+this.id,r),eve("raphael.drag.start."+this.id,o||i||this,a.clientX+c,a.clientY+l,a)}return this._drag={},Jt.push({el:this,start:a}),this.mousedown(a),this},Xt.onDragOver=function(t){t?eve.on("raphael.drag.over."+this.id,t):eve.unbind("raphael.drag.over."+this.id)},Xt.undrag=function(){for(var e=Jt.length;e--;)Jt[e].el==this&&(this.unmousedown(Jt[e].start),Jt.splice(e,1),eve.unbind("raphael.drag.*."+this.id));!Jt.length&&t.unmousemove(Wt).unmouseup(qt)},y.circle=function(e,n,r){var i=t._engine.circle(this,e||0,n||0,r||0);return this.__set__&&this.__set__.push(i),i},y.rect=function(e,n,r,i,o){var s=t._engine.rect(this,e||0,n||0,r||0,i||0,o||0);return this.__set__&&this.__set__.push(s),s},y.ellipse=function(e,n,r,i){var o=t._engine.ellipse(this,e||0,n||0,r||0,i||0);return this.__set__&&this.__set__.push(o),o},y.path=function(e){e&&!t.is(e,U)&&!t.is(e[0],$)&&(e+=T);var n=t._engine.path(t.format[A](t,arguments),this);return this.__set__&&this.__set__.push(n),n},y.image=function(e,n,r,i,o){var s=t._engine.image(this,e||"about:blank",n||0,r||0,i||0,o||0);return this.__set__&&this.__set__.push(s),s},y.text=function(e,n,r){var i=t._engine.text(this,e||0,n||0,M(r));return this.__set__&&this.__set__.push(i),i},y.set=function(e){!t.is(e,"array")&&(e=Array.prototype.splice.call(arguments,0,arguments.length));var n=new ce(e);return this.__set__&&this.__set__.push(n),n},y.setStart=function(t){this.__set__=t||this.set()},y.setFinish=function(t){var e=this.__set__;return delete this.__set__,e},y.setSize=function(e,n){return t._engine.setSize.call(this,e,n)},y.setViewBox=function(e,n,r,i,o){return t._engine.setViewBox.call(this,e,n,r,i,o)},y.top=y.bottom=null,y.raphael=t;var Qt=function(t){var e=t.getBoundingClientRect(),n=t.ownerDocument,r=n.body,i=n.documentElement,o=i.clientTop||r.clientTop||0,s=i.clientLeft||r.clientLeft||0,a=e.top+(B.win.pageYOffset||i.scrollTop||r.scrollTop)-o,l=e.left+(B.win.pageXOffset||i.scrollLeft||r.scrollLeft)-s;return{y:a,x:l}};y.getElementByPoint=function(t,e){var n=this,r=n.canvas,i=B.doc.elementFromPoint(t,e);if(B.win.opera&&"svg"==i.tagName){var o=Qt(r),s=r.createSVGRect();s.x=t-o.x,s.y=e-o.y,s.width=s.height=1;var a=r.getIntersectionList(s,null);a.length&&(i=a[a.length-1])}if(!i)return null;for(;i.parentNode&&i!=r.parentNode&&!i.raphael;)i=i.parentNode;return i==n.canvas.parentNode&&(i=r),i=i&&i.raphael?n.getById(i.raphaelid):null},y.getById=function(t){for(var e=this.bottom;e;){if(e.id==t)return e;e=e.next}return null},y.forEach=function(t,e){for(var n=this.bottom;n;){if(t.call(e,n)===!1)return this;n=n.next}return this},y.getElementsByPoint=function(t,e){var n=this.set();return this.forEach(function(r){r.isPointInside(t,e)&&n.push(r)}),n},Xt.isPointInside=function(e,n){var r=this.realPath=this.realPath||ft[this.type](this);return t.isPointInsidePath(r,e,n)},Xt.getBBox=function(t){if(this.removed)return{};var e=this._;return t?((e.dirty||!e.bboxwt)&&(this.realPath=ft[this.type](this),e.bboxwt=Rt(this.realPath),e.bboxwt.toString=p,e.dirty=0),e.bboxwt):((e.dirty||e.dirtyT||!e.bbox)&&((e.dirty||!this.realPath)&&(e.bboxwt=0,this.realPath=ft[this.type](this)),e.bbox=Rt(mt(this.realPath,this.matrix)),e.bbox.toString=p,e.dirty=e.dirtyT=0),e.bbox)},Xt.clone=function(){if(this.removed)return null;var t=this.paper[this.type]().attr(this.attr());return this.__set__&&this.__set__.push(t),t},Xt.glow=function(t){if("text"==this.type)return null;t=t||{};var e={width:(t.width||10)+(+this.attr("stroke-width")||1),fill:t.fill||!1,opacity:t.opacity||.5,offsetx:t.offsetx||0,offsety:t.offsety||0,color:t.color||"#000"},n=e.width/2,r=this.paper,i=r.set(),o=this.realPath||ft[this.type](this);o=this.matrix?mt(o,this.matrix):o;for(var s=1;n+1>s;s++)i.push(r.path(o).attr({stroke:e.color,fill:e.fill?e.color:"none","stroke-linejoin":"round","stroke-linecap":"round","stroke-width":+(e.width/n*s).toFixed(3),opacity:+(e.opacity/n).toFixed(3)}));return i.insertBefore(this).translate(e.offsetx,e.offsety)};var Zt=function(e,n,r,i,o,s,c,h,u){return null==u?a(e,n,r,i,o,s,c,h):t.findDotsAtSegment(e,n,r,i,o,s,c,h,l(e,n,r,i,o,s,c,h,u))},te=function(e,n){return function(r,i,o){r=Lt(r);for(var s,a,l,c,h,u="",d={},p=0,f=0,m=r.length;m>f;f++){if(l=r[f],"M"==l[0])s=+l[1],a=+l[2];else{if(c=Zt(s,a,l[1],l[2],l[3],l[4],l[5],l[6]),p+c>i){if(n&&!d.start){if(h=Zt(s,a,l[1],l[2],l[3],l[4],l[5],l[6],i-p),u+=["C"+h.start.x,h.start.y,h.m.x,h.m.y,h.x,h.y],o)return u;d.start=u,u=["M"+h.x,h.y+"C"+h.n.x,h.n.y,h.end.x,h.end.y,l[5],l[6]].join(),p+=c,s=+l[5],a=+l[6];continue}if(!e&&!n)return h=Zt(s,a,l[1],l[2],l[3],l[4],l[5],l[6],i-p),{x:h.x,y:h.y,alpha:h.alpha}}p+=c,s=+l[5],a=+l[6]}u+=l.shift()+l}return d.end=u,h=e?p:n?d:t.findDotsAtSegment(s,a,l[0],l[1],l[2],l[3],l[4],l[5],1),h.alpha&&(h={x:h.x,y:h.y,alpha:h.alpha}),h}},ee=te(1),ne=te(),re=te(0,1);t.getTotalLength=ee,t.getPointAtLength=ne,t.getSubpath=function(t,e,n){if(this.getTotalLength(t)-n<1e-6)return re(t,e).end;var r=re(t,n,1);return e?re(r,e).end:r},Xt.getTotalLength=function(){return"path"==this.type?this.node.getTotalLength?this.node.getTotalLength():ee(this.attrs.path):void 0},Xt.getPointAtLength=function(t){return"path"==this.type?ne(this.attrs.path,t):void 0},Xt.getSubpath=function(e,n){return"path"==this.type?t.getSubpath(this.attrs.path,e,n):void 0};var ie=t.easing_formulas={linear:function(t){return t},"<":function(t){return F(t,1.7)},">":function(t){return F(t,.48)},"<>":function(t){var e=.48-t/1.04,n=I.sqrt(.1734+e*e),r=n-e,i=F(G(r),1/3)*(0>r?-1:1),o=-n-e,s=F(G(o),1/3)*(0>o?-1:1),a=i+s+.5;return 3*(1-a)*a*a+a*a*a},backIn:function(t){var e=1.70158;return t*t*((e+1)*t-e)},backOut:function(t){t-=1;var e=1.70158;return t*t*((e+1)*t+e)+1},elastic:function(t){return t==!!t?t:F(2,-10*t)*I.sin((t-.075)*(2*H)/.3)+1},bounce:function(t){var e,n=7.5625,r=2.75;return 1/r>t?e=n*t*t:2/r>t?(t-=1.5/r,e=n*t*t+.75):2.5/r>t?(t-=2.25/r,e=n*t*t+.9375):(t-=2.625/r,e=n*t*t+.984375),e}};ie.easeIn=ie["ease-in"]=ie["<"],ie.easeOut=ie["ease-out"]=ie[">"],ie.easeInOut=ie["ease-in-out"]=ie["<>"],ie["back-in"]=ie.backIn,ie["back-out"]=ie.backOut;var oe=[],se=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){setTimeout(t,16)},ae=function(){for(var e=+new Date,n=0;n<oe.length;n++){var r=oe[n];if(!r.el.removed&&!r.paused){var i,o,s=e-r.start,a=r.ms,l=r.easing,c=r.from,h=r.diff,u=r.to,d=(r.t,r.el),p={},f={};if(r.initstatus?(s=(r.initstatus*r.anim.top-r.prev)/(r.percent-r.prev)*a,r.status=r.initstatus,delete r.initstatus,r.stop&&oe.splice(n--,1)):r.status=(r.prev+(r.percent-r.prev)*(s/a))/r.anim.top,!(0>s))if(a>s){var m=l(s/a);for(var b in c)if(c[E](b)){switch(et[b]){case z:i=+c[b]+m*a*h[b];break;case"colour":i="rgb("+[le(K(c[b].r+m*a*h[b].r)),le(K(c[b].g+m*a*h[b].g)),le(K(c[b].b+m*a*h[b].b))].join(",")+")";break;case"path":i=[];for(var v=0,y=c[b].length;y>v;v++){i[v]=[c[b][v][0]];for(var x=1,S=c[b][v].length;S>x;x++)i[v][x]=+c[b][v][x]+m*a*h[b][v][x];i[v]=i[v].join(P)}i=i.join(P);break;case"transform":if(h[b].real)for(i=[],v=0,y=c[b].length;y>v;v++)for(i[v]=[c[b][v][0]],x=1,S=c[b][v].length;S>x;x++)i[v][x]=c[b][v][x]+m*a*h[b][v][x];else{var w=function(t){return+c[b][t]+m*a*h[b][t]};i=[["m",w(0),w(1),w(2),w(3),w(4),w(5)]]}break;case"csv":if("clip-rect"==b)for(i=[],v=4;v--;)i[v]=+c[b][v]+m*a*h[b][v];break;default:var B=[][_](c[b]);for(i=[],v=d.paper.customAttributes[b].length;v--;)i[v]=+B[v]+m*a*h[b][v]}p[b]=i}d.attr(p),function(t,e,n){setTimeout(function(){eve("raphael.anim.frame."+t,e,n)})}(d.id,d,r.anim)}else{if(function(e,n,r){setTimeout(function(){eve("raphael.anim.frame."+n.id,n,r),eve("raphael.anim.finish."+n.id,n,r),t.is(e,"function")&&e.call(n)})}(r.callback,d,r.anim),d.attr(u),oe.splice(n--,1),r.repeat>1&&!r.next){for(o in u)u[E](o)&&(f[o]=r.totalOrigin[o]);r.el.attr(f),g(r.anim,r.el,r.anim.percents[0],null,r.totalOrigin,r.repeat-1)}r.next&&!r.stop&&g(r.anim,r.el,r.next,null,r.totalOrigin,r.repeat)}}}t.svg&&d&&d.paper&&d.paper.safari(),oe.length&&se(ae)},le=function(t){return t>255?255:0>t?0:t};Xt.animateWith=function(e,n,r,i,o,s){var a=this;if(a.removed)return s&&s.call(a),a;var l=r instanceof m?r:t.animation(r,i,o,s);g(l,a,l.percents[0],null,a.attr());for(var c=0,h=oe.length;h>c;c++)if(oe[c].anim==n&&oe[c].el==e){oe[h-1].start=oe[c].start;break}return a},Xt.onAnimation=function(t){return t?eve.on("raphael.anim.frame."+this.id,t):eve.unbind("raphael.anim.frame."+this.id),this},m.prototype.delay=function(t){var e=new m(this.anim,this.ms);return e.times=this.times,e.del=+t||0,e},m.prototype.repeat=function(t){var e=new m(this.anim,this.ms);return e.del=this.del,e.times=I.floor(V(t,0))||1,e},t.animation=function(e,n,r,i){if(e instanceof m)return e;(t.is(r,"function")||!r)&&(i=i||r||null,r=null),e=Object(e),n=+n||0;var o,s,a={};for(s in e)e[E](s)&&J(s)!=s&&J(s)+"%"!=s&&(o=!0,a[s]=e[s]);return o?(r&&(a.easing=r),i&&(a.callback=i),new m({100:a},n)):new m(e,n)},Xt.animate=function(e,n,r,i){var o=this;if(o.removed)return i&&i.call(o),o;var s=e instanceof m?e:t.animation(e,n,r,i);return g(s,o,s.percents[0],null,o.attr()),o},Xt.setTime=function(t,e){return t&&null!=e&&this.status(t,j(e,t.ms)/t.ms),this},Xt.status=function(t,e){var n,r,i=[],o=0;if(null!=e)return g(t,this,-1,j(e,1)),this;for(n=oe.length;n>o;o++)if(r=oe[o],r.el.id==this.id&&(!t||r.anim==t)){if(t)return r.status;i.push({anim:r.anim,status:r.status})}return t?0:i},Xt.pause=function(t){for(var e=0;e<oe.length;e++)oe[e].el.id!=this.id||t&&oe[e].anim!=t||eve("raphael.anim.pause."+this.id,this,oe[e].anim)!==!1&&(oe[e].paused=!0);return this},Xt.resume=function(t){for(var e=0;e<oe.length;e++)if(oe[e].el.id==this.id&&(!t||oe[e].anim==t)){var n=oe[e];eve("raphael.anim.resume."+this.id,this,n.anim)!==!1&&(delete n.paused,this.status(n.anim,n.status))}return this},Xt.stop=function(t){for(var e=0;e<oe.length;e++)oe[e].el.id!=this.id||t&&oe[e].anim!=t||eve("raphael.anim.stop."+this.id,this,oe[e].anim)!==!1&&oe.splice(e--,1);return this},eve.on("raphael.remove",b),eve.on("raphael.clear",b),Xt.toString=function(){return"Raphaël’s object"};var ce=function(t){if(this.items=[],this.length=0,this.type="set",t)for(var e=0,n=t.length;n>e;e++)!t[e]||t[e].constructor!=Xt.constructor&&t[e].constructor!=ce||(this[this.items.length]=this.items[this.items.length]=t[e],this.length++)},he=ce.prototype;he.push=function(){for(var t,e,n=0,r=arguments.length;r>n;n++)t=arguments[n],!t||t.constructor!=Xt.constructor&&t.constructor!=ce||(e=this.items.length,this[e]=this.items[e]=t,this.length++);return this},he.pop=function(){return this.length&&delete this[this.length--],this.items.pop()},he.forEach=function(t,e){for(var n=0,r=this.items.length;r>n;n++)if(t.call(e,this.items[n],n)===!1)return this;return this};for(var ue in Xt)Xt[E](ue)&&(he[ue]=function(t){return function(){var e=arguments;return this.forEach(function(n){n[t][A](n,e)})}}(ue));he.attr=function(e,n){if(e&&t.is(e,$)&&t.is(e[0],"object"))for(var r=0,i=e.length;i>r;r++)this.items[r].attr(e[r]);else for(var o=0,s=this.items.length;s>o;o++)this.items[o].attr(e,n);return this},he.clear=function(){for(;this.length;)this.pop()},he.splice=function(t,e,n){t=0>t?V(this.length+t,0):t,e=V(0,j(this.length-t,e));var r,i=[],o=[],s=[];for(r=2;r<arguments.length;r++)s.push(arguments[r]);for(r=0;e>r;r++)o.push(this[t+r]);for(;r<this.length-t;r++)i.push(this[t+r]);var a=s.length;for(r=0;r<a+i.length;r++)this.items[t+r]=this[t+r]=a>r?s[r]:i[r-a];for(r=this.items.length=this.length-=e-a;this[r];)delete this[r++];return new ce(o)},he.exclude=function(t){for(var e=0,n=this.length;n>e;e++)if(this[e]==t)return this.splice(e,1),!0},he.animate=function(e,n,r,i){(t.is(r,"function")||!r)&&(i=r||null);var o,s,a=this.items.length,l=a,c=this;if(!a)return this;i&&(s=function(){!--a&&i.call(c)}),r=t.is(r,U)?r:s;var h=t.animation(e,n,r,s);for(o=this.items[--l].animate(h);l--;)this.items[l]&&!this.items[l].removed&&this.items[l].animateWith(o,h,h);return this},he.insertAfter=function(t){for(var e=this.items.length;e--;)this.items[e].insertAfter(t);return this},he.getBBox=function(){for(var t=[],e=[],n=[],r=[],i=this.items.length;i--;)if(!this.items[i].removed){var o=this.items[i].getBBox();t.push(o.x),e.push(o.y),n.push(o.x+o.width),r.push(o.y+o.height)}return t=j[A](0,t),e=j[A](0,e),n=V[A](0,n),r=V[A](0,r),{x:t,y:e,x2:n,y2:r,width:n-t,height:r-e}},he.clone=function(t){t=new ce;for(var e=0,n=this.items.length;n>e;e++)t.push(this.items[e].clone());return t},he.toString=function(){return"Raphaël‘s set"},t.registerFont=function(t){if(!t.face)return t;this.fonts=this.fonts||{};var e={w:t.w,face:{},glyphs:{}},n=t.face["font-family"];for(var r in t.face)t.face[E](r)&&(e.face[r]=t.face[r]);if(this.fonts[n]?this.fonts[n].push(e):this.fonts[n]=[e],!t.svg){e.face["units-per-em"]=Q(t.face["units-per-em"],10);for(var i in t.glyphs)if(t.glyphs[E](i)){var o=t.glyphs[i];if(e.glyphs[i]={w:o.w,k:{},d:o.d&&"M"+o.d.replace(/[mlcxtrv]/g,function(t){return{l:"L",c:"C",x:"z",t:"m",r:"l",v:"c"}[t]||"M"})+"z"},o.k)for(var s in o.k)o[E](s)&&(e.glyphs[i].k[s]=o.k[s])}}return t},y.getFont=function(e,n,r,i){if(i=i||"normal",r=r||"normal",n=+n||{normal:400,bold:700,lighter:300,bolder:800}[n]||400,t.fonts){var o=t.fonts[e];if(!o){var s=new RegExp("(^|\\s)"+e.replace(/[^\w\d\s+!~.:_-]/g,T)+"(\\s|$)","i");for(var a in t.fonts)if(t.fonts[E](a)&&s.test(a)){o=t.fonts[a];break}}var l;if(o)for(var c=0,h=o.length;h>c&&(l=o[c],l.face["font-weight"]!=n||l.face["font-style"]!=r&&l.face["font-style"]||l.face["font-stretch"]!=i);c++);return l}},y.print=function(e,n,r,i,o,s,a){s=s||"middle",a=V(j(a||0,1),-1);var l,c=M(r)[N](T),h=0,u=0,d=T;if(t.is(i,r)&&(i=this.getFont(i)),i){l=(o||16)/i.face["units-per-em"];for(var p=i.face.bbox[N](x),f=+p[0],m=p[3]-p[1],g=0,b=+p[1]+("baseline"==s?m+ +i.face.descent:m/2),v=0,y=c.length;y>v;v++){if("\n"==c[v])h=0,w=0,u=0,g+=m;else{var S=u&&i.glyphs[c[v-1]]||{},w=i.glyphs[c[v]];h+=u?(S.w||i.w)+(S.k&&S.k[c[v]]||0)+i.w*a:0,u=1}w&&w.d&&(d+=t.transformPath(w.d,["t",h*l,g*l,"s",l,l,f,b,"t",(e-f)/l,(n-b)/l]))}}return this.path(d).attr({fill:"#000",stroke:"none"})},y.add=function(e){if(t.is(e,"array"))for(var n,r=this.set(),i=0,o=e.length;o>i;i++)n=e[i]||{},S[E](n.type)&&r.push(this[n.type]().attr(n));return r},t.format=function(e,n){var r=t.is(n,$)?[0][_](n):arguments;return e&&t.is(e,U)&&r.length-1&&(e=e.replace(w,function(t,e){return null==r[++e]?T:r[e]})),e||T},t.fullfill=function(){var t=/\{([^\}]+)\}/g,e=/(?:(?:^|\.)(.+?)(?=\[|\.|$|\()|\[('|")(.+?)\2\])(\(\))?/g,n=function(t,n,r){var i=r;return n.replace(e,function(t,e,n,r,o){e=e||r,i&&(e in i&&(i=i[e]),"function"==typeof i&&o&&(i=i()))}),i=(null==i||i==r?t:i)+""};return function(e,r){return String(e).replace(t,function(t,e){return n(t,e,r)})}}(),t.ninja=function(){return R.was?B.win.Raphael=R.is:delete Raphael,t},t.st=he,function(e,n,r){function i(){/in/.test(e.readyState)?setTimeout(i,9):t.eve("raphael.DOMload")}null==e.readyState&&e.addEventListener&&(e.addEventListener(n,r=function(){e.removeEventListener(n,r,!1),e.readyState="complete"},!1),e.readyState="loading"),i()}(document,"DOMContentLoaded"),R.was?B.win.Raphael=t:Raphael=t,eve.on("raphael.DOMload",function(){v=!0})}(),window.Raphael.svg&&function(t){var e="hasOwnProperty",n=String,r=parseFloat,i=parseInt,o=Math,s=o.max,a=o.abs,l=o.pow,c=/[, ]+/,h=t.eve,u="",d=" ",p="http://www.w3.org/1999/xlink",f={block:"M5,0 0,2.5 5,5z",classic:"M5,0 0,2.5 5,5 3.5,3 3.5,2z",diamond:"M2.5,0 5,2.5 2.5,5 0,2.5z",open:"M6,1 1,3.5 6,6",oval:"M2.5,0A2.5,2.5,0,0,1,2.5,5 2.5,2.5,0,0,1,2.5,0z"},m={};t.toString=function(){return"Your browser supports SVG.\nYou are running Raphaël "+this.version};var g=function(r,i){if(i){"string"==typeof r&&(r=g(r));for(var o in i)i[e](o)&&("xlink:"==o.substring(0,6)?r.setAttributeNS(p,o.substring(6),n(i[o])):r.setAttribute(o,n(i[o])))}else r=t._g.doc.createElementNS("http://www.w3.org/2000/svg",r),r.style&&(r.style.webkitTapHighlightColor="rgba(0,0,0,0)");return r},b=function(e,i){var c="linear",h=e.id+i,d=.5,p=.5,f=e.node,m=e.paper,b=f.style,v=t._g.doc.getElementById(h);if(!v){if(i=n(i).replace(t._radial_gradient,function(t,e,n){if(c="radial",e&&n){d=r(e),p=r(n);var i=2*(p>.5)-1;l(d-.5,2)+l(p-.5,2)>.25&&(p=o.sqrt(.25-l(d-.5,2))*i+.5)&&.5!=p&&(p=p.toFixed(5)-1e-5*i)}return u}),i=i.split(/\s*\-\s*/),"linear"==c){var y=i.shift();if(y=-r(y),isNaN(y))return null;var x=[0,0,o.cos(t.rad(y)),o.sin(t.rad(y))],S=1/(s(a(x[2]),a(x[3]))||1);x[2]*=S,x[3]*=S,x[2]<0&&(x[0]=-x[2],x[2]=0),x[3]<0&&(x[1]=-x[3],x[3]=0)}var w=t._parseDots(i);if(!w)return null;if(h=h.replace(/[\(\)\s,\xb0#]/g,"_"),e.gradient&&h!=e.gradient.id&&(m.defs.removeChild(e.gradient),delete e.gradient),!e.gradient){v=g(c+"Gradient",{id:h}),e.gradient=v,g(v,"radial"==c?{fx:d,fy:p}:{x1:x[0],y1:x[1],x2:x[2],y2:x[3],gradientTransform:e.matrix.invert()}),m.defs.appendChild(v);for(var E=0,B=w.length;B>E;E++)v.appendChild(g("stop",{offset:w[E].offset?w[E].offset:E?"100%":"0%","stop-color":w[E].color||"#fff"}))}}return g(f,{fill:"url(#"+h+")",opacity:1,"fill-opacity":1}),b.fill=u,b.opacity=1,b.fillOpacity=1,1},v=function(t){var e=t.getBBox(1);g(t.pattern,{patternTransform:t.matrix.invert()+" translate("+e.x+","+e.y+")"})},y=function(r,i,o){if("path"==r.type){for(var s,a,l,c,h,d=n(i).toLowerCase().split("-"),p=r.paper,b=o?"end":"start",v=r.node,y=r.attrs,x=y["stroke-width"],S=d.length,w="classic",E=3,B=3,R=5;S--;)switch(d[S]){case"block":case"classic":case"oval":case"diamond":case"open":case"none":w=d[S];break;case"wide":B=5;break;case"narrow":B=2;break;case"long":E=5;break;case"short":E=2}if("open"==w?(E+=2,B+=2,R+=2,l=1,c=o?4:1,h={fill:"none",stroke:y.stroke}):(c=l=E/2,h={fill:y.stroke,stroke:"none"}),r._.arrows?o?(r._.arrows.endPath&&m[r._.arrows.endPath]--,r._.arrows.endMarker&&m[r._.arrows.endMarker]--):(r._.arrows.startPath&&m[r._.arrows.startPath]--,r._.arrows.startMarker&&m[r._.arrows.startMarker]--):r._.arrows={},"none"!=w){var C="raphael-marker-"+w,A="raphael-marker-"+b+w+E+B;t._g.doc.getElementById(C)?m[C]++:(p.defs.appendChild(g(g("path"),{"stroke-linecap":"round",d:f[w],id:C})),m[C]=1);var _,O=t._g.doc.getElementById(A);O?(m[A]++,_=O.getElementsByTagName("use")[0]):(O=g(g("marker"),{id:A,markerHeight:B,markerWidth:E,orient:"auto",refX:c,refY:B/2}),_=g(g("use"),{"xlink:href":"#"+C,transform:(o?"rotate(180 "+E/2+" "+B/2+") ":u)+"scale("+E/R+","+B/R+")","stroke-width":(1/((E/R+B/R)/2)).toFixed(4)}),O.appendChild(_),p.defs.appendChild(O),m[A]=1),g(_,h);var T=l*("diamond"!=w&&"oval"!=w);o?(s=r._.arrows.startdx*x||0,a=t.getTotalLength(y.path)-T*x):(s=T*x,a=t.getTotalLength(y.path)-(r._.arrows.enddx*x||0)),h={},h["marker-"+b]="url(#"+A+")",(a||s)&&(h.d=Raphael.getSubpath(y.path,s,a)),g(v,h),r._.arrows[b+"Path"]=C,r._.arrows[b+"Marker"]=A,r._.arrows[b+"dx"]=T,r._.arrows[b+"Type"]=w,r._.arrows[b+"String"]=i}else o?(s=r._.arrows.startdx*x||0,a=t.getTotalLength(y.path)-s):(s=0,a=t.getTotalLength(y.path)-(r._.arrows.enddx*x||0)),r._.arrows[b+"Path"]&&g(v,{d:Raphael.getSubpath(y.path,s,a)}),delete r._.arrows[b+"Path"],delete r._.arrows[b+"Marker"],delete r._.arrows[b+"dx"],delete r._.arrows[b+"Type"],delete r._.arrows[b+"String"];for(h in m)if(m[e](h)&&!m[h]){var P=t._g.doc.getElementById(h);P&&P.parentNode.removeChild(P)}}},x={"":[0],none:[0],"-":[3,1],".":[1,1],"-.":[3,1,1,1],"-..":[3,1,1,1,1,1],". ":[1,3],"- ":[4,3],"--":[8,3],"- .":[4,3,1,3],"--.":[8,3,1,3],"--..":[8,3,1,3,1,3]},S=function(t,e,r){if(e=x[n(e).toLowerCase()]){for(var i=t.attrs["stroke-width"]||"1",o={round:i,square:i,butt:0}[t.attrs["stroke-linecap"]||r["stroke-linecap"]]||0,s=[],a=e.length;a--;)s[a]=e[a]*i+(a%2?1:-1)*o;g(t.node,{"stroke-dasharray":s.join(",")})}},w=function(r,o){var l=r.node,h=r.attrs,d=l.style.visibility;l.style.visibility="hidden";for(var f in o)if(o[e](f)){if(!t._availableAttrs[e](f))continue;var m=o[f];switch(h[f]=m,f){case"blur":r.blur(m);break;case"href":case"title":case"target":var x=l.parentNode;if("a"!=x.tagName.toLowerCase()){var w=g("a");x.insertBefore(w,l),w.appendChild(l),x=w}"target"==f?x.setAttributeNS(p,"show","blank"==m?"new":m):x.setAttributeNS(p,f,m);break;case"cursor":l.style.cursor=m;break;case"transform":r.transform(m);break;case"arrow-start":y(r,m);break;case"arrow-end":y(r,m,1);break;case"clip-rect":var E=n(m).split(c);if(4==E.length){r.clip&&r.clip.parentNode.parentNode.removeChild(r.clip.parentNode);var R=g("clipPath"),C=g("rect");R.id=t.createUUID(),g(C,{x:E[0],y:E[1],width:E[2],height:E[3]}),R.appendChild(C),r.paper.defs.appendChild(R),g(l,{"clip-path":"url(#"+R.id+")"}),r.clip=C}if(!m){var A=l.getAttribute("clip-path");if(A){var _=t._g.doc.getElementById(A.replace(/(^url\(#|\)$)/g,u));_&&_.parentNode.removeChild(_),g(l,{"clip-path":u}),delete r.clip}}break;case"path":"path"==r.type&&(g(l,{d:m?h.path=t._pathToAbsolute(m):"M0,0"}),r._.dirty=1,r._.arrows&&("startString"in r._.arrows&&y(r,r._.arrows.startString),"endString"in r._.arrows&&y(r,r._.arrows.endString,1)));break;case"width":if(l.setAttribute(f,m),r._.dirty=1,!h.fx)break;f="x",m=h.x;case"x":h.fx&&(m=-h.x-(h.width||0));case"rx":if("rx"==f&&"rect"==r.type)break;case"cx":l.setAttribute(f,m),r.pattern&&v(r),r._.dirty=1;break;case"height":if(l.setAttribute(f,m),r._.dirty=1,!h.fy)break;f="y",m=h.y;case"y":h.fy&&(m=-h.y-(h.height||0));case"ry":if("ry"==f&&"rect"==r.type)break;case"cy":l.setAttribute(f,m),r.pattern&&v(r),r._.dirty=1;break;case"r":"rect"==r.type?g(l,{rx:m,ry:m}):l.setAttribute(f,m),r._.dirty=1;break;case"src":"image"==r.type&&l.setAttributeNS(p,"href",m);break;case"stroke-width":(1!=r._.sx||1!=r._.sy)&&(m/=s(a(r._.sx),a(r._.sy))||1),r.paper._vbSize&&(m*=r.paper._vbSize),l.setAttribute(f,m),h["stroke-dasharray"]&&S(r,h["stroke-dasharray"],o),r._.arrows&&("startString"in r._.arrows&&y(r,r._.arrows.startString),"endString"in r._.arrows&&y(r,r._.arrows.endString,1));break;case"stroke-dasharray":S(r,m,o);break;case"fill":var O=n(m).match(t._ISURL);if(O){R=g("pattern");var T=g("image");R.id=t.createUUID(),g(R,{x:0,y:0,patternUnits:"userSpaceOnUse",height:1,width:1}),g(T,{x:0,y:0,"xlink:href":O[1]}),R.appendChild(T),function(e){t._preload(O[1],function(){var t=this.offsetWidth,n=this.offsetHeight;g(e,{width:t,height:n}),g(T,{width:t,height:n}),r.paper.safari()})}(R),r.paper.defs.appendChild(R),g(l,{fill:"url(#"+R.id+")"}),r.pattern=R,r.pattern&&v(r);break}var P=t.getRGB(m);if(P.error){if(("circle"==r.type||"ellipse"==r.type||"r"!=n(m).charAt())&&b(r,m)){if("opacity"in h||"fill-opacity"in h){var M=t._g.doc.getElementById(l.getAttribute("fill").replace(/^url\(#|\)$/g,u));if(M){var N=M.getElementsByTagName("stop");g(N[N.length-1],{"stop-opacity":("opacity"in h?h.opacity:1)*("fill-opacity"in h?h["fill-opacity"]:1)})}}h.gradient=m,h.fill="none";break}}else delete o.gradient,delete h.gradient,!t.is(h.opacity,"undefined")&&t.is(o.opacity,"undefined")&&g(l,{opacity:h.opacity}),!t.is(h["fill-opacity"],"undefined")&&t.is(o["fill-opacity"],"undefined")&&g(l,{"fill-opacity":h["fill-opacity"]});P[e]("opacity")&&g(l,{"fill-opacity":P.opacity>1?P.opacity/100:P.opacity});case"stroke":P=t.getRGB(m),l.setAttribute(f,P.hex),"stroke"==f&&P[e]("opacity")&&g(l,{"stroke-opacity":P.opacity>1?P.opacity/100:P.opacity}),"stroke"==f&&r._.arrows&&("startString"in r._.arrows&&y(r,r._.arrows.startString),"endString"in r._.arrows&&y(r,r._.arrows.endString,1));break;case"gradient":("circle"==r.type||"ellipse"==r.type||"r"!=n(m).charAt())&&b(r,m);break;case"opacity":h.gradient&&!h[e]("stroke-opacity")&&g(l,{"stroke-opacity":m>1?m/100:m});case"fill-opacity":if(h.gradient){M=t._g.doc.getElementById(l.getAttribute("fill").replace(/^url\(#|\)$/g,u)),M&&(N=M.getElementsByTagName("stop"),g(N[N.length-1],{"stop-opacity":m}));break}default:"font-size"==f&&(m=i(m,10)+"px");var L=f.replace(/(\-.)/g,function(t){return t.substring(1).toUpperCase()});l.style[L]=m,r._.dirty=1,l.setAttribute(f,m)}}B(r,o),l.style.visibility=d},E=1.2,B=function(r,o){if("text"==r.type&&(o[e]("text")||o[e]("font")||o[e]("font-size")||o[e]("x")||o[e]("y"))){var s=r.attrs,a=r.node,l=a.firstChild?i(t._g.doc.defaultView.getComputedStyle(a.firstChild,u).getPropertyValue("font-size"),10):10;if(o[e]("text")){for(s.text=o.text;a.firstChild;)a.removeChild(a.firstChild);for(var c,h=n(o.text).split("\n"),d=[],p=0,f=h.length;f>p;p++)c=g("tspan"),p&&g(c,{dy:l*E,x:s.x}),c.appendChild(t._g.doc.createTextNode(h[p])),a.appendChild(c),d[p]=c}else for(d=a.getElementsByTagName("tspan"),p=0,f=d.length;f>p;p++)p?g(d[p],{dy:l*E,x:s.x}):g(d[0],{dy:0});g(a,{x:s.x,y:s.y}),r._.dirty=1;var m=r._getBBox(),b=s.y-(m.y+m.height/2);b&&t.is(b,"finite")&&g(d[0],{dy:b})}},R=function(e,n){this[0]=this.node=e,e.raphael=!0,this.id=t._oid++,
e.raphaelid=this.id,this.matrix=t.matrix(),this.realPath=null,this.paper=n,this.attrs=this.attrs||{},this._={transform:[],sx:1,sy:1,deg:0,dx:0,dy:0,dirty:1},!n.bottom&&(n.bottom=this),this.prev=n.top,n.top&&(n.top.next=this),n.top=this,this.next=null},C=t.el;R.prototype=C,C.constructor=R,t._engine.path=function(t,e){var n=g("path");e.canvas&&e.canvas.appendChild(n);var r=new R(n,e);return r.type="path",w(r,{fill:"none",stroke:"#000",path:t}),r},C.rotate=function(t,e,i){if(this.removed)return this;if(t=n(t).split(c),t.length-1&&(e=r(t[1]),i=r(t[2])),t=r(t[0]),null==i&&(e=i),null==e||null==i){var o=this.getBBox(1);e=o.x+o.width/2,i=o.y+o.height/2}return this.transform(this._.transform.concat([["r",t,e,i]])),this},C.scale=function(t,e,i,o){if(this.removed)return this;if(t=n(t).split(c),t.length-1&&(e=r(t[1]),i=r(t[2]),o=r(t[3])),t=r(t[0]),null==e&&(e=t),null==o&&(i=o),null==i||null==o)var s=this.getBBox(1);return i=null==i?s.x+s.width/2:i,o=null==o?s.y+s.height/2:o,this.transform(this._.transform.concat([["s",t,e,i,o]])),this},C.translate=function(t,e){return this.removed?this:(t=n(t).split(c),t.length-1&&(e=r(t[1])),t=r(t[0])||0,e=+e||0,this.transform(this._.transform.concat([["t",t,e]])),this)},C.transform=function(n){var r=this._;if(null==n)return r.transform;if(t._extractTransform(this,n),this.clip&&g(this.clip,{transform:this.matrix.invert()}),this.pattern&&v(this),this.node&&g(this.node,{transform:this.matrix}),1!=r.sx||1!=r.sy){var i=this.attrs[e]("stroke-width")?this.attrs["stroke-width"]:1;this.attr({"stroke-width":i})}return this},C.hide=function(){return!this.removed&&this.paper.safari(this.node.style.display="none"),this},C.show=function(){return!this.removed&&this.paper.safari(this.node.style.display=""),this},C.remove=function(){if(!this.removed&&this.node.parentNode){var e=this.paper;e.__set__&&e.__set__.exclude(this),h.unbind("raphael.*.*."+this.id),this.gradient&&e.defs.removeChild(this.gradient),t._tear(this,e),"a"==this.node.parentNode.tagName.toLowerCase()?this.node.parentNode.parentNode.removeChild(this.node.parentNode):this.node.parentNode.removeChild(this.node);for(var n in this)this[n]="function"==typeof this[n]?t._removedFactory(n):null;this.removed=!0}},C._getBBox=function(){if("none"==this.node.style.display){this.show();var t=!0}var e={};try{e=this.node.getBBox()}catch(n){}finally{e=e||{}}return t&&this.hide(),e},C.attr=function(n,r){if(this.removed)return this;if(null==n){var i={};for(var o in this.attrs)this.attrs[e](o)&&(i[o]=this.attrs[o]);return i.gradient&&"none"==i.fill&&(i.fill=i.gradient)&&delete i.gradient,i.transform=this._.transform,i}if(null==r&&t.is(n,"string")){if("fill"==n&&"none"==this.attrs.fill&&this.attrs.gradient)return this.attrs.gradient;if("transform"==n)return this._.transform;for(var s=n.split(c),a={},l=0,u=s.length;u>l;l++)n=s[l],n in this.attrs?a[n]=this.attrs[n]:t.is(this.paper.customAttributes[n],"function")?a[n]=this.paper.customAttributes[n].def:a[n]=t._availableAttrs[n];return u-1?a:a[s[0]]}if(null==r&&t.is(n,"array")){for(a={},l=0,u=n.length;u>l;l++)a[n[l]]=this.attr(n[l]);return a}if(null!=r){var d={};d[n]=r}else null!=n&&t.is(n,"object")&&(d=n);for(var p in d)h("raphael.attr."+p+"."+this.id,this,d[p]);for(p in this.paper.customAttributes)if(this.paper.customAttributes[e](p)&&d[e](p)&&t.is(this.paper.customAttributes[p],"function")){var f=this.paper.customAttributes[p].apply(this,[].concat(d[p]));this.attrs[p]=d[p];for(var m in f)f[e](m)&&(d[m]=f[m])}return w(this,d),this},C.toFront=function(){if(this.removed)return this;"a"==this.node.parentNode.tagName.toLowerCase()?this.node.parentNode.parentNode.appendChild(this.node.parentNode):this.node.parentNode.appendChild(this.node);var e=this.paper;return e.top!=this&&t._tofront(this,e),this},C.toBack=function(){if(this.removed)return this;var e=this.node.parentNode;"a"==e.tagName.toLowerCase()?e.parentNode.insertBefore(this.node.parentNode,this.node.parentNode.parentNode.firstChild):e.firstChild!=this.node&&e.insertBefore(this.node,this.node.parentNode.firstChild),t._toback(this,this.paper);this.paper;return this},C.insertAfter=function(e){if(this.removed)return this;var n=e.node||e[e.length-1].node;return n.nextSibling?n.parentNode.insertBefore(this.node,n.nextSibling):n.parentNode.appendChild(this.node),t._insertafter(this,e,this.paper),this},C.insertBefore=function(e){if(this.removed)return this;var n=e.node||e[0].node;return n.parentNode.insertBefore(this.node,n),t._insertbefore(this,e,this.paper),this},C.blur=function(e){var n=this;if(0!==+e){var r=g("filter"),i=g("feGaussianBlur");n.attrs.blur=e,r.id=t.createUUID(),g(i,{stdDeviation:+e||1.5}),r.appendChild(i),n.paper.defs.appendChild(r),n._blur=r,g(n.node,{filter:"url(#"+r.id+")"})}else n._blur&&(n._blur.parentNode.removeChild(n._blur),delete n._blur,delete n.attrs.blur),n.node.removeAttribute("filter")},t._engine.circle=function(t,e,n,r){var i=g("circle");t.canvas&&t.canvas.appendChild(i);var o=new R(i,t);return o.attrs={cx:e,cy:n,r:r,fill:"none",stroke:"#000"},o.type="circle",g(i,o.attrs),o},t._engine.rect=function(t,e,n,r,i,o){var s=g("rect");t.canvas&&t.canvas.appendChild(s);var a=new R(s,t);return a.attrs={x:e,y:n,width:r,height:i,r:o||0,rx:o||0,ry:o||0,fill:"none",stroke:"#000"},a.type="rect",g(s,a.attrs),a},t._engine.ellipse=function(t,e,n,r,i){var o=g("ellipse");t.canvas&&t.canvas.appendChild(o);var s=new R(o,t);return s.attrs={cx:e,cy:n,rx:r,ry:i,fill:"none",stroke:"#000"},s.type="ellipse",g(o,s.attrs),s},t._engine.image=function(t,e,n,r,i,o){var s=g("image");g(s,{x:n,y:r,width:i,height:o,preserveAspectRatio:"none"}),s.setAttributeNS(p,"href",e),t.canvas&&t.canvas.appendChild(s);var a=new R(s,t);return a.attrs={x:n,y:r,width:i,height:o,src:e},a.type="image",a},t._engine.text=function(e,n,r,i){var o=g("text");e.canvas&&e.canvas.appendChild(o);var s=new R(o,e);return s.attrs={x:n,y:r,"text-anchor":"middle",text:i,font:t._availableAttrs.font,stroke:"none",fill:"#000"},s.type="text",w(s,s.attrs),s},t._engine.setSize=function(t,e){return this.width=t||this.width,this.height=e||this.height,this.canvas.setAttribute("width",this.width),this.canvas.setAttribute("height",this.height),this._viewBox&&this.setViewBox.apply(this,this._viewBox),this},t._engine.create=function(){var e=t._getContainer.apply(0,arguments),n=e&&e.container,r=e.x,i=e.y,o=e.width,s=e.height;if(!n)throw new Error("SVG container not found.");var a,l=g("svg"),c="overflow:hidden;";return r=r||0,i=i||0,o=o||512,s=s||342,g(l,{height:s,version:1.1,width:o,xmlns:"http://www.w3.org/2000/svg"}),1==n?(l.style.cssText=c+"position:absolute;left:"+r+"px;top:"+i+"px",t._g.doc.body.appendChild(l),a=1):(l.style.cssText=c+"position:relative",n.firstChild?n.insertBefore(l,n.firstChild):n.appendChild(l)),n=new t._Paper,n.width=o,n.height=s,n.canvas=l,n.clear(),n._left=n._top=0,a&&(n.renderfix=function(){}),n.renderfix(),n},t._engine.setViewBox=function(t,e,n,r,i){h("raphael.setViewBox",this,this._viewBox,[t,e,n,r,i]);var o,a,l=s(n/this.width,r/this.height),c=this.top,u=i?"meet":"xMinYMin";for(null==t?(this._vbSize&&(l=1),delete this._vbSize,o="0 0 "+this.width+d+this.height):(this._vbSize=l,o=t+d+e+d+n+d+r),g(this.canvas,{viewBox:o,preserveAspectRatio:u});l&&c;)a="stroke-width"in c.attrs?c.attrs["stroke-width"]:1,c.attr({"stroke-width":a}),c._.dirty=1,c._.dirtyT=1,c=c.prev;return this._viewBox=[t,e,n,r,!!i],this},t.prototype.renderfix=function(){var t,e=this.canvas,n=e.style;try{t=e.getScreenCTM()||e.createSVGMatrix()}catch(r){t=e.createSVGMatrix()}var i=-t.e%1,o=-t.f%1;(i||o)&&(i&&(this._left=(this._left+i)%1,n.left=this._left+"px"),o&&(this._top=(this._top+o)%1,n.top=this._top+"px"))},t.prototype.clear=function(){t.eve("raphael.clear",this);for(var e=this.canvas;e.firstChild;)e.removeChild(e.firstChild);this.bottom=this.top=null,(this.desc=g("desc")).appendChild(t._g.doc.createTextNode("Created with Raphaël "+t.version)),e.appendChild(this.desc),e.appendChild(this.defs=g("defs"))},t.prototype.remove=function(){h("raphael.remove",this),this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas);for(var e in this)this[e]="function"==typeof this[e]?t._removedFactory(e):null};var A=t.st;for(var _ in C)C[e](_)&&!A[e](_)&&(A[_]=function(t){return function(){var e=arguments;return this.forEach(function(n){n[t].apply(n,e)})}}(_))}(window.Raphael),window.Raphael.vml&&function(t){var e="hasOwnProperty",n=String,r=parseFloat,i=Math,o=i.round,s=i.max,a=i.min,l=i.abs,c="fill",h=/[, ]+/,u=t.eve,d=" progid:DXImageTransform.Microsoft",p=" ",f="",m={M:"m",L:"l",C:"c",Z:"x",m:"t",l:"r",c:"v",z:"x"},g=/([clmz]),?([^clmz]*)/gi,b=/ progid:\S+Blur\([^\)]+\)/g,v=/-?[^,\s-]+/g,y="position:absolute;left:0;top:0;width:1px;height:1px",x=21600,S={path:1,rect:1,image:1},w={circle:1,ellipse:1},E=function(e){var r=/[ahqstv]/gi,i=t._pathToAbsolute;if(n(e).match(r)&&(i=t._path2curve),r=/[clmz]/g,i==t._pathToAbsolute&&!n(e).match(r)){var s=n(e).replace(g,function(t,e,n){var r=[],i="m"==e.toLowerCase(),s=m[e];return n.replace(v,function(t){i&&2==r.length&&(s+=r+m["m"==e?"l":"L"],r=[]),r.push(o(t*x))}),s+r});return s}var a,l,c=i(e);s=[];for(var h=0,u=c.length;u>h;h++){a=c[h],l=c[h][0].toLowerCase(),"z"==l&&(l="x");for(var d=1,b=a.length;b>d;d++)l+=o(a[d]*x)+(d!=b-1?",":f);s.push(l)}return s.join(p)},B=function(e,n,r){var i=t.matrix();return i.rotate(-e,.5,.5),{dx:i.x(n,r),dy:i.y(n,r)}},R=function(t,e,n,r,i,o){var s=t._,a=t.matrix,h=s.fillpos,u=t.node,d=u.style,f=1,m="",g=x/e,b=x/n;if(d.visibility="hidden",e&&n){if(u.coordsize=l(g)+p+l(b),d.rotation=o*(0>e*n?-1:1),o){var v=B(o,r,i);r=v.dx,i=v.dy}if(0>e&&(m+="x"),0>n&&(m+=" y")&&(f=-1),d.flip=m,u.coordorigin=r*-g+p+i*-b,h||s.fillsize){var y=u.getElementsByTagName(c);y=y&&y[0],u.removeChild(y),h&&(v=B(o,a.x(h[0],h[1]),a.y(h[0],h[1])),y.position=v.dx*f+p+v.dy*f),s.fillsize&&(y.size=s.fillsize[0]*l(e)+p+s.fillsize[1]*l(n)),u.appendChild(y)}d.visibility="visible"}};t.toString=function(){return"Your browser doesn’t support SVG. Falling down to VML.\nYou are running Raphaël "+this.version};var C=function(t,e,r){for(var i=n(e).toLowerCase().split("-"),o=r?"end":"start",s=i.length,a="classic",l="medium",c="medium";s--;)switch(i[s]){case"block":case"classic":case"oval":case"diamond":case"open":case"none":a=i[s];break;case"wide":case"narrow":c=i[s];break;case"long":case"short":l=i[s]}var h=t.node.getElementsByTagName("stroke")[0];h[o+"arrow"]=a,h[o+"arrowlength"]=l,h[o+"arrowwidth"]=c},A=function(i,l){i.attrs=i.attrs||{};var u=i.node,d=i.attrs,m=u.style,g=S[i.type]&&(l.x!=d.x||l.y!=d.y||l.width!=d.width||l.height!=d.height||l.cx!=d.cx||l.cy!=d.cy||l.rx!=d.rx||l.ry!=d.ry||l.r!=d.r),b=w[i.type]&&(d.cx!=l.cx||d.cy!=l.cy||d.r!=l.r||d.rx!=l.rx||d.ry!=l.ry),v=i;for(var y in l)l[e](y)&&(d[y]=l[y]);if(g&&(d.path=t._getPath[i.type](i),i._.dirty=1),l.href&&(u.href=l.href),l.title&&(u.title=l.title),l.target&&(u.target=l.target),l.cursor&&(m.cursor=l.cursor),"blur"in l&&i.blur(l.blur),(l.path&&"path"==i.type||g)&&(u.path=E(~n(d.path).toLowerCase().indexOf("r")?t._pathToAbsolute(d.path):d.path),"image"==i.type&&(i._.fillpos=[d.x,d.y],i._.fillsize=[d.width,d.height],R(i,1,1,0,0,0))),"transform"in l&&i.transform(l.transform),b){var B=+d.cx,A=+d.cy,O=+d.rx||+d.r||0,T=+d.ry||+d.r||0;u.path=t.format("ar{0},{1},{2},{3},{4},{1},{4},{1}x",o((B-O)*x),o((A-T)*x),o((B+O)*x),o((A+T)*x),o(B*x))}if("clip-rect"in l){var M=n(l["clip-rect"]).split(h);if(4==M.length){M[2]=+M[2]+ +M[0],M[3]=+M[3]+ +M[1];var N=u.clipRect||t._g.doc.createElement("div"),L=N.style;L.clip=t.format("rect({1}px {2}px {3}px {0}px)",M),u.clipRect||(L.position="absolute",L.top=0,L.left=0,L.width=i.paper.width+"px",L.height=i.paper.height+"px",u.parentNode.insertBefore(N,u),N.appendChild(u),u.clipRect=N)}l["clip-rect"]||u.clipRect&&(u.clipRect.style.clip="auto")}if(i.textpath){var k=i.textpath.style;l.font&&(k.font=l.font),l["font-family"]&&(k.fontFamily='"'+l["font-family"].split(",")[0].replace(/^['"]+|['"]+$/g,f)+'"'),l["font-size"]&&(k.fontSize=l["font-size"]),l["font-weight"]&&(k.fontWeight=l["font-weight"]),l["font-style"]&&(k.fontStyle=l["font-style"])}if("arrow-start"in l&&C(v,l["arrow-start"]),"arrow-end"in l&&C(v,l["arrow-end"],1),null!=l.opacity||null!=l["stroke-width"]||null!=l.fill||null!=l.src||null!=l.stroke||null!=l["stroke-width"]||null!=l["stroke-opacity"]||null!=l["fill-opacity"]||null!=l["stroke-dasharray"]||null!=l["stroke-miterlimit"]||null!=l["stroke-linejoin"]||null!=l["stroke-linecap"]){var D=u.getElementsByTagName(c),I=!1;if(D=D&&D[0],!D&&(I=D=P(c)),"image"==i.type&&l.src&&(D.src=l.src),l.fill&&(D.on=!0),(null==D.on||"none"==l.fill||null===l.fill)&&(D.on=!1),D.on&&l.fill){var V=n(l.fill).match(t._ISURL);if(V){D.parentNode==u&&u.removeChild(D),D.rotate=!0,D.src=V[1],D.type="tile";var j=i.getBBox(1);D.position=j.x+p+j.y,i._.fillpos=[j.x,j.y],t._preload(V[1],function(){i._.fillsize=[this.offsetWidth,this.offsetHeight]})}else D.color=t.getRGB(l.fill).hex,D.src=f,D.type="solid",t.getRGB(l.fill).error&&(v.type in{circle:1,ellipse:1}||"r"!=n(l.fill).charAt())&&_(v,l.fill,D)&&(d.fill="none",d.gradient=l.fill,D.rotate=!1)}if("fill-opacity"in l||"opacity"in l){var G=((+d["fill-opacity"]+1||2)-1)*((+d.opacity+1||2)-1)*((+t.getRGB(l.fill).o+1||2)-1);G=a(s(G,0),1),D.opacity=G,D.src&&(D.color="none")}u.appendChild(D);var F=u.getElementsByTagName("stroke")&&u.getElementsByTagName("stroke")[0],H=!1;!F&&(H=F=P("stroke")),(l.stroke&&"none"!=l.stroke||l["stroke-width"]||null!=l["stroke-opacity"]||l["stroke-dasharray"]||l["stroke-miterlimit"]||l["stroke-linejoin"]||l["stroke-linecap"])&&(F.on=!0),("none"==l.stroke||null===l.stroke||null==F.on||0==l.stroke||0==l["stroke-width"])&&(F.on=!1);var z=t.getRGB(l.stroke);F.on&&l.stroke&&(F.color=z.hex),G=((+d["stroke-opacity"]+1||2)-1)*((+d.opacity+1||2)-1)*((+z.o+1||2)-1);var U=.75*(r(l["stroke-width"])||1);if(G=a(s(G,0),1),null==l["stroke-width"]&&(U=d["stroke-width"]),l["stroke-width"]&&(F.weight=U),U&&1>U&&(G*=U)&&(F.weight=1),F.opacity=G,l["stroke-linejoin"]&&(F.joinstyle=l["stroke-linejoin"]||"miter"),F.miterlimit=l["stroke-miterlimit"]||8,l["stroke-linecap"]&&(F.endcap="butt"==l["stroke-linecap"]?"flat":"square"==l["stroke-linecap"]?"square":"round"),l["stroke-dasharray"]){var $={"-":"shortdash",".":"shortdot","-.":"shortdashdot","-..":"shortdashdotdot",". ":"dot","- ":"dash","--":"longdash","- .":"dashdot","--.":"longdashdot","--..":"longdashdotdot"};F.dashstyle=$[e](l["stroke-dasharray"])?$[l["stroke-dasharray"]]:f}H&&u.appendChild(F)}if("text"==v.type){v.paper.canvas.style.display=f;var Y=v.paper.span,W=100,q=d.font&&d.font.match(/\d+(?:\.\d*)?(?=px)/);m=Y.style,d.font&&(m.font=d.font),d["font-family"]&&(m.fontFamily=d["font-family"]),d["font-weight"]&&(m.fontWeight=d["font-weight"]),d["font-style"]&&(m.fontStyle=d["font-style"]),q=r(d["font-size"]||q&&q[0])||10,m.fontSize=q*W+"px",v.textpath.string&&(Y.innerHTML=n(v.textpath.string).replace(/</g,"&#60;").replace(/&/g,"&#38;").replace(/\n/g,"<br>"));var X=Y.getBoundingClientRect();v.W=d.w=(X.right-X.left)/W,v.H=d.h=(X.bottom-X.top)/W,v.X=d.x,v.Y=d.y+v.H/2,("x"in l||"y"in l)&&(v.path.v=t.format("m{0},{1}l{2},{1}",o(d.x*x),o(d.y*x),o(d.x*x)+1));for(var K=["x","y","text","font","font-family","font-weight","font-style","font-size"],J=0,Q=K.length;Q>J;J++)if(K[J]in l){v._.dirty=1;break}switch(d["text-anchor"]){case"start":v.textpath.style["v-text-align"]="left",v.bbx=v.W/2;break;case"end":v.textpath.style["v-text-align"]="right",v.bbx=-v.W/2;break;default:v.textpath.style["v-text-align"]="center",v.bbx=0}v.textpath.style["v-text-kern"]=!0}},_=function(e,o,s){e.attrs=e.attrs||{};var a=(e.attrs,Math.pow),l="linear",c=".5 .5";if(e.attrs.gradient=o,o=n(o).replace(t._radial_gradient,function(t,e,n){return l="radial",e&&n&&(e=r(e),n=r(n),a(e-.5,2)+a(n-.5,2)>.25&&(n=i.sqrt(.25-a(e-.5,2))*(2*(n>.5)-1)+.5),c=e+p+n),f}),o=o.split(/\s*\-\s*/),"linear"==l){var h=o.shift();if(h=-r(h),isNaN(h))return null}var u=t._parseDots(o);if(!u)return null;if(e=e.shape||e.node,u.length){e.removeChild(s),s.on=!0,s.method="none",s.color=u[0].color,s.color2=u[u.length-1].color;for(var d=[],m=0,g=u.length;g>m;m++)u[m].offset&&d.push(u[m].offset+p+u[m].color);s.colors=d.length?d.join():"0% "+s.color,"radial"==l?(s.type="gradientTitle",s.focus="100%",s.focussize="0 0",s.focusposition=c,s.angle=0):(s.type="gradient",s.angle=(270-h)%360),e.appendChild(s)}return 1},O=function(e,n){this[0]=this.node=e,e.raphael=!0,this.id=t._oid++,e.raphaelid=this.id,this.X=0,this.Y=0,this.attrs={},this.paper=n,this.matrix=t.matrix(),this._={transform:[],sx:1,sy:1,dx:0,dy:0,deg:0,dirty:1,dirtyT:1},!n.bottom&&(n.bottom=this),this.prev=n.top,n.top&&(n.top.next=this),n.top=this,this.next=null},T=t.el;O.prototype=T,T.constructor=O,T.transform=function(e){if(null==e)return this._.transform;var r,i=this.paper._viewBoxShift,o=i?"s"+[i.scale,i.scale]+"-1-1t"+[i.dx,i.dy]:f;i&&(r=e=n(e).replace(/\.{3}|\u2026/g,this._.transform||f)),t._extractTransform(this,o+e);var s,a=this.matrix.clone(),l=this.skew,c=this.node,h=~n(this.attrs.fill).indexOf("-"),u=!n(this.attrs.fill).indexOf("url(");if(a.translate(-.5,-.5),u||h||"image"==this.type)if(l.matrix="1 0 0 1",l.offset="0 0",s=a.split(),h&&s.noRotation||!s.isSimple){c.style.filter=a.toFilter();var d=this.getBBox(),m=this.getBBox(1),g=d.x-m.x,b=d.y-m.y;c.coordorigin=g*-x+p+b*-x,R(this,1,1,g,b,0)}else c.style.filter=f,R(this,s.scalex,s.scaley,s.dx,s.dy,s.rotate);else c.style.filter=f,l.matrix=n(a),l.offset=a.offset();return r&&(this._.transform=r),this},T.rotate=function(t,e,i){if(this.removed)return this;if(null!=t){if(t=n(t).split(h),t.length-1&&(e=r(t[1]),i=r(t[2])),t=r(t[0]),null==i&&(e=i),null==e||null==i){var o=this.getBBox(1);e=o.x+o.width/2,i=o.y+o.height/2}return this._.dirtyT=1,this.transform(this._.transform.concat([["r",t,e,i]])),this}},T.translate=function(t,e){return this.removed?this:(t=n(t).split(h),t.length-1&&(e=r(t[1])),t=r(t[0])||0,e=+e||0,this._.bbox&&(this._.bbox.x+=t,this._.bbox.y+=e),this.transform(this._.transform.concat([["t",t,e]])),this)},T.scale=function(t,e,i,o){if(this.removed)return this;if(t=n(t).split(h),t.length-1&&(e=r(t[1]),i=r(t[2]),o=r(t[3]),isNaN(i)&&(i=null),isNaN(o)&&(o=null)),t=r(t[0]),null==e&&(e=t),null==o&&(i=o),null==i||null==o)var s=this.getBBox(1);return i=null==i?s.x+s.width/2:i,o=null==o?s.y+s.height/2:o,this.transform(this._.transform.concat([["s",t,e,i,o]])),this._.dirtyT=1,this},T.hide=function(){return!this.removed&&(this.node.style.display="none"),this},T.show=function(){return!this.removed&&(this.node.style.display=f),this},T._getBBox=function(){return this.removed?{}:{x:this.X+(this.bbx||0)-this.W/2,y:this.Y-this.H,width:this.W,height:this.H}},T.remove=function(){if(!this.removed&&this.node.parentNode){this.paper.__set__&&this.paper.__set__.exclude(this),t.eve.unbind("raphael.*.*."+this.id),t._tear(this,this.paper),this.node.parentNode.removeChild(this.node),this.shape&&this.shape.parentNode.removeChild(this.shape);for(var e in this)this[e]="function"==typeof this[e]?t._removedFactory(e):null;this.removed=!0}},T.attr=function(n,r){if(this.removed)return this;if(null==n){var i={};for(var o in this.attrs)this.attrs[e](o)&&(i[o]=this.attrs[o]);return i.gradient&&"none"==i.fill&&(i.fill=i.gradient)&&delete i.gradient,i.transform=this._.transform,i}if(null==r&&t.is(n,"string")){if(n==c&&"none"==this.attrs.fill&&this.attrs.gradient)return this.attrs.gradient;for(var s=n.split(h),a={},l=0,d=s.length;d>l;l++)n=s[l],n in this.attrs?a[n]=this.attrs[n]:t.is(this.paper.customAttributes[n],"function")?a[n]=this.paper.customAttributes[n].def:a[n]=t._availableAttrs[n];return d-1?a:a[s[0]]}if(this.attrs&&null==r&&t.is(n,"array")){for(a={},l=0,d=n.length;d>l;l++)a[n[l]]=this.attr(n[l]);return a}var p;null!=r&&(p={},p[n]=r),null==r&&t.is(n,"object")&&(p=n);for(var f in p)u("raphael.attr."+f+"."+this.id,this,p[f]);if(p){for(f in this.paper.customAttributes)if(this.paper.customAttributes[e](f)&&p[e](f)&&t.is(this.paper.customAttributes[f],"function")){var m=this.paper.customAttributes[f].apply(this,[].concat(p[f]));this.attrs[f]=p[f];for(var g in m)m[e](g)&&(p[g]=m[g])}p.text&&"text"==this.type&&(this.textpath.string=p.text),A(this,p)}return this},T.toFront=function(){return!this.removed&&this.node.parentNode.appendChild(this.node),this.paper&&this.paper.top!=this&&t._tofront(this,this.paper),this},T.toBack=function(){return this.removed?this:(this.node.parentNode.firstChild!=this.node&&(this.node.parentNode.insertBefore(this.node,this.node.parentNode.firstChild),t._toback(this,this.paper)),this)},T.insertAfter=function(e){return this.removed?this:(e.constructor==t.st.constructor&&(e=e[e.length-1]),e.node.nextSibling?e.node.parentNode.insertBefore(this.node,e.node.nextSibling):e.node.parentNode.appendChild(this.node),t._insertafter(this,e,this.paper),this)},T.insertBefore=function(e){return this.removed?this:(e.constructor==t.st.constructor&&(e=e[0]),e.node.parentNode.insertBefore(this.node,e.node),t._insertbefore(this,e,this.paper),this)},T.blur=function(e){var n=this.node.runtimeStyle,r=n.filter;r=r.replace(b,f),0!==+e?(this.attrs.blur=e,n.filter=r+p+d+".Blur(pixelradius="+(+e||1.5)+")",n.margin=t.format("-{0}px 0 0 -{0}px",o(+e||1.5))):(n.filter=r,n.margin=0,delete this.attrs.blur)},t._engine.path=function(t,e){var n=P("shape");n.style.cssText=y,n.coordsize=x+p+x,n.coordorigin=e.coordorigin;var r=new O(n,e),i={fill:"none",stroke:"#000"};t&&(i.path=t),r.type="path",r.path=[],r.Path=f,A(r,i),e.canvas.appendChild(n);var o=P("skew");return o.on=!0,n.appendChild(o),r.skew=o,r.transform(f),r},t._engine.rect=function(e,n,r,i,o,s){var a=t._rectPath(n,r,i,o,s),l=e.path(a),c=l.attrs;return l.X=c.x=n,l.Y=c.y=r,l.W=c.width=i,l.H=c.height=o,c.r=s,c.path=a,l.type="rect",l},t._engine.ellipse=function(t,e,n,r,i){var o=t.path();o.attrs;return o.X=e-r,o.Y=n-i,o.W=2*r,o.H=2*i,o.type="ellipse",A(o,{cx:e,cy:n,rx:r,ry:i}),o},t._engine.circle=function(t,e,n,r){var i=t.path();i.attrs;return i.X=e-r,i.Y=n-r,i.W=i.H=2*r,i.type="circle",A(i,{cx:e,cy:n,r:r}),i},t._engine.image=function(e,n,r,i,o,s){var a=t._rectPath(r,i,o,s),l=e.path(a).attr({stroke:"none"}),h=l.attrs,u=l.node,d=u.getElementsByTagName(c)[0];return h.src=n,l.X=h.x=r,l.Y=h.y=i,l.W=h.width=o,l.H=h.height=s,h.path=a,l.type="image",d.parentNode==u&&u.removeChild(d),d.rotate=!0,d.src=n,d.type="tile",l._.fillpos=[r,i],l._.fillsize=[o,s],u.appendChild(d),R(l,1,1,0,0,0),l},t._engine.text=function(e,r,i,s){var a=P("shape"),l=P("path"),c=P("textpath");r=r||0,i=i||0,s=s||"",l.v=t.format("m{0},{1}l{2},{1}",o(r*x),o(i*x),o(r*x)+1),l.textpathok=!0,c.string=n(s),c.on=!0,a.style.cssText=y,a.coordsize=x+p+x,a.coordorigin="0 0";var h=new O(a,e),u={fill:"#000",stroke:"none",font:t._availableAttrs.font,text:s};h.shape=a,h.path=l,h.textpath=c,h.type="text",h.attrs.text=n(s),h.attrs.x=r,h.attrs.y=i,h.attrs.w=1,h.attrs.h=1,A(h,u),a.appendChild(c),a.appendChild(l),e.canvas.appendChild(a);var d=P("skew");return d.on=!0,a.appendChild(d),h.skew=d,h.transform(f),h},t._engine.setSize=function(e,n){var r=this.canvas.style;return this.width=e,this.height=n,e==+e&&(e+="px"),n==+n&&(n+="px"),r.width=e,r.height=n,r.clip="rect(0 "+e+" "+n+" 0)",this._viewBox&&t._engine.setViewBox.apply(this,this._viewBox),this},t._engine.setViewBox=function(e,n,r,i,o){t.eve("raphael.setViewBox",this,this._viewBox,[e,n,r,i,o]);var a,l,c=this.width,h=this.height,u=1/s(r/c,i/h);return o&&(a=h/i,l=c/r,c>r*a&&(e-=(c-r*a)/2/a),h>i*l&&(n-=(h-i*l)/2/l)),this._viewBox=[e,n,r,i,!!o],this._viewBoxShift={dx:-e,dy:-n,scale:u},this.forEach(function(t){t.transform("...")}),this};var P;t._engine.initWin=function(t){var e=t.document;e.createStyleSheet().addRule(".rvml","behavior:url(#default#VML)");try{!e.namespaces.rvml&&e.namespaces.add("rvml","urn:schemas-microsoft-com:vml"),P=function(t){return e.createElement("<rvml:"+t+' class="rvml">')}}catch(n){P=function(t){return e.createElement("<"+t+' xmlns="urn:schemas-microsoft.com:vml" class="rvml">')}}},t._engine.initWin(t._g.win),t._engine.create=function(){var e=t._getContainer.apply(0,arguments),n=e.container,r=e.height,i=e.width,o=e.x,s=e.y;if(!n)throw new Error("VML container not found.");var a=new t._Paper,l=a.canvas=t._g.doc.createElement("div"),c=l.style;return o=o||0,s=s||0,i=i||512,r=r||342,a.width=i,a.height=r,i==+i&&(i+="px"),r==+r&&(r+="px"),a.coordsize=1e3*x+p+1e3*x,a.coordorigin="0 0",a.span=t._g.doc.createElement("span"),a.span.style.cssText="position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;",l.appendChild(a.span),c.cssText=t.format("top:0;left:0;width:{0};height:{1};display:inline-block;position:relative;clip:rect(0 {0} {1} 0);overflow:hidden",i,r),1==n?(t._g.doc.body.appendChild(l),c.left=o+"px",c.top=s+"px",c.position="absolute"):n.firstChild?n.insertBefore(l,n.firstChild):n.appendChild(l),a.renderfix=function(){},a},t.prototype.clear=function(){t.eve("raphael.clear",this),this.canvas.innerHTML=f,this.span=t._g.doc.createElement("span"),this.span.style.cssText="position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;display:inline;",this.canvas.appendChild(this.span),this.bottom=this.top=null},t.prototype.remove=function(){t.eve("raphael.remove",this),this.canvas.parentNode.removeChild(this.canvas);for(var e in this)this[e]="function"==typeof this[e]?t._removedFactory(e):null;return!0};var M=t.st;for(var N in T)T[e](N)&&!M[e](N)&&(M[N]=function(t){return function(){var e=arguments;return this.forEach(function(n){n[t].apply(n,e)})}}(N))}(window.Raphael),window.util||(util={});var EventMap={mousemove:"mousemove",mousedown:"mousedown",mouseup:"mouseup"};if(Array.prototype.swap=function(t,e){var n=this[t];this[t]=this[e],this[e]=n},util.each=function(t,e,n){util.assert(!util.isNullOrUndefined(t),"array must be defined");for(var r=0;r<t.length;++r)e.call(n,t[r],r)},util.map_each=function(t,e,n){util.assert(!util.isNullOrUndefined(t),"map must be defined");for(var r in t)e.call(n,r,t[r])},util.find=function(t,e,n){for(var r=0;r<t.length;++r)if(e.call(n,t[r],r))return r;return-1},util.findAll=function(t,e,n){for(var r=[],i=0;i<t.length;++i)e.call(n,t[i],i)&&r.push(t[i]);return r},util.array=function(t){for(var e=[],n=t.length;--n>=0;)e[n]=t[n];return e},util.isEmpty=function(t){for(var e in t)return!1;return!0},util.stopEventPropagation=function(t){if("stopPropagation"in t)t.stopPropagation();else{if(!("cancelBubble"in t))throw Error("Browser unrecognized");t.cancelBubble=!0}},util.preventDefault=function(t){return"preventDefault"in t&&t.preventDefault(),Prototype.Browser.IE&&(t.returnValue=!1,t.keyCode=0),!1},util.setElementTextContent=function(t,e){if("textContent"in t)t.textContent=e;else{if(!("innerText"in t))throw Error("Browser unrecognized");t.innerText=e}},util.getElementTextContent=function(t){if("textContent"in t)return t.textContent;if("innerText"in t)return t.innerText;throw Error("Browser unrecognized")},util.stringPadded=function(t,e,n){t+="";for(var r="";t.length+r.length<e;)r+=" ";return n?t+r:r+t},util.idList=function(t){var e=[];for(var n in t)e.push(n);return e},util.mapArray=function(t,e){for(var n=[],r=0;r<t.length;++r)n.push(e[t[r]]);return n},util.arrayMax=function(t){return Math.max.apply(Math,t)},util.arrayMin=function(t){return Math.min.apply(Math,t)},util.map=function(t,e,n){for(var r=[],i=0;i<t.length;++i)r.push(e.call(n,t[i]));return r},util.apply=function(t,e){for(var n=0;n<t.length;++n)t[n]=e(t[n])},util.ifDef=function(t,e,n,r){t[n]=Object.isUndefined(e[n])?r:e[n]},util.ifDefList=function(t,e,n,r){t[n]=Object.isUndefined(e[n])||null===e[n]?r:util.array(e[n])},util.identityMap=function(t){for(var e={},n=0;n<t.length;++n)e[t[n]]=t[n];return e},util.strip=function(t){return t.replace(/\s*$/,"").replace(/^\s*/,"")},util.stripRight=function(t){return t.replace(/\s*$/,"")},util.stripQuotes=function(t){return'"'===t[0]&&'"'===t[t.length-1]?t.substr(1,t.length-2):t},util.paddedFloat=function(t,e,n){var r=t.toFixed(n).replace(",",".");if(r.length>e)throw new Error("number does not fit");return util.stringPadded(r,e)},util.paddedInt=function(t,e){var n=t.toFixed(0);if(n.length>e)throw new Error("number does not fit");return util.stringPadded(n,e)},util.arrayAddIfMissing=function(t,e){for(var n=0;n<t.length;++n)if(t[n]===e)return!1;return t.push(e),!0},util.assert=function(t,e){if(!t)throw new Error(e?"Assertion failed: "+e:"Assertion failed")},util.isUndefined=function(t){return Object.isUndefined(t)},util.isNull=function(t){return null===t},util.isNullOrUndefined=function(t){return util.isUndefined(t)||util.isNull(t)},util.arrayRemoveByValue=function(t,e){util.assert(!util.isUndefined(t)&&!util.isNull(t),"array must be defined");for(var n=t.indexOf(e),r=0;n>=0;)t.splice(n,1),r+=1,n=t.indexOf(e);return r},util.listNextRotate=function(t,e){return t[(t.indexOf(e)+1)%t.length]},window.util||(util={}),util.assertDefined=function(t){util.assert(!util.isNullOrUndefined(t))},util.Vec2=function(t,e){if(0==arguments.length)this.x=0,this.y=0;else if(1==arguments.length)this.x=parseFloat(t.x),this.y=parseFloat(t.y);else{if(2!=arguments.length)throw"util.Vec2(): invalid arguments";this.x=parseFloat(t),this.y=parseFloat(e)}},util.Vec2.ZERO=new util.Vec2(0,0),util.Vec2.UNIT=new util.Vec2(1,1),util.Vec2.segmentIntersection=function(t,e,n,r){var i=(t.x-n.x)*(e.y-n.y)-(t.y-n.y)*(e.x-n.x),o=(t.x-r.x)*(e.y-r.y)-(t.y-r.y)*(e.x-r.x),s=(n.x-t.x)*(r.y-t.y)-(n.y-t.y)*(r.x-t.x),a=(n.x-e.x)*(r.y-e.y)-(n.y-e.y)*(r.x-e.x);return 0>=i*o&&0>=s*a},util.Vec2.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},util.Vec2.prototype.equals=function(t){return util.assertDefined(t),this.x==t.x&&this.y==t.y},util.Vec2.prototype.add=function(t){return util.assertDefined(t),new util.Vec2(this.x+t.x,this.y+t.y)},util.Vec2.prototype.add_=function(t){util.assertDefined(t),this.x+=t.x,this.y+=t.y},util.Vec2.prototype.sub=function(t){return util.assertDefined(t),new util.Vec2(this.x-t.x,this.y-t.y)},util.Vec2.prototype.scaled=function(t){return util.assertDefined(t),new util.Vec2(this.x*t,this.y*t)},util.Vec2.prototype.negated=function(){return new util.Vec2(-this.x,-this.y)},util.Vec2.prototype.yComplement=function(t){return t=t||0,new util.Vec2(this.x,t-this.y)},util.Vec2.prototype.addScaled=function(t,e){return util.assertDefined(t),util.assertDefined(e),new util.Vec2(this.x+t.x*e,this.y+t.y*e)},util.Vec2.prototype.normalized=function(){return this.scaled(1/this.length())},util.Vec2.prototype.normalize=function(){var t=this.length();return 1e-6>t?!1:(this.x/=t,this.y/=t,!0)},util.Vec2.prototype.turnLeft=function(){return new util.Vec2(-this.y,this.x)},util.Vec2.prototype.coordStr=function(){return this.x.toString()+" , "+this.y.toString()},util.Vec2.prototype.toString=function(){return"("+this.x.toFixed(2)+","+this.y.toFixed(2)+")"},util.Vec2.dist=function(t,e){return util.assertDefined(t),util.assertDefined(e),util.Vec2.diff(t,e).length()},util.Vec2.max=function(t,e){return util.assertDefined(t),util.assertDefined(e),new util.Vec2(Math.max(t.x,e.x),Math.max(t.y,e.y))},util.Vec2.min=function(t,e){return util.assertDefined(t),util.assertDefined(e),new util.Vec2(Math.min(t.x,e.x),Math.min(t.y,e.y))},util.Vec2.prototype.max=function(t){return util.assertDefined(t),new util.Vec2.max(this,t)},util.Vec2.prototype.min=function(t){return util.assertDefined(t),new util.Vec2.min(this,t)},util.Vec2.prototype.ceil=function(){return new util.Vec2(Math.ceil(this.x),Math.ceil(this.y))},util.Vec2.prototype.floor=function(){return new util.Vec2(Math.floor(this.x),Math.floor(this.y))},util.Vec2.sum=function(t,e){return util.assertDefined(t),util.assertDefined(e),new util.Vec2(t.x+e.x,t.y+e.y)},util.Vec2.dot=function(t,e){return util.assertDefined(t),util.assertDefined(e),t.x*e.x+t.y*e.y},util.Vec2.cross=function(t,e){return util.assertDefined(t),util.assertDefined(e),t.x*e.y-t.y*e.x},util.Vec2.prototype.rotate=function(t){util.assertDefined(t);var e=Math.sin(t),n=Math.cos(t);return this.rotateSC(e,n)},util.Vec2.prototype.rotateSC=function(t,e){return util.assertDefined(t),util.assertDefined(e),new util.Vec2(this.x*e-this.y*t,this.x*t+this.y*e);
},util.Vec2.angle=function(t,e){return util.assertDefined(t),util.assertDefined(e),Math.atan2(util.Vec2.cross(t,e),util.Vec2.dot(t,e))},util.Vec2.prototype.oxAngle=function(){return Math.atan2(this.y,this.x)},util.Vec2.diff=function(t,e){return util.assertDefined(t),util.assertDefined(e),new util.Vec2(t.x-e.x,t.y-e.y)},util.Vec2.lc=function(){for(var t=new util.Vec2,e=0;e<arguments.length/2;++e)t=t.addScaled(arguments[2*e],arguments[2*e+1]);return t},util.Vec2.lc2=function(t,e,n,r){return util.assertDefined(t),util.assertDefined(n),util.assertDefined(e),util.assertDefined(r),new util.Vec2(t.x*e+n.x*r,t.y*e+n.y*r)},util.Vec2.centre=function(t,e){return new util.Vec2.lc2(t,.5,e,.5)},util.Box2Abs=function(){1==arguments.length&&"min"in arguments[0]&&"max"in arguments[0]&&(this.p0=arguments[0].min,this.p1=arguments[0].max),2==arguments.length&&arguments[0]instanceof util.Vec2&&arguments[1]instanceof util.Vec2?(this.p0=arguments[0],this.p1=arguments[1]):4==arguments.length?(this.p0=new util.Vec2(arguments[0],arguments[1]),this.p1=new util.Vec2(arguments[2],arguments[3])):0==arguments.length?(this.p0=new util.Vec2,this.p1=new util.Vec2):new Error("util.Box2Abs constructor only accepts 4 numbers or 2 vectors or no arguments!")},util.Box2Abs.prototype.toString=function(){return this.p0.toString()+" "+this.p1.toString()},util.Box2Abs.fromRelBox=function(t){return util.assertDefined(t),new util.Box2Abs(t.x,t.y,t.x+t.width,t.y+t.height)},util.Box2Abs.prototype.clone=function(){return new util.Box2Abs(this.p0,this.p1)},util.Box2Abs.union=function(t,e){return util.assertDefined(t),util.assertDefined(e),new util.Box2Abs(util.Vec2.min(t.p0,e.p0),util.Vec2.max(t.p1,e.p1))},util.Box2Abs.prototype.extend=function(t,e){return util.assertDefined(t),e=e||t,new util.Box2Abs(this.p0.sub(t),this.p1.add(e))},util.Box2Abs.prototype.include=function(t){return util.assertDefined(t),new util.Box2Abs(this.p0.min(t),this.p1.max(t))},util.Box2Abs.prototype.contains=function(t,e){return e=(e||0)-0,util.assertDefined(t),t.x>=this.p0.x-e&&t.x<=this.p1.x+e&&t.y>=this.p0.y-e&&t.y<=this.p1.y+e},util.Box2Abs.prototype.translate=function(t){return util.assertDefined(t),new util.Box2Abs(this.p0.add(t),this.p1.add(t))},util.Box2Abs.prototype.transform=function(t,e){return util.assert(!util.isNullOrUndefined(t)),new util.Box2Abs(t.call(e,this.p0),t.call(e,this.p1))},util.Box2Abs.prototype.sz=function(){return this.p1.sub(this.p0)},util.Box2Abs.prototype.centre=function(){return util.Vec2.centre(this.p0,this.p1)},util.Box2Abs.prototype.pos=function(){return this.p0},util.Vec2.shiftRayBox=function(t,e,n){util.assertDefined(t),util.assertDefined(e),util.assertDefined(n);var r=[n.p0,new util.Vec2(n.p1.x,n.p0.y),n.p1,new util.Vec2(n.p0.x,n.p1.y)],i=r.map(function(e){return e.sub(t)});e=e.normalized();for(var o=i.map(function(t){return util.Vec2.cross(t,e)}),s=i.map(function(t){return util.Vec2.dot(t,e)}),a=-1,l=-1,c=0;4>c;++c)o[c]>0?(0>a||s[a]<s[c])&&(a=c):(0>l||s[l]<s[c])&&(l=c);if(0>l||0>a)return 0;var h,u;return s[a]>s[l]?(h=l,u=a):(h=a,u=l),s[h]+Math.abs(o[h])*(s[u]-s[h])/(Math.abs(o[h])+Math.abs(o[u]))},window.util||(util={}),util.Set={empty:function(){return{}},single:function(t){var e={};return util.Set.add(e,t),e},size:function(t){var e=0;for(var n in t)t[n]!==Object.prototype[n]&&e++;return e},contains:function(t,e){return"undefined"!=typeof t[e]&&t[e]!==Object.prototype[e]},subset:function(t,e){for(var n in t)if(t[n]!==Object.prototype[n]&&e[n]!==t[n])return!1;return!0},intersection:function(t,e){var n={};for(var r in t)t[r]!==Object.prototype[r]&&e[r]===t[r]&&util.Set.add(n,r);return n},disjoint:function(t,e){for(var n in t)if(t[n]!==Object.prototype[n]&&e[n]===t[n])return!1;return!0},eq:function(t,e){return util.Set.subset(t,e)&&util.Set.subset(e,t)},each:function(t,e,n){for(var r in t)t[r]!==Object.prototype[r]&&e.call(n,t[r])},filter:function(t,e,n){var r={};for(var i in t)t[i]!==Object.prototype[i]&&e.call(n,t[i])&&(r[t[i]]=t[i]);return r},pick:function(t){for(var e in t)if(t[e]!==Object.prototype[e])return t[e];return null},list:function(t){var e=[];for(var n in t)t[n]!==Object.prototype[n]&&e.push(t[n]);return e},add:function(t,e){t[e]=e},mergeIn:function(t,e){util.Set.each(e,function(e){util.Set.add(t,e)})},remove:function(t,e){var n=t[e];return delete t[e],n},clone:function(t){var e={};return util.Set.mergeIn(e,t),e},fromList:function(t){var e={};if(t)for(var n=0;n<t.length;++n)e[t[n]-0]=t[n]-0;return e},keySetInt:function(t){var e={};return t.each(function(t){e[t-0]=t-0}),e},find:function(t,e,n){for(var r in t)if(t[r]!==Object.prototype[r]&&e.call(n,t[r]))return r;return null}},window.util||(util={}),util.Map=function(t){if("undefined"!=typeof t&&t.constructor!==Object)throw Error("Passed object is not an instance of 'Object'!");this._obj=t||{},this._count=0},util.Map.prototype.each=function(t,e){for(var n in this._obj){var r=parseInt(n),i=this._obj[n];isNaN(r)||(n=r),t.call(e,n,i)}},util.Map.prototype.map=function(t,e){var n=new util.Map;return this.each(function(r,i){n.set(r,t.call(e,r,i))},this),n},util.Map.prototype.find=function(t,e){for(var n in this._obj){var r=parseInt(n),i=this._obj[n];if(isNaN(r)||(n=r),t.call(e,n,i))return n}},util.Map.prototype.findAll=function(t,e){var n=[];for(var r in this._obj){var i=parseInt(r),o=this._obj[r];isNaN(i)||(r=i),t.call(e,r,o)&&n.push(r)}return n},util.Map.prototype.keys=function(){var t=[];for(var e in this._obj)t.push(e);return t},util.Map.prototype.ikeys=function(){var t=[];for(var e in this._obj)t.push(e-0);return t},util.Map.prototype.set=function(t,e){if(this._count+=("undefined"!=typeof e?1:0)-("undefined"!=typeof this._obj[t]?1:0),"undefined"==typeof e){var n=this._obj[t];return delete this._obj[t],n}return this._obj[t]=e},util.Map.prototype.get=function(t){return this._obj[t]!==Object.prototype[t]?this._obj[t]:void 0},util.Map.prototype.has=function(t){return this._obj[t]!==Object.prototype[t]},util.Map.prototype.unset=function(t){return this.set(t,void 0)},util.Map.prototype.update=function(t){for(var e in t)this.set(e,t[e])},util.Map.prototype.clear=function(){this._obj={},this._count=0},util.Map.prototype.count=function(){return this._count},util.Map.prototype.idList=function(){return util.idList(this._obj)},util.Map.prototype.keyOf=function(t){for(var e in this._obj)if(this._obj[e]===t)return e},!window.util||!util.Map)throw new Error("Map should be defined first");if(util.Pool=function(){this._map=new util.Map,this._nextId=0},util.Pool.prototype.newId=function(){return this._nextId++},util.Pool.prototype.add=function(t){var e=this._nextId++;return this._map.set(e,t),e},util.Pool.prototype.set=function(t,e){this._map.set(t,e)},util.Pool.prototype.get=function(t){return this._map.get(t)},util.Pool.prototype.has=function(t){return this._map.has(t)},util.Pool.prototype.remove=function(t){return this._map.unset(t)},util.Pool.prototype.clear=function(){this._map.clear()},util.Pool.prototype.keys=function(){return this._map.keys()},util.Pool.prototype.ikeys=function(){return this._map.ikeys()},util.Pool.prototype.each=function(t,e){this._map.each(t,e)},util.Pool.prototype.map=function(t,e){return this._map.map(t,e)},util.Pool.prototype.find=function(t,e){return this._map.find(t,e)},util.Pool.prototype.count=function(){return this._map.count()},util.Pool.prototype.keyOf=function(t){return this._map.keyOf(t)},!window.util||!util.Vec2)throw new Error("Vec2 should be defined first");if(window.chem||(chem={}),chem.Element=function(t,e,n,r,i,o,s){this.label=t,this.period=e,this.group=n,this.putHydrogenOnTheLeft=r,this.color=i||"#000000",this.labelColor=rgbToHex(rgbRescale(hexToRGB(this.color),150)),this.xpos=s||n,this.ypos=o||e;var a=("0x"+this.color.substring(1,3)-0)/255,l=("0x"+this.color.substring(3,5)-0)/255,c=("0x"+this.color.substring(5,7)-0)/255,h=.299*a+.587*l+.114*c;h>.6&&(a*=.6/h,l*=.6/h,c*=.6/h),a=Math.ceil(Math.min(255*a,255)).toString(16),l=Math.ceil(Math.min(255*l,255)).toString(16),c=Math.ceil(Math.min(255*c,255)).toString(16),a=1==a.length?"0"+a:a,l=1==l.length?"0"+l:l,c=1==c.length?"0"+c:c,this.color="#"+a+l+c},chem.Element.elements=new util.Map({1:new chem.Element("H",1,1,!1,"#000000",1,1),2:new chem.Element("He",1,8,!1,"#d9ffff",1,18),3:new chem.Element("Li",2,1,!1,"#cc80ff",2,1),4:new chem.Element("Be",2,2,!1,"#c2ff00",2,2),5:new chem.Element("B",2,3,!1,"#ffb5b5",2,13),6:new chem.Element("C",2,4,!1,"#000000",2,14),7:new chem.Element("N",2,5,!1,"#304ff7",2,15),8:new chem.Element("O",2,6,!0,"#ff0d0d",2,16),9:new chem.Element("F",2,7,!0,"#8fe04f",2,17),10:new chem.Element("Ne",2,8,!1,"#b3e3f5",2,18),11:new chem.Element("Na",3,1,!1,"#ab5cf2",3,1),12:new chem.Element("Mg",3,2,!1,"#8aff00",3,2),13:new chem.Element("Al",3,3,!1,"#bfa6a6",3,13),14:new chem.Element("Si",3,4,!1,"#f0c7a1",3,14),15:new chem.Element("P",3,5,!1,"#ff8000",3,15),16:new chem.Element("S",3,6,!0,"#d9a61a",3,16),17:new chem.Element("Cl",3,7,!0,"#1fd01f",3,17),18:new chem.Element("Ar",3,8,!1,"#80d1e3",3,18),19:new chem.Element("K",4,1,!1,"#8f40d4",4,1),20:new chem.Element("Ca",4,2,!1,"#3dff00",4,2),21:new chem.Element("Sc",4,3,!1,"#e6e6e6",4,3),22:new chem.Element("Ti",4,4,!1,"#bfc2c7",4,4),23:new chem.Element("V",4,5,!1,"#a6a6ab",4,5),24:new chem.Element("Cr",4,6,!1,"#8a99c7",4,6),25:new chem.Element("Mn",4,7,!1,"#9c7ac7",4,7),26:new chem.Element("Fe",4,8,!1,"#e06633",4,8),27:new chem.Element("Co",4,8,!1,"#f08fa1",4,9),28:new chem.Element("Ni",4,8,!1,"#4fd14f",4,10),29:new chem.Element("Cu",4,1,!1,"#c78033",4,11),30:new chem.Element("Zn",4,2,!1,"#7d80b0",4,12),31:new chem.Element("Ga",4,3,!1,"#c28f8f",4,13),32:new chem.Element("Ge",4,4,!1,"#668f8f",4,14),33:new chem.Element("As",4,5,!1,"#bd80e3",4,15),34:new chem.Element("Se",4,6,!0,"#ffa100",4,16),35:new chem.Element("Br",4,7,!0,"#a62929",4,17),36:new chem.Element("Kr",4,8,!1,"#5cb8d1",4,18),37:new chem.Element("Rb",5,1,!1,"#702eb0",5,1),38:new chem.Element("Sr",5,2,!1,"#00ff00",5,2),39:new chem.Element("Y",5,3,!1,"#94ffff",5,3),40:new chem.Element("Zr",5,4,!1,"#94e0e0",5,4),41:new chem.Element("Nb",5,5,!1,"#73c2c9",5,5),42:new chem.Element("Mo",5,6,!1,"#54b5b5",5,6),43:new chem.Element("Tc",5,7,!1,"#3b9e9e",5,7),44:new chem.Element("Ru",5,8,!1,"#248f8f",5,8),45:new chem.Element("Rh",5,8,!1,"#0a7d8c",5,9),46:new chem.Element("Pd",5,8,!1,"#006985",5,10),47:new chem.Element("Ag",5,1,!1,"#bfbfbf",5,11),48:new chem.Element("Cd",5,2,!1,"#ffd98f",5,12),49:new chem.Element("In",5,3,!1,"#a67573",5,13),50:new chem.Element("Sn",5,4,!1,"#668080",5,14),51:new chem.Element("Sb",5,5,!1,"#9e63b5",5,15),52:new chem.Element("Te",5,6,!1,"#d47a00",5,16),53:new chem.Element("I",5,7,!0,"#940094",5,17),54:new chem.Element("Xe",5,8,!1,"#429eb0",5,18),55:new chem.Element("Cs",6,1,!1,"#57178f",6,1),56:new chem.Element("Ba",6,2,!1,"#00c900",6,2),57:new chem.Element("La",6,3,!1,"#70d4ff",6,3),58:new chem.Element("Ce",6,3,!1,"#ffffc7",8,4),59:new chem.Element("Pr",6,3,!1,"#d9ffc7",8,5),60:new chem.Element("Nd",6,3,!1,"#c7ffc7",8,6),61:new chem.Element("Pm",6,3,!1,"#a3ffc7",8,7),62:new chem.Element("Sm",6,3,!1,"#8fffc7",8,8),63:new chem.Element("Eu",6,3,!1,"#61ffc7",8,9),64:new chem.Element("Gd",6,3,!1,"#45ffc7",8,10),65:new chem.Element("Tb",6,3,!1,"#30ffc7",8,11),66:new chem.Element("Dy",6,3,!1,"#1fffc7",8,12),67:new chem.Element("Ho",6,3,!1,"#00ff9c",8,13),68:new chem.Element("Er",6,3,!1,"#00e675",8,14),69:new chem.Element("Tm",6,3,!1,"#00d452",8,15),70:new chem.Element("Yb",6,3,!1,"#00bf38",8,16),71:new chem.Element("Lu",6,3,!1,"#00ab24",8,17),72:new chem.Element("Hf",6,4,!1,"#4dc2ff",6,4),73:new chem.Element("Ta",6,5,!1,"#4da6ff",6,5),74:new chem.Element("W",6,6,!1,"#2194d6",6,6),75:new chem.Element("Re",6,7,!1,"#267dab",6,7),76:new chem.Element("Os",6,8,!1,"#266696",6,8),77:new chem.Element("Ir",6,8,!1,"#175487",6,9),78:new chem.Element("Pt",6,8,!1,"#d1d1e0",6,10),79:new chem.Element("Au",6,1,!1,"#ffd124",6,11),80:new chem.Element("Hg",6,2,!1,"#b8b8d1",6,12),81:new chem.Element("Tl",6,3,!1,"#a6544d",6,13),82:new chem.Element("Pb",6,4,!1,"#575961",6,14),83:new chem.Element("Bi",6,5,!1,"#9e4fb5",6,15),84:new chem.Element("Po",6,6,!1,"#ab5c00",6,16),85:new chem.Element("At",6,7,!1,"#754f45",6,17),86:new chem.Element("Rn",6,8,!1,"#428296",6,18),87:new chem.Element("Fr",7,1,!1,"#420066",7,1),88:new chem.Element("Ra",7,2,!1,"#007d00",7,2),89:new chem.Element("Ac",7,3,!1,"#70abfa",7,3),90:new chem.Element("Th",7,3,!1,"#00baff",9,4),91:new chem.Element("Pa",7,3,!1,"#00a1ff",9,5),92:new chem.Element("U",7,3,!1,"#008fff",9,6),93:new chem.Element("Np",7,3,!1,"#0080ff",9,7),94:new chem.Element("Pu",7,3,!1,"#006bff",9,8),95:new chem.Element("Am",7,3,!1,"#545cf2",9,9),96:new chem.Element("Cm",7,3,!1,"#785ce3",9,10),97:new chem.Element("Bk",7,3,!1,"#8a4fe3",9,11),98:new chem.Element("Cf",7,3,!1,"#a136d4",9,12),99:new chem.Element("Es",7,3,!1,"#b31fd4",9,13),100:new chem.Element("Fm",7,3,!1,"#000000",9,14),101:new chem.Element("Md",7,3,!1,"#000000",9,15),102:new chem.Element("No",7,3,!1,"#000000",9,16),103:new chem.Element("Lr",7,3,!1,"#000000",9,17),104:new chem.Element("Rf",7,4,!1,"#4dc2ff",7,4),105:new chem.Element("Db",7,5,!1,"#4da6ff",7,5),106:new chem.Element("Sg",7,6,!1,"#2194d6",7,6),107:new chem.Element("Bh",7,7,!1,"#267dab",7,7),108:new chem.Element("Hs",7,8,!1,"#266696",7,8),109:new chem.Element("Mt",7,8,!1,"#175487",7,9),110:new chem.Element("Ds",7,8,!1,"#d1d1e0",7,10),111:new chem.Element("Rg",7,1,!1,"#ffd124",7,11),112:new chem.Element("Cn",7,2,!1,"#b8b8d1",7,12)}),chem.Element.labelMap=null,chem.Element.getElementByLabel=function(t){return this.labelMap||(this.labelMap={},this.elements.each(function(t,e){this.labelMap[e.label]=t-0},this)),this.labelMap.hasOwnProperty(t)?this.labelMap[t]:null},!window.chem||!util.Vec2||!util.Pool)throw new Error("Vec2, Pool should be defined first");if(chem.SGroup=function(t){if(!(t&&t in chem.SGroup.TYPES))throw new Error("Invalid or unsupported s-group type");this.type=t,this.id=-1,chem.SGroup.equip(this,t),this.label=-1,this.bracketBox=null,this.bracketDir=new util.Vec2(1,0),this.areas=[],this.highlight=!1,this.highlighting=null,this.selected=!1,this.selectionPlate=null,this.atoms=[],this.patoms=[],this.bonds=[],this.xBonds=[],this.neiAtoms=[],this.pp=null,this.data={mul:1,connectivity:"ht",name:"",subscript:"n",attached:!1,absolute:!0,showUnits:!1,nCharsToDisplay:-1,tagChar:"",daspPos:1,fieldType:"F",fieldName:"",fieldValue:"",units:"",query:"",queryOp:""}},chem.SGroup.prototype.getAttr=function(t){return this.data[t]},chem.SGroup.prototype.getAttrs=function(){var t={};for(var e in this.data)t[e]=this.data[e];return t},chem.SGroup.prototype.setAttr=function(t,e){var n=this.data[t];return this.data[t]=e,n},chem.SGroup.prototype.checkAttr=function(t,e){return this.data[t]==e},chem.SGroup.equip=function(t,e){var n=chem.SGroup.TYPES[e];for(var r in n)t[r]=n[r]},chem.SGroup.numberArrayToString=function(t,e){for(var n=util.stringPadded(t.length,3),r=0;r<t.length;++r)n+=" "+util.stringPadded(e[t[r]],3);return n},chem.SGroup.addGroup=function(t,e,n){e.id=t.sgroups.add(e),e.postLoad(t,n);for(var r=0;r<e.atoms.length;++r)t.atoms.has(e.atoms[r])&&util.Set.add(t.atoms.get(e.atoms[r]).sgs,e.id);return t.sGroupForest.insert(e.id),e.id},chem.SGroup.bracketsToMolfile=function(t,e,n){var r=[],i=[],o=util.Set.fromList(e.atoms);chem.SGroup.getCrossBonds(r,i,t,o),chem.SGroup.bracketPos(e,null,t,i);for(var s=e.bracketBox,a=e.bracketDir,l=a.rotateSC(1,0),c=chem.SGroup.getBracketParameters(t,i,o,s,a,l,null,e.id),h=[],u=0;u<c.length;++u){for(var d=c[u],p=d.c.addScaled(d.n,-.5*d.h).yComplement(),f=d.c.addScaled(d.n,.5*d.h).yComplement(),m="M  SDI "+n+util.paddedInt(4,3),g=[p.x,p.y,f.x,f.y],b=0;b<g.length;++b)m+=util.paddedFloat(g[b],10,4);h.push(m)}return h},chem.SGroup.filterAtoms=function(t,e){for(var n=[],r=0;r<t.length;++r){var i=t[r];"number"!=typeof e[i]?n.push(i):e[i]>=0?n.push(e[i]):n.push(-1)}return n},chem.SGroup.removeNegative=function(t){for(var e=[],n=0;n<t.length;++n)t[n]>=0&&e.push(t[n]);return e},chem.SGroup.filter=function(t,e,n){e.atoms=chem.SGroup.removeNegative(chem.SGroup.filterAtoms(e.atoms,n))},chem.SGroup.clone=function(t,e,n){var r=new chem.SGroup(t.type);for(var i in t.data)r.data[i]=t.data[i];return r.atoms=util.mapArray(t.atoms,e),r.pp=t.pp,r.bracketBox=t.bracketBox,r.patoms=null,r.bonds=null,r.allAtoms=t.allAtoms,r},chem.SGroup.addAtom=function(t,e){t.atoms.push(e)},chem.SGroup.removeAtom=function(t,e){for(var n=0;n<t.atoms.length;++n)if(t.atoms[n]===e)return void t.atoms.splice(n,1);throw new Error("The atom is not found in the given s-group")},chem.SGroup.getCrossBonds=function(t,e,n,r){n.bonds.each(function(n,i){util.Set.contains(r,i.begin)&&util.Set.contains(r,i.end)?util.isNull(t)||t.push(n):(util.Set.contains(r,i.begin)||util.Set.contains(r,i.end))&&(util.isNull(e)||e.push(n))},this)},chem.SGroup.bracketPos=function(t,e,n,r){var i=t.atoms;if(r&&2===r.length){var o=n.bonds.get(r[0]),s=n.bonds.get(r[1]),a=o.getCenter(n),l=s.getCenter(n);t.bracketDir=util.Vec2.diff(l,a).normalized()}else t.bracketDir=new util.Vec2(1,0);var c=t.bracketDir,h=c.rotateSC(1,0),u=null,d=[];util.each(i,function(t){var r=n.atoms.get(t),i=e?e.ctab.atoms.get(t).visel.boundingBox:null,o=new util.Vec2(r.pp);if(util.isNull(i)){i=new util.Box2Abs(o,o);var s=new util.Vec2(.05*3,.05*3);i=i.extend(s,s)}else i=i.translate((e.offset||new util.Vec2).negated()).transform(e.scaled2obj,e);d.push(i)},this),util.each(n.sGroupForest.children.get(t.id),function(t){var n=e?e.ctab.sgroups.get(t).visel.boundingBox:null;util.isNull(n)||(n=n.translate((e.offset||new util.Vec2).negated()).transform(e.scaled2obj,e),d.push(n))},this),util.each(d,function(t){var e=null;util.each([t.p0.x,t.p1.x],function(n){util.each([t.p0.y,t.p1.y],function(t){var r=new util.Vec2(n,t),i=new util.Vec2(util.Vec2.dot(r,c),util.Vec2.dot(r,h));e=util.isNull(e)?new util.Box2Abs(i,i):e.include(i)},this)},this),u=util.isNull(u)?e:util.Box2Abs.union(u,e)},this);var p=new util.Vec2(.2,.4);util.isNull(u)||(u=u.extend(p,p)),t.bracketBox=u},chem.SGroup.drawBrackets=function(t,e,n,r,i,o,s,a,l,c,h){for(var u=chem.SGroup.getBracketParameters(e.ctab.molecule,r,i,o,s,a,e,n.id),d=-1,p=0;p<u.length;++p){var f=u[p],m=chem.SGroup.drawBracket(e,e.paper,e.styles,f.d,f.n,f.c,f.w,f.h);t.push(m),(0>d||u[d].d.x<f.d.x||u[d].d.x==f.d.x&&u[d].d.y>f.d.y)&&(d=p)}var g=u[d],b=function(n,r){var i=e.ps(g.c.addScaled(g.n,r*g.h)),o=e.paper.text(i.x,i.y,n).attr({font:e.settings.font,"font-size":e.settings.fontszsub});h&&o.attr(h);var s=util.Box2Abs.fromRelBox(rnd.relBox(o.getBBox())),a=Math.max(util.Vec2.shiftRayBox(i,g.d.negated(),s),3)+2;o.translateAbs(a*g.d.x,a*g.d.y),t.push(o)};l&&b(l,.5),c&&b(c,-.5)},chem.SGroup.drawBracket=function(t,e,n,r,i,o,s,a){s=s||.25,a=a||1;var l=o.addScaled(i,-.5*a),c=o.addScaled(i,.5*a),h=l.addScaled(r,-s),u=c.addScaled(r,-s);return l=t.obj2scaled(l),c=t.obj2scaled(c),h=t.obj2scaled(h),u=t.obj2scaled(u),e.path("M {0}, {1} L {2} , {3} L {4} , {5} L {6} , {7}",h.x,h.y,l.x,l.y,c.x,c.y,u.x,u.y).attr(n.sgroupBracketStyle)},chem.SGroup.getBracketParameters=function(t,e,n,r,i,o,s,a){var l=function(t,e,n,r){this.c=t,this.d=e,this.n=e.rotateSC(1,0),this.w=n,this.h=r},c=[];return e.length<2?!function(){i=i||new util.Vec2(1,0),o=o||i.rotateSC(1,0);var t=Math.min(.25,.3*r.sz().x),e=util.Vec2.lc2(i,r.p0.x,o,.5*(r.p0.y+r.p1.y)),n=util.Vec2.lc2(i,r.p1.x,o,.5*(r.p0.y+r.p1.y)),s=r.sz().y;c.push(new l(e,i.negated(),t,s),new l(n,i,t,s))}():2===e.length?!function(){var n=t.bonds.get(e[0]),r=t.bonds.get(e[1]),i=n.getCenter(t),o=r.getCenter(t),h=-1,u=-1,d=-1,p=-1,f=util.Vec2.centre(i,o),m=util.Vec2.diff(o,i).normalized(),g=m.negated(),b=m.rotateSC(1,0),v=b.negated();util.each(t.sGroupForest.children.get(a),function(t){var e=s?s.ctab.sgroups.get(t).visel.boundingBox:null;util.isNull(e)||(e=e.translate((s.offset||new util.Vec2).negated()).transform(s.scaled2obj,s),h=Math.max(h,util.Vec2.shiftRayBox(i,g,e)),u=Math.max(u,util.Vec2.shiftRayBox(o,m,e)),d=Math.max(d,util.Vec2.shiftRayBox(f,b,e)),p=Math.max(p,util.Vec2.shiftRayBox(f,v,e)))},this),h=Math.max(h+.2,0),u=Math.max(u+.2,0),d=Math.max(Math.max(d,p)+.1,0);var y=.25,x=1.5+d;c.push(new l(i.addScaled(g,h),g,y,x),new l(o.addScaled(m,u),m,y,x))}():!function(){for(var r=0;r<e.length;++r){var i=t.bonds.get(e[r]),o=i.getCenter(t),s=util.Set.contains(n,i.begin)?i.getDir(t):i.getDir(t).negated();c.push(new l(o,s,.2,1))}}(),c},chem.SGroup.getObjBBox=function(t,e){if(0==t.length)throw new Error("Atom list is empty");for(var n=e.atoms.get(t[0]).pp,r=new util.Box2Abs(n,n),i=1;i<t.length;++i){var o=t[i],s=e.atoms.get(o),a=s.pp;r=r.include(a)}return r},chem.SGroup.makeAtomBondLines=function(t,e,n,r){if(!n)return[];for(var i=[],o=0;o<Math.floor((n.length+14)/15);++o){for(var s=Math.min(n.length-15*o,15),a="M  "+t+" "+e+" "+util.paddedInt(s,2),l=0;s>l;++l)a+=" "+util.paddedInt(r[n[15*o+l]],3);i.push(a)}return i},chem.SGroup.getAtoms=function(t,e){if(!e.allAtoms)return e.atoms;var n=[];return t.atoms.each(function(t){n.push(t)}),n},chem.SGroup.getBonds=function(t,e){var n=chem.SGroup.getAtoms(t,e),r=[];return t.bonds.each(function(t,e){n.indexOf(e.begin)>=0&&n.indexOf(e.end)>=0&&r.push(t)}),r},chem.SGroup.GroupMul={draw:function(t){var e=t.render,n=e.paper.set(),r=[],i=[],o=util.Set.fromList(this.atoms);chem.SGroup.getCrossBonds(r,i,t.molecule,o),chem.SGroup.bracketPos(this,e,t.molecule,i);var s=this.bracketBox,a=this.bracketDir,l=a.rotateSC(1,0);return this.areas=[s],chem.SGroup.drawBrackets(n,e,this,i,o,s,a,l,this.data.mul),n},saveToMolfile:function(t,e,n,r){var i=util.stringPadded(e[this.id],3),o=[];o=o.concat(chem.SGroup.makeAtomBondLines("SAL",i,util.idList(this.atomSet),n)),o=o.concat(chem.SGroup.makeAtomBondLines("SPA",i,util.idList(this.parentAtomSet),n)),o=o.concat(chem.SGroup.makeAtomBondLines("SBL",i,this.bonds,r));var s="M  SMT "+i+" "+this.data.mul;return o.push(s),o=o.concat(chem.SGroup.bracketsToMolfile(t,this,i)),o.join("\n")},prepareForSaving:function(t){var e;this.atoms.sort(),this.atomSet=util.Set.fromList(this.atoms),this.parentAtomSet=util.Set.clone(this.atomSet);var n=[],r=[];if(t.bonds.each(function(t,e){util.Set.contains(this.parentAtomSet,e.begin)&&util.Set.contains(this.parentAtomSet,e.end)?n.push(t):(util.Set.contains(this.parentAtomSet,e.begin)||util.Set.contains(this.parentAtomSet,e.end))&&r.push(t)},this),0!=r.length&&2!=r.length)throw{id:this.id,"error-type":"cross-bond-number",message:"Unsupported cross-bonds number"};var i=-1,o=-1,s=null;if(2==r.length){var a=t.bonds.get(r[0]);i=util.Set.contains(this.parentAtomSet,a.begin)?a.begin:a.end;var l=t.bonds.get(r[1]);o=util.Set.contains(this.parentAtomSet,l.begin)?l.begin:l.end,s=l}var c=null,h=i,u=[];for(e=0;e<this.data.mul-1;++e)if(c={},util.each(this.atoms,function(e){var n=t.atoms.get(e),r=t.atoms.add(new chem.Struct.Atom(n));u.push(r),this.atomSet[r]=1,c[e]=r},this),util.each(n,function(e){var n=t.bonds.get(e),r=new chem.Struct.Bond(n);r.begin=c[r.begin],r.end=c[r.end],t.bonds.add(r)},this),null!=s){var d=new chem.Struct.Bond(s);d.begin=h,d.end=c[o],t.bonds.add(d),h=c[i]}if(util.each(u,function(e){util.each(t.sGroupForest.getPathToRoot(this.id).reverse(),function(n){t.atomAddToSGroup(n,e)},this)},this),h>=0){var p=t.bonds.get(r[0]);p.begin==i?p.begin=h:p.end=h}this.bonds=r},postLoad:function(t,e){this.data.mul=this.data.subscript-0;var n={};this.atoms=chem.SGroup.filterAtoms(this.atoms,e),this.patoms=chem.SGroup.filterAtoms(this.patoms,e);for(var r=1;r<this.data.mul;++r)for(var i=0;i<this.patoms.length;++i){var o=this.atoms[r*this.patoms.length+i];if(!(0>o)){if(this.patoms[i]<0)throw new Error("parent atom missing");n[o]=this.patoms[i]}}this.patoms=chem.SGroup.removeNegative(this.patoms);var s=util.identityMap(this.patoms),a=[];t.bonds.each(function(t,e){var r=e.begin in n,i=e.end in n;r&&i||r&&e.end in s||i&&e.begin in s?a.push(t):r?e.begin=n[e.begin]:i&&(e.end=n[e.end])},this);for(var l=0;l<a.length;++l)t.bonds.remove(a[l]);for(var c in n)t.atoms.remove(c),e[c]=-1;this.atoms=this.patoms,this.patoms=null}},chem.SGroup.GroupSru={draw:function(t){var e=t.render,n=e.paper.set(),r=[],i=[],o=util.Set.fromList(this.atoms);chem.SGroup.getCrossBonds(r,i,t.molecule,o),chem.SGroup.bracketPos(this,e,t.molecule,i);var s=this.bracketBox,a=this.bracketDir,l=a.rotateSC(1,0);this.areas=[s];var c=this.data.connectivity||"eu";"ht"==c&&(c="");var h=this.data.subscript||"n";return chem.SGroup.drawBrackets(n,e,this,i,o,s,a,l,h,c),n},saveToMolfile:function(t,e,n,r){var i=util.stringPadded(e[this.id],3),o=[];return o=o.concat(chem.SGroup.makeAtomBondLines("SAL",i,this.atoms,n)),o=o.concat(chem.SGroup.makeAtomBondLines("SBL",i,this.bonds,r)),o=o.concat(chem.SGroup.bracketsToMolfile(t,this,i)),o.join("\n")},prepareForSaving:function(t){var e=[];if(t.bonds.each(function(n,r){var i=t.atoms.get(r.begin),o=t.atoms.get(r.end);(util.Set.contains(i.sgs,this.id)&&!util.Set.contains(o.sgs,this.id)||util.Set.contains(o.sgs,this.id)&&!util.Set.contains(i.sgs,this.id))&&e.push(n)},this),0!=e.length&&2!=e.length)throw{id:this.id,"error-type":"cross-bond-number",message:"Unsupported cross-bonds number"};this.bonds=e},postLoad:function(t,e){this.data.connectivity=(this.data.connectivity||"EU").strip().toLowerCase()}},chem.SGroup.GroupSup={draw:function(t){var e=t.render,n=e.paper.set(),r=[],i=[],o=util.Set.fromList(this.atoms);chem.SGroup.getCrossBonds(r,i,t.molecule,o),chem.SGroup.bracketPos(this,e,t.molecule,i);var s=this.bracketBox,a=this.bracketDir,l=a.rotateSC(1,0);return this.areas=[s],chem.SGroup.drawBrackets(n,e,this,i,o,s,a,l,this.data.name,null,{"font-style":"italic"}),n},saveToMolfile:function(t,e,n,r){var i=util.stringPadded(e[this.id],3),o=[];return o=o.concat(chem.SGroup.makeAtomBondLines("SAL",i,this.atoms,n)),o=o.concat(chem.SGroup.makeAtomBondLines("SBL",i,this.bonds,r)),this.data.name&&""!=this.data.name&&o.push("M  SMT "+i+" "+this.data.name),o.join("\n")},prepareForSaving:function(t){var e=[];t.bonds.each(function(n,r){var i=t.atoms.get(r.begin),o=t.atoms.get(r.end);(util.Set.contains(i.sgs,this.id)&&!util.Set.contains(o.sgs,this.id)||util.Set.contains(o.sgs,this.id)&&!util.Set.contains(i.sgs,this.id))&&e.push(n)},this),this.bonds=e},postLoad:function(t,e){this.data.name=(this.data.subscript||"").strip(),this.data.subscript=""}},chem.SGroup.GroupGen={draw:function(t){var e=t.render,n=(e.settings,e.styles,e.paper),r=n.set(),i=[],o=[],s=util.Set.fromList(this.atoms);chem.SGroup.getCrossBonds(i,o,t.molecule,s),chem.SGroup.bracketPos(this,e,t.molecule,o);var a=this.bracketBox,l=this.bracketDir,c=l.rotateSC(1,0);return this.areas=[a],chem.SGroup.drawBrackets(r,e,this,o,s,a,l,c),r},saveToMolfile:function(t,e,n,r){var i=util.stringPadded(e[this.id],3),o=[];return o=o.concat(chem.SGroup.makeAtomBondLines("SAL",i,this.atoms,n)),o=o.concat(chem.SGroup.makeAtomBondLines("SBL",i,this.bonds,r)),o=o.concat(chem.SGroup.bracketsToMolfile(t,this,i)),o.join("\n")},prepareForSaving:function(t){},postLoad:function(t,e){}},chem.SGroup.getMassCentre=function(t,e){for(var n=new util.Vec2,r=0;r<e.length;++r)n=n.addScaled(t.atoms.get(e[r]).pp,1/e.length);return n},chem.SGroup.setPos=function(t,e,n){e.pp=n},chem.SGroup.GroupDat={showValue:function(t,e,n,r){var i=t.text(e.x,e.y,n.data.fieldValue).attr({font:r.font,"font-size":r.fontsz});return i},draw:function(t){var e,n=t.render,r=n.settings,i=n.paper,o=i.set(),s=chem.SGroup.getAtoms(t,this);chem.SGroup.bracketPos(this,n,t.molecule),this.areas=this.bracketBox?[this.bracketBox]:[],null==this.pp&&chem.SGroup.setPos(t,this,this.bracketBox.p1.add(new util.Vec2(.5,.5)));var a=this.pp.scaled(r.scaleFactor);if(this.data.attached)for(e=0;e<s.length;++e){var l=t.atoms.get(s[e]),c=n.ps(l.a.pp),h=l.visel.boundingBox;null!=h&&(c.x=Math.max(c.x,h.p1.x)),c.x+=r.lineWidth;var u=this.showValue(i,c,this,r),d=rnd.relBox(u.getBBox());u.translateAbs(.5*d.width,-.3*d.height),o.push(u);var p=util.Box2Abs.fromRelBox(rnd.relBox(u.getBBox()));p=p.transform(n.scaled2obj,n),this.areas.push(p)}else{var f=this.showValue(i,a,this,r),m=rnd.relBox(f.getBBox());f.translateAbs(.5*m.width,-.5*m.height),o.push(f);var g=util.Box2Abs.fromRelBox(rnd.relBox(f.getBBox()));this.dataArea=g.transform(n.scaled2obj,n),t.sgroupData.has(this.id)||t.sgroupData.set(this.id,new rnd.ReDataSGroupData(this))}return o},saveToMolfile:function(t,e,n,r){var i=util.stringPadded(e[this.id],3),o=this.data,s=this.pp;o.absolute||(s=s.sub(chem.SGroup.getMassCentre(t,this.atoms)));var a=[];a=a.concat(chem.SGroup.makeAtomBondLines("SAL",i,this.atoms,n));var l="M  SDT "+i+" "+util.stringPadded(o.fieldName,30,!0)+util.stringPadded(o.fieldType,2)+util.stringPadded(o.units,20,!0)+util.stringPadded(o.query,2)+util.stringPadded(o.queryOp,3);a.push(l);var c="M  SDD "+i+" "+util.paddedFloat(s.x,10,4)+util.paddedFloat(-s.y,10,4)+"    "+(o.attached?"A":"D")+(o.absolute?"A":"R")+(o.showUnits?"U":" ")+"   "+(o.nCharnCharsToDisplay>=0?util.paddedInt(o.nCharnCharsToDisplay,3):"ALL")+"  1   "+util.stringPadded(o.tagChar,1)+"  "+util.paddedInt(o.daspPos,1)+"  ";return a.push(c),o.fieldValue.replace(/[\r\n|\n|\r]*$/,"").split(/\r\n|\n|\r/).each(function(t){for(var e=69;t.length>e;)a.push("M  SCD "+i+" "+t.slice(0,e)),t=t.slice(69);a.push("M  SED "+i+" "+util.stringPadded(t,e,!0))},this),a.join("\n")},prepareForSaving:function(t){this.atoms=chem.SGroup.getAtoms(t,this)},postLoad:function(t,e){var n=this.atoms.length==t.atoms.count();this.data.absolute||(this.pp=this.pp.add(chem.SGroup.getMassCentre(t,this.atoms))),!n||"MDLBG_FRAGMENT_STEREO"!=this.data.fieldName&&"MDLBG_FRAGMENT_COEFFICIENT"!=this.data.fieldName&&"MDLBG_FRAGMENT_CHARGE"!=this.data.fieldName||(this.atoms=[],this.allAtoms=!0)}},chem.SGroup.TYPES={MUL:chem.SGroup.GroupMul,SRU:chem.SGroup.GroupSru,SUP:chem.SGroup.GroupSup,DAT:chem.SGroup.GroupDat,GEN:chem.SGroup.GroupGen},chem.SGroupForest=function(t){this.parent=new util.Map,this.children=new util.Map,this.children.set(-1,[]),this.molecule=t},chem.SGroupForest.prototype.getSGroupsBFS=function(){var t=[],e=[],n=-1;for(e=util.array(this.children.get(-1));e.length>0;){var n=e.shift();e=e.concat(this.children.get(n)),t.push(n)}return t},chem.SGroupForest.prototype.getAtomSets=function(){return this.molecule.sgroups.map(function(t,e){return util.Set.fromList(e.atoms)})},chem.SGroupForest.prototype.getAtomSetRelations=function(t,e,n){var r=new util.Map,i=new util.Map,n=this.getAtomSets();n.unset(t),n.each(function(t,n){i.set(t,util.Set.subset(e,n)),r.set(t,util.Set.subset(n,e)&&!util.Set.eq(n,e))},this);var o=n.findAll(function(t){return i.get(t)?util.find(this.children.get(t),function(t){return i.get(t)},this)>=0?!1:!0:!1},this);util.assert(o.length<=1);var s=n.findAll(function(t,e){return r.get(t)&&!r.get(this.parent.get(t))},this);return{children:s,parent:0===o.length?-1:o[0]}},chem.SGroupForest.prototype.getPathToRoot=function(t){for(var e=[],n=t;n>=0;n=this.parent.get(n))util.assert(e.indexOf(n)<0,"SGroupForest: loop detected"),e.push(n);return e},chem.SGroupForest.prototype.validate=function(){var t=this.getAtomSets();this.molecule.sgroups.each(function(t){this.getPathToRoot(t)},this);var e=!0;return this.parent.each(function(n,r){r>=0&&!util.Set.subset(t.get(n),t.get(r))&&(e=!1)},this),this.children.each(function(n){for(var r=this.children.get(n),i=0;i<r.length;++i)for(var o=i+1;o<r.length;++o)util.Set.disjoint(t.get(r[i]),t.get(r[o]))||(e=!1)},this),e},chem.SGroupForest.prototype.insert=function(t,e,n){util.assert(!this.parent.has(t),"sgid already present in the forest"),util.assert(!this.children.has(t),"sgid already present in the forest"),util.assert(this.validate(),"s-group forest invalid");var r=this.getAtomSets(),i=util.Set.fromList(this.molecule.sgroups.get(t).atoms);if(util.isUndefined(e)||util.isUndefined(n)){var o=this.getAtomSetRelations(t,i,r);e=o.parent,n=o.children}return util.each(n,function(e){util.assert(1===util.arrayRemoveByValue(this.children.get(this.parent.get(e)),e)),this.parent.set(e,t)},this),this.children.set(t,n),this.parent.set(t,e),this.children.get(e).push(t),util.assert(this.validate(),"s-group forest invalid"),{parent:e,
children:n}},chem.SGroupForest.prototype.remove=function(t){util.assert(this.parent.has(t),"sgid is not in the forest"),util.assert(this.children.has(t),"sgid is not in the forest"),util.assert(this.validate(),"s-group forest invalid");var e=this.parent.get(t);util.each(this.children.get(t),function(t){this.parent.set(t,e),this.children.get(e).push(t)},this),util.assert(1===util.arrayRemoveByValue(this.children.get(e),t)),this.children.unset(t),this.parent.unset(t),util.assert(this.validate(),"s-group forest invalid")},!window.chem||!util.Vec2||!util.Pool)throw new Error("Vec2, Pool should be defined first");if(chem.Struct=function(){this.atoms=new util.Pool,this.bonds=new util.Pool,this.sgroups=new util.Pool,this.halfBonds=new util.Map,this.loops=new util.Pool,this.isChiral=!1,this.isReaction=!1,this.rxnArrows=new util.Pool,this.rxnPluses=new util.Pool,this.frags=new util.Pool,this.rgroups=new util.Map,this.name="",this.sGroupForest=new chem.SGroupForest(this)},chem.Struct.prototype.hasRxnProps=function(){return this.atoms.find(function(t,e){return e.hasRxnProps()},this)>=0||this.bonds.find(function(t,e){return e.hasRxnProps()},this)>=0},chem.Struct.prototype.hasRxnArrow=function(){return this.rxnArrows.count()>0},chem.Struct.prototype.addRxnArrowIfNecessary=function(){var t=!this.hasRxnArrow()&&this.hasRxnProps();return t&&this.rxnArrows.add(new chem.Struct.RxnArrow),t},chem.Struct.prototype.getSGroupsInAtomSet=function(t){var e=new Hash;util.each(t,function(t){var n=util.Set.list(this.atoms.get(t).sgs);n.each(function(t){var n=e.get(t);Object.isUndefined(n)?n=1:n++,e.set(t,n)},this)},this);var n=[];return e.each(function(t){var e=parseInt(t.key),r=this.sgroups.get(e),i=chem.SGroup.getAtoms(this,r);t.value==i.length&&n.push(e)},this),n},chem.Struct.prototype.isBlank=function(){return 0==this.atoms.count()&&0==this.rxnArrows.count()&&0==this.rxnPluses.count()&&!this.isChiral},chem.Struct.prototype.toLists=function(){var t={},e=[];this.atoms.each(function(n,r){t[n]=e.length,e.push(r)});var n=[];return this.bonds.each(function(e,r){var i=new chem.Struct.Bond(r);i.begin=t[r.begin],i.end=t[r.end],n.push(i)}),{atoms:e,bonds:n}},chem.Struct.prototype.clone=function(t,e,n,r){var i=new chem.Struct;return this.mergeInto(i,t,e,n,!1,r)},chem.Struct.prototype.getScaffold=function(){var t=util.Set.empty();return this.atoms.each(function(e){util.Set.add(t,e)},this),this.rgroups.each(function(e,n){n.frags.each(function(e,n){this.atoms.each(function(e,r){r.fragment==n&&util.Set.remove(t,e)},this)},this)},this),this.clone(t)},chem.Struct.prototype.getFragmentIds=function(t){var e=util.Set.empty();return this.atoms.each(function(n,r){r.fragment==t&&util.Set.add(e,n)},this),e},chem.Struct.prototype.getFragment=function(t){return this.clone(this.getFragmentIds(t))},chem.Struct.prototype.mergeInto=function(t,e,n,r,i,o){e=e||util.Set.keySetInt(this.atoms),n=n||util.Set.keySetInt(this.bonds),n=util.Set.filter(n,function(t){var n=this.bonds.get(t);return util.Set.contains(e,n.begin)&&util.Set.contains(e,n.end)},this);var s={};this.atoms.each(function(t,n){util.Set.contains(e,t)&&(s[n.fragment]=1)});var a={};this.frags.each(function(e,n){s[e]&&(a[e]=t.frags.add(n.clone()))}),this.rgroups.each(function(e,n){var r=i;if(r||(n.frags.each(function(t,e){s[e]&&(r=!0)}),r)){var o=t.rgroups.get(e);o?n.frags.each(function(t,e){s[e]&&o.frags.add(a[e])}):t.rgroups.set(e,n.clone(a))}}),("undefined"==typeof o||null===o)&&(o={}),this.atoms.each(function(n,r){util.Set.contains(e,n)&&(o[n]=t.atoms.add(r.clone(a)))});var l={};return this.bonds.each(function(e,r){util.Set.contains(n,e)&&(l[e]=t.bonds.add(r.clone(o)))}),this.sgroups.each(function(n,r){var i;for(i=0;i<r.atoms.length;++i)if(!util.Set.contains(e,r.atoms[i]))return;r=chem.SGroup.clone(r,o,l);var s=t.sgroups.add(r);for(r.id=s,i=0;i<r.atoms.length;++i)util.Set.add(t.atoms.get(r.atoms[i]).sgs,s);t.sGroupForest.insert(r.id)}),t.isChiral=this.isChiral,r||(t.isReaction=this.isReaction,this.rxnArrows.each(function(e,n){t.rxnArrows.add(n.clone())}),this.rxnPluses.each(function(e,n){t.rxnPluses.add(n.clone())})),t},chem.Struct.prototype.findBondId=function(t,e){var n=-1;return this.bonds.find(function(r,i){return i.begin==t&&i.end==e||i.begin==e&&i.end==t?(n=r,!0):!1},this),n},chem.Struct.ATOM={RADICAL:{NONE:0,SINGLET:1,DOUPLET:2,TRIPLET:3}},chem.Struct.radicalElectrons=function(t){if(t-=0,t==chem.Struct.ATOM.RADICAL.NONE)return 0;if(t==chem.Struct.ATOM.RADICAL.DOUPLET)return 1;if(t==chem.Struct.ATOM.RADICAL.SINGLET||t==chem.Struct.ATOM.RADICAL.TRIPLET)return 2;throw new Error("Unknown radical value")},chem.Struct.BOND={TYPE:{SINGLE:1,DOUBLE:2,TRIPLE:3,AROMATIC:4,SINGLE_OR_DOUBLE:5,SINGLE_OR_AROMATIC:6,DOUBLE_OR_AROMATIC:7,ANY:8},STEREO:{NONE:0,UP:1,EITHER:4,DOWN:6,CIS_TRANS:3},TOPOLOGY:{EITHER:0,RING:1,CHAIN:2},REACTING_CENTER:{NOT_CENTER:-1,UNMARKED:0,CENTER:1,UNCHANGED:2,MADE_OR_BROKEN:4,ORDER_CHANGED:8,MADE_OR_BROKEN_AND_CHANGED:12}},chem.Struct.FRAGMENT={NONE:0,REACTANT:1,PRODUCT:2,AGENT:3},chem.Struct.Atom=function(t){var e=chem.Struct.Atom.attrGetDefault;if(!(t&&"label"in t))throw new Error("label must be specified!");this.label=t.label,this.fragment=Object.isUndefined(t.fragment)?-1:t.fragment,util.ifDef(this,t,"isotope",e("isotope")),util.ifDef(this,t,"radical",e("radical")),util.ifDef(this,t,"charge",e("charge")),util.ifDef(this,t,"rglabel",e("rglabel")),util.ifDef(this,t,"attpnt",e("attpnt")),util.ifDef(this,t,"explicitValence",e("explicitValence")),this.valence=0,this.implicitH=0,Object.isUndefined(t.pp)?this.pp=new util.Vec2:this.pp=new util.Vec2(t.pp),this.sgs={},util.ifDef(this,t,"ringBondCount",e("ringBondCount")),util.ifDef(this,t,"substitutionCount",e("substitutionCount")),util.ifDef(this,t,"unsaturatedAtom",e("unsaturatedAtom")),util.ifDef(this,t,"hCount",e("hCount")),util.ifDef(this,t,"aam",e("aam")),util.ifDef(this,t,"invRet",e("invRet")),util.ifDef(this,t,"exactChangeFlag",e("exactChangeFlag")),util.ifDef(this,t,"rxnFragmentType",-1),this.atomList=Object.isUndefined(t.atomList)||null==t.atomList?null:new chem.Struct.AtomList(t.atomList),this.neighbors=[],this.badConn=!1},chem.Struct.Atom.getAttrHash=function(t){var e=new Hash;for(var n in chem.Struct.Atom.attrlist)"undefined"!=typeof t[n]&&e.set(n,t[n]);return e},chem.Struct.Atom.attrGetDefault=function(t){if(t in chem.Struct.Atom.attrlist)return chem.Struct.Atom.attrlist[t];throw new Error("Attribute unknown")},chem.Struct.Atom.attrlist={label:"C",isotope:0,radical:0,charge:0,explicitValence:-1,ringBondCount:0,substitutionCount:0,unsaturatedAtom:0,hCount:0,atomList:null,invRet:0,exactChangeFlag:0,rglabel:null,attpnt:null,aam:0},chem.Struct.Atom.prototype.clone=function(t){var e=new chem.Struct.Atom(this);return t&&this.fragment in t&&(e.fragment=t[this.fragment]),e},chem.Struct.Atom.prototype.isQuery=function(){return null!=this.atomList||"A"==this.label||this.attpnt||this.hCount},chem.Struct.Atom.prototype.pureHydrogen=function(){return"H"==this.label&&0==this.isotope},chem.Struct.Atom.prototype.isPlainCarbon=function(){return"C"==this.label&&0==this.isotope&&0==this.radical&&0==this.charge&&this.explicitValence<0&&0==this.ringBondCount&&0==this.substitutionCount&&0==this.unsaturatedAtom&&0==this.hCount&&!this.atomList},chem.Struct.Atom.prototype.isPseudo=function(){return!this.atomList&&!this.rglabel&&!chem.Element.getElementByLabel(this.label)},chem.Struct.Atom.prototype.hasRxnProps=function(){return!(!this.invRet&&!this.exactChangeFlag&&util.isNull(this.attpnt)&&!this.aam)},chem.Struct.AtomList=function(t){if(!(t&&"notList"in t&&"ids"in t))throw new Error("'notList' and 'ids' must be specified!");this.notList=t.notList,this.ids=t.ids},chem.Struct.AtomList.prototype.labelList=function(){for(var t=[],e=0;e<this.ids.length;++e)t.push(chem.Element.elements.get(this.ids[e]).label);return t},chem.Struct.AtomList.prototype.label=function(){var t="["+this.labelList().join(",")+"]";return this.notList&&(t="!"+t),t},chem.Struct.AtomList.prototype.equals=function(t){return this.notList==t.notList&&(this.ids||[]).sort().toString()==(t.ids||[]).sort().toString()},chem.Struct.Bond=function(t){if(!(t&&"begin"in t&&"end"in t&&"type"in t))throw new Error("'begin', 'end' and 'type' properties must be specified!");this.begin=t.begin,this.end=t.end,this.type=t.type,util.ifDef(this,t,"stereo",chem.Struct.BOND.STEREO.NONE),util.ifDef(this,t,"topology",chem.Struct.BOND.TOPOLOGY.EITHER),util.ifDef(this,t,"reactingCenterStatus",0),this.hb1=null,this.hb2=null,this.len=0,this.center=new util.Vec2,this.sb=0,this.sa=0,this.angle=0},chem.Struct.Bond.attrlist={type:chem.Struct.BOND.TYPE.SINGLE,stereo:chem.Struct.BOND.STEREO.NONE,topology:chem.Struct.BOND.TOPOLOGY.EITHER,reactingCenterStatus:0},chem.Struct.Bond.getAttrHash=function(t){var e=new Hash;for(var n in chem.Struct.Bond.attrlist)"undefined"!=typeof t[n]&&e.set(n,t[n]);return e},chem.Struct.Bond.attrGetDefault=function(t){if(t in chem.Struct.Bond.attrlist)return chem.Struct.Bond.attrlist[t];throw new Error("Attribute unknown")},chem.Struct.Bond.prototype.hasRxnProps=function(){return!!this.reactingCenterStatus},chem.Struct.Bond.prototype.getCenter=function(t){var e=t.atoms.get(this.begin).pp,n=t.atoms.get(this.end).pp;return util.Vec2.lc2(e,.5,n,.5)},chem.Struct.Bond.prototype.getDir=function(t){var e=t.atoms.get(this.begin).pp,n=t.atoms.get(this.end).pp;return n.sub(e).normalized()},chem.Struct.Bond.prototype.clone=function(t){var e=new chem.Struct.Bond(this);return t&&(e.begin=t[e.begin],e.end=t[e.end]),e},chem.Struct.Bond.prototype.findOtherEnd=function(t){if(t==this.begin)return this.end;if(t==this.end)return this.begin;throw new Error("bond end not found")},chem.HalfBond=function(t,e,n){if(3!=arguments.length)throw new Error("Invalid parameter number!");this.begin=t-0,this.end=e-0,this.bid=n-0,this.dir=new util.Vec2,this.norm=new util.Vec2,this.ang=0,this.p=new util.Vec2,this.loop=-1,this.contra=-1,this.next=-1,this.leftSin=0,this.leftCos=0,this.leftNeighbor=0,this.rightSin=0,this.rightCos=0,this.rightNeighbor=0},chem.Struct.prototype.initNeighbors=function(){this.atoms.each(function(t,e){e.neighbors=[]}),this.bonds.each(function(t,e){var n=this.atoms.get(e.begin),r=this.atoms.get(e.end);n.neighbors.push(e.hb1),r.neighbors.push(e.hb2)},this)},chem.Struct.prototype.bondInitHalfBonds=function(t,e){e=e||this.bonds.get(t),e.hb1=2*t,e.hb2=2*t+1,this.halfBonds.set(e.hb1,new chem.HalfBond(e.begin,e.end,t)),this.halfBonds.set(e.hb2,new chem.HalfBond(e.end,e.begin,t));var n=this.halfBonds.get(e.hb1),r=this.halfBonds.get(e.hb2);n.contra=e.hb2,r.contra=e.hb1},chem.Struct.prototype.halfBondUpdate=function(t){var e=this.halfBonds.get(t),n=this.atoms.get(e.begin).pp,r=this.atoms.get(e.end).pp,i=util.Vec2.diff(r,n).normalized();e.dir=util.Vec2.dist(r,n)>1e-4?i:new util.Vec2(1,0),e.norm=e.dir.turnLeft(),e.ang=e.dir.oxAngle(),e.loop<0&&(e.loop=-1)},chem.Struct.prototype.initHalfBonds=function(){this.halfBonds.clear(),this.bonds.each(this.bondInitHalfBonds,this)},chem.Struct.prototype.setHbNext=function(t,e){this.halfBonds.get(this.halfBonds.get(t).contra).next=e},chem.Struct.prototype.halfBondSetAngle=function(t,e){var n=this.halfBonds.get(t),r=this.halfBonds.get(e);r.rightCos=n.leftCos=util.Vec2.dot(r.dir,n.dir),r.rightSin=n.leftSin=util.Vec2.cross(r.dir,n.dir),n.leftNeighbor=e,r.rightNeighbor=t},chem.Struct.prototype.atomAddNeighbor=function(t){var e=this.halfBonds.get(t),n=this.atoms.get(e.begin),r=0;for(r=0;r<n.neighbors.length&&!(this.halfBonds.get(n.neighbors[r]).ang>e.ang);++r);n.neighbors.splice(r,0,t);var i=n.neighbors[(r+1)%n.neighbors.length],o=n.neighbors[(r+n.neighbors.length-1)%n.neighbors.length];this.setHbNext(o,t),this.setHbNext(t,i),this.halfBondSetAngle(t,o),this.halfBondSetAngle(i,t)},chem.Struct.prototype.atomSortNeighbors=function(t){var e=this.atoms.get(t);e.neighbors=e.neighbors.sortBy(function(t){return this.halfBonds.get(t).ang},this);var n;for(n=0;n<e.neighbors.length;++n)this.halfBonds.get(this.halfBonds.get(e.neighbors[n]).contra).next=e.neighbors[(n+1)%e.neighbors.length];for(n=0;n<e.neighbors.length;++n)this.halfBondSetAngle(e.neighbors[(n+1)%e.neighbors.length],e.neighbors[n])},chem.Struct.prototype.sortNeighbors=function(t){util.each(t,function(t){this.atomSortNeighbors(t)},this)},chem.Struct.prototype.atomUpdateHalfBonds=function(t){for(var e=this.atoms.get(t).neighbors,n=0;n<e.length;++n){var r=e[n];this.halfBondUpdate(r),this.halfBondUpdate(this.halfBonds.get(r).contra)}},chem.Struct.prototype.updateHalfBonds=function(t){util.each(t,function(t){this.atomUpdateHalfBonds(t)},this)},chem.Struct.prototype.sGroupsRecalcCrossBonds=function(){this.sgroups.each(function(t,e){e.xBonds=[],e.neiAtoms=[]},this),this.bonds.each(function(t,e){var n=this.atoms.get(e.begin),r=this.atoms.get(e.end);util.Set.each(n.sgs,function(n){if(!util.Set.contains(r.sgs,n)){var i=this.sgroups.get(n);i.xBonds.push(t),util.arrayAddIfMissing(i.neiAtoms,e.end)}},this),util.Set.each(r.sgs,function(r){if(!util.Set.contains(n.sgs,r)){var i=this.sgroups.get(r);i.xBonds.push(t),util.arrayAddIfMissing(i.neiAtoms,e.begin)}},this)},this)},chem.Struct.prototype.sGroupDelete=function(t){for(var e=this.sgroups.get(t),n=0;n<e.atoms.length;++n)util.Set.remove(this.atoms.get(e.atoms[n]).sgs,t);this.sGroupForest.remove(t),this.sgroups.remove(t)},chem.Struct.itemSetPos=function(t,e){t.pp=e},chem.Struct.prototype._itemSetPos=function(t,e,n,r){chem.Struct.itemSetPos(this[t].get(e),n,r)},chem.Struct.prototype._atomSetPos=function(t,e,n){this._itemSetPos("atoms",t,e,n)},chem.Struct.prototype._rxnPlusSetPos=function(t,e,n){this._itemSetPos("rxnPluses",t,e,n)},chem.Struct.prototype._rxnArrowSetPos=function(t,e,n){this._itemSetPos("rxnArrows",t,e,n)},chem.Struct.prototype.getCoordBoundingBox=function(t){var e=null,n=function(t){e?(e.min=util.Vec2.min(e.min,t),e.max=util.Vec2.max(e.max,t)):e={min:t,max:t}},r="undefined"==typeof t;return this.atoms.each(function(e,i){(r||util.Set.contains(t,e))&&n(i.pp)}),r&&(this.rxnPluses.each(function(t,e){n(e.pp)}),this.rxnArrows.each(function(t,e){n(e.pp)})),!e&&r&&(e={min:new util.Vec2(0,0),max:new util.Vec2(1,1)}),e},chem.Struct.prototype.getCoordBoundingBoxObj=function(){var t=null,e=function(e){t?(t.min=util.Vec2.min(t.min,e),t.max=util.Vec2.max(t.max,e)):t={min:new util.Vec2(e),max:new util.Vec2(e)}};return this.atoms.each(function(t,n){e(n.pp)}),t},chem.Struct.prototype.getBondLengthData=function(){var t=0,e=0;return this.bonds.each(function(n,r){t+=util.Vec2.dist(this.atoms.get(r.begin).pp,this.atoms.get(r.end).pp),e++},this),{cnt:e,totalLength:t}},chem.Struct.prototype.getAvgBondLength=function(){var t=this.getBondLengthData();return t.cnt>0?t.totalLength/t.cnt:-1},chem.Struct.prototype.getAvgClosestAtomDistance=function(){var t,e,n,r=0,i=0,o=this.atoms.keys();for(e=0;e<o.length;++e){for(t=-1,n=0;n<o.length;++n)n!=e&&(i=util.Vec2.dist(this.atoms.get(o[n]).pp,this.atoms.get(o[e]).pp),(0>t||t>i)&&(t=i));r+=t}return o.length>0?r/o.length:-1},chem.Struct.prototype.checkBondExists=function(t,e){var n=!1;return this.bonds.each(function(r,i){(i.begin==t&&i.end==e||i.end==t&&i.begin==e)&&(n=!0)},this),n},chem.Loop=function(t,e,n){this.hbs=t,this.dblBonds=0,this.aromatic=!0,this.convex=n||!1,t.each(function(t){var n=e.bonds.get(e.halfBonds.get(t).bid);n.type!=chem.Struct.BOND.TYPE.AROMATIC&&(this.aromatic=!1),n.type==chem.Struct.BOND.TYPE.DOUBLE&&this.dblBonds++},this)},chem.Struct.RxnPlus=function(t){t=t||{},this.pp=t.pp?new util.Vec2(t.pp):new util.Vec2},chem.Struct.RxnPlus.prototype.clone=function(){return new chem.Struct.RxnPlus(this)},chem.Struct.RxnArrow=function(t){t=t||{},this.pp=t.pp?new util.Vec2(t.pp):new util.Vec2},chem.Struct.RxnArrow.prototype.clone=function(){return new chem.Struct.RxnArrow(this)},chem.Struct.prototype.findConnectedComponent=function(t){for(var e={},n=[t],r=util.Set.empty();n.length>0;)(function(){var t=n.pop();e[t]=1,util.Set.add(r,t);for(var i=this.atoms.get(t),o=0;o<i.neighbors.length;++o){var s=this.halfBonds.get(i.neighbors[o]).end;util.Set.contains(r,s)||n.push(s)}}).apply(this);return r},chem.Struct.prototype.findConnectedComponents=function(t){this.halfBonds.count()||(this.initHalfBonds(),this.initNeighbors(),this.updateHalfBonds(this.atoms.keys()),this.sortNeighbors(this.atoms.keys()));var e={};this.atoms.each(function(t,n){e[t]=-1},this);var n=[];return this.atoms.each(function(r,i){if((t||i.fragment<0)&&e[r]<0){var o=this.findConnectedComponent(r);n.push(o),util.Set.each(o,function(t){e[t]=1},this)}},this),n},chem.Struct.prototype.markFragment=function(t){var e=this.frags.add(new chem.Struct.Fragment);util.Set.each(t,function(t){this.atoms.get(t).fragment=e},this)},chem.Struct.prototype.markFragmentByAtomId=function(t){this.markFragment(this.findConnectedComponent(t))},chem.Struct.prototype.markFragments=function(){for(var t=this.findConnectedComponents(),e=0;e<t.length;++e)this.markFragment(t[e])},chem.Struct.Fragment=function(){},chem.Struct.Fragment.prototype.clone=function(){return Object.clone(this)},chem.Struct.Fragment.getAtoms=function(t,e){var n=[];return t.atoms.each(function(t,r){r.fragment==e&&n.push(t)},this),n},chem.Struct.RGroup=function(t){t=t||{},this.frags=new util.Pool,this.resth=t.resth||!1,this.range=t.range||"",this.ifthen=t.ifthen||0},chem.Struct.RGroup.prototype.getAttrs=function(){return{resth:this.resth,range:this.range,ifthen:this.ifthen}},chem.Struct.RGroup.findRGroupByFragment=function(t,e){var n;return t.each(function(t,r){Object.isUndefined(r.frags.keyOf(e))||(n=t)}),n},chem.Struct.RGroup.prototype.clone=function(t){var e=new chem.Struct.RGroup(this);return this.frags.each(function(n,r){e.frags.add(t?t[r]:r)}),e},chem.Struct.prototype.scale=function(t){1!=t&&(this.atoms.each(function(e,n){n.pp=n.pp.scaled(t)},this),this.rxnPluses.each(function(e,n){n.pp=n.pp.scaled(t)},this),this.rxnArrows.each(function(e,n){n.pp=n.pp.scaled(t)},this),this.sgroups.each(function(e,n){n.pp=n.pp?n.pp.scaled(t):null},this))},chem.Struct.prototype.rescale=function(){var t=this.getAvgBondLength();0>t&&!this.isReaction&&(t=this.getAvgClosestAtomDistance()),.001>t&&(t=1);var e=1/t;this.scale(e)},chem.Struct.prototype.loopHasSelfIntersections=function(t){for(var e=0;e<t.length;++e)for(var n=this.halfBonds.get(t[e]),r=this.atoms.get(n.begin).pp,i=this.atoms.get(n.end).pp,o=util.Set.fromList([n.begin,n.end]),s=e+2;s<t.length;++s){var a=this.halfBonds.get(t[s]);if(!util.Set.contains(o,a.begin)&&!util.Set.contains(o,a.end)){var l=this.atoms.get(a.begin).pp,c=this.atoms.get(a.end).pp;if(util.Vec2.segmentIntersection(r,i,l,c))return!0}}return!1},chem.Struct.prototype.partitionLoop=function(t){var e=[],n=!0;t:for(;n;){for(var r={},i=0;i<t.length;++i){var o=t[i],s=this.halfBonds.get(o).begin,a=this.halfBonds.get(o).end;if(a in r){var l=r[a],c=t.slice(l,i+1);e.push(c),i<t.length&&t.splice(l,i-l+1);continue t}r[s]=i}n=!1,e.push(t)}return e},chem.Struct.prototype.halfBondAngle=function(t,e){var n=this.halfBonds.get(t),r=this.halfBonds.get(e);return Math.atan2(util.Vec2.cross(n.dir,r.dir),util.Vec2.dot(n.dir,r.dir))},chem.Struct.prototype.loopIsConvex=function(t){for(var e=0;e<t.length;++e){var n=this.halfBondAngle(t[e],t[(e+1)%t.length]);if(n>0)return!1}return!0},chem.Struct.prototype.loopIsInner=function(t){for(var e=2*Math.PI,n=0;n<t.length;++n){var r=t[n],i=t[(n+1)%t.length],o=this.halfBonds.get(i),s=this.halfBondAngle(r,i);e+=o.contra==t[n]?Math.PI:s}return Math.abs(e)<Math.PI},chem.Struct.prototype.findLoops=function(){var t,e,n,r,i=[],o=util.Set.empty();return this.halfBonds.each(function(s,a){if(-1==a.loop)for(t=s,e=0,n=[];e<=this.halfBonds.count();t=this.halfBonds.get(t).next,++e){if(e>0&&t==s){var l=this.partitionLoop(n);util.each(l,function(t){this.loopIsInner(t)&&!this.loopHasSelfIntersections(t)?(r=util.arrayMin(t),this.loops.set(r,new chem.Loop(t,this,this.loopIsConvex(t)))):r=-2,t.each(function(t){this.halfBonds.get(t).loop=r,util.Set.add(o,this.halfBonds.get(t).bid)},this),r>=0&&i.push(r)},this);break}n.push(t)}},this),{newLoops:i,bondsToMark:util.Set.list(o)}},chem.Struct.prototype.prepareLoopStructure=function(){this.initHalfBonds(),this.initNeighbors(),this.updateHalfBonds(this.atoms.keys()),this.sortNeighbors(this.atoms.keys()),this.findLoops()},chem.Struct.prototype.atomAddToSGroup=function(t,e){chem.SGroup.addAtom(this.sgroups.get(t),e),util.Set.add(this.atoms.get(e).sgs,t)},!window.chem||!chem.Struct)throw new Error("Include MolData.js first");if(chem.Struct.prototype.calcConn=function(t){for(var e=0,n=this.atoms.get(t),r=!1,i=0;i<n.neighbors.length;++i){var o=this.halfBonds.get(n.neighbors[i]),s=this.bonds.get(o.bid);switch(s.type){case chem.Struct.BOND.TYPE.SINGLE:e+=1;break;case chem.Struct.BOND.TYPE.DOUBLE:e+=2;break;case chem.Struct.BOND.TYPE.TRIPLE:e+=3;break;case chem.Struct.BOND.TYPE.AROMATIC:e+=1,r=!0;break;default:return-1}}return r&&(e+=1),e},chem.Struct.Atom.prototype.calcValence=function(t){var e=this,n=e.charge,r=e.label;if(e.isQuery())return this.implicitH=0,!0;var i=chem.Element.getElementByLabel(r);if(null==i)return this.implicitH=0,!0;var o=chem.Element.elements.get(i).group,s=chem.Struct.radicalElectrons(e.radical),a=t,l=0,c=Math.abs(n);return 1==o?("H"==r||"Li"==r||"Na"==r||"K"==r||"Rb"==r||"Cs"==r||"Fr"==r)&&(a=1,l=1-s-t-c):3==o?"B"==r||"Al"==r||"Ga"==r||"In"==r?-1==n?(a=4,l=4-s-t):(a=3,l=3-s-t-c):"Tl"==r&&(-1==n?2>=s+t?(a=2,l=2-s-t):(a=4,l=4-s-t):-2==n?3>=s+t?(a=3,l=3-s-t):(a=5,l=5-s-t):1>=s+t+c?(a=1,l=1-s-t-c):(a=3,l=3-s-t-c)):4==o?"C"==r||"Si"==r||"Ge"==r?(a=4,l=4-s-t-c):("Sn"==r||"Pb"==r)&&(2>=t+s+c?(a=2,l=2-s-t-c):(a=4,l=4-s-t-c)):5==o?"N"==r||"P"==r?1==n?(a=4,l=4-s-t):2==n?(a=3,l=3-s-t):"N"==r||3>=s+t+c?(a=3,l=3-s-t-c):(a=5,l=5-s-t-c):("Bi"==r||"Sb"==r||"As"==r)&&(1==n?2>=s+t&&"As"!=r?(a=2,l=2-s-t):(a=4,l=4-s-t):2==n?(a=3,l=3-s-t):3>=s+t?(a=3,l=3-s-t-c):(a=5,l=5-s-t-c)):6==o?"O"==r?n>=1?(a=3,l=3-s-t):(a=2,l=2-s-t-c):"S"==r||"Se"==r||"Po"==r?1==n?3>=t?(a=3,l=3-s-t):(a=5,l=5-s-t):2>=t+s+c?(a=2,l=2-s-t-c):4>=t+s+c?(a=4,l=4-s-t-c):(a=6,l=6-s-t-c):"Te"==r&&(-1==n?2>=t&&(a=2,l=2-s-t-c):(0==n||2==n)&&(2>=t?(a=2,l=2-s-t-c):4>=t?(a=4,l=4-s-t-c):0==n&&6>=t?(a=6,l=6-s-t-c):l=-1)):7==o&&("F"==r?(a=1,l=1-s-t-c):("Cl"==r||"Br"==r||"I"==r||"At"==r)&&(1==n?2>=t?(a=2,l=2-s-t):(3==t||5==t||t>=7)&&(l=-1):0==n&&(1>=t?(a=1,l=1-s-t):2==t||4==t||6==t?1==s?(a=t,l=0):l=-1:t>7&&(l=-1)))),this.valence=a,this.implicitH=l,this.implicitH<0?(this.valence=t,this.implicitH=0,this.badConn=!0,!1):!0},chem.Struct.Atom.prototype.calcValenceMinusHyd=function(t){var e=this,n=e.charge,r=e.label,i=chem.Element.getElementByLabel(r);if(null==i)throw new Error("Element "+r+" unknown");if(0>i)return this.implicitH=0,null;var o=chem.Element.elements.get(i).group,s=chem.Struct.radicalElectrons(e.radical);if(3==o){if(("B"==r||"Al"==r||"Ga"==r||"In"==r)&&-1==n&&4>=s+t)return s+t}else if(5==o){if("N"==r||"P"==r){if(1==n)return s+t;if(2==n)return s+t}else if("Sb"==r||"Bi"==r||"As"==r){if(1==n)return s+t;if(2==n)return s+t}}else if(6==o){if("O"==r){if(n>=1)return s+t}else if(("S"==r||"Se"==r||"Po"==r)&&1==n)return s+t}else if(7==o&&("Cl"==r||"Br"==r||"I"==r||"At"==r)&&1==n)return s+t;return s+t+Math.abs(n)},chem.Struct.prototype.calcImplicitHydrogen=function(t){var e=this.calcConn(t),n=this.atoms.get(t);if(n.badConn=!1,0>e||n.isQuery())return void(n.implicitH=0);if(n.explicitValence>=0){var r=chem.Element.getElementByLabel(n.label);n.implicitH=0,null!=r&&(n.implicitH=n.explicitValence-n.calcValenceMinusHyd(e),n.implicitH<0&&(n.implicitH=0,n.badConn=!0))}else n.calcValence(e)},!window.chem||!util.Vec2||!chem.Struct)throw new Error("Vec2 and Molecule should be defined first");chem.Molfile=function(){},chem.Molfile.loadRGroupFragments=!0,chem.Molfile.parseDecimalInt=function(t){var e=parseInt(t,10);return isNaN(e)?0:e},chem.Molfile.partitionLine=function(t,e,n){for(var r=[],i=0,o=0;i<e.length;++i)r.push(t.slice(o,o+e[i])),n&&o++,o+=e[i];return r},chem.Molfile.partitionLineFixed=function(t,e,n){for(var r=[],i=0;i<t.length;i+=e)r.push(t.slice(i,i+e)),n&&i++;return r},chem.Molfile.parseCTFile=function(t){var e=null;return e=0==t[0].search("\\$RXN")?chem.Molfile.parseRxn(t):chem.Molfile.parseMol(t),e.initHalfBonds(),e.initNeighbors(),e.markFragments(),e},chem.Molfile.fmtInfo={bondTypeMap:{1:chem.Struct.BOND.TYPE.SINGLE,2:chem.Struct.BOND.TYPE.DOUBLE,3:chem.Struct.BOND.TYPE.TRIPLE,4:chem.Struct.BOND.TYPE.AROMATIC,5:chem.Struct.BOND.TYPE.SINGLE_OR_DOUBLE,6:chem.Struct.BOND.TYPE.SINGLE_OR_AROMATIC,7:chem.Struct.BOND.TYPE.DOUBLE_OR_AROMATIC,8:chem.Struct.BOND.TYPE.ANY},bondStereoMap:{0:chem.Struct.BOND.STEREO.NONE,1:chem.Struct.BOND.STEREO.UP,4:chem.Struct.BOND.STEREO.EITHER,6:chem.Struct.BOND.STEREO.DOWN,3:chem.Struct.BOND.STEREO.CIS_TRANS},v30bondStereoMap:{0:chem.Struct.BOND.STEREO.NONE,1:chem.Struct.BOND.STEREO.UP,2:chem.Struct.BOND.STEREO.EITHER,3:chem.Struct.BOND.STEREO.DOWN},bondTopologyMap:{0:chem.Struct.BOND.TOPOLOGY.EITHER,1:chem.Struct.BOND.TOPOLOGY.RING,2:chem.Struct.BOND.TOPOLOGY.CHAIN},countsLinePartition:[3,3,3,3,3,3,3,3,3,3,3,6],atomLinePartition:[10,10,10,1,3,2,3,3,3,3,3,3,3,3,3,3,3],bondLinePartition:[3,3,3,3,3,3,3],atomListHeaderPartition:[3,1,1,4,1,1],atomListHeaderLength:11,atomListHeaderItemLength:4,chargeMap:[0,3,2,1,0,-1,-2,-3],valenceMap:[void 0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,0],implicitHydrogenMap:[void 0,0,1,2,3,4],v30atomPropMap:{CHG:"charge",RAD:"radical",MASS:"isotope",VAL:"explicitValence",HCOUNT:"hCount",INVRET:"invRet",SUBST:"substitutionCount",UNSAT:"unsaturatedAtom",RBCNT:"ringBondCount"},rxnItemsPartition:[3,3,3]},chem.Molfile.parseAtomLine=function(t){var e=chem.Molfile,n=e.partitionLine(t,e.fmtInfo.atomLinePartition),r={pp:new util.Vec2(parseFloat(n[0]),-parseFloat(n[1])),label:n[4].strip(),explicitValence:e.fmtInfo.valenceMap[e.parseDecimalInt(n[10])],massDifference:e.parseDecimalInt(n[5]),charge:e.fmtInfo.chargeMap[e.parseDecimalInt(n[6])],hCount:e.parseDecimalInt(e.parseDecimalInt(n[8])),stereoCare:0!=e.parseDecimalInt(n[9]),aam:e.parseDecimalInt(n[14]),invRet:e.parseDecimalInt(n[15]),exactChangeFlag:0!=e.parseDecimalInt(n[16])};return new chem.Struct.Atom(r)},chem.Molfile.stripV30=function(t){if("M  V30 "!=t.slice(0,7))throw Error("Prefix invalid");return t.slice(7)},chem.Molfile.parseAtomLineV3000=function(t){var e,n,r,i,o,s=chem.Molfile;e=s.spaceparsplit(t);var a={pp:new util.Vec2(parseFloat(e[2]),-parseFloat(e[3])),aam:e[5].strip()},l=e[1].strip();if('"'==l.charAt(0)&&'"'==l.charAt(l.length-1)&&(l=l.substr(1,l.length-2)),"]"==l.charAt(l.length-1)){l=l.substr(0,l.length-1);var c={};if(c.notList=!1,"NOT ["==l.substr(0,5))c.notList=!0,l=l.substr(5);else{if("["!=l.charAt(0))throw"Error: atom list expected, found '"+l+"'";l=l.substr(1)}c.ids=s.labelsListToIds(l.split(",")),a.atomList=new chem.Struct.AtomList(c),a.label="L#"}else a.label=l;for(e.splice(0,6),o=0;o<e.length;++o)if(n=s.splitonce(e[o],"="),r=n[0],i=n[1],r in s.fmtInfo.v30atomPropMap){var h=s.parseDecimalInt(i);if("VAL"==r){if(0==h)continue;-1==h&&(h=0)}a[s.fmtInfo.v30atomPropMap[r]]=h}else if("RGROUPS"==r){i=i.strip().substr(1,i.length-2);var u=i.split(" ").slice(1);a.rglabel=0;for(var d=0;d<u.length;++d)a.rglabel|=1<<u[d]-1}else"ATTCHPT"==r&&(a.attpnt=i.strip()-0);return new chem.Struct.Atom(a)},chem.Molfile.parseBondLineV3000=function(t){var e,n,r,i,o,s=chem.Molfile;e=s.spaceparsplit(t);var a={begin:s.parseDecimalInt(e[2])-1,end:s.parseDecimalInt(e[3])-1,type:s.fmtInfo.bondTypeMap[s.parseDecimalInt(e[1])]};for(e.splice(0,4),o=0;o<e.length;++o)n=s.splitonce(e[o],"="),r=n[0],i=n[1],"CFG"==r?(a.stereo=s.fmtInfo.v30bondStereoMap[s.parseDecimalInt(i)],a.type==chem.Struct.BOND.TYPE.DOUBLE&&a.stereo==chem.Struct.BOND.STEREO.EITHER&&(a.stereo=chem.Struct.BOND.STEREO.CIS_TRANS)):"TOPO"==r?a.topology=s.fmtInfo.bondTopologyMap[s.parseDecimalInt(i)]:"RXCTR"==r?a.reactingCenterStatus=s.parseDecimalInt(i):"STBOX"==r&&(a.stereoCare=s.parseDecimalInt(i));return new chem.Struct.Bond(a)},chem.Molfile.parseBondLine=function(t){var e=chem.Molfile,n=e.partitionLine(t,e.fmtInfo.bondLinePartition),r={begin:e.parseDecimalInt(n[0])-1,end:e.parseDecimalInt(n[1])-1,type:e.fmtInfo.bondTypeMap[e.parseDecimalInt(n[2])],stereo:e.fmtInfo.bondStereoMap[e.parseDecimalInt(n[3])],topology:e.fmtInfo.bondTopologyMap[e.parseDecimalInt(n[5])],reactingCenterStatus:e.parseDecimalInt(n[6])};return new chem.Struct.Bond(r)},chem.Molfile.parseAtomListLine=function(t){for(var e=chem.Molfile,n=e.partitionLine(t,e.fmtInfo.atomListHeaderPartition),r=e.parseDecimalInt(n[0])-1,i="T"==n[2].strip(),o=e.parseDecimalInt(n[4].strip()),s=t.slice(e.fmtInfo.atomListHeaderLength),a=[],l=e.fmtInfo.atomListHeaderItemLength,c=0;o>c;++c)a[c]=e.parseDecimalInt(s.slice(c*l,(c+1)*l-1));return{aid:r,atomList:new chem.Struct.AtomList({notList:i,ids:a})}},chem.Molfile.readKeyValuePairs=function(t,e){for(var n=chem.Molfile,r={},i=n.partitionLineFixed(t,3,!0),o=n.parseDecimalInt(i[0]),s=0;o>s;++s)r[n.parseDecimalInt(i[2*s+1])-1]=e?i[2*s+2].strip():n.parseDecimalInt(i[2*s+2]);return r},chem.Molfile.readKeyMultiValuePairs=function(t,e){for(var n=chem.Molfile,r=[],i=n.partitionLineFixed(t,3,!0),o=n.parseDecimalInt(i[0]),s=0;o>s;++s)r.push([n.parseDecimalInt(i[2*s+1])-1,e?i[2*s+2].strip():n.parseDecimalInt(i[2*s+2])]);return r},chem.Molfile.labelsListToIds=function(t){for(var e=[],n=0;n<t.length;++n)e.push(chem.Element.getElementByLabel(t[n].strip()));return e},chem.Molfile.parsePropertyLineAtomList=function(t,e){var n=chem.Molfile,r=n.parseDecimalInt(t[1])-1,i=n.parseDecimalInt(t[2]),o="T"==t[4].strip(),s=n.labelsListToIds(e.slice(0,i)),a={};return a[r]=new chem.Struct.AtomList({notList:o,ids:s}),a},chem.Molfile.initSGroup=function(t,e){var n=chem.Molfile,r=n.readKeyValuePairs(e,!0);for(var i in r){var o=r[i];if(!(o in chem.SGroup.TYPES))throw new Error("Unsupported S-group type");var s=new chem.SGroup(o);s.number=i,t[i]=s}},chem.Molfile.applySGroupProp=function(t,e,n,r,i){var o=chem.Molfile,s=o.readKeyValuePairs(n,!r);for(var a in s)(i?t[a]:t[a].data)[e]=s[a]},chem.Molfile.toIntArray=function(t){for(var e=chem.Molfile,n=[],r=0;r<t.length;++r)n[r]=e.parseDecimalInt(t[r]);return n},chem.Molfile.applySGroupArrayProp=function(t,e,n,r){var i=chem.Molfile,o=i.parseDecimalInt(n.slice(1,4))-1,s=i.parseDecimalInt(n.slice(4,8)),a=i.toIntArray(i.partitionLineFixed(n.slice(8),3,!0));if(a.length!=s)throw new Error("File format invalid");r&&util.apply(a,function(t){return t+r}),t[o][e]=t[o][e].concat(a)},chem.Molfile.applyDataSGroupName=function(t,e){t.data.fieldName=e},chem.Molfile.applyDataSGroupQuery=function(t,e){t.data.query=e},chem.Molfile.applyDataSGroupQueryOp=function(t,e){t.data.queryOp=e},chem.Molfile.applyDataSGroupDesc=function(t,e){var n=chem.Molfile,r=n.partitionLine(e,[4,31,2,20,2,3],!1),i=n.parseDecimalInt(r[0])-1,o=r[1].strip(),s=r[2].strip(),a=r[3].strip(),l=r[4].strip(),c=r[5].strip(),h=t[i];h.data.fieldType=s,h.data.fieldName=o,h.data.units=a,h.data.query=l,h.data.queryOp=c},chem.Molfile.applyDataSGroupInfo=function(t,e){var n=chem.Molfile,r=n.partitionLine(e,[10,10,4,1,1,1,3,3,3,3,2,3,2],!1),i=parseFloat(r[0]),o=parseFloat(r[1]),s="A"==r[3].strip(),a="A"==r[4].strip(),l="U"==r[5].strip(),c=r[7].strip();c="ALL"==c?-1:n.parseDecimalInt(c);var h=r[10].strip(),u=n.parseDecimalInt(r[11].strip());t.pp=new util.Vec2(i,-o),t.data.attached=s,t.data.absolute=a,t.data.showUnits=l,t.data.nCharsToDisplay=c,t.data.tagChar=h,t.data.daspPos=u},chem.Molfile.applyDataSGroupInfoLine=function(t,e){var n=chem.Molfile,r=n.parseDecimalInt(e.substr(0,4))-1,i=t[r];n.applyDataSGroupInfo(i,e.substr(5))},chem.Molfile.applyDataSGroupData=function(t,e,n){t.data.fieldValue=(t.data.fieldValue||"")+e,n&&(t.data.fieldValue=util.stripRight(t.data.fieldValue),t.data.fieldValue.startsWith('"')&&t.data.fieldValue.endsWith('"')&&(t.data.fieldValue=t.data.fieldValue.substr(1,t.data.fieldValue.length-2)),t.data.fieldValue+="\n")},chem.Molfile.applyDataSGroupDataLine=function(t,e,n){var r=chem.Molfile,i=r.parseDecimalInt(e.substr(0,5))-1,o=e.substr(5),s=t[i];r.applyDataSGroupData(s,o,n)},chem.Molfile.parsePropertyLines=function(t,e,n,r,i,o){
for(var s=chem.Molfile,a=new util.Map;r>n;){var l=e[n];if("A"==l.charAt(0))a.get("label")||a.set("label",new util.Map),a.get("label").set(s.parseDecimalInt(l.slice(3,6))-1,e[++n]);else if("M"==l.charAt(0)){var c=l.slice(3,6),h=l.slice(6);if("END"==c)break;if("CHG"==c)a.get("charge")||a.set("charge",new util.Map),a.get("charge").update(s.readKeyValuePairs(h));else if("RAD"==c)a.get("radical")||a.set("radical",new util.Map),a.get("radical").update(s.readKeyValuePairs(h));else if("ISO"==c)a.get("isotope")||a.set("isotope",new util.Map),a.get("isotope").update(s.readKeyValuePairs(h));else if("RBC"==c)a.get("ringBondCount")||a.set("ringBondCount",new util.Map),a.get("ringBondCount").update(s.readKeyValuePairs(h));else if("SUB"==c)a.get("substitutionCount")||a.set("substitutionCount",new util.Map),a.get("substitutionCount").update(s.readKeyValuePairs(h));else if("UNS"==c)a.get("unsaturatedAtom")||a.set("unsaturatedAtom",new util.Map),a.get("unsaturatedAtom").update(s.readKeyValuePairs(h));else if("RGP"==c){a.get("rglabel")||a.set("rglabel",new util.Map);for(var u=a.get("rglabel"),d=s.readKeyMultiValuePairs(h),p=0;p<d.length;p++){var f=d[p];u.set(f[0],(u.get(f[0])||0)|1<<f[1]-1)}}else if("LOG"==c){h=h.slice(4);var m=s.parseDecimalInt(h.slice(0,3).strip()),g=s.parseDecimalInt(h.slice(4,7).strip()),b=s.parseDecimalInt(h.slice(8,11).strip()),v=h.slice(12).strip(),y={};g>0&&(y.ifthen=g),y.resth=1==b,y.range=v,o[m]=y}else if("APO"==c)a.get("attpnt")||a.set("attpnt",new util.Map),a.get("attpnt").update(s.readKeyValuePairs(h));else if("ALS"==c){a.get("atomList")||a.set("atomList",new util.Map);var x=s.parsePropertyLineAtomList(s.partitionLine(h,[1,3,3,1,1,1]),s.partitionLineFixed(h.slice(10),4,!1));a.get("atomList").update(x),a.get("label")||a.set("label",new util.Map);for(var S in x)a.get("label").set(S,"L#")}else if("STY"==c)s.initSGroup(i,h);else if("SST"==c)s.applySGroupProp(i,"subtype",h);else if("SLB"==c)s.applySGroupProp(i,"label",h,!0);else if("SPL"==c)s.applySGroupProp(i,"parent",h,!0,!0);else if("SCN"==c)s.applySGroupProp(i,"connectivity",h);else if("SAL"==c)s.applySGroupArrayProp(i,"atoms",h,-1);else if("SBL"==c)s.applySGroupArrayProp(i,"bonds",h,-1);else if("SPA"==c)s.applySGroupArrayProp(i,"patoms",h,-1);else if("SMT"==c){var w=s.parseDecimalInt(h.slice(0,4))-1;i[w].data.subscript=h.slice(4).strip()}else"SDT"==c?s.applyDataSGroupDesc(i,h):"SDD"==c?s.applyDataSGroupInfoLine(i,h):"SCD"==c?s.applyDataSGroupDataLine(i,h,!1):"SED"==c&&s.applyDataSGroupDataLine(i,h,!0)}++n}return a},chem.Molfile.applyAtomProp=function(t,e,n,r){e.each(function(e,r){t.get(e)[n]=r})},chem.Molfile.parseCTabV2000=function(t,e){var n,r=new chem.Struct,i=chem.Molfile,o=i.parseDecimalInt(e[0]),s=i.parseDecimalInt(e[1]),a=i.parseDecimalInt(e[2]);r.isChiral=0!=i.parseDecimalInt(e[4]);var l=i.parseDecimalInt(e[5]),c=i.parseDecimalInt(e[10]),h=0,u=t.slice(h,h+o);h+=o;var d=t.slice(h,h+s);h+=s;var p=t.slice(h,h+a);h+=a+l;var f=u.map(i.parseAtomLine);for(n=0;n<f.length;++n)r.atoms.add(f[n]);var m=d.map(i.parseBondLine);for(n=0;n<m.length;++n)r.bonds.add(m[n]);var g=p.map(i.parseAtomListLine);g.each(function(t){r.atoms.get(t.aid).atomList=t.atomList,r.atoms.get(t.aid).label="L#"});var b={},v={},y=i.parsePropertyLines(r,t,h,Math.min(t.length,h+c),b,v);y.each(function(t,e){i.applyAtomProp(r.atoms,e,t)});var x,S={};for(x in b){var w=b[x];if("DAT"===w.type&&0===w.atoms.length){var E=b[x].parent;if(E>=0){var B=b[E-1];"GEN"===B.type&&(w.atoms=util.array(B.atoms))}}}for(x in b)chem.SGroup.addGroup(r,b[x],S);var R=[];for(x in b)chem.SGroup.filter(r,b[x],S),0!=b[x].atoms.length||b[x].allAtoms||R.push(x);for(n=0;n<R.length;++n)r.sGroupForest.remove(R[n]),r.sgroups.remove(R[n]);for(var C in v)r.rgroups.set(C,new chem.Struct.RGroup(v[C]));return r},chem.Molfile.spaceparsplit=function(t){var e,n,r=[],i=0,o=-1,s=t.toArray(),a=!1;for(n=0;n<t.length;++n)e=s[n],"("==e?i++:")"==e&&i--,'"'==e&&(a=!a),a||" "!=s[n]||0!=i||(n>o+1&&r.push(t.slice(o+1,n)),o=n);return n>o+1&&r.push(t.slice(o+1,n)),o=n,r},chem.Molfile.splitonce=function(t,e){var n=t.indexOf(e);return[t.slice(0,n),t.slice(n+1)]},chem.Molfile.splitSGroupDef=function(t){for(var e=[],n=0,r=!1,i=0;i<t.length;++i){var o=t.charAt(i);'"'==o?r=!r:r||("("==o?n++:")"==o?n--:" "==o&&0==n&&(e.push(t.slice(0,i)),t=t.slice(i+1).strip(),i=0))}if(0!=n)throw"Brace balance broken. S-group properies invalid!";return t.length>0&&e.push(t.strip()),e},chem.Molfile.parseBracedNumberList=function(t,e){if(!t)return null;var n=[];t=t.strip(),t=t.substr(1,t.length-2);var r=t.split(" ");e=e||0;for(var i=1;i<r.length;++i)n.push(r[i]-0+e);return n},chem.Molfile.v3000parseCollection=function(t,e,n){for(n++;"M  V30 END COLLECTION"!=e[n].strip();)n++;return n++,n},chem.Molfile.v3000parseSGroup=function(t,e,n,r,i){var o=chem.Molfile,s="";for(i++;i<e.length;){if(s=o.stripV30(e[i++]).strip(),"END SGROUP"==s.strip())return i;for(;"-"==s.charAt(s.length-1);)s=(s.substr(0,s.length-1)+o.stripV30(e[i++])).strip();var a=o.splitSGroupDef(s),l=a[1],c=new chem.SGroup(l);c.number=a[0]-0,c.type=l,c.label=a[2]-0,n[c.number]=c;for(var h={},u=3;u<a.length;++u){var d=o.splitonce(a[u],"=");if(2!=d.length)throw"A record of form AAA=BBB or AAA=(...) expected, got '"+a[u]+"'";var p=d[0];p in h||(h[p]=[]),h[p].push(d[1])}c.atoms=o.parseBracedNumberList(h.ATOMS[0],-1),h.PATOMS&&(c.patoms=o.parseBracedNumberList(h.PATOMS[0],-1)),c.bonds=h.BONDS?o.parseBracedNumberList(h.BONDS[0],-1):[];var f=h.BRKXYZ;if(c.brkxyz=[],f)for(var m=0;m<f.length;++m)c.brkxyz.push(o.parseBracedNumberList(f[m]));h.MULT&&(c.data.subscript=h.MULT[0]-0),h.LABEL&&(c.data.subscript=h.LABEL[0].strip()),h.CONNECT&&(c.data.connectivity=h.CONNECT[0].toLowerCase()),h.FIELDDISP&&o.applyDataSGroupInfo(c,util.stripQuotes(h.FIELDDISP[0])),h.FIELDDATA&&o.applyDataSGroupData(c,h.FIELDDATA[0],!0),h.FIELDNAME&&o.applyDataSGroupName(c,h.FIELDNAME[0]),h.QUERYTYPE&&o.applyDataSGroupQuery(c,h.QUERYTYPE[0]),h.QUERYOP&&o.applyDataSGroupQueryOp(c,h.QUERYOP[0]),chem.SGroup.addGroup(t,c,r)}throw new Error("S-group declaration incomplete.")},chem.Molfile.parseCTabV3000=function(t,e){var n=new chem.Struct,r=chem.Molfile,i=0;if("M  V30 BEGIN CTAB"!=t[i++].strip())throw Error("CTAB V3000 invalid");if("M  V30 COUNTS"!=t[i].slice(0,13))throw Error("CTAB V3000 invalid");var o=t[i].slice(14).split(" ");if(n.isChiral=1==r.parseDecimalInt(o[4]),i++,"M  V30 BEGIN ATOM"==t[i].strip()){i++;for(var s;i<t.length&&(s=r.stripV30(t[i++]).strip(),"END ATOM"!=s);){for(;"-"==s.charAt(s.length-1);)s=(s.substring(0,s.length-1)+r.stripV30(t[i++])).strip();n.atoms.add(r.parseAtomLineV3000(s))}if("M  V30 BEGIN BOND"==t[i].strip())for(i++;i<t.length&&(s=r.stripV30(t[i++]).strip(),"END BOND"!=s);){for(;"-"==s.charAt(s.length-1);)s=(s.substring(0,s.length-1)+r.stripV30(t[i++])).strip();n.bonds.add(r.parseBondLineV3000(s))}for(var a={},l={};"M  V30 END CTAB"!=t[i].strip();)if("M  V30 BEGIN COLLECTION"==t[i].strip())i=r.v3000parseCollection(n,t,i);else{if("M  V30 BEGIN SGROUP"!=t[i].strip())throw Error("CTAB V3000 invalid");i=r.v3000parseSGroup(n,t,a,l,i)}}if("M  V30 END CTAB"!=t[i++].strip())throw Error("CTAB V3000 invalid");return e||r.readRGroups3000(n,t.slice(i)),n},chem.Molfile.readRGroups3000=function(t,e){for(var n={},r={},i=0,o=chem.Molfile;i<e.length&&0==e[i].search("M  V30 BEGIN RGROUP");){var s=e[i++].split(" ").pop();for(n[s]=[],r[s]={};;){var a=e[i].strip();if(0!=a.search("M  V30 RLOGIC")){if("M  V30 BEGIN CTAB"!=a)throw Error("CTAB V3000 invalid");for(var l=0;l<e.length&&"M  V30 END CTAB"!=e[i+l].strip();++l);var c=e.slice(i,i+l+1),h=this.parseCTabV3000(c,!0);if(n[s].push(h),i=i+l+1,"M  V30 END RGROUP"==e[i].strip()){i++;break}}else{a=a.slice(13);var u=a.strip().split(/\s+/g),d=o.parseDecimalInt(u[0]),p=o.parseDecimalInt(u[1]),f=u.slice(2).join(" "),m={};d>0&&(m.ifthen=d),m.resth=1==p,m.range=f,r[s]=m,i++}}}for(var g in n)for(var b=0;b<n[g].length;++b){var v=n[g][b];v.rgroups.set(g,new chem.Struct.RGroup(r[g]));var y=v.frags.add(new chem.Struct.Fragment);v.rgroups.get(g).frags.add(y),v.atoms.each(function(t,e){e.fragment=y}),v.mergeInto(t)}},chem.Molfile.parseMol=function(t){if(0==t[0].search("\\$MDL"))return this.parseRg2000(t);var e=this.parseCTab(t.slice(3));return e.name=t[0].strip(),e},chem.Molfile.parseCTab=function(t){var e=chem.Molfile,n=e.partitionLine(t[0],e.fmtInfo.countsLinePartition),r=n[11].strip();if(t=t.slice(1),"V2000"==r)return this.parseCTabV2000(t,n);if("V3000"==r)return this.parseCTabV3000(t,!chem.Molfile.loadRGroupFragments);throw Error("Molfile version unknown: "+r)},chem.MolfileSaver=function(t){this.molecule=null,this.molfile=null,this.v3000=t||!1},chem.MolfileSaver.prototype.prepareSGroups=function(t){var e=this.molecule,n=(e.sgroups,[]);util.each(this.molecule.sGroupForest.getSGroupsBFS().reverse(),function(r){var i=e.sgroups.get(r);try{i.prepareForSaving(e)}catch(o){if(ui.forwardExceptions)throw o;if(!t||"number"!=typeof o.id)throw o;n.push(o.id)}},this),n.length>0&&alert("WARNING: "+n.length.toString()+" invalid S-groups were detected. They will be omitted.");for(var r=0;r<n.length;++r)e.sGroupDelete(n[r]);return e},chem.MolfileSaver.getComponents=function(t){var e=t.findConnectedComponents(!0),n=[],r=null;t.rxnArrows.each(function(t,e){r=e.pp.x}),t.rxnPluses.each(function(t,e){n.push(e.pp.x)}),null!=r&&n.push(r),n.sort(function(t,e){return t-e});var i,o=[];for(i=0;i<e.length;++i){for(var s=t.getCoordBoundingBox(e[i]),a=util.Vec2.lc2(s.min,.5,s.max,.5),l=0;a.x>n[l];)++l;o[l]=o[l]||{},util.Set.mergeIn(o[l],e[i])}var c=[],h=[],u=[];for(i=0;i<o.length;++i)o[i]?(s=t.getCoordBoundingBox(o[i]),a=util.Vec2.lc2(s.min,.5,s.max,.5),a.x<r?h.push(o[i]):u.push(o[i])):c.push("");return{reactants:h,products:u}},chem.MolfileSaver.prototype.getCTab=function(t,e){return this.molecule=t.clone(),this.molfile="",this.writeCTab2000(e),this.molfile},chem.MolfileSaver.prototype.saveMolecule=function(t,e,n){if(this.reaction=t.rxnArrows.count()>0,t.rxnArrows.count()>1)throw new Error("Reaction may not contain more than one arrow");if(this.molfile="",this.reaction){if(t.rgroups.count()>0)throw new Error("Unable to save the structure - reactions with r-groups are not supported at the moment");var r=chem.MolfileSaver.getComponents(t),i=r.reactants,o=r.products,s=i.concat(o);this.molfile="$RXN\n\n\n\n"+util.paddedInt(i.length,3)+util.paddedInt(o.length,3)+util.paddedInt(0,3)+"\n";for(var a=0;a<s.length;++a){var l=new chem.MolfileSaver(!1),c=t.clone(s[a],null,!0),h=l.saveMolecule(c,!1,!0);this.molfile+="$MOL\n"+h}return this.molfile}if(t.rgroups.count()>0){if(!n){var u=new chem.MolfileSaver(!1).getCTab(t.getScaffold(),t.rgroups);return this.molfile="$MDL  REV  1\n$MOL\n$HDR\n\n\n\n$END HDR\n",this.molfile+="$CTAB\n"+u+"$END CTAB\n",t.rgroups.each(function(e,n){this.molfile+="$RGP\n",this.writePaddedNumber(e,3),this.molfile+="\n",n.frags.each(function(e,n){var r=new chem.MolfileSaver(!1).getCTab(t.getFragment(n));this.molfile+="$CTAB\n"+r+"$END CTAB\n"},this),this.molfile+="$END RGP\n"},this),this.molfile+="$END MOL\n",this.molfile}t=t.getScaffold()}return this.molecule=t.clone(),this.prepareSGroups(e),this.writeHeader(),this.writeCTab2000(),this.molfile},chem.MolfileSaver.prototype.writeHeader=function(){var t=new Date;this.writeCR(),this.writeWhiteSpace(2),this.write("Ketcher"),this.writeWhiteSpace(),this.writeCR((t.getMonth()+1).toPaddedString(2)+t.getDate().toPaddedString(2)+(t.getFullYear()%100).toPaddedString(2)+t.getHours().toPaddedString(2)+t.getMinutes().toPaddedString(2)+"2D 1   1.00000     0.00000     0"),this.writeCR()},chem.MolfileSaver.prototype.write=function(t){this.molfile+=t},chem.MolfileSaver.prototype.writeCR=function(t){0==arguments.length&&(t=""),this.molfile+=t+"\n"},chem.MolfileSaver.prototype.writeWhiteSpace=function(t){0==arguments.length&&(t=1),t.times(function(){this.write(" ")},this)},chem.MolfileSaver.prototype.writePadded=function(t,e){this.write(t),this.writeWhiteSpace(e-t.length)},chem.MolfileSaver.prototype.writePaddedNumber=function(t,e){var n=(t-0).toString();this.writeWhiteSpace(e-n.length),this.write(n)},chem.MolfileSaver.prototype.writePaddedFloat=function(t,e,n){this.write(util.paddedFloat(t,e,n))},chem.MolfileSaver.prototype.writeCTab2000Header=function(){this.writePaddedNumber(this.molecule.atoms.count(),3),this.writePaddedNumber(this.molecule.bonds.count(),3),this.writePaddedNumber(0,3),this.writeWhiteSpace(3),this.writePaddedNumber(this.molecule.isChiral?1:0,3),this.writePaddedNumber(0,3),this.writeWhiteSpace(12),this.writePaddedNumber(999,3),this.writeCR(" V2000")},chem.MolfileSaver.prototype.writeCTab2000=function(t){this.writeCTab2000Header(),this.mapping={};var e=1,n=[],r=[];for(this.molecule.atoms.each(function(t,i){this.writePaddedFloat(i.pp.x,10,4),this.writePaddedFloat(-i.pp.y,10,4),this.writePaddedFloat(0,10,4),this.writeWhiteSpace();var o=i.label;null!=i.atomList?(o="L",n.push(t)):null==chem.Element.getElementByLabel(o)&&-1==["A","Q","X","*","R#"].indexOf(o)&&(o="C",r.push(t)),this.writePadded(o,3),this.writePaddedNumber(0,2),this.writePaddedNumber(0,3),this.writePaddedNumber(0,3),Object.isUndefined(i.hCount)&&(i.hCount=0),this.writePaddedNumber(i.hCount,3),Object.isUndefined(i.stereoCare)&&(i.stereoCare=0),this.writePaddedNumber(i.stereoCare,3),this.writePaddedNumber(i.explicitValence<0?0:0==i.explicitValence?15:i.explicitValence,3),this.writePaddedNumber(0,3),this.writePaddedNumber(0,3),this.writePaddedNumber(0,3),Object.isUndefined(i.aam)&&(i.aam=0),this.writePaddedNumber(i.aam,3),Object.isUndefined(i.invRet)&&(i.invRet=0),this.writePaddedNumber(i.invRet,3),Object.isUndefined(i.exactChangeFlag)&&(i.exactChangeFlag=0),this.writePaddedNumber(i.exactChangeFlag,3),this.writeCR(),this.mapping[t]=e,e++},this),this.bondMapping={},e=1,this.molecule.bonds.each(function(t,n){this.bondMapping[t]=e++,this.writePaddedNumber(this.mapping[n.begin],3),this.writePaddedNumber(this.mapping[n.end],3),this.writePaddedNumber(n.type,3),Object.isUndefined(n.stereo)&&(n.stereo=0),this.writePaddedNumber(n.stereo,3),this.writeWhiteSpace(3),Object.isUndefined(n.topology)&&(n.topology=0),this.writePaddedNumber(n.topology,3),Object.isUndefined(n.reactingCenterStatus)&&(n.reactingCenterStatus=0),this.writePaddedNumber(n.reactingCenterStatus,3),this.writeCR()},this);r.length>0;)this.write("A  "),this.writePaddedNumber(r[0]+1,3),this.writeCR(),this.writeCR(this.molecule.atoms.get(r[0]).label),r.splice(0,1);var i=new Array,o=new Array,s=new Array,a=new Array,l=new Array,c=new Array,h=new Array,u=new Array,d=new Array;this.molecule.atoms.each(function(t,e){if(0!=e.charge&&i.push([t,e.charge]),0!=e.isotope&&o.push([t,e.isotope]),0!=e.radical&&s.push([t,e.radical]),null!=e.rglabel&&"R#"==e.label)for(var n=0;32>n;n++)e.rglabel&1<<n&&a.push([t,n+1]);null!=e.attpnt&&c.push([t,e.attpnt]),0!=e.ringBondCount&&h.push([t,e.ringBondCount]),0!=e.substitutionCount&&d.push([t,e.substitutionCount]),0!=e.unsaturatedAtom&&u.push([t,e.unsaturatedAtom])}),t&&t.each(function(t,e){if(e.resth||e.ifthen>0||e.range.length>0){var n="  1 "+util.paddedInt(t,3)+" "+util.paddedInt(e.ifthen,3)+" "+util.paddedInt(e.resth?1:0,3)+"   "+e.range;l.push(n)}});var p=function(t,e){for(;e.length>0;){for(var n=new Array;e.length>0&&n.length<8;)n.push(e[0]),e.splice(0,1);this.write(t),this.writePaddedNumber(n.length,3),n.each(function(t){this.writeWhiteSpace(),this.writePaddedNumber(this.mapping[t[0]],3),this.writeWhiteSpace(),this.writePaddedNumber(t[1],3)},this),this.writeCR()}};p.call(this,"M  CHG",i),p.call(this,"M  ISO",o),p.call(this,"M  RAD",s),p.call(this,"M  RGP",a);for(var f=0;f<l.length;++f)this.write("M  LOG"+l[f]+"\n");if(p.call(this,"M  APO",c),p.call(this,"M  RBC",h),p.call(this,"M  SUB",d),p.call(this,"M  UNS",u),n.length>0)for(f=0;f<n.length;++f){var m=n[f],g=this.molecule.atoms.get(m).atomList;this.write("M  ALS"),this.writePaddedNumber(m+1,4),this.writePaddedNumber(g.ids.length,3),this.writeWhiteSpace(),this.write(g.notList?"T":"F");for(var b=g.labelList(),v=0;v<b.length;++v)this.writeWhiteSpace(),this.writePadded(b[v],3);this.writeCR()}var y={},x=1,S={},w=this.molecule.sGroupForest.getSGroupsBFS();util.each(w,function(t){S[x]=t,y[t]=x++},this);for(var E=1;x>E;++E){var B=S[E],R=this.molecule.sgroups.get(B);this.write("M  STY"),this.writePaddedNumber(1,3),this.writeWhiteSpace(1),this.writePaddedNumber(E,3),this.writeWhiteSpace(1),this.writePadded(R.type,3),this.writeCR(),this.write("M  SLB"),this.writePaddedNumber(1,3),this.writeWhiteSpace(1),this.writePaddedNumber(E,3),this.writeWhiteSpace(1),this.writePaddedNumber(E,3),this.writeCR();var C=this.molecule.sGroupForest.parent.get(B);if(C>=0&&(this.write("M  SPL"),this.writePaddedNumber(1,3),this.writeWhiteSpace(1),this.writePaddedNumber(E,3),this.writeWhiteSpace(1),this.writePaddedNumber(y[C],3),this.writeCR()),"SRU"==R.type&&R.data.connectivity){var A="";A+=" ",A+=util.stringPadded(E.toString(),3),A+=" ",A+=util.stringPadded(R.data.connectivity,3,!0),this.write("M  SCN"),this.writePaddedNumber(1,3),this.write(A.toUpperCase()),this.writeCR()}"SRU"==R.type&&(this.write("M  SMT "),this.writePaddedNumber(E,3),this.writeWhiteSpace(),this.write(R.data.subscript||"n"),this.writeCR()),this.writeCR(R.saveToMolfile(this.molecule,y,this.mapping,this.bondMapping))}this.writeCR("M  END")},chem.Molfile.parseRxn=function(t){var e=chem.Molfile,n=t[0].strip().split(" ");return n.length>1&&"V3000"==n[1]?e.parseRxn3000(t):e.parseRxn2000(t)},chem.Molfile.parseRxn2000=function(t){var e=chem.Molfile;t=t.slice(4);var n=e.partitionLine(t[0],e.fmtInfo.rxnItemsPartition),r=n[0]-0,i=n[1]-0,o=n[2]-0;t=t.slice(1);for(var s=[];t.length>0&&"$MOL"==t[0].substr(0,4);){t=t.slice(1);for(var a=0;a<t.length&&"$MOL"!=t[a].substr(0,4);)a++;s.push(chem.Molfile.parseMol(t.slice(0,a))),t=t.slice(a)}return e.rxnMerge(s,r,i,o)},chem.Molfile.parseRxn3000=function(t){var e=chem.Molfile;t=t.slice(4);for(var n=t[0].split(/\s+/g).slice(3),r=n[0]-0,i=n[1]-0,o=n.length>2?n[2]-0:0,s=function(t){util.assert(t,"CTab format invalid")},a=function(e){for(var n=e;n<t.length;++n)if("M  V30 END CTAB"==t[n].strip())return n;s(!1)},l=function(e){for(var n=e;n<t.length;++n)if("M  V30 END RGROUP"==t[n].strip())return n;s(!1)},c=[],h=[],u=null,d=[],p=0;p<t.length;++p){var f=t[p].strip();if(f.startsWith("M  V30 COUNTS"));else{if("M  END"==f)break;if("M  V30 BEGIN PRODUCT"==f)s(null==u),u=h;else if("M  V30 END PRODUCT"==f)s(u===h),u=null;else if("M  V30 BEGIN REACTANT"==f)s(null==u),u=c;else if("M  V30 END REACTANT"==f)s(u===c),u=null;else if(f.startsWith("M  V30 BEGIN RGROUP")){s(null==u);var m=l(p);d.push(t.slice(p,m+1)),p=m}else{if("M  V30 BEGIN CTAB"!=f)throw new Error("line unrecognized: "+f);var m=a(p);u.push(t.slice(p,m+1)),p=m}}}for(var g=[],b=c.concat(h),m=0;m<b.length;++m){var v=chem.Molfile.parseCTabV3000(b[m],n);g.push(v)}var y=e.rxnMerge(g,r,i,o);return e.readRGroups3000(y,function(t){for(var e=[],n=0;n<t.length;++n)e=e.concat(t[n]);return e}(d)),y},chem.Molfile.rxnMerge=function(t,e,n,r){var i,o=(chem.Molfile,new chem.Struct),s=[],a=[],l=[],c=[],h=[],u=[],d={cnt:0,totalLength:0};for(i=0;i<t.length;++i){var p=t[i],f=p.getBondLengthData();d.cnt+=f.cnt,d.totalLength+=f.totalLength}var m=1/(0==d.cnt?1:d.totalLength/d.cnt);for(i=0;i<t.length;++i)p=t[i],p.scale(m);for(i=0;i<t.length;++i){p=t[i];var g=p.getCoordBoundingBoxObj();if(g){var b=e>i?chem.Struct.FRAGMENT.REACTANT:e+n>i?chem.Struct.FRAGMENT.PRODUCT:chem.Struct.FRAGMENT.AGENT;b==chem.Struct.FRAGMENT.REACTANT?(s.push(g),c.push(p)):b==chem.Struct.FRAGMENT.AGENT?(a.push(g),h.push(p)):b==chem.Struct.FRAGMENT.PRODUCT&&(l.push(g),u.push(p)),p.atoms.each(function(t,e){e.rxnFragmentType=b})}}var v=0,y=function(t,e,n,r,i){var o=new util.Vec2(r-n.min.x,i?1-n.min.y:-(n.min.y+n.max.y)/2);return e.atoms.each(function(t,e){e.pp.add_(o)}),e.sgroups.each(function(t,e){e.pp&&e.pp.add_(o)}),n.min.add_(o),n.max.add_(o),e.mergeInto(t),n.max.x-n.min.x};for(i=0;i<c.length;++i)v+=y(o,c[i],s[i],v,!1)+2;for(v+=2,i=0;i<h.length;++i)v+=y(o,h[i],a[i],v,!0)+2;for(v+=2,i=0;i<u.length;++i)v+=y(o,u[i],l[i],v,!1)+2;var x,S,w,E,B=null,R=null;for(i=0;i<s.length-1;++i)x=s[i],S=s[i+1],w=(x.max.x+S.min.x)/2,E=(x.max.y+x.min.y+S.max.y+S.min.y)/4,o.rxnPluses.add(new chem.Struct.RxnPlus({pp:new util.Vec2(w,E)}));for(i=0;i<s.length;++i)0==i?(B={},B.max=new util.Vec2(s[i].max),B.min=new util.Vec2(s[i].min)):(B.max=util.Vec2.max(B.max,s[i].max),B.min=util.Vec2.min(B.min,s[i].min));for(i=0;i<l.length-1;++i)x=l[i],S=l[i+1],w=(x.max.x+S.min.x)/2,E=(x.max.y+x.min.y+S.max.y+S.min.y)/4,o.rxnPluses.add(new chem.Struct.RxnPlus({pp:new util.Vec2(w,E)}));for(i=0;i<l.length;++i)0==i?(R={},R.max=new util.Vec2(l[i].max),R.min=new util.Vec2(l[i].min)):(R.max=util.Vec2.max(R.max,l[i].max),R.min=util.Vec2.min(R.min,l[i].min));if(x=B,S=R,x||S){var C=x?new util.Vec2(x.max.x,(x.max.y+x.min.y)/2):null,A=S?new util.Vec2(S.min.x,(S.max.y+S.min.y)/2):null,_=3;C||(C=new util.Vec2(A.x-_,A.y)),A||(A=new util.Vec2(C.x+_,C.y)),o.rxnArrows.add(new chem.Struct.RxnArrow({pp:util.Vec2.lc2(C,.5,A,.5)}))}else o.rxnArrows.add(new chem.Struct.RxnArrow({pp:new util.Vec2(0,0)}));return o.isReaction=!0,o},chem.Molfile.rgMerge=function(t,e){var n=new chem.Struct;t.mergeInto(n,null,null,!1,!0);for(var r in e)for(var i=0;i<e[r].length;++i){var o=e[r][i];o.rgroups.set(r,new chem.Struct.RGroup);var s=o.frags.add(new chem.Struct.Fragment);o.rgroups.get(r).frags.add(s),o.atoms.each(function(t,e){e.fragment=s}),o.mergeInto(n)}return n},chem.Molfile.parseRg2000=function(t){var e=chem.Molfile;if(t=t.slice(7),"$CTAB"!=t[0].strip())throw new Error("RGFile format invalid");for(var n=1;"$"!=t[n].charAt(0);)n++;if("$END CTAB"!=t[n].strip())throw new Error("RGFile format invalid");var r=t.slice(1,n);t=t.slice(n+1);for(var i={};;){if(0==t.length)throw new Error("Unexpected end of file");var o=t[0].strip();if("$END MOL"==o){t=t.slice(1);break}if("$RGP"!=o)throw new Error("RGFile format invalid");var s=t[1].strip()-0;for(i[s]=[],t=t.slice(2);;){if(0==t.length)throw new Error("Unexpected end of file");if(o=t[0].strip(),"$END RGP"==o){t=t.slice(1);break}if("$CTAB"!=o)throw new Error("RGFile format invalid");for(n=1;"$"!=t[n].charAt(0);)n++;if("$END CTAB"!=t[n].strip())throw new Error("RGFile format invalid");i[s].push(t.slice(1,n)),t=t.slice(n+1)}}var a=chem.Molfile.parseCTab(r),l={};if(chem.Molfile.loadRGroupFragments)for(var c in i){l[c]=[];for(var h=0;h<i[c].length;++h)l[c].push(chem.Molfile.parseCTab(i[c][h]))}return e.rgMerge(a,l)};var Prototype={Version:"1.7",Browser:function(){var t=navigator.userAgent,e="[object Opera]"==Object.prototype.toString.call(window.opera);return{IE:!!window.attachEvent&&!e,Opera:e,WebKit:t.indexOf("AppleWebKit/")>-1,Gecko:t.indexOf("Gecko")>-1&&-1===t.indexOf("KHTML"),MobileSafari:/Apple.*Mobile/.test(t)}}(),BrowserFeatures:{XPath:!!document.evaluate,SelectorsAPI:!!document.querySelector,ElementExtensions:function(){var t=window.Element||window.HTMLElement;return!(!t||!t.prototype)}(),SpecificElementExtensions:function(){if("undefined"!=typeof window.HTMLDivElement)return!0;var t=document.createElement("div"),e=document.createElement("form"),n=!1;return t.__proto__&&t.__proto__!==e.__proto__&&(n=!0),t=e=null,n}()},ScriptFragment:"<script[^>]*>([\\S\\s]*?)</script>",JSONFilter:/^\/\*-secure-([\s\S]*)\*\/\s*$/,emptyFunction:function(){},K:function(t){return t}};Prototype.Browser.MobileSafari&&(Prototype.BrowserFeatures.SpecificElementExtensions=!1);var Abstract={},Try={these:function(){for(var t,e=0,n=arguments.length;n>e;e++){var r=arguments[e];try{t=r();break}catch(i){}}return t}},Class=function(){function t(){}function e(){function e(){this.initialize.apply(this,arguments)}var n=null,r=$A(arguments);Object.isFunction(r[0])&&(n=r.shift()),Object.extend(e,Class.Methods),e.superclass=n,e.subclasses=[],n&&(t.prototype=n.prototype,e.prototype=new t,n.subclasses.push(e));for(var i=0,o=r.length;o>i;i++)e.addMethods(r[i]);return e.prototype.initialize||(e.prototype.initialize=Prototype.emptyFunction),e.prototype.constructor=e,e}function n(t){var e=this.superclass&&this.superclass.prototype,n=Object.keys(t);r&&(t.toString!=Object.prototype.toString&&n.push("toString"),t.valueOf!=Object.prototype.valueOf&&n.push("valueOf"));for(var i=0,o=n.length;o>i;i++){var s=n[i],a=t[s];if(e&&Object.isFunction(a)&&"$super"==a.argumentNames()[0]){var l=a;a=function(t){return function(){return e[t].apply(this,arguments)}}(s).wrap(l),a.valueOf=l.valueOf.bind(l),a.toString=l.toString.bind(l)}this.prototype[s]=a}return this}var r=function(){for(var t in{toString:1})if("toString"===t)return!1;return!0}();return{create:e,Methods:{addMethods:n}}}();!function(){function t(t){switch(t){case null:return x;case void 0:return S}var e=typeof t;switch(e){case"boolean":return w;case"number":return E;case"string":return B}return R}function e(t,e){for(var n in e)t[n]=e[n];return t}function n(t){try{return v(t)?"undefined":null===t?"null":t.inspect?t.inspect():String(t)}catch(e){if(e instanceof RangeError)return"...";throw e}}function r(t){return i("",{"":t},[])}function i(e,n,r){var o=n[e],s=typeof o;t(o)===R&&"function"==typeof o.toJSON&&(o=o.toJSON(e));var a=y.call(o);switch(a){case _:case A:case O:o=o.valueOf()}switch(o){case null:return"null";case!0:return"true";case!1:return"false"}switch(s=typeof o){case"string":return o.inspect(!0);case"number":return isFinite(o)?String(o):"null";case"object":for(var l=0,c=r.length;c>l;l++)if(r[l]===o)throw new TypeError;r.push(o);var h=[];if(a===T){for(var l=0,c=o.length;c>l;l++){var u=i(l,o,r);h.push("undefined"==typeof u?"null":u)}h="["+h.join(",")+"]"}else{for(var d=Object.keys(o),l=0,c=d.length;c>l;l++){var e=d[l],u=i(e,o,r);"undefined"!=typeof u&&h.push(e.inspect(!0)+":"+u)}h="{"+h.join(",")+"}"}return r.pop(),h}}function o(t){return JSON.stringify(t)}function s(t){return $H(t).toQueryString()}function a(t){return t&&t.toHTML?t.toHTML():String.interpret(t)}function l(e){if(t(e)!==R)throw new TypeError;var n=[];for(var r in e)e.hasOwnProperty(r)&&n.push(r);return n}function c(t){var e=[];for(var n in t)e.push(t[n]);return e}function h(t){return e({},t)}function u(t){return!(!t||1!=t.nodeType)}function d(t){return y.call(t)===T}function p(t){return t instanceof Hash}function f(t){return y.call(t)===C}function m(t){return y.call(t)===O}function g(t){return y.call(t)===_}function b(t){return y.call(t)===P}function v(t){return"undefined"==typeof t}var y=Object.prototype.toString,x="Null",S="Undefined",w="Boolean",E="Number",B="String",R="Object",C="[object Function]",A="[object Boolean]",_="[object Number]",O="[object String]",T="[object Array]",P="[object Date]",M=window.JSON&&"function"==typeof JSON.stringify&&"0"===JSON.stringify(0)&&"undefined"==typeof JSON.stringify(Prototype.K),N="function"==typeof Array.isArray&&Array.isArray([])&&!Array.isArray({});N&&(d=Array.isArray),e(Object,{extend:e,inspect:n,toJSON:M?o:r,toQueryString:s,toHTML:a,keys:Object.keys||l,values:c,clone:h,isElement:u,isArray:d,isHash:p,isFunction:f,isString:m,isNumber:g,isDate:b,isUndefined:v})}(),Object.extend(Function.prototype,function(){function t(t,e){for(var n=t.length,r=e.length;r--;)t[n+r]=e[r];return t}function e(e,n){return e=h.call(e,0),t(e,n)}function n(){var t=this.toString().match(/^[\s\(]*function[^(]*\(([^)]*)\)/)[1].replace(/\/\/.*?[\r\n]|\/\*(?:.|[\r\n])*?\*\//g,"").replace(/\s+/g,"").split(",");return 1!=t.length||t[0]?t:[]}function r(t){if(arguments.length<2&&Object.isUndefined(arguments[0]))return this;var n=this,r=h.call(arguments,1);return function(){var i=e(r,arguments);return n.apply(t,i)}}function i(e){var n=this,r=h.call(arguments,1);return function(i){var o=t([i||window.event],r);return n.apply(e,o)}}function o(){if(!arguments.length)return this;var t=this,n=h.call(arguments,0);return function(){var r=e(n,arguments);return t.apply(this,r)}}function s(t){var e=this,n=h.call(arguments,1);return t=1e3*t,window.setTimeout(function(){return e.apply(e,n)},t)}function a(){var e=t([.01],arguments);return this.delay.apply(this,e)}function l(e){var n=this;return function(){var r=t([n.bind(this)],arguments);return e.apply(this,r)}}function c(){if(this._methodized)return this._methodized;var e=this;return this._methodized=function(){var n=t([this],arguments);return e.apply(null,n)}}var h=Array.prototype.slice;return{argumentNames:n,bind:r,bindAsEventListener:i,curry:o,delay:s,defer:a,wrap:l,methodize:c}}()),function(t){function e(){return this.getUTCFullYear()+"-"+(this.getUTCMonth()+1).toPaddedString(2)+"-"+this.getUTCDate().toPaddedString(2)+"T"+this.getUTCHours().toPaddedString(2)+":"+this.getUTCMinutes().toPaddedString(2)+":"+this.getUTCSeconds().toPaddedString(2)+"Z"}function n(){return this.toISOString()}t.toISOString||(t.toISOString=e),t.toJSON||(t.toJSON=n)}(Date.prototype),RegExp.prototype.match=RegExp.prototype.test,RegExp.escape=function(t){return String(t).replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1")};var PeriodicalExecuter=Class.create({initialize:function(t,e){this.callback=t,this.frequency=e,this.currentlyExecuting=!1,this.registerCallback()},registerCallback:function(){this.timer=setInterval(this.onTimerEvent.bind(this),1e3*this.frequency)},execute:function(){this.callback(this)},stop:function(){this.timer&&(clearInterval(this.timer),this.timer=null)},onTimerEvent:function(){if(!this.currentlyExecuting)try{this.currentlyExecuting=!0,this.execute(),this.currentlyExecuting=!1}catch(t){throw this.currentlyExecuting=!1,t}}});Object.extend(String,{interpret:function(t){return null==t?"":String(t)},specialChar:{"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r","\\":"\\\\"}}),Object.extend(String.prototype,function(){function prepareReplacement(t){if(Object.isFunction(t))return t;var e=new Template(t);return function(t){return e.evaluate(t)}}function gsub(t,e){var n,r="",i=this;if(e=prepareReplacement(e),Object.isString(t)&&(t=RegExp.escape(t)),!t.length&&!t.source)return e=e(""),e+i.split("").join(e)+e;for(;i.length>0;)(n=i.match(t))?(r+=i.slice(0,n.index),r+=String.interpret(e(n)),i=i.slice(n.index+n[0].length)):(r+=i,i="");return r}function sub(t,e,n){return e=prepareReplacement(e),n=Object.isUndefined(n)?1:n,this.gsub(t,function(t){return--n<0?t[0]:e(t)})}function scan(t,e){return this.gsub(t,e),String(this)}function truncate(t,e){return t=t||30,e=Object.isUndefined(e)?"...":e,this.length>t?this.slice(0,t-e.length)+e:String(this)}function strip(){return this.replace(/^\s+/,"").replace(/\s+$/,"")}function stripTags(){return this.replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi,"")}function stripScripts(){return this.replace(new RegExp(Prototype.ScriptFragment,"img"),"")}function extractScripts(){var t=new RegExp(Prototype.ScriptFragment,"img"),e=new RegExp(Prototype.ScriptFragment,"im");return(this.match(t)||[]).map(function(t){return(t.match(e)||["",""])[1]})}function evalScripts(){return this.extractScripts().map(function(script){return eval(script)})}function escapeHTML(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function unescapeHTML(){return this.stripTags().replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")}function toQueryParams(t){var e=this.strip().match(/([^?#]*)(#.*)?$/);return e?e[1].split(t||"&").inject({},function(t,e){if((e=e.split("="))[0]){var n=decodeURIComponent(e.shift()),r=e.length>1?e.join("="):e[0];void 0!=r&&(r=decodeURIComponent(r)),n in t?(Object.isArray(t[n])||(t[n]=[t[n]]),t[n].push(r)):t[n]=r}return t}):{}}function toArray(){return this.split("")}function succ(){return this.slice(0,this.length-1)+String.fromCharCode(this.charCodeAt(this.length-1)+1)}function times(t){return 1>t?"":new Array(t+1).join(this)}function camelize(){return this.replace(/-+(.)?/g,function(t,e){return e?e.toUpperCase():""})}function capitalize(){return this.charAt(0).toUpperCase()+this.substring(1).toLowerCase()}function underscore(){return this.replace(/::/g,"/").replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").replace(/-/g,"_").toLowerCase()}function dasherize(){return this.replace(/_/g,"-")}function inspect(t){var e=this.replace(/[\x00-\x1f\\]/g,function(t){
return t in String.specialChar?String.specialChar[t]:"\\u00"+t.charCodeAt().toPaddedString(2,16)});return t?'"'+e.replace(/"/g,'\\"')+'"':"'"+e.replace(/'/g,"\\'")+"'"}function unfilterJSON(t){return this.replace(t||Prototype.JSONFilter,"$1")}function isJSON(){var t=this;return t.blank()?!1:(t=t.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@"),t=t.replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]"),t=t.replace(/(?:^|:|,)(?:\s*\[)+/g,""),/^[\],:{}\s]*$/.test(t))}function evalJSON(sanitize){var json=this.unfilterJSON(),cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;cx.test(json)&&(json=json.replace(cx,function(t){return"\\u"+("0000"+t.charCodeAt(0).toString(16)).slice(-4)}));try{if(!sanitize||json.isJSON())return eval("("+json+")")}catch(e){}throw new SyntaxError("Badly formed JSON string: "+this.inspect())}function parseJSON(){var t=this.unfilterJSON();return JSON.parse(t)}function include(t){return this.indexOf(t)>-1}function startsWith(t){return 0===this.lastIndexOf(t,0)}function endsWith(t){var e=this.length-t.length;return e>=0&&this.indexOf(t,e)===e}function empty(){return""==this}function blank(){return/^\s*$/.test(this)}function interpolate(t,e){return new Template(this,e).evaluate(t)}var NATIVE_JSON_PARSE_SUPPORT=window.JSON&&"function"==typeof JSON.parse&&JSON.parse('{"test": true}').test;return{gsub:gsub,sub:sub,scan:scan,truncate:truncate,strip:String.prototype.trim||strip,stripTags:stripTags,stripScripts:stripScripts,extractScripts:extractScripts,evalScripts:evalScripts,escapeHTML:escapeHTML,unescapeHTML:unescapeHTML,toQueryParams:toQueryParams,parseQuery:toQueryParams,toArray:toArray,succ:succ,times:times,camelize:camelize,capitalize:capitalize,underscore:underscore,dasherize:dasherize,inspect:inspect,unfilterJSON:unfilterJSON,isJSON:isJSON,evalJSON:NATIVE_JSON_PARSE_SUPPORT?parseJSON:evalJSON,include:include,startsWith:startsWith,endsWith:endsWith,empty:empty,blank:blank,interpolate:interpolate}}());var Template=Class.create({initialize:function(t,e){this.template=t.toString(),this.pattern=e||Template.Pattern},evaluate:function(t){return t&&Object.isFunction(t.toTemplateReplacements)&&(t=t.toTemplateReplacements()),this.template.gsub(this.pattern,function(e){if(null==t)return e[1]+"";var n=e[1]||"";if("\\"==n)return e[2];var r=t,i=e[3],o=/^([^.[]+|\[((?:.*?[^\\])?)\])(\.|\[|$)/;if(e=o.exec(i),null==e)return n;for(;null!=e;){var s=e[1].startsWith("[")?e[2].replace(/\\\\]/g,"]"):e[1];if(r=r[s],null==r||""==e[3])break;i=i.substring("["==e[3]?e[1].length:e[0].length),e=o.exec(i)}return n+String.interpret(r)})}});Template.Pattern=/(^|.|\r|\n)(#\{(.*?)\})/;var $break={},Enumerable=function(){function t(t,e){var n=0;try{this._each(function(r){t.call(e,r,n++)})}catch(r){if(r!=$break)throw r}return this}function e(t,e,n){var r=-t,i=[],o=this.toArray();if(1>t)return o;for(;(r+=t)<o.length;)i.push(o.slice(r,r+t));return i.collect(e,n)}function n(t,e){t=t||Prototype.K;var n=!0;return this.each(function(r,i){if(n=n&&!!t.call(e,r,i),!n)throw $break}),n}function r(t,e){t=t||Prototype.K;var n=!1;return this.each(function(r,i){if(n=!!t.call(e,r,i))throw $break}),n}function i(t,e){t=t||Prototype.K;var n=[];return this.each(function(r,i){n.push(t.call(e,r,i))}),n}function o(t,e){var n;return this.each(function(r,i){if(t.call(e,r,i))throw n=r,$break}),n}function s(t,e){var n=[];return this.each(function(r,i){t.call(e,r,i)&&n.push(r)}),n}function a(t,e,n){e=e||Prototype.K;var r=[];return Object.isString(t)&&(t=new RegExp(RegExp.escape(t))),this.each(function(i,o){t.match(i)&&r.push(e.call(n,i,o))}),r}function l(t){if(Object.isFunction(this.indexOf)&&-1!=this.indexOf(t))return!0;var e=!1;return this.each(function(n){if(n==t)throw e=!0,$break}),e}function c(t,e){return e=Object.isUndefined(e)?null:e,this.eachSlice(t,function(n){for(;n.length<t;)n.push(e);return n})}function h(t,e,n){return this.each(function(r,i){t=e.call(n,t,r,i)}),t}function u(t){var e=$A(arguments).slice(1);return this.map(function(n){return n[t].apply(n,e)})}function d(t,e){t=t||Prototype.K;var n;return this.each(function(r,i){r=t.call(e,r,i),(null==n||r>=n)&&(n=r)}),n}function p(t,e){t=t||Prototype.K;var n;return this.each(function(r,i){r=t.call(e,r,i),(null==n||n>r)&&(n=r)}),n}function f(t,e){t=t||Prototype.K;var n=[],r=[];return this.each(function(i,o){(t.call(e,i,o)?n:r).push(i)}),[n,r]}function m(t){var e=[];return this.each(function(n){e.push(n[t])}),e}function g(t,e){var n=[];return this.each(function(r,i){t.call(e,r,i)||n.push(r)}),n}function b(t,e){return this.map(function(n,r){return{value:n,criteria:t.call(e,n,r)}}).sort(function(t,e){var n=t.criteria,r=e.criteria;return r>n?-1:n>r?1:0}).pluck("value")}function v(){return this.map()}function y(){var t=Prototype.K,e=$A(arguments);Object.isFunction(e.last())&&(t=e.pop());var n=[this].concat(e).map($A);return this.map(function(e,r){return t(n.pluck(r))})}function x(){return this.toArray().length}function S(){return"#<Enumerable:"+this.toArray().inspect()+">"}return{each:t,eachSlice:e,all:n,every:n,any:r,some:r,collect:i,map:i,detect:o,findAll:s,select:s,filter:s,grep:a,include:l,member:l,inGroupsOf:c,inject:h,invoke:u,max:d,min:p,partition:f,pluck:m,reject:g,sortBy:b,toArray:v,entries:v,zip:y,size:x,inspect:S,find:o}}();Array.from=$A,function(){function t(t,e){for(var n=0,r=this.length>>>0;r>n;n++)n in this&&t.call(e,this[n],n,this)}function e(){return this.length=0,this}function n(){return this[0]}function r(){return this[this.length-1]}function i(){return this.select(function(t){return null!=t})}function o(){return this.inject([],function(t,e){return Object.isArray(e)?t.concat(e.flatten()):(t.push(e),t)})}function s(){var t=b.call(arguments,0);return this.select(function(e){return!t.include(e)})}function a(t){return(t===!1?this.toArray():this)._reverse()}function l(t){return this.inject([],function(e,n,r){return 0!=r&&(t?e.last()==n:e.include(n))||e.push(n),e})}function c(t){return this.uniq().findAll(function(e){return t.detect(function(t){return e===t})})}function h(){return b.call(this,0)}function u(){return this.length}function d(){return"["+this.map(Object.inspect).join(", ")+"]"}function p(t,e){e||(e=0);var n=this.length;for(0>e&&(e=n+e);n>e;e++)if(this[e]===t)return e;return-1}function f(t,e){e=isNaN(e)?this.length:(0>e?this.length+e:e)+1;var n=this.slice(0,e).reverse().indexOf(t);return 0>n?n:e-n-1}function m(){for(var t,e=b.call(this,0),n=0,r=arguments.length;r>n;n++)if(t=arguments[n],!Object.isArray(t)||"callee"in t)e.push(t);else for(var i=0,o=t.length;o>i;i++)e.push(t[i]);return e}var g=Array.prototype,b=g.slice,v=g.forEach;v||(v=t),Object.extend(g,Enumerable),g._reverse||(g._reverse=g.reverse),Object.extend(g,{_each:v,clear:e,first:n,last:r,compact:i,flatten:o,without:s,reverse:a,uniq:l,intersect:c,clone:h,toArray:h,size:u,inspect:d});var y=function(){return 1!==[].concat(arguments)[0][0]}(1,2);y&&(g.concat=m),g.indexOf||(g.indexOf=p),g.lastIndexOf||(g.lastIndexOf=f)}();var Hash=Class.create(Enumerable,function(){function t(t){this._object=Object.isHash(t)?t.toObject():Object.clone(t)}function e(t){for(var e in this._object){var n=this._object[e],r=[e,n];r.key=e,r.value=n,t(r)}}function n(t,e){return this._object[t]=e}function r(t){return this._object[t]!==Object.prototype[t]?this._object[t]:void 0}function i(t){var e=this._object[t];return delete this._object[t],e}function o(){return Object.clone(this._object)}function s(){return this.pluck("key")}function a(){return this.pluck("value")}function l(t){var e=this.detect(function(e){return e.value===t});return e&&e.key}function c(t){return this.clone().update(t)}function h(t){return new Hash(t).inject(this,function(t,e){return t.set(e.key,e.value),t})}function u(t,e){return Object.isUndefined(e)?t:t+"="+encodeURIComponent(String.interpret(e))}function d(){return this.inject([],function(t,e){var n=encodeURIComponent(e.key),r=e.value;if(r&&"object"==typeof r){if(Object.isArray(r)){for(var i,o=[],s=0,a=r.length;a>s;s++)i=r[s],o.push(u(n,i));return t.concat(o)}}else t.push(u(n,r));return t}).join("&")}function p(){return"#<Hash:{"+this.map(function(t){return t.map(Object.inspect).join(": ")}).join(", ")+"}>"}function f(){return new Hash(this)}return{initialize:t,_each:e,set:n,get:r,unset:i,toObject:o,toTemplateReplacements:o,keys:s,values:a,index:l,merge:c,update:h,toQueryString:d,inspect:p,toJSON:o,clone:f}}());Hash.from=$H,Object.extend(Number.prototype,function(){function t(){return this.toPaddedString(2,16)}function e(){return this+1}function n(t,e){return $R(0,this,!0).each(t,e),this}function r(t,e){var n=this.toString(e||10);return"0".times(t-n.length)+n}function i(){return Math.abs(this)}function o(){return Math.round(this)}function s(){return Math.ceil(this)}function a(){return Math.floor(this)}return{toColorPart:t,succ:e,times:n,toPaddedString:r,abs:i,round:o,ceil:s,floor:a}}());var ObjectRange=Class.create(Enumerable,function(){function t(t,e,n){this.start=t,this.end=e,this.exclusive=n}function e(t){for(var e=this.start;this.include(e);)t(e),e=e.succ()}function n(t){return t<this.start?!1:this.exclusive?t<this.end:t<=this.end}return{initialize:t,_each:e,include:n}}()),Ajax={getTransport:function(){return Try.these(function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")})||!1},activeRequestCount:0};if(Ajax.Responders={responders:[],_each:function(t){this.responders._each(t)},register:function(t){this.include(t)||this.responders.push(t)},unregister:function(t){this.responders=this.responders.without(t)},dispatch:function(t,e,n,r){this.each(function(i){if(Object.isFunction(i[t]))try{i[t].apply(i,[e,n,r])}catch(o){}})}},Object.extend(Ajax.Responders,Enumerable),Ajax.Responders.register({onCreate:function(){Ajax.activeRequestCount++},onComplete:function(){Ajax.activeRequestCount--}}),Ajax.Base=Class.create({initialize:function(t){this.options={method:"post",asynchronous:!0,contentType:"application/x-www-form-urlencoded",encoding:"UTF-8",parameters:"",evalJSON:!0,evalJS:!0},Object.extend(this.options,t||{}),this.options.method=this.options.method.toLowerCase(),Object.isHash(this.options.parameters)&&(this.options.parameters=this.options.parameters.toObject())}}),Ajax.Request=Class.create(Ajax.Base,{_complete:!1,initialize:function(t,e,n){t(n),this.transport=Ajax.getTransport(),this.request(e)},request:function(t){this.url=t,this.method=this.options.method;var e=Object.isString(this.options.parameters)?this.options.parameters:Object.toQueryString(this.options.parameters);["get","post"].include(this.method)||(e+=(e?"&":"")+"_method="+this.method,this.method="post"),e&&"get"===this.method&&(this.url+=(this.url.include("?")?"&":"?")+e),this.parameters=e.toQueryParams();try{var n=new Ajax.Response(this);this.options.onCreate&&this.options.onCreate(n),Ajax.Responders.dispatch("onCreate",this,n),this.transport.open(this.method.toUpperCase(),this.url,this.options.asynchronous),this.options.asynchronous&&this.respondToReadyState.bind(this).defer(1),this.transport.onreadystatechange=this.onStateChange.bind(this),this.setRequestHeaders(),this.body="post"==this.method?this.options.postBody||e:null,this.transport.send(this.body),!this.options.asynchronous&&this.transport.overrideMimeType&&this.onStateChange()}catch(r){this.dispatchException(r)}},onStateChange:function(){var t=this.transport.readyState;t>1&&(4!=t||!this._complete)&&this.respondToReadyState(this.transport.readyState)},setRequestHeaders:function(){var t={"X-Requested-With":"XMLHttpRequest","X-Prototype-Version":Prototype.Version,Accept:"text/javascript, text/html, application/xml, text/xml, */*"};if("post"==this.method&&(t["Content-type"]=this.options.contentType+(this.options.encoding?"; charset="+this.options.encoding:""),this.transport.overrideMimeType&&(navigator.userAgent.match(/Gecko\/(\d{4})/)||[0,2005])[1]<2005&&(t.Connection="close")),"object"==typeof this.options.requestHeaders){var e=this.options.requestHeaders;if(Object.isFunction(e.push))for(var n=0,r=e.length;r>n;n+=2)t[e[n]]=e[n+1];else $H(e).each(function(e){t[e.key]=e.value})}for(var i in t)this.transport.setRequestHeader(i,t[i])},success:function(){var t=this.getStatus();return!t||t>=200&&300>t||304==t},getStatus:function(){try{return 1223===this.transport.status?204:this.transport.status||0}catch(t){return 0}},respondToReadyState:function(t){var e=Ajax.Request.Events[t],n=new Ajax.Response(this);if("Complete"==e){try{this._complete=!0,(this.options["on"+n.status]||this.options["on"+(this.success()?"Success":"Failure")]||Prototype.emptyFunction)(n,n.headerJSON)}catch(r){this.dispatchException(r)}var i=n.getHeader("Content-type");("force"==this.options.evalJS||this.options.evalJS&&this.isSameOrigin()&&i&&i.match(/^\s*(text|application)\/(x-)?(java|ecma)script(;.*)?\s*$/i))&&this.evalResponse()}try{(this.options["on"+e]||Prototype.emptyFunction)(n,n.headerJSON),Ajax.Responders.dispatch("on"+e,this,n,n.headerJSON)}catch(r){this.dispatchException(r)}"Complete"==e&&(this.transport.onreadystatechange=Prototype.emptyFunction)},isSameOrigin:function(){var t=this.url.match(/^\s*https?:\/\/[^\/]*/);return!t||t[0]=="#{protocol}//#{domain}#{port}".interpolate({protocol:location.protocol,domain:document.domain,port:location.port?":"+location.port:""})},getHeader:function(t){try{return this.transport.getResponseHeader(t)||null}catch(e){return null}},evalResponse:function(){try{return eval((this.transport.responseText||"").unfilterJSON())}catch(e){this.dispatchException(e)}},dispatchException:function(t){(this.options.onException||Prototype.emptyFunction)(this,t),Ajax.Responders.dispatch("onException",this,t)}}),Ajax.Request.Events=["Uninitialized","Loading","Loaded","Interactive","Complete"],Ajax.Response=Class.create({initialize:function(t){this.request=t;var e=this.transport=t.transport,n=this.readyState=e.readyState;if((n>2&&!Prototype.Browser.IE||4==n)&&(this.status=this.getStatus(),this.statusText=this.getStatusText(),this.responseText=String.interpret(e.responseText),this.headerJSON=this._getHeaderJSON()),4==n){var r=e.responseXML;this.responseXML=Object.isUndefined(r)?null:r,this.responseJSON=this._getResponseJSON()}},status:0,statusText:"",getStatus:Ajax.Request.prototype.getStatus,getStatusText:function(){try{return this.transport.statusText||""}catch(t){return""}},getHeader:Ajax.Request.prototype.getHeader,getAllHeaders:function(){try{return this.getAllResponseHeaders()}catch(t){return null}},getResponseHeader:function(t){return this.transport.getResponseHeader(t)},getAllResponseHeaders:function(){return this.transport.getAllResponseHeaders()},_getHeaderJSON:function(){var t=this.getHeader("X-JSON");if(!t)return null;t=decodeURIComponent(escape(t));try{return t.evalJSON(this.request.options.sanitizeJSON||!this.request.isSameOrigin())}catch(e){this.request.dispatchException(e)}},_getResponseJSON:function(){var t=this.request.options;if(!t.evalJSON||"force"!=t.evalJSON&&!(this.getHeader("Content-type")||"").include("application/json")||this.responseText.blank())return null;try{return this.responseText.evalJSON(t.sanitizeJSON||!this.request.isSameOrigin())}catch(e){this.request.dispatchException(e)}}}),Ajax.Updater=Class.create(Ajax.Request,{initialize:function(t,e,n,r){this.container={success:e.success||e,failure:e.failure||(e.success?null:e)},r=Object.clone(r);var i=r.onComplete;r.onComplete=function(t,e){this.updateContent(t.responseText),Object.isFunction(i)&&i(t,e)}.bind(this),t(n,r)},updateContent:function(t){var e=this.container[this.success()?"success":"failure"],n=this.options;if(n.evalScripts||(t=t.stripScripts()),e=$(e))if(n.insertion)if(Object.isString(n.insertion)){var r={};r[n.insertion]=t,e.insert(r)}else n.insertion(e,t);else e.update(t)}}),Ajax.PeriodicalUpdater=Class.create(Ajax.Base,{initialize:function(t,e,n,r){t(r),this.onComplete=this.options.onComplete,this.frequency=this.options.frequency||2,this.decay=this.options.decay||1,this.updater={},this.container=e,this.url=n,this.start()},start:function(){this.options.onComplete=this.updateComplete.bind(this),this.onTimerEvent()},stop:function(){this.updater.options.onComplete=void 0,clearTimeout(this.timer),(this.onComplete||Prototype.emptyFunction).apply(this,arguments)},updateComplete:function(t){this.options.decay&&(this.decay=t.responseText==this.lastText?this.decay*this.options.decay:1,this.lastText=t.responseText),this.timer=this.onTimerEvent.bind(this).delay(this.decay*this.frequency)},onTimerEvent:function(){this.updater=new Ajax.Updater(this.container,this.url,this.options)}}),Prototype.BrowserFeatures.XPath&&(document._getElementsByXPath=function(t,e){for(var n=[],r=document.evaluate(t,$(e)||document,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),i=0,o=r.snapshotLength;o>i;i++)n.push(Element.extend(r.snapshotItem(i)));return n}),!Node)var Node={};Node.ELEMENT_NODE||Object.extend(Node,{ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12}),function(t){function e(t,e){return"select"===t?!1:"type"in e?!1:!0}var n=function(){try{var t=document.createElement('<input name="x">');return"input"===t.tagName.toLowerCase()&&"x"===t.name}catch(e){return!1}}(),r=t.Element;t.Element=function(t,r){r=r||{},t=t.toLowerCase();var i=Element.cache;if(n&&r.name)return t="<"+t+' name="'+r.name+'">',delete r.name,Element.writeAttribute(document.createElement(t),r);i[t]||(i[t]=Element.extend(document.createElement(t)));var o=e(t,r)?i[t].cloneNode(!1):document.createElement(t);return Element.writeAttribute(o,r)},Object.extend(t.Element,r||{}),r&&(t.Element.prototype=r.prototype)}(this),Element.idCounter=1,Element.cache={},Element._purgeElement=function(t){var e=t._prototypeUID;e&&(Element.stopObserving(t),t._prototypeUID=void 0,delete Element.Storage[e])},Element.Methods={visible:function(t){return"none"!=$(t).style.display},toggle:function(t){return t=$(t),Element[Element.visible(t)?"hide":"show"](t),t},hide:function(t){return t=$(t),t.style.display="none",t},show:function(t){return t=$(t),t.style.display="",t},remove:function(t){return t=$(t),t.parentNode.removeChild(t),t},update:function(){function t(t,e){t=$(t);for(var n=Element._purgeElement,s=t.getElementsByTagName("*"),a=s.length;a--;)n(s[a]);if(e&&e.toElement&&(e=e.toElement()),Object.isElement(e))return t.update().insert(e);e=Object.toHTML(e);var l=t.tagName.toUpperCase();if("SCRIPT"===l&&o)return t.text=e,t;if(i)if(l in Element._insertionTranslations.tags){for(;t.firstChild;)t.removeChild(t.firstChild);Element._getContentFromAnonymousElement(l,e.stripScripts()).each(function(e){t.appendChild(e)})}else if(r&&Object.isString(e)&&e.indexOf("<link")>-1){for(;t.firstChild;)t.removeChild(t.firstChild);var c=Element._getContentFromAnonymousElement(l,e.stripScripts(),!0);c.each(function(e){t.appendChild(e)})}else t.innerHTML=e.stripScripts();else t.innerHTML=e.stripScripts();return e.evalScripts.bind(e).defer(),t}var e=function(){var t=document.createElement("select"),e=!0;return t.innerHTML='<option value="test">test</option>',t.options&&t.options[0]&&(e="OPTION"!==t.options[0].nodeName.toUpperCase()),t=null,e}(),n=function(){try{var t=document.createElement("table");if(t&&t.tBodies){t.innerHTML="<tbody><tr><td>test</td></tr></tbody>";var e="undefined"==typeof t.tBodies[0];return t=null,e}}catch(n){return!0}}(),r=function(){try{var t=document.createElement("div");t.innerHTML="<link>";var e=0===t.childNodes.length;return t=null,e}catch(n){return!0}}(),i=e||n||r,o=function(){var t=document.createElement("script"),e=!1;try{t.appendChild(document.createTextNode("")),e=!t.firstChild||t.firstChild&&3!==t.firstChild.nodeType}catch(n){e=!0}return t=null,e}();return t}(),replace:function(t,e){if(t=$(t),e&&e.toElement)e=e.toElement();else if(!Object.isElement(e)){e=Object.toHTML(e);var n=t.ownerDocument.createRange();n.selectNode(t),e.evalScripts.bind(e).defer(),e=n.createContextualFragment(e.stripScripts())}return t.parentNode.replaceChild(e,t),t},insert:function(t,e){t=$(t),(Object.isString(e)||Object.isNumber(e)||Object.isElement(e)||e&&(e.toElement||e.toHTML))&&(e={bottom:e});var n,r,i,o;for(var s in e)n=e[s],s=s.toLowerCase(),r=Element._insertionTranslations[s],n&&n.toElement&&(n=n.toElement()),Object.isElement(n)?r(t,n):(n=Object.toHTML(n),i=("before"==s||"after"==s?t.parentNode:t).tagName.toUpperCase(),o=Element._getContentFromAnonymousElement(i,n.stripScripts()),("top"==s||"after"==s)&&o.reverse(),o.each(r.curry(t)),n.evalScripts.bind(n).defer());return t},wrap:function(t,e,n){return t=$(t),Object.isElement(e)?$(e).writeAttribute(n||{}):e=Object.isString(e)?new Element(e,n):new Element("div",e),t.parentNode&&t.parentNode.replaceChild(e,t),e.appendChild(t),e},inspect:function(t){t=$(t);var e="<"+t.tagName.toLowerCase();return $H({id:"id",className:"class"}).each(function(n){var r=n.first(),i=n.last(),o=(t[r]||"").toString();o&&(e+=" "+i+"="+o.inspect(!0))}),e+">"},recursivelyCollect:function(t,e,n){t=$(t),n=n||-1;for(var r=[];(t=t[e])&&(1==t.nodeType&&r.push(Element.extend(t)),r.length!=n););return r},ancestors:function(t){return Element.recursivelyCollect(t,"parentNode")},descendants:function(t){return Element.select(t,"*")},firstDescendant:function(t){for(t=$(t).firstChild;t&&1!=t.nodeType;)t=t.nextSibling;return $(t)},immediateDescendants:function(t){for(var e=[],n=$(t).firstChild;n;)1===n.nodeType&&e.push(Element.extend(n)),n=n.nextSibling;return e},previousSiblings:function(t,e){return Element.recursivelyCollect(t,"previousSibling")},nextSiblings:function(t){return Element.recursivelyCollect(t,"nextSibling")},siblings:function(t){return t=$(t),Element.previousSiblings(t).reverse().concat(Element.nextSiblings(t))},match:function(t,e){return t=$(t),Object.isString(e)?Prototype.Selector.match(t,e):e.match(t)},up:function(t,e,n){if(t=$(t),1==arguments.length)return $(t.parentNode);var r=Element.ancestors(t);return Object.isNumber(e)?r[e]:Prototype.Selector.find(r,e,n)},down:function(t,e,n){return t=$(t),1==arguments.length?Element.firstDescendant(t):Object.isNumber(e)?Element.descendants(t)[e]:Element.select(t,e)[n||0]},previous:function(t,e,n){return t=$(t),Object.isNumber(e)&&(n=e,e=!1),Object.isNumber(n)||(n=0),e?Prototype.Selector.find(t.previousSiblings(),e,n):t.recursivelyCollect("previousSibling",n+1)[n]},next:function(t,e,n){if(t=$(t),Object.isNumber(e)&&(n=e,e=!1),Object.isNumber(n)||(n=0),e)return Prototype.Selector.find(t.nextSiblings(),e,n);Object.isNumber(n)?n+1:1;return t.recursivelyCollect("nextSibling",n+1)[n]},select:function(t){t=$(t);var e=Array.prototype.slice.call(arguments,1).join(", ");return Prototype.Selector.select(e,t)},adjacent:function(t){t=$(t);var e=Array.prototype.slice.call(arguments,1).join(", ");return Prototype.Selector.select(e,t.parentNode).without(t)},identify:function(t){t=$(t);var e=Element.readAttribute(t,"id");if(e)return e;do e="anonymous_element_"+Element.idCounter++;while($(e));return Element.writeAttribute(t,"id",e),e},readAttribute:function(t,e){if(t=$(t),Prototype.Browser.IE){var n=Element._attributeTranslations.read;if(n.values[e])return n.values[e](t,e);if(n.names[e]&&(e=n.names[e]),e.include(":"))return t.attributes&&t.attributes[e]?t.attributes[e].value:null}return t.getAttribute(e)},writeAttribute:function(t,e,n){t=$(t);var r={},i=Element._attributeTranslations.write;"object"==typeof e?r=e:r[e]=Object.isUndefined(n)?!0:n;for(var o in r)e=i.names[o]||o,n=r[o],i.values[o]&&(e=i.values[o](t,n)),n===!1||null===n?t.removeAttribute(e):n===!0?t.setAttribute(e,e):t.setAttribute(e,n);return t},getHeight:function(t){return Element.getDimensions(t).height},getWidth:function(t){return Element.getDimensions(t).width},classNames:function(t){return new Element.ClassNames(t)},hasClassName:function(t,e){if(t=$(t)){var n=t.className;return n.length>0&&(n==e||new RegExp("(^|\\s)"+e+"(\\s|$)").test(n))}},addClassName:function(t,e){return(t=$(t))?(Element.hasClassName(t,e)||(t.className+=(t.className?" ":"")+e),t):void 0},removeClassName:function(t,e){return(t=$(t))?(t.className=t.className.replace(new RegExp("(^|\\s+)"+e+"(\\s+|$)")," ").strip(),t):void 0},toggleClassName:function(t,e){return(t=$(t))?Element[Element.hasClassName(t,e)?"removeClassName":"addClassName"](t,e):void 0},cleanWhitespace:function(t){t=$(t);for(var e=t.firstChild;e;){var n=e.nextSibling;3!=e.nodeType||/\S/.test(e.nodeValue)||t.removeChild(e),e=n}return t},empty:function(t){return $(t).innerHTML.blank()},descendantOf:function(t,e){if(t=$(t),e=$(e),t.compareDocumentPosition)return 8===(8&t.compareDocumentPosition(e));if(e.contains)return e.contains(t)&&e!==t;for(;t=t.parentNode;)if(t==e)return!0;return!1},scrollTo:function(t){t=$(t);var e=Element.cumulativeOffset(t);return window.scrollTo(e[0],e[1]),t},getStyle:function(t,e){t=$(t),e="float"==e?"cssFloat":e.camelize();var n=t.style[e];if(!n||"auto"==n){var r=document.defaultView.getComputedStyle(t,null);n=r?r[e]:null}return"opacity"==e?n?parseFloat(n):1:"auto"==n?null:n},getOpacity:function(t){return $(t).getStyle("opacity")},setStyle:function(t,e){t=$(t);var n=t.style;if(Object.isString(e))return t.style.cssText+=";"+e,e.include("opacity")?t.setOpacity(e.match(/opacity:\s*(\d?\.?\d*)/)[1]):t;for(var r in e)"opacity"==r?t.setOpacity(e[r]):n["float"==r||"cssFloat"==r?Object.isUndefined(n.styleFloat)?"cssFloat":"styleFloat":r]=e[r];return t},setOpacity:function(t,e){return t=$(t),t.style.opacity=1==e||""===e?"":1e-5>e?0:e,t},makePositioned:function(t){t=$(t);var e=Element.getStyle(t,"position");return"static"!=e&&e||(t._madePositioned=!0,t.style.position="relative",Prototype.Browser.Opera&&(t.style.top=0,t.style.left=0)),t},undoPositioned:function(t){return t=$(t),t._madePositioned&&(t._madePositioned=void 0,t.style.position=t.style.top=t.style.left=t.style.bottom=t.style.right=""),t},makeClipping:function(t){return t=$(t),t._overflow?t:(t._overflow=Element.getStyle(t,"overflow")||"auto","hidden"!==t._overflow&&(t.style.overflow="hidden"),t)},undoClipping:function(t){return t=$(t),t._overflow?(t.style.overflow="auto"==t._overflow?"":t._overflow,t._overflow=null,t):t},clonePosition:function(t,e){var n=Object.extend({setLeft:!0,setTop:!0,setWidth:!0,setHeight:!0,offsetTop:0,offsetLeft:0},arguments[2]||{});e=$(e);var r=Element.viewportOffset(e),i=[0,0],o=null;return t=$(t),"absolute"==Element.getStyle(t,"position")&&(o=Element.getOffsetParent(t),i=Element.viewportOffset(o)),o==document.body&&(i[0]-=document.body.offsetLeft,i[1]-=document.body.offsetTop),n.setLeft&&(t.style.left=r[0]-i[0]+n.offsetLeft+"px"),n.setTop&&(t.style.top=r[1]-i[1]+n.offsetTop+"px"),n.setWidth&&(t.style.width=e.offsetWidth+"px"),n.setHeight&&(t.style.height=e.offsetHeight+"px"),t}},Object.extend(Element.Methods,{getElementsBySelector:Element.Methods.select,childElements:Element.Methods.immediateDescendants}),Element._attributeTranslations={write:{names:{className:"class",htmlFor:"for"},values:{}}},Prototype.Browser.Opera?(Element.Methods.getStyle=Element.Methods.getStyle.wrap(function(t,e,n){switch(n){case"height":case"width":if(!Element.visible(e))return null;var r=parseInt(t(e,n),10);if(r!==e["offset"+n.capitalize()])return r+"px";var i;return i="height"===n?["border-top-width","padding-top","padding-bottom","border-bottom-width"]:["border-left-width","padding-left","padding-right","border-right-width"],i.inject(r,function(n,r){var i=t(e,r);return null===i?n:n-parseInt(i,10)})+"px";default:return t(e,n)}}),Element.Methods.readAttribute=Element.Methods.readAttribute.wrap(function(t,e,n){return"title"===n?e.title:t(e,n)})):Prototype.Browser.IE?(Element.Methods.getStyle=function(t,e){t=$(t),e="float"==e||"cssFloat"==e?"styleFloat":e.camelize();var n=t.style[e];return!n&&t.currentStyle&&(n=t.currentStyle[e]),"opacity"==e?(n=(t.getStyle("filter")||"").match(/alpha\(opacity=(.*)\)/))&&n[1]?parseFloat(n[1])/100:1:"auto"==n?"width"!=e&&"height"!=e||"none"==t.getStyle("display")?null:t["offset"+e.capitalize()]+"px":n},Element.Methods.setOpacity=function(t,e){function n(t){return t.replace(/alpha\([^\)]*\)/gi,"")}t=$(t);var r=t.currentStyle;(r&&!r.hasLayout||!r&&"normal"==t.style.zoom)&&(t.style.zoom=1);var i=t.getStyle("filter"),o=t.style;return 1==e||""===e?((i=n(i))?o.filter=i:o.removeAttribute("filter"),t):(1e-5>e&&(e=0),o.filter=n(i)+"alpha(opacity="+100*e+")",t)},Element._attributeTranslations=function(){var t="className",e="for",n=document.createElement("div");return n.setAttribute(t,"x"),"x"!==n.className&&(n.setAttribute("class","x"),"x"===n.className&&(t="class")),n=null,n=document.createElement("label"),n.setAttribute(e,"x"),"x"!==n.htmlFor&&(n.setAttribute("htmlFor","x"),"x"===n.htmlFor&&(e="htmlFor")),n=null,{read:{names:{"class":t,className:t,"for":e,htmlFor:e},values:{_getAttr:function(t,e){return t.getAttribute(e)},_getAttr2:function(t,e){return t.getAttribute(e,2)},_getAttrNode:function(t,e){var n=t.getAttributeNode(e);return n?n.value:""},_getEv:function(){var t,e=document.createElement("div");e.onclick=Prototype.emptyFunction;var n=e.getAttribute("onclick");return String(n).indexOf("{")>-1?t=function(t,e){return(e=t.getAttribute(e))?(e=e.toString(),e=e.split("{")[1],e=e.split("}")[0],e.strip()):null}:""===n&&(t=function(t,e){return e=t.getAttribute(e),e?e.strip():null}),e=null,t}(),_flag:function(t,e){return $(t).hasAttribute(e)?e:null},style:function(t){return t.style.cssText.toLowerCase()},title:function(t){return t.title}}}}}(),Element._attributeTranslations.write={names:Object.extend({cellpadding:"cellPadding",cellspacing:"cellSpacing"},Element._attributeTranslations.read.names),values:{checked:function(t,e){t.checked=!!e},style:function(t,e){t.style.cssText=e?e:""}}},Element._attributeTranslations.has={},$w("colSpan rowSpan vAlign dateTime accessKey tabIndex encType maxLength readOnly longDesc frameBorder").each(function(t){Element._attributeTranslations.write.names[t.toLowerCase()]=t,Element._attributeTranslations.has[t.toLowerCase()]=t}),function(t){Object.extend(t,{href:t._getAttr2,src:t._getAttr2,type:t._getAttr,action:t._getAttrNode,disabled:t._flag,checked:t._flag,readonly:t._flag,multiple:t._flag,onload:t._getEv,onunload:t._getEv,onclick:t._getEv,ondblclick:t._getEv,onmousedown:t._getEv,onmouseup:t._getEv,onmouseover:t._getEv,onmousemove:t._getEv,onmouseout:t._getEv,onfocus:t._getEv,onblur:t._getEv,onkeypress:t._getEv,onkeydown:t._getEv,onkeyup:t._getEv,onsubmit:t._getEv,onreset:t._getEv,onselect:t._getEv,onchange:t._getEv})}(Element._attributeTranslations.read.values),Prototype.BrowserFeatures.ElementExtensions&&!function(){function t(t){for(var e,n=t.getElementsByTagName("*"),r=[],i=0;e=n[i];i++)"!"!==e.tagName&&r.push(e);return r}Element.Methods.down=function(e,n,r){return e=$(e),1==arguments.length?e.firstDescendant():Object.isNumber(n)?t(e)[n]:Element.select(e,n)[r||0]}}()):Prototype.Browser.Gecko&&/rv:1\.8\.0/.test(navigator.userAgent)?Element.Methods.setOpacity=function(t,e){return t=$(t),t.style.opacity=1==e?.999999:""===e?"":1e-5>e?0:e,t}:Prototype.Browser.WebKit&&(Element.Methods.setOpacity=function(t,e){if(t=$(t),t.style.opacity=1==e||""===e?"":1e-5>e?0:e,1==e)if("IMG"==t.tagName.toUpperCase()&&t.width)t.width++,t.width--;else try{var n=document.createTextNode(" ");t.appendChild(n),t.removeChild(n)}catch(r){}return t}),"outerHTML"in document.documentElement&&(Element.Methods.replace=function(t,e){if(t=$(t),e&&e.toElement&&(e=e.toElement()),Object.isElement(e))return t.parentNode.replaceChild(e,t),t;e=Object.toHTML(e);var n=t.parentNode,r=n.tagName.toUpperCase();if(Element._insertionTranslations.tags[r]){var i=t.next(),o=Element._getContentFromAnonymousElement(r,e.stripScripts());n.removeChild(t),i?o.each(function(t){n.insertBefore(t,i)}):o.each(function(t){n.appendChild(t)})}else t.outerHTML=e.stripScripts();return e.evalScripts.bind(e).defer(),t}),Element._returnOffset=function(t,e){
var n=[t,e];return n.left=t,n.top=e,n},Element._getContentFromAnonymousElement=function(t,e,n){var r=new Element("div"),i=Element._insertionTranslations.tags[t],o=!1;if(i?o=!0:n&&(o=!0,i=["","",0]),o){r.innerHTML="&nbsp;"+i[0]+e+i[1],r.removeChild(r.firstChild);for(var s=i[2];s--;)r=r.firstChild}else r.innerHTML=e;return $A(r.childNodes)},Element._insertionTranslations={before:function(t,e){t.parentNode.insertBefore(e,t)},top:function(t,e){t.insertBefore(e,t.firstChild)},bottom:function(t,e){t.appendChild(e)},after:function(t,e){t.parentNode.insertBefore(e,t.nextSibling)},tags:{TABLE:["<table>","</table>",1],TBODY:["<table><tbody>","</tbody></table>",2],TR:["<table><tbody><tr>","</tr></tbody></table>",3],TD:["<table><tbody><tr><td>","</td></tr></tbody></table>",4],SELECT:["<select>","</select>",1]}},function(){var t=Element._insertionTranslations.tags;Object.extend(t,{THEAD:t.TBODY,TFOOT:t.TBODY,TH:t.TD})}(),Element.Methods.Simulated={hasAttribute:function(t,e){e=Element._attributeTranslations.has[e]||e;var n=$(t).getAttributeNode(e);return!(!n||!n.specified)}},Element.Methods.ByTag={},Object.extend(Element,Element.Methods),function(t){!Prototype.BrowserFeatures.ElementExtensions&&t.__proto__&&(window.HTMLElement={},window.HTMLElement.prototype=t.__proto__,Prototype.BrowserFeatures.ElementExtensions=!0),t=null}(document.createElement("div")),Element.extend=function(){function t(t){if("undefined"!=typeof window.Element){var e=window.Element.prototype;if(e){var n="_"+(Math.random()+"").slice(2),r=document.createElement(t);e[n]="x";var i="x"!==r[n];return delete e[n],r=null,i}}return!1}function e(t,e){for(var n in e){var r=e[n];!Object.isFunction(r)||n in t||(t[n]=r.methodize())}}var n=t("object");if(Prototype.BrowserFeatures.SpecificElementExtensions)return n?function(t){if(t&&"undefined"==typeof t._extendedByPrototype){var n=t.tagName;n&&/^(?:object|applet|embed)$/i.test(n)&&(e(t,Element.Methods),e(t,Element.Methods.Simulated),e(t,Element.Methods.ByTag[n.toUpperCase()]))}return t}:Prototype.K;var r={},i=Element.Methods.ByTag,o=Object.extend(function(t){if(!t||"undefined"!=typeof t._extendedByPrototype||1!=t.nodeType||t==window)return t;var n=Object.clone(r),o=t.tagName.toUpperCase();return i[o]&&Object.extend(n,i[o]),e(t,n),t._extendedByPrototype=Prototype.emptyFunction,t},{refresh:function(){Prototype.BrowserFeatures.ElementExtensions||(Object.extend(r,Element.Methods),Object.extend(r,Element.Methods.Simulated))}});return o.refresh(),o}(),document.documentElement.hasAttribute?Element.hasAttribute=function(t,e){return t.hasAttribute(e)}:Element.hasAttribute=Element.Methods.Simulated.hasAttribute,Element.addMethods=function(t){function e(e){e=e.toUpperCase(),Element.Methods.ByTag[e]||(Element.Methods.ByTag[e]={}),Object.extend(Element.Methods.ByTag[e],t)}function n(t,e,n){n=n||!1;for(var r in t){var i=t[r];Object.isFunction(i)&&(n&&r in e||(e[r]=i.methodize()))}}function r(t){var e,n={OPTGROUP:"OptGroup",TEXTAREA:"TextArea",P:"Paragraph",FIELDSET:"FieldSet",UL:"UList",OL:"OList",DL:"DList",DIR:"Directory",H1:"Heading",H2:"Heading",H3:"Heading",H4:"Heading",H5:"Heading",H6:"Heading",Q:"Quote",INS:"Mod",DEL:"Mod",A:"Anchor",IMG:"Image",CAPTION:"TableCaption",COL:"TableCol",COLGROUP:"TableCol",THEAD:"TableSection",TFOOT:"TableSection",TBODY:"TableSection",TR:"TableRow",TH:"TableCell",TD:"TableCell",FRAMESET:"FrameSet",IFRAME:"IFrame"};if(n[t]&&(e="HTML"+n[t]+"Element"),window[e])return window[e];if(e="HTML"+t+"Element",window[e])return window[e];if(e="HTML"+t.capitalize()+"Element",window[e])return window[e];var r=document.createElement(t),i=r.__proto__||r.constructor.prototype;return r=null,i}var i=Prototype.BrowserFeatures,o=Element.Methods.ByTag;if(t||(Object.extend(Form,Form.Methods),Object.extend(Form.Element,Form.Element.Methods),Object.extend(Element.Methods.ByTag,{FORM:Object.clone(Form.Methods),INPUT:Object.clone(Form.Element.Methods),SELECT:Object.clone(Form.Element.Methods),TEXTAREA:Object.clone(Form.Element.Methods),BUTTON:Object.clone(Form.Element.Methods)})),2==arguments.length){var s=t;t=arguments[1]}s?Object.isArray(s)?s.each(e):e(s):Object.extend(Element.Methods,t||{});var a=window.HTMLElement?HTMLElement.prototype:Element.prototype;if(i.ElementExtensions&&(n(Element.Methods,a),n(Element.Methods.Simulated,a,!0)),i.SpecificElementExtensions)for(var l in Element.Methods.ByTag){var c=r(l);Object.isUndefined(c)||n(o[l],c.prototype)}Object.extend(Element,Element.Methods),delete Element.ByTag,Element.extend.refresh&&Element.extend.refresh(),Element.cache={}},document.viewport={getDimensions:function(){return{width:this.getWidth(),height:this.getHeight()}},getScrollOffsets:function(){return Element._returnOffset(window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft,window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop)}},function(t){function e(){return i.WebKit&&!o.evaluate?document:i.Opera&&window.parseFloat(window.opera.version())<9.5?document.body:document.documentElement}function n(n){return r||(r=e()),s[n]="client"+n,t["get"+n]=function(){return r[s[n]]},t["get"+n]()}var r,i=Prototype.Browser,o=document,s={};t.getWidth=n.curry("Width"),t.getHeight=n.curry("Height")}(document.viewport),Element.Storage={UID:1},Element.addMethods({getStorage:function(t){if(t=$(t)){var e;return t===window?e=0:("undefined"==typeof t._prototypeUID&&(t._prototypeUID=Element.Storage.UID++),e=t._prototypeUID),Element.Storage[e]||(Element.Storage[e]=$H()),Element.Storage[e]}},store:function(t,e,n){return(t=$(t))?(2===arguments.length?Element.getStorage(t).update(e):Element.getStorage(t).set(e,n),t):void 0},retrieve:function(t,e,n){if(t=$(t)){var r=Element.getStorage(t),i=r.get(e);return Object.isUndefined(i)&&(r.set(e,n),i=n),i}},clone:function(t,e){if(t=$(t)){var n=t.cloneNode(e);if(n._prototypeUID=void 0,e)for(var r=Element.select(n,"*"),i=r.length;i--;)r[i]._prototypeUID=void 0;return Element.extend(n)}},purge:function(t){if(t=$(t)){var e=Element._purgeElement;e(t);for(var n=t.getElementsByTagName("*"),r=n.length;r--;)e(n[r]);return null}}}),function(){function t(t){var e=t.match(/^(\d+)%?$/i);return e?Number(e[1])/100:null}function e(e,n,r){var i=null;if(Object.isElement(e)&&(i=e,e=i.getStyle(n)),null===e)return null;if(/^(?:-)?\d+(\.\d+)?(px)?$/i.test(e))return window.parseFloat(e);var o=e.include("%"),s=r===document.viewport;if(/\d/.test(e)&&i&&i.runtimeStyle&&(!o||!s)){var a=i.style.left,l=i.runtimeStyle.left;return i.runtimeStyle.left=i.currentStyle.left,i.style.left=e||0,e=i.style.pixelLeft,i.style.left=a,i.runtimeStyle.left=l,e}if(i&&o){r=r||i.parentNode;var c=t(e),h=null,u=(i.getStyle("position"),n.include("left")||n.include("right")||n.include("width")),d=n.include("top")||n.include("bottom")||n.include("height");return r===document.viewport?u?h=document.viewport.getWidth():d&&(h=document.viewport.getHeight()):u?h=$(r).measure("width"):d&&(h=$(r).measure("height")),null===h?0:h*c}return 0}function n(t){for(;t&&t.parentNode;){var e=t.getStyle("display");if("none"===e)return!1;t=$(t.parentNode)}return!0}function r(t){return t.include("border")&&(t+="-width"),t.camelize()}function i(t,e){return new Element.Layout(t,e)}function o(t,e){return $(t).getLayout().get(e)}function s(t){t=$(t);var e=Element.getStyle(t,"display");if(e&&"none"!==e)return{width:t.offsetWidth,height:t.offsetHeight};var n=t.style,r={visibility:n.visibility,position:n.position,display:n.display},i={visibility:"hidden",display:"block"};"fixed"!==r.position&&(i.position="absolute"),Element.setStyle(t,i);var o={width:t.offsetWidth,height:t.offsetHeight};return Element.setStyle(t,r),o}function a(t){if(t=$(t),g(t)||b(t)||f(t)||m(t))return $(document.body);var e="inline"===Element.getStyle(t,"display");if(!e&&t.offsetParent)return $(t.offsetParent);for(;(t=t.parentNode)&&t!==document.body;)if("static"!==Element.getStyle(t,"position"))return $(m(t)?document.body:t);return $(document.body)}function l(t){t=$(t);var e=0,n=0;if(t.parentNode)do e+=t.offsetTop||0,n+=t.offsetLeft||0,t=t.offsetParent;while(t);return new Element.Offset(n,e)}function c(t){t=$(t);var e=t.getLayout(),n=0,r=0;do if(n+=t.offsetTop||0,r+=t.offsetLeft||0,t=t.offsetParent){if(f(t))break;var i=Element.getStyle(t,"position");if("static"!==i)break}while(t);return r-=e.get("margin-top"),n-=e.get("margin-left"),new Element.Offset(r,n)}function h(t){var e=0,n=0;do e+=t.scrollTop||0,n+=t.scrollLeft||0,t=t.parentNode;while(t);return new Element.Offset(n,e)}function u(t){i=$(i);var e=0,n=0,r=document.body,i=t;do if(e+=i.offsetTop||0,n+=i.offsetLeft||0,i.offsetParent==r&&"absolute"==Element.getStyle(i,"position"))break;while(i=i.offsetParent);i=t;do i!=r&&(e-=i.scrollTop||0,n-=i.scrollLeft||0);while(i=i.parentNode);return new Element.Offset(n,e)}function d(t){if(t=$(t),"absolute"===Element.getStyle(t,"position"))return t;var e=a(t),n=t.viewportOffset(),r=e.viewportOffset(),i=n.relativeTo(r),o=t.getLayout();return t.store("prototype_absolutize_original_styles",{left:t.getStyle("left"),top:t.getStyle("top"),width:t.getStyle("width"),height:t.getStyle("height")}),t.setStyle({position:"absolute",top:i.top+"px",left:i.left+"px",width:o.get("width")+"px",height:o.get("height")+"px"}),t}function p(t){if(t=$(t),"relative"===Element.getStyle(t,"position"))return t;var e=t.retrieve("prototype_absolutize_original_styles");return e&&t.setStyle(e),t}function f(t){return"BODY"===t.nodeName.toUpperCase()}function m(t){return"HTML"===t.nodeName.toUpperCase()}function g(t){return t.nodeType===Node.DOCUMENT_NODE}function b(t){return t!==document.body&&!Element.descendantOf(t,document.body)}var v=Prototype.K;"currentStyle"in document.documentElement&&(v=function(t){return t.currentStyle.hasLayout||(t.style.zoom=1),t}),Element.Layout=Class.create(Hash,{initialize:function(t,e,n){t(),this.element=$(e),Element.Layout.PROPERTIES.each(function(t){this._set(t,null)},this),n&&(this._preComputing=!0,this._begin(),Element.Layout.PROPERTIES.each(this._compute,this),this._end(),this._preComputing=!1)},_set:function(t,e){return Hash.prototype.set.call(this,t,e)},set:function(t,e){throw"Properties of Element.Layout are read-only."},get:function(t,e){var n=t(e);return null===n?this._compute(e):n},_begin:function(){if(!this._prepared){var t=this.element;if(n(t))return void(this._prepared=!0);var r={position:t.style.position||"",width:t.style.width||"",visibility:t.style.visibility||"",display:t.style.display||""};t.store("prototype_original_styles",r);var i=t.getStyle("position"),o=t.getStyle("width");("0px"===o||null===o)&&(t.style.display="block",o=t.getStyle("width"));var s="fixed"===i?document.viewport:t.parentNode;t.setStyle({position:"absolute",visibility:"hidden",display:"block"});var a,l=t.getStyle("width");if(o&&l===o)a=e(t,"width",s);else if("absolute"===i||"fixed"===i)a=e(t,"width",s);else{var c=t.parentNode,h=$(c).getLayout();a=h.get("width")-this.get("margin-left")-this.get("border-left")-this.get("padding-left")-this.get("padding-right")-this.get("border-right")-this.get("margin-right")}t.setStyle({width:a+"px"}),this._prepared=!0}},_end:function(){var t=this.element,e=t.retrieve("prototype_original_styles");t.store("prototype_original_styles",null),t.setStyle(e),this._prepared=!1},_compute:function(t){var e=Element.Layout.COMPUTATIONS;if(!(t in e))throw"Property not found.";return this._set(t,e[t].call(this,this.element))},toObject:function(){var t=$A(arguments),e=0===t.length?Element.Layout.PROPERTIES:t.join(" ").split(" "),n={};return e.each(function(t){if(Element.Layout.PROPERTIES.include(t)){var e=this.get(t);null!=e&&(n[t]=e)}},this),n},toHash:function(){var t=this.toObject.apply(this,arguments);return new Hash(t)},toCSS:function(){var t=$A(arguments),e=0===t.length?Element.Layout.PROPERTIES:t.join(" ").split(" "),n={};return e.each(function(t){if(Element.Layout.PROPERTIES.include(t)&&!Element.Layout.COMPOSITE_PROPERTIES.include(t)){var e=this.get(t);null!=e&&(n[r(t)]=e+"px")}},this),n},inspect:function(){return"#<Element.Layout>"}}),Object.extend(Element.Layout,{PROPERTIES:$w("height width top left right bottom border-left border-right border-top border-bottom padding-left padding-right padding-top padding-bottom margin-top margin-bottom margin-left margin-right padding-box-width padding-box-height border-box-width border-box-height margin-box-width margin-box-height"),COMPOSITE_PROPERTIES:$w("padding-box-width padding-box-height margin-box-width margin-box-height border-box-width border-box-height"),COMPUTATIONS:{height:function(t){this._preComputing||this._begin();var e=this.get("border-box-height");if(0>=e)return this._preComputing||this._end(),0;var n=this.get("border-top"),r=this.get("border-bottom"),i=this.get("padding-top"),o=this.get("padding-bottom");return this._preComputing||this._end(),e-n-r-i-o},width:function(t){this._preComputing||this._begin();var e=this.get("border-box-width");if(0>=e)return this._preComputing||this._end(),0;var n=this.get("border-left"),r=this.get("border-right"),i=this.get("padding-left"),o=this.get("padding-right");return this._preComputing||this._end(),e-n-r-i-o},"padding-box-height":function(t){var e=this.get("height"),n=this.get("padding-top"),r=this.get("padding-bottom");return e+n+r},"padding-box-width":function(t){var e=this.get("width"),n=this.get("padding-left"),r=this.get("padding-right");return e+n+r},"border-box-height":function(t){this._preComputing||this._begin();var e=t.offsetHeight;return this._preComputing||this._end(),e},"border-box-width":function(t){this._preComputing||this._begin();var e=t.offsetWidth;return this._preComputing||this._end(),e},"margin-box-height":function(t){var e=this.get("border-box-height"),n=this.get("margin-top"),r=this.get("margin-bottom");return 0>=e?0:e+n+r},"margin-box-width":function(t){var e=this.get("border-box-width"),n=this.get("margin-left"),r=this.get("margin-right");return 0>=e?0:e+n+r},top:function(t){var e=t.positionedOffset();return e.top},bottom:function(t){var e=t.positionedOffset(),n=t.getOffsetParent(),r=n.measure("height"),i=this.get("border-box-height");return r-i-e.top},left:function(t){var e=t.positionedOffset();return e.left},right:function(t){var e=t.positionedOffset(),n=t.getOffsetParent(),r=n.measure("width"),i=this.get("border-box-width");return r-i-e.left},"padding-top":function(t){return e(t,"paddingTop")},"padding-bottom":function(t){return e(t,"paddingBottom")},"padding-left":function(t){return e(t,"paddingLeft")},"padding-right":function(t){return e(t,"paddingRight")},"border-top":function(t){return e(t,"borderTopWidth")},"border-bottom":function(t){return e(t,"borderBottomWidth")},"border-left":function(t){return e(t,"borderLeftWidth")},"border-right":function(t){return e(t,"borderRightWidth")},"margin-top":function(t){return e(t,"marginTop")},"margin-bottom":function(t){return e(t,"marginBottom")},"margin-left":function(t){return e(t,"marginLeft")},"margin-right":function(t){return e(t,"marginRight")}}}),"getBoundingClientRect"in document.documentElement&&Object.extend(Element.Layout.COMPUTATIONS,{right:function(t){var e=v(t.getOffsetParent()),n=t.getBoundingClientRect(),r=e.getBoundingClientRect();return(r.right-n.right).round()},bottom:function(t){var e=v(t.getOffsetParent()),n=t.getBoundingClientRect(),r=e.getBoundingClientRect();return(r.bottom-n.bottom).round()}}),Element.Offset=Class.create({initialize:function(t,e){this.left=t.round(),this.top=e.round(),this[0]=this.left,this[1]=this.top},relativeTo:function(t){return new Element.Offset(this.left-t.left,this.top-t.top)},inspect:function(){return"#<Element.Offset left: #{left} top: #{top}>".interpolate(this)},toString:function(){return"[#{left}, #{top}]".interpolate(this)},toArray:function(){return[this.left,this.top]}}),Prototype.Browser.IE?(a=a.wrap(function(t,e){if(e=$(e),g(e)||b(e)||f(e)||m(e))return $(document.body);var n=e.getStyle("position");if("static"!==n)return t(e);e.setStyle({position:"relative"});var r=t(e);return e.setStyle({position:n}),r}),c=c.wrap(function(t,e){if(e=$(e),!e.parentNode)return new Element.Offset(0,0);var n=e.getStyle("position");if("static"!==n)return t(e);var r=e.getOffsetParent();r&&"fixed"===r.getStyle("position")&&v(r),e.setStyle({position:"relative"});var i=t(e);return e.setStyle({position:n}),i})):Prototype.Browser.Webkit&&(l=function(t){t=$(t);var e=0,n=0;do{if(e+=t.offsetTop||0,n+=t.offsetLeft||0,t.offsetParent==document.body&&"absolute"==Element.getStyle(t,"position"))break;t=t.offsetParent}while(t);return new Element.Offset(n,e)}),Element.addMethods({getLayout:i,measure:o,getDimensions:s,getOffsetParent:a,cumulativeOffset:l,positionedOffset:c,cumulativeScrollOffset:h,viewportOffset:u,absolutize:d,relativize:p}),"getBoundingClientRect"in document.documentElement&&Element.addMethods({viewportOffset:function(t){if(t=$(t),b(t))return new Element.Offset(0,0);var e=t.getBoundingClientRect(),n=document.documentElement;return new Element.Offset(e.left-n.clientLeft,e.top-n.clientTop)}})}(),window.$$=function(){var t=$A(arguments).join(", ");return Prototype.Selector.select(t,document)},Prototype.Selector=function(){function t(){throw new Error('Method "Prototype.Selector.select" must be defined.')}function e(){throw new Error('Method "Prototype.Selector.match" must be defined.')}function n(t,e,n){n=n||0;var r,i=Prototype.Selector.match,o=t.length,s=0;for(r=0;o>r;r++)if(i(t[r],e)&&n==s++)return Element.extend(t[r])}function r(t){for(var e=0,n=t.length;n>e;e++)Element.extend(t[e]);return t}var i=Prototype.K;return{select:t,match:e,find:n,extendElements:Element.extend===i?i:r,extendElement:Element.extend}}(),Prototype._original_property=window.Sizzle,function(){function t(t,e,n,r,i,o){for(var s="previousSibling"==t&&!o,a=0,l=r.length;l>a;a++){var c=r[a];if(c){s&&1===c.nodeType&&(c.sizcache=n,c.sizset=a),c=c[t];for(var h=!1;c;){if(c.sizcache===n){h=r[c.sizset];break}if(1!==c.nodeType||o||(c.sizcache=n,c.sizset=a),c.nodeName===e){h=c;break}c=c[t]}r[a]=h}}}function e(t,e,n,r,i,o){for(var s="previousSibling"==t&&!o,l=0,c=r.length;c>l;l++){var h=r[l];if(h){s&&1===h.nodeType&&(h.sizcache=n,h.sizset=l),h=h[t];for(var u=!1;h;){if(h.sizcache===n){u=r[h.sizset];break}if(1===h.nodeType)if(o||(h.sizcache=n,h.sizset=l),"string"!=typeof e){if(h===e){u=!0;break}}else if(a.filter(e,[h]).length>0){u=h;break}h=h[t]}r[l]=u}}}var n=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^[\]]*\]|['"][^'"]*['"]|[^[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g,r=0,i=Object.prototype.toString,o=!1,s=!0;[0,0].sort(function(){return s=!1,0});var a=function(t,e,r,o){r=r||[];var s=e=e||document;if(1!==e.nodeType&&9!==e.nodeType)return[];if(!t||"string"!=typeof t)return r;for(var h,d,p,b,v=[],y=!0,x=m(e),S=t;null!==(n.exec(""),h=n.exec(S));)if(S=h[3],v.push(h[1]),h[2]){b=h[3];break}if(v.length>1&&c.exec(t))if(2===v.length&&l.relative[v[0]])d=g(v[0]+v[1],e);else for(d=l.relative[v[0]]?[e]:a(v.shift(),e);v.length;)t=v.shift(),l.relative[t]&&(t+=v.shift()),d=g(t,d);else{if(!o&&v.length>1&&9===e.nodeType&&!x&&l.match.ID.test(v[0])&&!l.match.ID.test(v[v.length-1])){var w=a.find(v.shift(),e,x);e=w.expr?a.filter(w.expr,w.set)[0]:w.set[0]}if(e){var w=o?{expr:v.pop(),set:u(o)}:a.find(v.pop(),1!==v.length||"~"!==v[0]&&"+"!==v[0]||!e.parentNode?e:e.parentNode,x);for(d=w.expr?a.filter(w.expr,w.set):w.set,v.length>0?p=u(d):y=!1;v.length;){var E=v.pop(),B=E;l.relative[E]?B=v.pop():E="",null==B&&(B=e),l.relative[E](p,B,x)}}else p=v=[]}if(p||(p=d),!p)throw"Syntax error, unrecognized expression: "+(E||t);if("[object Array]"===i.call(p))if(y)if(e&&1===e.nodeType)for(var R=0;null!=p[R];R++)p[R]&&(p[R]===!0||1===p[R].nodeType&&f(e,p[R]))&&r.push(d[R]);else for(var R=0;null!=p[R];R++)p[R]&&1===p[R].nodeType&&r.push(d[R]);else r.push.apply(r,p);else u(p,r);return b&&(a(b,s,r,o),a.uniqueSort(r)),r};a.uniqueSort=function(t){if(p&&(o=s,t.sort(p),o))for(var e=1;e<t.length;e++)t[e]===t[e-1]&&t.splice(e--,1);return t},a.matches=function(t,e){return a(t,null,null,e)},a.find=function(t,e,n){var r,i;if(!t)return[];for(var o=0,s=l.order.length;s>o;o++){var i,a=l.order[o];if(i=l.leftMatch[a].exec(t)){var c=i[1];if(i.splice(1,1),"\\"!==c.substr(c.length-1)&&(i[1]=(i[1]||"").replace(/\\/g,""),r=l.find[a](i,e,n),null!=r)){t=t.replace(l.match[a],"");break}}}return r||(r=e.getElementsByTagName("*")),{set:r,expr:t}},a.filter=function(t,e,n,r){for(var i,o,s=t,a=[],c=e,h=e&&e[0]&&m(e[0]);t&&e.length;){for(var u in l.filter)if(null!=(i=l.match[u].exec(t))){var d,p,f=l.filter[u];if(o=!1,c==a&&(a=[]),l.preFilter[u])if(i=l.preFilter[u](i,c,n,a,r,h)){if(i===!0)continue}else o=d=!0;if(i)for(var g=0;null!=(p=c[g]);g++)if(p){d=f(p,i,g,c);var b=r^!!d;n&&null!=d?b?o=!0:c[g]=!1:b&&(a.push(p),o=!0)}if(void 0!==d){if(n||(c=a),t=t.replace(l.match[u],""),!o)return[];break}}if(t==s){if(null==o)throw"Syntax error, unrecognized expression: "+t;break}s=t}return c};var l=a.selectors={order:["ID","NAME","TAG"],match:{ID:/#((?:[\w\u00c0-\uFFFF-]|\\.)+)/,CLASS:/\.((?:[\w\u00c0-\uFFFF-]|\\.)+)/,NAME:/\[name=['"]*((?:[\w\u00c0-\uFFFF-]|\\.)+)['"]*\]/,ATTR:/\[\s*((?:[\w\u00c0-\uFFFF-]|\\.)+)\s*(?:(\S?=)\s*(['"]*)(.*?)\3|)\s*\]/,TAG:/^((?:[\w\u00c0-\uFFFF\*-]|\\.)+)/,CHILD:/:(only|nth|last|first)-child(?:\((even|odd|[\dn+-]*)\))?/,POS:/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^-]|$)/,PSEUDO:/:((?:[\w\u00c0-\uFFFF-]|\\.)+)(?:\((['"]*)((?:\([^\)]+\)|[^\2\(\)]*)+)\2\))?/},leftMatch:{},attrMap:{"class":"className","for":"htmlFor"},attrHandle:{href:function(t){return t.getAttribute("href")}},relative:{"+":function(t,e,n){var r="string"==typeof e,i=r&&!/\W/.test(e),o=r&&!i;i&&!n&&(e=e.toUpperCase());for(var s,l=0,c=t.length;c>l;l++)if(s=t[l]){for(;(s=s.previousSibling)&&1!==s.nodeType;);t[l]=o||s&&s.nodeName===e?s||!1:s===e}o&&a.filter(e,t,!0)},">":function(t,e,n){var r="string"==typeof e;if(r&&!/\W/.test(e)){e=n?e:e.toUpperCase();for(var i=0,o=t.length;o>i;i++){var s=t[i];if(s){var l=s.parentNode;t[i]=l.nodeName===e?l:!1}}}else{for(var i=0,o=t.length;o>i;i++){var s=t[i];s&&(t[i]=r?s.parentNode:s.parentNode===e)}r&&a.filter(e,t,!0)}},"":function(n,i,o){var s=r++,a=e;if(!/\W/.test(i)){var l=i=o?i:i.toUpperCase();a=t}a("parentNode",i,s,n,l,o)},"~":function(n,i,o){var s=r++,a=e;if("string"==typeof i&&!/\W/.test(i)){var l=i=o?i:i.toUpperCase();a=t}a("previousSibling",i,s,n,l,o)}},find:{ID:function(t,e,n){if("undefined"!=typeof e.getElementById&&!n){var r=e.getElementById(t[1]);return r?[r]:[]}},NAME:function(t,e,n){if("undefined"!=typeof e.getElementsByName){for(var r=[],i=e.getElementsByName(t[1]),o=0,s=i.length;s>o;o++)i[o].getAttribute("name")===t[1]&&r.push(i[o]);return 0===r.length?null:r}},TAG:function(t,e){return e.getElementsByTagName(t[1])}},preFilter:{CLASS:function(t,e,n,r,i,o){if(t=" "+t[1].replace(/\\/g,"")+" ",o)return t;for(var s,a=0;null!=(s=e[a]);a++)s&&(i^(s.className&&(" "+s.className+" ").indexOf(t)>=0)?n||r.push(s):n&&(e[a]=!1));return!1},ID:function(t){return t[1].replace(/\\/g,"")},TAG:function(t,e){for(var n=0;e[n]===!1;n++);return e[n]&&m(e[n])?t[1]:t[1].toUpperCase()},CHILD:function(t){if("nth"==t[1]){var e=/(-?)(\d*)n((?:\+|-)?\d*)/.exec("even"==t[2]&&"2n"||"odd"==t[2]&&"2n+1"||!/\D/.test(t[2])&&"0n+"+t[2]||t[2]);t[2]=e[1]+(e[2]||1)-0,t[3]=e[3]-0}return t[0]=r++,t},ATTR:function(t,e,n,r,i,o){var s=t[1].replace(/\\/g,"");return!o&&l.attrMap[s]&&(t[1]=l.attrMap[s]),"~="===t[2]&&(t[4]=" "+t[4]+" "),t},PSEUDO:function(t,e,r,i,o){if("not"===t[1]){if(!((n.exec(t[3])||"").length>1||/^\w/.test(t[3]))){var s=a.filter(t[3],e,r,!0^o);return r||i.push.apply(i,s),!1}t[3]=a(t[3],null,null,e)}else if(l.match.POS.test(t[0])||l.match.CHILD.test(t[0]))return!0;return t},POS:function(t){return t.unshift(!0),t}},filters:{enabled:function(t){return t.disabled===!1&&"hidden"!==t.type},disabled:function(t){return t.disabled===!0},checked:function(t){return t.checked===!0},selected:function(t){return t.parentNode.selectedIndex,t.selected===!0},parent:function(t){return!!t.firstChild},empty:function(t){return!t.firstChild},has:function(t,e,n){return!!a(n[3],t).length},header:function(t){return/h\d/i.test(t.nodeName)},text:function(t){return"text"===t.type},radio:function(t){return"radio"===t.type},checkbox:function(t){return"checkbox"===t.type},file:function(t){return"file"===t.type},password:function(t){return"password"===t.type},submit:function(t){return"submit"===t.type},image:function(t){return"image"===t.type},reset:function(t){return"reset"===t.type},button:function(t){return"button"===t.type||"BUTTON"===t.nodeName.toUpperCase()},input:function(t){return/input|select|textarea|button/i.test(t.nodeName)}},setFilters:{first:function(t,e){return 0===e},last:function(t,e,n,r){return e===r.length-1},even:function(t,e){return e%2===0},odd:function(t,e){return e%2===1},lt:function(t,e,n){return e<n[3]-0},gt:function(t,e,n){return e>n[3]-0},nth:function(t,e,n){return n[3]-0==e},eq:function(t,e,n){return n[3]-0==e}},filter:{PSEUDO:function(t,e,n,r){var i=e[1],o=l.filters[i];if(o)return o(t,n,e,r);if("contains"===i)return(t.textContent||t.innerText||"").indexOf(e[3])>=0;if("not"===i){for(var s=e[3],n=0,a=s.length;a>n;n++)if(s[n]===t)return!1;return!0}},CHILD:function(t,e){var n=e[1],r=t;switch(n){case"only":case"first":for(;r=r.previousSibling;)if(1===r.nodeType)return!1;if("first"==n)return!0;r=t;case"last":for(;r=r.nextSibling;)if(1===r.nodeType)return!1;return!0;case"nth":var i=e[2],o=e[3];if(1==i&&0==o)return!0;var s=e[0],a=t.parentNode;if(a&&(a.sizcache!==s||!t.nodeIndex)){var l=0;for(r=a.firstChild;r;r=r.nextSibling)1===r.nodeType&&(r.nodeIndex=++l);a.sizcache=s}var c=t.nodeIndex-o;return 0==i?0==c:c%i==0&&c/i>=0}},ID:function(t,e){return 1===t.nodeType&&t.getAttribute("id")===e},TAG:function(t,e){return"*"===e&&1===t.nodeType||t.nodeName===e},CLASS:function(t,e){return(" "+(t.className||t.getAttribute("class"))+" ").indexOf(e)>-1},ATTR:function(t,e){var n=e[1],r=l.attrHandle[n]?l.attrHandle[n](t):null!=t[n]?t[n]:t.getAttribute(n),i=r+"",o=e[2],s=e[4];return null==r?"!="===o:"="===o?i===s:"*="===o?i.indexOf(s)>=0:"~="===o?(" "+i+" ").indexOf(s)>=0:s?"!="===o?i!=s:"^="===o?0===i.indexOf(s):"$="===o?i.substr(i.length-s.length)===s:"|="===o?i===s||i.substr(0,s.length+1)===s+"-":!1:i&&r!==!1},POS:function(t,e,n,r){var i=e[2],o=l.setFilters[i];return o?o(t,n,e,r):void 0}}},c=l.match.POS;for(var h in l.match)l.match[h]=new RegExp(l.match[h].source+/(?![^\[]*\])(?![^\(]*\))/.source),l.leftMatch[h]=new RegExp(/(^(?:.|\r|\n)*?)/.source+l.match[h].source);var u=function(t,e){return t=Array.prototype.slice.call(t,0),e?(e.push.apply(e,t),e):t};try{Array.prototype.slice.call(document.documentElement.childNodes,0)}catch(d){u=function(t,e){var n=e||[];if("[object Array]"===i.call(t))Array.prototype.push.apply(n,t);else if("number"==typeof t.length)for(var r=0,o=t.length;o>r;r++)n.push(t[r]);else for(var r=0;t[r];r++)n.push(t[r]);return n}}var p;document.documentElement.compareDocumentPosition?p=function(t,e){if(!t.compareDocumentPosition||!e.compareDocumentPosition)return t==e&&(o=!0),0;var n=4&t.compareDocumentPosition(e)?-1:t===e?0:1;return 0===n&&(o=!0),n}:"sourceIndex"in document.documentElement?p=function(t,e){if(!t.sourceIndex||!e.sourceIndex)return t==e&&(o=!0),0;var n=t.sourceIndex-e.sourceIndex;return 0===n&&(o=!0),n}:document.createRange&&(p=function(t,e){if(!t.ownerDocument||!e.ownerDocument)return t==e&&(o=!0),0;var n=t.ownerDocument.createRange(),r=e.ownerDocument.createRange();n.setStart(t,0),n.setEnd(t,0),r.setStart(e,0),r.setEnd(e,0);var i=n.compareBoundaryPoints(Range.START_TO_END,r);return 0===i&&(o=!0),i}),function(){var t=document.createElement("div"),e="script"+(new Date).getTime();t.innerHTML="<a name='"+e+"'/>";var n=document.documentElement;n.insertBefore(t,n.firstChild),document.getElementById(e)&&(l.find.ID=function(t,e,n){if("undefined"!=typeof e.getElementById&&!n){var r=e.getElementById(t[1]);return r?r.id===t[1]||"undefined"!=typeof r.getAttributeNode&&r.getAttributeNode("id").nodeValue===t[1]?[r]:void 0:[]}},l.filter.ID=function(t,e){var n="undefined"!=typeof t.getAttributeNode&&t.getAttributeNode("id");return 1===t.nodeType&&n&&n.nodeValue===e}),n.removeChild(t),n=t=null}(),function(){var t=document.createElement("div");t.appendChild(document.createComment("")),t.getElementsByTagName("*").length>0&&(l.find.TAG=function(t,e){var n=e.getElementsByTagName(t[1]);if("*"===t[1]){for(var r=[],i=0;n[i];i++)1===n[i].nodeType&&r.push(n[i]);n=r}return n}),t.innerHTML="<a href='#'></a>",t.firstChild&&"undefined"!=typeof t.firstChild.getAttribute&&"#"!==t.firstChild.getAttribute("href")&&(l.attrHandle.href=function(t){return t.getAttribute("href",2)}),t=null}(),document.querySelectorAll&&!function(){var t=a,e=document.createElement("div");if(e.innerHTML="<p class='TEST'></p>",!e.querySelectorAll||0!==e.querySelectorAll(".TEST").length){a=function(e,n,r,i){if(n=n||document,!i&&9===n.nodeType&&!m(n))try{return u(n.querySelectorAll(e),r)}catch(o){}return t(e,n,r,i)};for(var n in t)a[n]=t[n];e=null}}(),document.getElementsByClassName&&document.documentElement.getElementsByClassName&&!function(){var t=document.createElement("div");t.innerHTML="<div class='test e'></div><div class='test'></div>",0!==t.getElementsByClassName("e").length&&(t.lastChild.className="e",1!==t.getElementsByClassName("e").length&&(l.order.splice(1,0,"CLASS"),l.find.CLASS=function(t,e,n){return"undefined"==typeof e.getElementsByClassName||n?void 0:e.getElementsByClassName(t[1])},t=null))}();var f=document.compareDocumentPosition?function(t,e){return 16&t.compareDocumentPosition(e)}:function(t,e){return t!==e&&(t.contains?t.contains(e):!0)},m=function(t){return 9===t.nodeType&&"HTML"!==t.documentElement.nodeName||!!t.ownerDocument&&"HTML"!==t.ownerDocument.documentElement.nodeName},g=function(t,e){for(var n,r=[],i="",o=e.nodeType?[e]:e;n=l.match.PSEUDO.exec(t);)i+=n[0],t=t.replace(l.match.PSEUDO,"");t=l.relative[t]?t+"*":t;for(var s=0,c=o.length;c>s;s++)a(t,o[s],r);return a.filter(i,r)};window.Sizzle=a}(),function(t){function e(e,n){return r(t(e,n||document))}function n(e,n){return 1==t.matches(n,[e]).length}var r=Prototype.Selector.extendElements;Prototype.Selector.engine=t,Prototype.Selector.select=e,Prototype.Selector.match=n}(Sizzle),window.Sizzle=Prototype._original_property,delete Prototype._original_property;var Form={reset:function(t){return t=$(t),t.reset(),t},serializeElements:function(t,e){"object"!=typeof e?e={hash:!!e}:Object.isUndefined(e.hash)&&(e.hash=!0);var n,r,i,o,s=!1,a=e.submit;return e.hash?(o={},i=function(t,e,n){return e in t?(Object.isArray(t[e])||(t[e]=[t[e]]),t[e].push(n)):t[e]=n,t}):(o="",i=function(t,e,n){return t+(t?"&":"")+encodeURIComponent(e)+"="+encodeURIComponent(n)}),t.inject(o,function(t,e){return!e.disabled&&e.name&&(n=e.name,r=$(e).getValue(),null==r||"file"==e.type||"submit"==e.type&&(s||a===!1||a&&n!=a||!(s=!0))||(t=i(t,n,r))),t})}};Form.Methods={serialize:function(t,e){return Form.serializeElements(Form.getElements(t),e)},getElements:function(t){for(var e,n=$(t).getElementsByTagName("*"),r=[],i=Form.Element.Serializers,o=0;e=n[o];o++)r.push(e);return r.inject([],function(t,e){return i[e.tagName.toLowerCase()]&&t.push(Element.extend(e)),t})},getInputs:function(t,e,n){t=$(t);var r=t.getElementsByTagName("input");if(!e&&!n)return $A(r).map(Element.extend);for(var i=0,o=[],s=r.length;s>i;i++){var a=r[i];e&&a.type!=e||n&&a.name!=n||o.push(Element.extend(a))}return o},disable:function(t){return t=$(t),Form.getElements(t).invoke("disable"),t},enable:function(t){return t=$(t),Form.getElements(t).invoke("enable"),t},findFirstElement:function(t){var e=$(t).getElements().findAll(function(t){return"hidden"!=t.type&&!t.disabled}),n=e.findAll(function(t){return t.hasAttribute("tabIndex")&&t.tabIndex>=0}).sortBy(function(t){return t.tabIndex}).first();return n?n:e.find(function(t){return/^(?:input|select|textarea)$/i.test(t.tagName)})},focusFirstElement:function(t){t=$(t);var e=t.findFirstElement();return e&&e.activate(),t},request:function(t,e){t=$(t),e=Object.clone(e||{});var n=e.parameters,r=t.readAttribute("action")||"";
return r.blank()&&(r=window.location.href),e.parameters=t.serialize(!0),n&&(Object.isString(n)&&(n=n.toQueryParams()),Object.extend(e.parameters,n)),t.hasAttribute("method")&&!e.method&&(e.method=t.method),new Ajax.Request(r,e)}},Form.Element={focus:function(t){return $(t).focus(),t},select:function(t){return $(t).select(),t}},Form.Element.Methods={serialize:function(t){if(t=$(t),!t.disabled&&t.name){var e=t.getValue();if(void 0!=e){var n={};return n[t.name]=e,Object.toQueryString(n)}}return""},getValue:function(t){t=$(t);var e=t.tagName.toLowerCase();return Form.Element.Serializers[e](t)},setValue:function(t,e){t=$(t);var n=t.tagName.toLowerCase();return Form.Element.Serializers[n](t,e),t},clear:function(t){return $(t).value="",t},present:function(t){return""!=$(t).value},activate:function(t){t=$(t);try{t.focus(),!t.select||"input"==t.tagName.toLowerCase()&&/^(?:button|reset|submit)$/i.test(t.type)||t.select()}catch(e){}return t},disable:function(t){return t=$(t),t.disabled=!0,t},enable:function(t){return t=$(t),t.disabled=!1,t}};var Field=Form.Element,$F=Form.Element.Methods.getValue;Form.Element.Serializers=function(){function t(t,r){switch(t.type.toLowerCase()){case"checkbox":case"radio":return e(t,r);default:return n(t,r)}}function e(t,e){return Object.isUndefined(e)?t.checked?t.value:null:void(t.checked=!!e)}function n(t,e){return Object.isUndefined(e)?t.value:void(t.value=e)}function r(t,e){if(Object.isUndefined(e))return("select-one"===t.type?i:o)(t);for(var n,r,s=!Object.isArray(e),a=0,l=t.length;l>a;a++)if(n=t.options[a],r=this.optionValue(n),s){if(r==e)return void(n.selected=!0)}else n.selected=e.include(r)}function i(t){var e=t.selectedIndex;return e>=0?s(t.options[e]):null}function o(t){var e,n=t.length;if(!n)return null;for(var r=0,e=[];n>r;r++){var i=t.options[r];i.selected&&e.push(s(i))}return e}function s(t){return Element.hasAttribute(t,"value")?t.value:t.text}return{input:t,inputSelector:e,textarea:n,select:r,selectOne:i,selectMany:o,optionValue:s,button:n}}(),Abstract.TimedObserver=Class.create(PeriodicalExecuter,{initialize:function(t,e,n,r){t(r,n),this.element=$(e),this.lastValue=this.getValue()},execute:function(){var t=this.getValue();(Object.isString(this.lastValue)&&Object.isString(t)?this.lastValue!=t:String(this.lastValue)!=String(t))&&(this.callback(this.element,t),this.lastValue=t)}}),Form.Element.Observer=Class.create(Abstract.TimedObserver,{getValue:function(){return Form.Element.getValue(this.element)}}),Form.Observer=Class.create(Abstract.TimedObserver,{getValue:function(){return Form.serialize(this.element)}}),Abstract.EventObserver=Class.create({initialize:function(t,e){this.element=$(t),this.callback=e,this.lastValue=this.getValue(),"form"==this.element.tagName.toLowerCase()?this.registerFormCallbacks():this.registerCallback(this.element)},onElementEvent:function(){var t=this.getValue();this.lastValue!=t&&(this.callback(this.element,t),this.lastValue=t)},registerFormCallbacks:function(){Form.getElements(this.element).each(this.registerCallback,this)},registerCallback:function(t){if(t.type)switch(t.type.toLowerCase()){case"checkbox":case"radio":Event.observe(t,"click",this.onElementEvent.bind(this));break;default:Event.observe(t,"change",this.onElementEvent.bind(this))}}}),Form.Element.EventObserver=Class.create(Abstract.EventObserver,{getValue:function(){return Form.Element.getValue(this.element)}}),Form.EventObserver=Class.create(Abstract.EventObserver,{getValue:function(){return Form.serialize(this.element)}}),function(){function t(t,e){return t.which?t.which===e+1:t.button===e}function e(t,e){return t.button===B[e]}function n(t,e){switch(e){case 0:return 1==t.which&&!t.metaKey;case 1:return 2==t.which||1==t.which&&t.metaKey;case 2:return 3==t.which;default:return!1}}function r(t){return E(t,0)}function i(t){return E(t,1)}function o(t){return E(t,2)}function s(t){t=y.extend(t);var e=t.target,n=t.type,r=t.currentTarget;return r&&r.tagName&&("load"===n||"error"===n||"click"===n&&"input"===r.tagName.toLowerCase()&&"radio"===r.type)&&(e=r),e.nodeType==Node.TEXT_NODE&&(e=e.parentNode),Element.extend(e)}function a(t,e){var n=y.element(t);if(!e)return n;for(;n;){if(Object.isElement(n)&&Prototype.Selector.match(n,e))return Element.extend(n);n=n.parentNode}}function l(t){return{x:c(t),y:h(t)}}function c(t){var e=document.documentElement,n=document.body||{scrollLeft:0};return t.pageX||t.clientX+(e.scrollLeft||n.scrollLeft)-(e.clientLeft||0)}function h(t){var e=document.documentElement,n=document.body||{scrollTop:0};return t.pageY||t.clientY+(e.scrollTop||n.scrollTop)-(e.clientTop||0)}function u(t){y.extend(t),t.preventDefault(),t.stopPropagation(),t.stopped=!0}function d(t){var e;switch(t.type){case"mouseover":case"mouseenter":e=t.fromElement;break;case"mouseout":case"mouseleave":e=t.toElement;break;default:return null}return Element.extend(e)}function p(t,e,n){var r=Element.retrieve(t,"prototype_event_registry");Object.isUndefined(r)&&(A.push(t),r=Element.retrieve(t,"prototype_event_registry",$H()));var i=r.get(e);if(Object.isUndefined(i)&&(i=[],r.set(e,i)),i.pluck("handler").include(n))return!1;var o;return e.include(":")?o=function(r){return Object.isUndefined(r.eventName)?!1:r.eventName!==e?!1:(y.extend(r,t),void n.call(t,r))}:S||"mouseenter"!==e&&"mouseleave"!==e?o=function(e){y.extend(e,t),n.call(t,e)}:("mouseenter"===e||"mouseleave"===e)&&(o=function(e){y.extend(e,t);for(var r=e.relatedTarget;r&&r!==t;)try{r=r.parentNode}catch(i){r=t}r!==t&&n.call(t,e)}),o.handler=n,i.push(o),o}function f(){for(var t=0,e=A.length;e>t;t++)y.stopObserving(A[t]),A[t]=null}function m(t,e,n){t=$(t);var r=p(t,e,n);if(!r)return t;if(e.include(":"))t.addEventListener?t.addEventListener("dataavailable",r,!1):(t.attachEvent("ondataavailable",r),t.attachEvent("onlosecapture",r));else{var i=_(e);t.addEventListener?t.addEventListener(i,r,!1):t.attachEvent("on"+i,r)}return t}function g(t,e,n){t=$(t);var r=Element.retrieve(t,"prototype_event_registry");if(!r)return t;if(!e)return r.each(function(e){var n=e.key;g(t,n)}),t;var i=r.get(e);if(!i)return t;if(!n)return i.each(function(n){g(t,e,n.handler)}),t;for(var o,s=i.length;s--;)if(i[s].handler===n){o=i[s];break}if(!o)return t;if(e.include(":"))t.removeEventListener?t.removeEventListener("dataavailable",o,!1):(t.detachEvent("ondataavailable",o),t.detachEvent("onlosecapture",o));else{var a=_(e);t.removeEventListener?t.removeEventListener(a,o,!1):t.detachEvent("on"+a,o)}return r.set(e,i.without(o)),t}function b(t,e,n,r){t=$(t),Object.isUndefined(r)&&(r=!0),t==document&&document.createEvent&&!t.dispatchEvent&&(t=document.documentElement);var i;return document.createEvent?(i=document.createEvent("HTMLEvents"),i.initEvent("dataavailable",r,!0)):(i=document.createEventObject(),i.eventType=r?"ondataavailable":"onlosecapture"),i.eventName=e,i.memo=n||{},document.createEvent?t.dispatchEvent(i):t.fireEvent(i.eventType,i),y.extend(i)}function v(t,e,n,r){return t=$(t),Object.isFunction(n)&&Object.isUndefined(r)&&(r=n,n=null),new y.Handler(t,e,n,r).start()}var y={KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ESC:27,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_DELETE:46,KEY_HOME:36,KEY_END:35,KEY_PAGEUP:33,KEY_PAGEDOWN:34,KEY_INSERT:45,cache:{}},x=document.documentElement,S="onmouseenter"in x&&"onmouseleave"in x,w=function(t){return!1};window.attachEvent&&(w=window.addEventListener?function(t){return!(t instanceof window.Event)}:function(t){return!0});var E,B={0:1,1:4,2:2};E=window.attachEvent?window.addEventListener?function(n,r){return w(n)?e(n,r):t(n,r)}:e:Prototype.Browser.WebKit?n:t,y.Methods={isLeftClick:r,isMiddleClick:i,isRightClick:o,element:s,findElement:a,pointer:l,pointerX:c,pointerY:h,stop:u};var R=Object.keys(y.Methods).inject({},function(t,e){return t[e]=y.Methods[e].methodize(),t});if(window.attachEvent){var C={stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.returnValue=!1},inspect:function(){return"[object Event]"}};y.extend=function(t,e){if(!t)return!1;if(!w(t))return t;if(t._extendedByPrototype)return t;t._extendedByPrototype=Prototype.emptyFunction;var n=y.pointer(t);return Object.extend(t,{target:t.srcElement||e,relatedTarget:d(t),pageX:n.x,pageY:n.y}),Object.extend(t,R),Object.extend(t,C),t}}else y.extend=Prototype.K;window.addEventListener&&(y.prototype=window.Event.prototype||document.createEvent("HTMLEvents").__proto__,Object.extend(y.prototype,R));var A=[];Prototype.Browser.IE&&window.attachEvent("onunload",f),Prototype.Browser.WebKit&&window.addEventListener("unload",Prototype.emptyFunction,!1);var _=Prototype.K,O={mouseenter:"mouseover",mouseleave:"mouseout"};S||(_=function(t){return O[t]||t}),y.Handler=Class.create({initialize:function(t,e,n,r){this.element=$(t),this.eventName=e,this.selector=n,this.callback=r,this.handler=this.handleEvent.bind(this)},start:function(){return y.observe(this.element,this.eventName,this.handler),this},stop:function(){return y.stopObserving(this.element,this.eventName,this.handler),this},handleEvent:function(t){var e=y.findElement(t,this.selector);e&&this.callback.call(this.element,t,e)}}),Object.extend(y,y.Methods),Object.extend(y,{fire:b,observe:m,stopObserving:g,on:v}),Element.addMethods({fire:b,observe:m,stopObserving:g,on:v}),Object.extend(document,{fire:b.methodize(),observe:m.methodize(),stopObserving:g.methodize(),on:v.methodize(),loaded:!1}),window.Event?Object.extend(window.Event,y):window.Event=y}(),function(){function t(){document.loaded||(r&&window.clearTimeout(r),document.loaded=!0,document.fire("dom:loaded"))}function e(){"complete"===document.readyState&&(document.stopObserving("readystatechange",e),t())}function n(){try{document.documentElement.doScroll("left")}catch(e){return void(r=n.defer())}t()}var r;document.addEventListener?document.addEventListener("DOMContentLoaded",t,!1):(document.observe("readystatechange",e),window==top&&(r=n.defer())),Event.observe(window,"load",t)}(),Element.addMethods(),Hash.toQueryString=Object.toQueryString;var Toggle={display:Element.toggle};Element.Methods.childOf=Element.Methods.descendantOf;var Insertion={Before:function(t,e){return Element.insert(t,{before:e})},Top:function(t,e){return Element.insert(t,{top:e})},Bottom:function(t,e){return Element.insert(t,{bottom:e})},After:function(t,e){return Element.insert(t,{after:e})}},$continue=new Error('"throw $continue" is deprecated, use "return" instead'),Position={includeScrollOffsets:!1,prepare:function(){this.deltaX=window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft||0,this.deltaY=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0},within:function(t,e,n){return this.includeScrollOffsets?this.withinIncludingScrolloffsets(t,e,n):(this.xcomp=e,this.ycomp=n,this.offset=Element.cumulativeOffset(t),n>=this.offset[1]&&n<this.offset[1]+t.offsetHeight&&e>=this.offset[0]&&e<this.offset[0]+t.offsetWidth)},withinIncludingScrolloffsets:function(t,e,n){var r=Element.cumulativeScrollOffset(t);return this.xcomp=e+r[0]-this.deltaX,this.ycomp=n+r[1]-this.deltaY,this.offset=Element.cumulativeOffset(t),this.ycomp>=this.offset[1]&&this.ycomp<this.offset[1]+t.offsetHeight&&this.xcomp>=this.offset[0]&&this.xcomp<this.offset[0]+t.offsetWidth},overlap:function(t,e){return t?"vertical"==t?(this.offset[1]+e.offsetHeight-this.ycomp)/e.offsetHeight:"horizontal"==t?(this.offset[0]+e.offsetWidth-this.xcomp)/e.offsetWidth:void 0:0},cumulativeOffset:Element.Methods.cumulativeOffset,positionedOffset:Element.Methods.positionedOffset,absolutize:function(t){return Position.prepare(),Element.absolutize(t)},relativize:function(t){return Position.prepare(),Element.relativize(t)},realOffset:Element.Methods.cumulativeScrollOffset,offsetParent:Element.Methods.getOffsetParent,page:Element.Methods.viewportOffset,clone:function(t,e,n){return n=n||{},Element.clonePosition(e,t,n)}};if(document.getElementsByClassName||(document.getElementsByClassName=function(t){function e(t){return t.blank()?null:"[contains(concat(' ', @class, ' '), ' "+t+" ')]"}return t.getElementsByClassName=Prototype.BrowserFeatures.XPath?function(t,n){n=n.toString().strip();var r=/\s/.test(n)?$w(n).map(e).join(""):e(n);return r?document._getElementsByXPath(".//*"+r,t):[]}:function(t,e){e=e.toString().strip();var n=[],r=/\s/.test(e)?$w(e):null;if(!r&&!e)return n;var i=$(t).getElementsByTagName("*");e=" "+e+" ";for(var o,s,a=0;o=i[a];a++)o.className&&(s=" "+o.className+" ")&&(s.include(e)||r&&r.all(function(t){return!t.toString().blank()&&s.include(" "+t+" ")}))&&n.push(Element.extend(o));return n},function(t,e){return $(e||document.body).getElementsByClassName(t)}}(Element.Methods)),Element.ClassNames=Class.create(),Element.ClassNames.prototype={initialize:function(t){this.element=$(t)},_each:function(t){this.element.className.split(/\s+/).select(function(t){return t.length>0})._each(t)},set:function(t){this.element.className=t},add:function(t){this.include(t)||this.set($A(this).concat(t).join(" "))},remove:function(t){this.include(t)&&this.set($A(this).without(t).join(" "))},toString:function(){return $A(this).join(" ")}},Object.extend(Element.ClassNames.prototype,Enumerable),function(){window.Selector=Class.create({initialize:function(t){this.expression=t.strip()},findElements:function(t){return Prototype.Selector.select(this.expression,t)},match:function(t){return Prototype.Selector.match(t,this.expression)},toString:function(){return this.expression},inspect:function(){return"#<Selector: "+this.expression+">"}}),Object.extend(Selector,{matchElements:function(t,e){for(var n=Prototype.Selector.match,r=[],i=0,o=t.length;o>i;i++){var s=t[i];n(s,e)&&r.push(Element.extend(s))}return r},findElement:function(t,e,n){n=n||0;for(var r,i=0,o=0,s=t.length;s>o;o++)if(r=t[o],Prototype.Selector.match(r,e)&&n===i++)return Element.extend(r)},findChildElements:function(t,e){var n=e.toArray().join(", ");return Prototype.Selector.select(n,t||document)}})}(),!window.chem||!chem.Struct)throw new Error("Molecule should be defined first");if(chem.Dfs=function(t,e,n,r){this.molecule=t,this.atom_data=e,this.components=n,this.nComponentsInReactants=-1,this.nReactants=r,this.vertices=new Array(this.molecule.atoms.count()),this.molecule.atoms.each(function(t){this.vertices[t]=new chem.Dfs.VertexDesc},this),this.edges=new Array(this.molecule.bonds.count()),this.molecule.bonds.each(function(t){this.edges[t]=new chem.Dfs.EdgeDesc},this),this.v_seq=new Array},chem.Dfs.VertexDesc=function(){this.dfs_state=0,this.parent_vertex=0,this.parent_edge=0,this.branches=0},chem.Dfs.EdgeDesc=function(){this.opening_cycles=0,this.closing_cycle=0},chem.Dfs.SeqElem=function(t,e,n){this.idx=t,this.parent_vertex=e,this.parent_edge=n},chem.Dfs.prototype.walk=function(){for(var t,e,n=new Array,r=0,i=0;;){if(n.length<1){for(var o=-1,s=function(t){return 0==this.vertices[t].dfs_state?(o=t,!0):!1};r<this.components.length&&-1==o;)o=util.Set.find(this.components[r],s,this),null===o&&(o=-1,r++,r==this.nReactants&&(this.nComponentsInReactants=i));if(-1>o&&this.molecule.atoms.find(s,this),-1==o)break;this.vertices[o].parent_vertex=-1,this.vertices[o].parent_edge=-1,n.push(o),i++}var a=n.pop(),l=this.vertices[a].parent_vertex,c=new chem.Dfs.SeqElem(a,l,this.vertices[a].parent_edge);this.v_seq.push(c),this.vertices[a].dfs_state=2;var h=this.atom_data[a];for(t=0;t<h.neighbours.length;t++){var u=h.neighbours[t].aid,d=h.neighbours[t].bid;if(u!=l)if(2==this.vertices[u].dfs_state){for(this.edges[d].closing_cycle=1,e=a;-1!=e&&this.vertices[e].parent_vertex!=u;)e=this.vertices[e].parent_vertex;if(-1==e)throw new Error("cycle unwind error");this.edges[this.vertices[e].parent_edge].opening_cycles++,this.vertices[a].branches++,c=new chem.Dfs.SeqElem(u,a,d),this.v_seq.push(c)}else{if(1==this.vertices[u].dfs_state){if(e=n.indexOf(u),-1==e)throw new Error("internal: removing vertex from stack");n.splice(e,1);var p=this.vertices[u].parent_vertex;p>=0&&this.vertices[p].branches--}this.vertices[a].branches++,this.vertices[u].parent_vertex=a,this.vertices[u].parent_edge=d,this.vertices[u].dfs_state=1,n.push(u)}}}},chem.Dfs.prototype.edgeClosingCycle=function(t){return 0!=this.edges[t].closing_cycle},chem.Dfs.prototype.numBranches=function(t){return this.vertices[t].branches},chem.Dfs.prototype.numOpeningCycles=function(t){return this.edges[t].opening_cycles},chem.Dfs.prototype.toString=function(){var t="";return this.v_seq.each(function(e){t+=e.idx+" -> "}),t+="*"},!window.chem||!chem.Struct)throw new Error("Vec2 and Molecule should be defined first");if(chem.SmilesSaver=function(){this.smiles="",this._written_atoms=new Array,this._written_components=0,this.ignore_errors=!1},chem.SmilesSaver._Atom=function(t){this.neighbours=new Array,this.aromatic=!1,this.lowercase=!1,this.chirality=0,this.branch_cnt=0,this.paren_written=!1,this.h_count=t,this.parent=-1},chem.SmilesSaver.prototype.isBondInRing=function(t){if(util.isUndefined(this.inLoop)||util.isNull(this.inLoop))throw new Error("Init this.inLoop prior to calling this method");return this.inLoop[t]},chem.SmilesSaver.prototype.saveMolecule=function(t,e){var n,r,i;Object.isUndefined(e)||(this.ignore_errors=e),t=t.clone(),t.sgroups.each(function(e,n){if("MUL"==n.type)try{n.prepareForSaving(t)}catch(r){throw{message:"Bad s-group ("+r.message+")"}}else if(!this.ignore_errors)throw new Error("SMILES data format doesn't support s-groups")},this),this.atoms=new Array(t.atoms.count()),t.atoms.each(function(t,e){this.atoms[t]=new chem.SmilesSaver._Atom(e.implicitH)},this);var o=["B","C","N","O","P","S","Se","As"];t.bonds.each(function(e,n){n.type==chem.Struct.BOND.TYPE.AROMATIC&&(this.atoms[n.begin].aromatic=!0,-1!=o.indexOf(t.atoms.get(n.begin).label)&&(this.atoms[n.begin].lowercase=!0),this.atoms[n.end].aromatic=!0,-1!=o.indexOf(t.atoms.get(n.end).label)&&(this.atoms[n.end].lowercase=!0)),this.atoms[n.begin].neighbours.push({aid:n.end,bid:e}),this.atoms[n.end].neighbours.push({aid:n.begin,bid:e})},this),this.inLoop=function(){t.prepareLoopStructure();var e=util.Set.empty();t.loops.each(function(n,r){r.hbs.length<=6&&util.Set.mergeIn(e,util.Set.fromList(util.map(r.hbs,function(e){return t.halfBonds.get(e).bid},this)))},this);var n={};return util.Set.each(e,function(t){n[t]=1},this),n}(),this._touched_cistransbonds=0,this._markCisTrans(t);var s=chem.MolfileSaver.getComponents(t),a=s.reactants.concat(s.products),l=new chem.Dfs(t,this.atoms,a,s.reactants.length);for(l.walk(),this.atoms.each(function(t){t.neighbours.clear()},this),n=0;n<l.v_seq.length;n++){var c=l.v_seq[n],h=c.idx,u=c.parent_edge,d=c.parent_vertex;if(u>=0){var p=this.atoms[h],f=l.numOpeningCycles(u);for(r=0;f>r;r++)this.atoms[d].neighbours.push({aid:-1,bid:-1});if(l.edgeClosingCycle(u)){for(i=0;i<p.neighbours.length;i++)if(-1==p.neighbours[i].aid){p.neighbours[i].aid=d,p.neighbours[i].bid=u;break}if(i==p.neighbours.length)throw new Error("internal: can not put closing bond to its place")}else p.neighbours.push({aid:d,bid:u}),p.parent=d;this.atoms[d].neighbours.push({aid:h,bid:u})}}try{var m=new chem.Stereocenters(t,function(t){return this.atoms[t].neighbours},this);m.buildFromBonds(this.ignore_errors),m.each(function(t,e){var n=-1;-1==e.pyramid[3]&&(n=3);var o=new Array(4),s=0,a=this.atoms[t];if(-1!=a.parent)for(i=0;4>i;i++)if(e.pyramid[i]==a.parent){o[s++]=i;break}for(-1!=n&&(o[s++]=n),r=0;r!=a.neighbours.length;r++)if(a.neighbours[r].aid!=a.parent)for(i=0;4>i;i++)if(a.neighbours[r].aid==e.pyramid[i]){if(s>=4)throw new Error("internal: pyramid overflow");o[s++]=i;break}if(4==s)s=o[0],o[0]=o[1],o[1]=o[2],o[2]=o[3],o[3]=s;else if(3!=s)throw new Error("cannot calculate chirality");chem.Stereocenters.isPyramidMappingRigid(o)?this.atoms[t].chirality=1:this.atoms[t].chirality=2},this)}catch(g){alert("Warning: "+g.message)}var b=new Array;b.push(0);var v=!0;for(n=0;n<l.v_seq.length;n++){c=l.v_seq[n],h=c.idx,u=c.parent_edge,d=c.parent_vertex;var y=!0;if(d>=0){for(l.numBranches(d)>1&&this.atoms[d].branch_cnt>0&&this.atoms[d].paren_written&&(this.smiles+=")"),f=l.numOpeningCycles(u),r=0;f>r;r++){for(i=1;i<b.length&&-1!=b[i];i++);i==b.length?b.push(d):b[i]=d,this._writeCycleNumber(i)}if(d>=0){var x=l.numBranches(d);if(x>1&&this.atoms[d].branch_cnt<x-1&&(l.edgeClosingCycle(u)?this.atoms[d].paren_written=!1:(this.smiles+="(",this.atoms[d].paren_written=!0)),this.atoms[d].branch_cnt++,this.atoms[d].branch_cnt>x)throw new Error("unexpected branch")}var S=t.bonds.get(u),w=!0,E=0;if(S.type==chem.Struct.BOND.TYPE.SINGLE&&(E=this._calcBondDirection(t,u,d)),1==E&&h==S.end||2==E&&h==S.begin?this.smiles+="/":2==E&&h==S.end||1==E&&h==S.begin?this.smiles+="\\":S.type==chem.Struct.BOND.TYPE.ANY?this.smiles+="~":S.type==chem.Struct.BOND.TYPE.DOUBLE?this.smiles+="=":S.type==chem.Struct.BOND.TYPE.TRIPLE?this.smiles+="#":S.type!=chem.Struct.BOND.TYPE.AROMATIC||this.atoms[S.begin].lowercase&&this.atoms[S.end].lowercase&&this.isBondInRing(u)?S.type==chem.Struct.BOND.TYPE.SINGLE&&this.atoms[S.begin].aromatic&&this.atoms[S.end].aromatic?this.smiles+="-":w=!1:this.smiles+=":",l.edgeClosingCycle(u)){for(r=1;r<b.length&&b[r]!=h;r++);if(r==b.length)throw new Error("cycle number not found");this._writeCycleNumber(r),b[r]=-1,y=!1}}else v||(this.smiles+=this._written_components==l.nComponentsInReactants?">>":"."),v=!1,this._written_components++;y&&(this._writeAtom(t,h,this.atoms[h].aromatic,this.atoms[h].lowercase,this.atoms[h].chirality),this._written_atoms.push(c.idx))}return this.comma=!1,this._writeRadicals(t),this.comma&&(this.smiles+="|"),this.smiles},chem.SmilesSaver.prototype._writeCycleNumber=function(t){if(t>0&&10>t)this.smiles+=t;else if(t>=10&&100>t)this.smiles+="%"+t;else{if(!(t>=100&&1e3>t))throw new Error("bad cycle number: "+t);this.smiles+="%%"+t}},chem.SmilesSaver.prototype._writeAtom=function(t,e,n,r,i){var o=t.atoms.get(e),s=!1,a=-1,l=0;if("A"==o.label)return void(this.smiles+="*");if("R"==o.label||"R#"==o.label)return void(this.smiles+="[*]");l=o.aam,"C"!=o.label&&"P"!=o.label&&"N"!=o.label&&"S"!=o.label&&"O"!=o.label&&"Cl"!=o.label&&"F"!=o.label&&"Br"!=o.label&&"B"!=o.label&&"I"!=o.label&&(s=!0),(o.explicitValence>=0||0!=o.radical||i>0||n&&"C"!=o.label&&"O"!=o.label||n&&"C"==o.label&&this.atoms[e].neighbours.length<3&&0==this.atoms[e].h_count)&&(a=this.atoms[e].h_count);var c=o.label;if(o.atomList&&!o.atomList.notList?(c=o.atomList.label(),s=!1):o.isPseudo()||o.atomList&&o.atomList.notList?(c="*",s=!0):(i||0!=o.charge||o.isotope>0||a>=0||l>0)&&(s=!0),s&&(-1==a&&(a=this.atoms[e].h_count),this.smiles+="["),o.isotope>0&&(this.smiles+=o.isotope),r?this.smiles+=c.toLowerCase():this.smiles+=c,i>0&&(1==i?this.smiles+="@":this.smiles+="@@",o.implicitH>1))throw new Error(o.implicitH+" implicit H near stereocenter");"H"!=o.label&&(a>1||0==a&&!s?this.smiles+="H"+a:1==a&&(this.smiles+="H")),o.charge>1?this.smiles+="+"+o.charge:o.charge<-1?this.smiles+=o.charge:1==o.charge?this.smiles+="+":-1==o.charge&&(this.smiles+="-"),l>0&&(this.smiles+=":"+l),s&&(this.smiles+="]")},chem.SmilesSaver.prototype._markCisTrans=function(t){this.cis_trans=new chem.CisTrans(t,function(t){return this.atoms[t].neighbours},this),this.cis_trans.build(),this._dbonds=new Array(t.bonds.count()),t.bonds.each(function(t){this._dbonds[t]={ctbond_beg:-1,ctbond_end:-1,saved:0}},this),this.cis_trans.each(function(e,n){var r=t.bonds.get(e);if(0!=n.parity&&!this.isBondInRing(e)){var i=this.atoms[r.begin].neighbours,o=this.atoms[r.end].neighbours,s=!0,a=!0;if(i.each(function(n){n.bid!=e&&t.bonds.get(n.bid).type==chem.Struct.BOND.TYPE.SINGLE&&(s=!1)},this),o.each(function(n){n.bid!=e&&t.bonds.get(n.bid).type==chem.Struct.BOND.TYPE.SINGLE&&(a=!1)},this),s||a)return;i.each(function(n){n.bid!=e&&(t.bonds.get(n.bid).begin==r.begin?this._dbonds[n.bid].ctbond_beg=e:this._dbonds[n.bid].ctbond_end=e)},this),o.each(function(n){n.bid!=e&&(t.bonds.get(n.bid).begin==r.end?this._dbonds[n.bid].ctbond_beg=e:this._dbonds[n.bid].ctbond_end=e)},this)}},this)},chem.SmilesSaver.prototype._updateSideBonds=function(t,e){var n=t.bonds.get(e),r=this.cis_trans.getSubstituents(e),i=this.cis_trans.getParity(e),o=[-1,-1,-1,-1];o[0]=t.findBondId(r[0],n.begin),-1!=r[1]&&(o[1]=t.findBondId(r[1],n.begin)),o[2]=t.findBondId(r[2],n.end),-1!=r[3]&&(o[3]=t.findBondId(r[3],n.end));var s=0,a=0,l=0,c=0;if(0!=this._dbonds[o[0]].saved&&(1==this._dbonds[o[0]].saved&&t.bonds.get(o[0]).begin==n.begin||2==this._dbonds[o[0]].saved&&t.bonds.get(o[0]).end==n.begin?s++:a++),-1!=o[1]&&0!=this._dbonds[o[1]].saved&&(2==this._dbonds[o[1]].saved&&t.bonds.get(o[1]).begin==n.begin||1==this._dbonds[o[1]].saved&&t.bonds.get(o[1]).end==n.begin?s++:a++),0!=this._dbonds[o[2]].saved&&(1==this._dbonds[o[2]].saved&&t.bonds.get(o[2]).begin==n.end||2==this._dbonds[o[2]].saved&&t.bonds.get(o[2]).end==n.end?l++:c++),-1!=o[3]&&0!=this._dbonds[o[3]].saved&&(2==this._dbonds[o[3]].saved&&t.bonds.get(o[3]).begin==n.end||1==this._dbonds[o[3]].saved&&t.bonds.get(o[3]).end==n.end?l++:c++),i==chem.CisTrans.PARITY.CIS?(s+=l,a+=c):(s+=c,a+=l),s>0&&a>0)throw new Error("incompatible cis-trans configuration");return 0==s&&0==a?!1:(s>0&&(this._dbonds[o[0]].saved=t.bonds.get(o[0]).begin==n.begin?1:2,-1!=o[1]&&(this._dbonds[o[1]].saved=t.bonds.get(o[1]).begin==n.begin?2:1),this._dbonds[o[2]].saved=t.bonds.get(o[2]).begin==n.end==(i==chem.CisTrans.PARITY.CIS)?1:2,-1!=o[3]&&(this._dbonds[o[3]].saved=t.bonds.get(o[3]).begin==n.end==(i==chem.CisTrans.PARITY.CIS)?2:1)),a>0&&(this._dbonds[o[0]].saved=t.bonds.get(o[0]).begin==n.begin?2:1,-1!=o[1]&&(this._dbonds[o[1]].saved=t.bonds.get(o[1]).begin==n.begin?1:2),this._dbonds[o[2]].saved=t.bonds.get(o[2]).begin==n.end==(i==chem.CisTrans.PARITY.CIS)?2:1,-1!=o[3]&&(this._dbonds[o[3]].saved=t.bonds.get(o[3]).begin==n.end==(i==chem.CisTrans.PARITY.CIS)?1:2)),!0)},chem.SmilesSaver.prototype._calcBondDirection=function(t,e,n){var r;if(-1==this._dbonds[e].ctbond_beg&&-1==this._dbonds[e].ctbond_end)return 0;if(t.bonds.get(e).type!=chem.Struct.BOND.TYPE.SINGLE)throw new Error("internal: directed bond type "+t.bonds.get(e).type);for(;;){if(r=0,this.cis_trans.each(function(e,n){0==n.parity||this.isBondInRing(e)||this._updateSideBonds(t,e)&&r++},this),r==this._touched_cistransbonds)break;this._touched_cistransbonds=r}return 0==this._dbonds[e].saved&&(n==t.bonds.get(e).begin?this._dbonds[e].saved=1:this._dbonds[e].saved=2),this._dbonds[e].saved},chem.SmilesSaver.prototype._writeRadicals=function(t){var e,n,r=new Array(this._written_atoms.length);for(e=0;e<this._written_atoms.size();e++)if(!r[e]){var i=t.atoms.get(this._written_atoms[e]).radical;if(0!=i)for(this.comma?this.smiles+=",":(this.smiles+=" |",this.comma=!0),i==chem.Struct.ATOM.RADICAL.SINGLET?this.smiles+="^3:":i==chem.Struct.ATOM.RADICAL.DOUPLET?this.smiles+="^1:":this.smiles+="^4:",this.smiles+=e,n=e+1;n<this._written_atoms.length;n++)t.atoms.get(this._written_atoms[n]).radical==i&&(r[n]=!0,this.smiles+=","+n)}},!window.chem||!util.Vec2||!chem.Struct)throw new Error("Vec2 and Molecule, should be defined first");if(window.rnd||(rnd={}),rnd.Visel=function(t){this.type=t,this.paths=[],this.boxes=[],this.boundingBox=null},rnd.Visel.TYPE={ATOM:1,BOND:2,LOOP:3,ARROW:4,PLUS:5,SGROUP:6,TMP:7,FRAGMENT:8,RGROUP:9,CHIRAL_FLAG:10},rnd.Visel.prototype.add=function(t,e,n){this.paths.push(t),e&&(this.boxes.push(e),this.boundingBox=null==this.boundingBox?e:util.Box2Abs.union(this.boundingBox,e)),n&&this.exts.push(n)},rnd.Visel.prototype.clear=function(){this.paths=[],this.boxes=[],this.exts=[],this.boundingBox=null},rnd.Visel.prototype.translate=function(t,e){if(1===arguments.length)e=t.y,t=t.x;else if(2!==arguments.length)throw new Error("One vector or two scalar arguments expected");for(var n=0;n<this.paths.length;++n)this.paths[n].translateAbs(t,e);for(var r=new util.Vec2(t,e),i=0;i<this.boxes.length;++i)this.boxes[i]=this.boxes[i].translate(r);null!==this.boundingBox&&(this.boundingBox=this.boundingBox.translate(r))},!(window.chem&&util.Vec2&&chem.Struct&&window.rnd&&rnd.Visel))throw new Error("Vec2, Molecule and Visel should be defined first");if(window.rnd||(rnd={}),Raphael.el.translateAbs=function(t,e){this.delta=this.delta||new util.Vec2,this.delta.x+=t-0,this.delta.y+=e-0,this.transform("t"+this.delta.x.toString()+","+this.delta.y.toString())},Raphael.st.translateAbs=function(t,e){this.forEach(function(n){n.translateAbs(t,e)})},rnd.ReObject=function(){this.__ext=new util.Vec2(.05*3,.05*3)},rnd.ReObject.prototype.init=function(t){this.visel=new rnd.Visel(t),this.highlight=!1,this.highlighting=null,this.selected=!1,this.selectionPlate=null},rnd.ReObject.prototype.getVBoxObj=function(t){var e=this.visel.boundingBox;return util.isNull(e)?null:(t.offset&&(e=e.translate(t.offset.negated())),e.transform(t.scaled2obj,t))},rnd.ReObject.prototype.drawHighlight=function(t){},rnd.ReObject.prototype.setHighlight=function(t,e){if(t){var n="highlighting"in this&&null!=this.highlighting;n&&(n="set"==this.highlighting.type?!this.highlighting[0].removed:!this.highlighting.removed),n=n&&(!("hiddenPaths"in rnd.ReStruct.prototype)||rnd.ReStruct.prototype.hiddenPaths.indexOf(this.highlighting)<0),n?this.highlighting.show():(e.paper.setStart(),this.drawHighlight(e),this.highlighting=e.paper.setFinish())}else this.highlighting&&this.highlighting.hide();this.highlight=t},rnd.ReObject.prototype.makeSelectionPlate=function(t){},rnd.ReAtom=function(t){this.init(rnd.Visel.TYPE.ATOM),this.a=t,this.showLabel=!1,this.hydrogenOnTheLeft=!1,this.component=-1},rnd.ReAtom.prototype=new rnd.ReObject,rnd.ReAtom.isSelectable=function(){return!0},rnd.ReAtom.prototype.getVBoxObj=function(t){return this.visel.boundingBox?rnd.ReObject.prototype.getVBoxObj.call(this,t):new util.Box2Abs(this.a.pp,this.a.pp)},rnd.ReAtom.prototype.drawHighlight=function(t){var e=this.makeHighlightPlate(t);return t.ctab.addReObjectPath("highlighting",this.visel,e),e},rnd.ReAtom.prototype.makeHighlightPlate=function(t){var e=t.paper,n=t.styles,r=t.ps(this.a.pp);return e.circle(r.x,r.y,n.atomSelectionPlateRadius).attr(n.highlightStyle)},rnd.ReAtom.prototype.makeSelectionPlate=function(t,e,n){var r=t.render.ps(this.a.pp);return e.circle(r.x,r.y,n.atomSelectionPlateRadius).attr(n.selectionStyle)},rnd.ReBond=function(t){this.init(rnd.Visel.TYPE.BOND),this.b=t,this.doubleBondShift=0},rnd.ReBond.prototype=new rnd.ReObject,rnd.ReBond.isSelectable=function(){return!0},rnd.ReBond.prototype.drawHighlight=function(t){var e=this.makeHighlightPlate(t);return t.ctab.addReObjectPath("highlighting",this.visel,e),e},rnd.ReBond.prototype.makeHighlightPlate=function(t){t.ctab.bondRecalc(t.settings,this);var e=t.ps(this.b.center);return t.paper.circle(e.x,e.y,.8*t.styles.atomSelectionPlateRadius).attr(t.styles.highlightStyle)},rnd.ReBond.prototype.makeSelectionPlate=function(t,e,n){t.bondRecalc(t.render.settings,this);var r=t.render.ps(this.b.center);return e.circle(r.x,r.y,.8*n.atomSelectionPlateRadius).attr(n.selectionStyle)},rnd.ReStruct=function(t,e,n){this.render=e,this.atoms=new util.Map,this.bonds=new util.Map,this.reloops=new util.Map,this.rxnPluses=new util.Map,this.rxnArrows=new util.Map,this.frags=new util.Map,this.rgroups=new util.Map,this.sgroups=new util.Map,this.sgroupData=new util.Map,this.chiralFlags=new util.Map,this.molecule=t||new chem.Struct,this.initialized=!1,this.layers=[],this.initLayers(),this.connectedComponents=new util.Pool,this.ccFragmentType=new util.Map;for(var r in rnd.ReStruct.maps)this[r+"Changed"]={};if(this.structChanged=!1,t.atoms.each(function(t,e){this.atoms.set(t,new rnd.ReAtom(e))},this),t.bonds.each(function(t,e){this.bonds.set(t,new rnd.ReBond(e))},this),t.loops.each(function(t,e){this.reloops.set(t,new rnd.ReLoop(e))},this),t.rxnPluses.each(function(t,e){this.rxnPluses.set(t,new rnd.ReRxnPlus(e))},this),t.rxnArrows.each(function(t,e){this.rxnArrows.set(t,new rnd.ReRxnArrow(e))},this),t.frags.each(function(t,e){this.frags.set(t,new rnd.ReFrag(e))},this),t.rgroups.each(function(t,e){this.rgroups.set(t,new rnd.ReRGroup(e))},this),t.sgroups.each(function(t,e){this.sgroups.set(t,new rnd.ReSGroup(e)),"DAT"!=e.type||e.data.attached||this.sgroupData.set(t,new rnd.ReDataSGroupData(e));
},this),t.isChiral){var i=t.getCoordBoundingBox();this.chiralFlags.set(0,new rnd.ReChiralFlag(new util.Vec2(i.max.x,i.min.y-1)))}this.coordProcess(n)},rnd.ReStruct.prototype.connectedComponentRemoveAtom=function(t,e){if(e=e||this.atoms.get(t),!(e.component<0)){var n=this.connectedComponents.get(e.component);util.Set.remove(n,t),util.Set.size(n)<1&&this.connectedComponents.remove(e.component),e.component=-1}},rnd.ReStruct.prototype.printConnectedComponents=function(){var t=[];this.connectedComponents.each(function(e,n){t.push(" "+e+":["+util.Set.list(n).toString()+"]."+util.Set.size(n).toString())},this)},rnd.ReStruct.prototype.clearConnectedComponents=function(){this.connectedComponents.clear(),this.atoms.each(function(t,e){e.component=-1})},rnd.ReStruct.prototype.getConnectedComponent=function(t,e){for(var n="number"==typeof t.length?util.array(t):[t],r=util.Set.empty();n.length>0;)(function(){var t=n.pop();util.Set.add(r,t);var i=this.atoms.get(t);i.component>=0&&util.Set.add(e,i.component);for(var o=0;o<i.a.neighbors.length;++o){var s=this.molecule.halfBonds.get(i.a.neighbors[o]).end;util.Set.contains(r,s)||n.push(s)}}).apply(this);return r},rnd.ReStruct.prototype.addConnectedComponent=function(t){var e=this.connectedComponents.add(t),n=util.Set.empty(),r=this.getConnectedComponent(util.Set.list(t),n);util.Set.remove(n,e);var i=-1;return util.Set.each(r,function(t){var n=this.atoms.get(t);if(n.component=e,-1!=n.a.rxnFragmentType){if(-1!=i&&n.a.rxnFragmentType!=i)throw new Error("reaction fragment type mismatch");i=n.a.rxnFragmentType}},this),this.ccFragmentType.set(e,i),e},rnd.ReStruct.prototype.removeConnectedComponent=function(t){return util.Set.each(this.connectedComponents.get(t),function(t){this.atoms.get(t).component=-1},this),this.connectedComponents.remove(t)},rnd.ReStruct.prototype.connectedComponentMergeIn=function(t,e){util.Set.each(e,function(e){this.atoms.get(e).component=t},this),util.Set.mergeIn(this.connectedComponents.get(t),e)},rnd.ReStruct.prototype.assignConnectedComponents=function(){this.atoms.each(function(t,e){if(!(e.component>=0)){var n=util.Set.empty(),r=this.getConnectedComponent(t,n);util.Set.each(n,function(t){this.removeConnectedComponent(t)},this),this.addConnectedComponent(r)}},this)},rnd.ReStruct.prototype.connectedComponentGetBoundingBox=function(t,e,n){return e=e||this.connectedComponents.get(t),n=n||{min:null,max:null},util.Set.each(e,function(t){var e=this.render.ps(this.atoms.get(t).a.pp);null==n.min?n.min=n.max=e:(n.min=n.min.min(e),n.max=n.max.max(e))},this),n},rnd.ReStruct.prototype.initLayers=function(){for(var t in rnd.ReStruct.layerMap)this.layers[rnd.ReStruct.layerMap[t]]=this.render.paper.rect(0,0,10,10).attr({fill:"#000",opacity:"0.0"}).toFront()},rnd.ReStruct.prototype.insertInLayer=function(t,e){e.insertBefore(this.layers[t])},rnd.ReStruct.prototype.clearMarks=function(){for(var t in rnd.ReStruct.maps)this[t+"Changed"]={};this.structChanged=!1},rnd.ReStruct.prototype.markItemRemoved=function(){this.structChanged=!0},rnd.ReStruct.prototype.markBond=function(t,e){this.markItem("bonds",t,e)},rnd.ReStruct.prototype.markAtom=function(t,e){this.markItem("atoms",t,e)},rnd.ReStruct.prototype.markItem=function(t,e,n){var r=this[t+"Changed"];r[e]="undefined"!=typeof r[e]?Math.max(n,r[e]):n,this[t].has(e)&&this.clearVisel(this[t].get(e).visel)},rnd.ReStruct.prototype.eachVisel=function(t,e){for(var n in rnd.ReStruct.maps)this[n].each(function(n,r){t.call(e,r.visel)},this)},rnd.ReStruct.prototype.getVBoxObj=function(t){if(t=t||{},this.selectionIsEmpty(t))for(var e in rnd.ReStruct.maps)t[e]=this[e].keys();var n=null;for(var e in rnd.ReStruct.maps)t[e]&&util.each(t[e],function(t){var r=this[e].get(t).getVBoxObj(this.render);r&&(n=n?util.Box2Abs.union(n,r):r.clone())},this);return n=n||new util.Box2Abs(0,0,0,0)},rnd.ReStruct.prototype.selectionIsEmpty=function(t){if(util.assert(!util.isUndefined(t),"'selection' is not defined"),util.isNull(t))return!0;for(var e in rnd.ReStruct.maps)if(t[e]&&t[e].length>0)return!1;return!0},rnd.ReStruct.prototype.translate=function(t){this.eachVisel(function(e){e.translate(t)},this)},rnd.ReStruct.prototype.scale=function(t){this.eachVisel(function(e){this.scaleVisel(e,t)},this)},rnd.ReStruct.prototype.scaleRPath=function(t,e){if("set"==t.type)for(var n=0;n<t.length;++n)this.scaleRPath(t[n],e);else Object.isUndefined(t.attrs)||("font-size"in t.attrs?t.attr("font-size",t.attrs["font-size"]*e):"stroke-width"in t.attrs&&t.attr("stroke-width",t.attrs["stroke-width"]*e)),t.scale(e,e,0,0)},rnd.ReStruct.prototype.scaleVisel=function(t,e){for(var n=0;n<t.paths.length;++n)this.scaleRPath(t.paths[n],e)},rnd.ReStruct.prototype.clearVisels=function(){this.eachVisel(function(t){this.clearVisel(t)},this)},rnd.ReStruct.prototype.findIncomingStereoUpBond=function(t,e,n){return util.find(t.neighbors,function(t){var r=this.molecule.halfBonds.get(t),i=r.bid;if(i===e)return!1;var o=this.bonds.get(i);return o.b.type===chem.Struct.BOND.TYPE.SINGLE&&o.b.stereo===chem.Struct.BOND.STEREO.UP?o.b.end===r.begin||o.boldStereo&&n:o.b.type===chem.Struct.BOND.TYPE.DOUBLE&&o.b.stereo===chem.Struct.BOND.STEREO.NONE&&n&&o.boldStereo?!0:!1},this)},rnd.ReStruct.prototype.checkStereoBold=function(t,e){var n=util.map([e.b.begin,e.b.end],function(e){var n=this.molecule.atoms.get(e),r=this.findIncomingStereoUpBond(n,t,!1);return 0>r?-1:n.neighbors[r]},this);util.assert(2===n.length),e.boldStereo=n[0]>=0&&n[1]>=0},rnd.ReStruct.prototype.findIncomingUpBonds=function(t,e){var n=util.map([e.b.begin,e.b.end],function(e){var n=this.molecule.atoms.get(e),r=this.findIncomingStereoUpBond(n,t,!0);return 0>r?-1:n.neighbors[r]},this);util.assert(2===n.length),e.neihbid1=this.atoms.get(e.b.begin).showLabel?-1:n[0],e.neihbid2=this.atoms.get(e.b.end).showLabel?-1:n[1]},rnd.ReStruct.prototype.checkStereoBoldBonds=function(){this.bonds.each(this.checkStereoBold,this)},rnd.ReStruct.prototype.update=function(t){t=t||!this.initialized;var e;t?function(){for(var t in rnd.ReStruct.maps){var e=this[t+"Changed"];this[t].each(function(t){e[t]=1},this)}}.call(this):function(){for(var t in rnd.ReStruct.maps){var n=this[t+"Changed"];for(e in n)this[t].has(e)||delete n[e]}}.call(this);for(e in this.atomsChanged)this.connectedComponentRemoveAtom(e);for(var n=this.frags.findAll(function(t,e){return!e.calcBBox(this.render,t)},this),r=0;r<n.length;++r){var i=n[r];this.clearVisel(this.frags.get(i).visel),this.frags.unset(i),this.molecule.frags.remove(i)}(function(){for(var t in rnd.ReStruct.maps){var n=this[t+"Changed"];for(e in n)this.clearVisel(this[t].get(e).visel),this.structChanged|=n[e]>0}}).call(this),this.sgroups.each(function(t,e){this.clearVisel(e.visel),e.highlighting=null,e.selectionPlate=null},this),this.frags.each(function(t,e){this.clearVisel(e.visel)},this),this.rgroups.each(function(t,e){this.clearVisel(e.visel)},this),t&&(this.clearConnectedComponents(),this.molecule.initHalfBonds(),this.molecule.initNeighbors()),this.molecule.updateHalfBonds(new util.Map(this.atomsChanged).findAll(function(t,e){return e>=0},this)),this.molecule.sortNeighbors(new util.Map(this.atomsChanged).findAll(function(t,e){return e>=1},this)),this.assignConnectedComponents(),this.setImplicitHydrogen(),this.setHydrogenPos(),this.initialized=!0,this.verifyLoops();var o=t||this.structChanged;return o&&this.updateLoops(),this.setDoubleBondShift(),this.checkLabelsToShow(),this.checkStereoBoldBonds(),this.showLabels(),this.showBonds(),o&&this.renderLoops(),this.drawReactionSymbols(),this.drawSGroups(),this.drawFragments(),this.drawRGroups(),this.chiralFlags.each(function(t,e){this.chiralFlagsChanged[t]>0&&e.draw(this.render)},this),this.clearMarks(),!0},rnd.ReStruct.prototype.drawReactionSymbols=function(){var t,e;for(e in this.rxnArrowsChanged)t=this.rxnArrows.get(e),this.drawReactionArrow(e,t);for(e in this.rxnPlusesChanged)t=this.rxnPluses.get(e),this.drawReactionPlus(e,t)},rnd.ReStruct.prototype.drawReactionArrow=function(t,e){var n=this.render.ps(e.item.pp),r=this.drawArrow(new util.Vec2(n.x-this.render.scale,n.y),new util.Vec2(n.x+this.render.scale,n.y));e.visel.add(r,util.Box2Abs.fromRelBox(rnd.relBox(r.getBBox())));var i=this.render.offset;null!=i&&r.translateAbs(i.x,i.y)},rnd.ReStruct.prototype.drawReactionPlus=function(t,e){var n=this.render.ps(e.item.pp),r=this.drawPlus(n);e.visel.add(r,util.Box2Abs.fromRelBox(rnd.relBox(r.getBBox())));var i=this.render.offset;null!=i&&r.translateAbs(i.x,i.y)},rnd.ReStruct.prototype.drawSGroups=function(){util.each(this.molecule.sGroupForest.getSGroupsBFS().reverse(),function(t){var e=this.sgroups.get(t),n=e.draw(this.render);this.addReObjectPath("data",e.visel,n,null,!0),e.setHighlight(e.highlight,this.render)},this)},rnd.ReStruct.prototype.drawFragments=function(){this.frags.each(function(t,e){var n=e.draw(this.render,t);n&&this.addReObjectPath("data",e.visel,n,null,!0)},this)},rnd.ReStruct.prototype.drawRGroups=function(){this.rgroups.each(function(t,e){var n=e.draw(this.render);for(var r in n)for(;n[r].length>0;)this.addReObjectPath(r,e.visel,n[r].shift(),null,!0)},this)},rnd.ReStruct.prototype.eachCC=function(t,e,n){this.connectedComponents.each(function(r,i){e&&this.ccFragmentType.get(r)!=e||t.call(n||this,r,i)},this)},rnd.ReStruct.prototype.getGroupBB=function(t){var e={min:null,max:null};return this.eachCC(function(t,n){e=this.connectedComponentGetBoundingBox(t,n,e)},t,this),e},rnd.ReStruct.prototype.setHydrogenPos=function(){for(var t in this.atomsChanged){var e=this.atoms.get(t);if(0!=e.a.neighbors.length){for(var n=1,r=1,i=0,o=0,s=0;s<e.a.neighbors.length;++s){var a=this.molecule.halfBonds.get(e.a.neighbors[s]).dir;a.x<=0?(n=Math.min(n,Math.abs(a.y)),i++):(r=Math.min(r,Math.abs(a.y)),o++)}.51>n||.51>r?e.hydrogenOnTheLeft=n>r:e.hydrogenOnTheLeft=o>i}else{var l=chem.Element.getElementByLabel(e.a.label);null!=l&&(e.hydrogenOnTheLeft=chem.Element.elements.get(l).putHydrogenOnTheLeft)}}},rnd.ReStruct.prototype.setImplicitHydrogen=function(){for(var t in this.atomsChanged)this.molecule.calcImplicitHydrogen(t)},rnd.ReLoop=function(t){this.loop=t,this.visel=new rnd.Visel(rnd.Visel.TYPE.LOOP),this.centre=new util.Vec2,this.radius=new util.Vec2},rnd.ReLoop.prototype=new rnd.ReObject,rnd.ReLoop.isSelectable=function(){return!1},rnd.ReStruct.prototype.coordProcess=function(t){t||this.molecule.rescale()},rnd.ReStruct.prototype.notifyAtomAdded=function(t){var e=new rnd.ReAtom(this.molecule.atoms.get(t));e.component=this.connectedComponents.add(util.Set.single(t)),this.atoms.set(t,e),this.markAtom(t,1)},rnd.ReStruct.prototype.notifyRxnPlusAdded=function(t){this.rxnPluses.set(t,new rnd.ReRxnPlus(this.molecule.rxnPluses.get(t)))},rnd.ReStruct.prototype.notifyRxnArrowAdded=function(t){this.rxnArrows.set(t,new rnd.ReRxnArrow(this.molecule.rxnArrows.get(t)))},rnd.ReStruct.prototype.notifyRxnArrowRemoved=function(t){this.markItemRemoved(),this.clearVisel(this.rxnArrows.get(t).visel),this.rxnArrows.unset(t)},rnd.ReStruct.prototype.notifyRxnPlusRemoved=function(t){this.markItemRemoved(),this.clearVisel(this.rxnPluses.get(t).visel),this.rxnPluses.unset(t)},rnd.ReStruct.prototype.notifyBondAdded=function(t){this.bonds.set(t,new rnd.ReBond(this.molecule.bonds.get(t))),this.markBond(t,1)},rnd.ReStruct.prototype.notifyAtomRemoved=function(t){var e=this.atoms.get(t),n=this.connectedComponents.get(e.component);util.Set.remove(n,t),0==util.Set.size(n)&&this.connectedComponents.remove(e.component),this.clearVisel(e.visel),this.atoms.unset(t),this.markItemRemoved()},rnd.ReStruct.prototype.notifyBondRemoved=function(t){var e=this.bonds.get(t);[e.b.hb1,e.b.hb2].each(function(t){var e=this.molecule.halfBonds.get(t);e.loop>=0&&this.loopRemove(e.loop)},this),this.clearVisel(e.visel),this.bonds.unset(t),this.markItemRemoved()},rnd.ReStruct.prototype.loopRemove=function(t){if(this.reloops.has(t)){var e=this.reloops.get(t);this.clearVisel(e.visel);for(var n=[],r=0;r<e.loop.hbs.length;++r){var i=e.loop.hbs[r];if(this.molecule.halfBonds.has(i)){var o=this.molecule.halfBonds.get(i);o.loop=-1,this.markBond(o.bid,1),this.markAtom(o.begin,1),n.push(o.bid)}}this.reloops.unset(t),this.molecule.loops.remove(t)}},rnd.ReStruct.prototype.loopIsValid=function(t,e){var n=this.molecule.halfBonds,r=e.loop,i=!1;return r.hbs.each(function(e){n.has(e)&&n.get(e).loop===t||(i=!0)},this),!i},rnd.ReStruct.prototype.verifyLoops=function(){var t=[];this.reloops.each(function(e,n){this.loopIsValid(e,n)||t.push(e)},this);for(var e=0;e<t.length;++e)this.loopRemove(t[e])},rnd.ReStruct.prototype.BFS=function(t,e,n){e-=0;var r=new Array,i={};for(r.push(e),i[e]=1;r.length>0;){var o=r.shift();t.call(n,o);for(var s=this.atoms.get(o),a=0;a<s.a.neighbors.length;++a){var l=s.a.neighbors[a],c=this.molecule.halfBonds.get(l);i[c.end]||(i[c.end]=1,r.push(c.end))}}},rnd.ReRxnPlus=function(t){this.init(rnd.Visel.TYPE.PLUS),this.item=t},rnd.ReRxnPlus.prototype=new rnd.ReObject,rnd.ReRxnPlus.isSelectable=function(){return!0},rnd.ReRxnPlus.findClosest=function(t,e){var n,r;return t.ctab.rxnPluses.each(function(t,i){var o=i.item.pp,s=Math.max(Math.abs(e.x-o.x),Math.abs(e.y-o.y));.5>s&&(!r||n>s)&&(n=s,r={id:t,dist:n})}),r},rnd.ReRxnPlus.prototype.highlightPath=function(t){var e=t.ps(this.item.pp),n=t.settings.scaleFactor;return t.paper.rect(e.x-n/4,e.y-n/4,n/2,n/2,n/8)},rnd.ReRxnPlus.prototype.drawHighlight=function(t){var e=this.highlightPath(t).attr(t.styles.highlightStyle);return t.ctab.addReObjectPath("highlighting",this.visel,e),e},rnd.ReRxnPlus.prototype.makeSelectionPlate=function(t,e,n){return this.highlightPath(t.render).attr(n.selectionStyle)},rnd.ReRxnArrow=function(t){this.init(rnd.Visel.TYPE.ARROW),this.item=t},rnd.ReRxnArrow.prototype=new rnd.ReObject,rnd.ReRxnArrow.isSelectable=function(){return!0},rnd.ReRxnArrow.findClosest=function(t,e){var n,r;return t.ctab.rxnArrows.each(function(t,i){var o=i.item.pp;if(Math.abs(e.x-o.x)<1){var s=Math.abs(e.y-o.y);.3>s&&(!r||n>s)&&(n=s,r={id:t,dist:n})}}),r},rnd.ReRxnArrow.prototype.highlightPath=function(t){var e=t.ps(this.item.pp),n=t.settings.scaleFactor;return t.paper.rect(e.x-n,e.y-n/4,2*n,n/2,n/8)},rnd.ReRxnArrow.prototype.drawHighlight=function(t){var e=this.highlightPath(t).attr(t.styles.highlightStyle);return t.ctab.addReObjectPath("highlighting",this.visel,e),e},rnd.ReRxnArrow.prototype.makeSelectionPlate=function(t,e,n){return this.highlightPath(t.render).attr(n.selectionStyle)},rnd.ReFrag=function(t){this.init(rnd.Visel.TYPE.FRAGMENT),this.item=t},rnd.ReFrag.prototype=new rnd.ReObject,rnd.ReFrag.isSelectable=function(){return!1},rnd.ReFrag.findClosest=function(t,e,n,r){r=Math.min(r||t.opt.selectionDistanceCoefficient,t.opt.selectionDistanceCoefficient);var i;return t.ctab.frags.each(function(o,s){if(o!=n){var a=s.calcBBox(t,o);if(a.p0.y<e.y&&a.p1.y>e.y&&a.p0.x<e.x&&a.p1.x>e.x){var l=Math.min(Math.abs(a.p0.x-e.x),Math.abs(a.p1.x-e.x));(!i||r>l)&&(r=l,i={id:o,dist:r})}}}),i},rnd.ReFrag.prototype.fragGetAtoms=function(t,e){var n=[];return t.ctab.atoms.each(function(t,r){r.a.fragment==e&&n.push(t)},this),n},rnd.ReFrag.prototype.fragGetBonds=function(t,e){var n=[];return t.ctab.bonds.each(function(r,i){t.ctab.atoms.get(i.b.begin).a.fragment==e&&t.ctab.atoms.get(i.b.end).a.fragment==e&&n.push(r)},this),n},rnd.ReFrag.prototype.calcBBox=function(t,e){var n;return t.ctab.atoms.each(function(r,i){if(i.a.fragment==e){var o=i.visel.boundingBox;if(o)o=o.translate((t.offset||new util.Vec2).negated()).transform(t.scaled2obj,t);else{o=new util.Box2Abs(i.a.pp,i.a.pp);var s=new util.Vec2(.05*3,.05*3);o=o.extend(s,s)}n=n?util.Box2Abs.union(n,o):o}},this),n},rnd.ReFrag.prototype._draw=function(t,e,n){var r=this.calcBBox(t,e);if(r){var i=t.obj2scaled(new util.Vec2(r.p0.x,r.p0.y)),o=t.obj2scaled(new util.Vec2(r.p1.x,r.p1.y));return t.paper.rect(i.x,i.y,o.x-i.x,o.y-i.y,0).attr(n)}},rnd.ReFrag.prototype.draw=function(t){return null},rnd.ReFrag.prototype.drawHighlight=function(t){},rnd.ReFrag.prototype.setHighlight=function(t,e){var n=e.ctab.frags.keyOf(this);Object.isUndefined(n)||(e.ctab.atoms.each(function(r,i){i.a.fragment==n&&i.setHighlight(t,e)},this),e.ctab.bonds.each(function(r,i){e.ctab.atoms.get(i.b.begin).a.fragment==n&&i.setHighlight(t,e)},this))},rnd.ReRGroup=function(t){this.init(rnd.Visel.TYPE.RGROUP),this.labelBox=null,this.item=t},rnd.ReRGroup.prototype=new rnd.ReObject,rnd.ReRGroup.isSelectable=function(){return!1},rnd.ReRGroup.prototype.getAtoms=function(t){var e=[];return this.item.frags.each(function(n,r){e=e.concat(t.ctab.frags.get(r).fragGetAtoms(t,r))}),e},rnd.ReRGroup.prototype.getBonds=function(t){var e=[];return this.item.frags.each(function(n,r){e=e.concat(t.ctab.frags.get(r).fragGetBonds(t,r))}),e},rnd.ReRGroup.findClosest=function(t,e,n,r){r=Math.min(r||t.opt.selectionDistanceCoefficient,t.opt.selectionDistanceCoefficient);var i;return t.ctab.rgroups.each(function(t,o){if(t!=n&&o.labelBox&&o.labelBox.contains(e,.5)){var s=util.Vec2.dist(o.labelBox.centre(),e);(!i||r>s)&&(r=s,i={id:t,dist:r})}}),i},rnd.ReRGroup.prototype.calcBBox=function(t){var e;return this.item.frags.each(function(n,r){var i=t.ctab.frags.get(r).calcBBox(t,r);i&&(e=e?util.Box2Abs.union(e,i):i)}),e=e.extend(this.__ext,this.__ext)},rnd.ReRGroup.drawBrackets=function(t,e,n,r,i){r=r||new util.Vec2(1,0);var o=Math.min(.25,.3*n.sz().x),s=n.p1.y-n.p0.y,a=.5*(n.p1.y+n.p0.y),l=chem.SGroup.drawBracket(e,e.paper,e.styles,r.negated(),r.negated().rotateSC(1,0),new util.Vec2(n.p0.x,a),o,s),c=chem.SGroup.drawBracket(e,e.paper,e.styles,r,r.rotateSC(1,0),new util.Vec2(n.p1.x,a),o,s);t.push(l,c)},rnd.ReRGroup.prototype.draw=function(t){var e=this.calcBBox(t),n=t.settings;if(e){var r={data:[]},i=t.obj2scaled(e.p0),o=t.obj2scaled(e.p1),s=t.paper.set();rnd.ReRGroup.drawBrackets(s,t,e),r.data.push(s);var a=t.ctab.rgroups.keyOf(this),l=t.paper.set(),c=t.paper.text(i.x,(i.y+o.y)/2,"R"+a+"=").attr({font:n.font,"font-size":n.fontRLabel,fill:"black"}),h=rnd.relBox(c.getBBox());c.translateAbs(-h.width/2-n.lineWidth,0),l.push(c);var u={font:n.font,"font-size":n.fontRLogic,fill:"black"},d=[];d.push((this.item.ifthen>0?"IF ":"")+"R"+a.toString()+(this.item.range.length>0?this.item.range.startsWith(">")||this.item.range.startsWith("<")||this.item.range.startsWith("=")?this.item.range:"="+this.item.range:">0")+(this.item.resth?" (RestH)":"")+(this.item.ifthen>0?"\nTHEN R"+this.item.ifthen.toString():""));for(var p=h.height/2+n.lineWidth/2,f=0;f<d.length;++f){var m=t.paper.text(i.x,(i.y+o.y)/2,d[f]).attr(u),g=rnd.relBox(m.getBBox());p+=g.height/2,m.translateAbs(-g.width/2-6*n.lineWidth,p),p+=g.height/2+n.lineWidth/2,r.data.push(m),l.push(m)}return r.data.push(c),this.labelBox=util.Box2Abs.fromRelBox(l.getBBox()).transform(t.scaled2obj,t),r}return{}},rnd.ReRGroup.prototype._draw=function(t,e,n){var r=this.getVBoxObj(t).extend(this.__ext,this.__ext);if(r){var i=t.obj2scaled(r.p0),o=t.obj2scaled(r.p1);return t.paper.rect(i.x,i.y,o.x-i.x,o.y-i.y,0).attr(n)}},rnd.ReRGroup.prototype.drawHighlight=function(t){var e=t.ctab.rgroups.keyOf(this);if(!Object.isUndefined(e)){var n=this._draw(t,e,t.styles.highlightStyle);return t.ctab.addReObjectPath("highlighting",this.visel,n),this.item.frags.each(function(e,n){t.ctab.frags.get(n).drawHighlight(t)},this),n}},rnd.ReSGroup=function(t){this.init(rnd.Visel.TYPE.SGROUP),this.item=t},rnd.ReSGroup.prototype=new rnd.ReObject,rnd.ReSGroup.isSelectable=function(){return!1},rnd.ReSGroup.findClosest=function(t,e){var n=null,r=t.opt.selectionDistanceCoefficient;return t.ctab.molecule.sgroups.each(function(t,i){for(var o=i.bracketDir,s=o.rotateSC(1,0),a=new util.Vec2(util.Vec2.dot(e,o),util.Vec2.dot(e,s)),l=0;l<i.areas.length;++l){var c=i.areas[l],h=c.p0.y<a.y&&c.p1.y>a.y&&c.p0.x<a.x&&c.p1.x>a.x,u=Math.min(Math.abs(c.p0.x-a.x),Math.abs(c.p1.x-a.x));h&&(null==n||r>u)&&(n=t,r=u)}},this),null!=n?{id:n,dist:r}:null},rnd.ReSGroup.prototype.draw=function(t){return this.item.draw(t.ctab)},rnd.ReSGroup.prototype.drawHighlight=function(t){var e=t.styles,n=t.settings,r=t.paper,i=this.item,o=i.bracketBox.transform(t.obj2scaled,t),s=n.lineWidth,a=new util.Vec2(4*s,6*s);o=o.extend(a,a);var l=i.bracketDir,c=l.rotateSC(1,0),h=util.Vec2.lc2(l,o.p0.x,c,o.p0.y),u=util.Vec2.lc2(l,o.p0.x,c,o.p1.y),d=util.Vec2.lc2(l,o.p1.x,c,o.p0.y),p=util.Vec2.lc2(l,o.p1.x,c,o.p1.y),f=r.set();i.highlighting=r.path("M{0},{1}L{2},{3}L{4},{5}L{6},{7}L{0},{1}",tfx(h.x),tfx(h.y),tfx(u.x),tfx(u.y),tfx(p.x),tfx(p.y),tfx(d.x),tfx(d.y)).attr(e.highlightStyle),f.push(i.highlighting),chem.SGroup.getAtoms(t.ctab.molecule,i).each(function(e){f.push(t.ctab.atoms.get(e).makeHighlightPlate(t))},this),chem.SGroup.getBonds(t.ctab.molecule,i).each(function(e){f.push(t.ctab.bonds.get(e).makeHighlightPlate(t))},this),t.ctab.addReObjectPath("highlighting",this.visel,f)},rnd.ReDataSGroupData=function(t){this.init(rnd.Visel.TYPE.SGROUP_DATA),this.sgroup=t},rnd.ReDataSGroupData.prototype=new rnd.ReObject,rnd.ReDataSGroupData.isSelectable=function(){return!0},rnd.ReDataSGroupData.findClosest=function(t,e){var n=null,r=null;return t.ctab.sgroupData.each(function(t,i){if("DAT"!=i.sgroup.type)throw new Error("Data group expected");var o=i.sgroup.dataArea,s=o.p0.y<e.y&&o.p1.y>e.y&&o.p0.x<e.x&&o.p1.x>e.x,a=Math.min(Math.abs(o.p0.x-e.x),Math.abs(o.p1.x-e.x));s&&(null==r||n>a)&&(r={id:t,dist:a},n=a)}),r},rnd.ReDataSGroupData.prototype.highlightPath=function(t){var e=this.sgroup.dataArea,n=t.obj2scaled(e.p0),r=t.obj2scaled(e.p1).sub(n);return t.paper.rect(n.x,n.y,r.x,r.y)},rnd.ReDataSGroupData.prototype.drawHighlight=function(t){var e=this.highlightPath(t).attr(t.styles.highlightStyle);return t.ctab.addReObjectPath("highlighting",this.visel,e),e},rnd.ReDataSGroupData.prototype.makeSelectionPlate=function(t,e,n){return this.highlightPath(t.render).attr(n.selectionStyle)},rnd.ReChiralFlag=function(t){this.init(rnd.Visel.TYPE.CHIRAL_FLAG),this.pp=t},rnd.ReChiralFlag.prototype=new rnd.ReObject,rnd.ReChiralFlag.isSelectable=function(){return!0},rnd.ReChiralFlag.findClosest=function(t,e){var n,r;return t.ctab.chiralFlags.each(function(t,i){var o=i.pp;if(Math.abs(e.x-o.x)<1){var s=Math.abs(e.y-o.y);.3>s&&(!r||n>s)&&(n=s,r={id:t,dist:n})}}),r},rnd.ReChiralFlag.prototype.highlightPath=function(t){var e=util.Box2Abs.fromRelBox(this.path.getBBox()),n=e.p1.sub(e.p0),r=e.p0.sub(t.offset);return t.paper.rect(r.x,r.y,n.x,n.y)},rnd.ReChiralFlag.prototype.drawHighlight=function(t){var e=this.highlightPath(t).attr(t.styles.highlightStyle);return t.ctab.addReObjectPath("highlighting",this.visel,e),e},rnd.ReChiralFlag.prototype.makeSelectionPlate=function(t,e,n){return this.highlightPath(t.render).attr(n.selectionStyle)},rnd.ReChiralFlag.prototype.draw=function(t){var e=t.paper,n=t.settings,r=t.ps(this.pp);this.path=e.text(r.x,r.y,"Chiral").attr({font:n.font,"font-size":n.fontsz,fill:"#000"}),t.ctab.addReObjectPath("data",this.visel,this.path,null,!0)},rnd.ReStruct.maps={atoms:rnd.ReAtom,bonds:rnd.ReBond,rxnPluses:rnd.ReRxnPlus,rxnArrows:rnd.ReRxnArrow,frags:rnd.ReFrag,rgroups:rnd.ReRGroup,sgroupData:rnd.ReDataSGroupData,chiralFlags:rnd.ReChiralFlag,sgroups:rnd.ReSGroup,reloops:rnd.ReLoop},!window.rnd||!rnd.ReStruct)throw new Error("MolData should be defined first");rnd.relBox=function(t){return{x:t.x,y:t.y,width:t.width,height:t.height}},rnd.ReStruct.prototype.drawArrow=function(t,e){var n=5,r=7,i=this.render.paper,o=this.render.styles;return i.path("M{0},{1}L{2},{3}L{4},{5}M{2},{3}L{4},{6}",tfx(t.x),tfx(t.y),tfx(e.x),tfx(e.y),tfx(e.x-r),tfx(e.y-n),tfx(e.y+n)).attr(o.lineattr)},rnd.ReStruct.prototype.drawPlus=function(t){var e=this.render.scale/5,n=this.render.paper,r=this.render.styles;return n.path("M{0},{4}L{0},{5}M{2},{1}L{3},{1}",tfx(t.x),tfx(t.y),tfx(t.x-e),tfx(t.x+e),tfx(t.y-e),tfx(t.y+e)).attr(r.lineattr)},rnd.ReStruct.prototype.drawBondSingle=function(t,e){var n=t.p,r=e.p,i=this.render.paper,o=this.render.styles;return i.path(rnd.ReStruct.makeStroke(n,r)).attr(o.lineattr)},rnd.ReStruct.prototype.drawBondSingleUp=function(t,e,n){var r=t.p,i=e.p,o=t.norm,s=this.render.settings,a=this.render.paper,l=this.render.styles,c=.7*s.bondSpace,h=i.addScaled(o,c),u=i.addScaled(o,-c);if(n.neihbid2>=0){var d=this.stereoUpBondGetCoordinates(e,n.neihbid2);h=d[0],u=d[1]}return a.path("M{0},{1}L{2},{3}L{4},{5}Z",tfx(r.x),tfx(r.y),tfx(h.x),tfx(h.y),tfx(u.x),tfx(u.y)).attr(l.lineattr).attr({fill:"#000"})},rnd.ReStruct.prototype.drawVec=function(t,e,n,r){var i=this.render.settings,o=this.render.paper,s=this.render.styles,a=i.bondSpace,l=t.addScaled(e,r||3*a);return o.path("M{0},{1}L{2},{3}",tfx(t.x),tfx(t.y),tfx(l.x),tfx(l.y)).attr(s.lineattr).attr({stroke:n||"#0F0"})},rnd.ReStruct.prototype.stereoUpBondGetCoordinates=function(t,e){var n=this.render.settings.bondSpace,r=this.molecule.halfBonds.get(e),i=util.Vec2.dot(t.dir,r.dir),o=util.Vec2.cross(t.dir,r.dir),s=Math.sqrt(.5*(1-i)),a=r.dir.rotateSC((o>=0?-1:1)*s,Math.sqrt(.5*(1+i))),l=.3,c=.7,h=t.p.addScaled(a,c*n/(s+l)),u=t.p.addScaled(a.negated(),c*n/(s+l));return o>0?[h,u]:[u,h]},rnd.ReStruct.prototype.drawBondSingleStereoBold=function(t,e,n,r){var i=this.render.paper,o=this.render.settings,s=this.render.styles,a=this.stereoUpBondGetCoordinates(t,n.neihbid1),l=this.stereoUpBondGetCoordinates(e,n.neihbid2),c=a[0],h=a[1],u=l[0],d=l[1],p=i.path("M{0},{1}L{2},{3}L{4},{5}L{6},{7}Z",tfx(c.x),tfx(c.y),tfx(h.x),tfx(h.y),tfx(u.x),tfx(u.y),tfx(d.x),tfx(d.y)).attr(s.lineattr).attr({stroke:"#000",fill:"#000"});if(r){var f=t.p,m=e.p,g=t.norm,b=n.doubleBondShift,v=1.5*o.bondSpace,y=f.addScaled(g,v*b),x=m.addScaled(g,v*b),S=!this.atoms.get(t.begin).showLabel,w=!this.atoms.get(e.begin).showLabel;return b>0?(S&&(y=y.addScaled(t.dir,v*this.getBondLineShift(t.rightCos,t.rightSin))),w&&(x=x.addScaled(t.dir,-v*this.getBondLineShift(e.leftCos,e.leftSin)))):0>b&&(S&&(y=y.addScaled(t.dir,v*this.getBondLineShift(t.leftCos,t.leftSin))),w&&(x=x.addScaled(t.dir,-v*this.getBondLineShift(e.rightCos,e.rightSin)))),i.set([p,i.path("M{0},{1}L{2},{3}",tfx(y.x),tfx(y.y),tfx(x.x),tfx(x.y)).attr(s.lineattr)])}return p},rnd.ReStruct.prototype.drawBondSingleDown=function(t,e){var n=t.p,r=e.p,i=t.norm,o=this.render.settings,s=this.render.paper,a=this.render.styles,l=.7*o.bondSpace,c=r.sub(n),h=c.length()+.2;c=c.normalized();for(var u,d,p=1.2*o.lineWidth,f=Math.max(Math.floor((h-o.lineWidth)/(o.lineWidth+p)),0)+2,m=h/(f-1),g="",b=n,v=0;f>v;++v)b=n.addScaled(c,m*v),u=b.addScaled(i,l*(v+.5)/(f-.5)),d=b.addScaled(i,-l*(v+.5)/(f-.5)),g+=rnd.ReStruct.makeStroke(u,d);return s.path(g).attr(a.lineattr)},rnd.ReStruct.prototype.drawBondSingleEither=function(t,e){var n=t.p,r=e.p,i=t.norm,o=this.render.settings,s=this.render.paper,a=this.render.styles,l=.7*o.bondSpace,c=r.sub(n),h=c.length();c=c.normalized();for(var u=.6*o.lineWidth,d=Math.max(Math.floor((h-o.lineWidth)/(o.lineWidth+u)),0)+2,p=h/(d-.5),f="M"+tfx(n.x)+","+tfx(n.y),m=n,g=0;d>g;++g)m=n.addScaled(c,p*(g+.5)).addScaled(i,(1&g?-1:1)*l*(g+.5)/(d-.5)),f+="L"+tfx(m.x)+","+tfx(m.y);return s.path(f).attr(a.lineattr)},rnd.ReStruct.prototype.getBondLineShift=function(t,e){return 0>e||Math.abs(t)>.9?0:e/(1-t)},rnd.ReStruct.prototype.drawBondDouble=function(t,e,n,r){var i=t.p,o=e.p,s=t.norm,a=r?0:n.doubleBondShift,l=this.render.settings,c=this.render.paper,h=this.render.styles,u=l.bondSpace/2,d=u,p=-u;d+=a*u,p+=a*u;var f=i.addScaled(s,d),m=o.addScaled(s,d),g=i.addScaled(s,p),b=o.addScaled(s,p),v=!this.atoms.get(t.begin).showLabel,y=!this.atoms.get(e.begin).showLabel;return a>0?(v&&(f=f.addScaled(t.dir,l.bondSpace*this.getBondLineShift(t.rightCos,t.rightSin))),y&&(m=m.addScaled(t.dir,-l.bondSpace*this.getBondLineShift(e.leftCos,e.leftSin)))):0>a&&(v&&(g=g.addScaled(t.dir,l.bondSpace*this.getBondLineShift(t.leftCos,t.leftSin))),y&&(b=b.addScaled(t.dir,-l.bondSpace*this.getBondLineShift(e.rightCos,e.rightSin)))),c.path(r?"M{0},{1}L{6},{7}M{4},{5}L{2},{3}":"M{0},{1}L{2},{3}M{4},{5}L{6},{7}",tfx(f.x),tfx(f.y),tfx(m.x),tfx(m.y),tfx(g.x),tfx(g.y),tfx(b.x),tfx(b.y)).attr(h.lineattr)},rnd.ReStruct.makeStroke=function(t,e){return"M"+tfx(t.x)+","+tfx(t.y)+"L"+tfx(e.x)+","+tfx(e.y)+"	"},rnd.ReStruct.prototype.drawBondSingleOrDouble=function(t,e){var n=t.p,r=e.p,i=t.norm,o=this.render,s=o.settings,a=o.paper,l=o.styles,c=s.bondSpace/2,h=(util.Vec2.dist(n,r)/(s.bondSpace+s.lineWidth)).toFixed()-0;1&h||(h+=1);for(var u="",d=n,p=1;h>=p;++p){var f=util.Vec2.lc2(n,(h-p)/h,r,p/h);1&p?u+=rnd.ReStruct.makeStroke(d,f):(u+=rnd.ReStruct.makeStroke(d.addScaled(i,c),f.addScaled(i,c)),u+=rnd.ReStruct.makeStroke(d.addScaled(i,-c),f.addScaled(i,-c))),d=f}return a.path(u).attr(l.lineattr)},rnd.ReStruct.prototype.drawBondTriple=function(t,e){var n=t.p,r=e.p,i=t.norm,o=this.render,s=o.settings,a=o.paper,l=o.styles,c=n.addScaled(i,s.bondSpace),h=r.addScaled(i,s.bondSpace),u=n.addScaled(i,-s.bondSpace),d=r.addScaled(i,-s.bondSpace);return a.path(rnd.ReStruct.makeStroke(n,r)+rnd.ReStruct.makeStroke(c,h)+rnd.ReStruct.makeStroke(u,d)).attr(l.lineattr)},rnd.dashedPath=function(t,e,n){for(var r=0,i=util.Vec2.dist(t,e),o=util.Vec2.diff(e,t).normalized(),s=!0,a="",l=0;i>r;){var c=n[l%n.length],h=r+Math.min(c,i-r);s&&(a+="M "+t.addScaled(o,r).coordStr()+" L "+t.addScaled(o,h).coordStr()),r+=c,s=!s,l++}return a},rnd.ReStruct.prototype.drawBondAromatic=function(t,e,n,r){if(!r)return this.drawBondSingle(t,e);var i=n.doubleBondShift,o=this.render.paper,s=this.preparePathsForAromaticBond(t,e,i),a=s[0],l=s[1];return(i>0?a:l).attr({"stroke-dasharray":"- "}),o.set([a,l])},rnd.dashdotPattern=[.125,.125,.005,.125],rnd.ReStruct.prototype.drawBondSingleOrAromatic=function(t,e,n){var r=n.doubleBondShift,i=this.render.paper,o=this.render.settings.scaleFactor,s=util.map(rnd.dashdotPattern,function(t){return t*o}),a=this.preparePathsForAromaticBond(t,e,r,r>0?1:2,s),l=a[0],c=a[1];return i.set([l,c])},rnd.ReStruct.prototype.preparePathsForAromaticBond=function(t,e,n,r,i){var o=this.render.settings,s=this.render.paper,a=this.render.styles,l=t.p,c=e.p,h=t.norm,u=o.bondSpace/2,d=u,p=-u;d+=n*u,p+=n*u;var f=l.addScaled(h,d),m=c.addScaled(h,d),g=l.addScaled(h,p),b=c.addScaled(h,p),v=!this.atoms.get(t.begin).showLabel,y=!this.atoms.get(e.begin).showLabel;n>0?(v&&(f=f.addScaled(t.dir,o.bondSpace*this.getBondLineShift(t.rightCos,t.rightSin))),y&&(m=m.addScaled(t.dir,-o.bondSpace*this.getBondLineShift(e.leftCos,e.leftSin)))):0>n&&(v&&(g=g.addScaled(t.dir,o.bondSpace*this.getBondLineShift(t.leftCos,t.leftSin))),y&&(b=b.addScaled(t.dir,-o.bondSpace*this.getBondLineShift(e.rightCos,e.rightSin))));var x=s.path(i&&1&r?rnd.dashedPath(f,m,i):rnd.ReStruct.makeStroke(f,m)).attr(a.lineattr),S=s.path(i&&2&r?rnd.dashedPath(g,b,i):rnd.ReStruct.makeStroke(g,b)).attr(a.lineattr);return[x,S]},rnd.ReStruct.prototype.drawBondDoubleOrAromatic=function(t,e,n){var r=n.doubleBondShift,i=this.render.paper,o=this.render.settings.scaleFactor,s=util.map(rnd.dashdotPattern,function(t){return t*o}),a=this.preparePathsForAromaticBond(t,e,r,3,s),l=a[0],c=a[1];return i.set([l,c])},rnd.ReStruct.prototype.drawBondAny=function(t,e){var n=t.p,r=e.p,i=this.render.paper,o=this.render.styles;return i.path(rnd.ReStruct.makeStroke(n,r)).attr(o.lineattr).attr({"stroke-dasharray":"- "})},rnd.ReStruct.prototype.drawReactingCenter=function(t,e,n){var r=e.p,i=n.p,o=i.add(r).scaled(.5),s=i.sub(r).normalized(),a=s.rotateSC(1,0),l=this.render.paper,c=this.render.styles,h=this.render.settings,u=[],d=h.lineWidth,p=h.bondSpace/2,f=d,m=2*d,g=1.5*p,b=1.5*p,v=3*p,y=.2;switch(t.b.reactingCenterStatus){case chem.Struct.BOND.REACTING_CENTER.NOT_CENTER:u.push(o.addScaled(a,v).addScaled(s,y*v)),u.push(o.addScaled(a,-v).addScaled(s,-y*v)),u.push(o.addScaled(a,v).addScaled(s,-y*v)),u.push(o.addScaled(a,-v).addScaled(s,y*v));break;case chem.Struct.BOND.REACTING_CENTER.CENTER:u.push(o.addScaled(a,v).addScaled(s,y*v).addScaled(s,f)),u.push(o.addScaled(a,-v).addScaled(s,-y*v).addScaled(s,f)),u.push(o.addScaled(a,v).addScaled(s,y*v).addScaled(s,-f)),u.push(o.addScaled(a,-v).addScaled(s,-y*v).addScaled(s,-f)),u.push(o.addScaled(s,g).addScaled(a,b)),u.push(o.addScaled(s,-g).addScaled(a,b)),u.push(o.addScaled(s,g).addScaled(a,-b)),u.push(o.addScaled(s,-g).addScaled(a,-b));break;case chem.Struct.BOND.REACTING_CENTER.MADE_OR_BROKEN:
u.push(o.addScaled(a,v).addScaled(s,m)),u.push(o.addScaled(a,-v).addScaled(s,m)),u.push(o.addScaled(a,v).addScaled(s,-m)),u.push(o.addScaled(a,-v).addScaled(s,-m));break;case chem.Struct.BOND.REACTING_CENTER.ORDER_CHANGED:u.push(o.addScaled(a,v)),u.push(o.addScaled(a,-v));break;case chem.Struct.BOND.REACTING_CENTER.MADE_OR_BROKEN_AND_CHANGED:u.push(o.addScaled(a,v).addScaled(s,m)),u.push(o.addScaled(a,-v).addScaled(s,m)),u.push(o.addScaled(a,v).addScaled(s,-m)),u.push(o.addScaled(a,-v).addScaled(s,-m)),u.push(o.addScaled(a,v)),u.push(o.addScaled(a,-v));break;default:return null}for(var x="",S=0;S<u.length/2;++S)x+=rnd.ReStruct.makeStroke(u[2*S],u[2*S+1]);return l.path(x).attr(c.lineattr)},rnd.ReStruct.prototype.drawTopologyMark=function(t,e,n){var r=null;if(t.b.topology==chem.Struct.BOND.TOPOLOGY.RING)r="rng";else{if(t.b.topology!=chem.Struct.BOND.TOPOLOGY.CHAIN)return null;r="chn"}var i=this.render.paper,o=this.render.settings,s=e.p,a=n.p,l=a.add(s).scaled(.5),c=a.sub(s).normalized(),h=c.rotateSC(1,0),u=o.lineWidth;t.doubleBondShift>0?h=h.scaled(-t.doubleBondShift):0==t.doubleBondShift&&(u+=o.bondSpace/2);var d=new util.Vec2(2,1).scaled(o.bondSpace);t.b.type==chem.Struct.BOND.TYPE.TRIPLE&&(u+=o.bondSpace);var p=l.add(new util.Vec2(h.x*(d.x+u),h.y*(d.y+u))),f=i.text(p.x,p.y,r).attr({font:o.font,"font-size":o.fontszsub,fill:"#000"}),m=rnd.relBox(f.getBBox());return this.centerText(f,m),f},rnd.ReStruct.prototype.drawBond=function(t,e,n){var r=null,i=this.molecule;switch(t.b.type){case chem.Struct.BOND.TYPE.SINGLE:switch(t.b.stereo){case chem.Struct.BOND.STEREO.UP:this.findIncomingUpBonds(e.bid,t),r=t.boldStereo&&t.neihbid1>=0&&t.neihbid2>=0?this.drawBondSingleStereoBold(e,n,t):this.drawBondSingleUp(e,n,t);break;case chem.Struct.BOND.STEREO.DOWN:r=this.drawBondSingleDown(e,n,t);break;case chem.Struct.BOND.STEREO.EITHER:r=this.drawBondSingleEither(e,n,t);break;default:r=this.drawBondSingle(e,n)}break;case chem.Struct.BOND.TYPE.DOUBLE:this.findIncomingUpBonds(e.bid,t),r=t.b.stereo===chem.Struct.BOND.STEREO.NONE&&t.boldStereo&&t.neihbid1>=0&&t.neihbid2>=0?this.drawBondSingleStereoBold(e,n,t,!0):this.drawBondDouble(e,n,t,t.b.stereo===chem.Struct.BOND.STEREO.CIS_TRANS);break;case chem.Struct.BOND.TYPE.TRIPLE:r=this.drawBondTriple(e,n,t);break;case chem.Struct.BOND.TYPE.AROMATIC:var o=e.loop>=0&&i.loops.get(e.loop).aromatic||n.loop>=0&&i.loops.get(n.loop).aromatic;r=this.drawBondAromatic(e,n,t,!o);break;case chem.Struct.BOND.TYPE.SINGLE_OR_DOUBLE:r=this.drawBondSingleOrDouble(e,n,t);break;case chem.Struct.BOND.TYPE.SINGLE_OR_AROMATIC:r=this.drawBondSingleOrAromatic(e,n,t);break;case chem.Struct.BOND.TYPE.DOUBLE_OR_AROMATIC:r=this.drawBondDoubleOrAromatic(e,n,t);break;case chem.Struct.BOND.TYPE.ANY:r=this.drawBondAny(e,n,t);break;default:throw new Error("Bond type "+t.b.type+" not supported")}return r},rnd.ReStruct.prototype.radicalCap=function(t){var e=this.render.settings,n=this.render.paper,r=.9*e.lineWidth,i=r,o=2*r;return n.path("M{0},{1}L{2},{3}L{4},{5}",tfx(t.x-i),tfx(t.y+o),tfx(t.x),tfx(t.y),tfx(t.x+i),tfx(t.y+o)).attr({stroke:"#000","stroke-width":.7*e.lineWidth,"stroke-linecap":"square","stroke-linejoin":"miter"})},rnd.ReStruct.prototype.radicalBullet=function(t){var e=this.render.settings,n=this.render.paper;return n.circle(t.x,t.y,e.lineWidth).attr({stroke:null,fill:"#000"})},rnd.ReStruct.prototype.centerText=function(t,e){this.render.paper.raphael.vml&&this.pathAndRBoxTranslate(t,e,0,.16*e.height)},rnd.ReStruct.prototype.showItemSelection=function(t,e,n){var r=null!=e.selectionPlate&&!e.selectionPlate.removed;if(r=r&&(!("hiddenPaths"in rnd.ReStruct.prototype)||rnd.ReStruct.prototype.hiddenPaths.indexOf(e.selectionPlate)<0),n){if(!r){var i=this.render,o=i.styles,s=i.paper;e.selectionPlate=e.makeSelectionPlate(this,s,o),this.addReObjectPath("selection-plate",e.visel,e.selectionPlate)}e.selectionPlate&&e.selectionPlate.show()}else r&&e.selectionPlate&&e.selectionPlate.hide()},rnd.ReStruct.prototype.pathAndRBoxTranslate=function(t,e,n,r){t.translateAbs(n,r),e.x+=n,e.y+=r};var markerColors=["black","cyan","magenta","red","green","blue","green"];if(rnd.ReStruct.prototype.showLabels=function(){var t=this.render,e=t.settings,n=t.styles,r=t.opt,i=t.paper,o=.5*e.lineWidth;for(var s in this.atomsChanged){var a=this.atoms.get(s),l=t.ps(a.a.pp),h=null;r.showAtomIds&&(h={},h.text=s.toString(),h.path=i.text(l.x,l.y,h.text).attr({font:e.font,"font-size":e.fontszsub,fill:"#070"}),h.rbb=rnd.relBox(h.path.getBBox()),this.centerText(h.path,h.rbb),this.addReObjectPath("indices",a.visel,h.path,l)),a.setHighlight(a.highlight,t);var u="#000000";if(a.showLabel){var d=0,p=0,f={};if(null!=a.a.atomList)f.text=a.a.atomList.label();else if("R#"==a.a.label&&null!=a.a.rglabel){f.text="";for(var m=0;32>m;m++)a.a.rglabel&1<<m&&(f.text+="R"+(m+1).toString());""==f.text&&(f="R#")}else if(f.text=a.a.label,r.atomColoring){var g=chem.Element.getElementByLabel(f.text);g&&(u=chem.Element.elements.get(g).color)}f.path=i.text(l.x,l.y,f.text).attr({font:e.font,"font-size":e.fontsz,fill:u}),f.rbb=rnd.relBox(f.path.getBBox()),this.centerText(f.path,f.rbb),null!=a.a.atomList&&this.pathAndRBoxTranslate(f.path,f.rbb,(a.hydrogenOnTheLeft?-1:1)*(f.rbb.width-f.rbb.height)/2,0),this.addReObjectPath("data",a.visel,f.path,l,!0),d=f.rbb.width/2,p=-f.rbb.width/2;var b=Math.floor(a.a.implicitH),v="H"==f.text,y={},x=null,S=a.hydrogenOnTheLeft;v&&b>0&&(x={},x.text=(b+1).toString(),x.path=i.text(l.x,l.y,x.text).attr({font:e.font,"font-size":e.fontszsub,fill:u}),x.rbb=rnd.relBox(x.path.getBBox()),this.centerText(x.path,x.rbb),this.pathAndRBoxTranslate(x.path,x.rbb,d+.5*x.rbb.width+o,.2*f.rbb.height),d+=x.rbb.width+o,this.addReObjectPath("data",a.visel,x.path,l,!0));var w={};if(0!=a.a.radical){var E;switch(a.a.radical){case 1:w.path=i.set(),E=1.6*e.lineWidth,w.path.push(this.radicalBullet(l.add(new util.Vec2(-E,0))),this.radicalBullet(l.add(new util.Vec2(E,0)))),w.path.attr("fill",u);break;case 2:w.path=this.radicalBullet(l).attr("fill",u);break;case 3:w.path=i.set(),E=1.6*e.lineWidth,w.path.push(this.radicalCap(l.add(new util.Vec2(-E,0))),this.radicalCap(l.add(new util.Vec2(E,0)))),w.path.attr("stroke",u)}w.rbb=rnd.relBox(w.path.getBBox());var B=-.5*(f.rbb.height+w.rbb.height);3==a.a.radical&&(B-=e.lineWidth/2),this.pathAndRBoxTranslate(w.path,w.rbb,0,B),this.addReObjectPath("data",a.visel,w.path,l,!0)}var R={};0!=a.a.isotope&&(R.text=a.a.isotope.toString(),R.path=i.text(l.x,l.y,R.text).attr({font:e.font,"font-size":e.fontszsub,fill:u}),R.rbb=rnd.relBox(R.path.getBBox()),this.centerText(R.path,R.rbb),this.pathAndRBoxTranslate(R.path,R.rbb,p-.5*R.rbb.width-o,-.3*f.rbb.height),p-=R.rbb.width+o,this.addReObjectPath("data",a.visel,R.path,l,!0)),!v&&b>0&&!t.opt.hideImplicitHydrogen&&(y.text="H",y.path=i.text(l.x,l.y,y.text).attr({font:e.font,"font-size":e.fontsz,fill:u}),y.rbb=rnd.relBox(y.path.getBBox()),this.centerText(y.path,y.rbb),S||(this.pathAndRBoxTranslate(y.path,y.rbb,d+.5*y.rbb.width+o,0),d+=y.rbb.width+o),b>1&&(x={},x.text=b.toString(),x.path=i.text(l.x,l.y,x.text).attr({font:e.font,"font-size":e.fontszsub,fill:u}),x.rbb=rnd.relBox(x.path.getBBox()),this.centerText(x.path,x.rbb),S||(this.pathAndRBoxTranslate(x.path,x.rbb,d+.5*x.rbb.width+o,.2*f.rbb.height),d+=x.rbb.width+o)),S&&(null!=x&&(this.pathAndRBoxTranslate(x.path,x.rbb,p-.5*x.rbb.width-o,.2*f.rbb.height),p-=x.rbb.width+o),this.pathAndRBoxTranslate(y.path,y.rbb,p-.5*y.rbb.width-o,0),p-=y.rbb.width+o),this.addReObjectPath("data",a.visel,y.path,l,!0),null!=x&&this.addReObjectPath("data",a.visel,x.path,l,!0));var C={};if(0!=a.a.charge){C.text="";var A=Math.abs(a.a.charge);1!=A&&(C.text=A.toString()),a.a.charge<0?C.text+="–":C.text+="+",C.path=i.text(l.x,l.y,C.text).attr({font:e.font,"font-size":e.fontszsub,fill:u}),C.rbb=rnd.relBox(C.path.getBBox()),this.centerText(C.path,C.rbb),this.pathAndRBoxTranslate(C.path,C.rbb,d+.5*C.rbb.width+o,-.3*f.rbb.height),d+=C.rbb.width+o,this.addReObjectPath("data",a.visel,C.path,l,!0)}var _={},O={0:"0",1:"I",2:"II",3:"III",4:"IV",5:"V",6:"VI",7:"VII",8:"VIII",9:"IX",10:"X",11:"XI",12:"XII",13:"XIII",14:"XIV"};if(a.a.explicitValence>=0){if(_.text=O[a.a.explicitValence],!_.text)throw new Error("invalid valence "+a.a.explicitValence.toString());_.text="("+_.text+")",_.path=i.text(l.x,l.y,_.text).attr({font:e.font,"font-size":e.fontszsub,fill:u}),_.rbb=rnd.relBox(_.path.getBBox()),this.centerText(_.path,_.rbb),this.pathAndRBoxTranslate(_.path,_.rbb,d+.5*_.rbb.width+o,-.3*f.rbb.height),d+=_.rbb.width+o,this.addReObjectPath("data",a.visel,_.path,l,!0)}if(a.a.badConn&&r.showValenceWarnings){var T={},P=l.y+f.rbb.height/2+o;T.path=i.path("M{0},{1}L{2},{3}",tfx(l.x+p),tfx(P),tfx(l.x+d),tfx(P)).attr(this.render.styles.lineattr).attr({stroke:"#F00"}),T.rbb=rnd.relBox(T.path.getBBox()),this.addReObjectPath("warnings",a.visel,T.path,l,!0)}h&&this.pathAndRBoxTranslate(h.path,h.rbb,-.5*f.rbb.width-.5*h.rbb.width-o,.3*f.rbb.height)}var M=this.bisectLargestSector(a),N=Prototype.Browser.IE?"*":"∗";if(a.a.attpnt){var L,k;for(L=0,c=0;4>L;++L){var D="";if(a.a.attpnt&1<<L){for(D.length>0&&(D+=" "),D+=N,k=0;(0==L?0:L+1)>k;++k)D+="'";var I=new util.Vec2(l),V=l.addScaled(M,.7*e.scaleFactor),j=i.text(V.x,V.y,D).attr({font:e.font,"font-size":e.fontsz,fill:u}),G=rnd.relBox(j.getBBox());this.centerText(j,G);var F=M.negated();V=V.addScaled(F,util.Vec2.shiftRayBox(V,F,util.Box2Abs.fromRelBox(G))+e.lineWidth/2),I=this.shiftBondEnd(a,I,M,e.lineWidth);var H=M.rotateSC(1,0),z=V.addScaled(H,.05*e.scaleFactor).addScaled(F,.09*e.scaleFactor),U=V.addScaled(H,-.05*e.scaleFactor).addScaled(F,.09*e.scaleFactor),$=i.set();$.push(j,i.path("M{0},{1}L{2},{3}M{4},{5}L{2},{3}L{6},{7}",tfx(I.x),tfx(I.y),tfx(V.x),tfx(V.y),tfx(z.x),tfx(z.y),tfx(U.x),tfx(U.y)).attr(n.lineattr).attr({"stroke-width":e.lineWidth/2})),this.addReObjectPath("indices",a.visel,$,l),M=M.rotate(Math.PI/6)}}}var Y="";if(a.a.aam>0&&(Y+=a.a.aam),a.a.invRet>0)if(Y.length>0&&(Y+=","),1==a.a.invRet)Y+="Inv";else{if(2!=a.a.invRet)throw new Error("Invalid value for the invert/retain flag");Y+="Ret"}var W="";if(0!=a.a.ringBondCount)if(a.a.ringBondCount>0)W+="rb"+a.a.ringBondCount.toString();else if(-1==a.a.ringBondCount)W+="rb0";else{if(-2!=a.a.ringBondCount)throw new Error("Ring bond count invalid");W+="rb*"}if(0!=a.a.substitutionCount)if(W.length>0&&(W+=","),a.a.substitutionCount>0)W+="s"+a.a.substitutionCount.toString();else if(-1==a.a.substitutionCount)W+="s0";else{if(-2!=a.a.substitutionCount)throw new Error("Substitution count invalid");W+="s*"}if(a.a.unsaturatedAtom>0){if(W.length>0&&(W+=","),1!=a.a.unsaturatedAtom)throw new Error("Unsaturated atom invalid value");W+="u"}if(a.a.hCount>0&&(W.length>0&&(W+=","),W+="H"+(a.a.hCount-1).toString()),a.a.exactChangeFlag>0){if(Y.length>0&&(Y+=","),1!=a.a.exactChangeFlag)throw new Error("Invalid value for the exact change flag");Y+="ext"}if(Y=(W.length>0?W+"\n":"")+(Y.length>0?"."+Y+".":""),Y.length>0){var q=i.text(l.x,l.y,Y).attr({font:e.font,"font-size":e.fontszsub,fill:u}),X=rnd.relBox(q.getBBox());this.centerText(q,X);var K=this.bisectLargestSector(a),J=a.visel,Q=3;for(L=0;L<J.exts.length;++L)Q=Math.max(Q,util.Vec2.shiftRayBox(l,K,J.exts[L].translate(l)));Q+=util.Vec2.shiftRayBox(l,K.negated(),util.Box2Abs.fromRelBox(X)),K=K.scaled(8+Q),this.pathAndRBoxTranslate(q,X,K.x,K.y),this.addReObjectPath("data",a.visel,q,l,!0)}}},rnd.ReStruct.prototype.shiftBondEnd=function(t,e,n,r){for(var i=0,o=t.visel,s=0;s<o.exts.length;++s){var a=o.exts[s].translate(e);i=Math.max(i,util.Vec2.shiftRayBox(e,n,a))}return i>0&&(e=e.addScaled(n,i+r)),e},rnd.ReStruct.prototype.bisectLargestSector=function(t){var e=[];t.a.neighbors.each(function(t){var n=this.molecule.halfBonds.get(t);e.push(n.ang)},this),e=e.sort(function(t,e){return t-e});for(var n=[],r=0;r<e.length-1;++r)n.push(e[(r+1)%e.length]-e[r]);n.push(e[0]-e[e.length-1]+2*Math.PI);var i=0,o=-Math.PI/2;for(r=0;r<e.length;++r)n[r]>i&&(i=n[r],o=e[r]+n[r]/2);return new util.Vec2(Math.cos(o),Math.sin(o))},rnd.ReStruct.prototype.bondRecalc=function(t,e){var n=this.render,r=this.atoms.get(e.b.begin),i=this.atoms.get(e.b.end),o=n.ps(r.a.pp),s=n.ps(i.a.pp),a=this.molecule.halfBonds.get(e.b.hb1),l=this.molecule.halfBonds.get(e.b.hb2);a.p=this.shiftBondEnd(r,o,a.dir,2*t.lineWidth),l.p=this.shiftBondEnd(i,s,l.dir,2*t.lineWidth),e.b.center=util.Vec2.lc2(r.a.pp,.5,i.a.pp,.5),e.b.len=util.Vec2.dist(o,s),e.b.sb=5*t.lineWidth,e.b.sa=Math.max(e.b.sb,e.b.len/2-2*t.lineWidth),e.b.angle=180*Math.atan2(a.dir.y,a.dir.x)/Math.PI},rnd.ReStruct.prototype.showBonds=function(){var t=this.render,e=t.settings,n=t.paper,r=t.opt;for(var i in this.bondsChanged){var o=this.bonds.get(i),s=this.molecule.halfBonds.get(o.b.hb1),a=this.molecule.halfBonds.get(o.b.hb2);this.bondRecalc(e,o),o.path=this.drawBond(o,s,a),o.rbb=rnd.relBox(o.path.getBBox()),this.addReObjectPath("data",o.visel,o.path,null,!0);var l={};l.path=this.drawReactingCenter(o,s,a),l.path&&(l.rbb=rnd.relBox(l.path.getBBox()),this.addReObjectPath("data",o.visel,l.path,null,!0));var c={};c.path=this.drawTopologyMark(o,s,a),c.path&&(c.rbb=rnd.relBox(c.path.getBBox()),this.addReObjectPath("data",o.visel,c.path,null,!0)),o.setHighlight(o.highlight,t);var h=.6*e.subFontSize,u=null,d=null;if(r.showBondIds){var p=util.Vec2.lc(s.p,.5,a.p,.5,s.norm,h);u=n.text(p.x,p.y,i.toString()),d=rnd.relBox(u.getBBox()),this.centerText(u,d),this.addReObjectPath("indices",o.visel,u)}if(r.showHalfBondIds){var f=util.Vec2.lc(s.p,.8,a.p,.2,s.norm,h);u=n.text(f.x,f.y,o.b.hb1.toString()),d=rnd.relBox(u.getBBox()),this.centerText(u,d),this.addReObjectPath("indices",o.visel,u);var m=util.Vec2.lc(s.p,.2,a.p,.8,a.norm,h);u=n.text(m.x,m.y,o.b.hb2.toString()),d=rnd.relBox(u.getBBox()),this.centerText(u,d),this.addReObjectPath("indices",o.visel,u)}if(r.showLoopIds&&!r.showBondIds){var g=util.Vec2.lc(s.p,.5,a.p,.5,a.norm,h);u=n.text(g.x,g.y,s.loop.toString()),d=rnd.relBox(u.getBBox()),this.centerText(u,d),this.addReObjectPath("indices",o.visel,u);var b=util.Vec2.lc(s.p,.5,a.p,.5,s.norm,h);u=n.text(b.x,b.y,a.loop.toString()),d=rnd.relBox(u.getBBox()),this.centerText(u,d),this.addReObjectPath("indices",o.visel,u)}}},rnd.ReStruct.prototype.labelIsVisible=function(t,e){if(0==e.a.neighbors.length||e.a.neighbors.length<2&&!this.render.opt.hideTerminalLabels||"c"!=e.a.label.toLowerCase()||e.a.badConn&&this.render.opt.showValenceWarnings||0!=e.a.isotope||0!=e.a.radical||0!=e.a.charge||e.a.explicitValence>=0||null!=e.a.atomList||null!=e.a.rglabel)return!0;if(2==e.a.neighbors.length){var n=e.a.neighbors[0],r=e.a.neighbors[1],i=this.molecule.halfBonds.get(n),o=this.molecule.halfBonds.get(r),s=this.bonds.get(i.bid),a=this.bonds.get(o.bid);if(s.b.type==a.b.type&&s.b.stereo==chem.Struct.BOND.STEREO.NONE&&a.b.stereo==chem.Struct.BOND.STEREO.NONE&&Math.abs(util.Vec2.cross(i.dir,o.dir))<.2)return!0}return!1},rnd.ReStruct.prototype.checkLabelsToShow=function(){for(var t in this.atomsChanged){var e=this.atoms.get(t);e.showLabel=this.labelIsVisible(t,e)}},rnd.ReStruct.layerMap={background:0,"selection-plate":1,highlighting:2,warnings:3,data:4,indices:5},rnd.ReStruct.prototype.addReObjectPath=function(t,e,n,r,i){if(n){var o=this.render.offset,s=i?util.Box2Abs.fromRelBox(rnd.relBox(n.getBBox())):null,a=r&&s?s.translate(r.negated()):null;null!==o&&(n.translateAbs(o.x,o.y),s=s?s.translate(o):null),e.add(n,s,a),this.insertInLayer(rnd.ReStruct.layerMap[t],n)}},rnd.ReStruct.prototype.clearVisel=function(t){for(var e=0;e<t.paths.length;++e)t.paths[e].remove();t.clear()},rnd.ReStruct.prototype.selectDoubleBondShift=function(t,e,n,r){return 6==t&&6!=e&&(n>1||1==r)?-1:6==e&&6!=t&&(r>1||1==n)?1:e*n>t*r?-1:t*r>e*n?1:e>t?-1:1},rnd.ReStruct.prototype.selectDoubleBondShift_Chain=function(t){var e=this.molecule,n=e.halfBonds.get(t.b.hb1),r=e.halfBonds.get(t.b.hb2),i=(n.leftSin>.3?1:0)+(r.rightSin>.3?1:0),o=(r.leftSin>.3?1:0)+(n.rightSin>.3?1:0);return i>o?-1:o>i?1:(n.leftSin>.3?1:0)+(n.rightSin>.3?1:0)==1?1:0},rnd.ReStruct.prototype.setDoubleBondShift=function(){var t=this.molecule;for(var e in this.bondsChanged){var n,r,i=this.bonds.get(e);if(n=t.halfBonds.get(i.b.hb1).loop,r=t.halfBonds.get(i.b.hb2).loop,n>=0&&r>=0){var o=t.loops.get(n).dblBonds,s=t.loops.get(r).dblBonds,a=t.loops.get(n).hbs.length,l=t.loops.get(r).hbs.length;i.doubleBondShift=this.selectDoubleBondShift(a,l,o,s)}else n>=0?i.doubleBondShift=-1:r>=0?i.doubleBondShift=1:i.doubleBondShift=this.selectDoubleBondShift_Chain(i)}},rnd.ReStruct.prototype.updateLoops=function(){this.reloops.each(function(t,e){this.clearVisel(e.visel)},this);var t=this.molecule.findLoops();util.each(t.bondsToMark,function(t){this.markBond(t,1)},this),util.each(t.newLoops,function(t){this.reloops.set(t,new rnd.ReLoop(this.molecule.loops.get(t)))},this)},rnd.ReStruct.prototype.renderLoops=function(){var t=this.render,e=t.settings,n=t.paper,r=this.molecule;this.reloops.each(function(i,o){var s=o.loop;o.centre=new util.Vec2,s.hbs.each(function(e){var n=r.halfBonds.get(e),i=this.bonds.get(n.bid),a=t.ps(this.atoms.get(n.begin).a.pp);i.b.type!=chem.Struct.BOND.TYPE.AROMATIC&&(s.aromatic=!1),o.centre.add_(a)},this),s.convex=!0;for(var a=0;a<o.loop.hbs.length;++a){var l=r.halfBonds.get(s.hbs[a]),c=r.halfBonds.get(s.hbs[(a+1)%s.hbs.length]),h=Math.atan2(util.Vec2.cross(l.dir,c.dir),util.Vec2.dot(l.dir,c.dir));h>0&&(s.convex=!1)}if(o.centre=o.centre.scaled(1/s.hbs.length),o.radius=-1,s.hbs.each(function(e){var n=r.halfBonds.get(e),i=t.ps(this.atoms.get(n.begin).a.pp),s=t.ps(this.atoms.get(n.end).a.pp),a=util.Vec2.diff(s,i).rotateSC(1,0).normalized(),l=util.Vec2.dot(util.Vec2.diff(i,o.centre),a);o.radius<0?o.radius=l:o.radius=Math.min(o.radius,l)},this),o.radius*=.7,s.aromatic){var u=null;if(s.convex)u=n.circle(o.centre.x,o.centre.y,o.radius).attr({stroke:"#000","stroke-width":e.lineWidth});else{var d="";for(a=0;a<s.hbs.length;++a){l=r.halfBonds.get(s.hbs[a]),c=r.halfBonds.get(s.hbs[(a+1)%s.hbs.length]),h=Math.atan2(util.Vec2.cross(l.dir,c.dir),util.Vec2.dot(l.dir,c.dir));var p=(Math.PI-h)/2,f=c.dir.rotate(p),m=t.ps(this.atoms.get(c.begin).a.pp),g=Math.sin(p),b=.1;Math.abs(g)<b&&(g=g*b/Math.abs(g));var v=e.bondSpace/g,y=m.addScaled(f,-v);d+=0==a?"M":"L",d+=tfx(y.x)+","+tfx(y.y)}d+="Z",u=n.path(d).attr({stroke:"#000","stroke-width":e.lineWidth,"stroke-dasharray":"- "})}this.addReObjectPath("data",o.visel,u,null,!0)}},this)},!window.Prototype)throw new Error("Prototype.js should be loaded first");if(!window.rnd||!rnd.ReStruct)throw new Error("rnd.MolData should be defined prior to loading this file");rnd.DEBUG=!1,rnd.logcnt=0,rnd.logmouse=!1,rnd.hl=!1,rnd.logMethod=function(){},rnd.RenderDummy=function(t,e,n,r){this.clientArea=t=$(t),t.innerHTML="",this.paper=new Raphael(t),this.paper.rect(0,0,100,100).attr({fill:"#0F0",stroke:"none"}),this.setMolecule=function(){},this.update=function(){}},rnd.RenderOptions=function(t){t=t||{},this.showSelectionRegions=t.showSelectionRegions||!1,this.showAtomIds=t.showAtomIds||!1,this.showBondIds=t.showBondIds||!1,this.showHalfBondIds=t.showHalfBondIds||!1,this.showLoopIds=t.showLoopIds||!1,this.showValenceWarnings=Object.isUndefined(t.showValenceWarnings)?!0:t.showValenceWarnings,this.autoScale=t.autoScale||!1,this.autoScaleMargin=t.autoScaleMargin||0,this.atomColoring=t.atomColoring||0,this.hideImplicitHydrogen=t.hideImplicitHydrogen||!1,this.hideTerminalLabels=t.hideTerminalLabels||!1,this.ignoreMouseEvents=t.ignoreMouseEvents||!1,this.selectionDistanceCoefficient=(t.selectionDistanceCoefficient||.4)-0},rnd.Render=function(t,e,n,r){this.opt=new rnd.RenderOptions(n),this.useOldZoom=Prototype.Browser.IE,this.scale=e||100,this.baseScale=this.scale,this.offset=new util.Vec2,this.clientArea=t=$(t),t.innerHTML="",this.paper=new Raphael(t),this.size=new util.Vec2,this.viewSz=r||new util.Vec2(t.clientWidth||100,t.clientHeight||100),this.bb=new util.Box2Abs(new util.Vec2,this.viewSz),this.dirty=!0,this.selectionRect=null,this.rxnArrow=null,this.rxnMode=!1,this.zoom=1;var i=this,o=0,s=0,a=t;do o+=a.offsetTop||0,s+=a.offsetLeft||0,a=a.offsetParent;while(a);this.clientAreaPos=new util.Vec2(s,o),t.observe("selectstart",function(t){return util.stopEventPropagation(t),util.preventDefault(t)});var l=this;l.longTapFlag=!1,l.longTapTimeout=null,l.longTapTouchstart=null,l.setLongTapTimeout=function(t){l.longTapFlag=!1,l.longTapTouchstart=t,l.longTapTimeout=setTimeout(function(){l.longTapFlag=!0,l.longTapTimeout=null},500)},l.resetLongTapTimeout=function(t){clearTimeout(l.longTapTimeout),l.longTapTimeout=null,t&&(l.longTapTouchstart=null,l.longTapFlag=!1)},t.observe("touchstart",function(t){l.resetLongTapTimeout(!0),2==t.touches.length?(this._tui=this._tui||{},this._tui.center={pageX:(t.touches[0].pageX+t.touches[1].pageX)/2,pageY:(t.touches[0].pageY+t.touches[1].pageY)/2},ui.setZoomStaticPointInit(ui.page2obj(this._tui.center))):1==t.touches.length&&l.setLongTapTimeout(t)}),t.observe("touchmove",function(t){l.resetLongTapTimeout(!0),"_tui"in this&&2==t.touches.length&&(this._tui.center={pageX:(t.touches[0].pageX+t.touches[1].pageX)/2,pageY:(t.touches[0].pageY+t.touches[1].pageY)/2})}),t.observe("gesturestart",function(t){this._tui=this._tui||{},this._tui.scale0=ui.render.zoom,t.preventDefault()}),t.observe("gesturechange",function(t){ui.setZoomStaticPoint(this._tui.scale0*t.scale,ui.page2canvas2(this._tui.center)),ui.render.update(),t.preventDefault()}),t.observe("gestureend",function(t){delete this._tui,t.preventDefault()}),t.observe("onresize",function(t){i.onResize()}),"hiddenPaths"in rnd.ReStruct.prototype&&t.observe("touchend",function(t){if(0==t.touches.length)for(;rnd.ReStruct.prototype.hiddenPaths.length>0;)rnd.ReStruct.prototype.hiddenPaths.pop().remove()}),t.observe("touchend",function(t){return l.resetLongTapTimeout(!1),l.longTapFlag?(ui.render.current_tool&&ui.render.current_tool.processEvent("OnDblClick",l.longTapTouchstart),l.resetLongTapTimeout(!0),util.preventDefault(t)):void(0==t.touches.length&&ui.render.current_tool&&ui.render.current_tool.processEvent("OnMouseUp",t))}),this.opt.ignoreMouseEvents||["Click","DblClick","MouseDown","MouseMove","MouseUp","MouseLeave"].each(function(e){var n=e.toLowerCase();n=EventMap[n]||n,t.observe(n,function(r){if(!("MouseLeave"==e||ui&&ui.is_touch)){var i=t.cumulativeOffset();i=new util.Vec2(i[0],i[1]);var o=new util.Vec2(r.clientX,r.clientY).sub(i),s=new util.Vec2(t.clientWidth,t.clientHeight);if(!(o.x>0&&o.y>0&&o.x<s.x&&o.y<s.y))return"MouseMove"==e&&ui.render.current_tool.processEvent("OnMouseLeave",r),util.preventDefault(r)}return ui.render.current_tool.processEvent("On"+e,r),util.stopEventPropagation(r),"touchstart"==n||"touchmove"==n&&2==r.touches.length?void 0:util.preventDefault(r)})},this),this.ctab=new rnd.ReStruct(new chem.Struct,this),this.settings=null,this.styles=null,this.onCanvasOffsetChanged=null,this.onCanvasSizeChanged=null},rnd.Render.prototype.view2scaled=function(t,e){var n=ui.scrollPos();return this.useOldZoom||(t=t.scaled(1/this.zoom),n=n.scaled(1/this.zoom)),t=e?t:t.add(n).sub(this.offset)},rnd.Render.prototype.scaled2view=function(t,e){return t=e?t:t.add(this.offset).sub(ui.scrollPos().scaled(1/this.zoom)),this.useOldZoom||(t=t.scaled(this.zoom)),t},rnd.Render.prototype.scaled2obj=function(t){return t.scaled(1/this.settings.scaleFactor)},rnd.Render.prototype.obj2scaled=function(t){return t.scaled(this.settings.scaleFactor)},rnd.Render.prototype.view2obj=function(t,e){return this.scaled2obj(this.view2scaled(t,e))},rnd.Render.prototype.obj2view=function(t,e){return this.scaled2view(this.obj2scaled(t,e))},rnd.Render.prototype.findItem=function(t,e,n){var r=this.findClosestItem("ui"in window&&"page2obj"in ui?new util.Vec2(ui.page2obj(t)):new util.Vec2(t.pageX,t.pageY).sub(this.clientAreaPos),e,n);return"Atom"==r.type?r.map="atoms":"Bond"==r.type?r.map="bonds":"SGroup"==r.type?r.map="sgroups":"DataSGroupData"==r.type?r.map="sgroupData":"RxnArrow"==r.type?r.map="rxnArrows":"RxnPlus"==r.type?r.map="rxnPluses":"Fragment"==r.type?r.map="frags":"RGroup"==r.type?r.map="rgroups":"ChiralFlag"==r.type&&(r.map="chiralFlags"),r},rnd.Render.prototype.client2Obj=function(t){return new util.Vec2(t).sub(this.offset)},rnd.Render.prototype.setMolecule=function(t,e){rnd.logMethod("setMolecule"),this.paper.clear(),this.ctab=new rnd.ReStruct(t,this,e),this.offset=null,this.size=null,this.bb=null,this.rxnMode=t.isReaction},rnd.Render.prototype.atomGetAttr=function(t,e){return rnd.logMethod("atomGetAttr"),this.ctab.molecule.atoms.get(t)[e]},rnd.Render.prototype.invalidateAtom=function(t,e){var n=this.ctab.atoms.get(t);this.ctab.markAtom(t,e?1:0);for(var r=this.ctab.molecule.halfBonds,i=0;i<n.a.neighbors.length;++i){var o=n.a.neighbors[i];if(r.has(o)){var s=r.get(o);this.ctab.markBond(s.bid,1),this.ctab.markAtom(s.end,0),e&&this.invalidateLoop(s.bid)}}},rnd.Render.prototype.invalidateLoop=function(t){var e=this.ctab.bonds.get(t),n=this.ctab.molecule.halfBonds.get(e.b.hb1).loop,r=this.ctab.molecule.halfBonds.get(e.b.hb2).loop;n>=0&&this.ctab.loopRemove(n),r>=0&&this.ctab.loopRemove(r)},rnd.Render.prototype.invalidateBond=function(t){var e=this.ctab.bonds.get(t);this.invalidateLoop(t),this.invalidateAtom(e.b.begin,0),this.invalidateAtom(e.b.end,0)},rnd.Render.prototype.invalidateItem=function(t,e,n){"atoms"==t?this.invalidateAtom(e,n):"bonds"==t?(this.invalidateBond(e),n>0&&this.invalidateLoop(e)):this.ctab.markItem(t,e,n)},rnd.Render.prototype.atomGetDegree=function(t){return rnd.logMethod("atomGetDegree"),this.ctab.atoms.get(t).a.neighbors.length},rnd.Render.prototype.isBondInRing=function(t){var e=this.ctab.bonds.get(t);return this.ctab.molecule.halfBonds.get(e.b.hb1).loop>=0||this.ctab.molecule.halfBonds.get(e.b.hb2).loop>=0},rnd.Render.prototype.atomGetNeighbors=function(t){for(var e=this.ctab.atoms.get(t),n=[],r=0;r<e.a.neighbors.length;++r){var i=this.ctab.molecule.halfBonds.get(e.a.neighbors[r]);n.push({aid:i.end-0,bid:i.bid-0})}return n},rnd.Render.prototype.atomGetSGroups=function(t){rnd.logMethod("atomGetSGroups");var e=this.ctab.atoms.get(t);return util.Set.list(e.a.sgs)},rnd.Render.prototype.sGroupGetAttr=function(t,e){return rnd.logMethod("sGroupGetAttr"),this.ctab.sgroups.get(t).item.getAttr(e)},rnd.Render.prototype.sGroupGetAttrs=function(t){return rnd.logMethod("sGroupGetAttrs"),this.ctab.sgroups.get(t).item.getAttrs()},rnd.Render.prototype.sGroupGetAtoms=function(t){rnd.logMethod("sGroupGetAtoms");var e=this.ctab.sgroups.get(t).item;return chem.SGroup.getAtoms(this.ctab.molecule,e)},rnd.Render.prototype.sGroupGetType=function(t){rnd.logMethod("sGroupGetType");var e=this.ctab.sgroups.get(t).item;return e.type},rnd.Render.prototype.sGroupsFindCrossBonds=function(){rnd.logMethod("sGroupsFindCrossBonds"),this.ctab.molecule.sGroupsRecalcCrossBonds()},rnd.Render.prototype.sGroupGetNeighborAtoms=function(t){rnd.logMethod("sGroupGetNeighborAtoms");var e=this.ctab.sgroups.get(t).item;return e.neiAtoms},rnd.Render.prototype.atomIsPlainCarbon=function(t){return rnd.logMethod("atomIsPlainCarbon"),this.ctab.atoms.get(t).a.isPlainCarbon()},rnd.Render.prototype.highlightObject=function(t,e){if(!(["atoms","bonds","rxnArrows","rxnPluses","chiralFlags","frags","rgroups","sgroups","sgroupData"].indexOf(t.map)>-1))return!1;var n=this.ctab[t.map].get(t.id);if(null==n)return!0;if("sgroups"==t.map&&"DAT"==n.item.type||"sgroupData"==t.map){var r=this.ctab.sgroups.get(t.id),i=this.ctab.sgroupData.get(t.id);null!=r&&r.setHighlight(e,this),null!=i&&i.setHighlight(e,this)}else n.setHighlight(e,this);return!0},rnd.Render.prototype.itemGetPos=function(t,e){return this.ctab.molecule[t].get(e).pp},rnd.Render.prototype.atomGetPos=function(t){return rnd.logMethod("atomGetPos"),this.itemGetPos("atoms",t)},rnd.Render.prototype.rxnArrowGetPos=function(t){return rnd.logMethod("rxnArrowGetPos"),this.itemGetPos("rxnArrows",t)},rnd.Render.prototype.rxnPlusGetPos=function(t){return rnd.logMethod("rxnPlusGetPos"),this.itemGetPos("rxnPluses",t)},rnd.Render.prototype.getAdjacentBonds=function(t){for(var e=util.Set.fromList(t),n=util.Set.empty(),r=util.Set.empty(),i=0;i<t.length;++i)for(var o=t[i],s=this.ctab.atoms.get(o),a=0;a<s.a.neighbors.length;++a){var l=s.a.neighbors[a],c=this.ctab.molecule.halfBonds.get(l),h=c.end,u=util.Set.contains(e,h)?n:r;util.Set.add(u,c.bid)}return{inner:n,cross:r}},rnd.Render.prototype.bondGetAttr=function(t,e){return rnd.logMethod("bondGetAttr"),this.ctab.bonds.get(t).b[e]},rnd.Render.prototype.setSelection=function(t){rnd.logMethod("setSelection");for(var e in rnd.ReStruct.maps)if(rnd.ReStruct.maps[e].isSelectable()){var n=t?t[e]?util.identityMap(t[e]):{}:null;this.ctab[e].each(function(t,e){var r=n?n[t]===t:e.selected;e.selected=r,this.ctab.showItemSelection(t,e,r)},this)}},rnd.Render.prototype.initStyles=function(){var t=this.settings;this.styles={},this.styles.lineattr={stroke:"#000","stroke-width":t.lineWidth,"stroke-linecap":"round","stroke-linejoin":"round"},this.styles.selectionStyle={fill:"#7f7",stroke:"none"},this.styles.selectionZoneStyle={fill:"#000",stroke:"none",opacity:0},this.styles.highlightStyle={stroke:"#0c0","stroke-width":.6*t.lineWidth},this.styles.sGroupHighlightStyle={stroke:"#9900ff","stroke-width":.6*t.lineWidth},this.styles.sgroupBracketStyle={stroke:"darkgray","stroke-width":.5*t.lineWidth},this.styles.atomSelectionPlateRadius=1.2*t.labelFontSize},rnd.Render.prototype.initSettings=function(){var t=this.settings={};t.delta=this.ctab.molecule.getCoordBoundingBox(),t.margin=.1,t.scaleFactor=this.scale,t.lineWidth=t.scaleFactor/20,t.bondShift=t.scaleFactor/6,t.bondSpace=t.scaleFactor/7,t.labelFontSize=Math.ceil(1.9*(t.scaleFactor/6)),t.subFontSize=Math.ceil(.7*t.labelFontSize),t.font='30px "Arial"',t.fontsz=this.settings.labelFontSize,t.fontszsub=this.settings.subFontSize,t.fontRLabel=1.2*this.settings.labelFontSize,t.fontRLogic=.7*this.settings.labelFontSize},rnd.Render.prototype.getStructCenter=function(t){var e=this.ctab.getVBoxObj(t);return util.Vec2.lc2(e.p0,.5,e.p1,.5)},rnd.Render.prototype.onResize=function(){this.setViewSize(new util.Vec2(this.clientArea.clientWidth,this.clientArea.clientHeight))},rnd.Render.prototype.setViewSize=function(t){this.viewSz=new util.Vec2(t)},rnd.Render.prototype._setPaperSize=function(t){var e=this.zoom;this.paper.setSize(t.x*e,t.y*e),this.setViewBox(e)},rnd.Render.prototype.setPaperSize=function(t){rnd.logMethod("setPaperSize");var e=this.sz;this.sz=t,this._setPaperSize(t),this.onCanvasSizeChanged&&this.onCanvasSizeChanged(t,e)},rnd.Render.prototype.setOffset=function(t){rnd.logMethod("setOffset");var e=this.offset;this.offset=t,this.onCanvasOffsetChanged&&this.onCanvasOffsetChanged(t,e)},rnd.Render.prototype.getElementPos=function(t){var e=0,n=0;if(t.offsetParent)do e+=t.offsetLeft,n+=t.offsetTop;while(t=t.offsetParent);return new util.Vec2(e,n)},rnd.Render.prototype.drawSelectionLine=function(t,e){rnd.logMethod("drawSelectionLine"),this.selectionRect&&(this.selectionRect.remove(),this.selectionRect=null),t&&e&&(t=this.obj2scaled(t).add(this.offset),e=this.obj2scaled(e).add(this.offset),this.selectionRect=this.paper.path(rnd.ReStruct.makeStroke(t,e)).attr({stroke:"gray","stroke-width":"1px"}))},rnd.Render.prototype.drawSelectionRectangle=function(t,e){rnd.logMethod("drawSelectionRectangle"),this.selectionRect&&(this.selectionRect.remove(),this.selectionRect=null),t&&e&&(t=this.obj2scaled(t).add(this.offset),e=this.obj2scaled(e).add(this.offset),this.selectionRect=this.paper.rect(Math.min(t.x,e.x),Math.min(t.y,e.y),Math.abs(e.x-t.x),Math.abs(e.y-t.y)).attr({stroke:"gray","stroke-width":"1px"}))},rnd.Render.prototype.getElementsInRectangle=function(t,e){rnd.logMethod("getElementsInRectangle");var n=new Array,r=new Array,i=Math.min(t.x,e.x),o=Math.max(t.x,e.x),s=Math.min(t.y,e.y),a=Math.max(t.y,e.y);this.ctab.bonds.each(function(t,e){var r=util.Vec2.lc2(this.ctab.atoms.get(e.b.begin).a.pp,.5,this.ctab.atoms.get(e.b.end).a.pp,.5);r.x>i&&r.x<o&&r.y>s&&r.y<a&&n.push(t)},this),this.ctab.atoms.each(function(t,e){e.a.pp.x>i&&e.a.pp.x<o&&e.a.pp.y>s&&e.a.pp.y<a&&r.push(t)},this);var l=new Array,c=new Array;this.ctab.rxnArrows.each(function(t,e){
e.item.pp.x>i&&e.item.pp.x<o&&e.item.pp.y>s&&e.item.pp.y<a&&l.push(t)},this),this.ctab.rxnPluses.each(function(t,e){e.item.pp.x>i&&e.item.pp.x<o&&e.item.pp.y>s&&e.item.pp.y<a&&c.push(t)},this);var h=new Array;this.ctab.chiralFlags.each(function(t,e){e.pp.x>i&&e.pp.x<o&&e.pp.y>s&&e.pp.y<a&&h.push(t)},this);var u=new Array;return this.ctab.sgroupData.each(function(t,e){e.sgroup.pp.x>i&&e.sgroup.pp.x<o&&e.sgroup.pp.y>s&&e.sgroup.pp.y<a&&u.push(t)},this),{atoms:r,bonds:n,rxnArrows:l,rxnPluses:c,chiralFlags:h,sgroupData:u}},rnd.Render.prototype.drawSelectionPolygon=function(t){if(rnd.logMethod("drawSelectionPolygon"),this.selectionRect&&(this.selectionRect.remove(),this.selectionRect=null),t&&t.length>1){for(var e=this.obj2scaled(t[t.length-1]).add(this.offset),n="M"+tfx(e.x)+","+tfx(e.y),r=0;r<t.length;++r)e=this.obj2scaled(t[r]).add(this.offset),n+="L"+tfx(e.x)+","+tfx(e.y);this.selectionRect=this.paper.path(n).attr({stroke:"gray","stroke-width":"1px"})}},rnd.Render.prototype.isPointInPolygon=function(t,e){for(var n=new util.Vec2(0,1),r=n.rotate(Math.PI/2),i=util.Vec2.diff(t[t.length-1],e),o=util.Vec2.dot(r,i),s=util.Vec2.dot(n,i),a=null,l=0,c=1e-5,h=!1,u=!1,d=0;d<t.length;++d){var p=util.Vec2.diff(t[d],e),f=util.Vec2.diff(p,i),m=util.Vec2.dot(r,p),g=util.Vec2.dot(n,p);h=!1,0>m*o&&(g*s>-c?s>-c&&(h=!0):(Math.abs(o)*Math.abs(g)-Math.abs(m)*Math.abs(s))*g>0&&(h=!0)),h&&u&&util.Vec2.dot(f,r)*util.Vec2(a,r)>=0&&(h=!1),h&&l++,i=p,o=m,s=g,a=f,u=h}return l%2!=0},rnd.Render.prototype.ps=function(t){return t.scaled(this.settings.scaleFactor)},rnd.Render.prototype.getElementsInPolygon=function(t){rnd.logMethod("getElementsInPolygon");for(var e=new Array,n=new Array,r=[],i=0;i<t.length;++i)r[i]=new util.Vec2(t[i].x,t[i].y);this.ctab.bonds.each(function(t,n){var i=util.Vec2.lc2(this.ctab.atoms.get(n.b.begin).a.pp,.5,this.ctab.atoms.get(n.b.end).a.pp,.5);this.isPointInPolygon(r,i)&&e.push(t)},this),this.ctab.atoms.each(function(t,e){this.isPointInPolygon(r,e.a.pp)&&n.push(t)},this);var o=new Array,s=new Array;this.ctab.rxnArrows.each(function(t,e){this.isPointInPolygon(r,e.item.pp)&&o.push(t)},this),this.ctab.rxnPluses.each(function(t,e){this.isPointInPolygon(r,e.item.pp)&&s.push(t)},this);var a=new Array;this.ctab.chiralFlags.each(function(t,e){this.isPointInPolygon(r,e.pp)&&a.push(t)},this);var l=new Array;return this.ctab.sgroupData.each(function(t,e){this.isPointInPolygon(r,e.sgroup.pp)&&l.push(t)},this),{atoms:n,bonds:e,rxnArrows:o,rxnPluses:s,chiralFlags:a,sgroupData:l}},rnd.Render.prototype.testPolygon=function(t){if(t=t||[{x:50,y:10},{x:20,y:90},{x:90,y:30},{x:10,y:30},{x:90,y:80}],!(t.length<3)){for(var e=t[0],n=t[0],r=1;r<t.length;++r)e=util.Vec2.min(e,t[r]),n=util.Vec2.max(n,t[r]);this.drawSelectionPolygon(t);for(var i=0;1e3>i;++i){var o=new util.Vec2(Math.random()*zz,Math.random()*zz),s=this.isPointInPolygon(t,o),a=s?"#0f0":"#f00";this.paper.circle(o.x,o.y,2).attr({fill:a,stroke:"none"})}this.drawSelectionPolygon(t)}},rnd.Render.prototype.update=function(t){if(rnd.logMethod("update"),!this.settings||this.dirty){if(this.opt.autoScale){var e=this.ctab.molecule.getCoordBoundingBox(),n=e.max.y-e.min.y>0?.8*this.viewSz.y/(e.max.y-e.min.y):100,r=e.max.x-e.min.x>0?.8*this.viewSz.x/(e.max.x-e.min.x):100;this.scale=Math.min(n,r)}this.initSettings(),this.initStyles(),this.dirty=!1,t=!0}var i=(new Date).getTime(),o=this.ctab.update(t);this.setSelection(null);var s=(new Date).getTime()-i;if(t&&$("log")&&($("log").innerHTML=s.toString()+"\n"),o){var a=this.settings.scaleFactor,l=this.ctab.getVBoxObj().transform(this.obj2scaled,this).translate(this.offset||new util.Vec2);if(this.opt.autoScale){var c=l.sz(),h=this.opt.autoScaleMargin,u=new util.Vec2(h,h),d=this.viewSz;if(d.x<2*h+1||d.y<2*h+1)throw new Error("View box too small for the given margin");var p=Math.max(c.x/(d.x-2*h),c.y/(d.y-2*h)),f=c.add(u.scaled(2*p));this.paper.setViewBox(l.pos().x-h*p-(d.x*p-f.x)/2,l.pos().y-h*p-(d.y*p-f.y)/2,d.x*p,d.y*p)}else{var m=util.Vec2.UNIT.scaled(a);l=l.extend(m,m),this.bb||(this.bb=new util.Box2Abs(util.Vec2.ZERO,this.viewSz)),this.bb=util.Box2Abs.union(this.bb,l),l=this.bb.clone();var g=util.Vec2.max(l.sz().floor(),this.viewSz),b=l.p0.negated().ceil();(!this.sz||g.x>this.sz.x||g.y>this.sz.y)&&this.setPaperSize(g);var v=this.offset||new util.Vec2,y=b.sub(v);(!this.offset||y.x>0||y.y>0)&&(this.setOffset(b),this.ctab.translate(y),this.bb.translate(y))}}},rnd.Render.prototype.checkBondExists=function(t,e){return this.ctab.molecule.checkBondExists(t,e)},rnd.Render.prototype.findClosestAtom=function(t,e,n){var r=null,i=this.opt.selectionDistanceCoefficient;return e=e||i,e=Math.min(e,i),this.ctab.atoms.each(function(i,o){if(i!=n){var s=util.Vec2.dist(t,o.a.pp);e>s&&(r=i,e=s)}},this),null!=r?{id:r,dist:e}:null},rnd.Render.prototype.findClosestBond=function(t,e){var n=null,r=null,i=this.opt.selectionDistanceCoefficient;e=e||i,e=Math.min(e,i);var o=e;return this.ctab.bonds.each(function(e,n){var i=this.ctab.atoms.get(n.b.begin).a.pp,s=this.ctab.atoms.get(n.b.end).a.pp,a=util.Vec2.lc2(i,.5,s,.5),l=util.Vec2.dist(t,a);o>l&&(o=l,r=e)},this),this.ctab.bonds.each(function(r,i){var o=this.ctab.molecule.halfBonds.get(i.b.hb1),s=o.dir,a=o.norm,l=this.ctab.atoms.get(i.b.begin).a.pp,c=this.ctab.atoms.get(i.b.end).a.pp,h=util.Vec2.dot(t.sub(l),s)*util.Vec2.dot(t.sub(c),s)<0;if(h){var u=Math.abs(util.Vec2.dot(t.sub(l),a));e>u&&(n=r,e=u)}},this),null!==n||null!==r?{id:n,dist:e,cid:r,cdist:o}:null},rnd.Render.prototype.findClosestItem=function(t,e,n){var r=null,i=function(t,e,n){null!=e&&(null==r||r.dist>e.dist||n)&&(r={type:t,id:e.id,dist:e.dist})};if(!e||e.indexOf("atoms")>=0){var o=this.findClosestAtom(t,void 0,Object.isUndefined(n)||"atoms"!=n.map?void 0:n.id);i("Atom",o)}if(!e||e.indexOf("bonds")>=0){var s=this.findClosestBond(t);s&&(null!==s.cid&&i("Bond",{id:s.cid,dist:s.cdist}),(null==r||r.dist>.4*this.scale)&&i("Bond",s))}if(!e||e.indexOf("chiralFlags")>=0){var a=rnd.ReChiralFlag.findClosest(this,t);i("ChiralFlag",a)}if(!e||e.indexOf("sgroupData")>=0){var l=rnd.ReDataSGroupData.findClosest(this,t);i("DataSGroupData",l)}if(!e||e.indexOf("sgroups")>=0){var c=rnd.ReSGroup.findClosest(this,t);i("SGroup",c)}if(!e||e.indexOf("rxnArrows")>=0){var h=rnd.ReRxnArrow.findClosest(this,t);i("RxnArrow",h)}if(!e||e.indexOf("rxnPluses")>=0){var u=rnd.ReRxnPlus.findClosest(this,t);i("RxnPlus",u)}if(!e||e.indexOf("frags")>=0){var d=rnd.ReFrag.findClosest(this,t,n&&"atoms"==n.map?n.id:void 0);i("Fragment",d)}if(!e||e.indexOf("rgroups")>=0){var p=rnd.ReRGroup.findClosest(this,t);i("RGroup",p)}return r=r||{type:"Canvas",id:-1}},rnd.Render.prototype.setZoom=function(t){this.zoom=t,this._setPaperSize(this.sz)},rnd.Render.prototype.extendCanvas=function(t,e,n,r){var i=0,o=0,s=0,a=0;t-=0,n-=0,e-=0,r-=0,0>t&&(i+=-t,s+=-t),0>e&&(o+=-e,a+=-e);var l=this.sz.x*this.zoom,c=this.sz.y*this.zoom;n>l&&(i+=n-l),r>c&&(o+=r-c);var h=new util.Vec2(s,a).scaled(1/this.zoom);if(o>0||i>0){var u=new util.Vec2(i,o).scaled(1/this.zoom),d=this.sz.add(u);this.setPaperSize(d),(h.x>0||h.y>0)&&(this.setOffset(this.offset.add(h)),this.ctab.translate(h),this.bb.translate(h))}return h},rnd.Render.prototype.setScale=function(t){this.offset&&(this.offset=this.offset.scaled(1/t).scaled(this.zoom)),this.scale=this.baseScale*this.zoom,this.settings=null,this.update(!0)},rnd.Render.prototype.setViewBox=function(t){this.useOldZoom?this.setScale(t):this.paper.canvas.setAttribute("viewBox","0 0 "+this.sz.x+" "+this.sz.y)},ketcher=function(){this.render=null},ketcher.version="1.1-beta",ketcher.init=function(t,e){document.title+=" v"+ketcher.version,ketcher.button_areas={};var n={fontSize:25};ketcher.button_areas.atom_h=new rnd.ElementTable("atom_h",n).renderSingle("H"),ketcher.button_areas.atom_c=new rnd.ElementTable("atom_c",n).renderSingle("C"),ketcher.button_areas.atom_n=new rnd.ElementTable("atom_n",n).renderSingle("N"),ketcher.button_areas.atom_o=new rnd.ElementTable("atom_o",n).renderSingle("O"),ketcher.button_areas.atom_s=new rnd.ElementTable("atom_s",n).renderSingle("S"),ketcher.button_areas.atom_p=new rnd.ElementTable("atom_p",n).renderSingle("P"),ketcher.button_areas.atom_f=new rnd.ElementTable("atom_f",n).renderSingle("F"),ketcher.button_areas.atom_cl=new rnd.ElementTable("atom_cl",n).renderSingle("Cl"),ketcher.button_areas.atom_br=new rnd.ElementTable("atom_br",n).renderSingle("Br"),ketcher.button_areas.atom_i=new rnd.ElementTable("atom_i",n).renderSingle("I"),ketcher.button_areas.atom_table=new rnd.ElementTable("atom_table",n).renderSingle("..."),ketcher.button_areas.atom_any=new rnd.ElementTable("atom_reagenerics",{fontSize:9}).renderSingle("Generic\nGroups"),ui.init(t,e),$("ketcher_version").innerHTML="Version "+ketcher.version},ketcher.getSmiles=function(){var t=new chem.SmilesSaver;return t.saveMolecule(ui.ctab,!0)},ketcher.getMolfile=function(){var t=new chem.MolfileSaver;return t.saveMolecule(ui.ctab,!0)},ketcher.setMolecule=function(t){Object.isString(t)&&ui.loadMolecule(t)},ketcher.addFragment=function(t){Object.isString(t)&&ui.loadMolecule(t,void 0,void 0,!0)},ketcher.showMolfile=function(t,e,n,r){return ketcher.showMolfileOpts(t,e,75,{showSelectionRegions:!1,showBondIds:!1,showHalfBondIds:!1,showLoopIds:!1,showAtomIds:!1,autoScale:n||!1,autoScaleMargin:4,hideImplicitHydrogen:r||!1})},ketcher.showMolfileOpts=function(t,e,n,r){return this.render=new rnd.Render(t,n,r),e&&this.render.setMolecule(chem.Molfile.parseCTFile("string"==typeof e?e.split("\n"):e)),this.render.update(),this.render},ketcher.testSegment=function(t){for(var e=600,n=50,r=50,i=e,o=e,s=new util.Box2Abs(n,r,n+i,r+o),a=new Raphael(t),l=[],c=0;1e5>c;++c){for(var h=new util.Vec2(Math.random()*e+50,Math.random()*e+50),s=new util.Vec2(Math.random()*e+50,Math.random()*e+50),u=!0,d=0;d<l.length;++d)if(util.Vec2.segmentIntersection(h,s,l[d][0],l[d][1])){u=!1;break}u&&l.push([h,s])}a.rect(50,50,e,e).attr({stroke:"#0f0"});for(var d=0;d<l.length;++d)a.path("M{0},{1}L{2},{3}",l[d][0].x,l[d][0].y,l[d][1].x,l[d][1].y).attr({"stroke-width":1,stroke:"#000"})};